<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Coursera-deeplearning-ai-（三）</title>
    <url>/2018/05/07/Coursera-deeplearning-ai-%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<p>这篇博文主要讲的是关于deeplearning.ai的第三门课程的内容，《Structuring Machine Learning Projects》</p>
<span id="more"></span>

<h2 id="Week-one"><a href="#Week-one" class="headerlink" title="Week one"></a>Week one</h2><h3 id="机器学习策略简介"><a href="#机器学习策略简介" class="headerlink" title="机器学习策略简介"></a>机器学习策略简介</h3><p>当你构建了一个机器学习系统，但是结果达不到你的要求的时候，你可能会尝试以下的方法</p>
<ul>
<li>collect more data</li>
<li>collect more diverse training set</li>
<li>train algorithm longer with gradient descent</li>
<li>try Adam instead of gradient descent</li>
<li>try bigger network</li>
<li>try smaller network</li>
<li>try dropout</li>
<li>add L2 regularization</li>
<li>network architecture<ul>
<li>activation functions</li>
<li># hidden units</li>
<li>…</li>
</ul>
</li>
</ul>
<h3 id="Orthogonalization-正交化"><a href="#Orthogonalization-正交化" class="headerlink" title="Orthogonalization(正交化)"></a>Orthogonalization(正交化)</h3><p>正如同调整电视或者是汽车的控制一样，通常一个按钮用于调整一个方面，这样才方便调整到你希望的结果，如果一个按钮控制很多个方面，那么你很难将结果调整到合适</p>
<p>在机器学习的过程中，通常需要调整如下图的四个目标</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-7/31363076.jpg"></p>
<ol>
<li>首先是要在训练集上面表现够好（基本达到人工识别的水平），如果效果不够好，尝试更大的网络，或者好的优化算法比如Adam</li>
<li>第二要在dev set 上面表现够好，如果不过好，尝试正则化或者更大的训练集</li>
<li>其次在test set上面表现够好，如果不够好，需要尝试更大的dev set（因为你之前在dev set上面表现已经足够好了，但是在test set上面表现不够好，很可能是因为dev set取的太小了）</li>
<li>最后要求在现实世界的问题中表现够好，如果不够好，那么就要改变你的dev set 或者是 cost function，因为你之前在dev和test上用定义好的cost function已经能达到很好的结果，而在现实世界中不行，那可能就是你的cost function定义不够符合现实问题</li>
</ol>
<h3 id="设定目标"><a href="#设定目标" class="headerlink" title="设定目标"></a>设定目标</h3><h4 id="单一数值化评价矩阵"><a href="#单一数值化评价矩阵" class="headerlink" title="单一数值化评价矩阵"></a>单一数值化评价矩阵</h4><p>加入有A,B两个分类器，其精确率和召回率分别如下，精确率的定义是你分类为猫的样本中真正是猫的比例，召回率是所有是猫的图片最终被正确分类为猫的比例</p>
<p>两个定义倒不是非常重要，重要的是我们通常会需要在这两者当中做折中</p>
<p>如果你尝试了很多组超参的组合，你就需要不仅仅是在2个分类器之间选择，而是在十几个分类器之间选择了</p>
<p>为了能够同时照顾到精确率和召回率，引入一个F1 score，这个指标同时考虑了精确率和召回率</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-7/18118181.jpg"></p>
<p>F1score 的定义是precision和recall的调和平均数（hormonic mean），表示为$F_1&#x3D;\frac{2}{1&#x2F;P+1&#x2F;R}$,P和R分别表示精确率和召回率</p>
<h4 id="满足-statisficing-和优化-optimizing-矩阵"><a href="#满足-statisficing-和优化-optimizing-矩阵" class="headerlink" title="满足(statisficing)和优化(optimizing)矩阵"></a>满足(statisficing)和优化(optimizing)矩阵</h4><p>加入你现在有两个系统，第一个是用来分类猫图片的，但是又要考虑时间；第二个是用来唤醒关键字的，要同时考虑准确率和false positive（没有说话但是被唤醒了）</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-7/77729361.jpg"></p>
<p>第一个猫图片系统可以用&lt;&#x3D;100ms的值的最大精确度来衡量</p>
<p>第二个可以用在24小时内被唤醒小于等于1次的，最大化精度的系统</p>
<h4 id="训练，开发，测试集的分布"><a href="#训练，开发，测试集的分布" class="headerlink" title="训练，开发，测试集的分布"></a>训练，开发，测试集的分布</h4><p>开发集和测试集需要来自于同一个分布，如果不同，你在开发集上面得到了很好的精度，运用到测试集的时候，就相当于是找另外一个问题的最优值，这样效果一般来说都不够好</p>
<p>在传统的机器学习项目中，因为数据量不是很大，比如有100个，1000个或者10000个数据，通常train和test的比例是7 0%和30%，如果需要dev set的情况就是60%train，20%dev，20%test</p>
<p>在数据量比较大的时候，比如100w条数据的时候，可能98%的train，1%的dev和test，因为1w条dev和test已经绰绰有余了</p>
<h4 id="改变dev-x2F-test-setd和评估矩阵"><a href="#改变dev-x2F-test-setd和评估矩阵" class="headerlink" title="改变dev&#x2F;test setd和评估矩阵"></a>改变dev&#x2F;test setd和评估矩阵</h4><p>比如你现在有一个分类猫图片的分类器，其中一个错误率低，但是存在一些色情图片，这个时候就要改变你的评估矩阵，加入一个系数，这个系数当图片不是色情图片的时候为1，是色情图片的时候为10或者100，这样如果是色情图片，错误率就会变得很高，实现了你的要求</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-7/48157316.jpg"></p>
<p>再来看个例子，假如你的分类器的dev和test的数据都是高清的猫图片，而最后应用的时候的图片的质量都很差，此时你分不出来猫图片，这个时候我们就要考虑改变dev&#x2F;test set，或者改变评价指标</p>
<h3 id="与人工分辨水平的比较"><a href="#与人工分辨水平的比较" class="headerlink" title="与人工分辨水平的比较"></a>与人工分辨水平的比较</h3><p>当你的系统超过了人类的精度的时候，可能就接近一个称之为贝叶斯优化错误或者是贝叶斯错误的值了，这个值是理论上的最佳精度，你不论如何用更复杂的模型或者是调参都无法逾越这个值</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-7/8559400.jpg"></p>
<p>与人类相比的原因是因为人类擅长很多方面，只要你的系统还不如人类做得好，你就可以用人工标注出更多的数据，以及分析为什么人工做的比机器好，更好的分析偏差和方差</p>
<h3 id="可避免的偏差和方差"><a href="#可避免的偏差和方差" class="headerlink" title="可避免的偏差和方差"></a>可避免的偏差和方差</h3><p>训练集误差和贝叶斯误差之间的距离成为可避免的偏差，训练集误差和开发集误差之间的差距成为可避免的偏差，如下图所示</p>
<p>两者当中，哪个大我们就专注于减少哪一个</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-7/77589726.jpg"></p>
<h3 id="超过人工水平"><a href="#超过人工水平" class="headerlink" title="超过人工水平"></a>超过人工水平</h3><p>人类尤其擅长感知任务，比如图片分类，自然语言处理和语音识别，机器更擅长数据挖掘，找寻数字规律等任务</p>
<p>机器在感知领域能够超越人工水平是非常棒的效果，现在越来越多领域已经可以超越人类</p>
<h3 id="改进模型效果的策略"><a href="#改进模型效果的策略" class="headerlink" title="改进模型效果的策略"></a>改进模型效果的策略</h3><p>如下图，改进模型表现，主要有两点，首先是可以在训练集上面表现的很好，然后是扩展到开发集和测试集</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-8/14356520.jpg"></p>
<p>具体来说，对于不同的问题，有如下的策略</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-8/67730158.jpg"></p>
<h2 id="Week-Two"><a href="#Week-Two" class="headerlink" title="Week Two"></a>Week Two</h2><h3 id="错误分析"><a href="#错误分析" class="headerlink" title="错误分析"></a>错误分析</h3><p>加入你现在建立了一个分类猫的分类器，但是你发现其中有些狗的图片也被分成了猫，那么你是否需要去找更多的狗的图片并标记好，放在你的训练样本中呢？</p>
<p>这个时候我们就需要进行错误分析，看看我们对某个方向的努力是否值得</p>
<p>错误分析的步骤：</p>
<ul>
<li>找出100个错误标记的开发集样例</li>
<li>计算这里有多少张本来是狗，结果分成了猫的情况</li>
</ul>
<p>如果这里100张分错的样例中只有5张是狗，那么也就是5%的错误原因来源于狗的图片。如果你之前的错误率是10%，那么你最多也就只能减少5%，达到9.5%，这显然不太值得去做</p>
<p>如果这100张分错的样例中有50张是狗，那么就是50%的错误原因来源于狗的图片。如果你之前错误率是10%，那么现在可以减少50%，达到5%，这就值得去做了</p>
<p>当然，我们可能会找到很多个方向去优化，比如在猫的分类器的问题中：</p>
<ol>
<li>解决狗被分成猫的情况</li>
<li>解决大型猫科动物（狮子，老虎等等）被认为是猫的情况</li>
<li>解决模糊图片分错的问题</li>
</ol>
<p>这个时候，我们找出大概100张分错的图片，然后列一个表格，对每个分错的图片进行归因，最终得到每个因素的影响的比例，为我们提供改进的参考，如下图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/77418193.jpg"></p>
<h3 id="清理标记错误的数据"><a href="#清理标记错误的数据" class="headerlink" title="清理标记错误的数据"></a>清理标记错误的数据</h3><p>当训练集中存在标记错误的数据的时候，只要比例不是很大，深度学习系统是可以克服这样的情况的</p>
<p>当开发集和测试集中存在错误标记的数据的时候，我们就把错误标记也看作一个影响因素，然后加入一列在上面的错误分析表中，如果影响大则去纠正，否则就先纠正别的</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/17088670.jpg"></p>
<h3 id="快速建立你的第一个系统，并迭代"><a href="#快速建立你的第一个系统，并迭代" class="headerlink" title="快速建立你的第一个系统，并迭代"></a>快速建立你的第一个系统，并迭代</h3><p>假如你现在正在建立一个语音识别的系统，你可能考虑很多下图左边的影响，比如背景噪声，方言的影响等等。</p>
<p>但是正确的做法应该如右边所示，首先建立一个开发和测试集以及评价矩阵，然后快速建立一个系统，之后使用偏差&#x2F;方差分析和错误分析来进行迭代，优化你的系统</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/78361136.jpg"></p>
<h3 id="不匹配的训练和开发-x2F-测试集数据"><a href="#不匹配的训练和开发-x2F-测试集数据" class="headerlink" title="不匹配的训练和开发&#x2F;测试集数据"></a>不匹配的训练和开发&#x2F;测试集数据</h3><p>假设你现在有一个分类猫的app，你能从网上找到的猫图片都是高清的，但是用户用手机上传的都是不够清晰的，这时就有一个训练与开发&#x2F;测试集数据不匹配的问题</p>
<p>假设你能从网上找到20w张高清猫图，而用户那种模糊的图只有1w张</p>
<p>现在有两种方案：</p>
<ol>
<li>随机混合所有数据，用20500张训练，2500张开发集，2500张测试集</li>
<li>将20w张高清图和5k张模糊图用于训练，2500张模糊图作为开发集，2500张模糊图作为测试集</li>
</ol>
<p>显然第一种方法是错误的，因为如果你随机混合之后，2500张开发集中只有119张来自于模糊图，你最终的目标是去识别模糊图中的猫，这样一来目标就设置错了</p>
<p>因此我们选用第二种方法</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/83829145.jpg"></p>
<p>再假设你现在在开发一个语音激活的后视镜系统，你有别的语音数据50w条，而语音控制后视镜的你有2w条，那么正确的方法应该是50w条语音加上1w条控制语音作为训练，5k条控制语言作为开发集，5k条控制语言作为测试集</p>
<h3 id="不同分布数据的偏差-x2F-方差分析"><a href="#不同分布数据的偏差-x2F-方差分析" class="headerlink" title="不同分布数据的偏差&#x2F;方差分析"></a>不同分布数据的偏差&#x2F;方差分析</h3><p>假设你现在有一个猫分类器，training error是1%，dev error 是10%。同时，你已经知道你的训练数据和dev&#x2F;test数据分布不同，训练图清晰，dev&#x2F;test数据不清晰。那么你这个1%到10%的差距，到底来源于high variance还是来自于数据的不匹配呢？此时就说不清了</p>
<p>我们在可能存在数据不匹配的情况下，再划分一个training-dev set，用于衡量究竟是high variance 还是数据不匹配对系统造成了印象，分类方式如下图，原来的train set分成了train和training-dev，原来的dev和test不变</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/52399374.jpg"></p>
<p>接下来在新的train set上面训练，并用training-dev set和dev&#x2F;test set进行测试，根据结果来判断到底是high variance造成的问题，还是数据不匹配造成的问题，那么怎么判断呢，我们来看几个例子</p>
<p>例1. 你现在的training error 是1%，training-dev error是9%，dev error 是10%，可以看到，即使数据分布相同时，数据的variance依然很高，所以我们先处理high variance的问题</p>
<p>例2. 你现在的training error 是1%，training-dev error是1.5%，dev error 是10%。可以看到，数据分布相同时的差距很小，而数据分布不同的时候差距很大， 应该着重处理数据失配(missmatch)问题</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/6819337.jpg"></p>
<p>human error和training error之间的差距是avoid bias，需要更复杂的模型或者超参数</p>
<p>traning error 和 training-dev error之间的差距是high variance，需要正则化</p>
<p>training-dev error 和 dev error之间的差距是data missmatch</p>
<p>dev error 和 test error 之间的差距是 overfitting dev set，要找一个更大的dev error</p>
<h3 id="解决data-missmatch"><a href="#解决data-missmatch" class="headerlink" title="解决data missmatch"></a>解决data missmatch</h3><p>解决data missmatch的方法，总体来说就是构造与dev&#x2F;test相同分布的数据</p>
<p>我们举个例子，比如你现在有很多安静环境下的录音，同时还有少量汽车噪音下的录音，我们最终的dev&#x2F;test数据是这个汽车噪音下的录音，因此我们可以将安静环境下的录音与单纯的汽车噪音混合，这样我们就快要得到更多汽车噪音下的数据</p>
<p>但是在混合的时候也要注意，比如你现在有10000小时的安静录音，1小时的汽车噪音，你将这1小时的汽车噪音重复到10000次得到10000小时的汽车噪音，这对人耳来说可能是正常的，但是对于深度学习算法来说，可以就会对这1小时的汽车噪声产生过拟合。因此正确的做法是尽可能收集10000小时的汽车噪声，然后与这10000小时的安静录音混合。</p>
<h3 id="迁移学习"><a href="#迁移学习" class="headerlink" title="迁移学习"></a>迁移学习</h3><p>假如你现在有两个任务A和B，你有大量的A的数据，只有少量B的数据，但是你最终想要去识别B，此时，只要A和B是同一类的数据（比如都是图片，或者都是语音），那么我们就可以使用迁移学习</p>
<p>迁移学习就是用数据量大的A数据先构建模型，然后去掉输出层（数据量非常少的时候，如果数据量稍微多一些，可以多去掉几层），用数据量少的B的数据进行训练，最终这个系统能够很好地分类B</p>
<p>举个例子，比如你现在有个分类猫的分类器，但是你想要能够分类x光，那么你先用猫的数据建立分类猫的分类器，然后去掉输出层，再用x光的数据进行训练，就得到了一个分类x光的分类器</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/59103871.jpg"></p>
<p>再比如说你有一个语音识别的分类器，现在要建立一个唤醒词的分类器，那么你只需要去掉输出层，然后再训练唤醒词分类器即可，这个唤醒词分类器可以只有1层，也可以扩展为好几层</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/60205274.jpg"></p>
<h3 id="多任务学习"><a href="#多任务学习" class="headerlink" title="多任务学习"></a>多任务学习</h3><p>假设你正在做一个自动驾驶物体检测的问题，检测一张图上是否有行人，车辆，路标和交通灯，如果有则标记出来，比如下面这张图的标记为y&#x3D;(0,1,1,0)</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/58730529.jpg"></p>
<p>所谓的多任务学习就是一次学习出的分类器可以分类多个目标，比如上述的问题，我们把四个的loss放到一起，甚至有些分类没有标记也是可以学习的，你只需要在计算loss的时候只算标记好的类型，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/92028508.jpg"></p>
<p>多任务学习和softmax回归的区别：多分类可以有多个类别是1，而softmax回归只能有一个类别为1</p>
<h3 id="端到端的深度学习"><a href="#端到端的深度学习" class="headerlink" title="端到端的深度学习"></a>端到端的深度学习</h3><p>传统的机器学习方法，是输入原始数据，然后分好几步提取特征，最终得到分类结果</p>
<p>端到端的学习，就是直接输入原始数据，得到最终的分类结果，这是需要大量的数据作为支撑的</p>
<p>举个例子，在人脸识别这个问题中，你是不能使用端到端的方法的，因为在人脸识别的时候，人脸可能处于图中任何位置，因此没有这么多的数据支撑你进行端到端的识别。你应该分成两个子任务，首先是提取出人脸这个任务，然后再是人脸的比较任务</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/63267645.jpg"></p>
<p>再比如机器翻译这个任务，用端到端的方法是很合适的，因为翻译的数据足够多，可以支撑你的端到端方法</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-9/98914578.jpg"></p>
<h4 id="决定是否使用端到端的方法"><a href="#决定是否使用端到端的方法" class="headerlink" title="决定是否使用端到端的方法"></a>决定是否使用端到端的方法</h4><p>端到端学习的优劣势</p>
<p>优势：</p>
<ul>
<li>数据自我解释</li>
<li>很少的需要动手去设计的中间步骤</li>
</ul>
<p>劣势：</p>
<ul>
<li>需要大量数据</li>
<li>不能使用手动设计的步骤中的有效内容</li>
</ul>
<p>是否使用端到端的方法，最主要的问题就是你是否有足够的数据去找出x到y的映射</p>
<p>比如在自动驾驶的过程中，目标检测的过程我们用的是深度学习的方法，在路径规划的时候用的是motion planning 的方法，然后到如何控制油门刹车，方向盘之类的时候用的是控制学</p>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>deeplearning</tag>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Coursera deeplearning.ai (一)</title>
    <url>/2018/03/15/Coursera-deeplearning-ai-%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<p>Coursera上面关于deeplearning.ai的课程一共有五门，在申请助学金之后都可以免费参与，这篇博文主要讲的是关于deeplearning.ai的第一门课程的</p>
<span id="more"></span>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-15/44184824.jpg"></p>
<p>在房价预测中，最普通的如右上角转弯的函数，称之为ReLU(rectified linear unit)函数，给定一个大小，通过一个神经元就可以得到房子的价格，这就是一个神经元。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-15/68262402.jpg"></p>
<p>如果你对房价预测还有别的因素，比如卧室的数量，地理位置，学区信息等等来对房价进行预测，你只需要给定大量的x的输入数据，就可以用来预测房价y的值，这样就得到了一个较大的神经元</p>
<p>最左边的一层是输入层，中间一层是隐藏层，最后是输出层</p>
<h2 id="Week-2"><a href="#Week-2" class="headerlink" title="Week 2"></a>Week 2</h2><p>首先介绍一下logistics二分类：经典的二分类算法</p>
<p>首先来看看图像分类的问题，输入一张图片，我们标记1作为猫，标记0作为不是猫</p>
<p>图片在电脑中保存为红绿蓝三个色彩强度矩阵，如果是一幅$64\times64$的图片，就有3个$64\times64$的色彩矩阵，为了进行分类，将这些矩阵中的像素值展开为一个向量x作为算法的输入</p>
<p>输入x的定义为：红黄蓝三张矩阵的像素值按顺序放进去，x在$64\times64$的图片的情况下就是，$64\times64\times3&#x3D;(12288,1)$的矩阵，有m个训练数据，则有m个x向量，m个y</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-17/57255797.jpg"></p>
<p>如图，每个训练数据占一列，m个训练数据，一共是$m<em>n$行，Y是标签，m个标签为1</em>m</p>
<h3 id="logistics-回归"><a href="#logistics-回归" class="headerlink" title="logistics 回归"></a>logistics 回归</h3><p>给定x，预测y，y只能是0和1，也就是二分类问题</p>
<p>有两个参数，w和b，w也是（n，1）的向量，$\hat{y} &#x3D; w^Tx+b$，这样的表示并不好，因为y可能是一个小数或者甚至是负数，我们想要结果是0或1，因此我们对结果用sigmoid函数，如下：</p>
<p>$\hat{y} &#x3D; \sigma(w^Tx+b)$</p>
<p>sigmoid函数的定义为：$f(z)&#x3D;\frac{1}{1+e^{-z}}$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-19/84173695.jpg"></p>
<h3 id="Logistic-Regression-Cost-Function"><a href="#Logistic-Regression-Cost-Function" class="headerlink" title="Logistic Regression Cost Function"></a>Logistic Regression Cost Function</h3><p>为了优化logistic回归的w和b，我们定义一个损失函数，</p>
<p>损失函数（loss function）：定义一个估计量$\hat{y}$和一个真实值$y$之间的误差，我们在这里用到的是平方损失函数，$L(\hat{y},y)&#x3D;\frac{1}{2}(\hat{y}-y)^2$</p>
<p>另一种适用的损失函数定义为：$L(\hat{y},y)&#x3D;- (y\log\hat{y}+(1-y)\log({1-\hat{y}}))$</p>
<ul>
<li>这个函数在y&#x3D;1的时候，$L(\hat{y},y)&#x3D;- \log\hat{y}$，要让损失函数尽可能小，那么$\hat{y}$就要尽可能大（因为前面有负号，log是增函数），由于$\hat{y}$是sigmoid函数，最大为1</li>
<li>这个函数在y&#x3D;0的时候，$L(\hat{y},y)&#x3D;- \log({1-\hat{y}})$，要让损失函数尽可能小，那么$\hat{y}$就要尽可能小（因为前面有负号，log是增函数），由于$\hat{y}$是sigmoid函数，最小为0</li>
</ul>
<p>代价函数（cost function）：定义整个训练集的平均损失：$J(\hat{y},y)&#x3D;\frac{1}{m}\sum_{i&#x3D;1}^{n}L(\hat{y}^{(i)},y^{(i)})$</p>
<h3 id="梯度下降"><a href="#梯度下降" class="headerlink" title="梯度下降"></a>梯度下降</h3><p>已经知道了逻辑回归算法的参数w和b，以及代价函数$J(\hat{y},y)$，我们需要一个方法来训练我们的模型，那就是梯度下降。</p>
<p>目标是使代价函数$J(\hat{y},y)$最小，也就是下面这个公式最小：</p>
<p>$J(w,b) &#x3D; \frac{1}{m}\sum_{i&#x3D;1}^mL(\hat{y}^{(i)},y^{(i)})&#x3D;\frac{1}{m}y^{(i)}\log\hat{y}^{(i)}+(1-y^{(i)})\log(1-\hat{y}^{(i)})$</p>
<p>这是一个凸优化问题，有且仅有一个最优值，在初始化w和b的时候，可以令初始w&#x3D;1，b&#x3D;0，也可以随机初始化。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-19/36310473.jpg"></p>
<p>每次迭代找到下一个点的方法是通过找到斜率的方向，因为斜率的方向是下降最快的</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-19/42922001.jpg"></p>
<p>直到找到全局最优值，w和b每次迭代更新的公式如下：</p>
<p>$w:&#x3D;w-\alpha\frac{\partial{J(w,b)}}{\partial{w}}$</p>
<p>$b:&#x3D;b-\alpha\frac{\partial{J(w,b)}}{\partial{b}}$</p>
<h3 id="计算图"><a href="#计算图" class="headerlink" title="计算图"></a>计算图</h3><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-20/26861114.jpg"></p>
<p>如图是一个计算图，$J(a,b,c)&#x3D;3(a+bc)$，令bc&#x3D;u，bc&#x3D;v，3v&#x3D;j，这样就是如上图一步一步的计算</p>
<p>在代码中，我们要表示dJ&#x2F;da的时候，只需要写da就行了 </p>
<p>所谓的反向传播，就是通过链式法则求导倒数的过程</p>
<h3 id="logistic回归梯度下降法应用"><a href="#logistic回归梯度下降法应用" class="headerlink" title="logistic回归梯度下降法应用"></a>logistic回归梯度下降法应用</h3><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-20/84901446.jpg"></p>
<p>已知z，$\hat{y}$，以及L(a,y)公式如上，要通过调节w和b得到最大或者最小的L，应该用L对w和b求偏导，然后运用</p>
<p>$$w:&#x3D;w-\alpha dw$$</p>
<p>$$b:&#x3D;b-\alpha db$$</p>
<p>这两个公式进行迭代，其中dw就是L对w的偏导，db就L对b的偏导</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-20/16345016.jpg"></p>
<p>首先L对a求偏导，得到$da&#x3D;-\frac{y}{a}+\frac{1-y}{1-a}$，接下来a对z求偏导，乘以L对a求偏导，得到$dz&#x3D;\frac{dL}{dz}&#x3D;\frac{dL}{da}\frac{da}{dz}$，有</p>
<p>$\frac{da}{dz}&#x3D;(\frac{1}{1+e^{-z}})’&#x3D;\frac{e^{-z}}{(1+e^{-z})^2}&#x3D;\frac{1+e^{-z}-1}{(1+e^{-z})^2}&#x3D;\frac{1}{1+e^{-z}}(1-\frac{1}{1+e^{-z}})&#x3D;f(z)(1-f(z))&#x3D;a(1-a)$</p>
<p>因此，$dz&#x3D;a-y$，$dw_1&#x3D;x_1dz$，$dw_2&#x3D;x_2dz$，$db&#x3D;dz$，再用上图右下角的迭代公式，即可实现梯度下降迭代</p>
<h3 id="m个训练数据的梯度下降"><a href="#m个训练数据的梯度下降" class="headerlink" title="m个训练数据的梯度下降"></a>m个训练数据的梯度下降</h3><p>代价函数$J(w,b)&#x3D;\frac{1}{m}\sum_{i&#x3D;1}^{n}L(a^{(i)},y^{(i)})$</p>
<p>其中$a^{(i)}&#x3D;\hat{y}^{(i)}&#x3D;\sigma(w^Tx^{(i)}+b)$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-21/50315744.jpg"></p>
<p>如图，有两层循环，第一层是循环m个训练数据，第二层是循环n个w</p>
<h3 id="通过向量化减少逻辑回归的循环"><a href="#通过向量化减少逻辑回归的循环" class="headerlink" title="通过向量化减少逻辑回归的循环"></a>通过向量化减少逻辑回归的循环</h3><p>如下图，我们先减少内层的n个w的循环，通过$dw+&#x3D;x^{(i)}dz^{(i)}$减少内层循环</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-21/66629047.jpg"></p>
<p>我们再来减少外层的循环</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-21/44301965.jpg"></p>
<p>通过图片中Z和A的计算，就可以减少外层的循环</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-21/69750118.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-21/26767201.jpg"></p>
<h2 id="Week-3"><a href="#Week-3" class="headerlink" title="Week 3"></a>Week 3</h2><p>神经网络的定义，我们可以从前两周学的逻辑回归来进入，给定x，w，b，可以算出z，由z可以算出a，由a算出损失函数，</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/77110335.jpg"></p>
<p>这是一个两层神经网络（包括1个隐藏层和1个输出层，输入层并不算在其中）</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/30753349.jpg"></p>
<h3 id="神经网络的计算公式"><a href="#神经网络的计算公式" class="headerlink" title="神经网络的计算公式"></a>神经网络的计算公式</h3><p>我们先看看逻辑回归的计算方法：没有隐藏层，直接通过输入就算出最终的输出a</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/11306728.jpg"></p>
<p>神经网络与之类似，不过多了一层隐藏层，</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/15254553.jpg"></p>
<p>通过如下的公式进行计算隐藏层的每一个点的值</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/76248903.jpg"></p>
<p>整理一下四个点的计算公式如下：右上角的方括号表示所在层，右下角角标表示第几个点</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/88933716.jpg"></p>
<p>我们将公式矢量化：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/21544575.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/41708289.jpg"></p>
<p>得到最终的计算公式如下：其中a[0]表示输入x</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/72894768.jpg"></p>
<h3 id="多个训练样本的矢量化"><a href="#多个训练样本的矢量化" class="headerlink" title="多个训练样本的矢量化"></a>多个训练样本的矢量化</h3><p>要将如下图所示的循环进行矢量化：其中方括号表示所在层，圆括号表示第几个隐藏单元</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/86500821.jpg"></p>
<p>矢量化之后得到如下公式：Z和A的横向表示m个样本</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-22/12794340.jpg"></p>
<h3 id="激活函数"><a href="#激活函数" class="headerlink" title="激活函数"></a>激活函数</h3><p>我们之前用的激活函数都是simoid函数，tanh函数一般来说比sigmoid函数的效果好</p>
<p>$a &#x3D; tanh(z) &#x3D; \frac{e^z-e^{-z}}{e^z+e^{-z}}$</p>
<p>tanh函数可以看做一个sigmoid函数的平移，图形如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-27/57360301.jpg"></p>
<p>但是tanh函数和sigmoid函数都有缺陷，那就是在a接近1的时候，斜率非常小，导致迭代速度特别慢，因此给出了RELU函数和leaker relu函数，是Restrict Linear Unit的缩写，一个是取0和z的最大值，一个取0.01z和z的最大值，这样能够保证迭代的速度</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-27/38210461.jpg"></p>
<h3 id="为什么需要非线性激活函数"><a href="#为什么需要非线性激活函数" class="headerlink" title="为什么需要非线性激活函数"></a>为什么需要非线性激活函数</h3><p>$z^{[1]} &#x3D; W^{[1]}X+b^{[1]}$</p>
<p>$a^{[1]}&#x3D;\sigma(z^{[1]})​$</p>
<p>$z^{[2]} &#x3D; W^{[2]}X+b^{[2]}$</p>
<p>$a^{[2]}&#x3D;\sigma(z^{[2]})$</p>
<p>如果我们不使用非线性激活函数，比如直接让g(z) &#x3D; z，那么$z^{[2]} &#x3D; W^{[2]}a^{[1]}+b^{[2]}&#x3D;W^{[2]}(W^{[1]}X+b^{[1]})+b^{[2]}&#x3D;W^{[2]}W^{[1]}X+W^{[2]}b^{[1]}+b^{[2]} &#x3D; W^{‘}X+b^{‘}$</p>
<p>相当于经过多个隐藏层之后，结果还是输入的线性变化，那么隐藏层就没有意义了</p>
<p>只有一种情况使用线性激活函数，就是在做回归问题的最后一步的时候，输出值不是0和1而是一个实数，那么这个时候就应该使用线性激活函数，但是在中间的隐藏层仍然应该使用非线性激活函数。</p>
<h3 id="激活函数的梯度下降"><a href="#激活函数的梯度下降" class="headerlink" title="激活函数的梯度下降"></a>激活函数的梯度下降</h3><ol>
<li>sigmoid函数： $a&#x3D;g(z)&#x3D;\frac{1}{1+e^{-z}}$，导数是$g^{‘}(z)&#x3D;g(z)(1-g(z))&#x3D;a(1-a)$，在z&#x3D;一个很大的正数或者负数的时候，g（z）导数接近于0；z等于0的时候，g(z)的导数是1&#x2F;4</li>
<li>tanh函数，$a&#x3D;g(z)&#x3D;\tanh(z)&#x3D;\frac{e^z-e^{-z}}{e^z+e^{-z}}$，求导可得$g^{‘}(z)&#x3D;1-g^{2}(z)$，我们可以通过一个简单的例子来检验有没有错误，当z很大或者很小的时候，$g^{‘}(z)&#x3D;0$当，z&#x3D;0的时候，导数&#x3D;1</li>
<li>Relu函数，$g(z)&#x3D;max(0,z)$，导数&#x3D;0（当$z&lt;0$的时候），导数&#x3D;1（当$z&gt;&#x3D;0$的时候）</li>
<li>Leaky ReLU：$g(z)&#x3D;max(0.01z,z)$，导数&#x3D;0.01（当$z&lt;0$的时候），导数&#x3D;1（当$z&gt;&#x3D;0$的时候）</li>
</ol>
<h3 id="神经网络的梯度下降"><a href="#神经网络的梯度下降" class="headerlink" title="神经网络的梯度下降"></a>神经网络的梯度下降</h3><p>左边是包含一个隐藏层的神经网络的推导公式，右边是反向传播求导的结果，其中np.sum函数中的keepdims&#x3D;True这个参数是为了输出结果是(n,1)而不是(n,)</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-29/85213919.jpg"></p>
<h3 id="神经网络梯度下降的推导"><a href="#神经网络梯度下降的推导" class="headerlink" title="神经网络梯度下降的推导"></a>神经网络梯度下降的推导</h3><p>从后往前推导，先求dz2&#x3D;a2-y，因为L(a2,y)&#x3D;-y<em>loga-(1-y)log(1-a)，对a求导，然后乘以sigmoid的导数刚好是a2-y，dw2&#x3D;dz2</em>a1T，这里的转置是通过维度来判断的，dw2一定和w2一样的维度，w2的维度是（n2,n1），那么dw2维度也是(n2,n1)，dz2的维度与z2相同是(n2,1)，那么应该右乘一个(1,n1)得到dw2，也就是a1T</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-29/25424720.jpg"></p>
<p>左边是一个输入的时候的梯度下降，右边是向量化之后多个输入的梯度下降，因为代价函数J前面有1&#x2F;m，所以dw前面也有1&#x2F;m，keepdims&#x3D;True是为了保证b2的形状是(n2,1)</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-29/25376002.jpg"></p>
<h3 id="随机初始化"><a href="#随机初始化" class="headerlink" title="随机初始化"></a>随机初始化</h3><p>在逻辑回归中，w可以初始化为0，在神经网络中，我们必须要随机初始化w。这是为什么呢？主要是因为神经网络中存在隐藏层，如果一开始将w设置为全0，那么在反向传播的时候，通过$w &#x3D; w-\alpha dw$这个公式进行迭代，每次迭代结束之后，两行的结果完全相同，这就是所谓的“对称”。这样多个隐藏点就跟1个隐藏点没有区别了</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-29/15262152.jpg"></p>
<p>我们使用np.random.randn((1,2))随机初始化，并乘以一个很小的值，比如0.01，为什么不乘以一个很大的值比如100之类的呢，这是因为我们通常使用的激活函数，比如tanh和sigmoid函数，在值很大的时候斜率很小，迭代速度非常慢。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-29/1215672.jpg"></p>
<h2 id="Week-4"><a href="#Week-4" class="headerlink" title="Week 4"></a>Week 4</h2><h3 id="L层深度神经网络的符号表示"><a href="#L层深度神经网络的符号表示" class="headerlink" title="L层深度神经网络的符号表示"></a>L层深度神经网络的符号表示</h3><p>其中L表示神经网络的层数，不包括输入层，仅包含隐藏层和输出层，$n^{[i]}$表示第i层的点的个数</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-29/96874993.jpg"></p>
<h3 id="深度神经网络的前向传播"><a href="#深度神经网络的前向传播" class="headerlink" title="深度神经网络的前向传播"></a>深度神经网络的前向传播</h3><p>深度神经网络前向传播的通用公式：</p>
<p>$Z^{[l]}&#x3D;W^{l}A^{[l-1]}+b^{[l]}$</p>
<p>$A^{[l]}&#x3D;g^{[l]}(Z^{[l]})$</p>
<p>通过这个通用公式，我们就可以通过一个for循环，循环完所有的层</p>
<h3 id="使矩阵维度保持正确"><a href="#使矩阵维度保持正确" class="headerlink" title="使矩阵维度保持正确"></a>使矩阵维度保持正确</h3><p>检查神经网络代码的最好的办法，就是拿出一张纸，看看矩阵维度是否正确</p>
<p>检查两个参数W,b和每层输出a和Z的维度</p>
<p>$W^{[l]}&#x3D;dW&#x3D;(n^{[l]},n^{[l-1]})$</p>
<p>$a^{[l]}&#x3D;z^{[l]}&#x3D;(n^{[l]},1)$</p>
<p>$b^{[l]}&#x3D;db&#x3D;(n^{[l]},1)$</p>
<p>矢量化之后的</p>
<p>$W^{[l]}&#x3D;dW&#x3D;(n^{[l]},n^{[l-1]})$</p>
<p>$A^{[l]}&#x3D;Z^{[l]}&#x3D;dA&#x3D;dZ(n^{[l]},m)$</p>
<p>$b^{[l]}&#x3D;db&#x3D;(n^{[l]},1)$通过python的广播功能传播为$(n^{[l]},m)$</p>
<h3 id="深度神经网络的解释"><a href="#深度神经网络的解释" class="headerlink" title="深度神经网络的解释"></a>深度神经网络的解释</h3><p>如下图，深度神经网络的第一层，可能能够检测一些图像的边缘，第二层可能由这些边缘组成了一些部件（比如人脸识别中的眼睛、鼻子、耳朵之类的），第三层再将这些眼睛鼻子耳朵之类的组合起来形成不同的脸，这就是神经网络的直观解释。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-30/82184765.jpg"></p>
<h3 id="建立神经网络"><a href="#建立神经网络" class="headerlink" title="建立神经网络"></a>建立神经网络</h3><p>神经网络主要分为两个部分，前向传播和反向传播</p>
<p>前向传播：输入$a^{[l-1]}$，输出$a^{[l]}$</p>
<p>反向传播中：输入$da^{[l]}$和$z^{[l]}$，输出$da^{[l-1]}$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-4/153714.jpg"></p>
<p>第L层的前向与反向传播示意如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-4/60529019.jpg"></p>
<p>整个深度神经网络的传播示意如下：</p>
<p>先正向传播，再反向传播，算出dw和db后用更新公式更新w和b，就完成了一次迭代</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-4/20215725.jpg"></p>
<h3 id="正反向传播"><a href="#正反向传播" class="headerlink" title="正反向传播"></a>正反向传播</h3><p>第L层的正向传播</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-9/85558501.jpg"></p>
<p>第L层的反向传播</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-9/41217448.jpg"></p>
<p>前反向传播的总结</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-9/50179449.jpg"></p>
<h3 id="参数和超参数"><a href="#参数和超参数" class="headerlink" title="参数和超参数"></a>参数和超参数</h3><p>神经网络中的参数：W，b</p>
<p>超参数：影响到实际的参数W和b的参数，比如学习率$\alpha$，迭代次数，隐藏层的个数，隐藏神经单元数，激活函数的选择（tanh，sigmoid，RELU）</p>
<p>一般都是不断的尝试找到最优的超参值（启发式搜索），比如学习率$\alpha$要找到一个下降较快，且算是函数收敛到较低的值。</p>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>deeplearning</tag>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Coursera-deeplearning-ai-（二）</title>
    <url>/2018/04/11/Coursera-deeplearning-ai-%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<p>这篇博文主要讲的是关于deeplearning.ai的第二门课程的内容，《Improving Deep Neural Networks: Hyperparameter tuning, Regularization and Optimization》</p>
<span id="more"></span>

<h2 id="Week-one"><a href="#Week-one" class="headerlink" title="Week one"></a>Week one</h2><h3 id="设置训练，验证，测试集"><a href="#设置训练，验证，测试集" class="headerlink" title="设置训练，验证，测试集"></a>设置训练，验证，测试集</h3><p>设置神经网络时，有很多的值需要你自己设置，比如隐藏层的数量，隐藏点的个数，学习率，激活函数的类型等等……</p>
<p>数据通常被分为三部分：训练集，hold-out交叉验证集（或者成为开发集dev），测试集。分布如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/88387245.jpg"></p>
<p>多年前，数据较少：70%的训练数据和30%的测试数据，或者60%训练数据，验证集和测试集各占20%</p>
<p>但现在数据越来越多，100w的总数据，验证集和测试集可能都只需要1w个就行了，剩下的98w数据都可以用于训练，比例为98&#x2F;1&#x2F;1</p>
<p>数据更多的时候，可能开发集和测试集所占的比例更小</p>
<h4 id="数据不平衡"><a href="#数据不平衡" class="headerlink" title="数据不平衡"></a>数据不平衡</h4><p>训练集，开发集，测试集的数据分布不同，比如图片识别中，两边的数据来源不同（一边是高清图片，一边是模糊图片），这时候只需要保证<strong>开发集和测试集在同一个分布</strong>即可。</p>
<h3 id="偏差方差"><a href="#偏差方差" class="headerlink" title="偏差方差"></a>偏差方差</h3><p>深度学习中有一个问题叫做“偏差-方差困境”，要在偏差和方差之间权衡</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/22424626.jpg"></p>
<h4 id="如何判断是高方差还是高偏差"><a href="#如何判断是高方差还是高偏差" class="headerlink" title="如何判断是高方差还是高偏差"></a>如何判断是高方差还是高偏差</h4><p>往往通过训练集误差和开发集误差的对比来进行判断：</p>
<ul>
<li>训练集误差小，开发集误差大，证明过拟合了，高方差</li>
<li>训练集误差大，开发集误差约等于训练集误差，证明欠拟合，高偏差</li>
<li>训练集误差大，开发集误差远大于训练集，证明高偏差且高方差，这是因为在某些数据上过拟合，而在大部分数据上欠拟合</li>
<li>训练集误差小，开发集误差也很小，这就是最理想的状态</li>
</ul>
<p>下面这个分类猫的例子比较直观解释了上面四种情况，注意，此时所谓的大小是因为我们设置的贝叶斯先验错误为0%，所以认为1%小，15%大。如果贝叶斯先验概率不是0%而是15%，那么15%的错误率也是很小的了。并且此时要求训练集和开发集的数据分布是相同的（如果一个是高质量数据，一个是低质量数据，那么两个本来错误率就不一样）。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/29396365.jpg"></p>
<h3 id="机器学习的基本准则"><a href="#机器学习的基本准则" class="headerlink" title="机器学习的基本准则"></a>机器学习的基本准则</h3><p>训练好模型之后：</p>
<ul>
<li>首先询问，是否存在<strong>高偏差</strong>（在训练集上面的表现），如果存在，那么你可以尝试使用<strong>更大的网络</strong>（更多层和更多隐藏点），或者尝试训练<strong>更多的迭代次数</strong>。尝试多种方法，直到将偏差减小到一个可以接受的范围。</li>
<li>再看看是否有较高的<strong>方差</strong>（在开发集上面的表现），如果存在，那么比较好的办法就是<strong>增加训练数据</strong>，或者是<strong>正则化</strong></li>
</ul>
<h3 id="正则化"><a href="#正则化" class="headerlink" title="正则化"></a>正则化</h3><p>如果发现<strong>过拟合</strong>，那么就是方差过大，首先应该尝试的方法就是正则化</p>
<p>以逻辑回归为例，为了最小化代价函数$J(W,b)&#x3D;\frac{1}{m}\sum_{i&#x3D;1}^{m}L(\hat{y}^{(i)},y^{(i)})$，我们在后面加上一个W的范数，常用的范数为二范数，代价函数变为：</p>
<p>$J(W,b)&#x3D;\frac{1}{m}\sum_{i&#x3D;1}^{m}L(\hat{y}^{(i)},y^{(i)})+\frac{\lambda}{2m}||w||^{2}_{2}$</p>
<p>其中的$\lambda$是正则化参数，$||w||^{2}<em>{2}$称为w的二范数，$||w||^{2}</em>{2}&#x3D;\sum_{j&#x3D;1}^{n_{x}}w_j^2&#x3D;w^Tw$</p>
<p>为什么只对w正则化而忽略b呢，这是因为在过拟合的情况下，w的维度非常大，而b只有一个参数，影响相对于w来说可以忽略</p>
<p>偶尔也用一范数，但很少用，具体的逻辑回归的正则化方法如下</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/27719103.jpg"></p>
<h4 id="神经网络的正则化"><a href="#神经网络的正则化" class="headerlink" title="神经网络的正则化"></a>神经网络的正则化</h4><p>神经网路的正则化的方法和逻辑回归基本一样，只是w的二范数成了w矩阵的元素平方和，这个值被称为Frobenius norm（弗罗贝尼乌斯范数）</p>
<p>在反向传播的时候，反向传播的$dw^{[l]}$就成了原本的反向传播的值（下图中间绿色方框行，由代价函数J求导得到），加上$\frac{\lambda}{m}w^{[l]}$，w的更新公式就成了这样:</p>
<p>$w^{[l]}&#x3D;(1-\frac{\alpha\lambda}{m})w^{[l]}-\alpha(原本的反向传播值)$</p>
<p>所以正则化之后，每次更新相当于只是在原本的w前面乘以一个略小于1的值$1-\frac{\alpha\lambda}{m}$，再减去原本的反向传播的值，因此神经网络的正则化又被称之为权重衰减</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/82915442.jpg"></p>
<h3 id="为什么正则化可以消除过拟合"><a href="#为什么正则化可以消除过拟合" class="headerlink" title="为什么正则化可以消除过拟合"></a>为什么正则化可以消除过拟合</h3><p>如图，如果过拟合，我们在加入正则化之后，如果把$\lambda$设置的非常大，那么为了是代价函数最小，w必须非常小，那么w的很多值就为0了，多层神经网络看上去就像是一个简单神经网路一样</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/98592108.jpg"></p>
<p>另一个直观解释是当你使用tanh之类的激活函数的时候，当$\lambda$非常大的时候，那么w非常小，因此z也非常小，经过激活函数变化之后的a也非常小，因此a值只能在0附近变化，这一段tanh函数基本相当于一个线性函数，也就是多层神经网络变化之后基本相当于在做线性变换，就变成一个接近线性变化的值</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/41548130.jpg"></p>
<h3 id="dropout-正则化"><a href="#dropout-正则化" class="headerlink" title="dropout 正则化"></a>dropout 正则化</h3><p>dropout正则化，也就是丢弃法正则化，也成为随机失活正则化。</p>
<p>对每个点进行抛硬币，50%的概率丢弃该点，得到一个丢弃一部分的神经网络，这个方法虽然听上去不可靠，但是实际表现却不错</p>
<p>随机失活正则化的实现方法：</p>
<p>假设有一个L&#x3D;3的神经网络，先设置一个保留率keep-prob，随机产生一个3*n的矩阵，与keep-prob比较之后产生d3，让原本的w乘以这个d3，再除以一个keep-prob以消除引入随机失活的影响（因为你引入随机失活，相当于对某层的a乘以一个keep-prob，那么我要结果一样，就要除以一个keep-prob）</p>
<p>举个例子为什么要除以keep-prob，比如我们现在第三层有50个点，如果keep-prob为0.8的话，那么这层大概平均来说有10个点要失效，$z^{[4]}&#x3D;w^{[4]}a^{[3]}+b^{[4]}$，那么此时的$a^{[3]}$的期望就变成了原来的80%，为了使得$z^{[4]}$的期望不变，我们就需要将$a^{[3]}$除以一个keep-prob来确保$z^{[4]}$期望不变。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-11/1978794.jpg"></p>
<h3 id="随机失活正则化的理解"><a href="#随机失活正则化的理解" class="headerlink" title="随机失活正则化的理解"></a>随机失活正则化的理解</h3><p>直观解释：因为你不知道哪一个神经元可能被丢弃，所以你不能过分依赖某个神经元，因此权重就不得不分散</p>
<p>在真正使用的时候，如果你担心某层容易过拟合，那么就把这一层的留存率设置的低一些；如果确认不会过拟合，那就把留存率设置接近1，比如在输入层这里留存率就应该是1</p>
<h3 id="其它正则化方法"><a href="#其它正则化方法" class="headerlink" title="其它正则化方法"></a>其它正则化方法</h3><p>在图片处理的时候，如果你没有更多的数据，比如处理猫之类的：你可以将图片进行水平翻转，或者放大旋转之类的，处理数字的时候：可以扭曲加旋转</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-12/9225476.jpg"></p>
<p>另一种方法叫做<strong>早终止方法</strong>（early stopping）</p>
<p>画出训练集的代价函数和开发集的代价函数，选择两者都还比较小的值</p>
<h3 id="归一化（normalization）"><a href="#归一化（normalization）" class="headerlink" title="归一化（normalization）"></a>归一化（normalization）</h3><p>归一化可以加速训练过程</p>
<p>归一化的过程：<strong>减去均值（$x-\mu$），将方差归一化$(x-\mu)&#x2F;\sigma$</strong></p>
<p>归一化过程中一定要注意，对训练集和测试集都需要归一化</p>
<h3 id="梯度消失和梯度爆炸"><a href="#梯度消失和梯度爆炸" class="headerlink" title="梯度消失和梯度爆炸"></a>梯度消失和梯度爆炸</h3><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190225112424.png"></p>
<p>由于：</p>
<p>$$a^{[l]}&#x3D;\sigma(w^{[l]}a^{[l-1]}+b^{[l]}) \tag{1}$$</p>
<p>$$a^{[l-1]}&#x3D;\sigma(w^{[l-1]}a^{[l-2]}+b^{[l-1]}) \tag{2}$$</p>
<p>$$a^{[l-2]}&#x3D;\sigma(w^{[l-2]}a^{[l-3]}+b^{[l-2]}) \tag{3}$$</p>
<p>求导可得</p>
<p>$dz^{[l]}&#x3D;da^{[l]} * {g^{[l]}}’(z^{[l]}) \tag{4}​$</p>
<p>$dw^{[l]}&#x3D;dz^{[l]}*a^{[l-1]}\tag{5} $</p>
<p>$db^{[l]}&#x3D;dz^{[l]}\tag{6}​$</p>
<p>接着求前一层：</p>
<p>由上面公式(1)可以得到：</p>
<p>$da^{[l-1]}&#x3D;dz^{[l]}*w^{[l]}\tag{7}​$</p>
<p>由公式(2)得到：</p>
<p>$dz^{[l-1]}&#x3D;da^{[l-1]} * {g^{[l-1]}}’(z^{[l-1]}) \tag{8}​$</p>
<p>$dw^{[l-1]}&#x3D;dz^{[l-1]}*a^{[l-2]} \tag{9}​$</p>
<p>结合(7),(8),(9)得到：</p>
<p>$dw^{[l-1]}&#x3D;dz^{[l]}<em>w^{[l]}</em> {g^{[l-1]}}’(z^{[l-1]}) \tag{10}$</p>
<p>继续对(3)进行求导：</p>
<p>$dz^{[l-2]}&#x3D;da^{[l-2]} * {g^{[l-2]}}’(z^{[l-2]}) \tag{11}​$</p>
<p>$dw^{[l-2]}&#x3D;dz^{[l-2]}*a^{[l-3]} \tag{12}$</p>
<p>由公式(2)得到：</p>
<p>$da^{[l-2]}&#x3D;dz^{[l-1]}*w^{[l-1]}\tag{13}​$</p>
<p>结合(11),(12),(13)得到：</p>
<p>$dw^{[l-2]}&#x3D;dz^{[l-1]}<em>w^{[l-1]}</em>{g^{[l-2]}}’(z^{[l-2]})*a^{[l-3]}​$</p>
<p>再结合(4),(7),(8)可得</p>
<p>$dw^{[l-2]}&#x3D;da^{[l]}<em>w^{[l]}<em>w^{[l-1]}</em>{g^{[l]}}’(z^{[l]})</em>{g^{[l-1]}}’(z^{[l-1]}) *{g^{[l-2]}}’(z^{[l-2]})*a^{[l-3]}$</p>
<p>比如你的激活函数是g(z)&#x3D;z，损失函数是交叉熵函数，$da&#x3D;a-y​$然后$dw^{[1]}&#x3D;w^{[l]}\times w^{[l-1]}\times…\times w^{[2]}\times w^{[1]}\times X​$，只要所有w都是对角矩阵，他的某一项大于1，则出现梯度爆炸，求出的梯度非常大，或者是梯度消失，求出的梯度基本为0</p>
<h3 id="权重初始化和深度网络"><a href="#权重初始化和深度网络" class="headerlink" title="权重初始化和深度网络"></a>权重初始化和深度网络</h3><p>特殊地初始化可以部分解决梯度爆炸和梯度消失的问题</p>
<p>在使用Relu激活函数的时候：</p>
<p>$W^{[L]}&#x3D;np.random.randn(shape) * np.sqrt(1&#x2F;n)​$</p>
<h3 id="梯度检验"><a href="#梯度检验" class="headerlink" title="梯度检验"></a>梯度检验</h3><p>根据导数的定义，对代价函数进行求导：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-12/31073973.jpg"></p>
<p>检查：两个导数之间的欧式距离&#x2F;两个导数的2范数之和，如果基本等于$\epsilon$的话，那就说明正确了，如果大于$\epsilon$很多的话，就说明错了</p>
<h3 id="梯度下降的实现"><a href="#梯度下降的实现" class="headerlink" title="梯度下降的实现"></a>梯度下降的实现</h3><ul>
<li>只在调试的时候用提督检验，在训练的时候不要用</li>
<li>如果算法梯度检验失败，检查每一个dw，db来找到程序的bug</li>
<li>记得正则化</li>
<li>在没有dropout的时候先进行梯度检验，发现算法没有问题再使用dropout</li>
<li>随机初始化可以先运行一下梯度检验</li>
</ul>
<h3 id="合适的初始化方法"><a href="#合适的初始化方法" class="headerlink" title="合适的初始化方法"></a>合适的初始化方法</h3><p>He初始化方法（<a href="https://arxiv.org/abs/1502.01852">He et al., 2015</a>），在激活函数是Relu的时候非常有效，具体做法是$W^{[l]}&#x3D;\rm{np.random.randn}(layer_dimension[l],layer_dimension[l-1])*\rm{np.sqrt}(2.&#x2F;layer_dimension[l-1])$</p>
<h2 id="第二周"><a href="#第二周" class="headerlink" title="第二周"></a>第二周</h2><h3 id="优化算法"><a href="#优化算法" class="headerlink" title="优化算法"></a>优化算法</h3><p>向量化可以高效计算m个example，但是当example非常多的时候，计算起来也是非常的慢的，比如你现在有500w个example，拿计算起来就是非常慢的</p>
<p>为了加快计算的速度，提出了mini-batch gradient descent，也就是批量梯度下降，将数据分成一个个的小batch，然后进行前向传播，反向传播，参数更新等步骤，这样计算速度会快上很多</p>
<p>比如现在有500w条数据，将每1000条数据凑成一个batch，用<code>&#123;&#125;</code>来表示第多少个batch，现在分成了$X^1$到$X^5000$共5000个batch，每个batch的维度是$(n_x,1000)$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-28/23613139.jpg"></p>
<p>Y以同样的方法被分成5000份，每个$Y^$的维度是(1，1000)</p>
<p>到目前为止，我们一共用过三种括号，分别是小括号，中括号，和大括号</p>
<ul>
<li>小括号：$x^{(i)}$，表示第i个训练实例</li>
<li>中括号：$Z^{[L]}$表示第L层</li>
<li>大括号：$X^$,$Y^$表示第t个batch</li>
</ul>
<p>分成batch之后的步骤和之前的神经网络的构建步骤一样，只是多了一重循环batch的for</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-28/12421014.jpg"></p>
<h3 id="理解mini-batch梯度下降"><a href="#理解mini-batch梯度下降" class="headerlink" title="理解mini-batch梯度下降"></a>理解mini-batch梯度下降</h3><p>批量梯度下降的损失函数往往一直下降，但是mini-batch梯度下降存在噪声，但是整体趋势是下降的</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-4-30/72186468.jpg"></p>
<p>两种极端情况：</p>
<ol>
<li>如果mini-batch的size&#x3D;m，那么这就是梯度下降，梯度下降的好处是每一步迭代都是往最优值的方向去靠近，但是数据量很大的时候，批量梯度下降就会非常的慢，这种情况又被称为批梯度下降</li>
<li>如果mini-batch的size&#x3D;1，那么这种情况就是每次输入一个example，这样每次迭代的方向可能是乱的，最终的结果可能在最优值附近徘徊，这种情况又被称为随机梯度下降</li>
<li>只有mini-batch值合适的时候，才能既用到向量化的加速运算，又能得到一个最优值</li>
</ol>
<p>一般认为：</p>
<p>在m&lt;&#x3D;2000时，认为数据量足够下，可以使用批量梯度下降</p>
<p>在m&gt;2000时，通常使用的mini-batch的size为64, 128, 256, 512，用2的倍数是因为内存读取的方式是通过2的倍数来读取的，这样能够加快运算</p>
<h3 id="指数加权平均"><a href="#指数加权平均" class="headerlink" title="指数加权平均"></a>指数加权平均</h3><p>如图，是一大堆温度数据，我们为了对温度数据做个平均，用v0&#x3D;0,$v_1&#x3D;0.9v_0+0.1\theta_1$，一直到$v_t&#x3D;0.9v_{t-1}+0.1\theta_t$进行指数加权平均</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-1/63473191.jpg"></p>
<p>这种指数加权平均的效果的$v_{t}$就大致等同于对$\frac{1}{1-\beta}$天的数据进行平均，其中$\beta$是$v_t&#x3D;\beta v_{t-1}+(1-\beta)\theta_t$这个公式中的系数</p>
<p>比如，当$\beta&#x3D;0.9$时，这就相当于对前10天的数据进行平均；当的$\beta&#x3D;0.98$时，这就相当于对前50天的数据进行平均；当的$\beta&#x3D;0.5$时，这就相当于对前2天的数据进行平均</p>
<p>更大的$\beta$意味着更平滑的曲线，但是对数据的延迟性也更大</p>
<h3 id="指数加权平均的理解"><a href="#指数加权平均的理解" class="headerlink" title="指数加权平均的理解"></a>指数加权平均的理解</h3><p>通用的迭代公式：$v_t&#x3D;\beta v_{t-1}+(1-\beta)\theta_t $</p>
<p>我们来举个例子，假如$\beta&#x3D;0.9$</p>
<p>那么</p>
<p>$v_{100}&#x3D;0.9 v_{99}+0.1\theta_{100}$</p>
<p>$v_{99}&#x3D;0.9 v_{98}+0.1\theta_{99}$</p>
<p>$v_{98}&#x3D;0.9 v_{97}+0.1\theta_{98}$</p>
<p>将$v_{100}&#x3D;0.9 v_{99}+0.1\theta_{100}$展开可以得到</p>
<p>$v_{100}&#x3D;0.9 v_{99}+0.1\theta_{100}&#x3D;0.1\theta_{100}+0.9(0.1\theta_{99}+0.9 v_{98})&#x3D;0.1\theta_{100}+0.9*0.1\theta_{99}+0.9^2(0.9 v_{97}+0.1\theta_{98})…$ </p>
<p>这个过程与我们平时的平均数有类似的地方，因为我们平时求解的平均数是在每个$\theta$前面的系数相等，都是1&#x2F;n，在指数加权平均的时候，将靠的近的系数放大，靠的远的系数变小，以指数形式衰减</p>
<p>这样下去，要使得v的加和的那一项足够小， 也就是$0.1*0.9^{t}$足够小的情况下，$0.9^{10}&#x3D;1&#x2F;e$，就认为是10天的平均</p>
<p><strong>指数加权平均的好处：</strong> </p>
<p>我们可以看到指数加权平均的求解过程实际上是一个递推的过程，那么这样就会有一个非常大的好处，每当我要求从0到某一时刻（n）的平均值的时候，我并不需要像普通求解平均值的作为，保留所有的时刻值，类和然后除以n。</p>
<p>而是只需要保留0-(n-1)时刻的平均值和n时刻的温度值即可。也就是每次只需要保留常数值，然后进行运算即可，这对于深度学习中的海量数据来说，是一个很好的减少内存和空间的做法。</p>
<h3 id="偏差修正"><a href="#偏差修正" class="headerlink" title="偏差修正"></a>偏差修正</h3><p>因为$v_0&#x3D;0$，而$v_1&#x3D;0.98v_0+0.02\theta_1$，因为$v_0&#x3D;0$，所以$v_1&#x3D;0.02\theta_1$；$v_2&#x3D;0.98v_1+0.02\theta_2$，$v_2&#x3D;0.0196\theta_1+0.02\theta_2$</p>
<p>由于上面两个等式展现的原因，这些v的值在初始阶段都很小，为了使这些初始阶段的值可以作为平均，我们用$v_t&#x3D;\frac{v_t}{1-\beta^t}$来进行偏差修正，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-2/83045151.jpg"></p>
<h3 id="动量-Momentum-梯度下降"><a href="#动量-Momentum-梯度下降" class="headerlink" title="动量(Momentum)梯度下降"></a>动量(Momentum)梯度下降</h3><p>动量梯度下降比普通的梯度下降更快，其主要思想是：计算梯度的指数加权平均，使用这个梯度来更新权重</p>
<p>实现的方式如下，$\beta$参数最常用的值就是0.9：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-2/7255551.jpg"></p>
<p>进行动量梯度下降之后，纵轴上的偏差被减小了，得到如下图红线的效果</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-2/48630632.jpg"></p>
<h3 id="RMSprop-Root-Mean-Square-prop-算法"><a href="#RMSprop-Root-Mean-Square-prop-算法" class="headerlink" title="RMSprop(Root Mean Square prop)算法"></a>RMSprop(Root Mean Square prop)算法</h3><p>实现的方法和momentum类似，但是公式变成了</p>
<p>$S_{dw}&#x3D;\beta_2S_{dw}+(1-\beta_2)dw^{2}$</p>
<p>$S_{db}&#x3D;\beta_2S_{db}+(1-\beta_2)db^{2}$</p>
<p>而迭代公式变成了</p>
<p>$w:&#x3D;w-\alpha\frac{dw}{\sqrt{S_{dw}}+\epsilon}$</p>
<p>$b:&#x3D;b-\alpha\frac{dw}{\sqrt{S_{db}}+\epsilon}$</p>
<p>加一个$\epsilon$是为了不出现除以0的情况</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-2/46166279.jpg"></p>
<h3 id="Adam-Adaptive-moment-estimation-优化算法"><a href="#Adam-Adaptive-moment-estimation-优化算法" class="headerlink" title="Adam(Adaptive moment estimation) 优化算法"></a>Adam(Adaptive moment estimation) 优化算法</h3><p>Adam(Adaptive moment estimation)的意思是：适应性矩优化，这里的矩指的是一阶矩，二阶矩那个矩。</p>
<p>Adam就是将momentum和RMSprop结合起来</p>
<p>实现方法如下图，注意这里的参数都需要修正偏差：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-2/70350494.jpg"></p>
<p>里面的超参，一般来说momentum的超参$\beta_1&#x3D;0.9$，RMSprop的超参$\beta_2&#x3D;0.999$，$\epsilon&#x3D;10^{-8}$，学习率$\alpha$ 是需要去调整的参数，Adam的公式如下，将w换成b则得到b的更新公式</p>
<p>$$<br>\begin{cases}<br>v_{dW^{[l]}} &#x3D; \beta_1 v_{dW^{[l]}} + (1 - \beta_1) \frac{\partial \mathcal{J} }{ \partial W^{[l]} } \</p>
<p>v^{corrected}<em>{dW^{[l]}} &#x3D; \frac{v</em>{dW^{[l]}}}{1 - (\beta_1)^t} \<br>s_{dW^{[l]}} &#x3D; \beta_2 s_{dW^{[l]}} + (1 - \beta_2) (\frac{\partial \mathcal{J} }{\partial W^{[l]} })^2 \<br>s^{corrected}<em>{dW^{[l]}} &#x3D; \frac{s</em>{dW^{[l]}}}{1 - (\beta_2)^t} \<br>W^{[l]} &#x3D; W^{[l]} - \alpha \frac{v^{corrected}<em>{dW^{[l]}}}{\sqrt{s^{corrected}</em>{dW^{[l]}}} + \varepsilon}<br>\end{cases}<br>$$</p>
<h3 id="学习率衰减"><a href="#学习率衰减" class="headerlink" title="学习率衰减"></a>学习率衰减</h3><p>我们用下面的公式来衰减学习率$\alpha$：</p>
<p>$\alpha&#x3D;\frac{1}{1+decay_rate\times epoch_num}\alpha_0$</p>
<p>decay_rate是这里的下降率，epoch_num是迭代的次数</p>
<h3 id="局部最优解"><a href="#局部最优解" class="headerlink" title="局部最优解"></a>局部最优解</h3><p>在二维图像中，很容易产生局部最优解，但是在高维的时候，你要找到一个这个点在所有维度上梯度都为0，这是非常困难的，我们称这种有部分维度梯度为0的点为鞍点，因为图形的形状就好像马鞍一样</p>
<h3 id="Week-3"><a href="#Week-3" class="headerlink" title="Week 3"></a>Week 3</h3><h2 id="Batch-Normalization"><a href="#Batch-Normalization" class="headerlink" title="Batch Normalization"></a>Batch Normalization</h2><h3 id="调参过程"><a href="#调参过程" class="headerlink" title="调参过程"></a>调参过程</h3><p>神经网络有很多的超参，调整超参有利于改进神经网络的性能</p>
<p>参数有很多，包括：学习率$\alpha$，momentum当中的$\beta$，Adam优化中的$\beta_1,\beta_2,\epsilon$，网络层数，隐藏单元，学习率衰减方式，mini-batch的size</p>
<p>一般来说需要调整的重要程度排序为：</p>
<p>$\alpha&gt;\rm{momentum当中的}\beta&#x3D;mini-batch\ size&#x3D;隐藏单元数量&gt;网络层数&gt;学习率衰减参数&gt;&gt;Adam（Adam一般不调参，用默认参数\beta_1&#x3D;0.9,\beta_2&#x3D;0.999,\epsilon&#x3D;10^{-8}）$</p>
<p>但这并不是一个死板的规定，可能有其他的规则</p>
<p>早期调参的时候，通常是启发式搜索，然后给定最优的参数；参数很多的时候，建议随机选择点，进行尝试，如下图右边</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/80735041.jpg"></p>
<p>当你能确定更小的范围的时候，就可以在这个范围内进行更加密集的搜索，直到找到你能接受的最优参数</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/20607262.jpg"></p>
<h3 id="选择合适尺度去选取超参数"><a href="#选择合适尺度去选取超参数" class="headerlink" title="选择合适尺度去选取超参数"></a>选择合适尺度去选取超参数</h3><p>很多超参数是不能在某个范围内均匀取样的，比如考虑学习率$\alpha$，让$\alpha$从0.0001到1取值，肯定要求在0.0001到0.001之前取多点，而0.1-1之间要比较少，所以我们此时用到对数的取法，也就是从10e-4取到10e0，那我们就只需要去一个-4到0的随机数，用a &#x3D; -4 * np.random.randn(), alpha&#x3D;10**a</p>
<p>还有比如momentum当中的$\beta$参数，如果让$\beta$从0.9取到0.999，在靠近0.999的时候，稍微改变一点点都会让平均值的范围变化很大，因此在后面我们要取的密集一些，我们考虑$1-\beta$，$\beta$从0.9到0.999，那么$1-\beta$就从0.1到0.001，取一个从-3到-1的随机数，再用10的指数来代替$1-\beta$，那么$\beta&#x3D;1-10^t$</p>
<h3 id="熊猫模型和鱼子酱模型"><a href="#熊猫模型和鱼子酱模型" class="headerlink" title="熊猫模型和鱼子酱模型"></a>熊猫模型和鱼子酱模型</h3><p>熊猫模型：关注你的模型，就如同熊猫产子一般，一次调整一点</p>
<p>鱼子酱模型：一次同时开始多个模型的训练，如同鱼类产子一般</p>
<p>计算资源足够的时候，就用鱼子酱模型，否则用熊猫模型</p>
<p>这两个名称只是为了好记忆，并没有特别的意思</p>
<h3 id="批量归一化"><a href="#批量归一化" class="headerlink" title="批量归一化"></a>批量归一化</h3><p>在之前的归一化当中，我们只是对第一步的输入进行了归一化，但是其实每一层神经网络的输入应该都有归一化，在归一化z和a这两种选择中，业界都默认归一化z</p>
<p>对z的归一化过程如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/36826086.jpg"></p>
<p>红框部分就是归一化的过程，对于每一个z(i)，计算均值$\mu$，方差$\sigma^2$，然后用$z^{(i)}<em>{norm}&#x3D;\frac{z^{(i)}-\mu}{\sqrt{\sigma^2+\epsilon}}$，这里加一个$\epsilon$的原因是为了避免除以0的情况发生，然后用$\tilde{z}^{(i)}&#x3D;\gamma z^{(i)}</em>{norm}+\beta$，这个$\gamma$和$\beta$是可以从模型当中学习出来的参数。</p>
<p>为什么要用$\gamma$和$\beta$这两个参数呢，是因为比如你中间某一层的激活函数是sigmoid函数，如果你让你的z均值为0，方差为1，那么z的变化范围就很靠近0，这是sigmoid函数基本就成了线性函数，为了利用好sigmoid的非线性，所以对中间的z的归一化稍有不同</p>
<h3 id="将batch-norm运用到神经网络中"><a href="#将batch-norm运用到神经网络中" class="headerlink" title="将batch-norm运用到神经网络中"></a>将batch-norm运用到神经网络中</h3><p>假设我们有一个如下图所示的三层神经网络，那么我们将x输入，通过w[1]和b[1]，得到z[1]，对z1进行batch-norm，通过$\gamma^{[1]}$和$\beta^{[1]}$得到$\tilde{z}^{[1]}$，然后将$\tilde{z}^{[1]}$通过g[1]得到a[1]，同理得到z[2]，$\tilde{z}^{[2]}$，a[2]</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/5744779.jpg"></p>
<p>此时的参数就有了w[1],b[1],w[2],b[2]，$\gamma^{[1]}$,$\beta^{[1]}$,$\gamma^{[2]}$,$\beta^{[2]}$,在TensorFlow中我们可以直接一行语句实现batch-normalization,<code>tf.nn.batch-normalization</code></p>
<p>那如何将batch-normalization用到mini-batch-normalization中呢</p>
<p>如下图，每次用一个mini-batch，对其进行batch-normalization。</p>
<p>值得注意的是，因为$z^{[l]}&#x3D;w^{[l]}a^{[l-1]}+b^{[l]}$，而$z_{norm}&#x3D;\frac{z-\mu}{\sqrt{\sigma^2+\epsilon}}$，每次归一化的时候减去了均值，所以加的$b^{[l]}$会被减掉，因此b这个参数在mini-batch-normalization时可以忽略</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/5343372.jpg"></p>
<p>实现的具体方法，对于每一次mini-batch t，计算对于$X^{[t]}$的前向传播，对每个隐藏层使用BN（batch-normalization）方法，然后反向传播去更新W,$\beta$,$\gamma$三个参数（b被减掉因此忽略），当然这里更新的方式可以是momentum，RMSprop或者Adam</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/57297767.jpg"></p>
<h3 id="为什么batch-normalization会有效"><a href="#为什么batch-normalization会有效" class="headerlink" title="为什么batch-normalization会有效"></a>为什么batch-normalization会有效</h3><p>首先，normalization会使得所有的x的值在同一个量级上面，这样能够加速迭代</p>
<p>协变量转换（covariate shift）是指在数据x变化之后，原来的网络不适用于分类新的数据的情况，如果我们使用了batch-normalization方法，前面层的变化对后面层的影响就降低了，因为被平均了，所以BN会使得系统优化的结果更好</p>
<p>同时，这还起到了一点点正则化的作用，因为每个mini-batch在计算的时候都被平均了，所以整个网络对于数据的适应性就没有那么强了</p>
<h3 id="对测试数据的batch-norm"><a href="#对测试数据的batch-norm" class="headerlink" title="对测试数据的batch norm"></a>对测试数据的batch norm</h3><p>在训练阶段，我们每次可以用一次批量的值计算均值和方差，但是在测试阶段，我们每次输入的只有一个值，这时候我们进行batch norm的均值和方差从哪里来呢？</p>
<p>解决办法就是，记录下训练数据的均值和方差，然后对各个mini-batch norm的均值和方差做指数权重平均，在测试阶段使用</p>
<h2 id="多分类"><a href="#多分类" class="headerlink" title="多分类"></a>多分类</h2><h3 id="softmax-Regression"><a href="#softmax-Regression" class="headerlink" title="softmax Regression"></a>softmax Regression</h3><p>我们之前接触的问题都是二分类，当我们要进行多分类的时候，就要用到一个特殊的激活函数，叫做softmax</p>
<p>假设我们要分类的类别数C&#x3D;4，标签为0,1,2,3，那么在最后一层，我们要输出一个4*1的输出层，每一个输出点代表分到该类的概率</p>
<p>举个例子，我们得到了最后一层的输入为z[L] &#x3D; [5,2,-1,3]，我们用指数函数对其变换，$t &#x3D; [e^5,e^2,e^{-1},e^3]$，计算比例得到$a^{[L]}$，如下图所示</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/89577231.jpg"></p>
<h3 id="对softmax的理解"><a href="#对softmax的理解" class="headerlink" title="对softmax的理解"></a>对softmax的理解</h3><p>softmax是一个$\frac{e^{z_j}}{\sum_ke^{z_k}}$形式的激活函数，当分类的类别C&#x3D;2的时候，softmax就是logistics函数</p>
<p>softmax的loss一般取为：$L(\hat{y},y)&#x3D;-\sum_{j&#x3D;1}^Cy_j\log \hat{y}_j$</p>
<p>真实的y和$\hat y$的形式如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/60312042.jpg"></p>
<p>真实值只有真的那个地方为1，别的地方为0，$\hat y$是C个概率，代表分到每一类的概率</p>
<p>因为y一般有很多个需要分类的样本，所以真实的y和$\hat y$如下，其中的4是此时分为4类</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/75203372.jpg"></p>
<p>反向传播中，softmax的导数的求法稍微复杂一点，过程如下：</p>
<p>首先求$\partial J&#x2F;\partial a$，虽然这里有个累加，但是其实只有真实的那类$y_j&#x3D;1$，别的都是0，所以求和号可以去掉，变成$J&#x3D;y_j\log \hat{y}_j$，对$\hat y$求偏导可以得到，$\partial J&#x2F;\partial a&#x3D;-1&#x2F;\hat{y}_j$</p>
<p>接下来求softmax的导数，也就是$\hat{y}_j$对所有的$z_i$求导数，分为i&#x3D;j和i!&#x3D;j的情况来求</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-3/83926609.jpg"></p>
<p>这样，$\partial J&#x2F;\partial z$的值就可以通过链式法则得到</p>
<p>当i&#x3D;j时，$\partial J&#x2F;\partial z&#x3D;a_j-1$</p>
<p>当i!&#x3D;j时，$\partial J&#x2F;\partial z&#x3D;-a_i$</p>
<p>在使用深度学习框架的时候，比如TensorFlow和caffe，我们只需要规划好前向传播的过程，反向传播的过程框架会自动帮你完成</p>
<h2 id="深度学习框架的介绍"><a href="#深度学习框架的介绍" class="headerlink" title="深度学习框架的介绍"></a>深度学习框架的介绍</h2><p>目前主流的深度学习框架和选择标准如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-4/69914394.jpg"></p>
<h3 id="TensorFlow简介"><a href="#TensorFlow简介" class="headerlink" title="TensorFlow简介"></a>TensorFlow简介</h3><p>引入TensorFlow，通过<code>import tensorflow as tf</code></p>
<p>w设置为tf当中的变量，用<code>tf.Variable(initial_value=0,dtype=tf.float32)</code>表示</p>
<p>x是输入值，一开始不知道是多少，只表示dtype和shape，用<code>tf.placeholder(dtype=tf.float32,shape=[3,1])</code>表示</p>
<p>表示cost函数，因为tf已经重载了加减乘除的形式，所以可以直接用加减乘除表示，也可以用<code>tf.add</code>之类的表示，矩阵乘法的表示是<code>tf.matmul()</code></p>
<p>之后表示train的方法和目标：我们这里用梯度下降，最小化cost<code>train = tf.train.GradientDescentOptimizer(0.01).minimize(cost)</code>，如果要用别的优化方法，只需要将<code>GradientDescentOptimizer</code>替换为别的函数就好了，括号里面的参数是learning-rate</p>
<p>然后初始化变量值，<code>init = tf.global_variables_initializer()</code></p>
<p>定义一个session，用session来run一下init，再run一下w，看看w的值，最后迭代run(train)</p>
<p>也可以用如下形式定义session</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> session:</span><br><span class="line">	session.run(init)</span><br><span class="line">    session.run(w)</span><br></pre></td></tr></table></figure>

<p>placeholder的值可以用feed_dict传入</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sess = tf.Session()</span><br><span class="line">x = tf.placeholder(tf.int64, name = <span class="string">&#x27;x&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(sess.run(<span class="number">2</span> * x, feed_dict = &#123;x: <span class="number">3</span>&#125;))</span><br><span class="line">sess.close()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-4/92497288.jpg"></p>
<p>写TensorFlow的代码过程大致如下：</p>
<ol>
<li>建立未执行的tensor变量</li>
<li>写tensor之间的运算</li>
<li>初始化tensor</li>
<li>建立session</li>
<li>运行session，将会运行你简历里的运算</li>
</ol>
<p>所有的运算都要run之后才能执行，如果你直接print运算的话，只会得到一个tensor，也就是计算图</p>
<p>因此，请注意初始化变量，建立session并run operation</p>
<h4 id="损失计算"><a href="#损失计算" class="headerlink" title="损失计算"></a>损失计算</h4><p>计算形如：</p>
<p>$$ J &#x3D; - \frac{1}{m}  \sum_{i &#x3D; 1}^m  \large ( \small y^{(i)} \log a^{ [2] (i)} + (1-y^{(i)})\log (1-a^{ [2] (i)} )\large )\small$$</p>
<p>这样的损失的时候，可以使用tf内置的<code>tf.nn.sigmoid_cross_entropy_with_logits</code>函数实现</p>
<h4 id="one-hot-encoding"><a href="#one-hot-encoding" class="headerlink" title="one_hot encoding"></a>one_hot encoding</h4><p>one_hot：只有一个值为1，别的值都为0的vector，用<code>tf.one_hot</code>实现，参数<code>indices</code>表示需要转换的向量, <code>depth</code>表示一共多少个类， <code>on_value=None</code>表示符合类的值为多少, <code>off_value=None</code>表示不符合类的值是多少, <code>axis</code>为0表示每个indices放一行，-1表示每个indices放一列</p>
<h4 id="实现TensorFlow-model的步骤"><a href="#实现TensorFlow-model的步骤" class="headerlink" title="实现TensorFlow model的步骤"></a>实现TensorFlow model的步骤</h4><ol>
<li>建立一个计算图</li>
<li>run这个计算图</li>
</ol>
<h3 id="初始化参数的方法"><a href="#初始化参数的方法" class="headerlink" title="初始化参数的方法"></a>初始化参数的方法</h3><p>W用Xavier初始化，b用zero初始化</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">W1 = tf.get_variable(<span class="string">&quot;W1&quot;</span>, [<span class="number">25</span>,<span class="number">12288</span>], initializer = tf.contrib.layers.xavier_initializer()）</span><br><span class="line">b1 = tf.get_variable(<span class="string">&quot;b1&quot;</span>, [<span class="number">25</span>,<span class="number">1</span>], initializer = tf.zeros_initializer())</span><br></pre></td></tr></table></figure>

<h3 id="反向传播的方法"><a href="#反向传播的方法" class="headerlink" title="反向传播的方法"></a>反向传播的方法</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#For instance, for gradient descent the optimizer would be:</span></span><br><span class="line">optimizer = tf.train.GradientDescentOptimizer(learning_rate = learning_rate).minimize(cost)</span><br><span class="line"><span class="comment">#To make the optimization you would do:</span></span><br><span class="line">_ , c = sess.run([optimizer, cost], feed_dict=&#123;X: minibatch_X, Y: minibatch_Y&#125;)</span><br></pre></td></tr></table></figure>













]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>deeplearning</tag>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Coursera-deeplearning-ai-（四）</title>
    <url>/2018/05/10/Coursera-deeplearning-ai-%EF%BC%88%E5%9B%9B%EF%BC%89/</url>
    <content><![CDATA[<p>这篇博文主要讲的是关于deeplearning.ai的第四门课程的内容，《Convolutional Neural Networks》</p>
<span id="more"></span>

<h2 id="Week-One"><a href="#Week-One" class="headerlink" title="Week One"></a>Week One</h2><h3 id="计算机视觉"><a href="#计算机视觉" class="headerlink" title="计算机视觉"></a>计算机视觉</h3><p>在处理计算机视觉问题的时候，我们可能处理的图片很大，之前我们用的都是64*64*3维度的图片，这样的图片不够清晰，如果我们用1000*1000*3大小的图片，每张图片的维度就是300w，这就需要很多的数据来调参，并且对系统的资源占用非常大，此时就要用到卷积的技巧，它是卷积神经网络的基础</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/21395179.jpg"></p>
<h3 id="利用卷积进行边缘检测的示例"><a href="#利用卷积进行边缘检测的示例" class="headerlink" title="利用卷积进行边缘检测的示例"></a>利用卷积进行边缘检测的示例</h3><p>比如我有如下左边这张图，我想检测这张图上面有些上面，我首先要用边缘检测，分别检测出他的横向边缘和纵向边缘</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/16688061.jpg"></p>
<p>边缘检测需要用到卷积，那么上面是卷积呢？</p>
<p>首先，假设我们现在有一张6*6的灰度图片（仅有一个rgb通道），我们定义一个3*3的filter，当然有些地方把这个filter称为kernel，我们这里就用filter来表示，那么现在用这个3*3的filter在6*6的图像上面移动，每移动一个位置进行元素乘积求和，最终得到一个4*4的结果矩阵，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/23155888.jpg"></p>
<p>比如左上角的-5，是把3*3的矩阵放在6*6的矩阵的左上角得到的，也就是$-5&#x3D;3\times1+1\times1+2\times1+0\times0+5\times0+7\times0+1\times(-1)+8\times(-1)+2\times(-1)$</p>
<p>然后向右移动一个单位得到-4，一直移动下去得到右边的4*4矩阵</p>
<p>再举一个直观的例子，比如我们现在有个黑白分明的6*6灰度图片，我们要检测它的垂直边缘，用一个3*3的filter卷积，得到一个4*4的垂直边缘结果，如下</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/45594204.jpg"></p>
<p>4*4矩阵中间那块白色的就是边缘，此时看起来边缘很大，那是因为我们这里的原始图片太小了，如果原始图片的大小是1000*1000，那么这个边缘就非常合理了。这里这个边缘也显示了边缘的大体趋势，是正确的</p>
<p>卷积函数在几乎所有深度学习框架当中都有包含，比如TensorFlow当中的<code>tf.nn.conv2d</code></p>
<h3 id="更多的边缘检测"><a href="#更多的边缘检测" class="headerlink" title="更多的边缘检测"></a>更多的边缘检测</h3><p>边缘有着正边缘和负边缘的说法，从黑到白和从白到黑是不同的，如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/36284135.jpg"></p>
<p>当然，还有水平边缘和垂直边缘的区分，很容易想到水平边缘的filter就是大概将竖直边缘filter转动90度</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/56352677.jpg"></p>
<p>然后，根据filter使用的不同，也可以得到不同的边缘，比如常用的还有sobel filter，参数是1,2,1，还有scharr filter，参数是3,10,3，甚至你可以将这3*3的filter的9个值都设置为参数，通过反向传播来学习他们，由此你可以检测出任意角度的边缘，比如45度，70度，73度等等</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/88907670.jpg"></p>
<h3 id="padding-扩充"><a href="#padding-扩充" class="headerlink" title="padding 扩充"></a>padding 扩充</h3><p>上面讲到的直接卷积的方法有两个明显的缺点：</p>
<ol>
<li>图片会被缩小，你输入的是6*6的图片，最终得到的4*4的图片，比原始图片大小小了，如果经过若干层网络的卷积之后，得到的图片就相当小了</li>
<li>边缘信息利用得太少了，比如左上角那个像素，你在计算的过程中只会用到1次，但是中间的像素会用到很多次，那么左上角那个像素包含的信息的权重就被减小了</li>
</ol>
<p>假设我们输入一个n*n的图片，用一个f*f的filter进行卷积，那么最终得到的是一个n-f+1的图片</p>
<p>这时，我们可以使用padding的方法，一次解决上面提到的两个问题，所谓的padding就是将原来的图片向外扩充，扩充的值全部填成0，如下图所示</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/92028937.jpg"></p>
<p>假如我们扩充的大小是p，那么最终得到的图片大小就是n+2p-f+1，要使得最终的图片大小等于初始大小，那么p&#x3D;(f-1)&#x2F;2，f通常都是一个奇数，不是奇数的时候就要混合padding，就是左右padding的范围不一样</p>
<h3 id="带步长的卷积"><a href="#带步长的卷积" class="headerlink" title="带步长的卷积"></a>带步长的卷积</h3><p>通常的卷积是每次移动一格，但是如果你加上步长的话，每次就可以移动步长那么多格，比如你现在有一个7*7的图像，然后有个3*3的filter，如果你每次移动2步，那么最终得到的是一个3*3的图像</p>
<p>这个计算方法是加入你有一个n*n的图像，有一个f*f的filter，stride步长要s，padding的大小p，那么最终得到的图像大小为floor((n+2p-f)&#x2F;2 +1)，其中floor表示向下取整，以防这是一个非整数的情况</p>
<p>我们在神经网络中用的卷积准确来说应该叫做交叉相关，真正的卷积的filter应该先向右翻转90度，再上下翻转（翻转是为了满足矩阵卷积的结合律），但是因为约定，所以我们在神经网络中的交叉相关都被称为卷积</p>
<h3 id="卷积RGB图像"><a href="#卷积RGB图像" class="headerlink" title="卷积RGB图像"></a>卷积RGB图像</h3><p>我们之前卷积的都是黑白图像，如果我们需要卷积三通道的RGB图像，我们应该怎么做呢？</p>
<p>如下图，在卷积RGB图像的时候，我们可以用一个同样有三通道的filter进行卷积，filter的每个通道与RGB的红绿蓝三通道相乘并全部求和，最终得到的卷积结果是只有一个通道的而不是三个通道的</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/69668519.jpg"></p>
<p>当我们需要同时取得图像的垂直边缘，水平边缘或者更多的边缘的时候，我们应该怎么做呢？</p>
<p>如果你需要同时取得多个边缘，你只需要同时使用多个filter即可，得到的结果是很多张边缘图，你也可以把他们stack起来</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/57359168.jpg"></p>
<p>那么我们现在总结一下各个层的维度</p>
<p>输入的图片的维度是: $n\times n \times n_c$，其中$n_c$是指图片通道的数量</p>
<p>filter的维度是$f\times f \times n_c$，这里的filter的通道数和图片的通道数应该相同</p>
<p>得到的边缘结果的维度是$(n-f+1)\times (n-f+1) \times n_c^\prime$，其中$n_c^\prime$表示拥有的filter的数量</p>
<h3 id="单层卷积神经网络"><a href="#单层卷积神经网络" class="headerlink" title="单层卷积神经网络"></a>单层卷积神经网络</h3><p>首先你输入一个RGB三通道的图像，大小是6*6*3，然后通过两个filter，大小是3*3*3，得到两个4*4的Z，分别加上bias b1,b2，然后通过Relu函数进行非线性变换，得到4*4*2</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/24095269.jpg"></p>
<p>将这个单层的卷积神经网络与神经网络比较，这里的输入图像就是x,也就是$a^{[0]}$，通过的filter相当于w，之后的b相当于偏差，relu函数相当于激活函数g，得到的4*4*2的输出相当于$a^{[1]}$</p>
<p>让我们来看看这里面的参数及其维度</p>
<p>用L来表示一个卷积层，$f^{[l]}$表示filter的大小，$p^{[l]}$表示padding的大小，$s^{[l]}$表示stride的大小，$n_c^{[l]}$表示第l层filter的数量</p>
<p>那么输入的维度就是$n_H^{[l-1]}\times n_W^{[l-1]}\times n_c^{[l-1]}$</p>
<p>输出的维度是$n_H^{[l]}\times n_W^{[l]}\times n_c^{[l]}$</p>
<p>其中的$n_H^{[l]}$和$n_W^{[l]}$可以用$n_H^{[l]}&#x3D;\lfloor \frac{n_H^{[l-1]}+2p^{[l]}-f^{[l]}}{s^{[l]}}+1 \rfloor$来计算</p>
<p>每一个filter的大小是：$f^{[l]} \times f^{[l]} \times n_c^{[l-1]}$，因为filter的通道要和输入相同</p>
<p>激活函数$a^{[l]}$的大小是$n_H^{[l]}\times n_W^{[l]}\times n_c^{[l]}$，如果是批处理$A^{[l]}$的大小是$m \times n_H^{[l]}\times n_W^{[l]}\times n_c^{[l]}$</p>
<p>权重w的大小是$f^{[l-1]}\times f^{[l-1]}\times n_c^{[l-1]} \times n_c^{[l]}$</p>
<p>偏差的大小是$n_c^{[l]}$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-10/97636140.jpg"></p>
<h3 id="简单的卷积网络"><a href="#简单的卷积网络" class="headerlink" title="简单的卷积网络"></a>简单的卷积网络</h3><p>下图是一个简单的神经网络的例子，输入层的维度是39*39*3，第一层的$f^{[1]}&#x3D;3$，$s^{[1]}&#x3D;1$，$p^{[1]}&#x3D;0$，有10个filter，那么第一层的输出是37*37*10；第二层的$f^{[2]}&#x3D;5$，$s^{[1]}&#x3D;2$，$p^{[2]}&#x3D;0$，filter个数是20，第二层的输出是17*17*20；第三层的$f^{[3]}&#x3D;5$，$s^{[3]}&#x3D;2$，$p^{[3]}&#x3D;0$，filter个数是40，输出是7*7*40</p>
<p>然后，将得到的7*7*40的图像flatten成一个7*7*40&#x3D;1960*1的向量，然后把这个向量输入一个logistics或softmax函数，以此进行分类</p>
<p>通常来说，卷积网络的图像大小会越来越小，但通道数会越来越多</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-11/9623750.jpg"></p>
<p>卷及网络中的典型层有：</p>
<ol>
<li>Convolution (conv)</li>
<li>Pooling（pool）</li>
<li>Fully connected (FC)</li>
</ol>
<h3 id="Pooling-Layers"><a href="#Pooling-Layers" class="headerlink" title="Pooling Layers"></a>Pooling Layers</h3><p>利用pooling layer去减小表达的大小，加速计算，并使得某些特征更加稳定</p>
<p>pooling layer最常用的就是max pooling，就是用一个filter去移动，但是不是相乘求和，而是求出这个filter移动过程中的最大值，如下所示</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-11/11785024.jpg"></p>
<p>还有一种pooling叫做average pooling，不是求最大值而是平均值，这种pooling用的非常少</p>
<h3 id="一个完整的卷积神经网络示例"><a href="#一个完整的卷积神经网络示例" class="headerlink" title="一个完整的卷积神经网络示例"></a>一个完整的卷积神经网络示例</h3><p>如图，我们输入一个32*32*3的网络，经过一个conv1层，f&#x3D;5,s&#x3D;1，得到一个28*28*6的输出，然后经一个maxpoo层pool1，得到14*14*6，这个conv1和pool1被合称为layer1，因为layer只算那些有参数的层，pool层没有参数，所以conv1和pool1合称一层layer1</p>
<p>然后经过conv2,f&#x3D;5,s&#x3D;1，得到10*10*16，然后经过pool2，得到5*5*16</p>
<p>此时flatten成400*1的向量，然后用普通的神经网络继续传输，此时用普通神经网络的层被称之为fully connected层，W[3]的参数是(120,400)，所以a[3]&#x3D;(120,1)，然后w[4]&#x3D;(84,120)，得到a[4]&#x3D;(84,1)，然后经过一个softmax层，因为我们这里是分类数字0-9，所以最后的输出是(10,1)，然后选择概率最大那个</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-11/71162365.jpg"></p>
<h3 id="为什么要用卷积神经网络"><a href="#为什么要用卷积神经网络" class="headerlink" title="为什么要用卷积神经网络"></a>为什么要用卷积神经网络</h3><p>卷积神经网络可以显著地减少参数，我们来看个例子</p>
<p>如下图你有一个卷积层，本来大小是32*32*3，经过一个卷积层之后大小成了28*28*6，那么你用到的参数个数应该是5*5*6+6&#x3D;156个，如果你直接用全联通层，那么你需要的参数个数是32*32*3*28*28*6&#x3D;14M个，明显这里的参数就非常多了</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-11/43271742.jpg"></p>
<p>还有种解释是卷及网络有参数共享和稀疏连接的好处</p>
<p>如图，你通过卷积层得到的每一个值，都只与自己的那9个卷积的值相关，与别的值不相关，这就是稀疏连接的意思，各个值之间不干扰</p>
<p>参数共享的意思是，比如你有一个3*3的filter，可以进行垂直边缘检测，那么这个filter无论是在<strong>同一张图</strong>的哪个地方，都可以进行边缘检测，而不是说只能在某个地方进行</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-11/32143114.jpg"></p>
<h3 id="利用TensorFlow搭建卷积神经网络"><a href="#利用TensorFlow搭建卷积神经网络" class="headerlink" title="利用TensorFlow搭建卷积神经网络"></a>利用TensorFlow搭建卷积神经网络</h3><p>这周的编程作业就是利用TensorFlow搭建卷积神经网络，那么我们对程序回顾一下</p>
<h4 id="read-data"><a href="#read-data" class="headerlink" title="read data"></a>read data</h4><p>先看看数据读入的程序</p>
<p>数据是存在f5文件中的，用h5py进行读取，然后通过key访问，查看key的方法是list(data.keys())，然后访问某个key下的所有数据的方法是<code>data[&#39;key&#39;][:]</code>，如果不加最后的<code>[:]</code>，那么你取到的是一个h5对象，然后将y reshape成一个行向量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">load_dataset</span>():</span><br><span class="line">    train_dataset = h5py.File(<span class="string">&#x27;datasets/train_signs.h5&#x27;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    train_set_x_orig = np.array(train_dataset[<span class="string">&quot;train_set_x&quot;</span>][:]) <span class="comment"># your train set features</span></span><br><span class="line">    train_set_y_orig = np.array(train_dataset[<span class="string">&quot;train_set_y&quot;</span>][:]) <span class="comment"># your train set labels</span></span><br><span class="line"></span><br><span class="line">    test_dataset = h5py.File(<span class="string">&#x27;datasets/test_signs.h5&#x27;</span>, <span class="string">&quot;r&quot;</span>)</span><br><span class="line">    test_set_x_orig = np.array(test_dataset[<span class="string">&quot;test_set_x&quot;</span>][:]) <span class="comment"># your test set features</span></span><br><span class="line">    test_set_y_orig = np.array(test_dataset[<span class="string">&quot;test_set_y&quot;</span>][:]) <span class="comment"># your test set labels</span></span><br><span class="line"></span><br><span class="line">    classes = np.array(test_dataset[<span class="string">&quot;list_classes&quot;</span>][:]) <span class="comment"># the list of classes</span></span><br><span class="line">    </span><br><span class="line">    train_set_y_orig = train_set_y_orig.reshape((<span class="number">1</span>, train_set_y_orig.shape[<span class="number">0</span>]))</span><br><span class="line">    test_set_y_orig = test_set_y_orig.reshape((<span class="number">1</span>, test_set_y_orig.shape[<span class="number">0</span>]))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> train_set_x_orig, train_set_y_orig, test_set_x_orig, test_set_y_orig, classes</span><br></pre></td></tr></table></figure>

<h4 id="one-hot-transfer"><a href="#one-hot-transfer" class="headerlink" title="one_hot transfer"></a>one_hot transfer</h4><p>接下来是一个one_hot y label 的转换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">convert_to_one_hot</span>(<span class="params">Y, C</span>):</span><br><span class="line">    Y = np.eye(C)[Y.reshape(-<span class="number">1</span>)].T</span><br><span class="line">    <span class="keyword">return</span> Y</span><br></pre></td></tr></table></figure>

<p>np.eye后面跟一个array，就可以制造一个多行的one_hot值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">np.eye(<span class="number">6</span>)[np.array([<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>])]</span><br><span class="line"><span class="comment">#array([[0., 1., 0., 0., 0., 0.],</span></span><br><span class="line"><span class="comment">#       [0., 0., 1., 0., 0., 0.],</span></span><br><span class="line"><span class="comment">#       [0., 1., 0., 0., 0., 0.],</span></span><br><span class="line"><span class="comment">#       [0., 1., 0., 0., 0., 0.],</span></span><br><span class="line"><span class="comment">#       [0., 1., 0., 0., 0., 0.],</span></span><br><span class="line"><span class="comment">#       [0., 1., 0., 0., 0., 0.]])</span></span><br></pre></td></tr></table></figure>

<p>当然你也可以用tf.one_hot函数来实现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">indices = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">depth = <span class="number">3</span></span><br><span class="line">one = tf.one_hot(indices, depth)</span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    <span class="built_in">print</span>(sess.run(one))</span><br><span class="line"><span class="comment">#[[1. 0. 0.]</span></span><br><span class="line"> <span class="comment">#[0. 1. 0.]</span></span><br><span class="line"> <span class="comment">#[0. 0. 1.]]</span></span><br></pre></td></tr></table></figure>

<h4 id="Create-Placeholder"><a href="#Create-Placeholder" class="headerlink" title="Create Placeholder"></a>Create Placeholder</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: create_placeholders</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_placeholders</span>(<span class="params">n_H0, n_W0, n_C0, n_y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Creates the placeholders for the tensorflow session.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    n_H0 -- scalar, height of an input image</span></span><br><span class="line"><span class="string">    n_W0 -- scalar, width of an input image</span></span><br><span class="line"><span class="string">    n_C0 -- scalar, number of channels of the input</span></span><br><span class="line"><span class="string">    n_y -- scalar, number of classes</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    X -- placeholder for the data input, of shape [None, n_H0, n_W0, n_C0] and dtype &quot;float&quot;</span></span><br><span class="line"><span class="string">    Y -- placeholder for the input labels, of shape [None, n_y] and dtype &quot;float&quot;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">### START CODE HERE ### (≈2 lines)</span></span><br><span class="line">    X = tf.placeholder(dtype=tf.float32,shape=(<span class="literal">None</span>, n_H0, n_W0, n_C0))</span><br><span class="line">    Y = tf.placeholder(dtype=tf.float32,shape=(<span class="literal">None</span>,n_y))</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> X, Y</span><br></pre></td></tr></table></figure>

<p>tf.placeholder是建立占位符</p>
<p>None是因为不确定每次输入多少张图片，然后X的维度是height，width，n_c0，y的维度是n_y</p>
<h4 id="initialize-parameters"><a href="#initialize-parameters" class="headerlink" title="initialize_parameters"></a>initialize_parameters</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: initialize_parameters</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">initialize_parameters</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Initializes weight parameters to build a neural network with tensorflow. The shapes are:</span></span><br><span class="line"><span class="string">                        W1 : [4, 4, 3, 8]</span></span><br><span class="line"><span class="string">                        W2 : [2, 2, 8, 16]</span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    parameters -- a dictionary of tensors containing W1, W2</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    tf.set_random_seed(<span class="number">1</span>)                              <span class="comment"># so that your &quot;random&quot; numbers match ours</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment">### START CODE HERE ### (approx. 2 lines of code)</span></span><br><span class="line">    W1 = tf.get_variable(<span class="string">&#x27;W1&#x27;</span>,shape=[<span class="number">4</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">8</span>],initializer=tf.contrib.layers.xavier_initializer(seed = <span class="number">0</span>))</span><br><span class="line">    W2 = tf.get_variable(<span class="string">&#x27;W2&#x27;</span>,shape=[<span class="number">2</span>,<span class="number">2</span>,<span class="number">8</span>,<span class="number">16</span>],initializer=tf.contrib.layers.xavier_initializer(seed = <span class="number">0</span>))</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    parameters = &#123;<span class="string">&quot;W1&quot;</span>: W1,</span><br><span class="line">                  <span class="string">&quot;W2&quot;</span>: W2&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> parameters</span><br></pre></td></tr></table></figure>
<p>tf.get_variable 用于建立变量，第一维的参数是f&#x3D;4,个数是8个；第二维的参数是f&#x3D;2，个数是16个</p>
<h4 id="Forward-propagation"><a href="#Forward-propagation" class="headerlink" title="Forward propagation"></a>Forward propagation</h4><p>我们这里输入parameter和X，网络的结构如下</p>
<p><code>CONV2D -&gt; RELU -&gt; MAXPOOL -&gt; CONV2D -&gt; RELU -&gt; MAXPOOL -&gt; FLATTEN -&gt; FULLYCONNECTED</code> </p>
<p>用<code>tf.nn.conv2d(X,W1,strides=[1, 1, 1, 1],padding=&#39;SAME&#39;)</code>进行卷积，输入A和W，步长的输入方式是[batch,s,s,depth]，batch表示每次跳过多少张图片，depth表示跳过多少通道；padding的方法是’SAME’</p>
<p>每个conv2d的输出是Z，relu之后是A，maxpool之后是P</p>
<p>把图片flatten到一维， <code>P2 = tf.contrib.layers.flatten(P2)</code></p>
<p><code>tf.contrib.layers.fully_connected(P2, num_outputs=6, activation_fn=None)</code>表示全连接层，不用activation_fn是因为最终计算cost的时候会自动用到softmax函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: forward_propagation</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">forward_propagation</span>(<span class="params">X, parameters</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Implements the forward propagation for the model:</span></span><br><span class="line"><span class="string">    CONV2D -&gt; RELU -&gt; MAXPOOL -&gt; CONV2D -&gt; RELU -&gt; MAXPOOL -&gt; FLATTEN -&gt; FULLYCONNECTED</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    X -- input dataset placeholder, of shape (input size, number of examples)</span></span><br><span class="line"><span class="string">    parameters -- python dictionary containing your parameters &quot;W1&quot;, &quot;W2&quot;</span></span><br><span class="line"><span class="string">                  the shapes are given in initialize_parameters</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    Z3 -- the output of the last LINEAR unit</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Retrieve the parameters from the dictionary &quot;parameters&quot; </span></span><br><span class="line">    W1 = parameters[<span class="string">&#x27;W1&#x27;</span>]</span><br><span class="line">    W2 = parameters[<span class="string">&#x27;W2&#x27;</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="comment">### START CODE HERE ###</span></span><br><span class="line">    <span class="comment"># CONV2D: stride of 1, padding &#x27;SAME&#x27;</span></span><br><span class="line">    Z1 = tf.nn.conv2d(X,W1,strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    <span class="comment"># RELU</span></span><br><span class="line">    A1 = tf.nn.relu(Z1)</span><br><span class="line">    <span class="comment"># MAXPOOL: window 8x8, sride 8, padding &#x27;SAME&#x27;</span></span><br><span class="line">    P1 = tf.nn.max_pool(A1,ksize=[<span class="number">1</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">1</span>],strides=[<span class="number">1</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="number">1</span>],padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    <span class="comment"># CONV2D: filters W2, stride 1, padding &#x27;SAME&#x27;</span></span><br><span class="line">    Z2 = tf.nn.conv2d(P1,W2,strides=[<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>],padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    <span class="comment"># RELU</span></span><br><span class="line">    A2 = tf.nn.relu(Z2)</span><br><span class="line">    <span class="comment"># MAXPOOL: window 4x4, stride 4, padding &#x27;SAME&#x27;</span></span><br><span class="line">    P2 = tf.nn.max_pool(A2,ksize=[<span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>],strides=[<span class="number">1</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1</span>],padding=<span class="string">&#x27;SAME&#x27;</span>)</span><br><span class="line">    <span class="comment"># FLATTEN</span></span><br><span class="line">    P2 = tf.contrib.layers.flatten(P2)</span><br><span class="line">    <span class="comment"># FULLY-CONNECTED without non-linear activation function (not not call softmax).</span></span><br><span class="line">    <span class="comment"># 6 neurons in output layer. Hint: one of the arguments should be &quot;activation_fn=None&quot; </span></span><br><span class="line">    Z3 = tf.contrib.layers.fully_connected(P2, num_outputs=<span class="number">6</span>, activation_fn=<span class="literal">None</span>)</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Z3</span><br></pre></td></tr></table></figure>

<h4 id="计算代价"><a href="#计算代价" class="headerlink" title="计算代价"></a>计算代价</h4><p><code>tf.nn.softmax_cross_entropy_with_logits(logits = Z3, labels = Y)</code>，logists表示输出，label表示真正的标签</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: compute_cost </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_cost</span>(<span class="params">Z3, Y</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Computes the cost</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    Z3 -- output of forward propagation (output of the last LINEAR unit), of shape (6, number of examples)</span></span><br><span class="line"><span class="string">    Y -- &quot;true&quot; labels vector placeholder, same shape as Z3</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    cost - Tensor of the cost function</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">### START CODE HERE ### (1 line of code)</span></span><br><span class="line">    cost = tf.reduce_mean(tf.nn.softmax_cross_entropy_with_logits(logits=Z3, labels=Y))</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cost</span><br></pre></td></tr></table></figure>

<h4 id="建立model"><a href="#建立model" class="headerlink" title="建立model"></a>建立model</h4><p>先获取shape，然后定义placeholder</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">(m, n_H0, n_W0, n_C0) = X_train.shape             </span><br><span class="line">n_y = Y_train.shape[<span class="number">1</span>]</span><br><span class="line">costs = []                                        <span class="comment"># To keep track of the cost</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create Placeholders of the correct shape</span></span><br><span class="line">X, Y = create_placeholders(n_H0,n_W0,n_C0,n_y)</span><br></pre></td></tr></table></figure>

<p>然后定义参数w1，w2</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">parameters = initialize_parameters()</span><br></pre></td></tr></table></figure>

<p>然后进行前向传播</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Z3 = forward_propagation(X,parameters)</span><br></pre></td></tr></table></figure>

<p>然后计算cost</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Z3 = forward_propagation(X,parameters)</span><br></pre></td></tr></table></figure>

<p>设置optimizer</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">optimizer = tf.train.AdamOptimizer().minimize(cost)</span><br></pre></td></tr></table></figure>

<p>进行参数初始化</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">init = tf.global_variables_initializer()</span><br></pre></td></tr></table></figure>

<p>然后开始循环epochs，其中的minibatch的取法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">random_mini_batches</span>(<span class="params">X, Y, mini_batch_size = <span class="number">64</span>, seed = <span class="number">0</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Creates a list of random minibatches from (X, Y)</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    X -- input data, of shape (input size, number of examples) (m, Hi, Wi, Ci)</span></span><br><span class="line"><span class="string">    Y -- true &quot;label&quot; vector (containing 0 if cat, 1 if non-cat), of shape (1, number of examples) (m, n_y)</span></span><br><span class="line"><span class="string">    mini_batch_size - size of the mini-batches, integer</span></span><br><span class="line"><span class="string">    seed -- this is only for the purpose of grading, so that you&#x27;re &quot;random minibatches are the same as ours.</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    mini_batches -- list of synchronous (mini_batch_X, mini_batch_Y)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    m = X.shape[<span class="number">0</span>]                  <span class="comment"># number of training examples</span></span><br><span class="line">    mini_batches = []</span><br><span class="line">    np.random.seed(seed)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Step 1: Shuffle (X, Y)</span></span><br><span class="line">    permutation = <span class="built_in">list</span>(np.random.permutation(m))</span><br><span class="line">    shuffled_X = X[permutation,:,:,:]</span><br><span class="line">    shuffled_Y = Y[permutation,:]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step 2: Partition (shuffled_X, shuffled_Y). Minus the end case.</span></span><br><span class="line">    num_complete_minibatches = math.floor(m/mini_batch_size) <span class="comment"># number of mini batches of size mini_batch_size in your partitionning</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, num_complete_minibatches):</span><br><span class="line">        mini_batch_X = shuffled_X[k * mini_batch_size : k * mini_batch_size + mini_batch_size,:,:,:]</span><br><span class="line">        mini_batch_Y = shuffled_Y[k * mini_batch_size : k * mini_batch_size + mini_batch_size,:]</span><br><span class="line">        mini_batch = (mini_batch_X, mini_batch_Y)</span><br><span class="line">        mini_batches.append(mini_batch)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Handling the end case (last mini-batch &lt; mini_batch_size)</span></span><br><span class="line">    <span class="keyword">if</span> m % mini_batch_size != <span class="number">0</span>:</span><br><span class="line">        mini_batch_X = shuffled_X[num_complete_minibatches * mini_batch_size : m,:,:,:]</span><br><span class="line">        mini_batch_Y = shuffled_Y[num_complete_minibatches * mini_batch_size : m,:]</span><br><span class="line">        mini_batch = (mini_batch_X, mini_batch_Y)</span><br><span class="line">        mini_batches.append(mini_batch)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> mini_batches</span><br></pre></td></tr></table></figure>







<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: model</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">model</span>(<span class="params">X_train, Y_train, X_test, Y_test, learning_rate = <span class="number">0.009</span>,</span></span><br><span class="line"><span class="params">          num_epochs = <span class="number">100</span>, minibatch_size = <span class="number">64</span>, print_cost = <span class="literal">True</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Implements a three-layer ConvNet in Tensorflow:</span></span><br><span class="line"><span class="string">    CONV2D -&gt; RELU -&gt; MAXPOOL -&gt; CONV2D -&gt; RELU -&gt; MAXPOOL -&gt; FLATTEN -&gt; FULLYCONNECTED</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    X_train -- training set, of shape (None, 64, 64, 3)</span></span><br><span class="line"><span class="string">    Y_train -- test set, of shape (None, n_y = 6)</span></span><br><span class="line"><span class="string">    X_test -- training set, of shape (None, 64, 64, 3)</span></span><br><span class="line"><span class="string">    Y_test -- test set, of shape (None, n_y = 6)</span></span><br><span class="line"><span class="string">    learning_rate -- learning rate of the optimization</span></span><br><span class="line"><span class="string">    num_epochs -- number of epochs of the optimization loop</span></span><br><span class="line"><span class="string">    minibatch_size -- size of a minibatch</span></span><br><span class="line"><span class="string">    print_cost -- True to print the cost every 100 epochs</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    train_accuracy -- real number, accuracy on the train set (X_train)</span></span><br><span class="line"><span class="string">    test_accuracy -- real number, testing accuracy on the test set (X_test)</span></span><br><span class="line"><span class="string">    parameters -- parameters learnt by the model. They can then be used to predict.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    ops.reset_default_graph()                         <span class="comment"># to be able to rerun the model without overwriting tf variables</span></span><br><span class="line">    tf.set_random_seed(<span class="number">1</span>)                             <span class="comment"># to keep results consistent (tensorflow seed)</span></span><br><span class="line">    seed = <span class="number">3</span>                                          <span class="comment"># to keep results consistent (numpy seed)</span></span><br><span class="line">    (m, n_H0, n_W0, n_C0) = X_train.shape             </span><br><span class="line">    n_y = Y_train.shape[<span class="number">1</span>]                            </span><br><span class="line">    costs = []                                        <span class="comment"># To keep track of the cost</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Create Placeholders of the correct shape</span></span><br><span class="line">    <span class="comment">### START CODE HERE ### (1 line)</span></span><br><span class="line">    X, Y = create_placeholders(n_H0,n_W0,n_C0,n_y)</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Initialize parameters</span></span><br><span class="line">    <span class="comment">### START CODE HERE ### (1 line)</span></span><br><span class="line">    parameters = initialize_parameters()</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Forward propagation: Build the forward propagation in the tensorflow graph</span></span><br><span class="line">    <span class="comment">### START CODE HERE ### (1 line)</span></span><br><span class="line">    Z3 = forward_propagation(X,parameters)</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Cost function: Add cost function to tensorflow graph</span></span><br><span class="line">    <span class="comment">### START CODE HERE ### (1 line)</span></span><br><span class="line">    cost = compute_cost(Z3,Y)</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Backpropagation: Define the tensorflow optimizer. Use an AdamOptimizer that minimizes the cost.</span></span><br><span class="line">    <span class="comment">### START CODE HERE ### (1 line)</span></span><br><span class="line">    optimizer = tf.train.AdamOptimizer().minimize(cost)</span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Initialize all the variables globally</span></span><br><span class="line">    init = tf.global_variables_initializer()</span><br><span class="line">     </span><br><span class="line">    <span class="comment"># Start the session to compute the tensorflow graph</span></span><br><span class="line">    <span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Run the initialization</span></span><br><span class="line">        sess.run(init)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Do the training loop</span></span><br><span class="line">        <span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line"></span><br><span class="line">            minibatch_cost = <span class="number">0.</span></span><br><span class="line">            num_minibatches = <span class="built_in">int</span>(m / minibatch_size) <span class="comment"># number of minibatches of size minibatch_size in the train set</span></span><br><span class="line">            seed = seed + <span class="number">1</span></span><br><span class="line">            minibatches = random_mini_batches(X_train, Y_train, minibatch_size, seed)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> minibatch <span class="keyword">in</span> minibatches:</span><br><span class="line"></span><br><span class="line">                <span class="comment"># Select a minibatch</span></span><br><span class="line">                (minibatch_X, minibatch_Y) = minibatch</span><br><span class="line">                <span class="comment"># IMPORTANT: The line that runs the graph on a minibatch.</span></span><br><span class="line">                <span class="comment"># Run the session to execute the optimizer and the cost, the feedict should contain a minibatch for (X,Y).</span></span><br><span class="line">                <span class="comment">### START CODE HERE ### (1 line)</span></span><br><span class="line">                _ , temp_cost = sess.run([optimizer,cost], feed_dict=&#123;X:minibatch_X, Y: minibatch_Y&#125;)</span><br><span class="line">                <span class="comment">### END CODE HERE ###</span></span><br><span class="line">                </span><br><span class="line">                minibatch_cost += temp_cost / num_minibatches</span><br><span class="line">                </span><br><span class="line"></span><br><span class="line">            <span class="comment"># Print the cost every epoch</span></span><br><span class="line">            <span class="keyword">if</span> print_cost == <span class="literal">True</span> <span class="keyword">and</span> epoch % <span class="number">5</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span> (<span class="string">&quot;Cost after epoch %i: %f&quot;</span> % (epoch, minibatch_cost))</span><br><span class="line">            <span class="keyword">if</span> print_cost == <span class="literal">True</span> <span class="keyword">and</span> epoch % <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">                costs.append(minibatch_cost)</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment"># plot the cost</span></span><br><span class="line">        plt.plot(np.squeeze(costs))</span><br><span class="line">        plt.ylabel(<span class="string">&#x27;cost&#x27;</span>)</span><br><span class="line">        plt.xlabel(<span class="string">&#x27;iterations (per tens)&#x27;</span>)</span><br><span class="line">        plt.title(<span class="string">&quot;Learning rate =&quot;</span> + <span class="built_in">str</span>(learning_rate))</span><br><span class="line">        plt.show()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Calculate the correct predictions</span></span><br><span class="line">        predict_op = tf.argmax(Z3, <span class="number">1</span>)</span><br><span class="line">        correct_prediction = tf.equal(predict_op, tf.argmax(Y, <span class="number">1</span>))</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># Calculate accuracy on the test set</span></span><br><span class="line">        accuracy = tf.reduce_mean(tf.cast(correct_prediction, <span class="string">&quot;float&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(accuracy)</span><br><span class="line">        train_accuracy = accuracy.<span class="built_in">eval</span>(&#123;X: X_train, Y: Y_train&#125;)</span><br><span class="line">        test_accuracy = accuracy.<span class="built_in">eval</span>(&#123;X: X_test, Y: Y_test&#125;)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Train Accuracy:&quot;</span>, train_accuracy)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Test Accuracy:&quot;</span>, test_accuracy)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> train_accuracy, test_accuracy, parameters</span><br></pre></td></tr></table></figure>

<p>然后run这个optimizer和cost</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">_ , temp_cost = sess.run([optimizer,cost], feed_dict=&#123;X:minibatch_X, Y: minibatch_Y&#125;)</span><br></pre></td></tr></table></figure>



<h2 id="Week-Two"><a href="#Week-Two" class="headerlink" title="Week Two"></a>Week Two</h2><h3 id="经典网络"><a href="#经典网络" class="headerlink" title="经典网络"></a>经典网络</h3><h4 id="LeNet-5"><a href="#LeNet-5" class="headerlink" title="LeNet-5"></a>LeNet-5</h4><p>这个网络是在1998年提出的，结果如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/27567213.jpg"></p>
<p>一共有大概60K个参数，第一层是6个5*5的conv layer，然后是一个f&#x3D;2,s&#x3D;2的pool layer（当时用的的average pool，不过后来证明max pool更有效），然后再来16个5*5的conv layer，然后是一个f&#x3D;2,s&#x3D;2的pool layer，然后将这个5*5*16的volume flatten为一个(400,1)的向量，经过一个fc（fully connected) layer，变成120*1,在经过一个fc layer，变成84*1的，再经过一个softmax得到一个10*1的$\hat{y}$，用于判别手写数字0-9</p>
<h4 id="AlexNet"><a href="#AlexNet" class="headerlink" title="AlexNet"></a>AlexNet</h4><p>AlexNet是在2012年提出的，这个网络让人们开始觉得深度学习的确可以在图像和自然语言处理等方面表现的很好</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/91339029.jpg"></p>
<p>这个网络的结构是一个conv layer，跟一个max pool layer，再来一个conv layer，跟一个max-pool layer，接下来3个conv layer，跟一个max-pool layer，这时flatten为一个9216*1的向量，然后接一个FC layer，再接一个FC layer，再接一个softmax，得到输出</p>
<p>参数的个数为$(11<em>11</em>3+1)<em>96+(5</em>5<em>96+1)<em>256+(3</em>3</em>256+1)<em>384+(3</em>3<em>384+1)<em>384</em>2 + 9216</em>4096 + 4096<em>4096+1000</em>4096&#x3D;62811648$，约为60million个</p>
<h4 id="VGG-16"><a href="#VGG-16" class="headerlink" title="VGG-16"></a>VGG-16</h4><p>这个网络在2015年提出，整个网络中用到的filter都是3*3的,padding都是same，用到的max-pool layer 都是f&#x3D;2,s&#x3D;2,</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/35706558.jpg"></p>
<p>先是2层conv 64的 conv layer，然后经过一个pool layer，接下来2层128个的conv layer，接下来一个pool layer，再接下来3层256个的conv layer，接一个pool layer，再接一个3层512个的conv layer，接一个pool layer，接一层512个的conv layer，接一个pool layer，接2层FC layer，接一层softmax</p>
<p>为什么叫VGG-16呢，因为这个网络里有参数的层一个是16个</p>
<p>同时提出的还有VGG-19，但是VGG-16的效果一般来说跟VGG-19差不多，并且参数要相对少一些，所以一般都用VGG-16</p>
<p>VGG-16参数非常多，大概有138million个，即使对于现代计算机，计算起来也是比较吃力的</p>
<h3 id="残差网络-ResNet"><a href="#残差网络-ResNet" class="headerlink" title="残差网络(ResNet)"></a>残差网络(ResNet)</h3><p>残差网络首先要理解什么是残差块(Residual block)</p>
<p>假如你现在有一个如下的2层的神经网络，每次经过一个线性层，然后一个ReLU非线性层，到达下一层，如图所示</p>
<p>从左到右依次进行的被称为full path，然而如果你直接将$a^{[l]}$加到最后一个ReLU之前，这样的方法叫做short cut 或者是 skip connection，此时我们称这样一个有跳跃连接的整体为一个Residual block</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/26910954.jpg"></p>
<p>如果我们有一个10层的神经网络，每2层形成一个残差块，那么这个网络就被称为残差网络，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/23582594.jpg"></p>
<p>残差网络在实际中表现比普通网络更好，具体表现在：随着网络层数的增加，普通网络的训练错误会先降低后增加（因为层数增多，普通网络的训练越来越难，到后面规定的iteration还没有收敛，所以training error又增加了）；但是残差网络会一直下降，直到基本不下降的状态，不会出现training error上升的情况</p>
<p>我们用plain表示普通网络，ResNet表示残差网络，得到如下的training error和layers的示意图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/99083203.jpg"></p>
<h3 id="为什么残差网络可以表现得更好"><a href="#为什么残差网络可以表现得更好" class="headerlink" title="为什么残差网络可以表现得更好"></a>为什么残差网络可以表现得更好</h3><ul>
<li><p>Lets see some example that illustrates why resNet work.</p>
<ul>
<li><p>We have a big NN as the following:</p>
<ul>
<li><code>X --&gt; Big NN --&gt; a[l]</code></li>
</ul>
</li>
<li><p>Lets add two layers to this network as a residual block:</p>
<ul>
<li><code>X --&gt; Big NN --&gt; a[l] --&gt; Layer1 --&gt; Layer2 --&gt; a[l+2]</code></li>
<li>And a<code>[l]</code> has a direct connection to <code>a[l+2]</code></li>
</ul>
</li>
<li><p>Suppose we are using RELU activations.</p>
</li>
<li><p>Then:</p>
<p><code>a[l+2] = g( z[l+2] + a[l] ) = g( W[l+2] a[l+1] + b[l+2] + a[l] )</code> </p>
</li>
<li><p>Then if we are using L2 regularization for example, <code>W[l+2]</code> will be zero. Lets say that <code>b[l+2]</code> will be zero too.</p>
</li>
<li><p>Then <code>a[l+2] = g( a[l] ) = a[l]</code> with no negative values.</p>
</li>
<li><p>This show that identity function is easy for a residual block to learn. And that why it can train deeper NNs.</p>
</li>
<li><p>Also that the two layers we added doesn’t hurt the performance of big NN we made.</p>
</li>
<li><p>Hint: dimensions of z[l+2] and a[l] have to be the same in resNets. In case they have different dimensions what we put a matrix parameters (Which can be learned or fixed)</p>
<ul>
<li><code>a[l+2] = g( z[l+2] + ws * a[l] ) # The added Ws should make the dimentions equal</code></li>
<li>ws also can be a zero padding.</li>
</ul>
</li>
</ul>
</li>
<li><p>Using a skip-connection helps the gradient to backpropagate and thus helps you to train deeper networks</p>
</li>
</ul>
<p>主要起作用的原因是redidual network 阻止了梯度消失和梯度爆炸之类的问题</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-12/3054087.jpg"></p>
<h3 id="1-times-1-的卷积（network-in-network）"><a href="#1-times-1-的卷积（network-in-network）" class="headerlink" title="$1\times 1$的卷积（network in network）"></a>$1\times 1$的卷积（network in network）</h3><p>1*1的卷积主要是为了改变图片的通道数目，比如你现在有一个28*28*192的图片，你可以将它变成32通道的，以此来减少计算量，也可以把它变成192通道的，这相当于在原来的图片上加了一个192通道的图片，这将使得模型更复杂，以此来表征更加复杂的模型</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/88550955.jpg"></p>
<h3 id="Inception-Network"><a href="#Inception-Network" class="headerlink" title="Inception Network"></a>Inception Network</h3><p>在设计神经网络的时候，你可能会想如何去选择conv layer 所用的filter的大小，以及max-pool的大小，这个时候其实你可以把所有你可能会想要用到的conv layer和max-pool layer联结起来，形成一个复杂的网络，具体如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/37028773.jpg"></p>
<p>所有的conv layer和max-pool layer都用到了same padding，这样保证经过一个layer之后的维度不变，以便大家能够联结起来</p>
<p>但是inception network造成的问题就是计算量太大，比如我们现在来看看5*5这组filter的乘法的数目，一共输出是28*28*32个，每个输出所要求的乘法数目是5*5*192，所以全部乘起来之后是28*28*32*5*5*192&#x3D;120M次</p>
<p>我们可以用上一节提到的1*1的conv 层进行计算次数的优化，用1*1的conv 层计算出一个 bottleneck layer（瓶颈层:和瓶颈一样，先变小，再变大），然后再计算乘法。具体来说是将28*28*192的图片先经过一个1*1的个数为16的层，变成28*28*16的层，然后再经过5*5的层，计算数量缩减为12.4M，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/68094398.jpg"></p>
<p>一个Inception module如下图所示，包含1*1的conv layer 和 3*3的conv layer(前面有一个1*1的bottleneck layer)和5*5的conv layer(前面有一个1*1的bottleneck layer)，以及一个3*3的max-pool layer（后面有一个1*1的layer用于减小通道数）</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/23343715.jpg"></p>
<p>一个完整的inception network如下图所示，由多个inception module组成，中间还有一个side branch，用中间某一层的输出进行预测</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/34915820.jpg"></p>
<h3 id="使用开源的深度学习实现"><a href="#使用开源的深度学习实现" class="headerlink" title="使用开源的深度学习实现"></a>使用开源的深度学习实现</h3><p>当你遇到一个想要去实现的网络的时候，从头开始动手实现是非常困难的，因为有很多调参之类的问题需要你去解决，那么你完全可以使用google 去搜索github上面的结果，比如你先想要实现ResNet， 你只需要在google上面搜索ResNet github，很容易就能找到一个结果，并且这些开源代码往往用了大量的原始数据进行训练，你只需要下下来进行迁移学习就行了</p>
<h3 id="迁移学习"><a href="#迁移学习" class="headerlink" title="迁移学习"></a>迁移学习</h3><p>比如你现在想要是别的两只猫，分别叫做tigger和misty，但是你拥有的这两只猫的图片很少，所以你从网上下了一个在非常大数据集上面训练的模型(比如image net上训练过的模型)，然后你直接去掉输出层，把前面的所有层的参数都freeze住，对最后一层进行训练，就得到了你的猫分类器</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/4627273.jpg"></p>
<p>当然，如果你数据量大一些，你可以少冻住几层，多训练几层，这个freeze的方法，通常是将输入输进去，用原来的网络参数计算直到你要自己训练的那层，把这些数据存下来作为新网络的输入。后面网络参数的初始化可以直接用别人训练好的参数作为反向传播</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/36852562.jpg"></p>
<p>除非你数据量非常大，不然你都不要完全重新训练网络</p>
<h3 id="数据提升"><a href="#数据提升" class="headerlink" title="数据提升"></a>数据提升</h3><p>数据提升主要有两种方法，一种是在图片内容上的变换，一种是色彩上的变换</p>
<p>内容上的变换主要有：镜像变换，随机裁剪，旋转，扭曲等等，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/27345434.jpg"></p>
<p>色彩上的变换主要是：增加或减少RGB色彩，比较高级的方法叫做PCA color augmentation，效果如图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/90144873.jpg"></p>
<h3 id="计算机视觉任务的经验"><a href="#计算机视觉任务的经验" class="headerlink" title="计算机视觉任务的经验"></a>计算机视觉任务的经验</h3><p>一般来说，数据越多，你所需要进行的手动修改的部分就越少，如图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/89008645.jpg"></p>
<p>在标准数据集或者是竞赛当中有一些比较常用的方法：</p>
<ol>
<li>Ensembling：训练多个神经网络并平均输出</li>
<li>多种图片裁剪的数据提升方法：原图以及镜像图片的正中心，左上角，右上角，左下角，右下角图片，这个方法被称为crop-10，因为一共裁剪出10张</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/73321754.jpg"></p>
<p>在使用开源框架的时候，通常可以：</p>
<ol>
<li>用论文中提出的框架，因为一般计算机视觉任务有通用性</li>
<li>使用开源框架</li>
<li>使用pre-trained model并调整你模型中的参数</li>
</ol>
<h3 id="Keras-tutorial"><a href="#Keras-tutorial" class="headerlink" title="Keras tutorial"></a>Keras tutorial</h3><p>Keras更像是sklearn的过程，每一层的叠加都是可见的，然后最后compile一下model，fit model，然后evaluate model</p>
<p>具体来说，我们看看一个1层的卷积神经网络怎么实现的</p>
<p>先用Input函数得到输入，用ZeroPadding2d函数进行zero padding，用Conv2D进行卷积，用BatchNormalization进行批量正则化（每一层都进行正则化而不只是输入正则化），经过一个激活函数Activation(‘relu’)，用MaxPooling2D经过一个max pool，然后Flatten，然后用一个sigmoid函数得到输出，最后用<code>model=Model(inputs=..., outputs=... ,name=&#39;...&#39;)</code>建立模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">model</span>(<span class="params">input_shape</span>):</span><br><span class="line">    <span class="comment"># Define the input placeholder as a tensor with shape input_shape. Think of this as your input image!</span></span><br><span class="line">    X_input = Input(input_shape)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Zero-Padding: pads the border of X_input with zeroes</span></span><br><span class="line">    X = ZeroPadding2D((<span class="number">3</span>, <span class="number">3</span>))(X_input)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># CONV -&gt; BN -&gt; RELU Block applied to X</span></span><br><span class="line">    X = Conv2D(<span class="number">32</span>, (<span class="number">7</span>, <span class="number">7</span>), strides = (<span class="number">1</span>, <span class="number">1</span>), name = <span class="string">&#x27;conv0&#x27;</span>)(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = <span class="string">&#x27;bn0&#x27;</span>)(X)</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># MAXPOOL</span></span><br><span class="line">    X = MaxPooling2D((<span class="number">2</span>, <span class="number">2</span>), name=<span class="string">&#x27;max_pool&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># FLATTEN X (means convert it to a vector) + FULLYCONNECTED</span></span><br><span class="line">    X = Flatten()(X)</span><br><span class="line">    X = Dense(<span class="number">1</span>, activation=<span class="string">&#x27;sigmoid&#x27;</span>, name=<span class="string">&#x27;fc&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create model. This creates your Keras model instance, you&#x27;ll use this instance to train/test the model.</span></span><br><span class="line">    model = Model(inputs = X_input, outputs = X, name=<span class="string">&#x27;HappyModel&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<p>You have now built a function to describe your model. To train and test this model, there are four steps in Keras:</p>
<ol>
<li>Create the model by calling the function above</li>
<li>Compile the model by calling <code>model.compile(optimizer = &quot;...&quot;, loss = &quot;...&quot;, metrics = [&quot;accuracy&quot;])</code></li>
<li>Train the model on train data by calling <code>model.fit(x = ..., y = ..., epochs = ..., batch_size = ...)</code></li>
<li>Test the model on test data by calling <code>model.evaluate(x = ..., y = ...)</code></li>
</ol>
<p>If you want to know more about <code>model.compile()</code>, <code>model.fit()</code>, <code>model.evaluate()</code> and their arguments, refer to the official <a href="https://keras.io/models/model/">Keras documentation</a>.</p>
<p>现在建立模型的方法就是四步：</p>
<ol>
<li>定义模型：<code>happyModel = HappyModel(X_train.shape[1:])</code></li>
<li>compile模型，定义其中的optimizer和loss以及metrics，<code>happyModel.compile(optimizer = &quot;Adam&quot;, loss = &quot;binary_crossentropy&quot;, metrics = [&quot;accuracy&quot;])</code></li>
<li>fit模型：<code>happyModel.fit(x = X_train, y = Y_train, epochs = 5, batch_size = 16)</code>，这里的batch-size选为16，一开始用了64，效果非常不好</li>
<li>evaluate模型：<code>preds = happyModel.evaluate(x = X_, y = ...)</code></li>
</ol>
<p>keras当中比较有用的两个函数：</p>
<ol>
<li>模型的每一层的参数个数：<code>happyModel.summary()</code></li>
<li><code>plot_model(happyModel, to_file=&#39;HappyModel.png&#39;)</code><br><code>SVG(model_to_dot(happyModel).create(prog=&#39;dot&#39;, format=&#39;svg&#39;))</code><br>上面两行用于打印模型的结构</li>
</ol>
<h3 id="Keras-to-ResNet"><a href="#Keras-to-ResNet" class="headerlink" title="Keras to ResNet"></a>Keras to ResNet</h3><p>首先导入一些需要用到的库</p>
<p>Keras是一个模型级的库，提供了快速构建深度学习网络的模块。Keras并不处理如张量乘法、卷积等底层操作。这些操作依赖于某种特定的、优化良好的张量操作库。Keras依赖于处理张量的库就称为“后端引擎”。Keras提供了三种后端引擎Theano&#x2F;Tensorflow&#x2F;CNTK，并将其函数统一封装，使得用户可以以同一个接口调用不同后端引擎的函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> layers</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> Input, Add, Dense, Activation, ZeroPadding2D, BatchNormalization, Flatten, Conv2D, AveragePooling2D, MaxPooling2D, GlobalMaxPooling2D</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Model, load_model</span><br><span class="line"><span class="keyword">from</span> keras.preprocessing <span class="keyword">import</span> image</span><br><span class="line"><span class="keyword">from</span> keras.utils <span class="keyword">import</span> layer_utils</span><br><span class="line"><span class="keyword">from</span> keras.utils.data_utils <span class="keyword">import</span> get_file</span><br><span class="line"><span class="keyword">from</span> keras.applications.imagenet_utils <span class="keyword">import</span> preprocess_input</span><br><span class="line"><span class="keyword">import</span> pydot</span><br><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> SVG</span><br><span class="line"><span class="keyword">from</span> keras.utils.vis_utils <span class="keyword">import</span> model_to_dot</span><br><span class="line"><span class="keyword">from</span> keras.utils <span class="keyword">import</span> plot_model</span><br><span class="line"><span class="keyword">from</span> resnets_utils <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keras.initializers <span class="keyword">import</span> glorot_uniform</span><br><span class="line"><span class="keyword">import</span> scipy.misc</span><br><span class="line"><span class="keyword">from</span> matplotlib.pyplot <span class="keyword">import</span> imshow</span><br><span class="line">%matplotlib inline</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> keras.backend <span class="keyword">as</span> K</span><br><span class="line">K.set_image_data_format(<span class="string">&#x27;channels_last&#x27;</span>)</span><br><span class="line">K.set_learning_phase(<span class="number">1</span>)   <span class="comment"># 设置为训练/测试模式 ，分别是0/1</span></span><br></pre></td></tr></table></figure>

<h4 id="建立一个identity-block"><a href="#建立一个identity-block" class="headerlink" title="建立一个identity block"></a>建立一个identity block</h4><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/87089704.jpg"></p>
<p>identity block是x[l]和 x[l+2]的size一样，就可以直接相加</p>
<p>用filters的list来存储三层的filter的个数，记录下一开始的X作为X_shortcut</p>
<p>然后开始主路的设计：先一个conv layer，然后一个BatchNormalization，axis&#x3D;3，是除了3以外的所有维度都normalization，也可以写成axis&#x3D;-1，然后是一个Activation(‘relu’)层</p>
<p>接下来的两层基本与第一层相同，只是filter的个数分别是F2,F3，filter的size中间那层是(f,f)</p>
<p>第三层结束之后得到的X加上一开始的X_shortcut，就是最终进入activation的值，这里的加法必须要用<code>keras.layers.Add()()([x1,x2])</code>或<code>keras.layers.add([x1, x2])</code>进行，直接用加号会出错</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: identity_block</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">identity_block</span>(<span class="params">X, f, filters, stage, block</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Implementation of the identity block as defined in Figure 3</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    X -- input tensor of shape (m, n_H_prev, n_W_prev, n_C_prev)</span></span><br><span class="line"><span class="string">    f -- integer, specifying the shape of the middle CONV&#x27;s window for the main path</span></span><br><span class="line"><span class="string">    filters -- python list of integers, defining the number of filters in the CONV layers of the main path</span></span><br><span class="line"><span class="string">    stage -- integer, used to name the layers, depending on their position in the network</span></span><br><span class="line"><span class="string">    block -- string/character, used to name the layers, depending on their position in the network</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    X -- output of the identity block, tensor of shape (n_H, n_W, n_C)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># defining name basis</span></span><br><span class="line">    conv_name_base = <span class="string">&#x27;res&#x27;</span> + <span class="built_in">str</span>(stage) + block + <span class="string">&#x27;_branch&#x27;</span></span><br><span class="line">    bn_name_base = <span class="string">&#x27;bn&#x27;</span> + <span class="built_in">str</span>(stage) + block + <span class="string">&#x27;_branch&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Retrieve Filters</span></span><br><span class="line">    F1, F2, F3 = filters</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Save the input value. You&#x27;ll need this later to add back to the main path. </span></span><br><span class="line">    X_shortcut = X</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># First component of main path</span></span><br><span class="line">    X = Conv2D(filters = F1, kernel_size = (<span class="number">1</span>, <span class="number">1</span>), strides = (<span class="number">1</span>,<span class="number">1</span>), padding = <span class="string">&#x27;valid&#x27;</span>, name = conv_name_base + <span class="string">&#x27;2a&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;2a&#x27;</span>)(X)</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">### START CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Second component of main path (≈3 lines)</span></span><br><span class="line">    X = Conv2D(filters = F2, kernel_size = (f, f), strides = (<span class="number">1</span>,<span class="number">1</span>), padding = <span class="string">&#x27;same&#x27;</span>, name = conv_name_base + <span class="string">&#x27;2b&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;2b&#x27;</span>)(X)</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Third component of main path (≈2 lines)</span></span><br><span class="line">    X = Conv2D(filters = F3, kernel_size = (<span class="number">1</span>, <span class="number">1</span>), strides = (<span class="number">1</span>,<span class="number">1</span>), padding = <span class="string">&#x27;valid&#x27;</span>, name = conv_name_base + <span class="string">&#x27;2c&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;2c&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Final step: Add shortcut value to main path, and pass it through a RELU activation (≈2 lines)</span></span><br><span class="line">    X = Add()([X, X_shortcut])  <span class="comment"># added = keras.layers.Add()([x1, x2])  ## equivalent to added = keras.layers.add([x1, x2])</span></span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> X</span><br></pre></td></tr></table></figure>

<p>然后开始tensorflow测试一下identity block，定义一个A_prev的placeholder，类型是float，<code>shape=[3,4,4,6]</code>，X设为一个<code>[3,4,4,6]</code>的随机矩阵，用A_prev建立一个identity block，三层filter的个数是2,4,6，第二层的filter的形状是2*2，然后用sess run 变量初始化，接着run一下这个identity block，feed_dict数据是<code>A_prev:x</code>,<code>K.learning_phase(): 0</code>用于转换为训练模式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tf.reset_default_graph()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> test:</span><br><span class="line">    np.random.seed(<span class="number">1</span>)</span><br><span class="line">    A_prev = tf.placeholder(<span class="string">&quot;float&quot;</span>, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>])</span><br><span class="line">    X = np.random.randn(<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>)</span><br><span class="line">    A = identity_block(A_prev, f = <span class="number">2</span>, filters = [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>], stage = <span class="number">1</span>, block = <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    test.run(tf.global_variables_initializer())</span><br><span class="line">    out = test.run([A], feed_dict=&#123;A_prev: X, K.learning_phase(): <span class="number">0</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;out = &quot;</span> + <span class="built_in">str</span>(out[<span class="number">0</span>][<span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<h4 id="建立一个convlutional-block"><a href="#建立一个convlutional-block" class="headerlink" title="建立一个convlutional block"></a>建立一个convlutional block</h4><p>convlutional block就是shortcut不是直接加到a[l+2]上面的，而是经过了一个conv layer和batch norm之后加的</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/5062663.jpg"></p>
<p>与建立identity layer的方法类似，记录X为X_shortcut，这里的shortcut到后面是要经过运算的，不是直接加的</p>
<p>每个conv layer 有一个kernel的initializer，<code> kernel_initializer = glorot_uniform(seed=0)</code>就是常用的Xavier 初始化</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: convolutional_block</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">convolutional_block</span>(<span class="params">X, f, filters, stage, block, s = <span class="number">2</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Implementation of the convolutional block as defined in Figure 4</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    X -- input tensor of shape (m, n_H_prev, n_W_prev, n_C_prev)</span></span><br><span class="line"><span class="string">    f -- integer, specifying the shape of the middle CONV&#x27;s window for the main path</span></span><br><span class="line"><span class="string">    filters -- python list of integers, defining the number of filters in the CONV layers of the main path</span></span><br><span class="line"><span class="string">    stage -- integer, used to name the layers, depending on their position in the network</span></span><br><span class="line"><span class="string">    block -- string/character, used to name the layers, depending on their position in the network</span></span><br><span class="line"><span class="string">    s -- Integer, specifying the stride to be used</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    X -- output of the convolutional block, tensor of shape (n_H, n_W, n_C)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># defining name basis</span></span><br><span class="line">    conv_name_base = <span class="string">&#x27;res&#x27;</span> + <span class="built_in">str</span>(stage) + block + <span class="string">&#x27;_branch&#x27;</span></span><br><span class="line">    bn_name_base = <span class="string">&#x27;bn&#x27;</span> + <span class="built_in">str</span>(stage) + block + <span class="string">&#x27;_branch&#x27;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Retrieve Filters</span></span><br><span class="line">    F1, F2, F3 = filters</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Save the input value</span></span><br><span class="line">    X_shortcut = X</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">##### MAIN PATH #####</span></span><br><span class="line">    <span class="comment"># First component of main path </span></span><br><span class="line">    X = Conv2D(F1, (<span class="number">1</span>, <span class="number">1</span>), strides = (s,s),padding=<span class="string">&#x27;valid&#x27;</span>, name = conv_name_base + <span class="string">&#x27;2a&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;2a&#x27;</span>)(X)</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">### START CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Second component of main path (≈3 lines)</span></span><br><span class="line">    X = Conv2D(F2, (f, f), strides = (<span class="number">1</span>,<span class="number">1</span>), padding = <span class="string">&#x27;same&#x27;</span>, name = conv_name_base + <span class="string">&#x27;2b&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;2b&#x27;</span>)(X)</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Third component of main path (≈2 lines)</span></span><br><span class="line">    X = Conv2D(F3, (<span class="number">1</span>, <span class="number">1</span>), strides = (<span class="number">1</span>,<span class="number">1</span>), padding = <span class="string">&#x27;valid&#x27;</span>, name = conv_name_base + <span class="string">&#x27;2c&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;2c&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment">##### SHORTCUT PATH #### (≈2 lines)</span></span><br><span class="line">    X_shortcut = Conv2D(F3, (<span class="number">1</span>, <span class="number">1</span>), strides = (s,s), padding = <span class="string">&#x27;valid&#x27;</span>, name = conv_name_base + <span class="string">&#x27;1&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X_shortcut)</span><br><span class="line">    X_shortcut = BatchNormalization(axis = <span class="number">3</span>, name = bn_name_base + <span class="string">&#x27;1&#x27;</span>)(X_shortcut)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Final step: Add shortcut value to main path, and pass it through a RELU activation (≈2 lines)</span></span><br><span class="line">    X = Add()([X, X_shortcut])</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> X</span><br></pre></td></tr></table></figure>

<p>同样来测试一下我们建立的convolutional block</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tf.reset_default_graph()</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> test:</span><br><span class="line">    np.random.seed(<span class="number">1</span>)</span><br><span class="line">    A_prev = tf.placeholder(<span class="string">&quot;float&quot;</span>, [<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>])</span><br><span class="line">    X = np.random.randn(<span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">6</span>)</span><br><span class="line">    A = convolutional_block(A_prev, f = <span class="number">2</span>, filters = [<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>], stage = <span class="number">1</span>, block = <span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">    test.run(tf.global_variables_initializer())</span><br><span class="line">    out = test.run([A], feed_dict=&#123;A_prev: X, K.learning_phase(): <span class="number">0</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;out = &quot;</span> + <span class="built_in">str</span>(out[<span class="number">0</span>][<span class="number">1</span>][<span class="number">1</span>][<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<h4 id="建立一个50层的ResNet"><a href="#建立一个50层的ResNet" class="headerlink" title="建立一个50层的ResNet"></a>建立一个50层的ResNet</h4><p>结构如下图所示，分为5个stage，其中的conv block就是我们在上面建立的convolutional block，其中的ID block就是我们上面建立的identity block</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/92727700.jpg"></p>
<p>我们先给一个大小就可以定义一个输入的tensor，用Input方法实现</p>
<p>先进入一个zero padding，然后一个conv layer，batch norm，relu，max pool，接下来就是一大堆的block，然后接一个AvgPool，flatten一下，接一个FC layer，就得到了输出</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GRADED FUNCTION: ResNet50</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNet50</span>(<span class="params">input_shape = (<span class="params"><span class="number">64</span>, <span class="number">64</span>, <span class="number">3</span></span>), classes = <span class="number">6</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Implementation of the popular ResNet50 the following architecture:</span></span><br><span class="line"><span class="string">    CONV2D -&gt; BATCHNORM -&gt; RELU -&gt; MAXPOOL -&gt; CONVBLOCK -&gt; IDBLOCK*2 -&gt; CONVBLOCK -&gt; IDBLOCK*3</span></span><br><span class="line"><span class="string">    -&gt; CONVBLOCK -&gt; IDBLOCK*5 -&gt; CONVBLOCK -&gt; IDBLOCK*2 -&gt; AVGPOOL -&gt; TOPLAYER</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Arguments:</span></span><br><span class="line"><span class="string">    input_shape -- shape of the images of the dataset</span></span><br><span class="line"><span class="string">    classes -- integer, number of classes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Returns:</span></span><br><span class="line"><span class="string">    model -- a Model() instance in Keras</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Define the input as a tensor with shape input_shape</span></span><br><span class="line">    X_input = Input(input_shape)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Zero-Padding</span></span><br><span class="line">    X = ZeroPadding2D((<span class="number">3</span>, <span class="number">3</span>))(X_input)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Stage 1</span></span><br><span class="line">    X = Conv2D(<span class="number">64</span>, (<span class="number">7</span>, <span class="number">7</span>), strides = (<span class="number">2</span>, <span class="number">2</span>), name = <span class="string">&#x27;conv1&#x27;</span>, kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    X = BatchNormalization(axis = <span class="number">3</span>, name = <span class="string">&#x27;bn_conv1&#x27;</span>)(X)</span><br><span class="line">    X = Activation(<span class="string">&#x27;relu&#x27;</span>)(X)</span><br><span class="line">    X = MaxPooling2D((<span class="number">3</span>, <span class="number">3</span>), strides=(<span class="number">2</span>, <span class="number">2</span>))(X)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Stage 2</span></span><br><span class="line">    X = convolutional_block(X, f = <span class="number">3</span>, filters = [<span class="number">64</span>, <span class="number">64</span>, <span class="number">256</span>], stage = <span class="number">2</span>, block=<span class="string">&#x27;a&#x27;</span>, s = <span class="number">1</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">64</span>, <span class="number">64</span>, <span class="number">256</span>], stage=<span class="number">2</span>, block=<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">64</span>, <span class="number">64</span>, <span class="number">256</span>], stage=<span class="number">2</span>, block=<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">### START CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Stage 3 (≈4 lines)</span></span><br><span class="line">    X = convolutional_block(X, f = <span class="number">3</span>, filters = [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage = <span class="number">3</span>, block=<span class="string">&#x27;a&#x27;</span>, s = <span class="number">2</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">128</span>, <span class="number">128</span>, <span class="number">512</span>], stage=<span class="number">3</span>, block=<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Stage 4 (≈6 lines)</span></span><br><span class="line">    X = convolutional_block(X, f = <span class="number">3</span>, filters = [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage = <span class="number">4</span>, block=<span class="string">&#x27;a&#x27;</span>, s = <span class="number">2</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">256</span>, <span class="number">256</span>, <span class="number">1024</span>], stage=<span class="number">4</span>, block=<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Stage 5 (≈3 lines)</span></span><br><span class="line">    X = convolutional_block(X, f = <span class="number">3</span>, filters = [<span class="number">512</span>, <span class="number">512</span>, <span class="number">2048</span>], stage = <span class="number">5</span>, block=<span class="string">&#x27;a&#x27;</span>, s = <span class="number">2</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">512</span>, <span class="number">512</span>, <span class="number">2048</span>], stage=<span class="number">5</span>, block=<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">    X = identity_block(X, <span class="number">3</span>, [<span class="number">512</span>, <span class="number">512</span>, <span class="number">2048</span>], stage=<span class="number">5</span>, block=<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># AVGPOOL (≈1 line). Use &quot;X = AveragePooling2D(...)(X)&quot;</span></span><br><span class="line">    X = AveragePooling2D(pool_size=(<span class="number">2</span>, <span class="number">2</span>))(X)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">### END CODE HERE ###</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># output layer</span></span><br><span class="line">    X = Flatten()(X)</span><br><span class="line">    X = Dense(classes, activation=<span class="string">&#x27;softmax&#x27;</span>, name=<span class="string">&#x27;fc&#x27;</span> + <span class="built_in">str</span>(classes), kernel_initializer = glorot_uniform(seed=<span class="number">0</span>))(X)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Create model</span></span><br><span class="line">    model = Model(inputs = X_input, outputs = X, name=<span class="string">&#x27;ResNet50&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> model</span><br></pre></td></tr></table></figure>

<p>接下来定义我们的model</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model = ResNet50(input_shape = (<span class="number">64</span>, <span class="number">64</span>, <span class="number">3</span>), classes = <span class="number">6</span>)</span><br></pre></td></tr></table></figure>

<p>然后compile model，指定optimizer和loss以及metric</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model.<span class="built_in">compile</span>(optimizer=<span class="string">&#x27;adam&#x27;</span>, loss=<span class="string">&#x27;categorical_crossentropy&#x27;</span>, metrics=[<span class="string">&#x27;accuracy&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>导入数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">X_train_orig, Y_train_orig, X_test_orig, Y_test_orig, classes = load_dataset()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Normalize image vectors</span></span><br><span class="line">X_train = X_train_orig/<span class="number">255.</span></span><br><span class="line">X_test = X_test_orig/<span class="number">255.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Convert training and test labels to one hot matrices</span></span><br><span class="line">Y_train = convert_to_one_hot(Y_train_orig, <span class="number">6</span>).T</span><br><span class="line">Y_test = convert_to_one_hot(Y_test_orig, <span class="number">6</span>).T</span><br><span class="line"></span><br><span class="line"><span class="comment"># number of training examples = 1080</span></span><br><span class="line"><span class="comment"># number of test examples = 120</span></span><br><span class="line"><span class="comment"># X_train shape: (1080, 64, 64, 3)</span></span><br><span class="line"><span class="comment"># Y_train shape: (1080, 6)</span></span><br><span class="line"><span class="comment"># X_test shape: (120, 64, 64, 3)</span></span><br><span class="line"><span class="comment"># Y_test shape: (120, 6)</span></span><br></pre></td></tr></table></figure>

<p>1080张64*64的三通道图片，测试时120张64*64的三通道图片</p>
<p>接下来fit model</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model.fit(X_train, Y_train, epochs = <span class="number">20</span>, batch_size = <span class="number">32</span>)</span><br></pre></td></tr></table></figure>

<p>最后evaluate模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">preds = model.evaluate(X_test, Y_test)</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;Loss = &quot;</span> + <span class="built_in">str</span>(preds[<span class="number">0</span>]))</span><br><span class="line"><span class="built_in">print</span> (<span class="string">&quot;Test Accuracy = &quot;</span> + <span class="built_in">str</span>(preds[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p>同样<code>summary()</code>和<code>plot_model</code>看看参数以及网络结构</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model.summary()</span><br><span class="line">plot_model(model, to_file=<span class="string">&#x27;model.png&#x27;</span>)</span><br><span class="line">SVG(model_to_dot(model).create(prog=<span class="string">&#x27;dot&#x27;</span>, <span class="built_in">format</span>=<span class="string">&#x27;svg&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-13/71188004.jpg"></p>
<h2 id="Week-Three-检测算法"><a href="#Week-Three-检测算法" class="headerlink" title="Week Three 检测算法"></a>Week Three 检测算法</h2><h3 id="目标定位"><a href="#目标定位" class="headerlink" title="目标定位"></a>目标定位</h3><p>目标检测主要有两类任务，一类是image classification 和 classification with localization，往往只有一个目标需要标记，另一类是detection，往往有多个目标需要标记</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/27032753.jpg"></p>
<p>当你需要标记目标位置的时候，你的神经网络的输出不仅是一个softmax的概率值，还有图像中心点的x，y坐标以及红框的宽和高的值，假设我们现在检测三类目标，分别是行人，汽车，摩托车，以及三类都没有的纯背景的情况，那么你的y应该设置为<br>$$<br>y&#x3D;\begin{bmatrix}P_c \b_x \b_y \b_h \b_w \c_1 \c_2 \c_3 \end{bmatrix}<br>$$</p>
<p>其中$P_c$表示的是图中有无目标，如果有目标那么就要定位$b_x,b_y,b_h,b_w$，以及他们的分类$c_1,c_2,c_3$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/76557389.jpg"></p>
<p>当$P_c &#x3D; 1$的时候，y的所有参数都是需要关心的</p>
<p>当$P_c &#x3D; 0$，除了$P_c $以外的其余参数都不用关心，图中用问号表示</p>
<p>损失函数可以表示为<br>$$<br>L(\hat y,y)&#x3D;\left{\begin{matrix}<br>(\hat y_1,y_1)^2+\ldots+(\hat y_8,y_8)^2 &amp; if &amp; y&#x3D;1\<br>(\hat y_1,y_1)^2 &amp; if &amp; y&#x3D;0<br>\end{matrix}\right.<br>$$</p>
<h3 id="特征点检测"><a href="#特征点检测" class="headerlink" title="特征点检测"></a>特征点检测</h3><p>当你检测一个人或者是一个姿势的时候，你可能需要的不是像检测汽车那样只要一个中心点，你可能需要很多个点来检测人脸的五官，或者不同的点来检测一个人的姿势，此时你的y就有很多个点</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/36562583.jpg"></p>
<h3 id="利用滑动窗口进行目标检测"><a href="#利用滑动窗口进行目标检测" class="headerlink" title="利用滑动窗口进行目标检测"></a>利用滑动窗口进行目标检测</h3><p>用一个正方形框在图像上以一定步长滑动，每次检测框内的图像，这就是滑动窗口的含义，用不同大小的框可以多次进行</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/76981350.jpg"></p>
<p>但是滑动窗口的计算成本非常大，如果你的步长选的比较小（精度比较高），那么你要输入系统的图片非常多，计算量就非常大</p>
<h3 id="使用卷积实现滑动窗口"><a href="#使用卷积实现滑动窗口" class="headerlink" title="使用卷积实现滑动窗口"></a>使用卷积实现滑动窗口</h3><p>使用卷积实现滑动窗口，首先要看看如何把FC层转换为卷积层，在本来应该flatten的地方，再用一组f大小与原图相等的filter，将它变成1*1的volume，然后反复使用1*1的filter，直到最后大小等于1*1*4</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/70781915.jpg"></p>
<p>同样，在滑动窗口的过程中，有很多的卷积步骤是重复的，因此我们可以使用卷积来避免每个滑动窗口都经历整个卷积神经网络</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/4716774.jpg"></p>
<h3 id="获得更加精确的边界框"><a href="#获得更加精确的边界框" class="headerlink" title="获得更加精确的边界框"></a>获得更加精确的边界框</h3><p>YOLO(You Only Look Once)算法是一个很好用的目标检测算法，先讲图片分割成很多个小的矩形，每个矩形中间如果有某个目标对象的中心点，那么这个方框的Y的第一个值$P_c$就为1，否则为0，最后得到一个3*3*8的volume，这个volume就是预测的结果，因为这个算法使用了卷积的方法，因此速度很快</p>
<p>我们来看个例子，比如下图，原图是100*100的大小，我们划分成3*3的格子，绿色和橙色格子有目标，找出中心点，然后标记出方框，绿色块的y值如右边的绿色y所示，橙色如橙色标识的y所示，其余的都是紫色标记</p>
<p>通常我们划分的块会更多一些，以便更加精确地定位图像</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/65964893.jpg"></p>
<p>边框的标记方法是给出中心点的坐标x，y，已经图像的高度h和宽度w，因为我们对每个小方块的坐标定义为左上角是(0,0)，右下角是(1,1)，所以x,y一定是在0到1之间的值，但是目标的大小可能超出一个方块，所以h和w可以是大于0的任何值（当然也可以大于1），如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/31698060.jpg"></p>
<h3 id="交并比（intersection-over-union）"><a href="#交并比（intersection-over-union）" class="headerlink" title="交并比（intersection over union）"></a>交并比（intersection over union）</h3><p>交并比：一个方框与真实结果的交集与其并集的比，用于评价目标检测算法的精度</p>
<p>最好情况的交并比是1，一般来说，如果你的交并比（IoU）&gt;&#x3D;0.5，就认为你的检测是正确的</p>
<h3 id="非最大值抑制-Non-max-Suppression"><a href="#非最大值抑制-Non-max-Suppression" class="headerlink" title="非最大值抑制(Non-max Suppression)"></a>非最大值抑制(Non-max Suppression)</h3><p>加入你在下图中检测汽车，你把图片分成了19*19大小的网格，两辆车的中心分别是绿色点和黄色点，理论上来说它们各自的中心点应该只会被标记一次，但是你在运行网络的时候，每一个网格都是独立运行的，所以旁边的网格可能也会认为自己就在图片中心，同一个目标可能会被标记好多次，因此引入非最大值抑制的策略来保证每个目标只被标记一次</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/39766648.jpg"></p>
<p>假设我们现在已经得到了很多个框，你需要去找到哪个框是真的有效的，如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/21084208.jpg"></p>
<p>具体做法如下：</p>
<ol>
<li>首先，你将那些概率值都低于0.6的框给删除</li>
<li>只要这里还剩任何框：选择现在概率最大的框最为结果，删除任何与这个结果IoU大于等于0.5的盒子</li>
<li>只要还有框没有标记就跳到第二步</li>
</ol>
<h3 id="Anchor-Box"><a href="#Anchor-Box" class="headerlink" title="Anchor Box"></a>Anchor Box</h3><p>Anchor Box是用来当你需要检测多个目标的时候，你先给几个预先给定的anchor box，将结果的y联合起来</p>
<p>比如你现在检测行人和车辆，行人的车辆应该是高长的，车辆的扁宽的，本来y是8维的，然后现在连接起来就有16维</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/12260966.jpg"></p>
<p>然后我们将两个anchor box 和 我们之前圈出来的框计算IoU，图像将被分到高IoU的部分</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/7317445.jpg"></p>
<h3 id="YOLO算法的完整描述"><a href="#YOLO算法的完整描述" class="headerlink" title="YOLO算法的完整描述"></a>YOLO算法的完整描述</h3><p>如果你在进行一个定位行人，汽车，摩托车的YOLO算法，如下图，先将图片分成3*3的网格，对每一个网格进行检测，现在设定了2个anchor box，那么最终的输出是3*3*16的结果</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/15432401.jpg"></p>
<p>我们来看看如何做预测，如下图，我们将最终的结果全为$P_c$全为0的分类成背景，为1的部分去找对应的c的分类</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/38705005.jpg"></p>
<p>我们再来看看如何使用non-max suppress，先从图中移除那些概率很低的框，然后分别对三个类别（行人，汽车，摩托车）进行non-max suppress得到最终的预测</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-14/49481234.jpg"></p>
<h2 id="Week-four"><a href="#Week-four" class="headerlink" title="Week four"></a>Week four</h2><h3 id="人脸识别的术语"><a href="#人脸识别的术语" class="headerlink" title="人脸识别的术语"></a>人脸识别的术语</h3><p>人脸识别任务大致分为两类，分别是face verification 和 face recognition：</p>
<ul>
<li>face verification：指的是给一张图片，判定是否是你要找的那个人，是一个二分类的问题</li>
<li>face recognition：是给一张图片，判定他是谁，是一个多分类问题</li>
</ul>
<h3 id="单样本学习问题-one-shot-learning"><a href="#单样本学习问题-one-shot-learning" class="headerlink" title="单样本学习问题(one shot learning)"></a>单样本学习问题(one shot learning)</h3><p>通常识别任务要求在只有一张图片的情况下进行识别，但是从传统来说，只有一个训练样本的效果是很差的</p>
<p>解决的办法就是，学习出一个相似性函数，给定两张图片，如果两张图片的相似度比较大（距离比较小），那么两张图片就是同一个人。我们设定一个阈值，如果小于这个阈值，我们认为是同一个人，如果大于这个阈值，我们认为是不同的人。这样，即使有新的人加入这个系统，你的系统依然可以进行判断</p>
<h3 id="孪生网络（Siamese-Network）"><a href="#孪生网络（Siamese-Network）" class="headerlink" title="孪生网络（Siamese Network）"></a>孪生网络（Siamese Network）</h3><p>普通的卷积神经网络是先经过几个卷基层，然后经过一个FC layer，最后一个softmax进行判别，我们在这里删除最后的softmax层，将最后的FC层的输出作为一张图片的编码</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-15/10704951.jpg"></p>
<p>将这些输出的编码作为结果，计算距离，并使得同一个人的不同图片距离小，不同人的图片距离大，以此作为目标进行反向传播，具体的loss函数被称为triple loss function</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-15/66344361.jpg"></p>
<h3 id="三重损失函数（triple-loss-function）"><a href="#三重损失函数（triple-loss-function）" class="headerlink" title="三重损失函数（triple loss function）"></a>三重损失函数（triple loss function）</h3><p>我们每次进行训练的图片应该有三张：Anchor，Positive，Negative，分别代表原始图片，同一个人的图片，另一个人的图片，计算Anchor和Positive以及Negative之间的距离，记作d(A,P)和d(A,N)，计算方法是通过神经网络给出的编码，计算欧式距离，要求同一个人的不同图片距离小(d(A,P)小)，不同人的图片距离大（d(A,N)大），并且他们之间不能是基本相同的大小，因为那样对于分类器来说是比较难区分的，我们把差距超过一定范围$\alpha$的才能称为不同人，如下图所示</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-15/35397965.jpg"></p>
<p>那么损失函数可以是上图中的右式移到左边，那么要求这个损失小于等于0，那么我们取Loss为<br>$$<br>L(A,P.N)&#x3D;max(||f(A)-f(N)||^2-||f(A)-f(N)||^2+\alpha,:0)<br>$$<br>那么代价函数就是<br>$$<br>J&#x3D;\sum_{i&#x3D;1}^mL(A^{(i)},P^{(i)},N^{(i)})<br>$$<br>训练的数据要足够的大，一个人应该有好几张图片，如果只有一张图片是很难训练的</p>
<p>如何选择APN也是有要求的，如果你A,P,N都随机选择，那么两张不同人的图片距离一般来说是肯定大于一个人的两张图片的，所以我们应该选那些尽可能接近的距离值去训练，也就是d(A,P)和d(A,N)要尽量靠近一些</p>
<p>在深度学习中，这些系统的名字一般选择为<code>xxNet</code>或者是<code>Deepxx</code>，比如这里的FaceNet和之前提到的DeepFace</p>
<h3 id="二分类的人脸识别"><a href="#二分类的人脸识别" class="headerlink" title="二分类的人脸识别"></a>二分类的人脸识别</h3><p>另一种进行人脸识别的方法是二分类，当你有一个新的图片需要分类的时候，将它输入一个已经训练好的卷积神经网络，得到一个编码，与系统中另一张图片的编码经过一个logistic单元，最终的$\hat y$如果为1，证明图片来自同一个人，否则来自于不同人</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-15/58169041.jpg"></p>
<p>这里有个节省计算能力的好办法，就是系统中的图片，你应该全部先通过卷及网络算出编码，直接存储编码，这样每次你只需要将新图片经过这个神经网络得到编码，再做一个logistic计算就可以了</p>
<h3 id="风格迁移"><a href="#风格迁移" class="headerlink" title="风格迁移"></a>风格迁移</h3><h4 id="什么是风格迁移"><a href="#什么是风格迁移" class="headerlink" title="什么是风格迁移"></a>什么是风格迁移</h4><p>如下图，我们将原图(Content)称为C，风格图（Style）称为S，生成的图片（Gnerated image）称为G</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-15/56114233.jpg"></p>
<h3 id="深度卷积神经网络究竟学的是什么"><a href="#深度卷积神经网络究竟学的是什么" class="headerlink" title="深度卷积神经网络究竟学的是什么"></a>深度卷积神经网络究竟学的是什么</h3><p>卷积神经网络的前面层，是一些图片的边缘信息，越到后面的层，信息越丰富</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-15/52977504.jpg"></p>
<h3 id="风格迁移的代价函数"><a href="#风格迁移的代价函数" class="headerlink" title="风格迁移的代价函数"></a>风格迁移的代价函数</h3><p>我们用C表示Content这张图，用S表示Style这张图，G代表Generated image，要求定义的代价函数在最小化时使用梯度下降：<br>$$<br>J(G) &#x3D; \alpha J_{content}(C,G) + \beta J_{style}(S,G)<br>$$<br>风格迁移的过程：</p>
<ol>
<li>随机初始化G</li>
<li>进行梯度下降，是的cost function变小，然后输出的图像和C和S的混合越来越像</li>
</ol>
<h4 id="Content-cost-function"><a href="#Content-cost-function" class="headerlink" title="Content cost function"></a>Content cost function</h4><p>你用第$l$层的卷积网络去计算你的content cost function，这个层数不能太靠前（前面全是边缘信息），也不能太靠后（太靠后已经是完整的图片了），你的Content cost function只需要计算第$l$层的Content和Generated 的输出的相似度，我们在这里使用L-2范数<br>$$<br>J_{content}(C,G)&#x3D;||a^{<a href="C">l</a>}-a^{<a href="G">l</a>}||^2<br>$$</p>
<h4 id="Style-cost-function"><a href="#Style-cost-function" class="headerlink" title="Style cost function"></a>Style cost function</h4><p>要定义S和G的风格相似度，我们要来看看如何定义风格的相似，这里引入一个Style matrix的概念，用于定义不同层之间的像素值的乘积和，用$a_{i,j,k}^{[l]}$表示第$l$层的一个像素点，用$G^{[l]}$表示第l层的Style Matrix<br>$$<br>G^{<a href="S">l</a>}<em>{kk\prime} &#x3D; \sum</em>{i&#x3D;1}^{n_H^{[l]}}\sum_{j&#x3D;1}^{n_W^{[l]}}a_{ijk}^{<a href="S">l</a>}a_{ijk\prime}^{<a href="S">l</a>} \<br>G^{<a href="G">l</a>}<em>{kk\prime} &#x3D; \sum</em>{i&#x3D;1}^{n_H^{[l]}}\sum_{j&#x3D;1}^{n_W^{[l]}}a_{ijk}^{<a href="G">l</a>}a_{ijk\prime}^{<a href="G">l</a>} \<br>$$<br>第l层的style cost function就用这两个style function的相似度来计算<br>$$<br>\begin{array}{rcl}<br>J_{style}^{[l]}(S,G)  &amp;&#x3D;&amp; \frac{1}{(…)}||G^{<a href="S">l</a>}-G^{<a href="G">l</a>}||^2 \<br>&amp;&#x3D;&amp; \frac{1}{(2n_H^{[l]}n_W^{[l]}n_C^{[l]})^2}\sum_k\sum_{k{\prime}}(G^{<a href="S">l</a>}<em>{kk\prime}-G^{<a href="G">l</a>}</em>{kk\prime})<br>\end{array}<br>$$<br>通常一层的效果不够好，因此我们多用几层<br>$$<br>J_{style}(S,G)&#x3D;\sum_l\lambda^{[l]}J_{style}^{[l]}(S,G)<br>$$<br>最终的J就是把content和style的J加起来<br>$$<br>J(G) &#x3D; \alpha J_{content}(C,G) + \beta J_{style}(S,G)<br>$$</p>
<h3 id="1D和3D数据的卷积"><a href="#1D和3D数据的卷积" class="headerlink" title="1D和3D数据的卷积"></a>1D和3D数据的卷积</h3><p>1D数据通常是信号数据，你用的卷积核应该也是1D的，比如你一开始是14*1的信号，卷积16个5*1的filter，变成</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-16/99066781.jpg"></p>
<p>3D图像通常有CT图，视频之类的，有长，宽，深度三个维度，</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-16/8799779.jpg"></p>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>deeplearning</tag>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Coursera-deeplearning-ai-（五）</title>
    <url>/2018/05/16/Coursera-deeplearning-ai-%EF%BC%88%E4%BA%94%EF%BC%89/</url>
    <content><![CDATA[<p>这篇博文主要讲的是关于deeplearning.ai的第五门课程的内容，《Sequence Models》</p>
 <span id="more"></span>

<h2 id="Week-one"><a href="#Week-one" class="headerlink" title="Week one"></a>Week one</h2><h3 id="循环神经网络"><a href="#循环神经网络" class="headerlink" title="循环神经网络"></a>循环神经网络</h3><p>循环神经网络的主要应用：语音识别，音乐生成，感觉分类，DNA序列分析，机器翻译，视频行为识别，人名的识别</p>
<h4 id="常用的符号"><a href="#常用的符号" class="headerlink" title="常用的符号"></a>常用的符号</h4><ul>
<li>X：输入数据</li>
<li>$x^{(i) \langle t \rangle }$：第i个输入样本序列中的第t个值</li>
<li>$T_x^{(i)}$：第i个输入样本的长度</li>
<li>y：目标数据</li>
<li>$x^{(i) \langle t \rangle }$：第i个输出序列中的第t个值</li>
</ul>
<h4 id="单词的表示"><a href="#单词的表示" class="headerlink" title="单词的表示"></a>单词的表示</h4><p>首先准备好一个字典，每个词一个one-hot向量，把出现的标记为1，没有出现的标记为0，如果遇到字典中不存在的单词，我们建立一个unknown的词，标记为unknown</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-16/44734504.jpg"></p>
<h4 id="为什么不用标准神经网络"><a href="#为什么不用标准神经网络" class="headerlink" title="为什么不用标准神经网络"></a>为什么不用标准神经网络</h4><p>标准神经网络将单词的表示输入一个网络，然后再输出一个y的向量，但是</p>
<ul>
<li>每个句子的长度不同，因此输入的x和输出的y的长度在变化</li>
<li>标准神经网络不会分享他们之间学到的特征信息</li>
</ul>
<p>因此标准神经网络不适合于这个问题</p>
<h4 id="循环神经网络-1"><a href="#循环神经网络-1" class="headerlink" title="循环神经网络"></a>循环神经网络</h4><p>先输入一个$x^{ \langle 1 \rangle }$，输出$y^{ \langle 1 \rangle }$和$a^{ \langle 1 \rangle }$；然后输入$x^{ \langle 2 \rangle }$，通过$a^{ \langle 1 \rangle }$的信息和$x^{ \langle 2 \rangle }$的信息共同输出$y^{ \langle 2 \rangle }$和$a^{ \langle 2 \rangle }$，后面的步骤相似，由之前的所有信息得到当前的输出y，右边是循环神经网络的另一种表示方式，不过在这门课当中我们用左边的表示方式，通常会构造一个$a^{ \langle 0 \rangle }$，一般构造为0向量</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/51333298.jpg"></p>
<p>但是这样的循环神经网络有个缺点就是只利用了前面的信息，而没有利用后面的信息，比如在判断人名的情况下，我们要判断下图中的Teddy是不是一个人名，我们如果用循环神经网络只能利用前面的信息，下面两个图的判断结果应该相同，解决这个问题的方法是之后会讲解的双向循环神经网络(Bidirectional RNN) BRNN</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/5379891.jpg"></p>
<p>循环神经网络中$a^{ \langle t \rangle }​$和$y^{ \langle t \rangle }​$的计算方法如下，$w_{a_}​$如果和a相乘的时候就是$w_{aa}​$，和x相乘的时候就是$w_{ax}​$，注意这里所有层是共享的同一组参数。上下两个激活函数可以不同，一般来说$g_1​$是tanh（偶尔也可以是Relu），$g_2​$根据任务不同一般是sigmoid或softmax<br>$$<br>\begin{align}<br>a^{\langle t \rangle} &amp;&#x3D; g_1(w_{aa}a^{ \langle t-1 \rangle } + w_{ax}x^{ \langle t \rangle }+b_a)\\<br>y^{ \langle t \rangle } &amp;&#x3D; g_2(w_{ya}a^{ \langle t \rangle } +b_y)<br>\end{align}<br>$$</p>
<p>上面的公式可以通过矩阵进行简化，用$w_a$表示$[w_{aa}| w_{ax}]$的横排并列，用$[a^{ \langle t-1 \rangle },x^{ \langle t \rangle }]$表示$a^{ \langle t-1 \rangle }$ 与$x^{ \langle t \rangle }$的纵向stack，最后公式简化为下图右边的第一个和左边的最下面那个，即</p>
<p>$$<br>\begin{align}<br>a^{ \langle t \rangle } &amp;&#x3D; g(w_{a}[a^{ \langle t-1 \rangle } ,x^{ \langle t \rangle }]+b_a)\\<br>y^{ \langle t \rangle } &amp;&#x3D; g(w_{y}a^{ \langle t \rangle } +b_y)<br>\end{align}<br>$$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/15290928.jpg"></p>
<h3 id="循环神经网络的反向传播"><a href="#循环神经网络的反向传播" class="headerlink" title="循环神经网络的反向传播"></a>循环神经网络的反向传播</h3><p>循环神经网络的反向传播用到的损失函数就是逻辑回归中的交叉熵损失函数</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/60395486.jpg"></p>
<h3 id="不同类型的循环神经网络"><a href="#不同类型的循环神经网络" class="headerlink" title="不同类型的循环神经网络"></a>不同类型的循环神经网络</h3><p>现在为止学到的循环神经网络的输入输出的大小是一样的，也存在一些不一样的情况，比如机器翻译中原句和目标句的长度可能就不一样</p>
<p>我们通过输入输出的数量的不同，进行划分，下图左边的是many-to-many RNN，并且输入数量等于输出的，比如之前的人名识别，中间是many-to-one RNN，比如情感分类，一大段话只需要输出一个情感值，也存在one-to-one的情况，不过很少见</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/56231645.jpg"></p>
<p>还有one-to-many结构，比如音乐生成，给个数字生成一段音乐，还有many-to-many的输入输出长度不同的情况，比如机器翻译的应用</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/1550175.jpg"></p>
<p>总结来说，RNN的不同结构有以下几种</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/65701426.jpg"></p>
<h3 id="语言建模和序列生成"><a href="#语言建模和序列生成" class="headerlink" title="语言建模和序列生成"></a>语言建模和序列生成</h3><p>给定一句话：“cats average 15 hours of sleep a day”，首先你要对这句话进行标记</p>
<p>比如你用一个字典标注，这个字典包含10000个词，你此时还要生成两个额外的词，一个是<code>&lt;EOS&gt;</code>，表示end of sentence，句子的结束标志，还有一个是<code>&lt;UNK&gt;</code>，表示unkonwn words，未知单词</p>
<p>标记完之后你开始计算每个单词出现的概率，然后计算第二个单词在第一个单词出现的概率，计算第三个单词在第一、二个单词出现的概率，一直到最后一个单词</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/78581883.jpg"></p>
<h3 id="采样新序列"><a href="#采样新序列" class="headerlink" title="采样新序列"></a>采样新序列</h3><p>我们之前计算每个$y^{ \langle t \rangle }$是通过选择最大的概率，但是在这里介绍一个新的方法，是通过随机采样作为下一个循环神经网络的输入，直到采样到<code>&lt;UNK&gt;</code>的时候结束</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/72354364.jpg"></p>
<p>除了以单词作为字典，还可以用字母作为字典，可以处理位置单词的情况，但是这种方法计算量更大，用得很少</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/86894239.jpg"></p>
<h3 id="梯度消失"><a href="#梯度消失" class="headerlink" title="梯度消失"></a>梯度消失</h3><p>RNN不擅长捕捉长期依赖关系，比如下图中的was和were和前面的cat和cats的搭配关系，如果中间隔了太多内容，那么他们之间的关系是很弱的</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/16533303.jpg"></p>
<p>除了梯度消失以外还有梯度爆炸的问题，还有梯度爆炸的问题，这只需要进行梯度裁剪即可(gradient clapping)，将超过某个值的梯度按比例缩小后再减</p>
<h3 id="Gated-Recurrent-Unit"><a href="#Gated-Recurrent-Unit" class="headerlink" title="Gated Recurrent Unit"></a>Gated Recurrent Unit</h3><p>选通循环单元(Gated Recurrent Unint)能够很大程度上地改善循环神经网络无法学习长期依赖关系和梯度消失这两个问题。</p>
<p>我们先来看看普通的RNN unit，用$x^{ \langle t \rangle }$和$a^{ \langle t-1 \rangle }$计算出$a^{ \langle t \rangle }$，然后经过softmax计算出$\hat y^{ \langle t \rangle }$，过程如下图所示</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/32330611.jpg"></p>
<p>我们再来看看Gated Recurrent  Unit，首先引入一个C表示memory cell，引入一个$\Gamma$表示选通的值（gated），每次是否更新C的值由选通信号来决定，$\Gamma&#x3D;1$则改变memory cell，$\Gamma&#x3D;0$则不改变，我们用sigmoid函数来表示$\Gamma$，因为sigmoid函数的值大多数都在0和1附近，那么一个GRU单元的定义如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/4804980.jpg"></p>
<p>我们把公式整理一下：<br>$$<br>\begin{align}<br>\tilde C&amp;&#x3D;\tanh(W_c[c^{ \langle t-1 \rangle },x^{ \langle t \rangle }]+b_c)\\<br>\Gamma_u&amp;&#x3D;\sigma(W_u[c^{ \langle t-1 \rangle },x^{ \langle t \rangle }]+b_u)\\<br>c^{ \langle t \rangle }&amp;&#x3D;\Gamma_u \times \tilde c^{ \langle t \rangle }+(1-\Gamma_u) c^{ \langle t-1 \rangle }<br>\end{align}<br>$$<br>其中$\tilde C$表示C的更新值，$\Gamma_u$表示选通函数，有时候我们会再加上一个选通函数$\Gamma_r$，整个GRU的定义如下：<br>$$<br>\begin{align}<br>\tilde C&amp;&#x3D;\tanh(W_c[\Gamma_r\times c^{ \langle t-1 \rangle },x^{ \langle t \rangle }]+b_c)\\<br>\Gamma_u&amp;&#x3D;\sigma(W_u[c^{ \langle t-1 \rangle },x^{ \langle t \rangle }]+b_u)\\<br>\Gamma_r&amp;&#x3D;\sigma(W_r[c^{ \langle t-1 \rangle },x^{ \langle t \rangle }]+b_r)\\<br>c^{ \langle t \rangle }&amp;&#x3D;\Gamma_u\times \tilde c^{ \langle t \rangle }+(1-\Gamma_u) c^{ \langle t-1 \rangle }<br>\end{align}<br>$$</p>
<h3 id="LSTM"><a href="#LSTM" class="headerlink" title="LSTM"></a>LSTM</h3><p>LSTM全称是(long short term memory)，长短期记忆</p>
<p>LSTM是GRU的更一般化的形式，其引入了另外两个选通参数$\Gamma_f$（forget）和$\Gamma_o$（output），还有这里的$\Gamma_u$表示的是update</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/68356717.jpg"></p>
<p>我们来看一个图示的LSTM单元</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/51003024.jpg"></p>
<h3 id="双向循环神经网络-Biderectional-RNN"><a href="#双向循环神经网络-Biderectional-RNN" class="headerlink" title="双向循环神经网络(Biderectional RNN)"></a>双向循环神经网络(Biderectional RNN)</h3><p>目前为止，循环神经网络可以使用前面的信息，但是还不能使用之后的信息，要同时使用上下文信息，需要使用BRNN，双向循环神经网络</p>
<p>下图是一个4层的双向循环神经网络，不光有向前传播的，还有向后传播的，这样就可以同时利用前后文的信息，这个图中是没有循环部分的。标准双向循环神经网络有个缺点就是要整句话的信息才可以进行判断，在一些语音识别之类的任务的时候需要用的是更加复杂的BRNN。BRNN的结构如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/7023899.jpg"></p>
<h3 id="深层RNN"><a href="#深层RNN" class="headerlink" title="深层RNN"></a>深层RNN</h3><p>利用RNN,GRU,LSTM,BRNN综合形成一个深度循环神经网络</p>
<p>我们现在用方括号来代表所在的layer，比如现在有一个三层的RNN，来看看$a^{[2] \langle 3 \rangle }$是怎么计算的，它既有左边的值，又有下面的值，一起算出$a^{[2] \langle 3 \rangle }$，一般来说3层的RNN已经非常深了（因为计算量非常大），通常上面得到的y还可以通过几层普通的神经网络来获得，这样可以使模型更加复杂</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-17/29850041.jpg"></p>
<h2 id="Week-Two"><a href="#Week-Two" class="headerlink" title="Week Two"></a>Week Two</h2><h3 id="词嵌入-Word-Embedding"><a href="#词嵌入-Word-Embedding" class="headerlink" title="词嵌入(Word Embedding)"></a>词嵌入(Word Embedding)</h3><p>嵌入是一个数学概念，表示单射的，结构保持的映射。</p>
<p>词嵌入(Word Embedding)并不是要把单词进行镶嵌，而是把单词嵌入到另一个空间中，要做到单射和结构保持，重点关注的是映射。词嵌入主要是在NLP当中将单词映射成由实数构成的向量上。</p>
<p>最简单的词表达方式就是用一个one-hot向量表示，在你的字典中标出存在的位置。这种方法存在的缺陷就是同类的词汇之间的距离不一定很近，比如apple和orange之间的距离可能是很远的，但是他们都属于水果，这种深层的关系没有被挖掘</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-19/58344691.jpg"></p>
<p>那么我们需要对词当中的特征进行表达，这就是word embedding，比如我们可以从下面这几个词里面学到大约300维度的特征，包括性别，是否与皇家有关等等，这就对每个词进行了特征表达，每个词都被镶嵌到一个300维的向量中，这样分类之后orange和apple的距离就很近了</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-19/34535407.jpg"></p>
<p>词镶嵌的可视化，是将高维的词镶嵌转换到2维，这个方法叫做t-SNE，可以看到，同类的词汇距离更近</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-19/22707995.jpg"></p>
<h3 id="如何使用词嵌入"><a href="#如何使用词嵌入" class="headerlink" title="如何使用词嵌入"></a>如何使用词嵌入</h3><p>我们得到了词嵌入向量之后，使用循环神经网络进行判别，比如在人名识别的任务中，我们先用大量的没有标记的词汇来学习词嵌入的表达，然后用可能10000个词来进行训练，最后进行判别，这是一种典型的迁移学习</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-19/66791396.jpg"></p>
<p>因此基于词嵌入的方法，一共分为三步，第一步用大量数据学习word embedding，第二步迁移到一个数据量较小的任务上，如果这个迁移之后的任务的数据量足够大，那么我们就还需要对迁移之后的数据来改变词嵌入，一般来说不用改变</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-19/19745785.jpg"></p>
<h3 id="词嵌入的属性"><a href="#词嵌入的属性" class="headerlink" title="词嵌入的属性"></a>词嵌入的属性</h3><p>类比问题，我们提出一个问题，man-woman，相当于king-？，那么这个问号是什么呢。我们用之前学到的词嵌入来进行表达两两词嵌入向量的距离。我们发现$e_{man}$和$e_{woman}$之间的距离和$e_{king}$与$e_{quene}$之间的距离基本相等，因此可以认为man-woman等价于king-quene的关系。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/50237387.jpg"></p>
<p>类比问题的做法是”?”代表的词计算出来，用$e_{man}-e_{woman}&#x3D;e_{king}-e_?$表示，那就是要找到词w，$arg\max_wsim(e_w,w_{king}-e_{man}+e_{woman})$</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/64676010.jpg"></p>
<p>最常用的相似性度量方式是Cosine similarity，定义为$sim(u,v)&#x3D;\frac{u^Tv}{||u||_2||v||_2}$，当然也可以用欧氏距离，但是cos相似度用的更多</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/28409899.jpg"></p>
<h3 id="嵌入矩阵"><a href="#嵌入矩阵" class="headerlink" title="嵌入矩阵"></a>嵌入矩阵</h3><p>你进行了word embedding的学习之后，最后的输出是一个嵌入矩阵，这个矩阵就是每个单词一列，所有单词组合得到的矩阵，如下图，乘以一个原本的one-hot的字典类型的表示之后，就可以得到这个单词的嵌入向量，但是实际中，我们只需要去查找这个embedding的向量，而不是做一个很高纬度的乘法</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/41118185.jpg"></p>
<h3 id="如何进行word-embedding的学习"><a href="#如何进行word-embedding的学习" class="headerlink" title="如何进行word embedding的学习"></a>如何进行word embedding的学习</h3><p>一开始进行word embedding方面的研究的时候，模型比较复杂，但是后来人们发现简单的模型的效果也很好。我们在这里先讲一些复杂的模型，然后简化他们，因为复杂的模型更容易让你理解为什么他们会有效。</p>
<p>还是以“I want a glass of orange __”这句单词预测的句子为例，你先把所有的one-hot向量通过embedding matrix E 变成一个embedding vector，然后把他们stacking到一起，输入一个神经网络，最后经过一个softmax单元，输出概率最高的单词，当然你也可以只使用之前的四个单词，删除最开始的I和want</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/78543171.jpg"></p>
<p>除了用之前的四个单词，你还可以使用左右各四个单词，也可以用之前的一个单词，也可以用最近的一个单词等等</p>
<h3 id="Word2Vec"><a href="#Word2Vec" class="headerlink" title="Word2Vec"></a>Word2Vec</h3><p>利用上一节中提到的方法，给定一个词作为context，一个词为target，通过一个embedding matrix，相乘之后经过一个softmax层，得到一个估计y，训练这一过程，来得到embedding matrix的参数</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/2208149.jpg"></p>
<p>主要有两种思想：一种是CBOW方法，是根据上下文来预测当前词语的概率，且上下文所有的词对当前词出现概率的影响的权重是一样的，因此叫continuous bag-of-words模型。如在袋子中取词，取出数量足够的词就可以了，至于取出的先后顺序是无关紧要的。 </p>
<p>Skip-gram刚好相反：根据当前词语来预测上下文的概率。</p>
<p>实际使用这个方法的时候有两个比较大的缺陷：</p>
<ol>
<li>计算量很大，计算概率时的分母求和的内容非常多，这就导致计算很复杂，这个问题在这后会用Negtive sampling解决</li>
<li>如果使用sample方法，那么文中出现的很多的那些无意义的连词出现的概率会比较大，比如the,a,and之类的，这个问题通过huffman 树来解决</li>
</ol>
<p>Huffuman树是通过每次选择最小的两个节点合并成一颗新的树，然后不断往上，直到合并完所有节点，我们来看个例子</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/18041198.jpg"></p>
<p>有了Huffman树，我们再将Huffman编码应用到机器学习中，最初Huffman编码用于编码传输，比如现在你要传一段由6个单词组成的文章（文章长度未知，可能是几十个单词，几百个单词都有可能），那么你需要$2^3$个编码来编码传输，这有两个问题，第一个问题是现在存在编码的浪费，二是不同概率的单词所用的编码是一样的，我们希望经常出现的单词应该编码长度短，不常出现的应该编码长度长，一次综合来取得最短共同长度，举个例子</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/41842953.jpg"></p>
<h3 id="负采样"><a href="#负采样" class="headerlink" title="负采样"></a>负采样</h3><p>上一章节中计算p(t|c)的计算复杂度很高，因此我们在这一章中引入了负采样的方法，负采样就是先选一个context，然后选择一个真正的target，把他的y标记成1，然后选择k个负样本（也就是不是context的上下文的那种单词），然后把他们输入一个sigmoid函数，计算k+1个概率，因此大大减少了计算复杂度</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/81675963.jpg"></p>
<h3 id="Glove-word-vectors"><a href="#Glove-word-vectors" class="headerlink" title="Glove word vectors"></a>Glove word vectors</h3><p>Glove全称：Global Vectors for Word Representation ，是以两个单词i,j互相在对方的上下文（比如前后10个单词之内）中出现的次数来表示的，如果两个次数越接近，两个单词就越相近</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/69857317.jpg"></p>
<p>我们需要优化以下的目标，为了避免出现log0的情况，我们引入一个权重项，在$x_{ij}&#x3D;0$的时候，让权重也等于0</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/74370111.jpg"></p>
<h3 id="Word-embedding应用1——情感分类"><a href="#Word-embedding应用1——情感分类" class="headerlink" title="Word embedding应用1——情感分类"></a>Word embedding应用1——情感分类</h3><p>如果我有一个word embedding的矩阵，我有一句话之后，就可以算出每个单词的word embedding 向量，然后对其平均或者求和来通过一个softmax单元，得到评分为1-5的概率，但这样有个缺点，如左下角的句子所示，没有考虑上下文文本的关系，左下角这个句子有三个good，分类器很可能认为是一个正面评论</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/82511465.jpg"></p>
<p>为了利用上下文信息，需要使用RNN进行分类，是一个many-to-one的结构</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-20/7972513.jpg"></p>
<h2 id="Week-Three"><a href="#Week-Three" class="headerlink" title="Week Three"></a>Week Three</h2><h3 id="序列到序列的模型"><a href="#序列到序列的模型" class="headerlink" title="序列到序列的模型"></a>序列到序列的模型</h3><p>我们有一句法语需要翻译，首先我们将法语输入一个RNN（比如LSTM单元），编码之后，再经过一个解码的RNN单元，把每次输出的单词作为下一个单元的输入，直到解码结束。事实证明，只要你拥有足够的训练数据（法语到英文的转换内容），你的系统可以表现的很好</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/66666382.jpg"></p>
<p>在图像标注的问题当中，也需要类似的办法。比如给定一张图像，然后给一句话对其进行描述，需要对新的图像同样进行描述的任务就称为图像标注。先用一个CNN对图像进行编码，比如一个AlexNet，然后将这个得到的编码输入一个RNN，输出一句描述。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/28729637.jpg"></p>
<h3 id="选择可能性最大的句子"><a href="#选择可能性最大的句子" class="headerlink" title="选择可能性最大的句子"></a>选择可能性最大的句子</h3><p>我们在进行机器翻译的时候，不是每次选择一个出现概率最大的词语，而是选择出现那一整句话最大概率的情况，也就是所有单词联合概率最大的情况。</p>
<p>比如我们看看下面这个例子，假如我们 现在已经选了两个单词”Jane is”，然后你现在要选第三个单词，可能going在英语中出现的概率更大，但是going这一句并没有上面那一整句的翻译效果好，因此我们要选择一整句出现概率大的情况</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/22639407.jpg"></p>
<p>因此此时要引入beam search algorithm</p>
<h3 id="beam-search-algorithm"><a href="#beam-search-algorithm" class="headerlink" title="beam search algorithm"></a>beam search algorithm</h3><p>加入你要找到最大的联合概率，那么你每一步都要评估你字典那么多个概率，比如你字典中有10000个单词，如果你要翻译为1个长度为10的句子，那么你就要计算$10000^{10}$这个多个概率，从中选择最大的。</p>
<p>beam search的思想就是每次你只选择n个最大的概率向后计算，比如你现在beam&#x3D;3，那么你每次只选择概率最大的3个短语向后计算，如下图，第一个单词概率最大的3个是”in, jane, sptember”，然后你以$\hat y^{ \langle 1 \rangle }$分别是”in, jane, sptember”，向后计算第二个单词，选出集中概率最大的三个，比如现在是”in september, jane is, jane visits”，然后再以这三个向后计算第三个单词，直到最后一个</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/80515032.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/61749994.jpg"></p>
<h3 id="细化beam-search"><a href="#细化beam-search" class="headerlink" title="细化beam search"></a>细化beam search</h3><p>length normalization是一种可以让beam search表现得更好的方法</p>
<p>一个很靠后的单词，是前面所有条件概率的乘积，那么越靠后这个概率可能越小，为了使计算机不会因为float值的存储长度限制而损失精度，一般用log函数进行表示</p>
<p>此外，长度越长，明显概率越小，为了使得最后的结果不是一堆长度很短的内容，我们使用长度对其归一化，也可以是长度的某个指数</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/5599276.jpg"></p>
<h3 id="beam-search的错误分析"><a href="#beam-search的错误分析" class="headerlink" title="beam search的错误分析"></a>beam search的错误分析</h3><p>在做机器翻译的时候，出现错误你需要去看看是beam search的错误还是RNN的错误</p>
<p>此时只需要比较RNN和beam search 两者的概率，如果RNN输出的概率大于beam search的概率，就是beam search的错误；反之则是RNN的错误。然后比较很多例子的错误来源，看哪个错误占得比例大， 就是哪个的主要错误。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/90034694.jpg"></p>
<h3 id="Bleu-score"><a href="#Bleu-score" class="headerlink" title="Bleu score"></a>Bleu score</h3><p>机器翻译与图片识别不一样，图片识别往往只有一个最终结果，但机器翻译有时候会存在好几句的翻译效果是一样好的情况，那么如何评价你翻译的好坏呢？这个时候就要引入Bleu score</p>
<p>首先我们看看单个单词程度的精度评价，原本的精度评价方式是在原句中存在且在翻译结果中也存在的单词的出现次数除以目标句子的总长，但下面这个时候这个评价指标就会失效。我们对其进行修正，用目标句和参考句中都出现的单词，其在参考句中出现次数的最大值，除以结果句的长度</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/57338958.jpg"></p>
<p>但是我们有时候不光是需要一个单词的精度，还要看看相邻单词的次数，此时的方法如下，对所有二元组，用其在所有参考句中出现的次数之和，除以目标句中出现的次数之和</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-21/29439686.jpg"></p>
<p>同样你还可以计算出三元组，四元组等等的结果，把他们加起来再放到e的指数上面，作为一个评估指标</p>
<h3 id="注意力模型"><a href="#注意力模型" class="headerlink" title="注意力模型"></a>注意力模型</h3><p>处理翻译问题的过程中，不论是对于人或者机器，如果句子过长，那么你很难去记住一个句子，然后把他们全部翻译出来。正确的处理方式应该是先看一部分，然后翻译一部分，直到翻译完所有内容。</p>
<p>我们以翻译法语到英语为例，假如你正在翻译”jane visite l’Afrique en septembre”，那么你翻译的第一个结果$s^{ \langle 1 \rangle }$到底需要关注哪些单词呢？我们在这里计算出一个注意力权重系数，$\alpha^{ \langle t,t^\prime \rangle }$表示在生成第t个翻译内容的单词时，需要对原文的$t^\prime$那个单词关注多少</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-22/88175104.jpg"></p>
<p>计算attention model 的方法，是先在下面用一个双向RNN，上面一个单向RNN，对每个词计算出注意力权重系数，然后加起来作为上面的单向RNN的输入。当然真正计算的时候还要加一个softmax单元，保证每一个注意力权重系数小于1</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-22/92447051.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-22/30477278.jpg"></p>
<h3 id="语音识别"><a href="#语音识别" class="headerlink" title="语音识别"></a>语音识别</h3><p>语音识别就是把一段音频数据转换成对应的文字，这个问题可以使用注意力模型。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-22/13099425.jpg"></p>
<p>同时，由于输出可能远大于输入，我们需要对输出的结果进行删减，方法是删除所有细小停顿，然后拼凑成一个个单词，这里用到的损失函数叫做CTC cost</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-22/49198460.jpg"></p>
<p>语音识别需要大量的训练数据，一般来说学术论文需要几千个小时的数据，商业系统需要100000小时数据</p>
<h3 id="触发词检测"><a href="#触发词检测" class="headerlink" title="触发词检测"></a>触发词检测</h3><p>标记一段数据，出现触发词的下一个标记标记为1，直到结束标记为0</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-22/54173363.jpg"></p>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>deeplearning</tag>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Cross Validation 交叉验证</title>
    <url>/2017/10/10/Cross-Validation-%E4%BA%A4%E5%8F%89%E9%AA%8C%E8%AF%81/</url>
    <content><![CDATA[<p>传统的$F-measure$或平衡的$F-score$ (F1 score)是精度和召回的调和平均值：</p>
<p>$F_1 &#x3D; 2 \frac{precision*recall}{precision + recall}$ </p>
<span id="more"></span>

<h2 id="交叉验证"><a href="#交叉验证" class="headerlink" title="交叉验证"></a>交叉验证</h2><p>cross validation大概的意思是：对于原始数据我们要将其一部分分为train_data，一部分分为test_data。train_data用于训练，test_data用于测试准确率。在test_data上测试的结果叫做validation_error。将一个算法作用于一个原始数据，我们不可能只做出随机的划分一次train和test_data，然后得到一个validation_error，就作为衡量这个算法好坏的标准。因为这样存在偶然性。我们必须好多次的随机的划分train_data和test_data，分别在其上面算出各自的validation_error。这样就有一组validation_error，根据这一组validation_error，就可以较好的准确的衡量算法的好坏。</p>
<p>cross validation是在数据量有限的情况下的非常好的一个evaluate performance的方法。而对原始数据划分出train data和test data的方法有很多种，这也就造成了cross validation的方法有很多种。</p>
<h2 id="带乱序的"><a href="#带乱序的" class="headerlink" title="带乱序的"></a>带乱序的</h2><p>使用下面的公式可以进行5折交叉验证，<code>cross_val_score</code>函数是进行交叉验证并计算出Validation_score的，但是其中的cross validation并没有打乱原始数据的顺序，所以使用<code>Kfold</code>函数构建cv变量，传递给<code>cross_val_score</code>的cv参数，其中scoring参数可以指定计算准确率的方式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Validation function</span></span><br><span class="line">n_folds = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rmsle_cv</span>(<span class="params">model</span>):</span><br><span class="line">    kf = KFold(n_folds, shuffle=<span class="literal">True</span>, random_state=<span class="number">42</span>).get_n_splits(train.values)</span><br><span class="line">    rmse= np.sqrt(-cross_val_score(model, train.values, y_train, scoring=<span class="string">&quot;neg_mean_squared_error&quot;</span>, cv = kf))</span><br><span class="line">    <span class="keyword">return</span>(rmse)</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>机器学习</category>
      </categories>
      <tags>
        <tag>机器学习</tag>
        <tag>交叉验证</tag>
      </tags>
  </entry>
  <entry>
    <title>Django与React前后端分离的认证(一)</title>
    <url>/2018/06/17/Django%E4%B8%8EReact%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E7%9A%84%E8%AE%A4%E8%AF%81-%E4%B8%80/</url>
    <content><![CDATA[<p>难以想象如果一个Django应用没有用户认证，我们用一个简单的认证流程来解释一下Django和React的协作进行用户认证的过程。</p>
<span id="more"></span>

<p>第一部分用JWT token认证创建一个简单的Django后端。第二部分展示如何创建React&#x2F;Redux前端，第三部分介绍如何应用JWT去刷新token。</p>
<p>最终你可以看到一个以django为后端，react&#x2F;redux为前端的小应用。</p>
<h2 id="什么是JWT"><a href="#什么是JWT" class="headerlink" title="什么是JWT"></a>什么是JWT</h2><p>json web token是一种无状态的认证方法。生成的token只保存在客户端。一个JWT token本身可能包含了用户名，邮箱或者用户权限。</p>
<p>JWT可以提供两种类型的token，一种是长期刷新的token（用于token过期之后的重新获取），一种是短期访问的token（用于调用API服务）</p>
<h2 id="建立后端代码"><a href="#建立后端代码" class="headerlink" title="建立后端代码"></a>建立后端代码</h2><p>首先用virtualenv建立新的环境，并安装相关库</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> backend/ &amp;&amp; <span class="built_in">cd</span> backend/</span><br><span class="line">$ python3.6 -m venv <span class="built_in">env</span></span><br><span class="line">$ <span class="built_in">source</span> <span class="built_in">env</span>/bin/activate</span><br><span class="line">$ pip install coreapi django djangorestframework \</span><br><span class="line">      djangorestframework-simplejwt</span><br><span class="line">$ pip freeze &gt; requirements.txt</span><br><span class="line">$ django-admin startproject config .</span><br></pre></td></tr></table></figure>

<p>安装的coreapi库用于自动生成api的模式，用于描述有什么资源可以用，urls是什么，支持什么操作，如何去展现结果。</p>
<p><a href="https://github.com/davesque/django-rest-framework-simplejwt">django-rest-framework-simplejwt</a> 库用于执行JWT认证</p>
<p>然后在<code>config/settings.py</code>中配置：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"><span class="comment"># Rest Framework</span></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.IsAuthenticated&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: (</span><br><span class="line">        <span class="string">&#x27;rest_framework_simplejwt.authentication.JWTAuthentication&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;rest_framework.authentication.SessionAuthentication&#x27;</span>,</span><br><span class="line">    ),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加入<code>rest_framework</code>到<code>INSTALLED_APPS</code>当中，用<code>IsAuthenticated</code>来保护所有的api访问权限，用<code>JWTAuthentication</code>和<code>SessionAuthentication</code>来保护认证的视图</p>
<p>修改<code>config/urls.py</code>：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> generic</span><br><span class="line"><span class="keyword">from</span> rest_framework.schemas <span class="keyword">import</span> get_schema_view</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (TokenObtainPairView,TokenRefreshView,)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, generic.RedirectView.as_view(url=<span class="string">&#x27;/api/&#x27;</span>, permanent=<span class="literal">False</span>)),</span><br><span class="line">    url(<span class="string">r&#x27;^api/$&#x27;</span>, get_schema_view()),</span><br><span class="line">    url(<span class="string">r&#x27;^api/auth/&#x27;</span>, include(<span class="string">&#x27;rest_framework.urls&#x27;</span>, namespace=<span class="string">&#x27;rest_framework&#x27;</span>)),</span><br><span class="line">    url(<span class="string">r&#x27;^api/auth/token/obtain/$&#x27;</span>, TokenObtainPairView.as_view()),</span><br><span class="line">    url(<span class="string">r&#x27;^api/auth/token/refresh/$&#x27;</span>, TokenRefreshView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这里使用了<code>get_schema_view</code>去是的api视图可用，<code>TokenObtainPairView</code> 和<code>TokenRefreshView</code> 完成JWT认证的作用</p>
<p>为了简单，我们把echo API部分直接放在<code>config/urls.py</code>中</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MessageSerializer</span>(serializers.Serializer):</span><br><span class="line">    message = serializers.CharField()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">EchoView</span>(views.APIView):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">post</span>(<span class="params">self, request, *args, **kwargs</span>):</span><br><span class="line">        serializer = MessageSerializer(data=request.data)</span><br><span class="line">        serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(</span><br><span class="line">            serializer.data, status=status.HTTP_201_CREATED)</span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    url(<span class="string">r&#x27;^api/echo/$&#x27;</span>, EchoView.as_view())</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>现在可以运行django代码</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ ./manage.py migrate</span><br><span class="line">$ ./manage.py createsuperuser</span><br><span class="line">$ ./manage.py runserver</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>网页</category>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>React</tag>
      </tags>
  </entry>
  <entry>
    <title>Django项目学习</title>
    <url>/2017/12/13/Django%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>本文主要来自于mooc公开课Django课程</p>
<h3 id="首先创建一个Django的虚拟环境："><a href="#首先创建一个Django的虚拟环境：" class="headerlink" title="首先创建一个Django的虚拟环境："></a>首先创建一个Django的虚拟环境：</h3><p><code>pip install virtualenv</code>，然后使用<code>virtualenv 虚拟环境名</code>建立一个虚拟环境，在windows下面的激活方法是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cd django_virtual</span><br><span class="line">cd Script</span><br><span class="line">activate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在linux下只需要将最后一步换位source activate</p>
<span id="more"></span>

<h3 id="建立Django项目"><a href="#建立Django项目" class="headerlink" title="建立Django项目"></a>建立Django项目</h3><p>在PyCharm建立程序时，直接选择Django程序，选择解释器为virtualenv建立的django环境，即可建立django项目</p>
<p>项目建立之后，我们得到了如下的目录结构，紫色的被标记为了templet目录，这样就能智能提示，如果你想要在import的时候不需要加入绝对路径，那么就可以<code>mark as source root</code></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-13/70910990.jpg" alt="img"></p>
<p>接下来我们先尝试运行该项目，点击run，运行这个Django项目，可以看到运行在了本机的8000端口，点击该地址即可访问：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-13/88013332.jpg" alt="img"></p>
<p>如果要配置监听所有ip，那么我们需要通过<code>run-Edit configurations</code>，将监听端口改为0.0.0.0</p>
<h3 id="Navicat使用"><a href="#Navicat使用" class="headerlink" title="Navicat使用"></a>Navicat使用</h3><p>安装好Navicat之后，打开软件，建立连接，之后建立表，设计表的字段，设计完之后按<code>ctrl+s</code>保存，之后就可以插入数据条目，这就是简单的使用方法，具体使用会在之后用到的时候详细介绍。<a href="%5Bhttp://pan.baidu.com/s/1pLNJOBD">下载地址请点击</a></p>
<h3 id="Django目录结构"><a href="#Django目录结构" class="headerlink" title="Django目录结构"></a>Django目录结构</h3><p>首先看看之前提到的建立django之后的目录结构，windows使用<code>tree \F .</code>得到如下结构，linux中使用<code>apt-get install tree</code>，然后<code>tree .即可得到</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">├mooc_web</span><br><span class="line">  │  manage.py</span><br><span class="line">  ├─mooc_web</span><br><span class="line">  │  │  settings.py</span><br><span class="line">  │  │  urls.py</span><br><span class="line">  │  │  wsgi.py</span><br><span class="line">  │  │  __init__.py</span><br><span class="line">  └─templates</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>templetes文件夹主要放html文件</li>
<li><a href="http://主文件夹下面有settings.py/">主文件夹下面有settings.py</a>，<a href="http://以及manage.py/">以及manage.py</a></li>
<li>我们需要建立static文件夹，用于存放css和js文件，以及主要的图片文件</li>
<li>建立log文件夹，用于存放日志</li>
<li>建立media文件夹，用于存放用户上传的文件</li>
<li>建立apps文件夹，用于存放各个app</li>
</ul>
<h3 id="建立app"><a href="#建立app" class="headerlink" title="建立app"></a>建立app</h3><p>通过pycharm当中的<code>tools-run manage.py task</code>，此时可以在shell中执行Django命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">startapp message</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时就有了一个名为message的文件夹，将其拖入apps文件夹，自动生成了一个<code>__init__.py</code>文件，这样就让apps变成一个可以导入的包，为了方便导入，那么我们需要将apps文件夹remark成source root，这样每次引用的时候就不需要import apps.message.view 而是可以直接 import message.view</p>
<p>这样在pycharm中引用变得方便了，但是在使用命令行运行的时候就会出错，此时我们需要在settings.py中将apps加入到<strong>根搜索路径</strong>（BASE_DIR）中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">├── apps</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   └── message</span><br><span class="line">│       ├── admin.py</span><br><span class="line">│       ├── apps.py</span><br><span class="line">│       ├── __init__.py</span><br><span class="line">│       ├── migrations</span><br><span class="line">│       │   └── __init__.py</span><br><span class="line">│       ├── models.py</span><br><span class="line">│       ├── tests.py</span><br><span class="line">│       └── views.py</span><br><span class="line">├── db.sqlite3</span><br><span class="line">├── log</span><br><span class="line">├── manage.py</span><br><span class="line">├── media</span><br><span class="line">├── mooc_web</span><br><span class="line">│   ├── __init__.py</span><br><span class="line">│   ├── settings.py</span><br><span class="line">│   ├── urls.py</span><br><span class="line">│   └── wsgi.py</span><br><span class="line">├── static</span><br><span class="line">└── templates</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立log文件夹用于存放日志，media用于存放用户的上传文件，建立static存放静态css和js文件</p>
<p>当app比较多的时候，就建立一个apps文件夹，将新建立的app拖进去</p>
<h3 id="使用模板"><a href="#使用模板" class="headerlink" title="使用模板"></a>使用模板</h3><p>将html模板放入template文件夹，在static文件夹中建立css文件夹，并放入style.css文件</p>
<h3 id="settings配置"><a href="#settings配置" class="headerlink" title="settings配置"></a>settings配置</h3><h4 id="更改数据库配置"><a href="#更改数据库配置" class="headerlink" title="更改数据库配置"></a>更改数据库配置</h4><p>因为Django默认用的是sqlite数据库，我们要改成mysql数据库，<a href="http://打开项目的settings.py/">打开项目的settings.py</a>，找到DATABASES，将其中的：</p>
<ul>
<li>ENGINE改为<code>django.db.backends.mysql</code></li>
<li>NAME改为Navicat中看到的<code>testDjango</code></li>
<li>USER改为数据库的user名，我这里是root</li>
<li>PASSWORD改为数据库的password，我这里也是root</li>
<li>HOST改为localhost，也就是127.0.0.1</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &#x27;default&#x27;: &#123;</span><br><span class="line">        &#x27;ENGINE&#x27;: &#x27;django.db.backends.mysql&#x27;,</span><br><span class="line">        &#x27;NAME&#x27;: &#x27;testDjango&#x27;,</span><br><span class="line">        &#x27;USER&#x27;: &#x27;root&#x27;,</span><br><span class="line">        &#x27;PASSWORD&#x27;: &#x27;root&#x27;,</span><br><span class="line">        &#x27;HOST&#x27;: &#x27;127.0.0.1&#x27;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>####migration生成数据表 通过<code>tools-Run manage.py Task</code>来连接数据库，首先需要安装mysqlclient，用<code>pip install mysqlclient</code>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; makemigrations   # 用于生成一个基于你对模型改变的迁移，在这里就是数据库类型从sqlite迁移到mysql</span><br><span class="line">&gt; migrate		  # 用于应用改变	</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时Django自动生成了一大堆数据库表，在Navicat中可以看到表的名称：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-14/11540528.jpg" alt="img"></p>
<p>此时可以点击run运行整个系统，可以在127.0.0.1:8000上访问该网址</p>
<h4 id="配置static文件夹地址"><a href="#配置static文件夹地址" class="headerlink" title="配置static文件夹地址"></a>配置static文件夹地址</h4><p>但是此时的style.css无法被找到，我们要在settings.py中配置一下static文件夹的地址，因为<code>STATICFILES_DIRS</code> 可能不止一个，所以用list的形式进行赋值，其中BASE_DIR是项目文件的根目录：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR,&#x27;static&#x27;)</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="urls-py配置和views-py函数"><a href="#urls-py配置和views-py函数" class="headerlink" title="urls.py配置和views.py函数"></a>urls.py配置和views.py函数</h3><p>在urls.py中添加新的页面，页面的处理函数要在<code>apps-message-views.py</code> 中新增，首先我们在<code>view.py</code> 中构造如下函数，直接return render的模板，其中request参数是Django的请求，每个views函数都得有：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def getform(request):</span><br><span class="line">    return render(request, template_name=&#x27;course-comment.html&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="项目配置流程"><a href="#项目配置流程" class="headerlink" title="项目配置流程"></a>项目配置流程</h3><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-14/89792661.jpg" alt="img"></p>
<p>整体来说，先设置数据库和STATICFILES_DIRS，之后这一块不再动，主要就是views.py写后端逻辑，urls.py写页面地址url配置</p>
<h3 id="Django-orm-模型设计"><a href="#Django-orm-模型设计" class="headerlink" title="Django orm 模型设计"></a>Django orm 模型设计</h3><p>普通的数据库调用方法，连接（connect），生成cursor，excute sql语句，cursor.fetchall( )</p>
<p>orm就是把一个表映射成一个类，比如要找出name只需要调用<code>book.name</code></p>
<p>下面我们开始使用orm进行设计数据库：</p>
<p>找到message下面的models.py文件，在其中定义一个UserMessage类，用于存放我们需要的数据，所有model都要继承models.Model类：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class UserMessage(models.Model):</span><br><span class="line">    name = models.CharField(max_length=20, verbose_name=&#x27;用户名&#x27;)</span><br><span class="line">    email = models.EmailField(verbose_name=&#x27;邮箱&#x27;)</span><br><span class="line">    address = models.CharField(max_length=100, verbose_name=&#x27;地址&#x27;)</span><br><span class="line">    message = models.CharField(max_length=500, verbose_name=&#x27;留言信箱&#x27;)</span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;用户留言信息&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line">        ordering = &#x27;-id&#x27;  # 排序方式为反向的id</span><br><span class="line">        db_table = &#x27;my_table&#x27;  #设置table的名字</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>其中每一个字段都定义一个类型，常用的有CharField，EmailField，DateTimeField, IntergerField, ForeignKey, IPAddressField, FileField, ImageField</p>
<p>其中max_length表示最大长度，verbose_name表示别名.</p>
<p>自己定义的model还有一个内部类Meta，用于存放所有不是Field的字段，比如排序的顺序，数据表的名称等等</p>
<h4 id="应用模型的改变"><a href="#应用模型的改变" class="headerlink" title="应用模型的改变"></a>应用模型的改变</h4><p>点击<code>Tools-Run manage.py</code>，执行命令，发现找不到message这个model，所有我们要去settings.py中<code>INSTALLED_APPS</code>加入’app.message’</p>
<p>再次执行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; makemigrations message</span><br><span class="line">&gt; migragate message</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="对数据表进行增删改查"><a href="#对数据表进行增删改查" class="headerlink" title="对数据表进行增删改查"></a>对数据表进行增删改查</h4><h5 id="查找数据"><a href="#查找数据" class="headerlink" title="查找数据"></a>查找数据</h5><p>先引入model对象，<code>from apps.message.models import UserMessage</code> ，，利用model对象的objects方法，对数据进行操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">all_message = UserMessage.objects.all()  #这个是可以循环的</span><br><span class="line">for message in all_messages:</span><br><span class="line">	print(message.name)</span><br><span class="line"></span><br><span class="line">filterd_data = UserMessage.objects.filter(name=&#x27;jeffrey&#x27;,address=&#x27;beijing&#x27;)  #filter方法可以对数据进行过滤，中间的逗号表示多个条件，这里是取出的name为jeffrey，address为北京的值</span><br><span class="line">for message in filterd_data:</span><br><span class="line">	print(message.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的all就是取出所有值，filter就是取出特定条件的值</p>
<h5 id="增加数据"><a href="#增加数据" class="headerlink" title="增加数据"></a>增加数据</h5><p>定义一个新的对象，并对其各个field赋值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">user_message = UserMessage()</span><br><span class="line">user_message.name = &#x27;a&#x27;</span><br><span class="line">user_message.message = &#x27;a@a.com&#x27;</span><br><span class="line">user_message.message = &#x27;aaaaa&#x27;</span><br><span class="line">user_message.save()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样每次访问form页面的时候都可以存入一条记录</p>
<p>在html文件中需要进行如下更改：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;form action=&quot;/form/&quot; method=&quot;post&quot; class=&quot;smart-green&quot;&gt;</span><br><span class="line">在action中填入网页地址</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>需要加入CSRF安全机制，</p>
<p>还可以通过页面的表单提交增加新的数据，request的POST属性中，以字典的形式存储了表单中提交的值，可以用python的get方法获取这些值，get的第二个参数为获取不到时候的默认值：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">if request.method == &#x27;POST&#x27;:</span><br><span class="line">    name = request.POST.get(&#x27;name&#x27;,&#x27;&#x27;)</span><br><span class="line">    email = request.POST.get(&#x27;email&#x27;, &#x27;&#x27;)</span><br><span class="line">    message = request.POST.get(&#x27;message&#x27;, &#x27;&#x27;)</span><br><span class="line">    </span><br><span class="line">    user_message = UserMessage()</span><br><span class="line">    user_message.name = &#x27;a&#x27;</span><br><span class="line">    user_message.email = &#x27;a@a.com&#x27;</span><br><span class="line">    user_message.message = &#x27;aaaaa&#x27;</span><br><span class="line">    user_message.save()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="删除数据"><a href="#删除数据" class="headerlink" title="删除数据"></a>删除数据</h5><p>直接先查找到对象，然后用delete方法就可以删除对象</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">all_message = UserMessage.objects.fileter(name=&#x27;bob&#x27;)</span><br><span class="line">all_message.delete()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="显示数据库中的数据到页面"><a href="#显示数据库中的数据到页面" class="headerlink" title="显示数据库中的数据到页面"></a>显示数据库中的数据到页面</h3><p>在view.py中，我们可以先取出数据，然后在render的时候，把需要传入的参数以一个dict的形式，传递给context，这样我们就可以在html文件中进行调用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def getform(request):</span><br><span class="line">    message = None</span><br><span class="line">    all_message = UserMessage.objects.filter(name=&#x27;boobytest&#x27;)</span><br><span class="line">    if all_message:</span><br><span class="line">    	message = all_message[0]</span><br><span class="line">    return render(request, template_name=&#x27;course-comment.html&#x27;,context=&#123;&#x27;message&#x27;:message,&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在HTML文件中调用参数的方法是两个大括号，input就输入在value里面，textarea就输入在两个标签之间：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;input id=&quot;email&quot; type=&quot;email&quot; value=&#123;　&#123; message.email &#125;　&#125; name=&quot;email&quot; placeholder=&quot;请输入邮箱地址&quot;/&gt;</span><br><span class="line">&lt;textarea id=&quot;message&quot; name=&quot;message&quot;  placeholder=&quot;请输入你的建议&quot;&gt;&#123;　&#123; message.message &#125;　&#125;&lt;/textarea&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="在HTML文件中使用python逻辑"><a href="#在HTML文件中使用python逻辑" class="headerlink" title="在HTML文件中使用python逻辑"></a>在HTML文件中使用python逻辑</h3><p>在HTML文件中，使用python逻辑的方法是大括号加百分号，<code>&#123;　% python expression %　&#125;</code></p>
<p>if和end if成对出现</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;input id=&quot;name&quot; type=&quot;text&quot; value=&quot;&#123; % if not message.name == &#x27;boobytest&#x27; % &#125;</span><br><span class="line">boobyhastest&#123; % else % &#125;booby no test</span><br><span class="line">&#123; % endif % &#125;&quot; name=&quot;name&quot; class=&quot;error&quot; placeholder=&quot;请输入您的姓名&quot;/&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>比如在HTML中使用if和else的方法如上，当然if a&#x3D;&#x3D;b 也可以使用 ifequal a b代替，取前五位也可以使用<code>message.name|split:&#39;5&#39;</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123; % ifequal a b% &#125;  &#123; % endif % &#125;#用于表示等于</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Django提供了很多内置的方法，具体可以查看<a href="https://docs.djangoproject.com/en/2.0/ref/templates/builtins/">Django template built-in tags</a></p>
<h3 id="使用别名关联url和HTML"><a href="#使用别名关联url和HTML" class="headerlink" title="使用别名关联url和HTML"></a>使用别名关联url和HTML</h3><p>url在配置过程中可能会改变，因此我们需要为url设置一个不变的名字供HTML调用</p>
<p>在url.py中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url(r&#x27;^form/$&#x27;, getform,name=&#x27;form&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在comment.html中：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;form action=&quot;&#123; % url &#x27;form&#x27; % &#125;&quot; method=&quot;post&quot; class=&quot;smart-green&quot;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意，在url配置中一定要加上<code>/$</code> 表示以<code>/</code>结尾，不然再进行正则匹配的时候可能会匹配到别的网页</p>
<h3 id="url匹配"><a href="#url匹配" class="headerlink" title="url匹配"></a>url匹配</h3><p>必须在url前面加上<code>^</code>，后面加上<code>/$</code>，这样不会匹配出错</p>
<h2 id="mooc开发实战"><a href="#mooc开发实战" class="headerlink" title="mooc开发实战"></a>mooc开发实战</h2><h3 id="app设计"><a href="#app设计" class="headerlink" title="app设计"></a>app设计</h3><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-1-21/6996332.jpg" alt="img"></p>
<h3 id="新建虚拟环境"><a href="#新建虚拟环境" class="headerlink" title="新建虚拟环境"></a>新建虚拟环境</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mkvirtualenv mooc</span><br><span class="line">cd mooc/Script</span><br><span class="line">activate</span><br><span class="line">pip install Django mysqlclient</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="新建Django项目"><a href="#新建Django项目" class="headerlink" title="新建Django项目"></a>新建Django项目</h3><p>通过pycharm建立Django项目，名字为MxOnline，首先在settings.py中更改数据库引擎</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    &#x27;default&#x27;: &#123;</span><br><span class="line">        &#x27;ENGINE&#x27;: &#x27;django.db.backends.mysql&#x27;,</span><br><span class="line">        &#x27;NAME&#x27;: &#x27;mxonline&#x27;,</span><br><span class="line">        &#x27;USER&#x27;: &#x27;root&#x27;,</span><br><span class="line">        &#x27;PASSWORD&#x27;: &#x27;root&#x27;,</span><br><span class="line">        &#x27;HOST&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过<code>Tools-run manage.py task</code>来生成数据库的表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">makemigrations</span><br><span class="line">migragate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="扩展user表"><a href="#扩展user表" class="headerlink" title="扩展user表"></a>扩展user表</h3><p>首先<code>startapp users</code>，在models当中，新建一个<code>UserProfile</code>，继承<code>django.contrib.auth.models.AbstractUser</code>，加入你需要的自定义字段，并定义好meta信息中的<code>verbose_name</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line">from django.contrib.auth.models import AbstractUser</span><br><span class="line"></span><br><span class="line"># Create your models here.</span><br><span class="line">class UserProfile(AbstractUser):</span><br><span class="line">    nick_name = models.CharField(max_length=50,verbose_name=&#x27;昵称&#x27;,default=&#x27;&#x27;)</span><br><span class="line">    birthday = models.DateField(verbose_name=&#x27;生日&#x27;,null=True,blank=True)</span><br><span class="line">    gender = models.CharField(max_length=5,choices=((&#x27;male&#x27;,&#x27;男&#x27;),(&#x27;female&#x27;,&#x27;女&#x27;)),default=&#x27;&#x27;)</span><br><span class="line">    address = models.CharField(max_length=100,default=&#x27;&#x27;)</span><br><span class="line">    mobile = models.CharField(max_length=11, null=True, blank=True)</span><br><span class="line">    image = models.ImageField(upload_to=&#x27;image/%Y/%m&#x27;,default=&#x27;image/default.png&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;用户信息&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后run <a href="http://manage.py/">manage.py</a>，通过<code>makemigrations users</code>和<code>migragate users</code>生成新的user表，可能会报错，报错时只需要将之前生成的所有表删除后重新生成即可</p>
<h3 id="循环引用"><a href="#循环引用" class="headerlink" title="循环引用"></a>循环引用</h3><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-1-23/18897780.jpg" alt="img"></p>
<p>避免交叉引用，不然会出错，使用上层app引用下层app</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-1-23/87606606.jpg" alt="img"></p>
<h3 id="加入邮件验证码和轮播图"><a href="#加入邮件验证码和轮播图" class="headerlink" title="加入邮件验证码和轮播图"></a>加入邮件验证码和轮播图</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class EmailVerifyRecord(models.Model):</span><br><span class="line">    code = models.CharField(max_length=20, verbose_name=&#x27;验证码&#x27;)</span><br><span class="line">    email = models.EmailField(max_length=50, verbose_name= &#x27;邮箱&#x27;)</span><br><span class="line">    send_type = models.CharField(choices=((&#x27;register&#x27;,&#x27;注册&#x27;),(&#x27;forget&#x27;,&#x27;找回密码&#x27;)),max_length=10)</span><br><span class="line">    send_time = models.DateTimeField(default=datetime.now) #记得去掉datetime.now的括号，不然只会记录class生成的时间</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;邮箱验证码&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class Banner(models.Model):</span><br><span class="line">    title = models.CharField(max_length=100, verbose_name=&#x27;标题&#x27;)</span><br><span class="line">    image = models.ImageField(upload_to=&#x27;banner/%Y/%m&#x27;, verbose_name=&#x27;轮播图&#x27;)</span><br><span class="line">    url = models.URLField(max_length=500, verbose_name=&#x27;访问地址&#x27;)</span><br><span class="line">    index = models.IntegerField(default=100, verbose_name=&#x27;顺序&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;轮播图&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="课程model设计"><a href="#课程model设计" class="headerlink" title="课程model设计"></a>课程model设计</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Course -- 课程基本信息</span><br><span class="line">Lesson -- 章节信息</span><br><span class="line">Video -- 视频</span><br><span class="line">CourseResource -- 课程资源</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>一共有上述四张表</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line"># Create your models here.</span><br><span class="line">class Course(models.Model):</span><br><span class="line">    name = models.CharField(max_length=50, verbose_name=&#x27;课程名称&#x27;)</span><br><span class="line">    desc = models.CharField(max_length=300, verbose_name=&#x27;课程描述&#x27;)</span><br><span class="line">    detail = models.TextField(verbose_name=&#x27;课程详情&#x27;)</span><br><span class="line">    degree = models.CharField(choices=((&#x27;cj&#x27;,&#x27;初级&#x27;),(&#x27;zj&#x27;,&#x27;中级&#x27;),(&#x27;gj&#x27;,&#x27;高级&#x27;)),verbose_name=&#x27;课程难度&#x27;,max_length=2)</span><br><span class="line">    learn_time = models.IntegerField(default=0, verbose_name=&#x27;学习时长(分钟数)&#x27;)</span><br><span class="line">    students = models.IntegerField(default=0, verbose_name=&#x27;学习人数&#x27;)</span><br><span class="line">    fav = models.IntegerField(default=0, verbose_name=&#x27;收藏人数&#x27;)</span><br><span class="line">    image = models.ImageField(upload_to=&#x27;courses/%Y/%m&#x27;, verbose_name=&#x27;封面图&#x27;, max_length=100)</span><br><span class="line">    click_num = models.IntegerField(default=0, verbose_name=&#x27;点击数&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name=&#x27;课程&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class Lesson(models.Model):</span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=&#x27;课程&#x27;)</span><br><span class="line">    name = models.CharField(max_length=100, verbose_name=&#x27;章节名&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;章节&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class Video(models.Model):</span><br><span class="line">    lesson = models.ForeignKey(Lesson, verbose_name=&#x27;章节&#x27;)</span><br><span class="line">    name = models.CharField(max_length=100, verbose_name=&#x27;视频名&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;视频&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class CourseResource(models.Model):</span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=&#x27;课程&#x27;)</span><br><span class="line">    download = models.FileField(upload_to=&#x27;courses/resource/%Y/%m&#x27;,max_length=100)</span><br><span class="line">    name = models.CharField(max_length=100, verbose_name=&#x27;资源名称&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(default=datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;课程资源&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="添加organization的model"><a href="#添加organization的model" class="headerlink" title="添加organization的model"></a>添加organization的model</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CourseOrg -- 课程机构基本信息</span><br><span class="line">Teacher -- 教师基本信息</span><br><span class="line">CityDict -- 城市信息</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line">from datetime import datetime</span><br><span class="line"></span><br><span class="line"># Create your models here.</span><br><span class="line"></span><br><span class="line">class CourseOrg(models.Model):</span><br><span class="line">    city = models.ForeignKey(CityDict,verbose_name=&#x27;所在城市&#x27;)</span><br><span class="line">    name = models.CharField(max_length=50,verbose_name=&#x27;机构名称&#x27;)</span><br><span class="line">    desc = models.TextField(verbose_name=&#x27;机构描述&#x27;)</span><br><span class="line">    click_nums = models.IntegerField(default=0, verbose_name=&#x27;点击数&#x27;)</span><br><span class="line">    fav_nums =  models.IntegerField(default=0, verbose_name=&#x27;收藏数&#x27;)</span><br><span class="line">    image = models.ImageField(upload_to=&#x27;org/%Y/%m&#x27;,verbose_name=&#x27;封面图&#x27;)</span><br><span class="line">    address = models.CharField(max_length=150,verbose_name=&#x27;地址&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;课程机构&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class CityDict(models.Model):</span><br><span class="line">    name = models.CharField(max_length=20,verbose_name=&#x27;城市&#x27;)</span><br><span class="line">    desc = models.CharField(max_length=200, verbose_name=&#x27;描述&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;城市&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class Teacher(models.Model):</span><br><span class="line">    org = models.ForeignKey(CourseOrg, verbose_name=&#x27;所属机构&#x27;)</span><br><span class="line">    name = models.CharField(max_length=20,verbose_name=&#x27;教师名&#x27;)</span><br><span class="line">    work_years = models.IntegerField(default=0, verbose_name=&#x27;工作年限&#x27;)</span><br><span class="line">    work_company = models.CharField(max_length=50,verbose_name=&#x27;就职公司&#x27;)</span><br><span class="line">    work_position = models.CharField(max_length=50,verbose_name=&#x27;公司职位&#x27;)</span><br><span class="line">    points = models.CharField(max_length=50, verbose_name=&#x27;教学特点&#x27;)</span><br><span class="line">    click_nums = models.IntegerField(default=0, verbose_name=&#x27;点击数&#x27;)</span><br><span class="line">    fav_nums =  models.IntegerField(default=0, verbose_name=&#x27;收藏数&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;教师&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="添加operation的model"><a href="#添加operation的model" class="headerlink" title="添加operation的model"></a>添加operation的model</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UserAsk -- 用户咨询</span><br><span class="line">CourseComments -- 用户评论</span><br><span class="line">UserFavorite -- 用户收藏</span><br><span class="line">UserMessage -- 用户消息</span><br><span class="line">UserCourse -- 用户学习的课程</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>添加如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.db import models</span><br><span class="line">from datetime import datetime</span><br><span class="line">from users.models import UserProfile</span><br><span class="line">from courses.models import Course</span><br><span class="line">from organization.models import CourseOrg</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># Create your models here.</span><br><span class="line">class UserAsk(models.Model):</span><br><span class="line">    name = models.CharField(max_length=20,verbose_name=&#x27;姓名&#x27;)</span><br><span class="line">    mobile = models.CharField(max_length=11, verbose_name=&#x27;手机&#x27;)</span><br><span class="line">    course_name = models.CharField(max_length=50,verbose_name=&#x27;课程名称&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;用户咨询&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class CourseComments(models.Model):</span><br><span class="line">    user = models.ForeignKey(UserProfile, verbose_name=&#x27;用户&#x27;)</span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=&#x27;课程&#x27;)</span><br><span class="line">    comments = models.CharField(max_length=500,verbose_name=&#x27;评论&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;课程评论&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class UserFavorite(models.Model):</span><br><span class="line">    user = models.ForeignKey(UserProfile, verbose_name=&#x27;用户&#x27;)</span><br><span class="line">    fav_id = models.IntegerField(default=0, verbose_name=&#x27;数据id&#x27;)</span><br><span class="line">    fav_type = models.IntegerField(choices=((1,&#x27;课程&#x27;),(2,&#x27;课程机构&#x27;),(3,&#x27;讲师&#x27;)),default=1,verbose_name=&#x27;收藏类型&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;用户收藏&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class UserMessage(models.Model):</span><br><span class="line">    user = models.IntegerField(default=0,verbose_name=&#x27;接收用户&#x27;)# 不用外键，因为有可能是发给所有人的消息，用0表示发送给所有人的消息,用int表示用户的id</span><br><span class="line">    message = models.CharField(max_length=500, verbose_name=&#x27;消息内容&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    has_read = models.BooleanField(default=False,verbose_name=&#x27;是否已读&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;用户消息&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br><span class="line">class UserCourse(models.Model):</span><br><span class="line">    user = models.ForeignKey(UserProfile, verbose_name=&#x27;用户&#x27;)</span><br><span class="line">    course = models.ForeignKey(Course, verbose_name=&#x27;课程&#x27;)</span><br><span class="line">    add_time = models.DateTimeField(datetime.now, verbose_name=&#x27;添加时间&#x27;)</span><br><span class="line">    class Meta:</span><br><span class="line">        verbose_name = &#x27;用户课程&#x27;</span><br><span class="line">        verbose_name_plural = verbose_name</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="将所有app放到同一个文件夹下面"><a href="#将所有app放到同一个文件夹下面" class="headerlink" title="将所有app放到同一个文件夹下面"></a>将所有app放到同一个文件夹下面</h3><p>建立new python package， 把所有的app放到apps这个包下面，注意选择不改相对引用，并mark apps为source root</p>
<p>将apps这个文件夹加入到settings当中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">sys.path.insert(0, os.path.join(BASE_DIR,&#x27;apps&#x27;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="建立后台管理系统"><a href="#建立后台管理系统" class="headerlink" title="建立后台管理系统"></a>建立后台管理系统</h3><p>直接在run <a href="http://manage.py/">manage.py</a> task中输入<code>createsuperuser</code>，输入用户名，邮箱和密码就可以登录</p>
<p>更改语言和时区：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LANGUAGE_CODE = &#x27;zh-hans&#x27;  #将语言改为中文</span><br><span class="line">TIME_ZONE = &#x27;Asia/Shanghai&#x27; #将时区改为上海</span><br><span class="line">USE_TZ = False # 系统使用本地时间而不是utc时间</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因为我们更改了admin的auth.user的model，因此需要注册user的model，在<code>users</code>库中的admin.py文件中注册：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from users.models import UserProfile</span><br><span class="line"># Register your models here.</span><br><span class="line"></span><br><span class="line">class UserProfileAdmin(admin.ModelAdmin):  #userprofile的管理器</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">admin.site.register(UserProfile,UserProfileAdmin) #admin和model的关联注册</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>登录<code>http://127.0.0.1:8000/admin</code>就可以对用户进行修改</p>
<ul>
<li>pycharm全局搜索的快捷键是<code>ctrl+shift+f</code></li>
</ul>
<h3 id="使用xadmin"><a href="#使用xadmin" class="headerlink" title="使用xadmin"></a>使用xadmin</h3><p>使用xadmin，因为我安装的Django 2.0.1版本，所以需要安装专门的xadmin for Django2.0</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install git+git://github.com/sshwsfc/xadmin.git@django2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在url.py中引入xadmin</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import xadmin</span><br><span class="line">urlpatterns = [url(r&#x27;^xadmin/&#x27;, xadmin.site.urls),]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在settings.py中注册xadmin和crispy_forms:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    &#x27;django.contrib.admin&#x27;,</span><br><span class="line">.......</span><br><span class="line">    &#x27;xadmin&#x27;,</span><br><span class="line">    &#x27;crispy_forms&#x27;,</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来同步xadmin的表：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&gt; makemigrations</span><br><span class="line">&gt; migragate</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>再打开<a href="http://127.0.0.1:8000/xadmin%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AExadmin%E7%9A%84%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E4%BA%86">http://127.0.0.1:8000/xadmin就可以访问xadmin的后台管理了</a></p>
<p>在管理用户信息的时候，会出现错误，这是由于我们用的Django是2.0.1版本，而教程中用到的是1.0+，根据pycharm报错的最后一条，打开widget.py文件，在74行修改如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">input_html = [ht for ht in super(AdminSplitDateTime, self).render(name, value, attrs).split(&#x27;/&gt;&lt;&#x27;) if ht != &#x27;&#x27;]</span><br><span class="line">if (len(input_html) &gt; 1):</span><br><span class="line">	input_html[0] = input_html[0] + &quot;/&gt;&quot;</span><br><span class="line">	input_html[1] = &quot;&lt;&quot; + input_html[1]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="通过源码安装xadmin"><a href="#通过源码安装xadmin" class="headerlink" title="通过源码安装xadmin"></a>通过源码安装xadmin</h4><p>在mxonline下建立一个python package文件夹extra_apps，下载xadmin并解压，拷贝其中的xadmin文件夹到其中，并把extra_apps mark as source root，这样引入xadmin的时候就会从相对文件引入</p>
<p>同时在settings.py中把xadmin文件夹加入根搜索路径</p>
<h4 id="注册邮箱验证码model"><a href="#注册邮箱验证码model" class="headerlink" title="注册邮箱验证码model"></a>注册邮箱验证码model</h4><p>注册方法类似于admin的注册方式，只不过不是在admin.py中注册，<a href="http://而是要新建adminx.py/">而是要新建adminx.py</a>，并且admin继承的是object</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import xadmin</span><br><span class="line">from users.models import EmailVerifyRecord</span><br><span class="line"></span><br><span class="line">class EmailVerifyRecordAdmin(object):</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xadmin.site.register(EmailVerifyRecord, EmailVerifyRecordAdmin)  # 注册方法</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改显示的邮件验证码存储记录的str名称：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class EmailVerifyRecord(models.Model):</span><br><span class="line">    code = models.CharField(max_length=20, verbose_name=&#x27;验证码&#x27;)</span><br><span class="line">    email = models.EmailField(max_length=50, verbose_name= &#x27;邮箱&#x27;)</span><br><span class="line">.......</span><br><span class="line">    def __str__(self):</span><br><span class="line">        return &#x27;&#123;0&#125;(&#123;1&#125;)&#x27;.format(self.code,self.email)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>注意：所有注册的Model名字都应该为<code>class Model名+Admin</code></li>
</ul>
<h4 id="添加搜索和显示列"><a href="#添加搜索和显示列" class="headerlink" title="添加搜索和显示列"></a>添加搜索和显示列</h4><p>在其中加入list_display（显示列）, search_fields（搜索域）, list_filter（过滤器）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class LessonAdmin(object):</span><br><span class="line">    list_display = [&#x27;course&#x27;,&#x27;name&#x27;,&#x27;add_time&#x27;]</span><br><span class="line">    search_fields = [&#x27;course&#x27;,&#x27;name&#x27;,&#x27;add_time&#x27;]</span><br><span class="line">    list_filter = [&#x27;course&#x27;,&#x27;name&#x27;,&#x27;add_time&#x27;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果要使用外键进行搜索，可以用两个下划线表示</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class LessonAdmin(object):</span><br><span class="line">    list_filter = [&#x27;course__name&#x27;,&#x27;name&#x27;,&#x27;add_time&#x27;]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="xadmin全局配置"><a href="#xadmin全局配置" class="headerlink" title="xadmin全局配置"></a>xadmin全局配置</h3><p>将全站的配置放在user app的admix.py中，新建一个class BaseSetting，用于配置主题</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from xadmin import views</span><br><span class="line"></span><br><span class="line">class BaseSettings:</span><br><span class="line">    enable_themes = True   #允许使用主题</span><br><span class="line">    use_bootswatch = True	#允许多主题</span><br><span class="line">xadmin.site.register(views.BaseAdminView,BaseSettings)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>建立一个class GlobalSettings配置标题名称和footer名称</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class GlobalSettings:</span><br><span class="line">    site_title = &#x27;慕学后台管理系统&#x27;</span><br><span class="line">    site_footer = &#x27;慕学在线网&#x27;</span><br><span class="line">    menu_style = &#x27;accordion&#x27; #折叠model</span><br><span class="line">xadmin.site.register(views.CommAdminView,GlobalSettings)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="更改model名称"><a href="#更改model名称" class="headerlink" title="更改model名称"></a>更改model名称</h4><p>在每个model文件夹中的apps.py文件中加入verbose_name</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.apps import AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class CoursesConfig(AppConfig):</span><br><span class="line">    name = &#x27;courses&#x27;</span><br><span class="line">    verbose_name = &#x27;课程&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在<code>__init__.py</code> 中加入default_app_config</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">default_app_config = &#x27;courses.apps.CoursesConfig&#x27;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="完成用户的登录功能"><a href="#完成用户的登录功能" class="headerlink" title="完成用户的登录功能"></a>完成用户的登录功能</h3><p>首先将前端给的Index.html（首页）文件和login.html（登录页）文件放入templates文件夹中</p>
<p>在根目录下建立static文件夹，存放css，images，js，media文件，并在settings.py中声明<code>STATICFILES_DIRS=[os.path.join(BASE_DIR,&#39;static&#39;)]</code>，注意：这里的STATICFILES_DIRS必须设置为list或者tuple形式，否则会报错</p>
<p>此时，将html文件中的所有css，js的文件路径修改为<code>/static/css</code>和<code>/static/js</code></p>
<p>接下来配置url，在url.py中引入TemplateView</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.views.generic import TemplateView</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(r&#x27;^xadmin/&#x27;, xadmin.site.urls),</span><br><span class="line">    url(r&#x27;^$&#x27;,TemplateView.as_view(template_name=&#x27;index.html&#x27;),name=&#x27;index&#x27;),</span><br><span class="line">    url(r&#x27;^login/&#x27;, TemplateView.as_view(template_name=&#x27;login.html&#x27;), name=&#x27;login&#x27;)</span><br><span class="line"></span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样就完成了页面配置，重启项目后就可以访问首页和登录页面</p>
<h4 id="实现使用用户名或者邮箱都可以登录"><a href="#实现使用用户名或者邮箱都可以登录" class="headerlink" title="实现使用用户名或者邮箱都可以登录"></a>实现使用用户名或者邮箱都可以登录</h4><p>现在users模块中新建CustomBackend类，继承ModelBackend，重写其中的authenticate函数，用Q函数实现或操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.contrib.auth.backends import ModelBackend</span><br><span class="line">from django.db.models import Q</span><br><span class="line">class CustomBackend(ModelBackend):</span><br><span class="line">    def authenticate(self, request, username=None, password=None, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            user = UserProfile.objects.get(Q(username=username)|Q(email=username))</span><br><span class="line">            if user.check_password(password):</span><br><span class="line">                return user</span><br><span class="line">        except Exception as e:</span><br><span class="line">            return None</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写自己的login函数login，并将其写到urls.py中</p>
<p><a href="http://views.py/">views.py</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def my_login(request):</span><br><span class="line">    if request.method == &#x27;POST&#x27;:</span><br><span class="line">        user_name = request.POST.get(&#x27;username&#x27;,&#x27;&#x27;)</span><br><span class="line">        pass_word = request.POST.get(&#x27;password&#x27;,&#x27;&#x27;)</span><br><span class="line">        user = authenticate(username=user_name,password=pass_word)</span><br><span class="line">        if user:</span><br><span class="line">            login(request, user)</span><br><span class="line">            return render(request, &#x27;index.html&#x27;,&#123;&#x27;userprofile&#x27;:user&#125;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request,&#x27;login.html&#x27;,&#123;&#x27;msg&#x27;:&#x27;用户名或密码错误&#x27;&#125;)</span><br><span class="line">    elif request.method == &#x27;GET&#x27;:</span><br><span class="line">        return render(request, &#x27;login.html&#x27;, &#123;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="http://urls.py/">urls.py</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url(r&#x27;^login/&#x27;, my_login, name=&#x27;login&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在settings.py中加入<code>AUTHENTICATION_BACKENDS=（&#39;users.views.CustomBackend&#39;,）</code>，将认证后台改为自己写的后台</p>
<p>在点击登陆后，我们需要跳转回首页或者是报告密码错误，此时request被传递到网页中，可以在跳转后显示自己的用户名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dd&gt;&#123; &#123; request.POST.username &#125; &#125;&lt;img class=&quot;down fr&quot; src=&quot;/static/images/top_down.png&quot;/&gt;&lt;/dd&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="将用户登录改成类的方法"><a href="#将用户登录改成类的方法" class="headerlink" title="将用户登录改成类的方法"></a>将用户登录改成类的方法</h4><p>views.py中加入自己的类：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django.views.generic import View</span><br><span class="line">class LoginView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &#x27;login.html&#x27;, &#123;&#125;)</span><br><span class="line">    def post(self, request):</span><br><span class="line">        user_name = request.POST.get(&#x27;username&#x27;,&#x27;&#x27;)</span><br><span class="line">        pass_word = request.POST.get(&#x27;password&#x27;,&#x27;&#x27;)</span><br><span class="line">        user = authenticate(username=user_name,password=pass_word)</span><br><span class="line">        if user:</span><br><span class="line">            login(request, user)</span><br><span class="line">            return render(request, &#x27;index.html&#x27;,&#123;&#x27;userprofile&#x27;:user&#125;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request,&#x27;login.html&#x27;,&#123;&#x27;msg&#x27;:&#x27;用户名或密码错误&#x27;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在urls.py中将loginview注册：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url(r&#x27;^login/&#x27;, LoginView.as_view(), name=&#x27;login&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="实现用户名和密码的长度和空检验"><a href="#实现用户名和密码的长度和空检验" class="headerlink" title="实现用户名和密码的长度和空检验"></a>实现用户名和密码的长度和空检验</h4><p>在users模块汇总建立forms.py用于检验表单</p>
<p><a href="http://forms.py/">forms.py</a></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django import forms</span><br><span class="line"></span><br><span class="line">class LoginForm(forms.Form):</span><br><span class="line">    username = forms.CharField(required=True)</span><br><span class="line">    password = forms.CharField(required=True, min_length=5)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在views.py中加入loginform的验证，逻辑是如果有效，则提取表单中的username和password，验证成功后，用login函数登录，返回index页面；如果验证失败，返回登录页显示用户或密码错误；如果检测到form有错误，返回登录页，显示错误类型</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class LoginView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &#x27;login.html&#x27;, &#123;&#125;)</span><br><span class="line">    def post(self, request):</span><br><span class="line">        login_form = LoginForm(request.POST)    #实例化一个login_form，传入参数为request.POST,自动验证其中的username和password，注意这里名字必须和login.html的form当中的name相同</span><br><span class="line">        if login_form.is_valid():  #这一步之后可以看到login_form的error类型，存为一个dict类型</span><br><span class="line">            user_name = request.POST.get(&#x27;username&#x27;,&#x27;&#x27;)</span><br><span class="line">            pass_word = request.POST.get(&#x27;password&#x27;,&#x27;&#x27;)</span><br><span class="line">            user = authenticate(username=user_name,password=pass_word)</span><br><span class="line">            if user:</span><br><span class="line">                login(request, user)</span><br><span class="line">                return render(request, &#x27;index.html&#x27;,&#123;&#x27;userprofile&#x27;:user&#125;)</span><br><span class="line">            else:</span><br><span class="line">                return render(request,&#x27;login.html&#x27;,&#123;&#x27;msg&#x27;:&#x27;用户名或密码错误&#x27;&#125;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request,&#x27;login.html&#x27;,&#123;&#x27;login_form&#x27;:login_form&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在login.html中显示错误类型：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div class=&quot;error btns login-form-tips&quot; id=&quot;jsLoginTips&quot;&gt;&#123; % for key, error in login_form.errors.items % &#125;</span><br><span class="line">&#123; &#123; error &#125; &#125;&#123; % endfor % &#125;&#123; &#123; msg &#125; &#125;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="使用cookies进行登录"><a href="#使用cookies进行登录" class="headerlink" title="使用cookies进行登录"></a>使用cookies进行登录</h2><p>http本身是一种无状态协议，每次发送请求，服务器返回请求的数据，如果要记住登录状态就需要cookies <img src="https://images2018.cnblogs.com/blog/1343961/201803/1343961-20180307112659303-1858050305.png" alt="img"> django的cookie由session_key和session_data以及expire_data组成，实现是通过setings.py中的’django.contrib.sessions’, 每个域名之下的cookies是不能互相访问的 <img src="https://images2018.cnblogs.com/blog/1343961/201803/1343961-20180307140134115-22522149.png" alt="img"></p>
<h3 id="实现user的注册功能"><a href="#实现user的注册功能" class="headerlink" title="实现user的注册功能"></a>实现user的注册功能</h3><p>先拷贝register.html到template中，配置url，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url(r&#x27;^register/&#x27;,RegisterView.as_view,name=&#x27;register&#x27;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在<code>views.py</code>中加入RegisterView类</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class RegisterView(View):</span><br><span class="line">    def get(self, request):</span><br><span class="line">        return render(request, &#x27;register.html&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在HTML代码中修改指向</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;a style=&quot;color:white&quot; class=&quot;fr registerbtn&quot; href=&quot;&#123; % url &#x27;register&#x27; % &#125;&quot;&gt;注册&lt;/a&gt;</span><br><span class="line">&lt;a style=&quot;color:white&quot; class=&quot;fr loginbtn&quot; href=&quot;&#123; % url &#x27;login&#x27; % &#125;&quot;&gt;登录&lt;/a&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改其css和js文件的地址，这里介绍第二种修改的方法 首先在html文件中输入<code>&#123; %load staticfiles% &#125;</code> 然后在需要修改地址的地方输入<code>&#123; %static &#39;/css/reset.css&#39;% &#125;</code></p>
<h3 id="加入验证码功能"><a href="#加入验证码功能" class="headerlink" title="加入验证码功能"></a>加入验证码功能</h3><ul>
<li>先安装django-simple-captcha模块</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install  django-simple-captcha</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>根据官方文档的提示添加captcha到settings.py当中的INSTALLED_APPS</li>
<li>运行makemigrations,migrate</li>
<li>添加实例到urls.py中</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">urlpatterns += [</span><br><span class="line">    url(r&#x27;^captcha/&#x27;, include(&#x27;captcha.urls&#x27;)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后在forms.py中加入一个新的register_form，在其中加入captchafiled</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from django import forms</span><br><span class="line">from captcha.fields import CaptchaField</span><br><span class="line"></span><br><span class="line">class RegisterForm(forms.Form):</span><br><span class="line">    email = forms.EmailField(required=True,error_messages=&#123;&#x27;invalid&#x27;:&#x27;请输入一个有效的邮箱地址&#x27;&#125;)</span><br><span class="line">    password = forms.CharField(required=True,min_length=5,error_messages=&#123;&#x27;invalid&#x27;:&#x27;密码至少6个字符&#x27;,&#x27;required&#x27;:&#x27;请输入密码&#x27;&#125;)</span><br><span class="line">    captcha = CaptchaField(error_messages=&#123;&#x27;required&#x27;: &#x27;验证码错误&#x27;&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在<code>view.py</code>中加入registerview</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class RegisterView(View):</span><br><span class="line">#get方法，先实例化一个RegisterForm，将register_form返回到html中用于获取验证码</span><br><span class="line">    def get(self, request): </span><br><span class="line">        register_form = RegisterForm()</span><br><span class="line">        return render(request, &#x27;register.html&#x27;,&#123;&#x27;register_form&#x27;:register_form&#125;)</span><br><span class="line"></span><br><span class="line">    def post(self, request):</span><br><span class="line">        register_form = RegisterForm(request.POST)</span><br><span class="line">        if register_form.is_valid():</span><br><span class="line">            user_name = request.POST.get(&#x27;email&#x27;, &#x27;&#x27;)</span><br><span class="line">            pass_word = request.POST.get(&#x27;password&#x27;, &#x27;&#x27;)</span><br><span class="line">            is_used = UserProfile.objects.filter(username=user_name)</span><br><span class="line">            if not is_used:</span><br><span class="line">                user = UserProfile()</span><br><span class="line">                user.username = user_name</span><br><span class="line">                user.email = user_name</span><br><span class="line">                user.password = make_password(pass_word)</span><br><span class="line">                user.save()</span><br><span class="line">                send_register_email(user_name)</span><br><span class="line">                return render(request, &#x27;login.html&#x27;,&#123;&#125;)</span><br><span class="line">            else:</span><br><span class="line">                return render(request, &#x27;register.html&#x27;, &#123;&#x27;msg&#x27;:&#x27;该用户名已经被占用&#x27;,&#x27;register_form&#x27;:register_form&#125;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &#x27;register.html&#x27;,&#123;&#x27;register_form&#x27;:register_form&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修改<code>register.html</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;div class=&quot;tab-form&quot;&gt;</span><br><span class="line">&lt;!--其中的action用于指定提交到哪个页面--&gt;</span><br><span class="line">    &lt;form id=&quot;email_register_form&quot; method=&quot;post&quot; action=&quot;&#123; % url &#x27;register&#x27; % &#125;&quot; autocomplete=&quot;off&quot;&gt;</span><br><span class="line">        &lt;input type=&#x27;hidden&#x27; name=&#x27;csrfmiddlewaretoken&#x27; value=&#x27;gTZljXgnpvxn0fKZ1XkWrM1PrCGSjiCZ&#x27;/&gt;</span><br><span class="line">&lt;!--在class里面加入&#123; %if register_form.email.errors % &#125;errorput用于出错时高亮--&gt;</span><br><span class="line">        &lt;div class=&quot;form-group marb20 &#123; % if register_form.email.errors % &#125;errorput&#123; % endif % &#125;&quot;&gt;</span><br><span class="line">            &lt;label&gt;邮&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;箱&lt;/label&gt;</span><br><span class="line">&lt;!--将value填为上次填写的value，这样出错时不用用户每次手动填写value--&gt;</span><br><span class="line">            &lt;input type=&quot;text&quot; id=&quot;id_email&quot; name=&quot;email&quot; value=&quot;&#123; &#123; register_form.email.value &#125; &#125;&quot;</span><br><span class="line">                   placeholder=&quot;请输入您的邮箱地址&quot;/&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;form-group marb8 &#123; % if register_form.errors.password % &#125;errorput&#123; % endif % &#125;&quot;&gt;</span><br><span class="line">            &lt;label&gt;密&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;码&lt;/label&gt;</span><br><span class="line">            &lt;input type=&quot;password&quot; id=&quot;id_password&quot; name=&quot;password&quot;</span><br><span class="line">                   value=&quot;&#123; &#123; register_form.password.value &#125; &#125;&quot;</span><br><span class="line">                   placeholder=&quot;请输入6-20位非中文字符密码&quot;/&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;form-group marb8 captcha1 &#123; % if register_form.errors.password % &#125;errorput&#123; % endif % &#125;&quot;&gt;</span><br><span class="line">            &lt;label&gt;验&amp;nbsp;证&amp;nbsp;码&lt;/label&gt;</span><br><span class="line">            &#123; &#123; register_form.captcha &#125; &#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;error btns&quot; id=&quot;jsEmailTips&quot;&gt;</span><br><span class="line">        &lt;!--用循环的方式将错误显示出来--&gt;</span><br><span class="line">            &#123; % for key,value in register_form.errors.items % &#125;</span><br><span class="line">                &#123; &#123; value &#125; &#125;</span><br><span class="line">            &#123; % endfor % &#125;</span><br><span class="line">            &#123; &#123; msg &#125; &#125;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;auto-box marb8&quot;&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;input class=&quot;btn btn-green&quot; id=&quot;jsEmailRegBtn&quot; type=&quot;submit&quot; value=&quot;注册并登录&quot;/&gt;</span><br><span class="line">        &#123;#                        &lt;input type=&#x27;hidden&#x27; name=&#x27;csrfmiddlewaretoken&#x27; value=&#x27;5I2SlleZJOMUX9QbwYLUIAOshdrdpRcy&#x27;/&gt;#&#125;</span><br><span class="line">        &#123; % csrf_token % &#125;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="处理用户激活"><a href="#处理用户激活" class="headerlink" title="处理用户激活"></a>处理用户激活</h2><p>在urls.py中插入需要激活的页面，用<code>(?P&lt;active_code&gt;.*?)/$</code>，<code>?P</code>是表示parameter的意思，active_code表示你需要提取的变量，后面的<code>.*?</code>表示正则表达式</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url(r&#x27;^active/(?P&lt;active_code&gt;.*?)/$&#x27;,ActiveUserView.as_view()),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在view中加入新的ActiveUserView,在get中可以拿到刚才在urls.py中定义的active_code参数，先判断这个值在我的数据库中是否存在</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class ActiveUserView(View):</span><br><span class="line">    def get(self, request, active_code):</span><br><span class="line">    #判断这个值在我的数据库中是否存在</span><br><span class="line">        all_records = EmailVerifyRecord.objects.filter(code=active_code)</span><br><span class="line">        #如果存在，通过active_code对应的email找到用户，并将其is_active改为True</span><br><span class="line">        if all_records:</span><br><span class="line">            for record in all_records:</span><br><span class="line">                email = record.email</span><br><span class="line">                user = UserProfile.objects.get(email=email)</span><br><span class="line">                user.is_active = True</span><br><span class="line">                user.save()</span><br><span class="line">            return render(request, &#x27;login.html&#x27;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在LoginView中加入是否激活的判断</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def post(self, request):</span><br><span class="line">    login_form = LoginForm(request.POST)</span><br><span class="line">    if login_form.is_valid():</span><br><span class="line">        user_name = request.POST.get(&#x27;username&#x27;,&#x27;&#x27;)</span><br><span class="line">        pass_word = request.POST.get(&#x27;password&#x27;,&#x27;&#x27;)</span><br><span class="line">        user = authenticate(username=user_name,password=pass_word)</span><br><span class="line">        if user:</span><br><span class="line">        #</span><br><span class="line">            if user.is_active:</span><br><span class="line">                login(request, user)</span><br><span class="line">                return render(request, &#x27;index.html&#x27;,&#123;&#x27;userprofile&#x27;:user&#125;)</span><br><span class="line">            else:</span><br><span class="line">                return render(request, &#x27;login.html&#x27;, &#123;&#x27;msg&#x27;: &#x27;用户未激活&#x27;&#125;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request,&#x27;login.html&#x27;,&#123;&#x27;msg&#x27;:&#x27;用户名或密码错误&#x27;&#125;)</span><br><span class="line">    else:</span><br><span class="line">        return render(request,&#x27;login.html&#x27;,&#123;&#x27;login_form&#x27;:login_form&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="处理忘记密码"><a href="#处理忘记密码" class="headerlink" title="处理忘记密码"></a>处理忘记密码</h2><p>在urls.py中加入新的页面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">url(r&#x27;^reset/(?P&lt;reset_code&gt;.*?)/$&#x27;, ResetView.as_view(), name=&#x27;reset_pwd&#x27;),</span><br><span class="line">url(r&#x27;^modify_pwd/&#x27;, ModifyPwdView.as_view(), name=&#x27;modifypwd&#x27;),</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在views.py中加入新的view</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class ResetView(View):</span><br><span class="line">    def get(self, request, reset_code):</span><br><span class="line">        all_records = EmailVerifyRecord.objects.filter(code=reset_code)</span><br><span class="line">        if all_records:</span><br><span class="line">            for record in all_records:</span><br><span class="line">                email = record.email</span><br><span class="line">                user = UserProfile.objects.get(email=email)</span><br><span class="line">                return render(request, &#x27;password_reset.html&#x27;,&#123;&#x27;email&#x27;:email&#125;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &#x27;active_fail.html&#x27;)</span><br><span class="line"></span><br><span class="line">class ModifyPwdView(View):</span><br><span class="line">    def post(self, request):</span><br><span class="line">        reset_form = ResetPwdForm(request.POST)</span><br><span class="line">        if reset_form.is_valid():</span><br><span class="line">            pw1 = request.POST.get(&#x27;password1&#x27;,&#x27;&#x27;)</span><br><span class="line">            pw2 = request.POST.get(&#x27;password2&#x27;,&#x27;&#x27;)</span><br><span class="line">            email = request.POST.get(&#x27;email&#x27;, &#x27;&#x27;)</span><br><span class="line">            if pw1 != pw2:</span><br><span class="line">                return render(request,&#x27;password_reset.html&#x27;,&#123;&#x27;msg&#x27;:&quot;两次密码不一致&quot;&#125;)</span><br><span class="line">            else:</span><br><span class="line">                user = UserProfile.objects.get(email=request.POST.email)</span><br><span class="line">                user.password = make_password(pw1)</span><br><span class="line">                user.save()</span><br><span class="line">                return render(request, &#x27;login.html&#x27;)</span><br><span class="line">        else:</span><br><span class="line">            return render(request, &#x27;password_reset.html&#x27;, &#123;&#x27;reset_form&#x27;:reset_form,&#x27;email&#x27;:request.POST.email&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在forms.py中加入<code>ResetPwdForm</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">class ResetPwdForm(forms.Form):</span><br><span class="line">    password1 = forms.CharField(required=True)</span><br><span class="line">    password2 = forms.CharField(required=True)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在template中加入<code>password_reset.html</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!--修改action为modifypwd--&gt;</span><br><span class="line">&lt;form id=&quot;reset_password_form&quot; action=&quot;&#123; % url &#x27;modifypwd&#x27; % &#125;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">&lt;!--两次密码的name分别为password1和password2--&gt;</span><br><span class="line">            &lt;span class=&quot;&quot;&gt;新 密 码 ：&lt;/span&gt;</span><br><span class="line">            &lt;input type=&quot;password&quot; name=&quot;password1&quot; id=&quot;pwd&quot; placeholder=&quot;6-20位非中文字符&quot;&gt;</span><br><span class="line">            &lt;i&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">&lt;!--加入一个隐藏层用于传输email--&gt;</span><br><span class="line">        &lt;input type=&quot;hidden&quot; value=&quot;&#123; &#123; email &#125; &#125;&quot; name=&quot;&#x27;email&quot;&gt;</span><br><span class="line">        &lt;li&gt;</span><br><span class="line">            &lt;span class=&quot;&quot;&gt;确定密码：&lt;/span&gt;</span><br><span class="line">            &lt;input type=&quot;password&quot; name=&quot;password2&quot; id=&quot;repwd&quot; placeholder=&quot;6-20位非中文字符&quot;&gt;</span><br><span class="line">            &lt;i&gt;&lt;/i&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">        &lt;li class=&quot;button&quot;&gt;</span><br><span class="line">            &lt;input type=&quot;button&quot; value=&quot;提交&quot; onclick=&quot;reset_password_form_submit()&quot;&gt;</span><br><span class="line">        &lt;/li&gt;</span><br><span class="line">    &lt;/ul&gt;</span><br><span class="line">    &#123; % csrf_token % &#125;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>编程学习</category>
        <category>网页制作</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>网页</tag>
      </tags>
  </entry>
  <entry>
    <title>FRP反向代理软件的使用（转）</title>
    <url>/2018/05/31/FRP%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E8%BD%AF%E4%BB%B6%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>对于没有公网 <code>IP</code> 的内网用户来说，远程管理或在外网访问内网机器上的服务是一个问题。通常解决方案就是用内网穿透工具将内网的服务穿透到公网中，便于远程管理和在外部访问。内网穿透的工具很多，之前也介绍过 <a href="https://www.hi-linux.com/posts/29097.html">Ngrok</a>、<a href="https://www.hi-linux.com/posts/24471.html">Localtunnel</a>。</p>
<p>今天给大家介绍另一款好用内网穿透工具 <code>FRP</code>，<code>FRP</code> 全名：Fast Reverse Proxy。<code>FRP</code> 是一个使用 <code>Go</code> 语言开发的高性能的反向代理应用，可以帮助您轻松地进行内网穿透，对外网提供服务。<code>FRP</code> 支持 <code>TCP</code>、<code>UDP</code>、<code>HTTP</code>、<code>HTTPS</code>等协议类型，并且支持 <code>Web</code> 服务根据域名进行路由转发。</p>
<span id="more"></span>

<p>FRP 项目地址：<a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a></p>
<p><strong>FRP 的作用</strong></p>
<ul>
<li>利用处于内网或防火墙后的机器，对外网环境提供 <code>HTTP</code> 或 <code>HTTPS</code> 服务。</li>
<li>对于 <code>HTTP</code>, <code>HTTPS</code> 服务支持基于域名的虚拟主机，支持自定义域名绑定，使多个域名可以共用一个 80 端口。</li>
<li>利用处于内网或防火墙后的机器，对外网环境提供 <code>TCP</code> 和 <code>UDP</code> 服务，例如在家里通过 <code>SSH</code> 访问处于公司内网环境内的主机。</li>
</ul>
<p><strong>FRP 架构</strong></p>
<p><a href="https://www.hi-linux.com/img/linux/frp-architecture.png"><img src="https://www.hi-linux.com/img/linux/frp-architecture.png" alt="img"></a></p>
<h3 id="FRP-安装"><a href="#FRP-安装" class="headerlink" title="FRP 安装"></a>FRP 安装</h3><p><code>FRP</code> 采用 <code>Go</code> 语言开发，支持 <code>Windows</code>、<code>Linux</code>、<code>MacOS</code>、<code>ARM</code>等多平台部署。<code>FRP</code> 安装非常容易，只需下载对应系统平台的软件包，并解压就可用了。</p>
<p>这里以 <code>Linux</code> 为例，为了方便管理我们把解压后的目录重命名为 frp ：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ wget https://github.com/fatedier/frp/releases/download/v0.15.1/frp_0.15.1_linux_amd64.tar.gz</span><br><span class="line">$ tar xzvf frp_0.15.1_linux_amd64.tar.gz</span><br><span class="line">$ mv frp_0.15.1_linux_amd64 frp</span><br></pre></td></tr></table></figure>

<p>更多平台的软件包下载地址：<a href="https://github.com/fatedier/frp/releases">https://github.com/fatedier/frp/releases</a></p>
<h3 id="FRP-配置"><a href="#FRP-配置" class="headerlink" title="FRP 配置"></a>FRP 配置</h3><h4 id="FRP-服务端配置"><a href="#FRP-服务端配置" class="headerlink" title="FRP 服务端配置"></a>FRP 服务端配置</h4><p>配置 <code>FRP</code> 服务端的前提条件是需要一台具有公网 <code>IP</code> 的设备，得益于 <code>FRP</code> 是 <code>Go</code> 语言开发的，具有良好的跨平台特性。你可以在 <code>Windows</code>、<code>Linux</code>、<code>MacOS</code>、<code>ARM</code>等几乎任何可联网设备上部署。</p>
<p>这里以 <code>Linux</code> 为例，<code>FRP</code> 默认给出两个服务端配置文件，一个是简版的 frps.ini，另一个是完整版本 frps_full.ini。</p>
<p>我们先来看看简版的 frps.ini，通过这个配置可以快速的搭建起一个 FRP 服务端。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat frps.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>默认配置中监听的是 7000 端口，可根据自己实际情况修改。</li>
</ul>
</blockquote>
<p>启动 FRP 服务端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frps -c ./frps.ini</span><br><span class="line">2018/01/25 10:52:45 [I] [service.go:96] frps tcp listen on 0.0.0.0:7000</span><br><span class="line">2018/01/25 10:52:45 [I] [main.go:112] Start frps success</span><br><span class="line">2018/01/25 10:52:45 [I] [main.go:114] PrivilegeMode is enabled, you should pay more attention to security issues</span><br></pre></td></tr></table></figure>

<p>通过上面简单的两步就可以成功启动一个监听在 7000 端口的 <code>FRP</code> 服务端。</p>
<h4 id="FRP-客户端配置"><a href="#FRP-客户端配置" class="headerlink" title="FRP 客户端配置"></a>FRP 客户端配置</h4><p>和 FRP 服务端类似，<code>FRP</code> 默认也给出两个客户端配置文件，一个是简版的 frpc.ini，另一个是完整版本 frpc_full.ini。</p>
<p>这里同样以简版的 frpc.ini 文件为例，假设 FRP 服务端所在服务器的公网 <code>IP</code> 为 4.3.2.1。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line"># server_addr 为 FRP 服务端的公网 IP</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line"># server_port 为 FRP 服务端监听的端口</span><br><span class="line">server_port = 7000</span><br></pre></td></tr></table></figure>

<p>启动 FRP 客户端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line">2018/01/25 11:15:49 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/25 11:15:49 [I] [proxy_manager.go:294] proxy added: []</span><br><span class="line">2018/01/25 11:15:49 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/25 11:15:49 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 11:15:49 [I] [control.go:240] [83775d7388b8e7d9] login to server success, get run id [83775d7388b8e7d9], server udp port [0]</span><br></pre></td></tr></table></figure>

<p>这样就可以成功在 <code>FRP</code> 服务端上成功建立一个客户端连接，当然现在还并不能对外提供任何内网机器上的服务，因为我们并还没有在 <code>FRP</code> 服务端注册任何内网服务的端口。</p>
<h3 id="FRP-使用实例"><a href="#FRP-使用实例" class="headerlink" title="FRP 使用实例"></a>FRP 使用实例</h3><p>下面我们就来看几个常用的例子，通过这些例子来了解下 FRP 是如何实现内网服务穿透的。</p>
<h4 id="通过-TCP-访问内网机器"><a href="#通过-TCP-访问内网机器" class="headerlink" title="通过 TCP 访问内网机器"></a>通过 TCP 访问内网机器</h4><p>这里以访问 <code>SSH</code> 服务为例， 修改 FRP 客户端配置文件 frpc.ini 文件并增加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cat frpc.ini</span><br><span class="line"></span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 6000</span><br></pre></td></tr></table></figure>

<p>启动 FRP 客户端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line">2018/01/25 12:21:23 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/25 12:21:23 [I] [proxy_manager.go:294] proxy added: [ssh]</span><br><span class="line">2018/01/25 12:21:23 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/25 12:21:23 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 12:21:23 [I] [control.go:240] [3b468a55191341cb] login to server success, get run id [3b468a55191341cb], server udp port [0]</span><br><span class="line">2018/01/25 12:21:23 [I] [control.go:165] [3b468a55191341cb] [ssh] start proxy success</span><br></pre></td></tr></table></figure>

<p>这样就在 <code>FRP</code> 服务端上成功注册了一个端口为 6000 的服务，接下来我们就可以通过这个端口访问内网机器上 <code>SSH</code> 服务，假设用户名为 mike：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ssh -oPort=6000 mike@4.3.2.1</span><br></pre></td></tr></table></figure>

<h4 id="通过自定义域名访问部署于内网的-Web-服务"><a href="#通过自定义域名访问部署于内网的-Web-服务" class="headerlink" title="通过自定义域名访问部署于内网的 Web 服务"></a>通过自定义域名访问部署于内网的 Web 服务</h4><p>有时需要在公有网络通过域名访问我们在本地环境搭建的 <code>Web</code> 服务，但是由于本地环境机器并没有公网 <code>IP</code>，无法将域名直接解析到本地的机器。</p>
<p>现在通过 <code>FRP</code> 就可以很容易实现这一功能，这里以 <code>HTTP</code> 服务为例：首先修改 <code>FRP</code> 服务端配置文件，通过 <code>vhost_http_port</code> 参数来设置 <code>HTTP</code> 访问端口，这里将 <code>HTTP</code> 访问端口设为 80。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line">vhost_http_port = 80</span><br></pre></td></tr></table></figure>

<p>启动 FRP 服务端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frps -c ./frps.ini</span><br><span class="line">2018/01/25 13:33:26 [I] [service.go:96] frps tcp listen on 0.0.0.0:7000</span><br><span class="line">2018/01/25 13:33:26 [I] [service.go:125] http service listen on 0.0.0.0:80</span><br><span class="line">2018/01/25 13:33:26 [I] [main.go:112] Start frps success</span><br><span class="line">2018/01/25 13:33:26 [I] [main.go:114] PrivilegeMode is enabled, you should pay more attention to security issues</span><br></pre></td></tr></table></figure>

<p>其次我们在修改 <code>FRP</code> 客户端配置文件并增加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">type = http</span><br><span class="line">local_port = 80</span><br><span class="line">custom_domains = mike.hi-linux.com</span><br></pre></td></tr></table></figure>

<p>这里通过 <code>local_port</code> 和 <code>custom_domains</code> 参数来设置本地机器上 <code>Web</code> 服务对应的端口和自定义的域名，这里我们分别设置端口为 80，对应域名为 <code>mike.hi-linux.com</code>。</p>
<p>启动 FRP 客户端</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line">2018/01/25 13:56:11 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/25 13:56:11 [I] [proxy_manager.go:294] proxy added: [web ssh]</span><br><span class="line">2018/01/25 13:56:11 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/25 13:56:11 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 13:56:11 [I] [control.go:240] [296fe9e31a551e07] login to server success, get run id [296fe9e31a551e07], server udp port [0]</span><br><span class="line">2018/01/25 13:56:11 [I] [control.go:165] [296fe9e31a551e07] [web] start proxy success</span><br><span class="line">2018/01/25 13:56:11 [I] [control.go:165] [296fe9e31a551e07] [ssh] start proxy success</span><br></pre></td></tr></table></figure>

<p>最后将 <code>mike.hi-linux.com</code> 的域名 A 记录解析到 <code>FRP</code> 服务器的公网 <code>IP</code> 上，现在便可以通过 <code>http://mike.hi-linux.com:8080</code> 这个 <code>URL</code>访问到处于内网机器上对应的 <code>Web</code> 服务。</p>
<blockquote>
<ul>
<li><code>HTTPS</code> 服务配置方法类似，只需将 <code>vhost_http_port</code> 替换为 <code>vhost_https_port</code>， type 设置为 <code>https</code> 即可。</li>
</ul>
</blockquote>
<p>多个web应用的情况：</p>
<p>服务器端配置：<code>frps.ini</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line">vhost_http_port = 80</span><br><span class="line">privilege_token = xxxxxx</span><br><span class="line">subdomain_host = drawon.site</span><br></pre></td></tr></table></figure>

<p>客户端配置：<code>frpc.ini</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line">server_addr = 144.xxx.xxx.xxx</span><br><span class="line">server_port = 7000</span><br><span class="line">privilege_token = xxxxxx</span><br><span class="line"></span><br><span class="line">[ssh]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 6000</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line"><span class="built_in">type</span> = http</span><br><span class="line">local_port = 8891</span><br><span class="line">subdomain = dj</span><br><span class="line"></span><br><span class="line">[web1]</span><br><span class="line"><span class="built_in">type</span> = http</span><br><span class="line">local_port = 8890</span><br><span class="line">subdomain = jupyter</span><br><span class="line"></span><br><span class="line">[web2]</span><br><span class="line"><span class="built_in">type</span> = http</span><br><span class="line">local_port = 8892</span><br><span class="line">subdomain = data</span><br></pre></td></tr></table></figure>

<p>在本地的8890,8891,8892端口部署三个网页，记得<a href="http://drawon.site/2017/12/05/ubuntu%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE%E9%80%9A%E8%BF%87%E6%9F%90%E7%AB%AF%E5%8F%A3/">打开linux防火墙端口</a>，然后在你的web控制台中，将dj,data,jupyter三个二级域名都绑定到A类型的解析，解析地址为<code>frps</code>运行的服务器地址。</p>
<h5 id="通过密码保护你的-Web-服务"><a href="#通过密码保护你的-Web-服务" class="headerlink" title="通过密码保护你的 Web 服务"></a>通过密码保护你的 Web 服务</h5><p>由于所有客户端共用一个 <code>FRP</code> 服务端的 <code>HTTP</code> 服务端口，任何知道你的域名和 <code>URL</code> 的人都能访问到你部署在内网的 <code>Web</code> 服务，但是在某些场景下需要确保只有限定的用户才能访问。</p>
<p><code>FRP</code> 支持通过 HTTP Basic Auth 来保护你的 <code>Web</code> 服务，使用户需要通过用户名和密码才能访问到你的服务。需要实现此功能主要需要在 <code>FRP</code> 客户端的配置文件中添加用户名和密码的设置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[web]</span><br><span class="line">type = http</span><br><span class="line">local_port = 80</span><br><span class="line">custom_domains = mike.hi-linux.com</span><br><span class="line"># 设置认证的用户名</span><br><span class="line">http_user = abc</span><br><span class="line"># 设置认证的密码</span><br><span class="line">http_pwd = abc</span><br></pre></td></tr></table></figure>

<p>这时访问 <code>http://mike.hi-linux.com:8080</code> 这个 URL 时就需要输入配置的用户名和密码才能访问。</p>
<blockquote>
<ul>
<li>该功能目前仅限于 HTTP 类型的代理。</li>
</ul>
</blockquote>
<h5 id="给-Web-服务增加自定义二级域名"><a href="#给-Web-服务增加自定义二级域名" class="headerlink" title="给 Web 服务增加自定义二级域名"></a>给 Web 服务增加自定义二级域名</h5><p>在多人同时使用一个 <code>FRP</code> 服务端实现 <code>Web</code> 服务时，通过自定义二级域名的方式来使用会更加方便。</p>
<p>通过在 <code>FRP</code> 服务端的配置文件中配置 <code>subdomain_host</code>参数就可以启用该特性。之后在 <code>FRP</code> 客户端的 http、https 类型的代理中可以不配置 <code>custom_domains</code>，而是配置一个 <code>subdomain</code> 参数。</p>
<p>然后只需要将 <code>*.&#123;subdomain_host&#125;</code> 解析到 <code>FRP</code> 服务端所在服务器。之后用户可以通过 <code>subdomain</code> 自行指定自己的 <code>Web</code> 服务所需要使用的二级域名，并通过 <code>&#123;subdomain&#125;.&#123;subdomain_host&#125;</code> 来访问自己的 <code>Web</code> 服务。</p>
<p>首先我们在 <code>FRP</code> 服务端配置 <code>subdomain_host</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line">[common]</span><br><span class="line">subdomain_host = hi-linux.com</span><br></pre></td></tr></table></figure>

<p>其次在 <code>FRP</code> 客户端配置文件配置 <code>subdomain</code> 参数：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[web]</span><br><span class="line">type = http</span><br><span class="line">local_port = 80</span><br><span class="line">subdomain = test</span><br></pre></td></tr></table></figure>

<p>然后将泛域名 *.hi-linux.com 解析到 <code>FRP</code> 服务端所在服务器的公网 <code>IP</code> 地址。FRP 服务端 和 FRP 客户端都启动成功后，通过 <code>test.hi-linux.com</code> 就可以访问到内网的 <code>Web</code> 服务。</p>
<blockquote>
<ul>
<li>同一个 <code>HTTP</code> 或 <code>HTTPS</code> 类型的代理中 <code>custom_domains</code> 和 <code>subdomain</code> 可以同时配置。</li>
<li>需要注意的是如果 <code>FPR</code> 服务端配置了 <code>subdomain_host</code>，则 <code>custom_domains</code> 中不能是属于 <code>subdomain_host</code> 的子域名或者泛域名。</li>
</ul>
</blockquote>
<h5 id="修改-Host-Header"><a href="#修改-Host-Header" class="headerlink" title="修改 Host Header"></a>修改 Host Header</h5><p>通常情况下 <code>FRP</code> 不会修改转发的任何数据。但有一些后端服务会根据 <code>HTTP</code> 请求 <code>header</code> 中的 host 字段来展现不同的网站，例如 <code>Nginx</code> 的虚拟主机服务，启用 host-header 的修改功能可以动态修改 <code>HTTP</code> 请求中的 host 字段。</p>
<p>实现此功能只需要在 FRP 客户端配置文件中定义 <code>host_header_rewrite</code> 参数。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[web]</span><br><span class="line">type = http</span><br><span class="line">local_port = 80</span><br><span class="line">custom_domains = test.hi-linux.com</span><br><span class="line">host_header_rewrite = dev.hi-linux.com</span><br></pre></td></tr></table></figure>

<p>原来 <code>HTTP</code> 请求中的 host 字段 <code>test.hi-linux.com</code> 转发到后端服务时会被替换为 <code>dev.hi-linux.com</code>。</p>
<blockquote>
<ul>
<li>该功能仅限于 HTTP 类型的代理。</li>
</ul>
</blockquote>
<h5 id="URL-路由"><a href="#URL-路由" class="headerlink" title="URL 路由"></a>URL 路由</h5><p><code>FRP</code> 支持根据请求的 <code>URL</code> 路径路由转发到不同的后端服务。要实现这个功能可通过 <code>FRP</code> 客户端配置文件中的 <code>locations</code> 字段来指定。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[web01]</span><br><span class="line">type = http</span><br><span class="line">local_port = 80</span><br><span class="line">custom_domains = web.hi-linux.com</span><br><span class="line">locations = /</span><br><span class="line"></span><br><span class="line">[web02]</span><br><span class="line">type = http</span><br><span class="line">local_port = 81</span><br><span class="line">custom_domains = web.hi-linux.com</span><br><span class="line">locations = /news,/about</span><br></pre></td></tr></table></figure>

<p>按照上述的示例配置后，<code>web.hi-linux.com</code> 这个域名下所有以 &#x2F;news 以及 &#x2F;about 作为前缀的 <code>URL</code> 请求都会被转发到后端 web02 所在的后端服务，其余的请求会被转发到 web01 所在的后端服务。</p>
<blockquote>
<ul>
<li>目前仅支持最大前缀匹配，之后会考虑支持正则匹配。</li>
</ul>
</blockquote>
<h4 id="通过-UDP-访问内网机器"><a href="#通过-UDP-访问内网机器" class="headerlink" title="通过 UDP 访问内网机器"></a>通过 UDP 访问内网机器</h4><p><code>DNS</code> 查询请求通常使用 <code>UDP</code> 协议，<code>FRP</code> 支持对内网 <code>UDP</code> 服务的穿透，配置方式和 <code>TCP</code> 基本一致。这里以转发到 Google 的 <code>DNS</code> 查询服务器 8.8.8.8 的 <code>UDP</code> 端口为例。</p>
<p>首先修改 FRP 客户端配置文件，并增加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[dns]</span><br><span class="line">type = udp</span><br><span class="line">local_ip = 8.8.8.8</span><br><span class="line">local_port = 53</span><br><span class="line">remote_port = 6001</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>要转发到内网 DNS 服务器只需把 <code>local_ip</code> 改成对应 IP 即可。</li>
</ul>
</blockquote>
<p>其次重新启动 <code>FRP</code> 客户端：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line">2018/01/25 14:54:17 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/25 14:54:17 [I] [proxy_manager.go:294] proxy added: [ssh web dns]</span><br><span class="line">2018/01/25 14:54:17 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/25 14:54:17 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 14:54:17 [I] [control.go:240] [33e1de8a771112a6] login to server success, get run id [33e1de8a771112a6], server udp port [0]</span><br><span class="line">2018/01/25 14:54:17 [I] [control.go:165] [33e1de8a771112a6] [ssh] start proxy success</span><br><span class="line">2018/01/25 14:54:17 [I] [control.go:165] [33e1de8a771112a6] [web] start proxy success</span><br><span class="line">2018/01/25 14:54:17 [I] [control.go:165] [33e1de8a771112a6] [dns] start proxy success</span><br></pre></td></tr></table></figure>

<p>最后通过 <code>dig</code> 命令测试 <code>UDP</code> 包转发是否成功，预期会返回 <code>www.google.com</code> 域名的解析结果：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ dig @4.3.2.1 -p 6001 www.google.com</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;www.google.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">www.google.com.		79	IN	A	69.63.184.30</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="转发-Unix-域套接字"><a href="#转发-Unix-域套接字" class="headerlink" title="转发 Unix 域套接字"></a>转发 Unix 域套接字</h4><p>通过 <code>TCP</code> 端口访问内网的 <code>Unix</code> 域套接字，这里以和本地机器上的 Docker Daemon 通信为例。</p>
<p>首先修改 <code>FRP</code> 客户端配置文件，并增加如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[unix_domain_socket]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 6002</span><br><span class="line">plugin = unix_domain_socket</span><br><span class="line">plugin_unix_path = /var/run/docker.sock</span><br></pre></td></tr></table></figure>

<p>这里主要是使用 <code>plugin</code> 和 <code>plugin_unix_path</code> 两个参数启用了 <code>unix_domain_socket</code> 插件和配置对应的套接字路径。</p>
<p>其次重新启动 <code>FRP</code> 客户端：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line"></span><br><span class="line">2018/01/25 15:09:33 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/25 15:09:33 [I] [proxy_manager.go:294] proxy added: [ssh web dns unix_domain_socket]</span><br><span class="line">2018/01/25 15:09:33 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/25 15:09:33 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 15:09:33 [I] [control.go:240] [f6424f0deb8b6ff7] login to server success, get run id [f6424f0deb8b6ff7], server udp port [0]</span><br><span class="line">2018/01/25 15:09:33 [I] [control.go:165] [f6424f0deb8b6ff7] [ssh] start proxy success</span><br><span class="line">2018/01/25 15:09:33 [I] [control.go:165] [f6424f0deb8b6ff7] [web] start proxy success</span><br><span class="line">2018/01/25 15:09:33 [I] [control.go:165] [f6424f0deb8b6ff7] [dns] start proxy success</span><br><span class="line">2018/01/25 15:09:33 [I] [control.go:165] [f6424f0deb8b6ff7] [unix_domain_socket] start proxy success</span><br></pre></td></tr></table></figure>

<p>最后通过 <code>curl</code> 命令查看 <code>Docker</code> 版本信息进行测试：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ curl http://4.3.2.1:6002/version</span><br><span class="line"></span><br><span class="line">&#123;&quot;Platform&quot;:&#123;&quot;Name&quot;:&quot;&quot;&#125;,&quot;Components&quot;:[&#123;&quot;Name&quot;:&quot;Engine&quot;,&quot;Version&quot;:&quot;17.12.0-ce&quot;,&quot;Details&quot;:&#123;&quot;ApiVersion&quot;:&quot;1.35&quot;,&quot;Arch&quot;:&quot;amd64&quot;,&quot;BuildTime&quot;:&quot;2017-12-27T20:12:29.000000000+00:00&quot;,&quot;Experimental&quot;:&quot;true&quot;,&quot;GitCommit&quot;:&quot;c97c6d6&quot;,&quot;GoVersion&quot;:&quot;go1.9.2&quot;,&quot;KernelVersion&quot;:&quot;4.9.60-linuxkit-aufs&quot;,&quot;MinAPIVersion&quot;:&quot;1.12&quot;,&quot;Os&quot;:&quot;linux&quot;&#125;&#125;],&quot;Version&quot;:&quot;17.12.0-ce&quot;,&quot;ApiVersion&quot;:&quot;1.35&quot;,&quot;MinAPIVersion&quot;:&quot;1.12&quot;,&quot;GitCommit&quot;:&quot;c97c6d6&quot;,&quot;GoVersion&quot;:&quot;go1.9.2&quot;,&quot;Os&quot;:&quot;linux&quot;,&quot;Arch&quot;:&quot;amd64&quot;,&quot;KernelVersion&quot;:&quot;4.9.60-linuxkit-aufs&quot;,&quot;Experimental&quot;:true,&quot;BuildTime&quot;:&quot;2017-12-27T20:12:29.000000000+00:00&quot;&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li><code>FRP</code> 从 1.5 版本开始支持客户端热加载配置文件，并不用每次都重启客户端程序。具体方法在后文 <code>FRP</code> 客户端热加载配置文件部分讲解。</li>
</ul>
</blockquote>
<h3 id="FRP-高级进阶"><a href="#FRP-高级进阶" class="headerlink" title="FRP 高级进阶"></a>FRP 高级进阶</h3><h4 id="给-FRP-服务端增加一个-Dashboard"><a href="#给-FRP-服务端增加一个-Dashboard" class="headerlink" title="给 FRP 服务端增加一个 Dashboard"></a>给 FRP 服务端增加一个 Dashboard</h4><p>通过 <code>Dashboard</code> 可以方便的查看 <code>FRP</code> 的状态以及代理统计信息展示，要使用这个功能首先需要在 <code>FRP</code> 服务端配置文件中指定 <code>Dashboard</code> 服务使用的端口：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line"></span><br><span class="line"># 指定 Dashboard 的监听的 IP 地址</span><br><span class="line">dashboard_addr = 0.0.0.0</span><br><span class="line"></span><br><span class="line"># 指定 Dashboard 的监听的端口</span><br><span class="line">dashboard_port = 7500</span><br><span class="line"></span><br><span class="line"># 指定访问 Dashboard 的用户名</span><br><span class="line">dashboard_user = admin</span><br><span class="line"></span><br><span class="line"># 指定访问 Dashboard 的端口</span><br><span class="line">dashboard_pwd = admin</span><br></pre></td></tr></table></figure>

<p>其次重新启动 FRP 服务端：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line">2018/01/25 16:39:29 [I] [service.go:96] frps tcp listen on 0.0.0.0:7000</span><br><span class="line">2018/01/25 16:39:29 [I] [service.go:125] http service listen on 0.0.0.0:8080</span><br><span class="line">2018/01/25 16:39:29 [I] [service.go:164] Dashboard listen on 0.0.0.0:7500</span><br><span class="line">2018/01/25 16:39:29 [I] [main.go:112] Start frps success</span><br><span class="line">2018/01/25 16:39:29 [I] [main.go:114] PrivilegeMode is enabled, you should pay more attention to security issues</span><br></pre></td></tr></table></figure>

<p>最后通过 <code>http://[server_addr]:7500</code> 访问 Dashboard 界面，用户名密码默认都为 admin。</p>
<p><a href="https://www.hi-linux.com/img/linux/frp1.png"><img src="https://www.hi-linux.com/img/linux/frp1.png" alt="img"></a></p>
<p><a href="https://www.hi-linux.com/img/linux/frp2.png"><img src="https://www.hi-linux.com/img/linux/frp2.png" alt="img"></a></p>
<h4 id="给-FRP-服务端加上身份验证"><a href="#给-FRP-服务端加上身份验证" class="headerlink" title="给 FRP 服务端加上身份验证"></a>给 FRP 服务端加上身份验证</h4><p>默认情况下只要知道 <code>FRP</code> 服务端开放的端口，任意 <code>FRP</code> 客户端都可以随意在服务端上注册端口映射，这样对于在公网上的 <code>FRP</code> 服务来说显然不太安全。<code>FRP</code> 提供了身份验证机制来提高 <code>FRP</code> 服务端的安全性。要启用这一特性也很简单，只需在 <code>FRP</code>服务端和 <code>FRP</code> 客户端的 common 配置中启用 <code>privilege_token</code> 参数就行。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[common]</span><br><span class="line">privilege_token = 12345678</span><br></pre></td></tr></table></figure>

<p>启用这一特性后，只有 <code>FRP</code> 服务端和 <code>FRP</code> 客户端的 common 配置中的 <code>privilege_token</code> 参数一致身份验证才会通过，<code>FRP</code> 客户端才能成功在 <code>FRP</code> 服务端注册端口映射。否则就会注册失败，出现类似下面的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2018/01/25 17:29:27 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/25 17:29:27 [I] [proxy_manager.go:294] proxy added: [ssh web dns unix_domain_socket]</span><br><span class="line">2018/01/25 17:29:27 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/25 17:29:27 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 17:29:27 [E] [control.go:230] authorization failed</span><br><span class="line">2018/01/25 17:29:27 [W] [control.go:109] login to server failed: authorization failed</span><br><span class="line">authorization failed</span><br></pre></td></tr></table></figure>

<blockquote>
<p>需要注意的是 <code>FRP</code> 客户端所在机器和 <code>FRP</code> 服务端所在机器的时间相差不能超过 15 分钟，因为时间戳会被用于加密验证中，防止报文被劫持后被其他人利用。这个超时时间可以在配置文件中通过 <code>authentication_timeout</code> 这个参数来修改，单位为秒，默认值为 900，即 15 分钟。如果修改为 0，则 <code>FRP</code> 服务端将不对身份验证报文的时间戳进行超时校验。</p>
</blockquote>
<h4 id="FRP-客户端热加载配置文件"><a href="#FRP-客户端热加载配置文件" class="headerlink" title="FRP 客户端热加载配置文件"></a>FRP 客户端热加载配置文件</h4><p>当修改了 <code>FRP</code> 客户端中的配置文件，从 0.15 版本开始可以通过 <code>frpc reload</code> 命令来动态加载配置文件，通常会在 10 秒内完成代理的更新。</p>
<p>启用此功能需要在 <code>FRP</code> 客户端配置文件中启用 admin 端口，用于提供 <code>API</code> 服务。配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">admin_addr = 127.0.0.1</span><br><span class="line">admin_port = 7400</span><br></pre></td></tr></table></figure>

<p>重启 <code>FRP</code> 客户端，以后就可通过热加载方式进行 <code>FRP</code> 客户端配置变更了。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line">2018/01/25 18:04:25 [I] [proxy_manager.go:326] visitor added: []</span><br><span class="line">2018/01/25 18:04:25 [I] [control.go:240] [3653b9a878f8acc7] login to server success, get run id [3653b9a878f8acc7], server udp port [0]</span><br><span class="line">2018/01/25 18:04:25 [I] [service.go:49] admin server listen on 127.0.0.1:7400</span><br><span class="line">2018/01/25 18:04:25 [I] [control.go:165] [3653b9a878f8acc7] [ssh] start proxy success</span><br><span class="line">2018/01/25 18:04:25 [I] [control.go:165] [3653b9a878f8acc7] [web] start proxy success</span><br><span class="line">2018/01/25 18:04:25 [I] [control.go:165] [3653b9a878f8acc7] [dns] start proxy success</span><br><span class="line">2018/01/25 18:04:25 [I] [control.go:165] [3653b9a878f8acc7] [unix_domain_socket] start proxy success</span><br><span class="line"></span><br><span class="line">$ ./frpc reload -c ./frpc.ini</span><br><span class="line">reload success</span><br></pre></td></tr></table></figure>

<p>等待一段时间后客户端会根据新的配置文件创建、更新、删除代理。</p>
<blockquote>
<ul>
<li>需要注意的是 [common] 中的参数除了 start 外目前无法被修改。</li>
</ul>
</blockquote>
<p>启用 <code>admin_addr</code> 后，还可以通过 <code>frpc status -c ./frpc.ini</code> 命令在 FRP 客户端很方便的查看当前代理状态信息。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc status -c ./frpc.ini</span><br><span class="line"></span><br><span class="line">Proxy Status...</span><br><span class="line">TCP</span><br><span class="line">Name                Status   LocalAddr     Plugin              RemoteAddr           Error</span><br><span class="line">ssh                 running  127.0.0.1:22                      4.3.2.1:6000</span><br><span class="line">unix_domain_socket  running                unix_domain_socket  4.3.2.1:6002</span><br><span class="line"></span><br><span class="line">UDP</span><br><span class="line">Name  Status   LocalAddr   Plugin  RemoteAddr           Error</span><br><span class="line">dns   running  8.8.8.8:53          4.3.2.1:6001</span><br><span class="line"></span><br><span class="line">HTTP</span><br><span class="line">Name  Status   LocalAddr     Plugin  RemoteAddr              Error</span><br><span class="line">web   running  127.0.0.1:80          mike.hi-linux.com:8080</span><br></pre></td></tr></table></figure>

<h4 id="给-FRP-服务端增加端口白名单"><a href="#给-FRP-服务端增加端口白名单" class="headerlink" title="给 FRP 服务端增加端口白名单"></a>给 FRP 服务端增加端口白名单</h4><p>为了防止 <code>FRP</code> 端口被滥用，<code>FRP</code> 提供了指定允许哪些端口被分配的功能。可通过 <code>FRP</code> 服务端的配置文件中 <code>privilege_allow_ports</code>参数来指定：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">privilege_allow_ports = 2000-3000,3001,3003,4000-5000</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>privilege_allow_ports</code> 可以配置允许使用的某个指定端口或者是一个范围内的所有端口，以 , 分隔，指定的范围以 - 分隔。</p>
</blockquote>
<p>当使用不允许的端口注册时，就会注册失败。出现类似以下错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc status -c ./frpc.ini</span><br><span class="line">Proxy Status...</span><br><span class="line">TCP</span><br><span class="line">Name                Status       LocalAddr     Plugin              RemoteAddr            Error</span><br><span class="line">ssh                 start error  127.0.0.1:22                      4.3.2.1:60000  port not allowed</span><br><span class="line">unix_domain_socket  start error                unix_domain_socket  4.3.2.1:60002  port not allowed</span><br></pre></td></tr></table></figure>

<h4 id="启用-TCP-多路复用"><a href="#启用-TCP-多路复用" class="headerlink" title="启用 TCP 多路复用"></a>启用 TCP 多路复用</h4><p>从 v0.10.0 版本开始，客户端和服务器端之间的连接支持多路复用，不再需要为每一个用户请求创建一个连接，使连接建立的延迟降低，并且避免了大量文件描述符的占用，使 <code>FRP</code> 可以承载更高的并发数。</p>
<p>该功能默认启用，如需关闭可以在 <code>FRP</code> 服务端配置文件和 <code>FRP</code> 客户端配置文件中配置，该配置项在服务端和客户端必须一致：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># frps.ini 和 frpc.ini 中</span><br><span class="line">[common]</span><br><span class="line">tcp_mux = false</span><br></pre></td></tr></table></figure>

<h4 id="FRP-底层通信启用-KCP-协议"><a href="#FRP-底层通信启用-KCP-协议" class="headerlink" title="FRP 底层通信启用 KCP 协议"></a>FRP 底层通信启用 KCP 协议</h4><p>FRP 从 v0.12.0 版本开始，底层通信协议支持选择 <code>KCP</code> 协议，在弱网络环境下传输效率会提升明显，但是会有一些额外的流量消耗。</p>
<p>要开启 <code>KCP</code> 协议支持，首先要在 <code>FRP</code> 服务端配置文件中启用 <code>KCP</code> 协议支持：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line">[common]</span><br><span class="line">bind_port = 7000</span><br><span class="line"># 指定一个 UDP 端口用于接收客户端请求 KCP 绑定的是 UDP 端口，可以和 bind_port 一样</span><br><span class="line">kcp_bind_port = 7000</span><br></pre></td></tr></table></figure>

<p>其次是在 <code>FRP</code> 客户端配置文件指定需要使用的协议类型，目前只支持 <code>TCP</code> 和 <code>KCP</code>。其它代理配置不需要变更：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim  frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line"># server_port 指定为 FRP 服务端里 kcp_bind_port 指定的端口</span><br><span class="line">server_port = 7000</span><br><span class="line"># 指定需要使用的协议类型，默认类型为 TCP</span><br><span class="line">protocol = kcp</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>需要注意开放相关机器上的 UDP 端口的访问权限。</li>
</ul>
</blockquote>
<h4 id="给-FRP-服务端配置连接池"><a href="#给-FRP-服务端配置连接池" class="headerlink" title="给 FRP 服务端配置连接池"></a>给 FRP 服务端配置连接池</h4><p>默认情况下，当用户请求建立连接后，<code>FRP</code> 服务端才会请求 <code>FRP</code> 客户端主动与后端服务建立一个连接。</p>
<p>当为指定的 <code>FRP</code> 服务端启用连接池功能后，<code>FRP</code> 会预先和后端服务建立起指定数量的连接，每次接收到用户请求后，会从连接池中取出一个连接和用户连接关联起来，避免了等待与后端服务建立连接以及 <code>FRP</code> 客户端 和 <code>FRP</code> 服务端之间传递控制信息的时间。</p>
<p>首先需要在 <code>FRP</code> 服务端配置文件中设置每个代理可以创建的连接池上限，避免大量资源占用，客户端设置超过此配置后会被调整到当前值：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line">[common]</span><br><span class="line">max_pool_count = 5</span><br></pre></td></tr></table></figure>

<p>其次在 <code>FRP</code> 客户端配置文件中为客户端启用连接池，指定预创建连接的数量：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[common]</span><br><span class="line">pool_count = 1</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>此功能比较适合有大量短连接请求时开启。</li>
</ul>
</blockquote>
<h4 id="加密与压缩"><a href="#加密与压缩" class="headerlink" title="加密与压缩"></a>加密与压缩</h4><p>如果公司内网防火墙对外网访问进行了流量识别与屏蔽，例如禁止了 <code>SSH</code> 协议等，可通过设置 use_encryption &#x3D; true，将 <code>FRP</code> 客户端 与 <code>FRP</code> 服务端之间的通信内容加密传输，将会有效防止流量被拦截。</p>
<p>如果传输的报文长度较长，通过设置 use_compression &#x3D; true 对传输内容进行压缩，可以有效减小 <code>FRP</code> 客户端 与 <code>FRP</code> 服务端之间的网络流量，来加快流量转发速度，但是会额外消耗一些 CPU 资源。</p>
<p>这两个功能默认是不开启的，需要在 <code>FRP</code> 客户端配置文件中通过配置来为指定的代理启用加密与压缩的功能，压缩算法使用的是 snappy。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[ssh]</span><br><span class="line">type = tcp</span><br><span class="line">local_port = 22</span><br><span class="line">remote_port = 6000</span><br><span class="line">use_encryption = true</span><br><span class="line">use_compression = true</span><br></pre></td></tr></table></figure>

<h4 id="通过-FRP-客户端代理其它内网机器访问外网"><a href="#通过-FRP-客户端代理其它内网机器访问外网" class="headerlink" title="通过 FRP 客户端代理其它内网机器访问外网"></a>通过 FRP 客户端代理其它内网机器访问外网</h4><p><code>FRP</code> 客户端内置了 <code>http_proxy</code> 和 <code>socks5</code> 插件，通过这两个插件可以使其它内网机器通过 <code>FPR</code> 客户端的的网络访问互联网。</p>
<p>要启用此功能，首先需要在 <code>FRP</code> 客户端配置文件中启用相关插件，这里以 <code>http_proxy</code> 插件为例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[http_proxy]</span><br><span class="line">type = tcp</span><br><span class="line">remote_port = 6000</span><br><span class="line">plugin = http_proxy</span><br></pre></td></tr></table></figure>

<p>其次将需要通过这个代理访问外网的内部机器的代理地址设置为 4.3.2.1:6000，这样就可以通过 FRP 客户端机器的网络访问互联网了。</p>
<blockquote>
<ul>
<li><code>http_proxy</code> 插件也支持认证机制，如果需要启用认证可通过配置参数 <code>plugin_http_user</code> 和 <code>plugin_http_passwd</code> 启用。</li>
<li>如需启用 <code>Socks5</code> 代理，只需将 plugin 的值更换为 socks5 即可。</li>
</ul>
</blockquote>
<h4 id="通过代理连接-FRP-服务端"><a href="#通过代理连接-FRP-服务端" class="headerlink" title="通过代理连接 FRP 服务端"></a>通过代理连接 FRP 服务端</h4><p>在只能通过代理访问外网的环境内，<code>FRP</code> 客户端支持通过 <code>HTTP_PROXY</code> 参数来配置代理和 <code>FRP</code> 服务端进行通信。要使用此功能可以通过设置系统环境变量 <code>HTTP_PROXY</code> 或者通过在 <code>FRP</code> 客户端的配置文件中设置 <code>http_proxy</code> 参数来使用此功能。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line">server_port = 7000</span><br><span class="line">protocol = tcp</span><br><span class="line">http_proxy = http://user:pwd@4.3.2.2:8080</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>仅在 <code>protocol = tcp</code> 时生效，暂时不支持 kcp 协议。</li>
</ul>
</blockquote>
<h4 id="安全地暴露内网服务"><a href="#安全地暴露内网服务" class="headerlink" title="安全地暴露内网服务"></a>安全地暴露内网服务</h4><p>对于一些比较敏感的服务如果直接暴露于公网上将会存在安全隐患，<code>FRP</code> 也提供了一种安全的转发方式 <code>STCP</code>。使用 <code>STCP</code>(secret tcp) 类型的代理可以避免让任何人都能访问到穿透到公网的内网服务，要使用 <code>STCP</code> 模式访问者需要单独运行另外一个 <code>FRP</code> 客户端。</p>
<p>下面就以创建一个只有自己能访问到的 <code>SSH</code> 服务代理为例，<code>FRP</code> 服务端和其它的部署步骤相同，主要区别是在 <code>FRP</code> 客户端上。</p>
<p>首先配置 <code>FRP</code> 客户端，和常规 <code>TCP</code> 转发不同的是这里不需要指定远程端口。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[secret_ssh]</span><br><span class="line">type = stcp</span><br><span class="line"># 只有 sk 一致的用户才能访问到此服务</span><br><span class="line">sk = abcdefg</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br></pre></td></tr></table></figure>

<p>其次在要访问这个服务的机器上启动另外一个 <code>FRP</code> 客户端，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[secret_ssh_visitor]</span><br><span class="line">type = stcp</span><br><span class="line"># STCP 的访问者</span><br><span class="line">role = visitor</span><br><span class="line"># 要访问的 STCP 代理的名字，和前面定义的相同。</span><br><span class="line">server_name = secret_ssh</span><br><span class="line"># 和前面定义的要一致</span><br><span class="line">sk = abcdefg</span><br><span class="line"># 绑定本地端口用于访问 ssh 服务</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 6005</span><br></pre></td></tr></table></figure>

<p>最后在本机启动一个 <code>FRP</code> 客户端，这样就可以通过本机 6005 端口对内网机器 <code>SSH</code> 服务进行访问，假设用户名为 mike：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line">2018/01/26 15:03:24 [I] [proxy_manager.go:284] proxy removed: []</span><br><span class="line">2018/01/26 15:03:24 [I] [proxy_manager.go:294] proxy added: []</span><br><span class="line">2018/01/26 15:03:24 [I] [proxy_manager.go:317] visitor removed: []</span><br><span class="line">2018/01/26 15:03:24 [I] [proxy_manager.go:326] visitor added: [secret_ssh_visitor]</span><br><span class="line">2018/01/26 15:03:24 [I] [control.go:240] [60d2af2f68196537] login to server success, get run id [60d2af2f68196537], server udp port [0]</span><br><span class="line">2018/01/26 15:03:24 [I] [proxy_manager.go:235] [60d2af2f68196537] try to start visitor [secret_ssh_visitor]</span><br><span class="line">2018/01/26 15:03:24 [I] [proxy_manager.go:243] [secret_ssh_visitor] start visitor success</span><br><span class="line"></span><br><span class="line">$ ssh -oPort=6005 mike@127.0.0.1</span><br></pre></td></tr></table></figure>

<h4 id="点对点内网穿透"><a href="#点对点内网穿透" class="headerlink" title="点对点内网穿透"></a>点对点内网穿透</h4><p>在传输大量数据时如果都经过服务器中转的话，这样会对服务器端带宽压力比较大。<code>FRP</code> 提供了一种新的代理类型 <code>XTCP</code>来解决这个问题，<code>XTCP</code> 模式下可以在传输大量数据时让流量不经过服务器中转。</p>
<p>使用方式同 <code>STCP</code> 类似，需要在传输数据的两端都部署上 <code>FRP</code> 客户端上用于建立直接的连接。</p>
<p>首先在 <code>FRP</code> 服务端配置上增加一个 <code>UDP</code> 端口用于支持该类型的客户端:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frps.ini</span><br><span class="line">bind_udp_port = 7001</span><br></pre></td></tr></table></figure>

<p>其次配置 <code>FRP</code> 客户端，和常规 <code>TCP</code> 转发不同的是这里不需要指定远程端口。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line"></span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[p2p_ssh]</span><br><span class="line">type = xtcp</span><br><span class="line"># 只有 sk 一致的用户才能访问到此服务</span><br><span class="line">sk = abcdefg</span><br><span class="line">local_ip = 127.0.0.1</span><br><span class="line">local_port = 22</span><br></pre></td></tr></table></figure>

<p>然后在要访问这个服务的机器上启动另外一个 <code>FRP</code> 客户端，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ vim frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = 4.3.2.1</span><br><span class="line">server_port = 7000</span><br><span class="line"></span><br><span class="line">[p2p_ssh_visitor]</span><br><span class="line">type = xtcp</span><br><span class="line"># XTCP 的访问者</span><br><span class="line">role = visitor</span><br><span class="line"># 要访问的 XTCP 代理的名字</span><br><span class="line">server_name = p2p_ssh</span><br><span class="line">sk = abcdefg</span><br><span class="line"># 绑定本地端口用于访问 ssh 服务</span><br><span class="line">bind_addr = 127.0.0.1</span><br><span class="line">bind_port = 6006</span><br></pre></td></tr></table></figure>

<p>最后在本机启动一个 FRP 客户端，这样就可以通过本机 6006 端口对内网机器 SSH 服务进行访问，假设用户名为 mike：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./frpc -c ./frpc.ini</span><br><span class="line"></span><br><span class="line">2018/01/26 16:01:52 [I] [proxy_manager.go:326] visitor added: [p2p_ssh_visitor secret_ssh_visitor]</span><br><span class="line">2018/01/26 16:01:52 [I] [control.go:240] [7c7e06878e11cc3c] login to server success, get run id [7c7e06878e11cc3c], server udp port [7001]</span><br><span class="line">2018/01/26 16:01:52 [I] [proxy_manager.go:235] [7c7e06878e11cc3c] try to start visitor [p2p_ssh_visitor]</span><br><span class="line">2018/01/26 16:01:52 [I] [proxy_manager.go:243] [p2p_ssh_visitor] start visitor success</span><br><span class="line">2018/01/26 16:01:52 [I] [proxy_manager.go:235] [7c7e06878e11cc3c] try to start visitor [secret_ssh_visitor]</span><br><span class="line">2018/01/26 16:01:52 [I] [proxy_manager.go:243] [secret_ssh_visitor] start visitor success</span><br><span class="line"></span><br><span class="line">$ ssh -oPort=6006 mike@127.0.0.1</span><br></pre></td></tr></table></figure>

<blockquote>
<ul>
<li>目前 <code>XTCP</code> 模式还处于开发的初级阶段，并不能穿透所有类型的 <code>NAT</code> 设备，所以穿透成功率较低。穿透失败时可以尝试 <code>STCP</code> 的方式。</li>
</ul>
</blockquote>
<h3 id="FRP-管理"><a href="#FRP-管理" class="headerlink" title="FRP 管理"></a>FRP 管理</h3><p><code>FRP</code> 的部署安装比较简单，项目官方也没有提供相应的管理脚本。不过好在开源项目总是有网友热心提供部署和管理脚本。如果你觉得手动部署太麻烦，还可以使用下面的一键安装脚本。</p>
<p>项目地址：<a href="https://github.com/clangcn/onekey-install-shell/">https://github.com/clangcn/onekey-install-shell/</a></p>
<h4 id="下载一键部署脚本"><a href="#下载一键部署脚本" class="headerlink" title="下载一键部署脚本"></a>下载一键部署脚本</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ wget --no-check-certificate https://raw.githubusercontent.com/clangcn/onekey-install-shell/master/frps/install-frps.sh -O ./install-frps.sh</span><br><span class="line">$ chmod 700 ./install-frps.sh</span><br></pre></td></tr></table></figure>

<h4 id="安装-FRP-服务端"><a href="#安装-FRP-服务端" class="headerlink" title="安装 FRP 服务端"></a>安装 FRP 服务端</h4><p>这个一键部署脚本比较好用，为了提高国内用户下载安装包速度还提供了阿里云节点的安装源。整个脚本使用起来也比较简单，对一些常用的 <code>FRP</code> 服务端配置参数都做了交互式选择让用户可以方便的根据自己实际情况进行选择。脚本比较贴心的一点是对默认的公网地址进行了检测，省去了手动输入的麻烦。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./install-frps.sh install</span><br><span class="line"></span><br><span class="line">Please select frps download url:</span><br><span class="line">[1].aliyun (default)</span><br><span class="line">[2].github</span><br><span class="line">Enter your choice (1, 2 or exit. default [aliyun]):</span><br><span class="line">---------------------------------------</span><br><span class="line">Your select: aliyun</span><br><span class="line">---------------------------------------</span><br><span class="line">Loading network version for frps, please wait...</span><br><span class="line">frps Latest release file frp_0.15.1_linux_amd64.tar.gz</span><br><span class="line">Loading You Server IP, please wait...</span><br><span class="line">You Server IP:12.34.56.78</span><br><span class="line">Please input your server setting:</span><br><span class="line"></span><br><span class="line">Please input frps bind_port [1-65535](Default Server Port: 5443):7000</span><br><span class="line">frps bind_port: 7000</span><br><span class="line"></span><br><span class="line">Please input frps vhost_http_port [1-65535](Default vhost_http_port: 80):8080</span><br><span class="line">frps vhost_http_port: 8080</span><br><span class="line"></span><br><span class="line">Please input frps vhost_https_port [1-65535](Default vhost_https_port: 443):</span><br><span class="line">frps vhost_https_port: 443</span><br><span class="line"></span><br><span class="line">Please input frps dashboard_port [1-65535](Default dashboard_port: 6443):7500</span><br><span class="line">frps dashboard_port: 7500</span><br><span class="line"></span><br><span class="line">Please input dashboard_user (Default: admin):</span><br><span class="line">frps dashboard_user: admin</span><br><span class="line"></span><br><span class="line">Please input dashboard_pwd (Default: IY0p1bOg):admin</span><br><span class="line">frps dashboard_pwd: admin</span><br><span class="line"></span><br><span class="line">Please input privilege_token (Default: 9BqswPpd1R0TfGR5):mike</span><br><span class="line">frps privilege_token: mike</span><br><span class="line"></span><br><span class="line">Please input frps max_pool_count [1-200]</span><br><span class="line">(Default max_pool_count: 50):</span><br><span class="line">frps max_pool_count: 50</span><br><span class="line"></span><br><span class="line">##### Please select log_level #####</span><br><span class="line">1: info (default)</span><br><span class="line">2: warn</span><br><span class="line">3: error</span><br><span class="line">4: debug</span><br><span class="line">#####################################################</span><br><span class="line">Enter your choice (1, 2, 3, 4 or exit. default [1]):</span><br><span class="line">log_level: info</span><br><span class="line"></span><br><span class="line">Please input frps log_max_days [1-30]</span><br><span class="line">(Default log_max_days: 3 day):</span><br><span class="line">frps log_max_days: 3</span><br><span class="line"></span><br><span class="line">##### Please select log_file #####</span><br><span class="line">1: enable (default)</span><br><span class="line">2: disable</span><br><span class="line">#####################################################</span><br><span class="line">Enter your choice (1, 2 or exit. default [1]):</span><br><span class="line">log_file: enable</span><br><span class="line"></span><br><span class="line">##### Please select tcp_mux #####</span><br><span class="line">1: enable (default)</span><br><span class="line">2: disable</span><br><span class="line">#####################################################</span><br><span class="line">Enter your choice (1, 2 or exit. default [1]):</span><br><span class="line">tcp_mux: true</span><br><span class="line"></span><br><span class="line">##### Please select kcp support #####</span><br><span class="line">1: enable (default)</span><br><span class="line">2: disable</span><br><span class="line">#####################################################</span><br><span class="line">Enter your choice (1, 2 or exit. default [1]):</span><br><span class="line">kcp support: true</span><br><span class="line"></span><br><span class="line">============== Check your input ==============</span><br><span class="line">You Server IP      : 12.34.56.78</span><br><span class="line">Bind port          : 7000</span><br><span class="line">kcp support        : true</span><br><span class="line">vhost http port    : 8080</span><br><span class="line">vhost https port   : 443</span><br><span class="line">Dashboard port     : 7500</span><br><span class="line">Dashboard user     : admin</span><br><span class="line">Dashboard password : admin</span><br><span class="line">Privilege token    : mike</span><br><span class="line">tcp_mux            : true</span><br><span class="line">Max Pool count     : 50</span><br><span class="line">Log level          : info</span><br><span class="line">Log max days       : 3</span><br><span class="line">Log file           : enable</span><br><span class="line">==============================================</span><br><span class="line"></span><br><span class="line">Press any key to start...or Press Ctrl+c to cancel</span><br><span class="line"></span><br><span class="line">frps install path:/usr/local/frps</span><br><span class="line">config file for frps ... done</span><br><span class="line">download frps ... done</span><br><span class="line">download /etc/init.d/frps... done</span><br><span class="line">setting frps boot... done</span><br><span class="line"></span><br><span class="line">+--------------------------------------------------+</span><br><span class="line">|        Manager for Frps, Written by Clang        |</span><br><span class="line">+--------------------------------------------------+</span><br><span class="line">| Intro: http://koolshare.cn/thread-65379-1-1.html |</span><br><span class="line">+--------------------------------------------------+</span><br><span class="line"></span><br><span class="line">Starting Frps(0.15.1)... done</span><br><span class="line">Frps (pid 3325)is running.</span><br><span class="line"></span><br><span class="line">+---------------------------------------------------------+</span><br><span class="line">|        frps for Linux Server, Written by Clang          |</span><br><span class="line">+---------------------------------------------------------+</span><br><span class="line">|     A tool to auto-compile &amp; install frps on Linux      |</span><br><span class="line">+---------------------------------------------------------+</span><br><span class="line">|    Intro: http://koolshare.cn/thread-65379-1-1.html     |</span><br><span class="line">+---------------------------------------------------------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Congratulations, frps install completed!</span><br><span class="line">==============================================</span><br><span class="line">You Server IP      : 12.34.56.78</span><br><span class="line">Bind port          : 7000</span><br><span class="line">KCP support        : true</span><br><span class="line">vhost http port    : 8080</span><br><span class="line">vhost https port   : 443</span><br><span class="line">Dashboard port     : 7500</span><br><span class="line">Privilege token    : mike</span><br><span class="line">tcp_mux            : true</span><br><span class="line">Max Pool count     : 50</span><br><span class="line">Log level          : info</span><br><span class="line">Log max days       : 3</span><br><span class="line">Log file           : enable</span><br><span class="line">==============================================</span><br><span class="line">frps Dashboard     : http://12.34.56.78:7500/</span><br><span class="line">Dashboard user     : admin</span><br><span class="line">Dashboard password : admin</span><br><span class="line">==============================================</span><br></pre></td></tr></table></figure>

<h4 id="配置-FRP-服务端"><a href="#配置-FRP-服务端" class="headerlink" title="配置 FRP 服务端"></a>配置 FRP 服务端</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./install-frps.sh config</span><br></pre></td></tr></table></figure>

<h4 id="更新-FRP-服务端"><a href="#更新-FRP-服务端" class="headerlink" title="更新 FRP 服务端"></a>更新 FRP 服务端</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./install-frps.sh update</span><br></pre></td></tr></table></figure>

<h4 id="卸载-FRP-服务端"><a href="#卸载-FRP-服务端" class="headerlink" title="卸载 FRP 服务端"></a>卸载 FRP 服务端</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ./install-frps.sh uninstall</span><br></pre></td></tr></table></figure>

<h4 id="FRP-服务端日常管理"><a href="#FRP-服务端日常管理" class="headerlink" title="FRP 服务端日常管理"></a>FRP 服务端日常管理</h4><p><code>FRP</code> 服务端安装完成后，一键部署脚本还提供了一个日常管理 <code>FRP</code> 服务端的管理脚本来进行日常的启动、重启、停止等操作，非常的方便。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Usage: /etc/init.d/frps &#123;start|stop|restart|status|config|version&#125;</span><br></pre></td></tr></table></figure>

<h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><p><a href="http://www.google.com/">http://www.google.com</a><br><a href="https://github.com/fatedier/frp">https://github.com/fatedier/frp</a><br><a href="http://koolshare.cn/thread-65379-1-1.html">http://koolshare.cn/thread-65379-1-1.html</a></p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>HTML教程.md</title>
    <url>/2017/06/29/HTML%E6%95%99%E7%A8%8B-md/</url>
    <content><![CDATA[<p><a href="http://www.runoob.com/tags/html-reference.html"><strong>HTML常用标签和属性参考</strong></a></p>
<h1 id="HTML定义"><a href="#HTML定义" class="headerlink" title="HTML定义"></a>HTML定义</h1><p>超文本标记语言（英语：HyperText Markup Language，简称：HTML）是一种用于创建网页的标准标记语言。</p>
<span id="more"></span>

<h1 id="HTML简介"><a href="#HTML简介" class="headerlink" title="HTML简介"></a>HTML简介</h1><h2 id="HTML实例"><a href="#HTML实例" class="headerlink" title="HTML实例"></a>HTML实例</h2><p>网页中需要展示出来的内容都在<code>&lt;body&gt;</code>标签中，整体结构如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&#x27;utf-8&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>.....<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&#x27;www.baidu.com&#x27;</span>&gt;</span>........<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span>    </span><br></pre></td></tr></table></figure>

<p>实例如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>菜鸟教程(runoob.com)<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>我的第一个标题<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>我的第一个段落。<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>&lt;!DOCTYPE html&gt;</code>：表示为HTML5文档，这个声明不区分大小写</li>
<li><code>&lt;html&gt;</code>：是HTML页面的根元素</li>
<li><code>&lt;head&gt;</code>元素包含了文档的元<code>&lt;meta&gt;</code>数据</li>
<li><code>&lt;title&gt;</code>元素表示文档的标题</li>
<li><code>&lt;body&gt;</code>元素包含了可见的页面内容</li>
<li><code>&lt;h1&gt;</code>元素定义了一个大标题</li>
<li><code>&lt;p&gt;</code>元素定义了一个段落</li>
<li><code>&lt;meta charset=&quot;utf-8&quot;&gt;</code>：可以使得输出中文时正常显示</li>
<li><code>&lt;q&gt;</code>：表示引用</li>
<li><code>&lt;br/&gt;</code>：换行符，回车在html文件中是无效的</li>
<li><code>&amp;nbsp;</code>：空格符号</li>
<li><code>&lt;hr/&gt;</code>：横线</li>
<li><code>&lt;code&gt;</code>：代码，<code>&lt;pre&gt;</code>:多行代码</li>
<li>​</li>
</ul>
<h2 id="HTML-元素语法"><a href="#HTML-元素语法" class="headerlink" title="HTML 元素语法"></a>HTML 元素语法</h2><ul>
<li>HTML 元素以<strong>开始标签</strong>起始</li>
<li>HTML 元素以<strong>结束标签</strong>终止</li>
</ul>
<h2 id="HTML-属性"><a href="#HTML-属性" class="headerlink" title="HTML 属性"></a>HTML 属性</h2><ul>
<li>HTML 元素可以设置<strong>属性</strong></li>
<li>属性可以在元素中添加<strong>附加信息</strong></li>
<li>属性一般描述于<strong>开始标签</strong></li>
<li>属性总是以名称&#x2F;值对的形式出现，**比如：name&#x3D;”value”**。</li>
</ul>
<p>HTML <strong>链接</strong> 由 <a> 标签定义。链接的地址在 <strong>href 属性</strong>中指定：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;http://www.runoob.com&quot;</span>&gt;</span>这是一个链接<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><a href="http://www.runoob.com/tags/html-reference.html"><strong>HTML常用标签和属性参考</strong></a></p>
<table>
<thead>
<tr>
<th>标签</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><a href="http://www.runoob.com/tags/tag-html.html"><code>&lt;html&gt;</code></a></td>
<td>定义 HTML 文档</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-body.html"><code>&lt;body&gt;</code></a></td>
<td>定义文档的主体</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-hn.html"><code>&lt;h1&gt;-&lt;h6&gt;</code> </a></td>
<td>定义 HTML 标题</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-hr.html"><code>&lt;hr&gt;</code></a></td>
<td>定义水平线</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-comment.html"><code>&lt;!--...--&gt;</code></a></td>
<td>定义注释</td>
</tr>
</tbody></table>
<h2 id="HTML-文本格式化标签"><a href="#HTML-文本格式化标签" class="headerlink" title="HTML 文本格式化标签"></a>HTML 文本格式化标签</h2><table>
<thead>
<tr>
<th>标签</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td><a href="http://www.runoob.com/tags/tag-b.html"><code>&lt;b&gt;</code></a></td>
<td>定义粗体文本</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-em.html"><code>&lt;em&gt;</code></a></td>
<td>定义着重文字</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-i.html"><code>&lt;i&gt;</code></a></td>
<td>定义斜体字</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-small.html"><code>&lt;small&gt;</code></a></td>
<td>定义小号字</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-strong.html"><code>&lt;strong&gt;</code></a></td>
<td>定义加重语气</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-sub.html"><code>&lt;sub&gt;</code></a></td>
<td>定义下标字</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/html/m/tags/tag-sup.html"><code>&lt;sup&gt;</code></a></td>
<td>定义上标字</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-ins.html"><code>&lt;ins&gt;</code></a></td>
<td>定义插入字</td>
</tr>
<tr>
<td><a href="http://www.runoob.com/tags/tag-del.html"><code>&lt;del&gt;</code></a></td>
<td>定义删除字</td>
</tr>
</tbody></table>
<h2 id="HTML-链接语法"><a href="#HTML-链接语法" class="headerlink" title="HTML 链接语法"></a>HTML 链接语法</h2><p>标签<code>&lt;a&gt;</code>加上属性<code>href</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;www.baidu.com&quot;</span>&gt;</span>百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果需要在新标签中打开网页，需要加上：<code>target=&quot;_blank&quot;</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;www.baidu.com&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span>百度<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="邮件语法"><a href="#邮件语法" class="headerlink" title="邮件语法"></a>邮件语法</h2><p>在连接中使用<code>mailto</code>，第一个符号使用<code>？</code>分隔，后面用<code>&amp;</code>分隔</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span> = <span class="string">&quot;mailto:xxxx@qq.com? &amp; cc=xxx@qq.com &amp; bcc=xxx@qq.com &amp; subject=&quot;</span><span class="attr">主题</span>&quot; &amp; <span class="attr">body</span>=<span class="string">&quot;内容&quot;</span>&gt;</span>发送按钮<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="表格实例"><a href="#表格实例" class="headerlink" title="表格实例"></a>表格实例</h2><p>由<code>table</code>标签开始，然后用<code>tbody</code>使表可以加载多少显示多少，<code>th</code>：table head表示表头，<code>tr</code>表示table row表行，<code>td</code>表示table data单元格</p>
<p>加入边框的方式有2种；第一种是直接加入<code>border</code> 属性，第二种是在<code>&lt;head&gt;</code>标签中加入<code>style</code>标签，具体如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-tag">table</span> <span class="selector-tag">tr</span> <span class="selector-tag">td</span>,<span class="selector-tag">th</span>&#123;<span class="attribute">border</span>:<span class="number">1px</span> solid <span class="number">#000</span>;&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>表格标题<code>caption</code></p>
<p>表格摘要用属性表示，<code>&lt;table summary=“xxxxx”</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">border</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>row 1, cell 1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>row 1, cell 2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>row 2, cell 1<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span>row 2, cell 2<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>表格标签是<code>&lt;tr&gt;</code>，每一个单元格的标签是<code>&lt;td&gt;</code>，边框的属性是<code>border</code></p>
<h2 id="HTML无序列表"><a href="#HTML无序列表" class="headerlink" title="HTML无序列表"></a>HTML无序列表</h2><p>无序列表是一个项目的列表，此列项目使用粗体圆点（典型的小黑圆圈）进行标记。</p>
<ul>
<li>无序列表使用 <ul> 标签，每个列表项始于 <li> 标签。</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>Coffee<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>Milk<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>有序列表始于 <ol> 标签。每个列表项始于 <li> 标签。</li>
</ul>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ol</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>Coffee<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">li</span>&gt;</span>Milk<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ol</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h2><p>图片使用<code>&lt;img sec=&quot;sss.jpg&quot;&gt;</code>来表示，如果要改变鼠标滑过时的文字，加入<code>title</code>属性</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;aa.jpg&quot;</span> <span class="attr">title</span>=<span class="string">&quot;xxxx&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="HTML-表单"><a href="#HTML-表单" class="headerlink" title="HTML 表单"></a>HTML 表单</h1><p>表单用于把用户输入的数据传送到服务端</p>
<h2 id="表单语法"><a href="#表单语法" class="headerlink" title="表单语法"></a>表单语法</h2><p>语法：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>   <span class="attr">method</span>=<span class="string">&quot;传送方式&quot;</span>   <span class="attr">action</span>=<span class="string">&quot;服务器文件&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>1.<code>&lt;form&gt; ：&lt;form&gt;</code>标签是成对出现的，以<code>&lt;form&gt;</code>开始，以<code>&lt;/form&gt;</code>结束。<br>2.<code>action</code> ：浏览者输入的数据被传送到的地方,比如一个PHP页面(save.php)</p>
<p>3.<strong>method</strong> <strong>：</strong> 数据传送的方式（get&#x2F;post）。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span>    <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>   <span class="attr">action</span>=<span class="string">&quot;save.php&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;username&quot;</span>&gt;</span>用户名:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;pass&quot;</span>&gt;</span>密码:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pass&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="输入大段多行文字"><a href="#输入大段多行文字" class="headerlink" title="输入大段多行文字"></a>输入大段多行文字</h2><p>用到<code>texarea</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">textarea</span>  <span class="attr">rows</span>=<span class="string">&quot;行数&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;列数&quot;</span>&gt;</span>文本<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="复选框"><a href="#复选框" class="headerlink" title="复选框"></a>复选框</h2><p><code>ratio</code>：圆框</p>
<p><code>checkbox</code>：方框</p>
<p>如果要做到单选效果，就需要名字相同</p>
<p><code>语法：</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span>   <span class="attr">type</span>=<span class="string">&quot;radio/checkbox&quot;</span>   <span class="attr">value</span>=<span class="string">&quot;值&quot;</span>    <span class="attr">name</span>=<span class="string">&quot;名称&quot;</span>   <span class="attr">checked</span>=<span class="string">&quot;checked&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="下拉框"><a href="#下拉框" class="headerlink" title="下拉框"></a>下拉框</h2><p><code>select</code>标签，每个选项使用<code>&lt;option&gt;</code>标签</p>
<p><code>value</code>为向系统提交的值，后面的文字为显示的内容</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;save.php&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>爱好:<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;看书&quot;</span>&gt;</span>看书<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;旅游&quot;</span>&gt;</span>旅游<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;运动&quot;</span>&gt;</span>运动<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;购物&quot;</span>&gt;</span>购物<span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>提交按钮：<code>&lt;input type=&quot;submit&quot; value=&quot;提交&quot;/&gt;</code></li>
<li>重置按钮：<code>&lt;input type=&quot;reset&quot; value=&quot;重置&quot;&gt;</code></li>
</ul>
<h2 id="label"><a href="#label" class="headerlink" title="label"></a>label</h2><p><code>&lt;label&gt;</code>：作用是点击文字时也可以选定复选框，不需要移动到框那里</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>网页</tag>
      </tags>
  </entry>
  <entry>
    <title>Java学习路线</title>
    <url>/2020/05/12/Java%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF/</url>
    <content><![CDATA[<p>b站codeSheep这个up主，最近更新了一期关于Java语言的学习路线，包含语言基础，算法与数据结构，开发工具，应用框架，运维知识等方面，感觉比较全面，因此记录下来，以备后续学习参考。</p>
<span id="more"></span>

<p>内容覆盖比较全，对于框架部分，每个方面只去掌握最出名的那一个或两个就行了，没有必要每个框架都去学。</p>
<p>这么多内容看完时间比较长，给自己打个气，困难任务只要拆分成小模块，可执行性就会大幅度增强，完成也会变得比较容易。</p>
<p>整理一下薄弱环节</p>
<ol>
<li>语言基础：异常、泛型</li>
<li>JVM：全部</li>
<li>并发&#x2F;多线程：全部</li>
<li>SQL：语言，锁</li>
<li>设计模式：全部</li>
</ol>
<p>整个内容比较多，如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/Java%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF.png"></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>JS Promise用法</title>
    <url>/2018/06/05/JS-Promise%E7%94%A8%E6%B3%95/</url>
    <content><![CDATA[<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>Promise对象就是一个异步调用的对象，有两个参数<code>resolve</code>和<code>reject</code>，执行调用成功的情况下使用resolve，失败的时候使用<code>reject</code>。</p>
<span id="more"></span>

<p>在keystroke项目中，我用到了下面这个例子</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">registerKeystroke</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> username = $(<span class="string">&#x27;#id_username&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">var</span> password = $(<span class="string">&#x27;#id_password&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_sendRequest</span>(<span class="string">&#x27;/pc_data/&#x27;</span>, &#123;<span class="string">&#x27;username&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function"><span class="params">res1</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;res1:&#x27;</span> + res1);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_change_status</span>(res1.<span class="title function_">toString</span>());</span><br><span class="line">        <span class="keyword">return</span> res1;</span><br><span class="line">    &#125;)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">res2</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;res2:&#x27;</span> + res2);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_sendRequest</span>(<span class="string">&#x27;/server/register_keystroke/&#x27;</span>, &#123;</span><br><span class="line">            <span class="string">&#x27;login&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password, <span class="string">&quot;login_timestamps&quot;</span>: <span class="variable language_">this</span>.<span class="property">_loginInput</span>.<span class="property">timeStamps</span>,</span><br><span class="line">            <span class="string">&quot;password_timestamps&quot;</span>: <span class="variable language_">this</span>.<span class="property">_passwordInput</span>.<span class="property">timeStamps</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">             )</span><br><span class="line">        .<span class="title function_">then</span>(</span><br><span class="line">        <span class="function"><span class="params">res3</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;res3:&#x27;</span> + res3);</span><br><span class="line">            <span class="keyword">return</span> res3;</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="title function_">_sendRequest</span>(<span class="params">url, data</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">            $.<span class="title function_">post</span>(</span><br><span class="line">                url,</span><br><span class="line">                <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data),</span><br><span class="line">                <span class="function">(<span class="params">data</span>) =&gt;</span> <span class="title function_">resolve</span>(data),</span><br><span class="line">                <span class="string">&#x27;json&#x27;</span></span><br><span class="line">            );</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先发送第一个请求到<code>/pc_data/</code>，如果成功，再发送一个到<code>/server/register_keystroke/</code>，</p>
<p>ES6原生提供了Promise对象。所谓Promise对象，就是代表了未来某个将要发生的事件（通常是一个异步操作）。它的好处在于，有了Promise对象，就可以将异步操作以同步操作的流程表达出来，避免了层层嵌套的回调函数。此外，Promise对象还提供了一整套完整的接口，使得可以更加容易地控制异步操作。Promise对象的概念的详细解释，请参考<a href="http://javascript.ruanyifeng.com/">《JavaScript标准参考教程》</a>。</p>
<p>ES6的Promise对象是一个构造函数，用来生成Promise实例。下面是Promise对象的基本用法。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* 异步操作成功 */</span>)&#123;</span><br><span class="line">    <span class="title function_">resolve</span>(value);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="title function_">reject</span>(error);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">promise.<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="comment">// success</span></span><br><span class="line">&#125;, <span class="keyword">function</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="comment">// failure</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面代码表示，Promise构造函数接受一个函数作为参数，该函数的两个参数分别是resolve方法和reject方法。如果异步操作成功，则用resolve方法将Promise对象的状态变为“成功”（即从pending变为resolved）；如果异步操作失败，则用reject方法将状态变为“失败”（即从pending变为rejected）。</p>
<p>promise实例生成以后，可以用then方法分别指定resolve方法和reject方法的回调函数。</p>
<p>下面是一个使用Promise对象的简单例子。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">timeout</span>(<span class="params">ms</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">setTimeout</span>(resolve, ms);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">timeout</span>(<span class="number">100</span>).<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;done&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面代码的timeout方法返回一个Promise实例对象，表示一段时间以后改变自身状态，从而触发then方法绑定的回调函数。</p>
<p> 下面是一个用Promise对象实现的Ajax操作的例子。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> getJSON = <span class="keyword">function</span>(<span class="params">url</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> promise = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    client.<span class="title function_">open</span>(<span class="string">&quot;GET&quot;</span>, url);</span><br><span class="line">    client.<span class="property">onreadystatechange</span> = handler;</span><br><span class="line">    client.<span class="property">responseType</span> = <span class="string">&quot;json&quot;</span>;</span><br><span class="line">    client.<span class="title function_">setRequestHeader</span>(<span class="string">&quot;Accept&quot;</span>, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">    client.<span class="title function_">send</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">handler</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">              <span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">response</span>);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="variable language_">this</span>.<span class="property">statusText</span>));</span><br><span class="line">          &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> promise;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/posts.json&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">json</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Contents: &#x27;</span> + json);</span><br><span class="line">&#125;, <span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;出错了&#x27;</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p> 上面代码中，<code>resolve</code>方法和<code>reject</code>方法调用时，都带有参数。它们的参数会被传递给回调函数。<code>reject</code>方法的参数通常是<code>Error</code>对象的实例，而<code>resolve</code>方法的参数除了正常的值以外，还可能是另一个Promise实例，比如像下面这样。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>)&#123;</span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p2 = <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">resolve, reject</span>)&#123;</span><br><span class="line">  <span class="comment">// ... some code</span></span><br><span class="line">  <span class="title function_">resolve</span>(p1);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>上面代码中，<code>p1</code>和<code>p2</code>都是Promise的实例，但是<code>p2</code>的<code>resolve</code>方法将<code>p1</code>作为参数，这时<code>p1</code>的状态就会传递给<code>p2</code>。如果调用的时候，<code>p1</code>的状态是pending，那么<code>p2</code>的回调函数就会等待p1的状态改变；如果p1的状态已经是fulfilled或者rejected，那么p2的回调函数将会立刻执行。</p>
<h2 id="Promise-prototype-then方法：链式操作"><a href="#Promise-prototype-then方法：链式操作" class="headerlink" title="Promise.prototype.then方法：链式操作"></a>Promise.prototype.then方法：链式操作</h2><p>Promise.prototype.then方法返回的是一个新的Promise对象，因此可以采用链式写法。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/posts.json&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">json</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> json.<span class="property">post</span>;</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">post</span>) &#123;</span><br><span class="line">  <span class="comment">// proceed</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>上面的代码使用then方法，依次指定了两个回调函数。第一个回调函数完成以后，会将返回结果作为参数，传入第二个回调函数。</p>
<p>如果前一个回调函数返回的是Promise对象，这时后一个回调函数就会等待该Promise对象有了运行结果，才会进一步调用。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/post/1.json&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">post</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getJSON</span>(post.<span class="property">commentURL</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">comments</span>) &#123;</span><br><span class="line">  <span class="comment">// 对comments进行处理</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这种设计使得嵌套的异步操作，可以被很容易得改写，从回调函数的“横向发展”改为“向下发展”。</p>
<h2 id="Promise-prototype-catch方法：捕捉错误"><a href="#Promise-prototype-catch方法：捕捉错误" class="headerlink" title="Promise.prototype.catch方法：捕捉错误"></a>Promise.prototype.catch方法：捕捉错误</h2><p>Promise.prototype.catch方法是Promise.prototype.then(null, rejection)的别名，用于指定发生错误时的回调函数。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/posts.json&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">posts</span>) &#123;</span><br><span class="line">  <span class="comment">// some code</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="comment">// 处理前一个回调函数运行时发生的错误</span></span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发生错误！&#x27;</span>, error);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Promise对象的错误具有“冒泡”性质，会一直向后传递，直到被捕获为止。也就是说，错误总是会被下一个catch语句捕获。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">getJSON</span>(<span class="string">&quot;/post/1.json&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">post</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getJSON</span>(post.<span class="property">commentURL</span>);</span><br><span class="line">&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">comments</span>) &#123;</span><br><span class="line">  <span class="comment">// some code</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">error</span>) &#123;</span><br><span class="line">  <span class="comment">// 处理前两个回调函数的错误</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="Promise-all方法，Promise-race方法"><a href="#Promise-all方法，Promise-race方法" class="headerlink" title="Promise.all方法，Promise.race方法"></a>Promise.all方法，Promise.race方法</h2><p>Promise.all方法用于将多个Promise实例，包装成一个新的Promise实例。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var p = Promise.all([p1,p2,p3]);</span><br></pre></td></tr></table></figure>

<p>上面代码中，Promise.all方法接受一个数组作为参数，p1、p2、p3都是Promise对象的实例。（Promise.all方法的参数不一定是数组，但是必须具有iterator接口，且返回的每个成员都是Promise实例。）</p>
<p>p的状态由p1、p2、p3决定，分成两种情况。</p>
<p>（1）只有p1、p2、p3的状态都变成fulfilled，p的状态才会变成fulfilled，此时p1、p2、p3的返回值组成一个数组，传递给p的回调函数。</p>
<p>（2）只要p1、p2、p3之中有一个被rejected，p的状态就变成rejected，此时第一个被reject的实例的返回值，会传递给p的回调函数。</p>
<p>下面是一个具体的例子。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 生成一个Promise对象的数组</span></span><br><span class="line"><span class="keyword">var</span> promises = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">11</span>, <span class="number">13</span>].<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">id</span>)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title function_">getJSON</span>(<span class="string">&quot;/post/&quot;</span> + id + <span class="string">&quot;.json&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="title class_">Promise</span>.<span class="title function_">all</span>(promises).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">posts</span>) &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;).<span class="title function_">catch</span>(<span class="keyword">function</span>(<span class="params">reason</span>)&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Promise.race方法同样是将多个Promise实例，包装成一个新的Promise实例。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">race</span>([p1,p2,p3]);</span><br></pre></td></tr></table></figure>

<p>上面代码中，只要p1、p2、p3之中有一个实例率先改变状态，p的状态就跟着改变。那个率先改变的Promise实例的返回值，就传递给p的返回值。</p>
<p>如果Promise.all方法和Promise.race方法的参数，不是Promise实例，就会先调用下面讲到的Promise.resolve方法，将参数转为Promise实例，再进一步处理。</p>
<h2 id="Promise-resolve方法，Promise-reject方法"><a href="#Promise-resolve方法，Promise-reject方法" class="headerlink" title="Promise.resolve方法，Promise.reject方法"></a>Promise.resolve方法，Promise.reject方法</h2><p>有时需要将现有对象转为Promise对象，Promise.resolve方法就起到这个作用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var jsPromise = Promise.resolve($.ajax(&#x27;/whatever.json&#x27;));</span><br></pre></td></tr></table></figure>

<p>上面代码将jQuery生成deferred对象，转为一个新的ES6的Promise对象。</p>
<p>如果Promise.resolve方法的参数，不是具有then方法的对象（又称thenable对象），则返回一个新的Promise对象，且它的状态为fulfilled。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;Hello&#x27;</span>);</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">s</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Hello</span></span><br></pre></td></tr></table></figure>

<p>上面代码生成一个新的Promise对象的实例p，它的状态为fulfilled，所以回调函数会立即执行，Promise.resolve方法的参数就是回调函数的参数。</p>
<p>如果Promise.resolve方法的参数是一个Promise对象的实例，则会被原封不动地返回。</p>
<p>Promise.reject(reason)方法也会返回一个新的Promise实例，该实例的状态为rejected。Promise.reject方法的参数reason，会被传递给实例的回调函数。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p = <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="string">&#x27;出错了&#x27;</span>);</span><br><span class="line"></span><br><span class="line">p.<span class="title function_">then</span>(<span class="literal">null</span>, <span class="keyword">function</span> (<span class="params">s</span>)&#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(s)</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 出错了</span></span><br></pre></td></tr></table></figure>

<p>上面代码生成一个Promise对象的实例p，状态为rejected，回调函数会立即执行。</p>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>React与Django连接</title>
    <url>/2018/06/09/React%E4%B8%8EDjango%E8%BF%9E%E6%8E%A5/</url>
    <content><![CDATA[<p>React构建好了前端网页，那么后端该如何使用这个前端网页呢，就需要用到下面介绍的方法</p>
<h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><p>首先处理Django方面的问题</p>
<span id="more"></span>

<ul>
<li>安装virtualenv的管理包virtualenvwrapper<code>，</code>pip install virtualenvwrapper&#96;. </li>
<li>创建virtualenv，<code>mkvirtualenv name-of-virtual-env </code></li>
<li>创建Django项目，<code>django-admin startproject nameOfProject </code></li>
<li>建立app，<code>django-admin startapp mynewapp </code></li>
<li>把<em>mynewapp</em>加入到<em>settings.py</em>中</li>
</ul>
<h2 id="React"><a href="#React" class="headerlink" title="React"></a>React</h2><p>首先安装nodejs和npm，然后：</p>
<ul>
<li>安装<code>create-react-app</code>包<code>create-react-app </code></li>
<li>建立一个新的前端app，<code>create-react-app name-of-project</code></li>
<li>把这个React app拷贝到Django目录下</li>
<li>修改<code>package.json</code>，添加<code> &quot;homepage&quot;: &quot;.&quot;</code></li>
<li><code>npm start</code>调试前端目录</li>
<li>直到效果完全ok之后打包前端文件<code>npm run build</code>得到一个build文件夹</li>
</ul>
<h2 id="Django-settings修改"><a href="#Django-settings修改" class="headerlink" title="Django settings修改"></a>Django settings修改</h2><p>然后是修改Django <em>settings.py</em>文件，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#更改模板文件夹</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line">TEMPLATES = [</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;DIRS&#x27;</span>: [</span><br><span class="line">      os.path.join(BASE_DIR, <span class="string">&#x27;build&#x27;</span>)</span><br><span class="line">    ],</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br><span class="line"><span class="comment">#更改静态文件夹</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">  os.path.join(BASE_DIR, <span class="string">&#x27;build/static&#x27;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>然后再url中配置好url就可以run server进行访问了</p>
]]></content>
      <categories>
        <category>网页</category>
      </categories>
      <tags>
        <tag>Django</tag>
        <tag>React</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring AOP的实现机制</title>
    <url>/2019/12/11/Spring-AOP%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/</url>
    <content><![CDATA[<p>spring aop属于第二代AOP，采用动态代理和字节码生成技术实现。所谓第一代AOP技术，就是在代码编译的时候，为需要添加aop功能的类，直接编译到系统的静态类中，也被称为静态aop。</p>
<p>要了解spring的aop实现方法，就要先了解一个设计模式：代理模式</p>
<span id="more"></span>

<h3 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h3><p>既然这个模式的名字叫做代理模式，那么肯定就有一个代理，简单来说，买房的时候，有房产代理，由代理分别接触房东和客户，而买卖双方不接触。在软件系统当中，这个模式被称为代理模式</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191211171814.png"></p>
<p>如图所示，代理模式有一个proxy代理，当client想要访问Isubject这个接口的时候，需要通过subjectProxy这个代理进行访问，这个代理持有一个Isubject的实例。</p>
<p>这样看上去，访问的过程中间加上代理似乎多此一举，但是实际上代理模式的最大的作用，在于对请求添加更多访问限制。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubjectProxy</span> <span class="keyword">implements</span> <span class="title class_">Isubject</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ISubject subject;</span><br><span class="line">    <span class="keyword">public</span> String request&#123;</span><br><span class="line">        <span class="comment">// add logic</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">originalResult</span> <span class="operator">=</span> subject.request();</span><br><span class="line">        <span class="comment">// add logic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，SubjectProxy类中的request方法，对原有的request方法的前后可以添加逻辑，比如，你可以限制只有在某一特定时间，接口才可用，其余时间直接返回null。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ServiceControlSubjectProxy</span> <span class="keyword">implements</span> <span class="title class_">Isubject</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ISubject subject;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ServiceControlSubjectProxy</span><span class="params">(ISubject s)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.subject = s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String request&#123;</span><br><span class="line">		<span class="type">TimeOfDay</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">        <span class="type">TimeOfDay</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>(<span class="number">5</span>,<span class="number">59</span>,<span class="number">59</span>);</span><br><span class="line">        <span class="type">TimeOfDay</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>();</span><br><span class="line">		<span class="keyword">if</span> (currentTime.isAfter(startTime)  &amp;&amp; currentTime.isBofore(endTime))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">originalResult</span> <span class="operator">=</span> subject.request();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;proxy: &quot;</span> + originalResult;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体使用的时候，我们就可以用ServiceControlSubjectProxy代替SubjectImpl来使用，如下所示</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Isubject</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SubjectImpl</span>();</span><br><span class="line"><span class="type">Isubject</span> <span class="variable">finalSubject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServiceControlSubjectProxy</span>(target);</span><br><span class="line">finalSubject.request();</span><br></pre></td></tr></table></figure>

<p>这样就实现了一个代理模式来限制接口的访问时间，但是如果还有一个类，IRequetable接口，同样要限制时间，那么是不是也要新建一个<code>ServiceControlSubjectProxy</code>呢，这样有多少个服务需要限制，就要新建多少个类来实现对应的接口，尽管他们的逻辑是一模一样的。显然这样的效率会比较低，解决这个问题的方法称为动态代理。</p>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>动态代理是在JDK1.3之后引入的，这个机制康有为指定的接口在系统运行期间动态的生成代理对象。动态代理机制的实现主要由一个类和一个接口组成，即<code>java.lang.reflect.Proxy</code>类和<code>java.lang.reflect.InvocationHandler</code>接口。</p>
<p>下面我们将使用动态代理来实现限制ISubject和IRequestable两个接口的限制接口时间的功能。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestCtrolInovationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RequestCtrolInovationHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;request&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">TimeOfDay</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="type">TimeOfDay</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>(<span class="number">5</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line">            <span class="type">TimeOfDay</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>();</span><br><span class="line">            <span class="keyword">if</span> (currentTime.isAfter(startTime) &amp;&amp; currentTime.isBofore(endTime)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> method.invoke(target, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后使用Proxy类，根据RequestCtrolInovationHandler的逻辑，为ISubject和IRequestable两个类生成对应的代理实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ISubject</span> <span class="variable">subject</span> <span class="operator">=</span> (ISubject) Proxy.newProxyInstance(ProxyRunner.class.getClassLoader), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Isubject.class&#125;, <span class="keyword">new</span> <span class="title class_">RequestCtrlInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">SubjectImpl</span>());</span><br><span class="line"></span><br><span class="line">subject.request();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">IRequestable</span> <span class="variable">requestable</span> <span class="operator">=</span> (IRequestable) Proxy.newProxyInstance(ProxyRunner.class.getClassLoader), <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;IRequestable.class&#125;, <span class="keyword">new</span> <span class="title class_">RequestCtrlInvocationHandler</span>(<span class="keyword">new</span> <span class="title class_">RequestableImpl</span>());</span><br><span class="line"></span><br><span class="line">subject.request();</span><br></pre></td></tr></table></figure>

<p>动态代理虽然效果好，但是并不能满足所有的需求，因为动态代理只能对实现了interface的类进行代理（因为目标类和代理类都向上转型成接口类，这样代理类就可以持有目标类的接口），如果一个类没有实现任何接口，那么就不能使用动态代理，只能使用动态字节码生成。</p>
<h3 id="动态字节码生成"><a href="#动态字节码生成" class="headerlink" title="动态字节码生成"></a>动态字节码生成</h3><p>原理：对目标对象进行集成，生成相应的子类，子类通过覆写来扩展父类的行为，将横切逻辑放到子类中，让系调用扩展后的目标对象的子类，就达到了和代理模式一样的效果。</p>
<p>使用集成的方式来扩展对象定义，不能像静态代理那样，为每个类生成一个子类，因此要借助CGLIB这样的动态字节码生成库，在系统运行期间动态的为目标对象生成相应的扩展子类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Requestable</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">request</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;excute request in requestable&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对Requestable进行扩展，首先需要实现一个<code>net.sf.cglib.proxy.Callback</code>，不过更多时候直接用<code>net.sf.cglib.proxy.MethodInterceptor</code>接口（MethodInterceptor扩展了Callback接口）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestCtrlCallback</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object o, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="keyword">if</span> (method.getName().equals(<span class="string">&quot;request&quot;</span>)) &#123;</span><br><span class="line">            <span class="type">TimeOfDay</span> <span class="variable">startTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            <span class="type">TimeOfDay</span> <span class="variable">endTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>(<span class="number">5</span>, <span class="number">59</span>, <span class="number">59</span>);</span><br><span class="line">            <span class="type">TimeOfDay</span> <span class="variable">currentTime</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimeOfDay</span>();</span><br><span class="line">            <span class="keyword">if</span> (currentTime.isAfter(startTime) &amp;&amp; currentTime.isBofore(endTime)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> methodProxy.invokeSuper(o, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>RequestCtrlCallback</code>实现了对<code>request()</code>方法请求进行访问控制的逻辑，我们现在通过CGLIB的Enhancer为目标对象动态地生成一个子类，并将<code>RequestCtrlCallback</code>中的横切逻辑添加到子类中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Enhancer enhancer = new Enhancer();</span><br><span class="line">enhancer.setSupercalss(Requestable.class);</span><br><span class="line">enhancer.setCallback(new RequestCtrlCallback());</span><br><span class="line"></span><br><span class="line">Requestable proxy = (Requestable) enhancer.create();</span><br><span class="line">proxy.request();</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
        <category>Spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring boot 入门</title>
    <url>/2018/09/18/Spring-boot-%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>SpringBoot其实就是Spring的简化版本，因为Spring依赖的项目太多，其xml文件的配置显得尤为繁琐，因此出现了一键配置的SpringBoot框架</p>
<span id="more"></span>

<h3 id="SpringBoot项目生成方法"><a href="#SpringBoot项目生成方法" class="headerlink" title="SpringBoot项目生成方法"></a>SpringBoot项目生成方法</h3><p>在idea中构建一个springboot项目的方法如下：</p>
<ol>
<li>点击new-&gt;project-&gt;Spring initializr，选好java版本后点击下一步</li>
<li>配置项目的名称等信息，点击下一步</li>
<li>在可选插件中选择需要的插件，一般来说只用选择web-&gt;web就行了</li>
<li>最后输入项目名称点击结束即可生成项目</li>
</ol>
<h3 id="运行方法"><a href="#运行方法" class="headerlink" title="运行方法"></a>运行方法</h3><p>一共有3种方法</p>
<ol>
<li>通过idea运行：直接在idea中找到java主文件，然后点击run，即可运行</li>
<li>用maven启动：<code>mvn  spring-boot:run</code></li>
<li>通过maven编译成jar后启动：<code>mvn install</code>-&gt;<code>java -jar xxx.jar</code></li>
</ol>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>有两种配置文件的配置方法：</p>
<ol>
<li><p>applicaiton.properties：就是直接赋值的方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line">server.servlet.context-path=/girl</span><br></pre></td></tr></table></figure>
</li>
<li><p>applicaiton.yml：以yaml格式进行配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8081</span><br><span class="line">  servlet:</span><br><span class="line">    context-path: /girl</span><br></pre></td></tr></table></figure></li>
</ol>
<p>在配置文件中还可以加入一些自定义的内容，比如一些变量的值，然后在网页中使用，比如我们加入身高Height</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">Height:</span> <span class="number">165</span></span><br></pre></td></tr></table></figure>

<p>然后在新建的<code>HelloControler.java</code>类中打印这个变量</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloControler</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;height&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String height;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以把配置写到一个类里面：</p>
<ol>
<li><p>现在yml配置文件中写入配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">girl:</span></span><br><span class="line">  <span class="attr">Height:</span> <span class="number">165</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">18</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>新建一个用于存放这些变量类，<code>GirlProperties.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;girl&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlProperties</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String Height;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHeight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHeight</span><span class="params">(String height)</span> &#123;</span><br><span class="line">        Height = height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在需要调用的类里面新建一个对象<code>GirlProperties</code>，用<code>@Autowired</code>（自动装配）关键字修饰</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloControler</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    GirlProperties girlProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> girlProperties.getHeight() + girlProperties.getAge();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="多个配置文件切换"><a href="#多个配置文件切换" class="headerlink" title="多个配置文件切换"></a>多个配置文件切换</h3><p>建立多个配置文件，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">application.yml</span><br><span class="line">application-dev.yml</span><br><span class="line">application-prod.yml</span><br></pre></td></tr></table></figure>

<p>在dev和prod两个文件中分别填上需要的配置，然后在applicaiton.yml中指定需要激活的配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<h3 id="Controller的使用"><a href="#Controller的使用" class="headerlink" title="Controller的使用"></a>Controller的使用</h3><p>controller是用来处理http请求的</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>@Controller</code></td>
<td>处理http请求</td>
</tr>
<tr>
<td><code>@RestController</code></td>
<td>Spring4之后的注解，原来返回json需要<code>@ResponseBody</code>配合<code>@Controller</code></td>
</tr>
<tr>
<td><code>@RequestMapping</code></td>
<td>配置url映射</td>
</tr>
</tbody></table>
<p>还有几个参数注解</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td><code>@PathVariable</code></td>
<td>获取url中的数据</td>
</tr>
<tr>
<td><code>@RequestParam</code></td>
<td>获取请求参数的值</td>
</tr>
<tr>
<td><code>@GetMapping</code></td>
<td>组合注解</td>
</tr>
</tbody></table>
<p><code>@PathVariable</code>用法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloControler</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello/&#123;id&#125;&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer myid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;id: &quot;</span>+myid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@RequestParam</code>用法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloControler</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/hello&quot;,method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">say</span><span class="params">(<span class="meta">@RequestParam(&quot;id&quot;)</span> Integer myid)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;id: &quot;</span>+myid;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当你访问<code>http://127.0.0.1:8080/hello?id=12233</code>即可与得到显示id的页面</p>
<p><code>@GetMapping</code>等同于将上面的<code>@RequestMapping(value = &quot;/hello&quot;,method = RequestMethod.GET)</code>简化，此时只需要填一个值就好了，方法已经设置为get了</p>
<h3 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a>数据库操作</h3><p>现在pom.xml中添加mysql的依赖，注意，这里要在idea的设置中，将maven的设置加上<code>always update snapshot</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后再在<code>application.yml</code>中加入对mysql的配置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://127.0.0.1:3306/dbgirl</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">create</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>此时只需要建立一个Girl类，在其中加入<code>id</code>,<code>height</code>,<code>age</code>等字段，即可运行时自动生成表，注意：最上面要加入<code>@Entity</code>，id要自增的话要加入<code>@Id</code>,<code>@GeneratedValue</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Girl</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Integer height;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Girl</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(Integer age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getHeight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHeight</span><span class="params">(Integer height)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="对数据库的增删改查"><a href="#对数据库的增删改查" class="headerlink" title="对数据库的增删改查"></a>对数据库的增删改查</h3><p>在<code>GirlController.java</code>这个类里面进行增删改查，要创建一个专用的<code>GirlRepository.java</code>类用于操作数据库</p>
<p><code>GirlRepository.java</code>是一个接口类，继承自<code>JpaRepository</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GirlRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;Girl,Integer&gt; &#123;</span><br><span class="line">    <span class="comment">//通过年龄来查询</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Girl&gt; <span class="title function_">findByAge</span><span class="params">(Integer age)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>GirlController.java</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GirlRepository girlRepository;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询所有女生的列表</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/girls&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Girl&gt; <span class="title function_">girllist</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> girlRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 为女神的身高，年龄赋值</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> height</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> age</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/girls&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Girl <span class="title function_">girlAdd</span><span class="params">(<span class="meta">@RequestParam(&quot;height&quot;)</span> Integer height,</span></span><br><span class="line"><span class="params">                        <span class="meta">@RequestParam(&quot;age&quot;)</span> Integer age</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line">        <span class="type">Girl</span> <span class="variable">girl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Girl</span>();</span><br><span class="line">        girl.setAge(age);</span><br><span class="line">        girl.setHeight(height);</span><br><span class="line">        <span class="keyword">return</span> girlRepository.save(girl);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询一个女生</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/girls/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Optional&lt;Girl&gt; <span class="title function_">findGirlById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> girlRepository.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过年龄查询</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/girls/age/&#123;age&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Girl&gt; <span class="title function_">findGirlByAge</span><span class="params">(<span class="meta">@PathVariable(&quot;age&quot;)</span> Integer age)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> girlRepository.findByAge(age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//更新</span></span><br><span class="line">    <span class="meta">@PutMapping(&quot;/girls/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Girl <span class="title function_">girlUpdate</span><span class="params">(<span class="meta">@RequestParam(&quot;height&quot;)</span> Integer height,</span></span><br><span class="line"><span class="params">                           <span class="meta">@RequestParam(&quot;age&quot;)</span> Integer age, <span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">Girl</span> <span class="variable">girl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Girl</span>();</span><br><span class="line">        girl.setId(id);</span><br><span class="line">        girl.setHeight(height);</span><br><span class="line">        girl.setAge(age);</span><br><span class="line">        <span class="keyword">return</span> girlRepository.save(girl);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//删除</span></span><br><span class="line">    <span class="meta">@DeleteMapping(&quot;/girls/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delGirl</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Integer id)</span> &#123;</span><br><span class="line">        <span class="type">Girl</span> <span class="variable">girl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Girl</span>();</span><br><span class="line">        girl.setId(id);</span><br><span class="line">        girlRepository.delete(girl);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h3><p>比如我们同时操作多条数据，有可能会失败，但是前面那些我希望已经插入的可以回滚到未插入的状态。</p>
<p>也就是说，我们要求插入多条数据的时候，要么同时插入，要么一条也不插入。</p>
<p>此时用到<code>Transactional</code>关键字，新建一个<code>GirlService.java</code></p>
<p><code>GirlService.java</code>，在事务操作前面加上<code>@Transactional</code>关键字</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon.demo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> javax.transaction.Transactional;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GirlService</span> &#123;</span><br><span class="line">    GirlRepository girlRepository;</span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertTwo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Girl</span> <span class="variable">girlA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Girl</span>();</span><br><span class="line">        girlA.setAge(<span class="number">10</span>);</span><br><span class="line">        girlA.setHeight(<span class="number">100</span>);</span><br><span class="line">        girlRepository.save(girlA);</span><br><span class="line"></span><br><span class="line">        <span class="type">Girl</span> <span class="variable">girlB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Girl</span>();</span><br><span class="line">        girlB.setAge(<span class="number">20</span>);</span><br><span class="line">        girlB.setHeight(<span class="number">200</span>);</span><br><span class="line">        girlRepository.save(girlB);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在controller里面调用这个service</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//添加2个girl</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/girls/two&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">girlAddTwo</span><span class="params">()</span>&#123;</span><br><span class="line">    girlService.insertTwo();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h3><p>验证表单的值是否满足要求，不满足要求的时候终止提交</p>
<p>比如在girl项目中，我们限制年龄小于18的进入，在<code>Girl.java</code>中定义如下内容：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Girl</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">        <span class="meta">@Min(value = 18, message = &quot;未成年禁止入内&quot;)</span></span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line">    ...&#125;</span><br></pre></td></tr></table></figure>
<p>用<code>@valid</code>进行验证，返回BindingResult验证结果，用<code>BindingResult.hasErrors()</code>方法检测有没有错误，有错误就直接返回null</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(&quot;/girls&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Girl <span class="title function_">girlAdd</span><span class="params">(<span class="meta">@Valid</span> Girl girl, BindingResult bindingResult</span></span><br><span class="line"><span class="params">    )</span> &#123;</span><br><span class="line"><span class="comment">//        Girl girl = new Girl();</span></span><br><span class="line">        <span class="keyword">if</span> (bindingResult.hasErrors())&#123;</span><br><span class="line">            System.out.println(bindingResult.getFieldError().getDefaultMessage());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        girl.setAge(girl.getAge());</span><br><span class="line">        <span class="keyword">if</span> (girl.getHeight() != <span class="literal">null</span>) &#123;</span><br><span class="line">            girl.setHeight(girl.getHeight());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            girl.setHeight(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> girlRepository.save(girl);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用AOP（Aspect-Oriented-Programming）处理请求"><a href="#使用AOP（Aspect-Oriented-Programming）处理请求" class="headerlink" title="使用AOP（Aspect Oriented Programming）处理请求"></a>使用AOP（Aspect Oriented Programming）处理请求</h3><p>AOP是一种编程思想，意思是面向切面编程</p>
<p>AOP主要思想是将通用模块独立出来，以便代码复用</p>
<p>比如我们要对所有的内容写入log，我们此时只需要建立一个HttpAspect类，使用aspect之前先在<code>pom.xml</code>中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后建立一个aspect文件夹，在其中加入httpAspect类，用<code>@Aspect</code>和<code>@component</code>注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Before(&quot;execution(public * com.drawon.demo.controller.GirlController.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="number">111111</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After(&quot;execution(public * com.drawon.demo.controller.GirlController.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfter</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="number">22222</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Before(&quot;execution(public * com.drawon.demo.controller.GirlController.*(..))&quot;)</code>保证了监听所有<code>GirlController</code>类中的方法，一定要写<code>*(..)</code>，不然不会监听所有函数</p>
<p>上面这段aspect的代码，其中的before和after注解后面的内容很长，并且重复了，我们想要增加代码复用性，简洁性，我们要把这一段抽出来，用<code>pointcut</code>关键字来表示，pointcut是切面编程中要切的点。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpAspect</span> &#123;</span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public * com.drawon.demo.controller.GirlController.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Before(&quot;log()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="number">11111</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@After(&quot;log()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfter</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="number">22222</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们需要将之前的<code>system.out.println</code>修改为spring自带的log模块来打印</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HttpAspect</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(HttpAspect.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Pointcut(&quot;execution(public * com.drawon.demo.controller.GirlController.*(..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">log</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before(&quot;log()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doBefore</span><span class="params">(JoinPoint joinPoint)</span> &#123;</span><br><span class="line">        <span class="type">ServletRequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">request</span> <span class="operator">=</span> attributes.getRequest();</span><br><span class="line">        <span class="comment">//记录url</span></span><br><span class="line">        logger.info(<span class="string">&quot;url=&#123;&#125;&quot;</span>, request.getRequestURI());</span><br><span class="line">        <span class="comment">//记录method</span></span><br><span class="line">        logger.info(<span class="string">&quot;method=&#123;&#125;&quot;</span>, request.getMethod());</span><br><span class="line">        <span class="comment">//ip</span></span><br><span class="line">        logger.info(<span class="string">&quot;ip=&#123;&#125;&quot;</span>, request.getRemoteAddr());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//类方法</span></span><br><span class="line">        logger.info(<span class="string">&quot;class_method=&#123;&#125;&quot;</span>, joinPoint.getSignature().getDeclaringTypeName() + <span class="string">&#x27;.&#x27;</span> + joinPoint.getSignature().getName());</span><br><span class="line">        <span class="comment">//参数</span></span><br><span class="line">        logger.info(<span class="string">&quot;args=&#123;&#125;&quot;</span>, joinPoint.getArgs());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@After(&quot;log()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfter</span><span class="params">()</span> &#123;</span><br><span class="line">        logger.info(<span class="string">&quot;22222&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="comment">//记录返回的内容，需要覆写Girl.java的tostring()方法</span></span><br><span class="line">    <span class="meta">@AfterReturning(returning = &quot;object&quot;,pointcut = &quot;log()&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterReturning</span><span class="params">(Object object)</span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;response=&#123;&#125;&quot;</span>,object);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>













]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot启动的三种方式</title>
    <url>/2019/11/14/SpringBoot%E5%90%AF%E5%8A%A8%E7%9A%84%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<h3 id="方法1：通过idea的Application配置启动"><a href="#方法1：通过idea的Application配置启动" class="headerlink" title="方法1：通过idea的Application配置启动"></a>方法1：通过idea的Application配置启动</h3><p>一般通过idea创建springboot项目后，可以直接点击启动按钮进行启动项目，如果启动按钮不可用，可以新建一个配置如下，填入主类的类名后即可上传</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191114142408.png"></p>
<h3 id="方法2：通过mvn命令启动"><a href="#方法2：通过mvn命令启动" class="headerlink" title="方法2：通过mvn命令启动"></a>方法2：通过mvn命令启动</h3><p>直接通过mvn命令启动</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mvn spring-boot:run</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191114142606.png"></p>
<h3 id="方法3：打包成jar文件，通过命令行启动"><a href="#方法3：打包成jar文件，通过命令行启动" class="headerlink" title="方法3：打包成jar文件，通过命令行启动"></a>方法3：打包成jar文件，通过命令行启动</h3><p>打包的命令：<code>mvn clean install</code></p>
<p>然后打开target文件夹，会找到跟项目同名的jar文件，通过<code>java -jar xxx.jar</code>即可启动项目</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191114142737.png"></p>
]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot多环境配置文件</title>
    <url>/2019/11/14/SpringBoot%E5%A4%9A%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<p>SpringBoot可以根据环境不同设置多个配置文件，比如可以设置<code>application-dev.yml</code>配置，就是开发环境，<code>application-prod.yml</code>配置就是生产环境</p>
<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191114141224.png" width="50%" height="50%"  style="margin: 0 auto;"/>

<p>那么系统该如何决定激活哪个文件呢？</p>
<p>在application.yml里面，设置spring.profiles.active来配置激活哪一个</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/demo</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">prod</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>JavaScript教程</title>
    <url>/2017/06/29/JavaScript%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>之前在慕课网上看了看JavaScript的教程，但是整个教程的内容不够详细，因此在廖雪峰官方网站看看关于js的教程，并重新学习和记录如下。</p>
<p>js用于在静态HTML页面上添加一些动态效果 ，网景公司的Brendan Eich这哥们在两周之内设计出了JavaScript语言 。为了让js称为全球标砖，欧洲计算机制造协会(European Computer Manufacturers Association)制定了js的标准，称为RCMAscript标准，最新版ECMAscript 6标准于2015年6月发布（简称ES6)。</p>
<span id="more"></span>

<h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><p>js代码一般放在<code>&lt;head&gt;</code>当中，由封闭的<code>&lt;script&gt;...&lt;/script&gt;</code>包含起来</p>
<p>第二种是将js放在一个单独的js文件中，然后在head中声明该文件</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/static/js/abc.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>有时候会看到定义js的类型，<code>&lt;script type=&quot;text/javascript&quot;&gt;</code>，但是实际上是没有必要的，因为默认的script的类型就是javascript</p>
<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><p>每一句以分号(‘;’)结束，语句块用大括号括起来</p>
<p>&#x2F;&#x2F;表示注释，&#x2F;*…*&#x2F;也表示注释</p>
<h3 id="数据类型和变量"><a href="#数据类型和变量" class="headerlink" title="数据类型和变量"></a>数据类型和变量</h3><h4 id="Number"><a href="#Number" class="headerlink" title="Number"></a>Number</h4><p>js不区分整数和浮点数，统一用Number表示</p>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>字符串是以单引号或双引号引起来的任何文本，比如’abc’或者”xyz”。如果引号里面还有引号，那么就要用到转义字符<code>\</code>，ASCII字符可以用<code>\x##</code>表示，例如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;\x41&#x27;</span>; <span class="comment">// 完全等同于 &#x27;A&#x27;</span></span><br></pre></td></tr></table></figure>

<p>还可以用<code>\u####</code>表示一个Unicode字符：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="string">&#x27;\u4e2d\u6587&#x27;</span>; <span class="comment">// 完全等同于 &#x27;中文&#x27;</span></span><br></pre></td></tr></table></figure>

<p>多行字符串可以用反引号表示，也就是数字1左边那个键</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`多行</span></span><br><span class="line"><span class="string">字符串</span></span><br><span class="line"><span class="string">测试`</span>);</span><br></pre></td></tr></table></figure>

<p>多个字符串连接起来跟python一样用加号<code>+</code>就可以了，也可以跟shell脚本一样用变量名来代替，比如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> name = <span class="string">&#x27;小明&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> age = <span class="number">20</span>;</span><br><span class="line"><span class="keyword">var</span> message = <span class="string">`你好, <span class="subst">$&#123;name&#125;</span>, 你今年<span class="subst">$&#123;age&#125;</span>岁了!`</span>;</span><br><span class="line"><span class="title function_">alert</span>(message);</span><br></pre></td></tr></table></figure>

<h5 id="操作字符串"><a href="#操作字符串" class="headerlink" title="操作字符串"></a>操作字符串</h5><p>获取字符串长度用<code>.length</code>，如果要获取slice，跟python的list方法一样，要注意，字符串本身是不可以变动的，对某个slice赋值不会改变本身：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;Test&#x27;</span>;</span><br><span class="line">s[<span class="number">0</span>] = <span class="string">&#x27;X&#x27;</span>;</span><br><span class="line"><span class="title function_">alert</span>(s); <span class="comment">// s仍然为&#x27;Test&#x27;</span></span><br></pre></td></tr></table></figure>

<p>还有一些函数用于操作字符串</p>
<ul>
<li><p><code>toUpperCase()</code>：字符串变大写</p>
</li>
<li><p><code>toLowerCase()</code>：字符串变小写</p>
</li>
<li><p><code>indexOf()</code>：搜索指定字符串出现的位置，如果没找到则返回-1</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;hello, world&#x27;</span>;</span><br><span class="line">s.<span class="title function_">indexOf</span>(<span class="string">&#x27;world&#x27;</span>); <span class="comment">// 返回7</span></span><br><span class="line">s.<span class="title function_">indexOf</span>(<span class="string">&#x27;World&#x27;</span>); <span class="comment">// 没有找到指定的子串，返回-1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>substring()</code>：返回指定索引区间的子串，类似于python使用冒号的slice方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;hello, world&#x27;</span></span><br><span class="line">s.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">5</span>); <span class="comment">// 从索引0开始到5（不包括5），返回&#x27;hello&#x27;</span></span><br><span class="line">s.<span class="title function_">substring</span>(<span class="number">7</span>); <span class="comment">// 从索引7开始到结束，返回&#x27;world&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="布尔值"><a href="#布尔值" class="headerlink" title="布尔值"></a>布尔值</h4><p>布尔值只有true和false两种，可以直接使用true，false来表示，也可以使用布尔运算来计算出来（比如大小比较或者与或非），js的与运算是&amp;&amp;，或运算是||，非运算是!</p>
<h4 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h4><p>大小比较与其他语言没有区别，但是js有个特殊的等于比较，两个等号”&#x3D;&#x3D;”会自动转换类型之后再比较，而三个等号”&#x3D;&#x3D;&#x3D;”不会自动转换类型，由于JavaScript这个设计缺陷，<em>不要</em>使用<code>==</code>比较，始终坚持使用<code>===</code>比较。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="literal">false</span> == <span class="number">0</span>; <span class="comment">// true</span></span><br><span class="line"><span class="literal">false</span> === <span class="number">0</span>; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>还有一个问题就是NaN与任何值都不相等，包括他自己</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">NaN</span> === <span class="title class_">NaN</span>; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>唯一判断NaN的方法就是使用<code>isNaN()</code>函数</p>
<p>浮点数运算的相等比较中，由于浮点数运算会出现误差，因此计算机无法精确标识无限循环小数，要比较两个浮点数是否相等，智能计算他们之间的绝对值，看是否小于某个阈值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> / <span class="number">3</span> === (<span class="number">1</span> - <span class="number">2</span> / <span class="number">3</span>); <span class="comment">// false</span></span><br><span class="line"><span class="title class_">Math</span>.<span class="title function_">abs</span>(<span class="number">1</span> / <span class="number">3</span> - (<span class="number">1</span> - <span class="number">2</span> / <span class="number">3</span>)) &lt; <span class="number">0.0000001</span>; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<h4 id="null和undefined"><a href="#null和undefined" class="headerlink" title="null和undefined"></a>null和undefined</h4><p>null表示空值，与0和空字符串<code>&#39;&#39;</code>都是不同的，null和undefined大致类似，大多数情况下都应该用<code>null</code>，<code>undefined</code>只有在判断函数参数是否传递的情况下有用</p>
<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><p>js的数组和python的list类似，可以包含任意类型的数据，例如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br></pre></td></tr></table></figure>

<p> 另一种创建数组的方法是通过<code>Array()</code>函数实现</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);<span class="comment">// 创建了数组[1, 2, 3]</span></span><br></pre></td></tr></table></figure>

<p>更建议直接使用方括号<code>[]</code>来建立数组，数组索引也和python类似，起始索引为0</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3.14</span>, <span class="string">&#x27;Hello&#x27;</span>, <span class="literal">null</span>, <span class="literal">true</span>];</span><br><span class="line">arr[<span class="number">0</span>]; <span class="comment">// 返回索引为0的元素，即1</span></span><br><span class="line">arr[<span class="number">5</span>]; <span class="comment">// 返回索引为5的元素，即true</span></span><br><span class="line">arr[<span class="number">6</span>]; <span class="comment">// 索引超出了范围，返回undefined</span></span><br></pre></td></tr></table></figure>

<p>数组同样用length来获取长度，如果对array的length赋值的话会改变数组的内容，没有定义的内容全为undefined，如果变短则截断</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.<span class="property">length</span>; <span class="comment">// 3</span></span><br><span class="line">arr.<span class="property">length</span> = <span class="number">6</span>;</span><br><span class="line">arr; <span class="comment">// arr变为[1, 2, 3, undefined, undefined, undefined]</span></span><br><span class="line">arr.<span class="property">length</span> = <span class="number">2</span>;</span><br><span class="line">arr; <span class="comment">// arr变为[1, 2]</span></span><br></pre></td></tr></table></figure>

<p>Array可以通过索引把对应的元素改为新的值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">arr[<span class="number">1</span>] = <span class="number">99</span>;</span><br><span class="line">arr; <span class="comment">// arr现在变为[&#x27;A&#x27;, 99, &#x27;C&#x27;]</span></span><br></pre></td></tr></table></figure>

<p><em>请注意</em>，如果通过索引赋值时，索引超过了范围，同样会引起<code>Array</code>大小的变化：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr[<span class="number">5</span>] = <span class="string">&#x27;x&#x27;</span>;</span><br><span class="line">arr; <span class="comment">// arr变为[1, 2, 3, undefined, undefined, &#x27;x&#x27;]</span></span><br></pre></td></tr></table></figure>

<h5 id="indexOf"><a href="#indexOf" class="headerlink" title="indexOf"></a>indexOf</h5><p>Array也可以用indexOf来获取某个元素的位置</p>
<h5 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h5><p><code>slice()</code>对应String的<code>substring()</code>方法，用于切片</p>
<h5 id="push和pop"><a href="#push和pop" class="headerlink" title="push和pop"></a>push和pop</h5><p><code>push()</code>是在array末尾添加元素，<code>pop()</code>是把array最后一个元素返回出来</p>
<h5 id="unshift和shift"><a href="#unshift和shift" class="headerlink" title="unshift和shift"></a>unshift和shift</h5><p><code>unshift()</code>：在array头部添加若干元素</p>
<p><code>shift()</code>：将array的第一个元素删除掉并返回出来</p>
<p>unshift和shift相当于push和pop作用在array头部</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">arr.<span class="title function_">unshift</span>(<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>); <span class="comment">// 返回Array新的长度: 4</span></span><br><span class="line">arr; <span class="comment">// [&#x27;A&#x27;, &#x27;B&#x27;, 1, 2]</span></span><br><span class="line">arr.<span class="title function_">shift</span>(); <span class="comment">// &#x27;A&#x27;</span></span><br><span class="line">arr; <span class="comment">// [&#x27;B&#x27;, 1, 2]</span></span><br></pre></td></tr></table></figure>

<h5 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h5><p>对array进行排序</p>
<h5 id="reverse"><a href="#reverse" class="headerlink" title="reverse"></a>reverse</h5><p>元素顺序反转</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;one&#x27;</span>, <span class="string">&#x27;two&#x27;</span>, <span class="string">&#x27;three&#x27;</span>];</span><br><span class="line">arr.<span class="title function_">reverse</span>(); </span><br><span class="line">arr; <span class="comment">// [&#x27;three&#x27;, &#x27;two&#x27;, &#x27;one&#x27;]</span></span><br></pre></td></tr></table></figure>

<h5 id="splice"><a href="#splice" class="headerlink" title="splice"></a>splice</h5><p><code>splice()</code>是array的万能方法，可以从指定索引删除若干元素，然后从该位置再添加若干元素</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Microsoft&#x27;</span>, <span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Yahoo&#x27;</span>, <span class="string">&#x27;AOL&#x27;</span>, <span class="string">&#x27;Excite&#x27;</span>, <span class="string">&#x27;Oracle&#x27;</span>];</span><br><span class="line"><span class="comment">// 从索引2开始删除3个元素,然后再添加两个元素:</span></span><br><span class="line">arr.<span class="title function_">splice</span>(<span class="number">2</span>, <span class="number">3</span>, <span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;Facebook&#x27;</span>); <span class="comment">// 返回删除的元素 [&#x27;Yahoo&#x27;, &#x27;AOL&#x27;, &#x27;Excite&#x27;]</span></span><br><span class="line">arr; <span class="comment">// [&#x27;Microsoft&#x27;, &#x27;Apple&#x27;, &#x27;Google&#x27;, &#x27;Facebook&#x27;, &#x27;Oracle&#x27;]</span></span><br><span class="line"><span class="comment">// 只删除,不添加:</span></span><br><span class="line">arr.<span class="title function_">splice</span>(<span class="number">2</span>, <span class="number">2</span>); <span class="comment">// [&#x27;Google&#x27;, &#x27;Facebook&#x27;]</span></span><br><span class="line">arr; <span class="comment">// [&#x27;Microsoft&#x27;, &#x27;Apple&#x27;, &#x27;Oracle&#x27;]</span></span><br><span class="line"><span class="comment">// 只添加,不删除:</span></span><br><span class="line">arr.<span class="title function_">splice</span>(<span class="number">2</span>, <span class="number">0</span>, <span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;Facebook&#x27;</span>); <span class="comment">// 返回[],因为没有删除任何元素</span></span><br><span class="line">arr; <span class="comment">// [&#x27;Microsoft&#x27;, &#x27;Apple&#x27;, &#x27;Google&#x27;, &#x27;Facebook&#x27;, &#x27;Oracle&#x27;]</span></span><br></pre></td></tr></table></figure>

<h5 id="concat"><a href="#concat" class="headerlink" title="concat"></a>concat</h5><p>把两个array连接起来，并返回一个新的array</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> added = arr.<span class="title function_">concat</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]);</span><br><span class="line">added; <span class="comment">// [&#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;, 1, 2, 3]</span></span><br></pre></td></tr></table></figure>

<h5 id="join"><a href="#join" class="headerlink" title="join"></a>join</h5><p>join和python的join方法效果一样，使用方法如下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">arr.<span class="title function_">join</span>(<span class="string">&#x27;-&#x27;</span>); <span class="comment">// &#x27;A-B-C-1-2-3&#x27;</span></span><br></pre></td></tr></table></figure>

<h5 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h5><p>多维数组和python的list里面的list一样</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>], [<span class="number">400</span>, <span class="number">500</span>, <span class="number">600</span>], <span class="string">&#x27;-&#x27;</span>];</span><br></pre></td></tr></table></figure>

<h5 id="取数组元素作为变量"><a href="#取数组元素作为变量" class="headerlink" title="取数组元素作为变量"></a>取数组元素作为变量</h5><p>取数组元素作为变量应该用<code>$&#123;array[i]&#125;</code>这样的形式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;小明&#x27;</span>, <span class="string">&#x27;小红&#x27;</span>, <span class="string">&#x27;大军&#x27;</span>, <span class="string">&#x27;阿黄&#x27;</span>];</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`欢迎<span class="subst">$&#123;arr[<span class="number">0</span>]&#125;</span>,<span class="subst">$&#123;arr[<span class="number">1</span>]&#125;</span>,<span class="subst">$&#123;arr[<span class="number">2</span>]&#125;</span>和<span class="subst">$&#123;arr[<span class="number">3</span>]&#125;</span>同学`</span>);<span class="comment">//欢迎小明,小红,大军和阿黄同学</span></span><br></pre></td></tr></table></figure>

<p>注意这里的`号，不是单引号，单引号无法得到变量，全部视为字符串</p>
<h4 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h4><p>js的对象是由一组键值对组成的字典，与python中的字典类型基本一样：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Bob&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">tags</span>: [<span class="string">&#x27;js&#x27;</span>, <span class="string">&#x27;web&#x27;</span>, <span class="string">&#x27;mobile&#x27;</span>],</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&#x27;Beijing&#x27;</span>,</span><br><span class="line">    <span class="attr">hasCar</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">zipcode</span>: <span class="literal">null</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>js对象的键都是字符串类型，值可以是任何类型，要获取一个对象的属性，就直接用<code>对象变量.属性名 </code>的方式：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">person.<span class="property">name</span>; <span class="comment">// &#x27;Bob&#x27;</span></span><br><span class="line">person.<span class="property">zipcode</span>; <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<p>如果某个对象的key是字符串类型，访问的时候就只能跟python的字典一样，用<code>object[&#39;key&#39;]</code>来访问</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaohong = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小红&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;middle-school&#x27;</span>: <span class="string">&#x27;No.1 Middle School&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">xiaohong[<span class="string">&#x27;middle-school&#x27;</span>]; <span class="comment">// &#x27;No.1 Middle School&#x27;</span></span><br><span class="line">xiaohong[<span class="string">&#x27;name&#x27;</span>]; <span class="comment">// &#x27;小红&#x27;</span></span><br><span class="line">xiaohong.<span class="property">name</span>; <span class="comment">// &#x27;小红&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果访问不存在的元素，那么返回的就是undefined</p>
<p>你可以随意给对象添加或者是删除属性，通过delete进行删除，还可以通过<code>in</code>来判断某个属性是否在某个对象中</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line">xiaoming.<span class="property">age</span>; <span class="comment">// undefined</span></span><br><span class="line">xiaoming.<span class="property">age</span> = <span class="number">18</span>; <span class="comment">// 新增一个age属性</span></span><br><span class="line">xiaoming.<span class="property">age</span>; <span class="comment">// 18</span></span><br><span class="line"><span class="keyword">delete</span> xiaoming.<span class="property">age</span>; <span class="comment">// 删除age属性</span></span><br><span class="line">xiaoming.<span class="property">age</span>; <span class="comment">// undefined</span></span><br><span class="line"><span class="comment">//用in来判断属性是否存在</span></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">birth</span>: <span class="number">1990</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="string">&#x27;name&#x27;</span> <span class="keyword">in</span> xiaoming; <span class="comment">// true</span></span><br><span class="line"><span class="string">&#x27;grade&#x27;</span> <span class="keyword">in</span> xiaoming; <span class="comment">// false</span></span><br><span class="line"><span class="string">&#x27;toString&#x27;</span> <span class="keyword">in</span> xiaoming; <span class="comment">// true</span></span><br><span class="line">xiaoming.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;name&#x27;</span>); <span class="comment">// true</span></span><br><span class="line">xiaoming.<span class="title function_">hasOwnProperty</span>(<span class="string">&#x27;toString&#x27;</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>但是用<code>in</code>判断有风险，因为如果是继承得到的属性也会被判断为自身的。要判断是否自身的属性， 应该用<code>hasOwnProperty()</code>方法： </p>
<h4 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h4><p>js的变量要以var定义，变量名是大小写英文、数字、<code>$</code>和<code>_</code>的组合 ，不能以数字开头</p>
<p>用等号对变量赋值，但一个变量只需要初始化一次</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">123</span>; <span class="comment">// a的值是整数123</span></span><br><span class="line">a = <span class="string">&#x27;ABC&#x27;</span>; <span class="comment">// a变为字符串</span></span><br></pre></td></tr></table></figure>

<h4 id="strict模式"><a href="#strict模式" class="headerlink" title="strict模式"></a>strict模式</h4><p>如果不用var进行初始化的话，那么变量将是全局变量，这会导致很严重的错误</p>
<p>ECMA为了修补js的这一严重缺陷，在后续退出了strict模式，如果不用var初始化变量将会报错，启用strict模式的方法是在js代码的第一行写上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;use strict&#x27;;</span><br></pre></td></tr></table></figure>

<h3 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h3><p>js用<code>if&#123;...&#125; else if&#123;...&#125;</code>的形式来进行条件判断，例如</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (age &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;teenager&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (age &gt;= <span class="number">18</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;adult&#x27;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;kid&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>JavaScript把<code>null</code>、<code>undefined</code>、<code>0</code>、<code>NaN</code>和空字符串<code>&#39;&#39;</code>视为<code>false</code>，其他值一概视为<code>true</code>，因此上述代码条件判断的结果是<code>true</code>。</p>
<h3 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h3><p>js的循环和c语言当中的是一样的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> i;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">1</span>; i&lt;=<span class="number">10000</span>; i++) &#123;</span><br><span class="line">    x = x + i;</span><br><span class="line">&#125;</span><br><span class="line">x; <span class="comment">// 50005000</span></span><br></pre></td></tr></table></figure>

<p><code>for</code>循环最常用的地方是利用索引来遍历数组：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;Microsoft&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> i, x;</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;arr.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    x = arr[i];</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>for</code>也可以用break来退出</p>
<p>js当中的<code>for</code>也可以用python当中的<code>in</code>的形式：<code>for ... in</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&#x27;Beijing&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> o)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(key);<span class="comment">// &#x27;name&#x27;, &#x27;age&#x27;, &#x27;city&#x27;</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(o.<span class="property">key</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要过滤掉对象继承的属性，用<code>hasOwnProperty()</code>来实现：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> o = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Jack&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">city</span>: <span class="string">&#x27;Beijing&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> key <span class="keyword">in</span> o) &#123;</span><br><span class="line">    <span class="keyword">if</span> (o.<span class="title function_">hasOwnProperty</span>(key)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(key); <span class="comment">// &#x27;name&#x27;, &#x27;age&#x27;, &#x27;city&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>for in 数组的话，得到的是索引，因为数组的索引被视为属性</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i <span class="keyword">in</span> a) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(i); <span class="comment">// &#x27;0&#x27;, &#x27;1&#x27;, &#x27;2&#x27;</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(a[i]); <span class="comment">// &#x27;A&#x27;, &#x27;B&#x27;, &#x27;C&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Map和Set"><a href="#Map和Set" class="headerlink" title="Map和Set"></a>Map和Set</h3><p>js中的Map相当于python中的字典，由键值对组成</p>
<p>初始化一个map需要一个二维数组或者是初始化为空map，用<code>set</code>添加键值对，用<code>has</code>确认是否含有某个键，用<code>get</code>取对应键的值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="title class_">Map</span>(); <span class="comment">// 空Map</span></span><br><span class="line">m.<span class="title function_">set</span>(<span class="string">&#x27;Adam&#x27;</span>, <span class="number">67</span>); <span class="comment">// 添加新的key-value</span></span><br><span class="line">m.<span class="title function_">set</span>(<span class="string">&#x27;Bob&#x27;</span>, <span class="number">59</span>);</span><br><span class="line">m.<span class="title function_">has</span>(<span class="string">&#x27;Adam&#x27;</span>); <span class="comment">// 是否存在key &#x27;Adam&#x27;: true</span></span><br><span class="line">m.<span class="title function_">get</span>(<span class="string">&#x27;Adam&#x27;</span>); <span class="comment">// 67</span></span><br><span class="line">m.<span class="title function_">delete</span>(<span class="string">&#x27;Adam&#x27;</span>); <span class="comment">// 删除key &#x27;Adam&#x27;</span></span><br><span class="line">m.<span class="title function_">get</span>(<span class="string">&#x27;Adam&#x27;</span>); <span class="comment">// undefined</span></span><br></pre></td></tr></table></figure>

<p><code>Set</code>就是python当中的集合，不允许重复</p>
<h3 id="iterable"><a href="#iterable" class="headerlink" title="iterable"></a>iterable</h3><p>因为<code>for in</code>语法不适用于Map和Set（因为他们不可以通过下标遍历），因此有了<code>for ... of</code>循环遍历</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]);</span><br><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="title class_">Map</span>([[<span class="number">1</span>, <span class="string">&#x27;x&#x27;</span>], [<span class="number">2</span>, <span class="string">&#x27;y&#x27;</span>], [<span class="number">3</span>, <span class="string">&#x27;z&#x27;</span>]]);</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">of</span> a) &#123; <span class="comment">// 遍历Array</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">of</span> s) &#123; <span class="comment">// 遍历Set</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> x <span class="keyword">of</span> m) &#123; <span class="comment">// 遍历Map</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x[<span class="number">0</span>] + <span class="string">&#x27;=&#x27;</span> + x[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而，更好的遍历方式是使用<code>iterable</code>内置的<code>forEach</code>方法，接收一个函数，每次迭代自动回调该函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>];</span><br><span class="line">a.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">element, index, array</span>) &#123;</span><br><span class="line">    <span class="comment">// element: 指向当前元素的值</span></span><br><span class="line">    <span class="comment">// index: 指向当前索引</span></span><br><span class="line">    <span class="comment">// array: 指向Array对象本身</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(element + <span class="string">&#x27;, index = &#x27;</span> + index);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">//A, index = 0</span></span><br><span class="line"><span class="comment">//B, index = 1</span></span><br><span class="line"><span class="comment">//C, index = 2</span></span><br></pre></td></tr></table></figure>

<p><code>Set</code>与<code>Array</code>类似，但<code>Set</code>没有索引，因此回调函数的前两个参数都是元素本身：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="title class_">Set</span>([<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>]);</span><br><span class="line">s.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">element, sameElement, set</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(element);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><code>Map</code>的回调函数参数依次为<code>value</code>、<code>key</code>和<code>map</code>本身：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> m = <span class="keyword">new</span> <span class="title class_">Map</span>([[<span class="number">1</span>, <span class="string">&#x27;x&#x27;</span>], [<span class="number">2</span>, <span class="string">&#x27;y&#x27;</span>], [<span class="number">3</span>, <span class="string">&#x27;z&#x27;</span>]]);</span><br><span class="line">m.<span class="title function_">forEach</span>(<span class="keyword">function</span> (<span class="params">value, key, map</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>在js中，函数定义的方法如下</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">abs</span>(<span class="params">x</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (x&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果没有return结果，那么函数的返回值是<code>undefined</code></p>
<p>还有一种函数的定义方法是把函数赋值给一个变量名</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> abs = <span class="keyword">function</span> (<span class="params">x</span>)&#123;</span><br><span class="line">    <span class="keyword">if</span> (x&gt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>js允许传入任意个函数参数，如果比定义的多，只会调用定义的那个参数，如果比定义的少，那么会返回NaN</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">abs</span>(<span class="number">10</span>); <span class="comment">// 返回10</span></span><br><span class="line"><span class="title function_">abs</span>(-<span class="number">9</span>); <span class="comment">// 返回9</span></span><br><span class="line"><span class="title function_">abs</span>(<span class="number">10</span>, <span class="string">&#x27;blablabla&#x27;</span>); <span class="comment">// 返回10</span></span><br><span class="line"><span class="title function_">abs</span>(-<span class="number">9</span>, <span class="string">&#x27;haha&#x27;</span>, <span class="string">&#x27;hehe&#x27;</span>, <span class="literal">null</span>); <span class="comment">// 返回9</span></span><br><span class="line"><span class="title function_">abs</span>(); <span class="comment">// 返回NaN</span></span><br></pre></td></tr></table></figure>

<p>要避免收到<code>undefined</code>，可以对参数进行检查：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">abs</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> x !== <span class="string">&#x27;number&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="string">&#x27;Not a number&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> -x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="arguments"><a href="#arguments" class="headerlink" title="arguments"></a>arguments</h4><p>js本身还定义了一个参数是arguments，指向传入的所有参数，形式跟array一样：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;x = &#x27;</span> + x); <span class="comment">// 10</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="variable language_">arguments</span>.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;arg &#x27;</span> + i + <span class="string">&#x27; = &#x27;</span> + <span class="variable language_">arguments</span>[i]); <span class="comment">// 10, 20, 30</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">foo</span>(<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>);</span><br><span class="line"><span class="comment">//输出如下</span></span><br><span class="line"><span class="comment">//x = 10</span></span><br><span class="line"><span class="comment">//arg 0 = 10</span></span><br><span class="line"><span class="comment">//arg 1 = 20</span></span><br><span class="line"><span class="comment">//arg 2 = 30</span></span><br></pre></td></tr></table></figure>

<h4 id="rest"><a href="#rest" class="headerlink" title="rest"></a>rest</h4><p>js还定义了rest参数，用于获取除了已定义参数之外的所有参数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params">a, b, ...rest</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;a = &#x27;</span> + a);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;b = &#x27;</span> + b);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(rest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>);</span><br><span class="line"><span class="comment">// 结果:</span></span><br><span class="line"><span class="comment">// a = 1</span></span><br><span class="line"><span class="comment">// b = 2</span></span><br><span class="line"><span class="comment">// Array [ 3, 4, 5 ]</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>(<span class="number">1</span>);</span><br><span class="line"><span class="comment">// 结果:</span></span><br><span class="line"><span class="comment">// a = 1</span></span><br><span class="line"><span class="comment">// b = undefined</span></span><br><span class="line"><span class="comment">// Array []</span></span><br></pre></td></tr></table></figure>

<p>est参数只能写在最后，前面用<code>...</code>标识， </p>
<h3 id="函数作用域"><a href="#函数作用域" class="headerlink" title="函数作用域"></a>函数作用域</h3><p>函数内定义的是局部变量，不可以在函数外使用，跟其他编程语言规定是一样的</p>
<h4 id="变量提升"><a href="#变量提升" class="headerlink" title="变量提升"></a>变量提升</h4><p>js的变量声明会提到最前面进行编译，但是变量赋值并不会提升</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="string">&#x27;Hello, &#x27;</span> + y;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">    <span class="keyword">var</span> y = <span class="string">&#x27;Bob&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">foo</span>();</span><br></pre></td></tr></table></figure>

<p>上面这段代码不报错，但是显示的是<code>Hello,undefined</code></p>
<p>js引擎看到的是如下的结构</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> y; <span class="comment">// 提升变量y的申明，此时y为undefined</span></span><br><span class="line">    <span class="keyword">var</span> x = <span class="string">&#x27;Hello, &#x27;</span> + y;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">    y = <span class="string">&#x27;Bob&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="全局作用域"><a href="#全局作用域" class="headerlink" title="全局作用域"></a>全局作用域</h4><p>js当中未定义在函数体中的变量都是全局变量，绑定在window这个对象上</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> course = <span class="string">&#x27;Learn JavaScript&#x27;</span>;</span><br><span class="line"><span class="title function_">alert</span>(course); <span class="comment">// &#x27;Learn JavaScript&#x27;</span></span><br><span class="line"><span class="title function_">alert</span>(<span class="variable language_">window</span>.<span class="property">course</span>); <span class="comment">// &#x27;Learn JavaScript&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="名字空间"><a href="#名字空间" class="headerlink" title="名字空间"></a>名字空间</h4><p>全局变量会绑定到<code>window</code>上，不同js文件如果用了相同的全局变量，或者定义了相同名字的顶层函数，都会造成命名冲突，减少冲突的好办法就是把所有的变量和函数全不绑定到一个全局变量中，如：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 唯一的全局变量MYAPP:</span></span><br><span class="line"><span class="keyword">var</span> <span class="variable constant_">MYAPP</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他变量:</span></span><br><span class="line"><span class="variable constant_">MYAPP</span>.<span class="property">name</span> = <span class="string">&#x27;myapp&#x27;</span>;</span><br><span class="line"><span class="variable constant_">MYAPP</span>.<span class="property">version</span> = <span class="number">1.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 其他函数:</span></span><br><span class="line"><span class="variable constant_">MYAPP</span>.<span class="property">foo</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;foo&#x27;</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="局部作用域"><a href="#局部作用域" class="headerlink" title="局部作用域"></a>局部作用域</h4><p>因为js的变量作用域是函数内部，因此类似于c++的for循环当中定义<code>i</code>的方法，在结束了for之后还是可以调用<code>i</code>的，如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">    &#125;</span><br><span class="line">    i += <span class="number">100</span>; <span class="comment">// 仍然可以引用变量i</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此ES6引入了<code>let</code>关键字</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">        sum += i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SyntaxError:</span></span><br><span class="line">    i += <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h4><p>ES6引入了<code>const</code>用于定义常量，常量无法修改</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">PI</span> = <span class="number">3.14</span>;</span><br><span class="line"><span class="variable constant_">PI</span> = <span class="number">3</span>; <span class="comment">// 某些浏览器不报错，但是无效果！</span></span><br><span class="line"><span class="variable constant_">PI</span>; <span class="comment">// 3.14</span></span><br></pre></td></tr></table></figure>

<h4 id="同时对多个变量赋值"><a href="#同时对多个变量赋值" class="headerlink" title="同时对多个变量赋值"></a>同时对多个变量赋值</h4><p>ES6引入可以同时对多个变量赋值的机制，对多个变量赋值的时候，这些变量要用方括号<code>[]</code>引起来：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> [x, y, z] = [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>];</span><br></pre></td></tr></table></figure>

<p>解构赋值还可以忽略某些元素：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> [, , z] = [<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;ES6&#x27;</span>]; <span class="comment">// 忽略前两个元素，只对z赋值第三个元素</span></span><br><span class="line">z; <span class="comment">// &#x27;ES6&#x27;</span></span><br></pre></td></tr></table></figure>

<p>如果需要从一个对象中取出若干属性，也可以使用解构赋值，便于快速获取对象的指定属性，在对对象进行解构赋值的时候，用大括号<code>&#123;&#125;</code>把变量扩起来：  </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">    <span class="attr">passport</span>: <span class="string">&#x27;G-12345678&#x27;</span>,</span><br><span class="line">    <span class="attr">school</span>: <span class="string">&#x27;No.4 middle school&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> &#123;name, age, passport&#125; = person;</span><br><span class="line"><span class="comment">// name, age, passport分别被赋值为对应属性:</span></span><br></pre></td></tr></table></figure>

<p>如果对应的属性不存在将会被定义为undefined，如果你要将某个变量拿出来赋给其他值，可以用冒号<code>:</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">    <span class="attr">passport</span>: <span class="string">&#x27;G-12345678&#x27;</span>,</span><br><span class="line">    <span class="attr">school</span>: <span class="string">&#x27;No.4 middle school&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 把passport属性赋值给变量id:</span></span><br><span class="line"><span class="keyword">let</span> &#123;name, <span class="attr">passport</span>:id&#125; = person;</span><br><span class="line">name; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">id; <span class="comment">// &#x27;G-12345678&#x27;</span></span><br><span class="line"><span class="comment">// 注意: passport不是变量，而是为了让变量id获得passport属性:</span></span><br><span class="line">passport; <span class="comment">// Uncaught ReferenceError: passport is not defined</span></span><br></pre></td></tr></table></figure>

<p>解构赋值还可以使用默认值，这样就避免出现undefined的情况：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> person = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">20</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="string">&#x27;male&#x27;</span>,</span><br><span class="line">    <span class="attr">passport</span>: <span class="string">&#x27;G-12345678&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果person对象没有single属性，默认赋值为true:</span></span><br><span class="line"><span class="keyword">var</span> &#123;name, single=<span class="literal">true</span>&#125; = person;</span><br><span class="line">name; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">single; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>解构赋值在用于已经定义好的变量的时候，不能直接以<code>&#123;&#125;</code>开头，因为js会认为以<code>&#123;</code>开头的内容是块元素，<code>=</code>不能对块元素赋值，解决办法是用小括号<code>()</code>括起来：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 声明变量:</span></span><br><span class="line"><span class="keyword">var</span> x, y;</span><br><span class="line"><span class="comment">// 解构赋值:</span></span><br><span class="line">&#123;x, y&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>, <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">200</span>&#125;;</span><br><span class="line"><span class="comment">// 语法错误: Uncaught SyntaxError: Unexpected token =</span></span><br><span class="line"></span><br><span class="line">(&#123;x, y&#125; = &#123; <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>, <span class="attr">x</span>: <span class="number">100</span>, <span class="attr">y</span>: <span class="number">200</span>&#125;); <span class="comment">//解决办法就是用小括号括起来</span></span><br></pre></td></tr></table></figure>

<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>在一个对象中绑定一个函数，称为这个对象的方法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">birth</span>: <span class="number">1990</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>();</span><br><span class="line">        <span class="keyword">return</span> y - <span class="variable language_">this</span>.<span class="property">birth</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个<code>age()</code>就是一个方法，<code>this</code>就是类定义的this</p>
<p>只有<code>object.funciton()</code>这样的调用形式才能触发<code>this</code></p>
<p>对于没有定义的this，在strict模式下指向undefined，在非strict模式下指向window</p>
<h4 id="apply"><a href="#apply" class="headerlink" title="apply"></a>apply</h4><p><code>apply</code>用于显示地指定this，第一个参数就是需要绑定的<code>this</code>变量，第二个参数是<code>Array</code> ，调用形式是<code>function.apply(this, Array)</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getAge</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> y = <span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getFullYear</span>();</span><br><span class="line">    <span class="keyword">return</span> y - <span class="variable language_">this</span>.<span class="property">birth</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">birth</span>: <span class="number">1990</span>,</span><br><span class="line">    <span class="attr">age</span>: getAge</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.<span class="title function_">age</span>(); <span class="comment">// 25</span></span><br><span class="line">getAge.<span class="title function_">apply</span>(xiaoming, []); <span class="comment">// 25, this指向xiaoming, 参数为空</span></span><br></pre></td></tr></table></figure>

<p>另一个与<code>apply()</code>类似的方法是<code>call()</code>，唯一区别是：</p>
<ul>
<li><code>apply()</code>把参数打包成<code>Array</code>再传入；</li>
<li><code>call()</code>把参数按顺序传入。</li>
</ul>
<p>比如调用<code>Math.max(3, 5, 4)</code>，分别用<code>apply()</code>和<code>call()</code>实现如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Math</span>.<span class="property">max</span>.<span class="title function_">apply</span>(<span class="literal">null</span>, [<span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>]); <span class="comment">// 5</span></span><br><span class="line"><span class="title class_">Math</span>.<span class="property">max</span>.<span class="title function_">call</span>(<span class="literal">null</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">4</span>); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h4 id="方法-1"><a href="#方法-1" class="headerlink" title="方法"></a>方法</h4><p>阅读: 141906</p>
<hr>
<p>在一个对象中绑定函数，称为这个对象的方法。</p>
<p>在JavaScript中，对象的定义是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>但是，如果我们给<code>xiaoming</code>绑定一个函数，就可以做更多的事情。比如，写个<code>age()</code>方法，返回<code>xiaoming</code>的年龄：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990,</span><br><span class="line">    age: function () &#123;</span><br><span class="line">        var y = new Date().getFullYear();</span><br><span class="line">        return y - this.birth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age; // function xiaoming.age()</span><br><span class="line">xiaoming.age(); // 今年调用是25,明年调用就变成26了</span><br></pre></td></tr></table></figure>

<p>绑定到对象上的函数称为方法，和普通函数也没啥区别，但是它在内部使用了一个<code>this</code>关键字，这个东东是什么？</p>
<p>在一个方法内部，<code>this</code>是一个特殊变量，它始终指向当前对象，也就是<code>xiaoming</code>这个变量。所以，<code>this.birth</code>可以拿到<code>xiaoming</code>的<code>birth</code>属性。</p>
<p>让我们拆开写：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function getAge() &#123;</span><br><span class="line">    var y = new Date().getFullYear();</span><br><span class="line">    return y - this.birth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990,</span><br><span class="line">    age: getAge</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age(); // 25, 正常结果</span><br><span class="line">getAge(); // NaN</span><br></pre></td></tr></table></figure>

<p>单独调用函数<code>getAge()</code>怎么返回了<code>NaN</code>？<em>请注意</em>，我们已经进入到了JavaScript的一个大坑里。</p>
<p>JavaScript的函数内部如果调用了<code>this</code>，那么这个<code>this</code>到底指向谁？</p>
<p>答案是，视情况而定！</p>
<p>如果以对象的方法形式调用，比如<code>xiaoming.age()</code>，该函数的<code>this</code>指向被调用的对象，也就是<code>xiaoming</code>，这是符合我们预期的。</p>
<p>如果单独调用函数，比如<code>getAge()</code>，此时，该函数的<code>this</code>指向全局对象，也就是<code>window</code>。</p>
<p>坑爹啊！</p>
<p>更坑爹的是，如果这么写：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">var fn = xiaoming.age; // 先拿到xiaoming的age函数</span><br><span class="line">fn(); // NaN</span><br></pre></td></tr></table></figure>

<p>也是不行的！要保证<code>this</code>指向正确，必须用<code>obj.xxx()</code>的形式调用！</p>
<p>由于这是一个巨大的设计错误，要想纠正可没那么简单。ECMA决定，在strict模式下让函数的<code>this</code>指向<code>undefined</code>，因此，在strict模式下，你会得到一个错误：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990,</span><br><span class="line">    age: function () &#123;</span><br><span class="line">        var y = new Date().getFullYear();</span><br><span class="line">        return y - this.birth;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">var fn = xiaoming.age;</span><br><span class="line">fn(); // Uncaught TypeError: Cannot read property &#x27;birth&#x27; of undefined</span><br></pre></td></tr></table></figure>

<p>这个决定只是让错误及时暴露出来，并没有解决<code>this</code>应该指向的正确位置。</p>
<p>有些时候，喜欢重构的你把方法重构了一下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990,</span><br><span class="line">    age: function () &#123;</span><br><span class="line">        function getAgeFromBirth() &#123;</span><br><span class="line">            var y = new Date().getFullYear();</span><br><span class="line">            return y - this.birth;</span><br><span class="line">        &#125;</span><br><span class="line">        return getAgeFromBirth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age(); // Uncaught TypeError: Cannot read property &#x27;birth&#x27; of undefined</span><br></pre></td></tr></table></figure>

<p>结果又报错了！原因是<code>this</code>指针只在<code>age</code>方法的函数内指向<code>xiaoming</code>，在函数内部定义的函数，<code>this</code>又指向<code>undefined</code>了！（在非strict模式下，它重新指向全局对象<code>window</code>！）</p>
<p>修复的办法也不是没有，我们用一个<code>that</code>变量首先捕获<code>this</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#x27;use strict&#x27;;</span><br><span class="line"></span><br><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990,</span><br><span class="line">    age: function () &#123;</span><br><span class="line">        var that = this; // 在方法内部一开始就捕获this</span><br><span class="line">        function getAgeFromBirth() &#123;</span><br><span class="line">            var y = new Date().getFullYear();</span><br><span class="line">            return y - that.birth; // 用that而不是this</span><br><span class="line">        &#125;</span><br><span class="line">        return getAgeFromBirth();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age(); // 25</span><br></pre></td></tr></table></figure>

<p>用<code>var that = this;</code>，你就可以放心地在方法内部定义其他函数，而不是把所有语句都堆到一个方法中。</p>
<h3 id="apply-1"><a href="#apply-1" class="headerlink" title="apply"></a>apply</h3><p>虽然在一个独立的函数调用中，根据是否是strict模式，<code>this</code>指向<code>undefined</code>或<code>window</code>，不过，我们还是可以控制<code>this</code>的指向的！</p>
<p>要指定函数的<code>this</code>指向哪个对象，可以用函数本身的<code>apply</code>方法，它接收两个参数，第一个参数就是需要绑定的<code>this</code>变量，第二个参数是<code>Array</code>，表示函数本身的参数。</p>
<p>用<code>apply</code>修复<code>getAge()</code>调用：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function getAge() &#123;</span><br><span class="line">    var y = new Date().getFullYear();</span><br><span class="line">    return y - this.birth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var xiaoming = &#123;</span><br><span class="line">    name: &#x27;小明&#x27;,</span><br><span class="line">    birth: 1990,</span><br><span class="line">    age: getAge</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.age(); // 25</span><br><span class="line">getAge.apply(xiaoming, []); // 25, this指向xiaoming, 参数为空</span><br></pre></td></tr></table></figure>

<p>另一个与<code>apply()</code>类似的方法是<code>call()</code>，唯一区别是：</p>
<ul>
<li><code>apply()</code>把参数打包成<code>Array</code>再传入；</li>
<li><code>call()</code>把参数按顺序传入。</li>
</ul>
<p>比如调用<code>Math.max(3, 5, 4)</code>，分别用<code>apply()</code>和<code>call()</code>实现如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Math.max.apply(null, [3, 5, 4]); // 5</span><br><span class="line">Math.max.call(null, 3, 5, 4); // 5</span><br></pre></td></tr></table></figure>

<p>对普通函数调用，我们通常把<code>this</code>绑定为<code>null</code>。</p>
<h4 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h4><p>利用<code>apply()</code>，我们还可以动态改变函数的行为。</p>
<p>JavaScript的所有对象都是动态的，即使内置的函数，我们也可以重新指向新的函数。</p>
<p>现在假定我们想统计一下代码一共调用了多少次<code>parseInt()</code>，可以把所有的调用都找出来，然后手动加上<code>count += 1</code>，不过这样做太傻了。最佳方案是用我们自己的函数替换掉默认的<code>parseInt()</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">&#x27;use strict&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">var</span> oldParseInt = <span class="built_in">parseInt</span>; <span class="comment">// 保存原函数</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="property">parseInt</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    count += <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> oldParseInt.<span class="title function_">apply</span>(<span class="literal">null</span>, <span class="variable language_">arguments</span>); <span class="comment">// 调用原函数</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试:</span></span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;10&#x27;</span>);</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;20&#x27;</span>);</span><br><span class="line"><span class="built_in">parseInt</span>(<span class="string">&#x27;30&#x27;</span>);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;count = &#x27;</span> + count); <span class="comment">// 3</span></span><br></pre></td></tr></table></figure>

<h3 id="高阶函数"><a href="#高阶函数" class="headerlink" title="高阶函数"></a>高阶函数</h3><p>js的最基础的高阶函数，就是把一个函数作为另一个函数的参数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">add</span>(<span class="params">x, y, f</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">f</span>(x) + <span class="title function_">f</span>(y);</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">add</span>(-<span class="number">5</span>, <span class="number">6</span>, <span class="title class_">Math</span>.<span class="property">abs</span>);<span class="comment">//返回abs(5)+abs(6)</span></span><br></pre></td></tr></table></figure>

<h4 id="map-x2F-reduce"><a href="#map-x2F-reduce" class="headerlink" title="map&#x2F;reduce"></a>map&#x2F;reduce</h4><p>js的map&#x2F;reduce和python的基本一样，只是调用方法略有区别，是<code>x.map(function)</code></p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>];</span><br><span class="line"><span class="keyword">var</span> results = arr.<span class="title function_">map</span>(pow); <span class="comment">// [1, 4, 9, 16, 25, 36, 49, 64, 81]</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(results);</span><br></pre></td></tr></table></figure>

 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>];</span><br><span class="line">arr.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y;</span><br><span class="line">&#125;); <span class="comment">// 25</span></span><br></pre></td></tr></table></figure>

<h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p>用于把array的某些元素过滤掉</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">15</span>];</span><br><span class="line"><span class="keyword">var</span> r = arr.<span class="title function_">filter</span>(<span class="keyword">function</span> (<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x % <span class="number">2</span> !== <span class="number">0</span>;</span><br><span class="line">&#125;);</span><br><span class="line">r; <span class="comment">// [1, 5, 9, 15]</span></span><br></pre></td></tr></table></figure>

<h4 id="sort-1"><a href="#sort-1" class="headerlink" title="sort"></a>sort</h4><p>sort方法用于排序</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 看上去正常的结果:</span></span><br><span class="line">[<span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;Apple&#x27;</span>, <span class="string">&#x27;Microsoft&#x27;</span>].<span class="title function_">sort</span>(); <span class="comment">// [&#x27;Apple&#x27;, &#x27;Google&#x27;, &#x27;Microsoft&#x27;];</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// apple排在了最后:根据ASCII码，小写字母a在大写字母之后</span></span><br><span class="line">[<span class="string">&#x27;Google&#x27;</span>, <span class="string">&#x27;apple&#x27;</span>, <span class="string">&#x27;Microsoft&#x27;</span>].<span class="title function_">sort</span>(); <span class="comment">// [&#x27;Google&#x27;, &#x27;Microsoft&quot;, &#x27;apple&#x27;]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 无法理解的结果: array的sort方法默认把所有元素转换换为string再排序</span></span><br><span class="line">[<span class="number">10</span>, <span class="number">20</span>, <span class="number">1</span>, <span class="number">2</span>].<span class="title function_">sort</span>(); <span class="comment">// [1, 10, 2, 20]</span></span><br></pre></td></tr></table></figure>

<p>因为sort的这种默认的排序往往不能达到要求，因此需要自己定义sort当中的条件函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> arr = [<span class="number">10</span>, <span class="number">20</span>, <span class="number">1</span>, <span class="number">2</span>];</span><br><span class="line">arr.<span class="title function_">sort</span>(<span class="keyword">function</span> (<span class="params">x, y</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (x &lt; y) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (x &gt; y) &#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;); <span class="comment">// [20, 10, 2, 1]</span></span><br></pre></td></tr></table></figure>

<p>返回1的时候表示要换位置，返回-1表示不换位置</p>
<h3 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h3><p>闭包就是在一个函数内部再定义一个函数，执行函数的时候返回的不是值，而是函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//普通的求和函数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">sum</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">x, y</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> x + y;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">sum</span>([<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>]); <span class="comment">// 15</span></span><br><span class="line"><span class="comment">//闭包</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">lazy_sum</span>(<span class="params">arr</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> sum = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> arr.<span class="title function_">reduce</span>(<span class="keyword">function</span> (<span class="params">x, y</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> x + y;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h3><p>创建一个函数并立即执行的方法称为匿名函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params">x</span>) &#123; <span class="keyword">return</span> x * x &#125;) (<span class="number">3</span>);<span class="comment">//由于js语法限制，要用小括号括起来</span></span><br></pre></td></tr></table></figure>

<h3 id="箭头函数"><a href="#箭头函数" class="headerlink" title="箭头函数"></a>箭头函数</h3><p>ES6新增的一种函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">x =&gt; x * x; </span><br></pre></td></tr></table></figure>

<p>上面的箭头函数相当于：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> (<span class="params">x</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> x * x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>参数不止一个的时候要用括号括起来：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 两个参数:</span></span><br><span class="line">(x, y) =&gt; x * x + y * y</span><br><span class="line"><span class="comment">// 无参数:</span></span><br><span class="line">() =&gt; <span class="number">3.14</span></span><br><span class="line"><span class="comment">// 可变参数:</span></span><br><span class="line">(x, y, ...rest) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> i, sum = x + y;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;rest.<span class="property">length</span>; i++) &#123;</span><br><span class="line">        sum += rest[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果要返回一个对象，就要注意，如果是单表达式，这么写的话会报错：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SyntaxError:</span></span><br><span class="line">x =&gt; &#123; <span class="attr">foo</span>: x &#125;</span><br><span class="line"><span class="comment">//因为和函数体的&#123; ... &#125;有语法冲突，所以要改为：</span></span><br><span class="line">x =&gt; (&#123; <span class="attr">foo</span>: x &#125;)</span><br></pre></td></tr></table></figure>

<h3 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h3><p>生成器和python当中的类似，用yield返回，用next访问</p>
<h2 id="标准对象"><a href="#标准对象" class="headerlink" title="标准对象"></a>标准对象</h2><p>js中所有都是对象，用<code>typeof</code>来查看对象类型</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typeof</span> <span class="number">123</span>; <span class="comment">// &#x27;number&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">NaN</span>; <span class="comment">// &#x27;number&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="string">&#x27;str&#x27;</span>; <span class="comment">// &#x27;string&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">true</span>; <span class="comment">// &#x27;boolean&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">undefined</span>; <span class="comment">// &#x27;undefined&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="title class_">Math</span>.<span class="property">abs</span>; <span class="comment">// &#x27;function&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> <span class="literal">null</span>; <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> []; <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">typeof</span> &#123;&#125;; <span class="comment">// &#x27;object&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="包装对象"><a href="#包装对象" class="headerlink" title="包装对象"></a>包装对象</h3><p>js提供包装对象，包装对象的关系就像java当中的<code>int</code>和<code>Intenger</code>的关系，<code>Intenger</code>这种包装对象要用<code>new</code>来创建，js当中的<code>number</code>、<code>boolean</code>和<code>string</code>都有包装对象 ，就是首字母大写，虽然包装对象看上去和原来的值一模一样，显示出来也是一模一样，但他们的类型已经变为<code>object</code>了！所以，包装对象和原始值用<code>===</code>比较会返回<code>false</code>： </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> n = <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">123</span>); <span class="comment">// 123,生成了新的包装类型</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="keyword">new</span> <span class="title class_">Boolean</span>(<span class="literal">true</span>); <span class="comment">// true,生成了新的包装类型</span></span><br><span class="line"><span class="keyword">var</span> s = <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&#x27;str&#x27;</span>); <span class="comment">// &#x27;str&#x27;,生成了新的包装类型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typeof</span> <span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">123</span>); <span class="comment">// &#x27;object&#x27;</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Number</span>(<span class="number">123</span>) === <span class="number">123</span>; <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<p>如果在使用<code>Number</code>、<code>Boolean</code>和<code>String</code>时，没有写<code>new</code> ，那么这三个函数就是类型转换函数</p>
<p><strong>注意</strong>：</p>
<ul>
<li>不要使用<code>new Number()</code>、<code>new Boolean()</code>、<code>new String()</code>创建包装对象；</li>
<li>用<code>parseInt()</code>或<code>parseFloat()</code>来转换任意类型到<code>number</code>；</li>
<li>用<code>String()</code>来转换任意类型到<code>string</code>，或者直接调用某个对象的<code>toString()</code>方法；</li>
<li>通常不必把任意类型转换为<code>boolean</code>再判断，因为可以直接写<code>if (myVar) &#123;...&#125;</code>；</li>
<li><code>typeof</code>操作符可以判断出<code>number</code>、<code>boolean</code>、<code>string</code>、<code>function</code>和<code>undefined</code>；</li>
<li>判断<code>Array</code>要使用<code>Array.isArray(arr)</code>；</li>
<li>判断<code>null</code>请使用<code>myVar === null</code>；</li>
<li>判断某个全局变量是否存在用<code>typeof window.myVar === &#39;undefined&#39;</code>；</li>
<li>函数内部判断某个变量是否存在用<code>typeof myVar === &#39;undefined&#39;</code>。</li>
</ul>
<h3 id="Date"><a href="#Date" class="headerlink" title="Date"></a>Date</h3><p>js中<code>Date</code>对象用于获取日期和时间：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> now = <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">now; <span class="comment">// Wed Jun 24 2015 19:49:22 GMT+0800 (CST)</span></span><br><span class="line">now.<span class="title function_">getFullYear</span>(); <span class="comment">// 2015, 年份</span></span><br><span class="line">now.<span class="title function_">getMonth</span>(); <span class="comment">// 5, 月份，注意月份范围是0~11，5表示六月</span></span><br><span class="line">now.<span class="title function_">getDate</span>(); <span class="comment">// 24, 表示24号</span></span><br><span class="line">now.<span class="title function_">getDay</span>(); <span class="comment">// 3, 表示星期三</span></span><br><span class="line">now.<span class="title function_">getHours</span>(); <span class="comment">// 19, 24小时制</span></span><br><span class="line">now.<span class="title function_">getMinutes</span>(); <span class="comment">// 49, 分钟</span></span><br><span class="line">now.<span class="title function_">getSeconds</span>(); <span class="comment">// 22, 秒</span></span><br><span class="line">now.<span class="title function_">getMilliseconds</span>(); <span class="comment">// 875, 毫秒数</span></span><br><span class="line">now.<span class="title function_">getTime</span>(); <span class="comment">// 1435146562875, 以number形式表示的时间戳</span></span><br></pre></td></tr></table></figure>

<p>如果要创建一个指定日期和时间的<code>Date</code>对象，可以用：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">2015</span>, <span class="number">5</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">15</span>, <span class="number">30</span>, <span class="number">123</span>);</span><br><span class="line">d; <span class="comment">// Fri Jun 19 2015 20:15:30 GMT+0800 (CST)</span></span><br></pre></td></tr></table></figure>

<p>**JavaScript的月份范围用整数表示是0~11，<code>0</code>表示一月，<code>1</code>表示二月……，所以要表示6月，我们传入的是<code>5</code>！ **</p>
<p>第二种创建一个指定日期和时间的方法是解析一个符合<a href="http://www.w3.org/TR/NOTE-datetime">ISO 8601</a>格式的字符串：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="title class_">Date</span>.<span class="title function_">parse</span>(<span class="string">&#x27;2015-06-24T19:49:22.875+08:00&#x27;</span>);</span><br><span class="line">d; <span class="comment">// 1435146562875</span></span><br></pre></td></tr></table></figure>

<p>但它返回的不是<code>Date</code>对象，而是一个时间戳。不过有时间戳就可以很容易地把它转换为一个<code>Date</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1435146562875</span>);</span><br><span class="line">d; <span class="comment">// Wed Jun 24 2015 19:49:22 GMT+0800 (CST)</span></span><br><span class="line">d.<span class="title function_">getMonth</span>(); <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<h4 id="时区"><a href="#时区" class="headerlink" title="时区"></a>时区</h4><p>浏览器可以把时间戳正确转换为本地时间</p>
<p>时间戳是个什么东西？时间戳是一个自增的整数，它表示从1970年1月1日零时整的GMT时区开始的那一刻，到现在的毫秒数。假设浏览器所在电脑的时间是准确的，那么世界上无论哪个时区的电脑，它们此刻产生的时间戳数字都是一样的，所以，时间戳可以精确地表示一个时刻，并且与时区无关。 </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> d = <span class="keyword">new</span> <span class="title class_">Date</span>(<span class="number">1435146562875</span>);</span><br><span class="line">d.<span class="title function_">toLocaleString</span>(); <span class="comment">// &#x27;2015/6/24 下午7:49:22&#x27;，本地时间（北京时区+8:00），显示的字符串与操作系统设定的格式有关</span></span><br><span class="line">d.<span class="title function_">toUTCString</span>(); <span class="comment">// &#x27;Wed, 24 Jun 2015 11:49:22 GMT&#x27;，UTC时间，与本地时间相差8小时</span></span><br></pre></td></tr></table></figure>

<p>获取时间戳的方法如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>()</span><br></pre></td></tr></table></figure>

<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><p>js当中的正则表达式的写法和python是一样的，创建正则表达式的方法有两种</p>
<p>第一种是直接通过<code>/正则表达式/</code>写出来，第二种方式是通过<code>new RegExp(&#39;正则表达式&#39;)</code>创建一个RegExp对象 </p>
<p><code>re.test(string)</code>方法用于判断正则表达式是否匹配，这个re就是一个正则表达式对象</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^\d&#123;3&#125;\-\d&#123;3,8&#125;$/</span>;</span><br><span class="line">re.<span class="title function_">test</span>(<span class="string">&#x27;010-12345&#x27;</span>); <span class="comment">// true</span></span><br><span class="line">re.<span class="title function_">test</span>(<span class="string">&#x27;010-1234x&#x27;</span>); <span class="comment">// false</span></span><br><span class="line">re.<span class="title function_">test</span>(<span class="string">&#x27;010 12345&#x27;</span>); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>

<h4 id="切分字符串"><a href="#切分字符串" class="headerlink" title="切分字符串"></a>切分字符串</h4><p>js切分字符串也是用<code>split()</code>实现的，用这则表达式可以通过任意形式切分</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//通过空格切分</span></span><br><span class="line"><span class="string">&#x27;a b   c&#x27;</span>.<span class="title function_">split</span>(<span class="string">&#x27; &#x27;</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;&#x27;, &#x27;&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">//通过任意个空格切分</span></span><br><span class="line"><span class="string">&#x27;a b   c&#x27;</span>.<span class="title function_">split</span>(<span class="regexp">/\s+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;]</span></span><br><span class="line"><span class="comment">//通过任意空格和逗号切分</span></span><br><span class="line"><span class="string">&#x27;a,b, c  d&#x27;</span>.<span class="title function_">split</span>(<span class="regexp">/[\s\,]+/</span>); <span class="comment">// [&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;, &#x27;d&#x27;]</span></span><br></pre></td></tr></table></figure>

<h4 id="提取子串"><a href="#提取子串" class="headerlink" title="提取子串"></a>提取子串</h4><p>js用<code>exec</code>提取子串，子串在正则表达式中用括号括起来</p>
<p><code>exec()</code>方法在匹配成功后，会返回一个<code>Array</code>，第一个元素是正则表达式匹配到的整个字符串，后面的字符串表示匹配成功的子串。</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> re = <span class="regexp">/^(\d&#123;3&#125;)-(\d&#123;3,8&#125;)$/</span>;</span><br><span class="line">re.<span class="title function_">exec</span>(<span class="string">&#x27;010-12345&#x27;</span>); <span class="comment">// [&#x27;010-12345&#x27;, &#x27;010&#x27;, &#x27;12345&#x27;]</span></span><br><span class="line">re.<span class="title function_">exec</span>(<span class="string">&#x27;010 12345&#x27;</span>); <span class="comment">// null</span></span><br></pre></td></tr></table></figure>

<p>同样<code>?</code>可以使得正则表达式进行非贪婪匹配</p>
<h4 id="全局搜索"><a href="#全局搜索" class="headerlink" title="全局搜索"></a>全局搜索</h4><p>js的正则表达式有几个特殊的标志，最常用的是<code>g</code>，表示全局匹配</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> r1 = <span class="regexp">/test/g</span>;</span><br><span class="line"><span class="comment">// 等价于:</span></span><br><span class="line"><span class="keyword">var</span> r2 = <span class="keyword">new</span> <span class="title class_">RegExp</span>(<span class="string">&#x27;test&#x27;</span>, <span class="string">&#x27;g&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>全局匹配可以多次执行<code>exec()</code>方法来搜索一个匹配的字符串。当我们指定<code>g</code>标志后，每次运行<code>exec()</code>，正则表达式本身会更新<code>lastIndex</code>属性，表示上次匹配到的最后索引：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&#x27;JavaScript, VBScript, JScript and ECMAScript&#x27;</span>;</span><br><span class="line"><span class="keyword">var</span> re=<span class="regexp">/[a-zA-Z]+Script/g</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用全局匹配:</span></span><br><span class="line">re.<span class="title function_">exec</span>(s); <span class="comment">// [&#x27;JavaScript&#x27;]</span></span><br><span class="line">re.<span class="property">lastIndex</span>; <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line">re.<span class="title function_">exec</span>(s); <span class="comment">// [&#x27;VBScript&#x27;]</span></span><br><span class="line">re.<span class="property">lastIndex</span>; <span class="comment">// 20</span></span><br></pre></td></tr></table></figure>

<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>JSON是JavaScript Object Notation的缩写，是一种数据存储格式</p>
<p>在JSON中，一共就这么几种数据类型：</p>
<ul>
<li>number：和JavaScript的<code>number</code>完全一致；</li>
<li>boolean：就是JavaScript的<code>true</code>或<code>false</code>；</li>
<li>string：就是JavaScript的<code>string</code>；</li>
<li>null：就是JavaScript的<code>null</code>；</li>
<li>array：就是JavaScript的<code>Array</code>表示方式——<code>[]</code>；</li>
<li>object：就是JavaScript的<code>&#123; ... &#125;</code>表示方式。</li>
</ul>
<p>为了统一解析，JSON的字符串规定必须用双引号<code>&quot;&quot;</code>，Object的键也必须用双引号<code>&quot;&quot;</code>。 </p>
<p>可以用<code>JSON.stringify(object, attribute, format)</code>将对象变为<code>json</code>输出，第一个参数是对象名，第二个参数是属性名或者是转换函数，第三个参数用于控制格式（一般是有多少个空格）</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span>,</span><br><span class="line">    <span class="attr">age</span>: <span class="number">14</span>,</span><br><span class="line">    <span class="attr">gender</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">1.65</span>,</span><br><span class="line">    <span class="attr">grade</span>: <span class="literal">null</span>,</span><br><span class="line">    <span class="string">&#x27;middle-school&#x27;</span>: <span class="string">&#x27;\&quot;W3C\&quot; Middle School&#x27;</span>,</span><br><span class="line">    <span class="attr">skills</span>: [<span class="string">&#x27;JavaScript&#x27;</span>, <span class="string">&#x27;Java&#x27;</span>, <span class="string">&#x27;Python&#x27;</span>, <span class="string">&#x27;Lisp&#x27;</span>]</span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">stringify</span>(xiaoming, [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;skills&#x27;</span>], <span class="string">&#x27;  &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;小明&quot;</span>,</span><br><span class="line">  <span class="string">&quot;skills&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;JavaScript&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Java&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Python&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Lisp&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果第二个参数是转化函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">convert</span>(<span class="params">key, value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value.<span class="title function_">toUpperCase</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">stringify</span>(xiaoming, convert, <span class="string">&#x27;  &#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>上面的代码把所有属性值都变成大写：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;小明&quot;</span>,</span><br><span class="line">  <span class="string">&quot;age&quot;</span>: <span class="number">14</span>,</span><br><span class="line">  <span class="string">&quot;gender&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">&quot;height&quot;</span>: <span class="number">1.65</span>,</span><br><span class="line">  <span class="string">&quot;grade&quot;</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="string">&quot;middle-school&quot;</span>: <span class="string">&quot;\&quot;W3C\&quot; MIDDLE SCHOOL&quot;</span>,</span><br><span class="line">  <span class="string">&quot;skills&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;JAVASCRIPT&quot;</span>,</span><br><span class="line">    <span class="string">&quot;JAVA&quot;</span>,</span><br><span class="line">    <span class="string">&quot;PYTHON&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LISP&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><p>如果你拿到一个<code>JSON</code>字符串，可以用<code>JSON.parse()</code>将其转换为js对象</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;[1,2,3,true]&#x27;</span>); <span class="comment">// [1, 2, 3, true]</span></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;name&quot;:&quot;小明&quot;,&quot;age&quot;:14&#125;&#x27;</span>); <span class="comment">// Object &#123;name: &#x27;小明&#x27;, age: 14&#125;</span></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;true&#x27;</span>); <span class="comment">// true</span></span><br><span class="line"><span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;123.45&#x27;</span>); <span class="comment">// 123.45</span></span><br></pre></td></tr></table></figure>

<p>parse还可以加上一个处理函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> obj = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(<span class="string">&#x27;&#123;&quot;name&quot;:&quot;小明&quot;,&quot;age&quot;:14&#125;&#x27;</span>, <span class="keyword">function</span> (<span class="params">key, value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (key === <span class="string">&#x27;name&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> value + <span class="string">&#x27;同学&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)); <span class="comment">// &#123;name: &#x27;小明同学&#x27;, age: 14&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="JS面向对象"><a href="#JS面向对象" class="headerlink" title="JS面向对象"></a>JS面向对象</h2><p>JS没有class的概念，如果要进行继承要用<code>Object.create()</code>方法，实质就是将一个类的prototype指向另一个类</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="title class_">Student</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Robot&#x27;</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">1.2</span>,</span><br><span class="line">    <span class="attr">run</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span> + <span class="string">&#x27; is running...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;小明&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">xiaoming.<span class="property">__proto__</span> = <span class="title class_">Student</span>;</span><br></pre></td></tr></table></figure>

<p>在编写JavaScript代码时，不要直接用<code>obj.__proto__</code>去改变一个对象的原型。<code>Object.create()</code>方法可以传入一个原型对象，并创建一个基于该原型的新对象 </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 原型对象:</span></span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Student</span> = &#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;Robot&#x27;</span>,</span><br><span class="line">    <span class="attr">height</span>: <span class="number">1.2</span>,</span><br><span class="line">    <span class="attr">run</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">name</span> + <span class="string">&#x27; is running...&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">createStudent</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="comment">// 基于Student原型创建一个新对象:</span></span><br><span class="line">    <span class="keyword">var</span> s = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="title class_">Student</span>);</span><br><span class="line">    <span class="comment">// 初始化新对象:</span></span><br><span class="line">    s.<span class="property">name</span> = name;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="title function_">createStudent</span>(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">xiaoming.<span class="title function_">run</span>(); <span class="comment">// 小明 is running...</span></span><br></pre></td></tr></table></figure>

<h4 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h4><p><code>new</code>一个对象，就是构造函数，如果不写new，那么就是一个普通函数，返回的是undefined</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Student</span>(<span class="params">name</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hello</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;Hello, &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span> + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> xiaoming = <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="string">&#x27;小明&#x27;</span>);</span><br><span class="line">xiaoming.<span class="property">name</span>; <span class="comment">// &#x27;小明&#x27;</span></span><br><span class="line">xiaoming.<span class="title function_">hello</span>(); <span class="comment">// Hello, 小明!</span></span><br></pre></td></tr></table></figure>

<p>新创建的xiaoming的原型链是：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xiaoming ----&gt; Student.prototype ----&gt; Object.prototype ----&gt; null</span><br></pre></td></tr></table></figure>

<h3 id="原型继承"><a href="#原型继承" class="headerlink" title="原型继承"></a>原型继承</h3><h3 id="class继承"><a href="#class继承" class="headerlink" title="class继承"></a>class继承</h3><p>原型继承章节比较难，之后会回过来看</p>
<p>ES6引入了class关键字，可以直接包含构造函数和定义在原型上的其他函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">name</span> = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;Hello, &#x27;</span> + <span class="variable language_">this</span>.<span class="property">name</span> + <span class="string">&#x27;!&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有了class之后，直接用extends就可以继承，调用父类方法直接用<code>super</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">PrimaryStudent</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Student</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">name, grade</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(name); <span class="comment">// 记得用super调用父类的构造方法!</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">grade</span> = grade;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">myGrade</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;I am at grade &#x27;</span> + <span class="variable language_">this</span>.<span class="property">grade</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="浏览器"><a href="#浏览器" class="headerlink" title="浏览器"></a>浏览器</h2><p>js可以获取浏览器对象并对其操作，<code>window</code>不光是全局作用域，还表示浏览器窗口，<code>window</code>对象有<code>innerWidth</code>和<code>innerHeight</code>属性 ，可以获取浏览器窗口的内部宽度和高度。内部宽高是指除去菜单栏、工具栏、边框等占位元素后，用于显示网页的净宽高。 </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;window inner size: &#x27;</span> + <span class="variable language_">window</span>.<span class="property">innerWidth</span> + <span class="string">&#x27; x &#x27;</span> + <span class="variable language_">window</span>.<span class="property">innerHeight</span>);</span><br></pre></td></tr></table></figure>

<p><code>navigator</code>通常包含的是浏览器信息，常用的属性包括：</p>
<ul>
<li>navigator.appName：浏览器名称；</li>
<li>navigator.appVersion：浏览器版本；</li>
<li>navigator.language：浏览器设置的语言；</li>
<li>navigator.platform：操作系统类型；</li>
<li>navigator.userAgent：浏览器设定的<code>User-Agent</code>字符串。</li>
</ul>
<h3 id="操作DOM"><a href="#操作DOM" class="headerlink" title="操作DOM"></a>操作DOM</h3><p>HTML文件被浏览器解析为一棵DOM（Document Object Model）树，要改变HTML的结构，就要用js来操作DOM</p>
<p>对DOM的操作主要有以下几种：</p>
<ul>
<li>更新：更新该DOM节点的内容，相当于更新了该DOM节点表示的HTML的内容；</li>
<li>遍历：遍历该DOM节点下的子节点，以便进行进一步操作；</li>
<li>添加：在该DOM节点下新增一个子节点，相当于动态增加了一个HTML节点；</li>
<li>删除：将该节点从HTML中删除，相当于删掉了该DOM节点的内容以及它包含的所有子节点。</li>
</ul>
<p>拿到DOM节点和之前用<code>selenium</code>写爬虫的方法基本是一致的，方法主要有<code>document.getElementById()</code>和<code>document.getElementsByTagName()</code>，以及CSS选择器<code>document.getElementsByClassName()</code> </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 返回ID为&#x27;test&#x27;的节点：</span></span><br><span class="line"><span class="keyword">var</span> test = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先定位ID为&#x27;test-table&#x27;的节点，再返回其内部所有tr节点：</span></span><br><span class="line"><span class="keyword">var</span> trs = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-table&#x27;</span>).<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;tr&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先定位ID为&#x27;test-div&#x27;的节点，再返回其内部所有class包含red的节点：</span></span><br><span class="line"><span class="keyword">var</span> reds = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-div&#x27;</span>).<span class="title function_">getElementsByClassName</span>(<span class="string">&#x27;red&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取节点test下的所有直属子节点:</span></span><br><span class="line"><span class="keyword">var</span> cs = test.<span class="property">children</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取节点test下第一个、最后一个子节点：</span></span><br><span class="line"><span class="keyword">var</span> first = test.<span class="property">firstElementChild</span>;</span><br><span class="line"><span class="keyword">var</span> last = test.<span class="property">lastElementChild</span>;</span><br></pre></td></tr></table></figure>

<p>还有一种是跟<code>scrapy</code>写爬虫的时候的<code>query</code>选择器差不多的语法</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 通过querySelector获取ID为q1的节点：</span></span><br><span class="line"><span class="keyword">var</span> q1 = <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#q1&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过querySelectorAll获取q1节点内的符合条件的所有节点：</span></span><br><span class="line"><span class="keyword">var</span> ps = q1.<span class="title function_">querySelectorAll</span>(<span class="string">&#x27;div.highlighted &gt; p&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="修改DOM"><a href="#修改DOM" class="headerlink" title="修改DOM"></a>修改DOM</h4><p>直接修改拿到的节点的innerHTML内容，这要把HTML的内容替换进去：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置文本为abc:</span></span><br><span class="line">p.<span class="property">innerHTML</span> = <span class="string">&#x27;ABC&#x27;</span>; <span class="comment">// &lt;p id=&quot;p-id&quot;&gt;ABC&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<p>还有一种是替换<code>innerText</code>或者<code>innerContent</code>，这样替换的只是html标签中间的文字内容，不能改变html内容</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置文本:</span></span><br><span class="line">p.<span class="property">innerText</span> = <span class="string">&#x27;&lt;script&gt;alert(&quot;Hi&quot;)&lt;/script&gt;&#x27;</span>;</span><br><span class="line"><span class="comment">// HTML被自动编码，无法设置一个&lt;script&gt;节点:</span></span><br><span class="line"><span class="comment">// &lt;p id=&quot;p-id&quot;&gt;&amp;lt;script&amp;gt;alert(&quot;Hi&quot;)&amp;lt;/script&amp;gt;&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<p>两者的区别在于读取属性时，<code>innerText</code>不返回隐藏元素的文本，而<code>textContent</code>返回所有文本</p>
<p>还可以通过js修改css样式，直接对对象的<code>Object.style.xxx</code>进行修改</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取&lt;p id=&quot;p-id&quot;&gt;...&lt;/p&gt;</span></span><br><span class="line"><span class="keyword">var</span> p = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;p-id&#x27;</span>);</span><br><span class="line"><span class="comment">// 设置CSS:</span></span><br><span class="line">p.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;#ff0000&#x27;</span>;</span><br><span class="line">p.<span class="property">style</span>.<span class="property">fontSize</span> = <span class="string">&#x27;20px&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>所有修改的css样式名称用驼峰命名法</p>
<h4 id="插入DOM"><a href="#插入DOM" class="headerlink" title="插入DOM"></a>插入DOM</h4><p>如果一个标签原本是空的，你直接修改它的<code>innerHTML</code>就相当于插入了一个DOM</p>
<p>如果不是空的，就需要用<code>appendChild</code>方法，将一个子节点加到父节点的最后一个节点</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML结构 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;js&quot;</span>&gt;</span>JavaScript<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;java&quot;</span>&gt;</span>Java<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;python&quot;</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;scheme&quot;</span>&gt;</span>Scheme<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>把<code>&lt;p id=&quot;js&quot;&gt;JavaScript&lt;/p&gt;</code>添加到<code>&lt;div id=&quot;list&quot;&gt;</code>的最后一项：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    js = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;js&#x27;</span>),</span><br><span class="line">    list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>);</span><br><span class="line">list.<span class="title function_">appendChild</span>(js);</span><br></pre></td></tr></table></figure>

<p>现在，HTML结构变成了这样：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML结构 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;list&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;java&quot;</span>&gt;</span>Java<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;python&quot;</span>&gt;</span>Python<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;scheme&quot;</span>&gt;</span>Scheme<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;js&quot;</span>&gt;</span>JavaScript<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>因为我们插入的<code>js</code>是从html中获取的，因此相当于把上面的节点append到了下面</p>
<p>当然你也可以通过<code>document.createElement(&#39;tag&#39;)</code>来建立某个标签，然后再<code>appendChild</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>),</span><br><span class="line">    haskell = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">haskell.<span class="property">id</span> = <span class="string">&#x27;haskell&#x27;</span>;</span><br><span class="line">haskell.<span class="property">innerText</span> = <span class="string">&#x27;Haskell&#x27;</span>;</span><br><span class="line">list.<span class="title function_">appendChild</span>(haskell);</span><br></pre></td></tr></table></figure>

<p>如果要插入到指定位置，那么就用<code>insertBefore</code>函数，用法是<code>父节点.insertBefore(新节点，参考节点)</code>，这样就把新节点插到了参考节点之前</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    list = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;list&#x27;</span>),</span><br><span class="line">    ref = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;python&#x27;</span>),</span><br><span class="line">    haskell = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;p&#x27;</span>);</span><br><span class="line">haskell.<span class="property">id</span> = <span class="string">&#x27;haskell&#x27;</span>;</span><br><span class="line">haskell.<span class="property">innerText</span> = <span class="string">&#x27;Haskell&#x27;</span>;</span><br><span class="line">list.<span class="title function_">insertBefore</span>(haskell, ref);</span><br></pre></td></tr></table></figure>

<h3 id="删除DOM"><a href="#删除DOM" class="headerlink" title="删除DOM"></a>删除DOM</h3><p>删除一个节点只需要得到父节点和本身，然后用<code>父节点.removechild(本身)</code>移除掉特定的节点</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 拿到待删除节点:</span></span><br><span class="line"><span class="keyword">var</span> self = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;to-be-removed&#x27;</span>);</span><br><span class="line"><span class="comment">// 拿到父节点:</span></span><br><span class="line"><span class="keyword">var</span> parent = self.<span class="property">parentElement</span>;</span><br><span class="line"><span class="comment">// 删除:</span></span><br><span class="line"><span class="keyword">var</span> removed = parent.<span class="title function_">removeChild</span>(self);</span><br><span class="line">removed === self; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>###js操作表单</p>
<p>js操作表单和操作DOM类似，因为表单本身也是DOM</p>
<p>HTML表单的输入控件主要有以下几种：</p>
<ul>
<li>文本框，对应的<code>&lt;input type=&quot;text&quot;&gt;</code>，用于输入文本；</li>
<li>密码框，对应的<code>&lt;input type=&quot;password&quot;&gt;</code>，用于输入口令；</li>
<li>单选框，对应的<code>&lt;input type=&quot;radio&quot;&gt;</code>，用于选择一项；</li>
<li>复选框，对应的<code>&lt;input type=&quot;checkbox&quot;&gt;</code>，用于选择多项；</li>
<li>下拉框，对应的<code>&lt;select&gt;</code>，用于选择一项；</li>
<li>隐藏文本，对应的<code>&lt;input type=&quot;hidden&quot;&gt;</code>，用户不可见，但表单提交时会把隐藏文本发送到服务器。</li>
</ul>
<p>先获取一个表单，然后直接对value赋值，就可以改变value的值</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;input type=&quot;text&quot; id=&quot;email&quot;&gt;</span></span><br><span class="line"><span class="keyword">var</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">input.<span class="property">value</span>; <span class="comment">// &#x27;用户输入的值&#x27;</span></span><br></pre></td></tr></table></figure>

<p>这种方式可以应用于<code>text</code>、<code>password</code>、<code>hidden</code>以及<code>select</code>。但是，对于单选框和复选框，应该用<code>checked</code>判断是否被勾上，也可以对他们设置值将其勾上：</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;weekday&quot; id=&quot;monday&quot; value=&quot;1&quot;&gt; Monday&lt;/label&gt;</span></span><br><span class="line"><span class="comment">// &lt;label&gt;&lt;input type=&quot;radio&quot; name=&quot;weekday&quot; id=&quot;tuesday&quot; value=&quot;2&quot;&gt; Tuesday&lt;/label&gt;</span></span><br><span class="line"><span class="keyword">var</span> mon = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;monday&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> tue = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;tuesday&#x27;</span>);</span><br><span class="line">mon.<span class="property">value</span>; <span class="comment">// &#x27;1&#x27;</span></span><br><span class="line">tue.<span class="property">value</span>; <span class="comment">// &#x27;2&#x27;</span></span><br><span class="line">mon.<span class="property">checked</span>; <span class="comment">// true或者false</span></span><br><span class="line">tue.<span class="property">checked</span>; <span class="comment">// true或者false</span></span><br><span class="line">mon.<span class="property">checked</span> = <span class="literal">true</span>; <span class="comment">//勾上mon这个选项</span></span><br></pre></td></tr></table></figure>

<h4 id="HTML5控件"><a href="#HTML5控件" class="headerlink" title="HTML5控件"></a>HTML5控件</h4><p>HTML5比标准的HTML多了几种控件，常用的有<code>date</code>、<code>datetime</code>、<code>datetime-local</code>、<code>color</code>等，它们都使用<code>&lt;input&gt;</code>标签 </p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;date&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2015-07-01&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;datetime-local&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2015-07-01T02:03:04&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;color&quot;</span> <span class="attr">value</span>=<span class="string">&quot;#ff0000&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="提交表单"><a href="#提交表单" class="headerlink" title="提交表单"></a>提交表单</h4><p>js有两种方式提交表单，在提交的时候可以对form当中的值进行修改或者是判断是否符合规则</p>
<p>第一种是通过<code>&lt;form&gt;</code>元素的<code>submit()</code>方法进行提交</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;!-- <span class="variable constant_">HTML</span> --&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;test-form&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;doSubmitForm()&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"><span class="keyword">function</span> <span class="title function_">doSubmitForm</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="keyword">var</span> form = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-form&#x27;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 可以在此修改form的input...</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    <span class="comment">// 提交form:</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">    form.<span class="title function_">submit</span>();</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">&#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<p>这种方式的缺点是扰乱了浏览器对form的正常提交。浏览器默认点击<code>&lt;button type=&quot;submit&quot;&gt;</code>时提交表单，或者用户在最后一个输入框按回车键。因此，第二种方式是响应<code>&lt;form&gt;</code>本身的<code>onsubmit</code>事件，在提交form时作修改：</p>
 <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;test-form&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">checkForm</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> form = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-form&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 可以在此修改form的input...</span></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 继续下一步:</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最后一定要<code>return true</code>，这样浏览器才会提交表单，如果<code>return false</code>浏览器就不会提交表单</p>
<p>在检查和修改<code>&lt;input&gt;</code>时，要充分利用<code>&lt;input type=&quot;hidden&quot;&gt;</code>来传递数据。</p>
<p>例如，很多登录表单希望用户输入用户名和口令，但是，安全考虑，提交表单时不传输明文口令，而是口令的MD5。普通JavaScript开发人员会直接修改<code>&lt;input&gt;</code>：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;login-form&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">checkForm</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> pwd = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;password&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 把用户输入的明文变为MD5:</span></span></span><br><span class="line"><span class="language-javascript">    pwd.<span class="property">value</span> = <span class="title function_">toMD5</span>(pwd.<span class="property">value</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 继续下一步:</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个做法看上去没啥问题，但用户输入了口令提交时，口令框的显示会突然从几个<code>*</code>变成32个<code>*</code>（因为MD5有32个字符）。</p>
<p>要想不改变用户的输入，可以利用<code>&lt;input type=&quot;hidden&quot;&gt;</code>实现：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- HTML --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">id</span>=<span class="string">&quot;login-form&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">onsubmit</span>=<span class="string">&quot;return checkForm()&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;username&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">id</span>=<span class="string">&quot;input-password&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">id</span>=<span class="string">&quot;md5-password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Submit<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">checkForm</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> input_pwd = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;input-password&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> md5_pwd = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;md5-password&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 把用户输入的明文变为MD5:</span></span></span><br><span class="line"><span class="language-javascript">    md5_pwd.<span class="property">value</span> = <span class="title function_">toMD5</span>(input_pwd.<span class="property">value</span>);</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 继续下一步:</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">return</span> <span class="literal">true</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意到<code>id</code>为<code>md5-password</code>的<code>&lt;input&gt;</code>标记了<code>name=&quot;password&quot;</code>，而用户输入的<code>id</code>为<code>input-password</code>的<code>&lt;input&gt;</code>没有<code>name</code>属性。没有<code>name</code>属性的<code>&lt;input&gt;</code>的数据不会被提交。</p>
<h4 id="上传文件"><a href="#上传文件" class="headerlink" title="上传文件"></a>上传文件</h4><p>HTML当中上传文件，用到的唯一控件就是<code>&lt;inpt type=&quot;file&quot;&gt;</code></p>
<p><em>注意</em>：当一个表单包含<code>&lt;input type=&quot;file&quot;&gt;</code>时，表单的<code>enctype</code>必须指定为<code>multipart/form-data</code>，<code>method</code>必须指定为<code>post</code>，浏览器才能正确编码并以<code>multipart/form-data</code>格式发送表单的数据。</p>
<p> 一般来说上传文件由后台处理，js可以在提交时对文件名称进行检查，以防止上传无效格式的文件</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> f = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-file-upload&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> filename = f.<span class="property">value</span>; <span class="comment">// &#x27;C:\fakepath\test.png&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (!filename || !( filename.<span class="title function_">endsWith</span>(<span class="string">&#x27;.jpg&#x27;</span>) || filename.<span class="title function_">endsWith</span>(<span class="string">&#x27;.png&#x27;</span>) || filename.<span class="title function_">endsWith</span>(<span class="string">&#x27;.gif&#x27;</span>))) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(<span class="string">&#x27;Can only upload image file.&#x27;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="File-API"><a href="#File-API" class="headerlink" title="File API"></a>File API</h4><p>HTML5新增的File API允许js读取文件内容，提供了<code>File</code>和<code>FileReader</code>两个主要对象，可以获取文件信息并读取文件</p>
<p>下面这段代码是预览图片并显示相关信息的代码</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    fileInput = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-image-file&#x27;</span>),</span><br><span class="line">    info = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-file-info&#x27;</span>),</span><br><span class="line">    preview = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-image-preview&#x27;</span>);</span><br><span class="line"><span class="comment">// 监听change事件:</span></span><br><span class="line">fileInput.<span class="title function_">addEventListener</span>(<span class="string">&#x27;change&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 清除背景图片:</span></span><br><span class="line">    preview.<span class="property">style</span>.<span class="property">backgroundImage</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="comment">// 检查文件是否选择:</span></span><br><span class="line">    <span class="keyword">if</span> (!fileInput.<span class="property">value</span>) &#123;</span><br><span class="line">        info.<span class="property">innerHTML</span> = <span class="string">&#x27;没有选择文件&#x27;</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取File引用:</span></span><br><span class="line">    <span class="keyword">var</span> file = fileInput.<span class="property">files</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// 获取File信息:</span></span><br><span class="line">    info.<span class="property">innerHTML</span> = <span class="string">&#x27;文件: &#x27;</span> + file.<span class="property">name</span> + <span class="string">&#x27;&lt;br&gt;&#x27;</span> +</span><br><span class="line">                     <span class="string">&#x27;大小: &#x27;</span> + file.<span class="property">size</span> + <span class="string">&#x27;&lt;br&gt;&#x27;</span> +</span><br><span class="line">                     <span class="string">&#x27;修改: &#x27;</span> + file.<span class="property">lastModifiedDate</span>;</span><br><span class="line">    <span class="keyword">if</span> (file.<span class="property">type</span> !== <span class="string">&#x27;image/jpeg&#x27;</span> &amp;&amp; file.<span class="property">type</span> !== <span class="string">&#x27;image/png&#x27;</span> &amp;&amp; file.<span class="property">type</span> !== <span class="string">&#x27;image/gif&#x27;</span>) &#123;</span><br><span class="line">        <span class="title function_">alert</span>(<span class="string">&#x27;不是有效的图片文件!&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 读取文件:</span></span><br><span class="line">    <span class="keyword">var</span> reader = <span class="keyword">new</span> <span class="title class_">FileReader</span>();</span><br><span class="line">    reader.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span></span><br><span class="line">            data = e.<span class="property">target</span>.<span class="property">result</span>; <span class="comment">// &#x27;data:image/jpeg;base64,/9j/4AAQSk...(base64编码)...&#x27;            </span></span><br><span class="line">        preview.<span class="property">style</span>.<span class="property">backgroundImage</span> = <span class="string">&#x27;url(&#x27;</span> + data + <span class="string">&#x27;)&#x27;</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// 以DataURL的形式读取文件:</span></span><br><span class="line">    reader.<span class="title function_">readAsDataURL</span>(file);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这一部分的回调函数也不是太懂，之后会再回来看看</p>
<h3 id="AJAX"><a href="#AJAX" class="headerlink" title="AJAX"></a>AJAX</h3><p>AJAX（Asynchronous JavaScript and XML ）就是异步加载的JavaScript，一般提交一个Form，点击submit之后浏览器就会刷新页面，告诉你成功还是失败，web就是这样，一次HTTP请求对应一个页面</p>
<p>如果你想要用户留在当前页面，同时发出HTTP请求，就必须要用js发送请求，接收到数据后再用js更新页面。这样页面没有刷新，但是数据不断地更新。</p>
<p>AJAX请求是异步执行的，也就是说，要通过回调函数获得响应。 </p>
<p>在现代浏览器上写AJAX主要依靠<code>XMLHttpRequest</code>对象：  </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">success</span>(<span class="params">text</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> textarea = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-response-text&#x27;</span>);</span><br><span class="line">    textarea.<span class="property">value</span> = text;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">fail</span>(<span class="params">code</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> textarea = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-response-text&#x27;</span>);</span><br><span class="line">    textarea.<span class="property">value</span> = <span class="string">&#x27;Error code: &#x27;</span> + code;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> request = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>(); <span class="comment">// 新建XMLHttpRequest对象</span></span><br><span class="line"></span><br><span class="line">request.<span class="property">onreadystatechange</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="comment">// 状态发生变化时，函数被回调</span></span><br><span class="line">    <span class="keyword">if</span> (request.<span class="property">readyState</span> === <span class="number">4</span>) &#123; <span class="comment">// 成功完成</span></span><br><span class="line">        <span class="comment">// 判断响应结果:</span></span><br><span class="line">        <span class="keyword">if</span> (request.<span class="property">status</span> === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="comment">// 成功，通过responseText拿到响应的文本:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">success</span>(request.<span class="property">responseText</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 失败，根据响应码判断失败原因:</span></span><br><span class="line">            <span class="keyword">return</span> <span class="title function_">fail</span>(request.<span class="property">status</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// HTTP请求还在继续...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送请求:</span></span><br><span class="line">request.<span class="title function_">open</span>(<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;/api/categories&#x27;</span>);</span><br><span class="line">request.<span class="title function_">send</span>();</span><br><span class="line"></span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&#x27;请求已发送，请等待响应...&#x27;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当创建了<code>XMLHttpRequest</code>对象后，要先设置<code>onreadystatechange</code>的回调函数。在回调函数中，通常我们只需通过<code>readyState === 4</code>判断请求是否完成，如果已完成，再根据<code>status === 200</code>判断是否是一个成功的响应。</p>
<h4 id="请求第三方网站数据CORS"><a href="#请求第三方网站数据CORS" class="headerlink" title="请求第三方网站数据CORS"></a>请求第三方网站数据CORS</h4><p>CORS全称Cross-Origin Resource Sharing，是HTML5规范定义的如何跨域访问资源。</p>
<p><img src="https://cdn.liaoxuefeng.com/cdn/files/attachments/00143640805071744d58164a40e42ef92b9973824451595000/l" alt="js-cors"> </p>
<p>只要浏览器的相应的<code>Access-Control-Allow-Origin</code>包含本域，则此次跨域请求成功 </p>
<h3 id="Promise"><a href="#Promise" class="headerlink" title="Promise"></a>Promise</h3><p>Promise是一种ajax异步加载，比较难，之后再看</p>
<h3 id="Canvas"><a href="#Canvas" class="headerlink" title="Canvas"></a>Canvas</h3><p>canvas可以用来画图</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">canvas</span> <span class="attr">id</span>=<span class="string">&quot;test-canvas&quot;</span> <span class="attr">width</span>=<span class="string">&quot;300&quot;</span> <span class="attr">height</span>=<span class="string">&quot;200&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">canvas</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> <code>getContext(&#39;2d&#39;)</code>方法让我们拿到一个<code>CanvasRenderingContext2D</code>对象，所有的绘图操作都需要通过这个对象完成。</p>
 <figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>左上角为原点，其余为x，y轴开始画图</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span></span><br><span class="line">    canvas = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;test-shape-canvas&#x27;</span>),</span><br><span class="line">    ctx = canvas.<span class="title function_">getContext</span>(<span class="string">&#x27;2d&#x27;</span>);</span><br><span class="line">ctx.<span class="title function_">clearRect</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">200</span>, <span class="number">200</span>); <span class="comment">// 擦除(0,0)位置大小为200x200的矩形，擦除的意思是把该区域变为透明</span></span><br><span class="line">ctx.<span class="property">fillStyle</span> = <span class="string">&#x27;#dddddd&#x27;</span>; <span class="comment">// 设置颜色</span></span><br><span class="line">ctx.<span class="title function_">fillRect</span>(<span class="number">10</span>, <span class="number">10</span>, <span class="number">130</span>, <span class="number">130</span>); <span class="comment">// 把(10,10)位置大小为130x130的矩形涂色</span></span><br><span class="line"><span class="comment">// 利用Path绘制复杂路径:</span></span><br><span class="line"><span class="keyword">var</span> path=<span class="keyword">new</span> <span class="title class_">Path2D</span>();</span><br><span class="line">path.<span class="title function_">arc</span>(<span class="number">75</span>, <span class="number">75</span>, <span class="number">50</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>*<span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">path.<span class="title function_">moveTo</span>(<span class="number">110</span>,<span class="number">75</span>);</span><br><span class="line">path.<span class="title function_">arc</span>(<span class="number">75</span>, <span class="number">75</span>, <span class="number">35</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>, <span class="literal">false</span>);</span><br><span class="line">path.<span class="title function_">moveTo</span>(<span class="number">65</span>, <span class="number">65</span>);</span><br><span class="line">path.<span class="title function_">arc</span>(<span class="number">60</span>, <span class="number">65</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>*<span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">path.<span class="title function_">moveTo</span>(<span class="number">95</span>, <span class="number">65</span>);</span><br><span class="line">path.<span class="title function_">arc</span>(<span class="number">90</span>, <span class="number">65</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="title class_">Math</span>.<span class="property">PI</span>*<span class="number">2</span>, <span class="literal">true</span>);</span><br><span class="line">ctx.<span class="property">strokeStyle</span> = <span class="string">&#x27;#0000ff&#x27;</span>;</span><br><span class="line">ctx.<span class="title function_">stroke</span>(path);</span><br></pre></td></tr></table></figure>

<h2 id="jQuery"><a href="#jQuery" class="headerlink" title="jQuery"></a>jQuery</h2><h1 id="JavaScript-简介"><a href="#JavaScript-简介" class="headerlink" title="JavaScript 简介"></a>JavaScript 简介</h1><!--more-->

<p>JavaScript 是互联网上最流行的脚本语言，这门语言可用于 HTML 和 web，更可广泛用于服务器、PC、笔记本电脑、平板电脑和智能手机等设备。</p>
<p>每一句后面添加“；”</p>
<p>放在html的head之间：</p>
<p>①<code>&lt;script type=&quot;text/javascript&quot;&gt;     &lt;/script&gt;</code>；</p>
<p>②<code>&lt;script src=&quot;script.js&quot;&gt;           &lt;/script&gt; ;</code></p>
<h2 id="直接写入-HTML-输出流"><a href="#直接写入-HTML-输出流" class="headerlink" title="直接写入 HTML 输出流"></a>直接写入 HTML 输出流</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;h1&gt;这是一个标题&lt;/h1&gt;&quot;</span>);</span><br><span class="line"><span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;&lt;p&gt;这是一个段落。&lt;/p&gt;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>输出多个内容时与python一样用+连接</p>
<p>输出html标签时（例如输出<code>“&lt;br/&gt;”</code>)，需要用引号扩上并用<code>&lt;&gt;</code>包围</p>
<h2 id="对事件的反应"><a href="#对事件的反应" class="headerlink" title="对事件的反应"></a>对事件的反应</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;button type=<span class="string">&quot;button&quot;</span> onclick=<span class="string">&quot;alert(&#x27;欢迎!&#x27;)&quot;</span>&gt;点我!&lt;/button&gt;</span><br></pre></td></tr></table></figure>

<h2 id="改变-HTML-内容"><a href="#改变-HTML-内容" class="headerlink" title="改变 HTML 内容"></a>改变 HTML 内容</h2><figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">x=<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;demo&quot;</span>)  <span class="comment">//查找元素</span></span><br><span class="line">x.<span class="property">innerHTML</span>=<span class="string">&quot;Hello JavaScript&quot;</span>;    <span class="comment">//改变内容</span></span><br></pre></td></tr></table></figure>

<p>您会经常看到 <em><strong>document.getElementById</strong></em>(“<em><strong>some id</strong></em>“)。这个方法是 HTML DOM 中定义的。</p>
<p>DOM (<strong>D</strong>ocument <strong>O</strong>bject <strong>M</strong>odel)（文档对象模型）是用于访问 HTML 元素的正式 W3C 标准。</p>
<h2 id="定义变量"><a href="#定义变量" class="headerlink" title="定义变量"></a>定义变量</h2><p>定义变量使用关键词<code>var</code>，语法如下：</p>
<p><code>var 变量名</code></p>
<p><strong>变量名可以任意取名，但要遵循命名规则:</strong></p>
<p>​    1.变量必须使用字母、下划线(_)或者美元符($)开始。</p>
<p>​    2.然后可以使用任意多个英文字母、数字、下划线(_)或者美元符($)组成。</p>
<p>​    3.不能使用JavaScript关键词与JavaScript保留字。</p>
<p><strong>注意：Javascript里面区分大小写，变量mychar和myChar是不同的变量</strong></p>
<h2 id="条件判断语句"><a href="#条件判断语句" class="headerlink" title="条件判断语句"></a>条件判断语句</h2><p>语法：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(条件)</span><br><span class="line">&#123; 条件成立时执行的代码 &#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123; 条件不成立时执行的代码 &#125;</span><br></pre></td></tr></table></figure>

<h2 id="JavaScript定义函数"><a href="#JavaScript定义函数" class="headerlink" title="JavaScript定义函数"></a>JavaScript定义函数</h2><p>关键字<code>function</code>，用法如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> 函数名()&#123;</span><br><span class="line">  函数代码；</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>点击按钮出提示的例子：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;!<span class="variable constant_">DOCTYPE</span> <span class="variable constant_">HTML</span>&gt;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">title</span>&gt;</span>函数调用<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">       <span class="keyword">function</span> <span class="title function_">contxt</span>(<span class="params"></span>) <span class="comment">//定义函数</span></span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#123;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">         <span class="title function_">alert</span>(<span class="string">&quot;哈哈，调用函数了!&quot;</span>);</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">      &#125;</span></span></span><br><span class="line"><span class="language-javascript"><span class="language-xml">   </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span>  <span class="attr">value</span>=<span class="string">&quot;点击我&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;contxt()&quot;</span>/&gt;</span>  </span></span><br><span class="line"><span class="language-xml">   <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="alert-警告框"><a href="#alert-警告框" class="headerlink" title="alert 警告框"></a>alert 警告框</h2><p><code>alert</code>是在屏幕上弹出一个警示框，点击确认之后消失，其使用方法如下：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">alert_test</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="keyword">var</span> mychar = <span class="string">&quot;一个警告&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(mychar);</span></span><br><span class="line"><span class="language-javascript">    &#125; </span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span>&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">name</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;rec()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;点击我弹出对话框&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="confirm-选择框"><a href="#confirm-选择框" class="headerlink" title="confirm 选择框"></a>confirm 选择框</h2><p><code>confirm</code>是在屏幕上弹出一个选择框，点击确认返回true，否则返回false</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>confirm<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">rec</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">var</span> mymessage= <span class="title function_">confirm</span>(<span class="string">&quot;你是女士吗&quot;</span>)     ;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span>(mymessage==<span class="literal">true</span>)</span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">    	<span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;你是女士!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">else</span></span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;你是男士!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;    </span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;button&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onClick</span>=<span class="string">&quot;rec()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;点击我，弹出确认对话框&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="prompt提示框"><a href="#prompt提示框" class="headerlink" title="prompt提示框"></a>prompt提示框</h2><p><code>“”</code>是弹出一个提示框，同时你可以在这个提示框中输入值并返回</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">&quot;Content-Type&quot;</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=utf-8&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">title</span>&gt;</span>prompt<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">function</span> <span class="title function_">rec</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">var</span> score; <span class="comment">//score变量，用来存储用户输入的成绩值。</span></span></span><br><span class="line"><span class="language-javascript">	score = <span class="title function_">prompt</span>(<span class="string">&quot;请输入你的成绩&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">if</span>(score&gt;=<span class="number">90</span>)</span></span><br><span class="line"><span class="language-javascript">	&#123;</span></span><br><span class="line"><span class="language-javascript">	   <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;你很棒!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">else</span> <span class="keyword">if</span>(score&gt;=<span class="number">75</span>)</span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">	   <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;不错吆!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">	<span class="keyword">else</span> <span class="keyword">if</span>(score&gt;=<span class="number">60</span>)</span></span><br><span class="line"><span class="language-javascript">    &#123;</span></span><br><span class="line"><span class="language-javascript">	   <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;要加油!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">else</span></span></span><br><span class="line"><span class="language-javascript">	&#123;</span></span><br><span class="line"><span class="language-javascript">       <span class="variable language_">document</span>.<span class="title function_">write</span>(<span class="string">&quot;要努力了!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">	&#125;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">  </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;button&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">onClick</span>=<span class="string">&quot;rec()&quot;</span> <span class="attr">value</span>=<span class="string">&quot;点击我，对成绩做评价!&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="打开新窗口"><a href="#打开新窗口" class="headerlink" title="打开新窗口"></a>打开新窗口</h2><p><code>open()</code> 方法可以查找一个已经存在或者新建的浏览器窗口。语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">window.open([URL], [窗口名称], [参数字符串])</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">窗口名称：可选参数，被打开窗口的名称。</span><br><span class="line">    1.该名称由字母、数字和下划线字符组成。</span><br><span class="line">    2.&quot;_top&quot;、&quot;_blank&quot;、&quot;_self&quot;具有特殊意义的名称。</span><br><span class="line">       _blank：在新窗口显示目标网页</span><br><span class="line">       _self：在当前窗口显示目标网页</span><br><span class="line">       _top：框架网页中在上部窗口中显示目标网页</span><br><span class="line">    3.相同 name 的窗口只能创建一个，要想创建多个窗口则 name 不能相同。</span><br><span class="line">   4.name 不能包含有空格。</span><br><span class="line">参数字符串：可选参数，设置窗口参数，各参数用逗号隔开。</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-7/21084204.jpg"></p>
<h2 id="关闭窗口"><a href="#关闭窗口" class="headerlink" title="关闭窗口"></a>关闭窗口</h2><p><code>window.close</code>关闭窗口</p>
<h2 id="DOM"><a href="#DOM" class="headerlink" title="DOM"></a>DOM</h2><p>dom意思是document object model，文档对象模型，是把html代码分割成3类节点：文本节点，属性节点，元素节点的树形结构</p>
<h2 id="通过id寻找元素"><a href="#通过id寻找元素" class="headerlink" title="通过id寻找元素"></a>通过id寻找元素</h2><p><code>document.getElementByid(&#39;id&#39;)</code></p>
<h2 id="innerHTML改变html元素内容"><a href="#innerHTML改变html元素内容" class="headerlink" title="innerHTML改变html元素内容"></a>innerHTML改变html元素内容</h2><p>用于改变html代码中的内容，通过<code>docment.getElementById</code>找到元素并赋值给object，然后用<code>object.innerHTML = &quot;new content&quot;</code>进行赋值</p>
<h2 id="改变html样式"><a href="#改变html样式" class="headerlink" title="改变html样式"></a>改变html样式</h2><p>用<code>object.style.property =&quot;xxx&quot;</code>来改变html中元素的样式，object是通过<code>document.getElementById()</code>取得的元素对象</p>
<h2 id="显示或隐藏"><a href="#显示或隐藏" class="headerlink" title="显示或隐藏"></a>显示或隐藏</h2><p>通过<code>object.style.display = value</code>，<code>value</code>的值为<code>none</code>或者是<code>block</code></p>
<h2 id="更改类名"><a href="#更改类名" class="headerlink" title="更改类名"></a>更改类名</h2><p>通过<code>object.className=“xxx”</code>改变一个元素的类名</p>
<h2 id="移除style设置"><a href="#移除style设置" class="headerlink" title="移除style设置"></a>移除style设置</h2><p><code>object.removeAttribute(&quot;style&quot;)</code></p>
<p>用于移除对元素style的设置</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot常用注解</title>
    <url>/2019/11/14/SpringBoot%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/</url>
    <content><![CDATA[<p><strong>一、注解(annotations)列表</strong></p>
<ol>
<li><p>@SpringBootApplication：包含了@ComponentScan、@Configuration和@EnableAutoConfiguration注解。其中@ComponentScan让<a href="http://lib.csdn.net/base/javaee">spring</a> Boot扫描到Configuration类并把它加入到程序上下文。</p>
</li>
<li><p>@Configuration 等同于spring的XML配置文件；使用<a href="http://lib.csdn.net/base/javase">Java</a>代码可以检查类型安全。</p>
</li>
</ol>
<span id="more"></span>

<ol start="3">
<li><p>@EnableAutoConfiguration 自动配置。</p>
</li>
<li><p>@ComponentScan 组件扫描，可自动发现和装配一些Bean。</p>
</li>
<li><p>@Component可配合CommandLineRunner使用，在程序启动后执行一些基础任务。</p>
</li>
<li><p>@ResponseBody：restful接口，加了之后返回的是json格式的数据，如果不加，返回的是某个跳转的地址</p>
</li>
<li><p>@RestController注解是@Controller和@ResponseBody的合集,表示这是个控制器bean,并且是将函数的返回值直 接填入HTTP响应体中,是REST风格的控制器。</p>
</li>
<li><p>@Autowired自动导入。</p>
</li>
<li><p>@PathVariable获取参数。</p>
</li>
<li><p>@JsonBackReference解决嵌套外链问题。</p>
</li>
<li><p>@RepositoryRestResourcepublic配合spring-boot-starter-data-rest使用。</p>
</li>
</ol>
<p><strong>二、注解(annotations)详解</strong></p>
<p>@SpringBootApplication：申明让spring boot自动给程序进行必要的配置，这个配置等同于：@Configuration ，@EnableAutoConfiguration 和 @ComponentScan 三个配置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.example.myproject; </span><br><span class="line">import org.springframework.boot.SpringApplication; </span><br><span class="line">import org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line">@SpringBootApplication // same as @Configuration @EnableAutoConfiguration @ComponentScan </span><br><span class="line">public class Application &#123; </span><br><span class="line">public static void main(String[] args) &#123; </span><br><span class="line">SpringApplication.run(Application.class, args); </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>@ResponseBody：表示该方法的返回结果直接写入HTTP response body中，一般在异步获取数据时使用，用于构建RESTful的api。在使用@RequestMapping后，返回值通常解析为跳转路径，加上@responsebody后返回结果不会被解析为跳转路径，而是直接写入HTTP response body中。比如异步获取json数据，加上@responsebody后，会直接返回json数据。该注解一般会配合@RequestMapping一起使用。示例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(“/test”) </span><br><span class="line">@ResponseBody </span><br><span class="line">public String test()&#123; </span><br><span class="line">return”ok”; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Controller：用于定义控制器类，在spring 项目中由控制器负责将用户发来的URL请求转发到对应的服务接口（service层），一般这个注解在类中，通常方法需要配合注解@RequestMapping。示例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Controller </span><br><span class="line">@RequestMapping(“/demoInfo”) </span><br><span class="line">publicclass DemoController &#123; </span><br><span class="line">@Autowired </span><br><span class="line">private DemoInfoService demoInfoService;</span><br><span class="line"></span><br><span class="line">@RequestMapping(&quot;/hello&quot;)</span><br><span class="line">public String hello(Map&lt;String,Object&gt; map)&#123;</span><br><span class="line">   System.out.println(&quot;DemoController.hello()&quot;);</span><br><span class="line">   map.put(&quot;hello&quot;,&quot;from TemplateController.helloHtml&quot;);</span><br><span class="line">   //会使用hello.html或者hello.ftl模板进行渲染显示.</span><br><span class="line">   return&quot;/hello&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@RestController：用于标注控制层组件(如struts中的action)，@ResponseBody和@Controller的合集。示例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.kfit.demo.web;</span><br><span class="line"></span><br><span class="line">import org.springframework.web.bind.annotation.RequestMapping; </span><br><span class="line">import org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@RestController </span><br><span class="line">@RequestMapping(“/demoInfo2”) </span><br><span class="line">publicclass DemoController2 &#123;</span><br><span class="line"></span><br><span class="line">@RequestMapping(&quot;/test&quot;)</span><br><span class="line">public String test()&#123;</span><br><span class="line">   return&quot;ok&quot;;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>@RequestMapping：提供路由信息，负责URL到Controller中的具体函数的映射。</p>
<p>@EnableAutoConfiguration：Spring Boot自动配置（auto-configuration）：尝试根据你添加的jar依赖自动配置你的Spring应用。例如，如果你的classpath下存在HSQLDB，并且你没有手动配置任何<a href="http://lib.csdn.net/base/mysql">数据库</a>连接beans，那么我们将自动配置一个内存型（in-memory）数据库”。你可以将@EnableAutoConfiguration或者@SpringBootApplication注解添加到一个@Configuration类上来选择自动配置。如果发现应用了你不想要的特定自动配置类，你可以使用@EnableAutoConfiguration注解的排除属性来禁用它们。</p>
<p>@ComponentScan：表示将该类自动发现扫描组件。个人理解相当于，如果扫描到有@Component、@Controller、@Service等这些注解的类，并注册为Bean，可以自动收集所有的Spring组件，包括@Configuration类。我们经常使用@ComponentScan注解搜索beans，并结合@Autowired注解导入。可以自动收集所有的Spring组件，包括@Configuration类。我们经常使用@ComponentScan注解搜索beans，并结合@Autowired注解导入。如果没有配置的话，Spring Boot会扫描启动类所在包下以及子包下的使用了@Service,@Repository等注解的类。</p>
<p>@Configuration：相当于传统的xml配置文件，如果有些第三方库需要用到xml文件，建议仍然通过@Configuration类作为项目的配置主类——可以使用@ImportResource注解加载xml配置文件。</p>
<p>@Import：用来导入其他配置类。</p>
<p>@ImportResource：用来加载xml配置文件。</p>
<p>@Autowired：自动导入依赖的bean</p>
<p>@Service：一般用于修饰service层的组件</p>
<p>@Repository：使用@Repository注解可以确保DAO或者repositories提供异常转译，这个注解修饰的DAO或者repositories类会被ComponetScan发现并配置，同时也不需要为它们提供XML配置项。</p>
<p>@Bean：用@Bean标注方法等价于XML中配置的bean。</p>
<p>@Value：注入Spring boot application.properties配置的属性的值。示例代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Value(value = “#&#123;message&#125;”) </span><br><span class="line">private String message;</span><br></pre></td></tr></table></figure>

<p>@Inject：等价于默认的@Autowired，只是没有required属性；</p>
<p>@Component：泛指组件，当组件不好归类的时候，我们可以使用这个注解进行标注。</p>
<p>@Bean:相当于XML中的,放在方法的上面，而不是类，意思是产生一个bean,并交给spring管理。</p>
<p>@AutoWired：自动导入依赖的bean。byType方式。把配置好的Bean拿来用，完成属性、方法的组装，它可以对类成员变量、方法及构造函数进行标注，完成自动装配的工作。当加上（required&#x3D;false）时，就算找不到bean也不报错。</p>
<p>@Qualifier：当有多个同一类型的Bean时，可以用@Qualifier(“name”)来指定。与@Autowired配合使用。@Qualifier限定描述符除了能根据名字进行注入，但能进行更细粒度的控制如何选择候选者，具体使用方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Autowired </span><br><span class="line">@Qualifier(value = “demoInfoService”) </span><br><span class="line">private DemoInfoService demoInfoService;</span><br></pre></td></tr></table></figure>

<p>@Resource(name&#x3D;”name”,type&#x3D;”type”)：没有括号内内容的话，默认byName。与@Autowired干类似的事。</p>
<p>@ControllerAdvice：有该注解的类里面的@ExceptionHandler，@InitBinder，@ModelAttribute都会被应用到所有handler中</p>
<p>@ExceptionHandler：用于异常处理</p>
<p>@InitBinder：注册属性编辑器，对HTTP请求参数进行处理，再绑定到对应的接口，比如格式化的时间转换等。应用于单个@Controller类的方法上时，仅对该类里的接口有效。与@ControllerAdvice组合使用可全局生效。</p>
<p>@modelAttribute：绑定数据，通过addAttribute绑定某个值到model中，通过modelAttribute获取model中的值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ActionAdvice</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@ModelAttribute</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleException</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        model.addAttribute(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;zfh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BasicController</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;index&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map <span class="title function_">index</span><span class="params">(<span class="meta">@ModelAttribute(&quot;user&quot;)</span> String user)</span> &#123;</span><br><span class="line">        <span class="comment">//...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>SpringBoot</category>
      </categories>
      <tags>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>TensorFlow入门</title>
    <url>/2017/10/13/TensorFlow%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>MNIST是一个深度学习入门的经典例子，是通过对55000张手写数字的识别以及10000张手写数字数据的测试以及5000个验证数据的验证，来了解TensorFlow的基本用法</p>
<span id="more"></span>

<p>每个MNIST数据有两部分，一部分是原始数据，每个图片是28*28的矩阵，在MNIST中已经转换为784的行向量，一行代表一个数据，在python中引用MNIST数据的方式如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> tensorflow.examples.tutorials.mnist <span class="keyword">import</span> input_data</span><br><span class="line">mnist = input_data.read_data_sets(<span class="string">&quot;MNIST_data/&quot;</span>, one_hot=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><code>mnist.train.images</code>表示数据，<code>mnist.train.labels</code>表示标签，这个标签被分成了10列，其中只有1列为1其他列为0，每行数据称为一个tensor（张量），其值均为0到1之间的像素值，标签是0-9之间的</p>
<p>one-hot vector是一个稀疏向量，也就是大多数维度上都为0，仅有一个为1</p>
<h2 id="Softmax-Regressions"><a href="#Softmax-Regressions" class="headerlink" title="Softmax Regressions"></a>Softmax Regressions</h2><p>softmax回归是logistic回归的推广，logistics回归主要解决的是二分类的问题，而softmax回归主要解决的是多分类的问题。</p>
<p>我们对输入的原始数据赋予一个权重和偏差，得到：</p>
<p>$evidence_i&#x3D;{\sum_j}{W_{i,j}}{x_i}+{b_i}$</p>
<p>其中$W_{i,j}$是权重，$b_i$是偏差，$x_i$是输入变量，$i$表示的是第$i$个类别</p>
<p>然后通过softmax回归，得到：</p>
<p>$y&#x3D;\text{softmax}(evidece)$</p>
<p>这里的softmax函数可以视作一个激活函数或者是连接函数，把线性函数变换成我们想要的形式，那么我们就得到了10中情况下的概率分布，你可以通过以下的公式得到真正的概率：</p>
<p>$\text{softmax}(x)&#x3D;\text{normalize}(\text{exp}(x))$</p>
<p>扩展等式后得到：</p>
<p>$\text{softmax}(x)&#x3D;\frac{\text{exp}(x_i)}{\sum_j\text{exp}(x_j)}$</p>
<h2 id="利用TensorFlow实现softmax方法"><a href="#利用TensorFlow实现softmax方法" class="headerlink" title="利用TensorFlow实现softmax方法"></a>利用TensorFlow实现softmax方法</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> TensorFlow <span class="keyword">as</span> tf</span><br><span class="line">x = tf.placeholder(tf.float32, [<span class="literal">None</span>, <span class="number">784</span>])</span><br></pre></td></tr></table></figure>

<p>x表示<code>tf</code>的一个占位符<code>placeholder</code>，其类型是<code>tf.float32</code>，其shape是<code>[None,784]</code>，<strong>其中None可以表示任意的值</strong>，在矩阵大小不确定的时候用这种表示方式</p>
<p>再定义权重W和偏量b</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">W = tf.Variable(tf.zeros([<span class="number">784</span>,<span class="number">10</span>]))</span><br><span class="line">b = tf.Variable(tf.zeros([<span class="number">10</span>]))</span><br></pre></td></tr></table></figure>

<p>把W和b都定义为变量，括号内是其<strong>初始值</strong>，<code>tf.zeros([10])</code>在这里表示的是一个<strong>一行10列的行向量</strong>，与<code>np.zeros([10])</code>表示的是一样的</p>
<p>现在我们使用TensorFlow的矩阵乘法来实现softmax：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y = tf.nn.softmax(tf.matmul(x,W)+b)</span><br></pre></td></tr></table></figure>

<h2 id="计算机器学习模型的性能"><a href="#计算机器学习模型的性能" class="headerlink" title="计算机器学习模型的性能"></a>计算机器学习模型的性能</h2><p>利用交叉熵来评判算法的性能，作为softmax的损失函数，</p>
<p>$H_{y^\prime}(y)&#x3D;-\sum_i{y_i}{^\prime}\log(y_i) $</p>
<p>其中y是预测的概率分布，$y^\prime$是真实分布，交叉熵是用于测量预测值描述真实值的无效程度的</p>
<p>为了计算交叉熵，需要增加一个占位符</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">y_=tf.placeholder(tf.float32,[<span class="literal">None</span>,<span class="number">10</span>])</span><br></pre></td></tr></table></figure>

<p>然后用下式表示交叉熵：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cross_entropy = tf.reduce_mean(-tf.reduce_sum(y_ * tf.log(y), reduction_indices=[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<h2 id="开始训练和实施模型"><a href="#开始训练和实施模型" class="headerlink" title="开始训练和实施模型"></a>开始训练和实施模型</h2><p>通过TensorFlow的train开始训练：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">train_step = tf.train.GradientDescentOptimizer(0.5).minimize(cross_entropy)</span><br></pre></td></tr></table></figure>

<p>其中的梯度下降是一个简单的下降方法，训练目标是要求最小化交叉熵</p>
<p>利用<code>InteractiveSession</code>来运行模型</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sess = tf.InteractiveSession()</span><br></pre></td></tr></table></figure>

<p>首先要初始化我们设置的变量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tf.global_variables_initializer().run()</span><br></pre></td></tr></table></figure>

<p>下面开始训练，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">for _ in range(1000):</span><br><span class="line">  batch_xs, batch_ys = mnist.train.next_batch(100)</span><br><span class="line">  sess.run(train_step, feed_dict=&#123;x: batch_xs, y_: batch_ys&#125;)</span><br></pre></td></tr></table></figure>

<p>然后计算预测的准确率</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">correct_prediction = tf.equal(tf.argmax(y,1), tf.argmax(y_,1))</span><br></pre></td></tr></table></figure>

<p><code>tf.argmax(y,1)</code>用于计算每一列最大值，通过<code>tf.equal</code>得到一个全为bool值的向量，通过<code>tf.reduce_mean</code>求出精度：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">accuracy = tf.reduce_mean(tf.cast(correct_prediction, tf.float32))</span><br></pre></td></tr></table></figure>

<p>最终，对测试数据进行实验</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">print(sess.run(accuracy, feed_dict=&#123;x: mnist.test.images, y_: mnist.test.labels&#125;))</span><br></pre></td></tr></table></figure>















]]></content>
      <categories>
        <category>编程学习</category>
        <category>TensorFlow</category>
      </categories>
      <tags>
        <tag>深度学习</tag>
        <tag>TensorFlow</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu彻底删除软件包</title>
    <url>/2018/08/22/Ubuntu%E5%BD%BB%E5%BA%95%E5%88%A0%E9%99%A4%E8%BD%AF%E4%BB%B6%E5%8C%85/</url>
    <content><![CDATA[<p>在删除apt安装的软件过程中，如果直接用apt remove，那么只是删除了软件本身，但是没有删除相关的配置，要删除相关的配置，就要用apt purge</p>
<span id="more"></span>

<p><strong>下面是详细的apt相关的卸载方法</strong></p>
<p>apt-get的卸载相关的命令有remove&#x2F;purge&#x2F;autoremove&#x2F;clean&#x2F;autoclean等。具体来说：</p>
<p><strong>apt-get purge &#x2F; apt-get –purge remove</strong><br>删除已安装包（不保留配置文件)。<br>如软件包a，依赖软件包b，则执行该命令会删除a，而且不保留配置文件</p>
<p><strong>apt-get autoremove</strong><br>删除为了满足依赖而安装的，但现在不再需要的软件包（包括已安装包），保留配置文件。</p>
<p><strong>apt-get remove</strong><br>删除已安装的软件包（保留配置文件），不会删除依赖软件包，且保留配置文件。</p>
<p><strong>apt-get autoclean</strong><br>APT的底层包是dpkg, 而dpkg 安装Package时, 会将 *.deb 放在 &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F;中，apt-get autoclean 只会删除 &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F; 已经过期的deb。</p>
<p><strong>apt-get clean</strong><br>使用 apt-get clean 会将 &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F; 的 所有 deb 删掉，可以理解为 rm &#x2F;var&#x2F;cache&#x2F;apt&#x2F;archives&#x2F;*.deb。</p>
<hr>
<p>那么如何彻底卸载软件呢？<br>具体来说可以运行如下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 删除软件及其配置文件</span><br><span class="line">apt-get --purge remove &lt;package&gt;</span><br><span class="line"># 删除没用的依赖包</span><br><span class="line">apt-get autoremove &lt;package&gt;</span><br><span class="line"># 此时dpkg的列表中有“rc”状态的软件包，可以执行如下命令做最后清理：</span><br><span class="line">dpkg -l |grep ^rc|awk &#x27;&#123;print $2&#125;&#x27; |sudo xargs dpkg -P123456</span><br></pre></td></tr></table></figure>

<p>当然如果要删除暂存的软件安装包，也可以再使用clean命令</p>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Ubuntu</tag>
      </tags>
  </entry>
  <entry>
    <title>WinEdt中英文字体调节</title>
    <url>/2017/12/18/WinEdt%E4%B8%AD%E8%8B%B1%E6%96%87%E5%AD%97%E4%BD%93%E8%B0%83%E8%8A%82/</url>
    <content><![CDATA[<p>WinEdt10之后的版本，在编译器中设置字体只能设置一种，当我们编辑器中又有中文，又有英文的时候会变得很难看，所以我们需要更改设置脚本以对中英文字体分别设置</p>
<span id="more"></span>

<h2 id="设置英文字体及大小"><a href="#设置英文字体及大小" class="headerlink" title="设置英文字体及大小"></a>设置英文字体及大小</h2><p>点击Options-Options Interface</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-18/50366005.jpg"></p>
<p>看到左边的font schemes - Font，双击之后设置英文字体和大小</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-18/83840061.jpg"></p>
<h2 id="设置中文字体"><a href="#设置中文字体" class="headerlink" title="设置中文字体"></a>设置中文字体</h2><p>点击左侧的language ，unicode，sorting，Translations</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-18/33504889.jpg"></p>
<p>点击unicode（utf-8） support，把喜欢的中文字体移到最前面</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-18/24859160.jpg"></p>
<p>完成！</p>
]]></content>
      <categories>
        <category>科研</category>
      </categories>
      <tags>
        <tag>latex</tag>
      </tags>
  </entry>
  <entry>
    <title>XML教程.md</title>
    <url>/2017/06/10/XML%E6%95%99%E7%A8%8B-md/</url>
    <content><![CDATA[<p>XML 指可扩展标记语言（e<strong>X</strong>tensible <strong>M</strong>arkup <strong>L</strong>anguage），被设计用来传输和存储数据。</p>
<h1 id="XML结构"><a href="#XML结构" class="headerlink" title="XML结构"></a>XML结构</h1><span id="more"></span>

<p>XML整体采用<font color='red'>“树形结构”</font>，从根开始，扩展到叶子节点。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">note</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Tove<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Jani<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heading</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">heading</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>Don&#x27;t forget me this weekend!<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第一行<code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</code>表示的是xml使用的版本和编码方式</p>
<p>第二行是<code>&lt;note&gt;</code>根元素</p>
<p>接下来的四行描述了4个子元素：to，from，heading，body</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Tove<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Jani<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heading</span>&gt;</span>Reminder<span class="tag">&lt;/<span class="name">heading</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span>Don&#x27;t forget me this weekend!<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>最后一行定义根元素结果</note></p>
<p>上述的结构可以看做Jani给Tove的一封便签</p>
<p><code>XML</code>由根元素开始，向下扩展子元素，其关系为父子，同级之间的元素关系为同胞</p>
<h1 id="XML语法"><a href="#XML语法" class="headerlink" title="XML语法"></a>XML语法</h1><ol>
<li><p>文档必须有根元素</p>
</li>
<li><p>XML 声明文件的可选部分，如果存在需要放在文档的第一行，如下所示：<br><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</code></p>
</li>
<li><p>所有XML都必须有开始和结束标签<code>&lt;p&gt;xxxxxx&lt;/p&gt;</code></p>
</li>
<li><p>XML标签对大小写敏感</p>
</li>
<li><p>XML的元素可以有属性值（名称&#x2F;值的对），属性值必须加引号</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">note</span> <span class="attr">date</span>=<span class="string">&quot;12/11/2007&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">to</span>&gt;</span>Tove<span class="tag">&lt;/<span class="name">to</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">from</span>&gt;</span>Jani<span class="tag">&lt;/<span class="name">from</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">note</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>&lt;</code>在xml文件中表示一个元素的开始，因此如果想使用小于符号时，应该利用<strong>实体引用</strong>来代替“&lt;”字符</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span>if salary <span class="symbol">&amp;lt;</span> 1000 then<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<table>
<thead>
<tr>
<th align="center">&amp;lt</th>
<th align="center">&lt;</th>
<th align="center">less than</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><strong>&amp;gt</strong></td>
<td align="center">&gt;</td>
<td align="center"><strong>grater than</strong></td>
</tr>
<tr>
<td align="center"><strong>&amp;amp</strong></td>
<td align="center"><strong>&amp;</strong></td>
<td align="center"><strong>ampersand</strong></td>
</tr>
<tr>
<td align="center"><strong>&amp;apos</strong></td>
<td align="center"><strong>‘</strong></td>
<td align="center"><strong>apostrophe</strong></td>
</tr>
<tr>
<td align="center"><strong>&amp;quot</strong></td>
<td align="center"><strong>“</strong></td>
<td align="center"><strong>quotation mark</strong></td>
</tr>
</tbody></table>
<ol start="8">
<li>在 XML 中编写注释的语法与 HTML 的语法很相似。<br><code>&lt;!-- This is a comment --&gt;</code></li>
<li>HTML 会把多个连续的空格字符裁减（合并）为一个，但是XML中空格不会减少</li>
<li>在 Windows 应用程序中，换行通常以一对字符来存储：回车符（CR）和换行符（LF）。XML 以 LF 存储换行。</li>
</ol>
<h1 id="XML-元素"><a href="#XML-元素" class="headerlink" title="XML 元素"></a>XML 元素</h1><h2 id="XML-命名规则"><a href="#XML-命名规则" class="headerlink" title="XML 命名规则"></a>XML 命名规则</h2><p>XML 元素必须遵循以下命名规则：</p>
<ul>
<li>名称可以包含字母、数字以及其他的字符</li>
<li>名称不能以数字或者标点符号开始</li>
<li>名称不能以字母 xml（或者 XML、Xml 等等）开始</li>
<li>名称不能包含空格</li>
</ul>
<h1 id="XML-属性"><a href="#XML-属性" class="headerlink" title="XML 属性"></a>XML 属性</h1><p><code>&lt;file type=&quot;gif&quot;&gt;computer.gif&lt;/file&gt;</code>其中的<code>type=&quot;gif&quot;</code>就是xml中元素的属性，属性必须添加<strong>引号</strong></p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>XML</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring实战课程——微信点餐平台</title>
    <url>/2018/09/25/Spring%E5%AE%9E%E6%88%98%E8%AF%BE%E7%A8%8B%E2%80%94%E2%80%94%E5%BE%AE%E4%BF%A1%E7%82%B9%E9%A4%90%E5%B9%B3%E5%8F%B0/</url>
    <content><![CDATA[<p>此教程跟随慕课网实战课程进行：<a href="https://coding.imooc.com/class/117.html">https://coding.imooc.com/class/117.html</a></p>
<span id="more"></span>

<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>开发全程使用的ide是idea，数据库使用的是MySQL，开发系统用的是linux centos7.3，前端的技术栈是vue，但是本课程只注重后端部分，前端部分不涉及</p>
<h3 id="安装apache-maven"><a href="#安装apache-maven" class="headerlink" title="安装apache maven"></a>安装apache maven</h3><p>请访问Maven的下载页面：<a href="http://maven.apache.org/download.html">http://maven.apache.org/download.html</a>，其中包含针对不同平台的各种版本的Maven下载文件。</p>
<p>解压apache-maven-3.5.4-bin.zip，并把解压后的文件夹下的apache-maven-3.5.4文件夹移动到<code>C:\Program Files</code> 下。</p>
<h4 id="添加环境变量"><a href="#添加环境变量" class="headerlink" title="添加环境变量"></a>添加环境变量</h4><p>右键“计算机”，选择“属性”，之后点击“高级系统设置”，点击“环境变量”，来设置环境变量，有以下系统变量需要配置：</p>
<p>新建系统变量   MAVEN_HOME  变量值：<code>C:\Program Files\apache-maven-3.5.4</code></p>
<p>编辑系统变量  Path         添加变量值： ;%MAVEN_HOME%\bin</p>
<h4 id="测试安装"><a href="#测试安装" class="headerlink" title="测试安装"></a>测试安装</h4><p>在cmd中使用<code>mvn --version</code>命令，成功打印出版本即安装成功</p>
<h4 id="换源"><a href="#换源" class="headerlink" title="换源"></a>换源</h4><p>国内访问maven源很慢，因此我们需要将maven源改为阿里镜像，使用<code>mvn -X</code>查找其中的mvn使用的settings文件，我们将默认的<code>settings.xml</code>文件拷贝至用户目录下的<code>.m2</code>文件夹，然后在镜像这一部分中加入：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><p>通过idea创建项目，选择<code>new-&gt;project-&gt;Spring Initializr</code>修改好域名和项目名称之后，选择java版本，点击下一步，选择web和mysql&#x2F;jdbc，如果没有选择jdbc这个内容，就要在<code>pom.xml</code>中配置jdbc</p>
<h2 id="数据库设计"><a href="#数据库设计" class="headerlink" title="数据库设计"></a>数据库设计</h2><p>数据库主要包含四个表：</p>
<ol>
<li>商品表</li>
<li>类目表</li>
<li>订单主表</li>
<li>订单详情表</li>
</ol>
<p>构建数据库的SQL语句如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">CREATE TABLE `product_info` (</span><br><span class="line">    `product_id` VARCHAR(32) NOT NULL,</span><br><span class="line">    `product_name` VARCHAR(64) NOT NULL COMMENT &#x27;商品名称&#x27;,</span><br><span class="line">    `product_price` DECIMAL(8 , 2 ) NOT NULL COMMENT &#x27;单价&#x27;,</span><br><span class="line">    `product_stock` INT NOT NULL COMMENT &#x27;库存&#x27;,</span><br><span class="line">    `product_description` VARCHAR(64) COMMENT &#x27;描述&#x27;,</span><br><span class="line">    `product_icon` VARCHAR(512) COMMENT &#x27;小图&#x27;,</span><br><span class="line">    `product_status` TINYINT(3) COMMENT &#x27;商品状态，0正常，1下架&#x27;,</span><br><span class="line">    `category_type` INT NOT NULL COMMENT &#x27;类目编号&#x27;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    PRIMARY KEY (`product_id`)</span><br><span class="line">)  COMMENT &#x27;商品表&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `product_category` (</span><br><span class="line">    `category_id` INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `category_name` VARCHAR(64) NOT NULL COMMENT &#x27;类目名称&#x27;,</span><br><span class="line">    `category_type` INT NOT NULL COMMENT &#x27;类目编号&#x27;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    PRIMARY KEY (`category_id`),</span><br><span class="line">    UNIQUE KEY `uqe_category_type` (`category_type`) COMMENT &#x27;建立索引&#x27;</span><br><span class="line">)  COMMENT &#x27;类目表&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CREATE TABLE `order_master` (</span><br><span class="line">    `order_id` VARCHAR(32) NOT NULL COMMENT &#x27;订单id&#x27;,</span><br><span class="line">    `buyer_name` VARCHAR(32) NOT NULL COMMENT &#x27;买家名字&#x27;,</span><br><span class="line">    `buyer_phone` VARCHAR(32) NOT NULL COMMENT &#x27;买家电话&#x27;,</span><br><span class="line">    `buyer_address` VARCHAR(128) NOT NULL COMMENT &#x27;买家地址&#x27;,</span><br><span class="line">    `buyer_openid` VARCHAR(64) NOT NULL COMMENT &#x27;买家微信openid&#x27;,</span><br><span class="line">    `order_amount` DECIMAL(8 , 2 ) NOT NULL COMMENT &#x27;订单总金额,8位整数，2位小数&#x27;,</span><br><span class="line">    `order_status` TINYINT(3) NOT NULL DEFAULT 0 COMMENT &#x27;订单状态，默认为0新下单&#x27;,</span><br><span class="line">    `pay_status` TINYINT(3) NOT NULL DEFAULT 0 COMMENT &#x27;支付状态，默认为0未支付&#x27;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    PRIMARY KEY (`order_id`),</span><br><span class="line">    KEY `idx_buyer_openid` (`buyer_openid`)</span><br><span class="line">)  COMMENT &#x27;订单主表&#x27;;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `order_detail` (</span><br><span class="line">    `detail_id` VARCHAR(32) NOT NULL COMMENT &#x27;详情id&#x27;,</span><br><span class="line">    `order_id` VARCHAR(32) NOT NULL COMMENT &#x27;订单id&#x27;,</span><br><span class="line">    `product_id` VARCHAR(32) NOT NULL COMMENT &#x27;商品id&#x27;,</span><br><span class="line">    `product_name` VARCHAR(64) NOT NULL COMMENT &#x27;商品名称&#x27;,</span><br><span class="line">    `product_price` DECIMAL(8 , 2 ) NOT NULL COMMENT &#x27;商品价格&#x27;,</span><br><span class="line">    `product_quantity` INT NOT NULL COMMENT &#x27;商品数量&#x27;,</span><br><span class="line">    `product_icon` VARCHAR(512) COMMENT &#x27;商品小图&#x27;,</span><br><span class="line">    `create_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class="line">    `update_time` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#x27;更新时间&#x27;,</span><br><span class="line">    PRIMARY KEY (`detail_id`),</span><br><span class="line">    KEY `idx_order_id` (`order_id`)</span><br><span class="line">)  COMMENT &#x27;订单详情表&#x27;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后通过Navicat建立数据库连接，并新建数据库，注意这里的编码要选择utf8mb4，这个编码可以存储诸如emoji表情之类的特殊符号，而传统的utf-8编码则不能</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-25/97093913.jpg"></p>
<p>建好之后通过Navicat运行上面的sql脚本，即可生成多个表</p>
<h2 id="日志框架"><a href="#日志框架" class="headerlink" title="日志框架"></a>日志框架</h2><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/53967472.jpg"></p>
<p>JUL来自官方，但是很多问题，首先淘汰；jboss用得也不多，其次淘汰；log4j和logback是同一个作者，logback是log4j的升级版，logback更好用</p>
<p>log4j2性能很强，但是很多框架不支持，因此删掉</p>
<p>最后我们剩下的就是SLF4j（Simple Logging Facade for Java 简单的java日志外观），Logback</p>
<p>在测试文件夹中新建LoggerTest类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggerTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(LoggerTest.class);<span class="comment">//写入当前类的类名</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;debug..........&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;info----&quot;</span>);</span><br><span class="line">        logger.error(<span class="string">&quot;error.......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试函数，可以看到info和error这两条信息，但是debug没有看到，这是因为sl4j默认打印info以上的级别的日志，用<code>ctrl+n</code>搜索类，找到sl4j里面的level类，发现有如下五个日志级别：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">Level</span> &#123;</span><br><span class="line">    ERROR(<span class="number">40</span>, <span class="string">&quot;ERROR&quot;</span>),</span><br><span class="line">    WARN(<span class="number">30</span>, <span class="string">&quot;WARN&quot;</span>),</span><br><span class="line">    INFO(<span class="number">20</span>, <span class="string">&quot;INFO&quot;</span>),</span><br><span class="line">    DEBUG(<span class="number">10</span>, <span class="string">&quot;DEBUG&quot;</span>),</span><br><span class="line">    TRACE(<span class="number">0</span>, <span class="string">&quot;TRACE&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>值越大的级别越高</p>
<h4 id="另一种引用SLF4j的方法"><a href="#另一种引用SLF4j的方法" class="headerlink" title="另一种引用SLF4j的方法"></a>另一种引用SLF4j的方法</h4><p>在test类上面加入注解<code>@Slf4j</code>，这要求你的idea有<code>Lombok</code>插件，否则下面的log标记无法正常识别，这样就不用定义logger变量</p>
<p>引入Lombok的方法是在<code>pom.xml</code>中添加：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加好之后就可以通过下面的方法来引用SLF4j</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoggerTest</span> &#123;</span><br><span class="line"><span class="comment">//    private final Logger logger = LoggerFactory.getLogger(LoggerTest.class);</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;imooc&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">passwd</span> <span class="operator">=</span> <span class="string">&quot;1234&quot;</span>;</span><br><span class="line">        log.debug(<span class="string">&quot;debug..........&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;info----&quot;</span>);</span><br><span class="line">        log.info(<span class="string">&quot;name:&#123;&#125;,password:&#123;&#125;&quot;</span>,name,passwd);</span><br><span class="line">        log.error(<span class="string">&quot;error.......&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置log文件"><a href="#配置log文件" class="headerlink" title="配置log文件"></a>配置log文件</h4><p>可以直接通过<code>application.yml</code>配置SLF4j</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">./log/tomcat</span> <span class="comment">#配置存放地址，存放地址和文件名有一个即可</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">./log/tomcat/sell.log</span> <span class="comment">#配置文件名</span></span><br><span class="line">  <span class="attr">level:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p>或者是在resources目录下新建一个<code>logback-spring.xml</code>，写入如下配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;consoleLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %d - %msg%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;fileInfoLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--只存储info而过滤error，如果还是用ThresholdFilter，比error等级高的都会被输出出来，因此要用LevelFilter--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %msg%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件存储策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--路径--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>./log/tomcat/sell/info.%d.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;fileErrorLog&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.ThresholdFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span></span><br><span class="line">                %msg%n</span><br><span class="line">            <span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--文件存储策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--路径--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>./log/tomcat/sell/error.%d.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;consoleLog&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;fileInfoLog&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;fileErrorLog&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="买家端开发"><a href="#买家端开发" class="headerlink" title="买家端开发"></a>买家端开发</h2><p>首先建立一个dataObject包用于存才各个数据表类</p>
<p>在其中建立ProductCategory类，创建id，名称，编号三个属性，最上面<code>@entity</code>，然后设置好getter和setter方法，在id上面<code>@Id</code>,<code>@GeneratedValue</code>用于表示id和自增</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell.dataObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCategory</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类目id</span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目名称*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目编号*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ProductCategory&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;categoryId=&quot;</span> + categoryId +</span><br><span class="line">                <span class="string">&quot;, categoryName=&#x27;&quot;</span> + categoryName + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, categoryType=&#x27;&quot;</span> + categoryType + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getCategoryId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> categoryId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCategoryId</span><span class="params">(Integer categoryId)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.categoryId = categoryId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCategoryName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> categoryName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCategoryName</span><span class="params">(String categoryName)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.categoryName = categoryName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getCategoryType</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> categoryType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCategoryType</span><span class="params">(String categoryType)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.categoryType = categoryType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>当然，如此多的getter和setter方法，可以通过<code>lombok</code>这个包来省去这一步，包括tostring方法也可以省略了，首先在pom.xml中加入dependency</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后在idea的插件中搜索lombok，安装之后重启idea</p>
<p>在productCategory里面加入一个<code>@Data</code>注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@DynamicUpdate</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCategory</span> &#123;</span><br><span class="line">    <span class="comment">//类目id</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目名称*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*类目编号*/</span></span><br><span class="line">    <span class="keyword">private</span> String categoryType;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后建立一个repository包，用于建立查询，新建<code>ProductCategoryRepository.java</code>，其中的接口继承自<code>JpaRepository</code>，然后后面两个参数是<code>&lt;ProductCategory,Integer&gt;</code>，类名和id类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.imooc.sell.dataObject.ProductCategory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductCategoryRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;ProductCategory,Integer&gt; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在测试一下<code>ProductCategoryRepository</code>，直接右键点击<code>ProductCategoryRepository</code>，选择goto-&gt;test，新建test</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.imooc.sell.repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCategoryRepositoryTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductCategoryRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findoneTest</span><span class="params">()</span>&#123;</span><br><span class="line">        Optional&lt;ProductCategory&gt; productCategory = repository.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(productCategory.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>点击findoneTest，点击run，此时报错</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalStateException: Failed to load ApplicationContext</span><br><span class="line">....</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: javax.xml.bind.JAXBException</span><br></pre></td></tr></table></figure>

<p>这是因为缺少<code>javax.xml.bind.JAXBException</code>包，在pom.xml中引入</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-impl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.xml.bind<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxb-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.activation<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>activation<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>接下来在数据库中手动添加一条数据，就可以实现查询了</p>
<p>因为Spring Boot 2的getOne要求transaction（事务操作），所以要在<code>application.yml</code>中添加no_trans的配置：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Spring:</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line">	<span class="attr">jpa:</span></span><br><span class="line">        <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">properties:</span></span><br><span class="line">          <span class="attr">hibernate:</span></span><br><span class="line">            <span class="attr">enable_lazy_load_no_trans:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>



<p>接下来实现一下增删改查</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductCategoryRepositoryTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductCategoryRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findoneTest</span><span class="params">()</span> &#123;</span><br><span class="line">        Optional&lt;ProductCategory&gt; productCategory = repository.findById(<span class="number">1</span>);</span><br><span class="line">        System.out.println(productCategory.toString());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ProductCategory</span> <span class="variable">productCategory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductCategory</span>();</span><br><span class="line">        productCategory.setCategoryName(<span class="string">&quot;最受欢迎的&quot;</span>);</span><br><span class="line">        productCategory.setCategoryType(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        repository.save(productCategory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateTest</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="comment">//        Optional&lt;ProductCategory&gt; productCategorys = repository.getOne(2);</span></span><br><span class="line"><span class="comment">//        ProductCategory productCategory = new ProductCategory();</span></span><br><span class="line"><span class="comment">//        if (productCategorys.isPresent())&#123;</span></span><br><span class="line"><span class="comment">//             productCategory = productCategorys.get();</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">//        productCategory.setCategoryName(&quot;最受人们欢迎的&quot;);</span></span><br><span class="line"><span class="comment">//        productCategory.setCategoryType(&quot;3&quot;);</span></span><br><span class="line"><span class="comment">//        repository.save(productCategory);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ProductCategory</span> <span class="variable">productCategory</span> <span class="operator">=</span> repository.getOne(<span class="number">2</span>);</span><br><span class="line">        productCategory.setCategoryName(<span class="string">&quot;最受人们欢迎的&quot;</span>);</span><br><span class="line">        productCategory.setCategoryType(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">        repository.save(productCategory);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByCategoryIdInTest</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = Arrays.asList(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">        List&lt;ProductCategory&gt; result = repository.findByCategoryIdIn(list);</span><br><span class="line">        System.out.println(result.toString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样直接运行会报错，要在项目设置中更改</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">jpa:</span></span><br><span class="line">  <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">properties:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">enable_lazy_load_no_trans:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>其中的<code>findByCategoryIdIn</code>方法是定义在<code>ProductCategoryRepository.java</code>中的自定义查找方法，其名字就表明了他的用途，按照规定也只能这样起名字，最后一个in表示sql语句中in的意思</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;ProductCategory&gt; <span class="title function_">findByCategoryIdIn</span><span class="params">(List&lt;Integer&gt; categoryTypeList)</span>;</span><br></pre></td></tr></table></figure>

<h4 id="jpa起名规范"><a href="#jpa起名规范" class="headerlink" title="jpa起名规范"></a>jpa起名规范</h4><p>Repository接口中声明方法的规范</p>
<p>1、查询方法以 find | read | get 开头；</p>
<p>2、涉及条件查询时，条件的属性用条件关键字连接，要注意的是：条件属性以首字母大写</p>
<p>例如：定义一个 Entity 实体类 class User｛</p>
<p>private String firstName;</p>
<p>private String lastName; ｝</p>
<p>使用And条件连接时，应这样写： findByLastNameAndFirstName(String lastName,String firstName); 条件的属性名称与个数要与参数的位置与个数一一对应</p>
<p>3、直接在接口中定义查询方法，如果是符合规范的，可以不用写实现，目前支持的关键字写法如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/91216516.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-26/54176380.jpg"></p>
<h3 id="服务层"><a href="#服务层" class="headerlink" title="服务层"></a>服务层</h3><p>新建一个CategoryService.java接口，定义<code>findOne</code>,<code>findAll</code>,<code>findByCategoryIn</code>,<code>save</code>四个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CategoryService</span> &#123;</span><br><span class="line">    ProductCategory <span class="title function_">findOne</span><span class="params">(Integer categoryId)</span>;</span><br><span class="line">    List&lt;ProductCategory&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    List&lt;ProductCategory&gt; <span class="title function_">findByCategoryIdIn</span><span class="params">(List&lt;Integer&gt; categoryTypeList)</span>;</span><br><span class="line">    ProductCategory <span class="title function_">save</span><span class="params">(ProductCategory productCategory)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后新建impl文件夹，在其中写<code>CategoryServiceImpl.java</code>，用于实现<code>CategoryService</code>接口，记得要<code>@Service</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CategoryServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">CategoryService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductCategoryRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProductCategory <span class="title function_">findOne</span><span class="params">(Integer categoryId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.getOne(categoryId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ProductCategory&gt; <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ProductCategory&gt; <span class="title function_">findByCategoryIdIn</span><span class="params">(List&lt;Integer&gt; categoryTypeList)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findByCategoryIdIn(categoryTypeList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProductCategory <span class="title function_">save</span><span class="params">(ProductCategory productCategory)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.save(productCategory);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>写完这一部分之后开始单元测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CategoryServiceImplTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CategoryServiceImpl categoryService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果getCategoryId不等于1则assert</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ProductCategory</span> <span class="variable">productCategory</span> <span class="operator">=</span> categoryService.findOne(<span class="number">1</span>);</span><br><span class="line">        Assert.assertEquals(Integer.valueOf(<span class="number">1</span>),productCategory.getCategoryId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如果查出来的productCategoryList的长度为0则assert</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ProductCategory&gt; productCategoryList = categoryService.findAll();</span><br><span class="line">        Assert.assertNotEquals(<span class="number">0</span>,productCategoryList.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByCategoryIdIn</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;ProductCategory&gt; productCategoryList = categoryService.findByCategoryIdIn(Arrays.asList(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>));</span><br><span class="line">        Assert.assertNotEquals(<span class="number">0</span>,productCategoryList.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ProductCategory</span> <span class="variable">productCategory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductCategory</span>();</span><br><span class="line">        productCategory.setCategoryName(<span class="string">&quot;男生专用&quot;</span>);</span><br><span class="line">        productCategory.setCategoryType(<span class="string">&quot;10&quot;</span>);</span><br><span class="line">        <span class="type">ProductCategory</span> <span class="variable">result</span> <span class="operator">=</span> categoryService.save(productCategory);</span><br><span class="line">        Assert.assertNotEquals(<span class="literal">null</span>,result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="商品相关开发"><a href="#商品相关开发" class="headerlink" title="商品相关开发"></a>商品相关开发</h3><p>顺序和之前一样，还是<code>DAO-&gt;Service-&gt;Controller</code>的顺序</p>
<p>首先我们在dataObject中，定义数据对象entity</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductInfo</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="comment">//名字</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="comment">//单价</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal productPrice;</span><br><span class="line">    <span class="comment">//库存</span></span><br><span class="line">    <span class="keyword">private</span> Integer productStock;</span><br><span class="line">    <span class="comment">//描述</span></span><br><span class="line">    <span class="keyword">private</span> String productDescription;</span><br><span class="line">    <span class="comment">//小图</span></span><br><span class="line">    <span class="keyword">private</span> String productIcon;</span><br><span class="line">    <span class="comment">//状态,0正常,1下架</span></span><br><span class="line">    <span class="keyword">private</span> Integer productStatus;</span><br><span class="line">    <span class="comment">//类目编号</span></span><br><span class="line">    <span class="keyword">private</span> Integer categoryType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在repository中定义，与<code>ProductInfo</code>对应的<code>ProductInfoRepository</code>接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductInfoRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;ProductInfo,String&gt; &#123;</span><br><span class="line">    List&lt;ProductInfo&gt; <span class="title function_">findByProductStatus</span><span class="params">(Integer productStatus)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此DAO相关的定义完成，开始测试相关函数功能</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductInfoRepositoryTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductInfoRepository repository;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getOneTest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">productInfo</span> <span class="operator">=</span> repository.getOne(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        assertEquals(<span class="string">&quot;123456&quot;</span>,productInfo.getProductId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">changeTest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">productInfo</span> <span class="operator">=</span> repository.getOne(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        productInfo.setProductPrice(BigDecimal.valueOf(<span class="number">10.5</span>));</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">reult</span> <span class="operator">=</span> repository.save(productInfo);</span><br><span class="line">        assertNotNull(reult);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">productInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductInfo</span>();</span><br><span class="line">        productInfo.setProductId(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        productInfo.setProductName(<span class="string">&quot;皮蛋粥&quot;</span>);</span><br><span class="line">        productInfo.setProductPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">3.2</span>));</span><br><span class="line">        productInfo.setProductStock(<span class="number">100</span>);</span><br><span class="line">        productInfo.setProductDescription(<span class="string">&quot;很好喝&quot;</span>);</span><br><span class="line">        productInfo.setProductDescription(<span class="string">&quot;abc.jpg&quot;</span>);</span><br><span class="line">        productInfo.setProductStatus(<span class="number">0</span>);</span><br><span class="line">        productInfo.setCategoryType(<span class="number">1</span>);</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">result</span> <span class="operator">=</span> repository.save(productInfo);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByProductStatusTest</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;ProductInfo&gt; productInfoList = repository.findByProductStatus(<span class="number">0</span>);</span><br><span class="line">        assertNotEquals(<span class="number">0</span>,productInfoList.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试全部通过，证明上面开发的部分没有问题</p>
<p>接下来开始写Service层。</p>
<h4 id="DAO和Service层的关系"><a href="#DAO和Service层的关系" class="headerlink" title="DAO和Service层的关系"></a>DAO和Service层的关系</h4><blockquote>
<p>DAO和Service层的关系</p>
<ol>
<li><p>初学Spring的时候，大家可能在DAO和Service层的关系上有些不解，为什么看上去DAO层和Service层做的事情一模一样，如果是这样，那么我们只需要DAO层不就行了吗？这是因为一开始开发的模型比较简单，等到系统越来越复杂的时候，我们查出来的内容可能就不是直接呈现给controller层了，而是经过很多的处理才交给controller层，这个时候的Service层就必不可少了，甚至一些诸如邮件通知之类的功能也可以放在service层，这样可以使controller层变得简洁。</p>
</li>
<li><p>第二个原因是因为用Service层包裹DAO层之后，当有攻击者攻击系统的时候，他只能访问由service层提供的几个函数来访问数据，只能获取少部分数据，而无法对整个数据库进行操作，这从一定程度上保证了数据库的安全性。</p>
</li>
</ol>
</blockquote>
<p>在service文件夹中新建<code>ProductService</code>接口，定义如下几个函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line">    ProductInfo <span class="title function_">findOne</span><span class="params">(String productId)</span>;</span><br><span class="line">    <span class="comment">//分页查询</span></span><br><span class="line">    Page&lt;ProductInfo&gt; <span class="title function_">findAll</span><span class="params">(Pageable pageable)</span>;</span><br><span class="line">    <span class="comment">//查询所有已上架的商品</span></span><br><span class="line">    List&lt;ProductInfo&gt; <span class="title function_">findUpAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ProductInfo <span class="title function_">save</span><span class="params">(ProductInfo productInfo)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加库存</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//减库存</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后再implement实现这个接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">ProductService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductInfoRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProductInfo <span class="title function_">findOne</span><span class="params">(String productId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.getOne(productId);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;ProductInfo&gt; <span class="title function_">findAll</span><span class="params">(Pageable pageable)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findAll(pageable);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ProductInfo&gt; <span class="title function_">findUpAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.findByProductStatus(ProductStatusEnum.UP.getCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ProductInfo <span class="title function_">save</span><span class="params">(ProductInfo productInfo)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> repository.save(productInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后新建<code>BuyerProductController.java</code>处理controller层，list这个页面，主要的业务逻辑是：</p>
<ol>
<li><p>查出所有上架的商品</p>
</li>
<li><p>查出所有上架商品的categoryType</p>
</li>
<li><p>数据拼装：最外层是code，msg，data</p>
<ul>
<li><p>新建一个ResultVO用于存放最外层对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResultVO</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="comment">//错误码</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">//提示信息</span></span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line">    <span class="comment">//返回的具体内容</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建一个ProductVO用于存放类别</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@JsonAutoDetect(fieldVisibility = JsonAutoDetect.Visibility.ANY, getterVisibility = JsonAutoDetect.Visibility.NONE, setterVisibility = JsonAutoDetect.Visibility.NONE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductVO</span> &#123;</span><br><span class="line">    <span class="meta">@JsonProperty(&quot;name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String CategoryName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;type&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer CategoryType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;foods&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;ProductInfoVO&gt; productInfoVOList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>新建一个ProductInfoVO用于存放每个商品的具体信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProductInfoVO</span> &#123;</span><br><span class="line">    <span class="meta">@JsonProperty(&quot;id&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;name&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;price&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal productPrice;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;description&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String productDescription;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JsonProperty(&quot;icon&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String productIcon;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>遍历category，然后再遍历所有product，如果当前的product的categoryType与当前的category相同，通过<code>BeanUtils.copyProperties</code>拷贝整个对象到另外一个，然后加入到<code>productVOList</code>中，最后设置msg和code，并返回</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 买家商品</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/buyer/product&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuyerProductController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CategoryService categoryService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultVO <span class="title function_">list</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//1. 查询所有的上架商品</span></span><br><span class="line">        List&lt;ProductInfo&gt; productInfoList = productService.findUpAll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 查询类目(一次性查询)</span></span><br><span class="line">        List&lt;Integer&gt; categoryTypeList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//传统方法</span></span><br><span class="line">        <span class="keyword">for</span> (ProductInfo productInfo : productInfoList) &#123;</span><br><span class="line">            categoryTypeList.add(productInfo.getCategoryType());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//精简方法(java8, lambda)</span></span><br><span class="line"><span class="comment">//        List&lt;Integer&gt; categoryTypeList = productInfoList.stream()</span></span><br><span class="line"><span class="comment">//                .map(e -&gt; e.getCategoryType())</span></span><br><span class="line"><span class="comment">//                .collect(Collectors.toList());</span></span><br><span class="line">        List&lt;ProductCategory&gt; productCategoryList = categoryService.findByCategoryTypeIn(categoryTypeList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 数据拼装</span></span><br><span class="line">        List&lt;ProductVO&gt; productVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (ProductCategory productCategory: productCategoryList) &#123;</span><br><span class="line">            <span class="type">ProductVO</span> <span class="variable">productVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductVO</span>();</span><br><span class="line">            productVO.setCategoryType(productCategory.getCategoryType());</span><br><span class="line">            productVO.setCategoryName(productCategory.getCategoryName());</span><br><span class="line"></span><br><span class="line">            List&lt;ProductInfoVO&gt; productInfoVOList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">for</span> (ProductInfo productInfo: productInfoList) &#123;</span><br><span class="line">                <span class="keyword">if</span> (productInfo.getCategoryType().equals(productCategory.getCategoryType())) &#123;</span><br><span class="line">                    <span class="type">ProductInfoVO</span> <span class="variable">productInfoVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProductInfoVO</span>();</span><br><span class="line">                    BeanUtils.copyProperties(productInfo, productInfoVO);</span><br><span class="line">                    productInfoVOList.add(productInfoVO);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            productVO.setProductInfoVOList(productInfoVOList);</span><br><span class="line">            productVOList.add(productVO);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultVO</span>();</span><br><span class="line">        resultVO.setCode(<span class="number">0</span>);</span><br><span class="line">        resultVO.setMsg(<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        resultVO.setData(productVOList);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现最后几行有些重复，我们新建一个utils包，用于存放杂件，新建一个ResultVOUtil，新建static方法，以便在上面的return中直接调用<code>return ResultVOUtil.success(productVOList);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResultVOUtil</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultVO <span class="title function_">success</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">        <span class="type">ResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultVO</span>&lt;&gt;();</span><br><span class="line">        resultVO.setCode(<span class="number">0</span>);</span><br><span class="line">        resultVO.setMsg(<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        resultVO.setData(o);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultVO <span class="title function_">success</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultVO</span>&lt;&gt;();</span><br><span class="line">        resultVO.setCode(<span class="number">0</span>);</span><br><span class="line">        resultVO.setMsg(<span class="string">&quot;成功&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ResultVO <span class="title function_">error</span><span class="params">(Integer code,String msg)</span> &#123;</span><br><span class="line">        <span class="type">ResultVO</span> <span class="variable">resultVO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResultVO</span>&lt;&gt;();</span><br><span class="line">        resultVO.setCode(code);</span><br><span class="line">        resultVO.setMsg(msg);</span><br><span class="line">        <span class="keyword">return</span> resultVO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前后端联调"><a href="#前后端联调" class="headerlink" title="前后端联调"></a>前后端联调</h3><ol>
<li><p>安装node依赖包，运行vue项目<br>首先cd到文件目录，执行下面的指令安装依赖</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install</span><br></pre></td></tr></table></figure>

<p>然后执行<code>npm run dev</code>，即可运行前端项目</p>
</li>
<li><p>刷新前端项目，发现前端的list指向的地址的端口有问题，因此用vscode搜索相关的地址之后可以找到vue项目设置的list函数的地址，并更改为<code>http://127.0.0.1:8080/sell/buyer/product/list</code></p>
</li>
<li><p>更改之后重新运行项目，发现可以访问了，但是没有数据返回，此时只需要在list函数上加入一个跨域访问的注解<code>@CrossOrigin(&quot;*&quot;)</code>，即可正常访问。</p>
</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-10-7/21769142.jpg"></p>
<h2 id="订单层开发"><a href="#订单层开发" class="headerlink" title="订单层开发"></a>订单层开发</h2><p>同样开发顺序是DAO-&gt;Service-&gt;Controller，具体一点，先是定义dataObject，然后定义repository，这两部分组成了DAO层</p>
<h3 id="订单DAO层开发"><a href="#订单DAO层开发" class="headerlink" title="订单DAO层开发"></a>订单DAO层开发</h3><h4 id="dataObject定义"><a href="#dataObject定义" class="headerlink" title="dataObject定义"></a>dataObject定义</h4><p>订单一共有两个表，一个是OrderDetail（详情表），一个是OrderMaster（主表），对照数据库，定义每一个字段</p>
<ol>
<li>首先定义OrderMaster表，<code>@DynamicUpdate</code>用于动态更新updateTime，</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@DynamicUpdate</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMaster</span> &#123;</span><br><span class="line">    <span class="comment">//订单ID</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">//买家姓名</span></span><br><span class="line">    <span class="keyword">private</span> String buyerName;</span><br><span class="line">    <span class="comment">//买家电话</span></span><br><span class="line">    <span class="keyword">private</span> String buyerPhone;</span><br><span class="line">    <span class="comment">//买家地址</span></span><br><span class="line">    <span class="keyword">private</span> String buyerAddress;</span><br><span class="line">    <span class="comment">//买家openid</span></span><br><span class="line">    <span class="keyword">private</span> String buyerOpenid;</span><br><span class="line">    <span class="comment">//订单总额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line">    <span class="comment">//订单状态，默认为新下单,0是新下单,1是已完成，2是已取消</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">orderStatus</span> <span class="operator">=</span> OrderStatusEnum.NEW.getCode();</span><br><span class="line">    <span class="comment">//支付状态，默认为0未支付</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> PayStatusEnum.WAIT.getCode();</span><br><span class="line">    <span class="comment">//创建时间</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>定义OrderDetail表</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDetail</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="keyword">private</span> String detailId;</span><br><span class="line">    <span class="comment">//订单id</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">//商品id</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="comment">//商品价格</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal productPrice;</span><br><span class="line">    <span class="comment">//商品名称</span></span><br><span class="line">    <span class="keyword">private</span> String productName;</span><br><span class="line">    <span class="comment">//商品数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer productQuantity;</span><br><span class="line">    <span class="comment">//商品图标</span></span><br><span class="line">    <span class="keyword">private</span> String productIcon;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中用到的状态表示，要用枚举来表示，不至于那么乱</p>
<p>首先是<code>OrderStatusEnum</code>列举订单状态</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">OrderStatusEnum</span> &#123;</span><br><span class="line">    NEW(<span class="number">0</span>,<span class="string">&quot;新订单&quot;</span>),</span><br><span class="line">    FINISHED(<span class="number">1</span>,<span class="string">&quot;完结&quot;</span>),</span><br><span class="line">    CANCEL(<span class="number">2</span>,<span class="string">&quot;已取消&quot;</span>),</span><br><span class="line">    ;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    OrderStatusEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后是<code>PayStatusEnum</code>枚举支付状态</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span>  <span class="title class_">PayStatusEnum</span> &#123;</span><br><span class="line">    WAIT(<span class="number">0</span>,<span class="string">&quot;未支付&quot;</span>),</span><br><span class="line">    SUCCESS(<span class="number">1</span>,<span class="string">&quot;支付成功&quot;</span>),;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String msg;</span><br><span class="line"></span><br><span class="line">    PayStatusEnum(Integer code, String msg) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="repository定义及测试"><a href="#repository定义及测试" class="headerlink" title="repository定义及测试"></a>repository定义及测试</h4><p>对应两个dataObject，定义两个repository</p>
<ol>
<li><code>OrderMasterRepository</code>用于操作OrderMaster表</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMasterRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;OrderMaster,String&gt; &#123;</span><br><span class="line">    <span class="comment">//通过用户来查找订单主表</span></span><br><span class="line">    Page&lt;OrderMaster&gt; <span class="title function_">findByBuyerOpenid</span><span class="params">(String buyerOpenId, Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>OrderDetailRepository</code>用于操作OrderDetail表</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderDetailRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;OrderDetail,String&gt; &#123;</span><br><span class="line">    <span class="comment">//通过OrderId来查找详情表</span></span><br><span class="line">    List&lt;OrderDetail&gt; <span class="title function_">findByOrderId</span><span class="params">(String orderId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，两个repository完成，开始测试</p>
<ol>
<li><code>OrderMasterRepositoryTest</code>用于测试OrderMasterRepository</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderMasterRepositoryTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMasterRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">        orderMaster.setOrderId(<span class="string">&quot;1234567&quot;</span>);</span><br><span class="line">        orderMaster.setBuyerName(<span class="string">&quot;师兄&quot;</span>);</span><br><span class="line">        orderMaster.setBuyerPhone(<span class="string">&quot;18888888888&quot;</span>);</span><br><span class="line">        orderMaster.setBuyerAddress(<span class="string">&quot;重庆市&quot;</span>);</span><br><span class="line">        orderMaster.setBuyerOpenid(<span class="string">&quot;110110&quot;</span>);</span><br><span class="line">        orderMaster.setOrderAmount(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">10</span>));</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">result</span> <span class="operator">=</span> repository.save(orderMaster);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByBuyerOpenid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">pageRequest</span> <span class="operator">=</span> PageRequest.of(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">        Page&lt;OrderMaster&gt; result = repository.findByBuyerOpenid(<span class="string">&quot;110110&quot;</span>,pageRequest);</span><br><span class="line">        System.out.println(result.getTotalElements());</span><br><span class="line">        assertNotEquals(<span class="number">0</span>,result.getSize());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>OrderDetailRepositoryTest</code>用于测试OrderDetailRepository</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDetailRepositoryTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailRepository repository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveTest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderDetail</span> <span class="variable">orderDetail</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetail</span>();</span><br><span class="line">        orderDetail.setDetailId(<span class="string">&quot;11111100&quot;</span>);</span><br><span class="line">        orderDetail.setOrderId(<span class="string">&quot;12345678&quot;</span>);</span><br><span class="line">        orderDetail.setProductIcon(<span class="string">&quot;abc.jpg&quot;</span>);</span><br><span class="line">        orderDetail.setProductId(<span class="string">&quot;a111&quot;</span>);</span><br><span class="line">        orderDetail.setProductName(<span class="string">&quot;南瓜&quot;</span>);</span><br><span class="line">        orderDetail.setProductPrice(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">10.5</span>));</span><br><span class="line">        orderDetail.setProductQuantity(<span class="number">2</span>);</span><br><span class="line">        <span class="type">OrderDetail</span> <span class="variable">result</span> <span class="operator">=</span> repository.save(orderDetail);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findByOrderId</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = repository.findByOrderId(<span class="string">&quot;12345678&quot;</span>);</span><br><span class="line">        assertNotEquals(<span class="number">0</span>,orderDetailList.size());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，订单DAO层开发完成，接下来开发Service层</p>
<h3 id="订单Service层开发"><a href="#订单Service层开发" class="headerlink" title="订单Service层开发"></a>订单Service层开发</h3><p>创建一个名为<code>OrderService.java</code>的接口，包含以下6个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    OrderDTO <span class="title function_">create</span><span class="params">(OrderDTO orderDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询单个订单</span></span><br><span class="line">    OrderDTO <span class="title function_">getOne</span><span class="params">(String orderId)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//查询订单列表</span></span><br><span class="line">    Page&lt;OrderDTO&gt; <span class="title function_">findList</span><span class="params">(String buyerOpenid, Pageable pageable)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消订单</span></span><br><span class="line">    OrderDTO <span class="title function_">cancel</span><span class="params">(OrderDTO orderDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//完结订单</span></span><br><span class="line">    OrderDTO <span class="title function_">finish</span><span class="params">(OrderDTO orderDTO)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//支付订单</span></span><br><span class="line">    OrderDTO <span class="title function_">paid</span><span class="params">(OrderDTO orderDTO)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建<code>ProductServiceImpl.java</code>实现上面的接口</p>
<p>其中需要用到一个Data Transform Object，名称为OrderDTO，其大部分字段与OrderMaster一样，多了一个<code>List&lt;OrderDetail&gt; orderDetailList</code>字段，用于保存每个订单对应的OrderDetail信息，定义如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//OrderDTO.java</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="comment">//@JsonSerialize(include = JsonSerialize.Inclusion.NON_NULL)</span></span><br><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderDTO</span> &#123;</span><br><span class="line">    <span class="comment">//订单ID</span></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line">    <span class="comment">//买家姓名</span></span><br><span class="line">    <span class="keyword">private</span> String buyerName;</span><br><span class="line">    <span class="comment">//买家电话</span></span><br><span class="line">    <span class="keyword">private</span> String buyerPhone;</span><br><span class="line">    <span class="comment">//买家地址</span></span><br><span class="line">    <span class="keyword">private</span> String buyerAddress;</span><br><span class="line">    <span class="comment">//买家openid</span></span><br><span class="line">    <span class="keyword">private</span> String buyerOpenid;</span><br><span class="line">    <span class="comment">//订单总额</span></span><br><span class="line">    <span class="keyword">private</span> BigDecimal orderAmount;</span><br><span class="line">    <span class="comment">//订单状态，默认为新下单,0是新下单,1是已完成，2是已取消</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">orderStatus</span> <span class="operator">=</span> OrderStatusEnum.NEW.getCode();</span><br><span class="line">    <span class="comment">//支付状态，默认为0未支付</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">Integer</span> <span class="variable">payStatus</span> <span class="operator">=</span> PayStatusEnum.WAIT.getCode();</span><br><span class="line">    <span class="comment">//创建时间</span></span><br><span class="line">    <span class="meta">@JsonSerialize(using = Date2LongSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line">    <span class="comment">//更新时间</span></span><br><span class="line">    <span class="meta">@JsonSerialize(using = Date2LongSerializer.class)</span></span><br><span class="line">    <span class="keyword">private</span> Date updateTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;OrderDetail&gt; orderDetailList;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中需要用到的SellException定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SellException</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SellException</span><span class="params">(ResultEnum resultEnum)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(resultEnum.getMessage());</span><br><span class="line">        <span class="built_in">this</span>.code = resultEnum.getCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SellException</span><span class="params">(Integer code, String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SellException引用的ResultEnum枚举，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">ResultEnum</span> &#123;</span><br><span class="line">    PARAM_ERROR(<span class="number">1</span>, <span class="string">&quot;参数不正确&quot;</span>),</span><br><span class="line">    PRODUCT_NOT_EXIST(<span class="number">10</span>, <span class="string">&quot;商品不存在&quot;</span>),</span><br><span class="line">    PRODUCT_STOCK_ERROR(<span class="number">11</span>, <span class="string">&quot;库存不足&quot;</span>),</span><br><span class="line">    ORDER_NOT_EXSIT(<span class="number">12</span>, <span class="string">&quot;订单不存在&quot;</span>),</span><br><span class="line">    ORDER_DETAIL_NOT_EXSIT(<span class="number">12</span>, <span class="string">&quot;订单详情不存在&quot;</span>),</span><br><span class="line">    ORDER_STATUS_ERROR(<span class="number">14</span>, <span class="string">&quot;订单状态不正确&quot;</span>),</span><br><span class="line">    ORDER_UPDATE_FAIL(<span class="number">15</span>, <span class="string">&quot;订单更新失败&quot;</span>),</span><br><span class="line">    ORDER_DETAIL_EMPTY(<span class="number">16</span>, <span class="string">&quot;订单详情为空&quot;</span>),</span><br><span class="line">    PAY_STAUS_ERROR(<span class="number">17</span>, <span class="string">&quot;支付状态不正确&quot;</span>),</span><br><span class="line">    CART_EMPTY(<span class="number">18</span>, <span class="string">&quot;购物车为空&quot;</span>),</span><br><span class="line">    ORDER_OWNER_ERROR(<span class="number">19</span>, <span class="string">&quot;该订单不属于当前用户&quot;</span>),;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    ResultEnum(Integer code, String message) &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">        <span class="built_in">this</span>.message = message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建订单"><a href="#创建订单" class="headerlink" title="创建订单"></a>创建订单</h4><p>create方法：传入一个orderDTO，查找商品，计算总价</p>
<p>传入的参数如下所示：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">name<span class="punctuation">:</span> <span class="string">&quot;张三&quot;</span></span><br><span class="line">phone<span class="punctuation">:</span> <span class="string">&quot;18868822111&quot;</span></span><br><span class="line">address<span class="punctuation">:</span> <span class="string">&quot;慕课网总部&quot;</span></span><br><span class="line">openid<span class="punctuation">:</span> <span class="string">&quot;ew3euwhd7sjw9diwkq&quot;</span> <span class="comment">//用户的微信openid</span></span><br><span class="line">items<span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">&#123;</span></span><br><span class="line">    productId<span class="punctuation">:</span> <span class="string">&quot;1423113435324&quot;</span><span class="punctuation">,</span></span><br><span class="line">    productQuantity<span class="punctuation">:</span> <span class="number">2</span> <span class="comment">//购买数量</span></span><br><span class="line"><span class="punctuation">&#125;</span><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p>因此，要通过productId来查询productInfo，然后获取价格乘以数量，得到总价，然后设置DTO的详细信息，设置OrderId和orderDetailId</p>
<p>设置ID的方法写在utils文件夹中，为了不重复，所以加上同步锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//utils/KeyUtil.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KeyUtil</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生成唯一主键</span></span><br><span class="line"><span class="comment">     * 格式：时间+随机数</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> String <span class="title function_">genUniqueKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">number</span> <span class="operator">=</span> random.nextInt(<span class="number">900000</span>) + <span class="number">100000</span>;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis() + String.valueOf(number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三步是写入OrderMaster，拷贝OrderDTO到OrderMater对象中，设置总价，保存</p>
<p>第四步是扣库存，扣库存的函数是<code>productService.decreaseStock</code>，其中用到的数据转移对象是<code>CartDTO</code>，包含id和数量，定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CartDTO</span> &#123;</span><br><span class="line">    <span class="comment">//商品id</span></span><br><span class="line">    <span class="keyword">private</span> String productId;</span><br><span class="line">    <span class="comment">//商品数量</span></span><br><span class="line">    <span class="keyword">private</span> Integer productQuantity;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CartDTO</span><span class="params">(String productId, Integer productQuantity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.productId = productId;</span><br><span class="line">        <span class="built_in">this</span>.productQuantity = productQuantity;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>扣库存的函数如下，通过id查出商品的库存，减去购物车里面的库存，保存商品信息：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decreaseStock</span><span class="params">(List&lt;CartDTO&gt; cartDTOList)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (CartDTO cartDTO : cartDTOList) &#123;</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">productInfo</span> <span class="operator">=</span> repository.findById(cartDTO.getProductId()).orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (productInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> productInfo.getProductStock() - cartDTO.getProductQuantity();</span><br><span class="line">        <span class="keyword">if</span> (result &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PRODUCT_STOCK_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        productInfo.setProductStock(result);</span><br><span class="line">        repository.save(productInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，创建订单的开发结束，具体实现如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService; </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDetailRepository orderDetailRepository;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderMasterRepository orderMasterRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">create</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">        <span class="type">BigDecimal</span> <span class="variable">orderAmount</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigDecimal</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> KeyUtil.genUniqueKey();</span><br><span class="line">        <span class="comment">//1.查询商品（数量，价格）</span></span><br><span class="line">        <span class="keyword">for</span> (OrderDetail orderDetail : orderDTO.getOrderDetailList()) &#123;</span><br><span class="line">            <span class="type">ProductInfo</span> <span class="variable">productInfo</span> <span class="operator">=</span> productService.findOne(orderDetail.getProductId());</span><br><span class="line">            <span class="keyword">if</span> (productInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//2.计算总价</span></span><br><span class="line">            orderAmount = productInfo.getProductPrice()</span><br><span class="line">                    .multiply(<span class="keyword">new</span> <span class="title class_">BigDecimal</span>(orderDetail.getProductQuantity()))</span><br><span class="line">                    .add(orderAmount);</span><br><span class="line">            <span class="comment">//订单详情入库OrderDetail</span></span><br><span class="line">            BeanUtils.copyProperties(productInfo, orderDetail);</span><br><span class="line">            orderDetail.setDetailId(KeyUtil.genUniqueKey());</span><br><span class="line">            orderDetail.setOrderId(orderId);</span><br><span class="line">            orderDetailRepository.save(orderDetail);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.写入订单数据库orderMaster</span></span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">        orderDTO.setOrderId(orderId);</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        orderMaster.setOrderAmount(orderAmount);</span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="comment">//4.扣库存</span></span><br><span class="line">        List&lt;CartDTO&gt; cartDTOList = orderDTO.getOrderDetailList().stream().map(e -&gt;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">CartDTO</span>(e.getProductId(), e.getProductQuantity())</span><br><span class="line">        ).collect(Collectors.toList());</span><br><span class="line">        productService.decreaseStock(cartDTOList);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">finish</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[完结订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;&quot;</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改状态并保存</span></span><br><span class="line">        orderDTO.setOrderStatus(OrderStatusEnum.FINISHED.getCode());</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">result</span> <span class="operator">=</span> orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">paid</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[支付订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;&quot;</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断支付状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(PayStatusEnum.WAIT.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[支付订单]支付状态不正确，orderId=&#123;&#125;,payStatus=&#123;&#125;&quot;</span>, orderDTO.getOrderId(), orderDTO.getPayStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PAY_STAUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改支付状态</span></span><br><span class="line">        orderDTO.setPayStatus(PayStatusEnum.SUCCESS.getCode());</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="通过订单id查询订单"><a href="#通过订单id查询订单" class="headerlink" title="通过订单id查询订单"></a>通过订单id查询订单</h4><p>查询订单相对容易，通过一个id查找到订单主表orderMaster信息，通过id查到所有订单详情表的orderDetail信息，返回一个orderDTO对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">getOne</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> orderMasterRepository.findById(orderId).orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (orderMaster == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_NOT_EXSIT);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = orderDetailRepository.findByOrderId(orderId);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(orderDetailList)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_DETAIL_NOT_EXSIT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDTO</span>();</span><br><span class="line">        BeanUtils.copyProperties(orderMaster, orderDTO);</span><br><span class="line">        orderDTO.setOrderDetailList(orderDetailList);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>####通过用户id查询订单列表</p>
<p>通过用户的openid来查询订单，要求返回一个page对象，包含的是OrderDTO类型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Page&lt;OrderDTO&gt; <span class="title function_">findList</span><span class="params">(String buyerOpenid, Pageable pageable)</span> &#123;</span><br><span class="line">        Page&lt;OrderMaster&gt; orderMasterPage = orderMasterRepository.findByBuyerOpenid(buyerOpenid, pageable);</span><br><span class="line">        List&lt;OrderDTO&gt; orderDTOList = OrderMaster2OrderDTOConverter.convert(orderMasterPage.getContent());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PageImpl</span>&lt;OrderDTO&gt;(orderDTOList, pageable, orderMasterPage.getTotalElements());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>其中的findByBuyerOpenid方法定义如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//repository/OrderMasterRepository.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OrderMasterRepository</span> <span class="keyword">extends</span> <span class="title class_">JpaRepository</span>&lt;OrderMaster, String&gt; &#123;</span><br><span class="line">    Page&lt;OrderMaster&gt; <span class="title function_">findByBuyerOpenid</span><span class="params">(String buyerOpenId, Pageable pageable)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="取消订单"><a href="#取消订单" class="headerlink" title="取消订单"></a>取消订单</h4><ol>
<li><p>首先判断订单是不是新下单状态，不是则抛出异常</p>
</li>
<li><p>如果是新下单，修改订单为取消状态</p>
</li>
<li><p>返还库存：<br>增加库存的函数如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increaseStock</span><span class="params">(List&lt;CartDTO&gt; cartDTOList)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (CartDTO cartDTO : cartDTOList) &#123;</span><br><span class="line">        <span class="type">ProductInfo</span> <span class="variable">productInfo</span> <span class="operator">=</span> repository.findById(cartDTO.getProductId()).orElse(<span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (productInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PRODUCT_NOT_EXIST);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> productInfo.getProductStock() + cartDTO.getProductQuantity();</span><br><span class="line">        productInfo.setProductStock(result);</span><br><span class="line">        repository.save(productInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果已支付，退款：因为现在支付相关的函数还没有完成，因此这部分先空着，用<code>//TODO</code>来表示，这样点击左下角的TODO按钮，即可快速浏览这部分内容</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">cancel</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[取消订单] 订单状态不正确，orderId=&#123;&#125;，orderStatus=&#123;&#125;&quot;</span>,</span><br><span class="line">                    orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改订单状态</span></span><br><span class="line">        orderDTO.setOrderStatus(OrderStatusEnum.CANCEL.getCode());</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">OrderMaster</span> <span class="variable">updateResult</span> <span class="operator">=</span> orderMasterRepository.save(orderMaster);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[取消订单] 更新失败，orderMaster=&#123;&#125;&quot;</span>, orderMaster);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_UPDATE_FAIL);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返还库存</span></span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(orderDTO.getOrderDetailList())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[取消订单] 订单中无商品，OrderDto=&#123;&#125;&quot;</span>, orderDTO);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_DETAIL_EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;CartDTO&gt; cartDTOList = orderDTO.getOrderDetailList().stream()</span><br><span class="line">                .map(e -&gt; <span class="keyword">new</span> <span class="title class_">CartDTO</span>(e.getProductId(), e.getProductQuantity()))</span><br><span class="line">                .collect(Collectors.toList());</span><br><span class="line">        productService.increaseStock(cartDTOList);</span><br><span class="line">        <span class="comment">//如果已支付，退款</span></span><br><span class="line">        <span class="keyword">if</span> (orderDTO.getPayStatus().equals(PayStatusEnum.SUCCESS.getCode())) &#123;</span><br><span class="line">            <span class="comment">//TODO</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="完结订单"><a href="#完结订单" class="headerlink" title="完结订单"></a>完结订单</h4><p>与取消订单相似，首先判断订单状态，如果是新下单，可以修改为完结并保存，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="keyword">public</span> OrderDTO <span class="title function_">finish</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">    <span class="comment">//判断订单状态</span></span><br><span class="line">    <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;[完结订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;&quot;</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//修改状态并保存</span></span><br><span class="line">    orderDTO.setOrderStatus(OrderStatusEnum.FINISHED.getCode());</span><br><span class="line">    <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">    BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">    <span class="type">OrderMaster</span> <span class="variable">result</span> <span class="operator">=</span> orderMasterRepository.save(orderMaster);</span><br><span class="line">    <span class="keyword">return</span> orderDTO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="退款"><a href="#退款" class="headerlink" title="退款"></a>退款</h4><p>首先判断订单状态，然后判断支付状态，最后修改支付状态</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">paid</span><span class="params">(OrderDTO orderDTO)</span> &#123;</span><br><span class="line">        <span class="comment">//判断订单状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(OrderStatusEnum.NEW.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[支付订单]订单状态不正确，orderId=&#123;&#125;,orderStatus=&#123;&#125;&quot;</span>, orderDTO.getOrderId(), orderDTO.getOrderStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_STATUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断支付状态</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getOrderStatus().equals(PayStatusEnum.WAIT.getCode())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[支付订单]支付状态不正确，orderId=&#123;&#125;,payStatus=&#123;&#125;&quot;</span>, orderDTO.getOrderId(), orderDTO.getPayStatus());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PAY_STAUS_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//修改支付状态</span></span><br><span class="line">        orderDTO.setPayStatus(PayStatusEnum.SUCCESS.getCode());</span><br><span class="line">        <span class="type">OrderMaster</span> <span class="variable">orderMaster</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderMaster</span>();</span><br><span class="line">        BeanUtils.copyProperties(orderDTO, orderMaster);</span><br><span class="line">        orderMasterRepository.save(orderMaster);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="订单Service测试"><a href="#订单Service测试" class="headerlink" title="订单Service测试"></a>订单Service测试</h4><p>测试代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderServiceImplTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">buyerOpenid</span> <span class="operator">=</span> <span class="string">&quot;110110&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">Order_Id</span> <span class="operator">=</span> <span class="string">&quot;12345678&quot;</span>;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderServiceImpl orderService;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDTO</span>();</span><br><span class="line">        orderDTO.setBuyerAddress(<span class="string">&quot;慕课网&quot;</span>);</span><br><span class="line">        orderDTO.setBuyerName(<span class="string">&quot;拜考神&quot;</span>);</span><br><span class="line">        orderDTO.setBuyerPhone(<span class="string">&quot;18888888888&quot;</span>);</span><br><span class="line">        orderDTO.setBuyerOpenid(buyerOpenid);</span><br><span class="line">        <span class="comment">//购物车</span></span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="type">OrderDetail</span> <span class="variable">o1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDetail</span>();</span><br><span class="line">        o1.setProductId(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        o1.setProductQuantity(<span class="number">2</span>);</span><br><span class="line">        orderDetailList.add(o1);</span><br><span class="line">        orderDTO.setOrderDetailList(orderDetailList);</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO1</span> <span class="operator">=</span> orderService.create(orderDTO);</span><br><span class="line">        assertNotNull(orderDTO1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getOne</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">result</span> <span class="operator">=</span> orderService.getOne(Order_Id);</span><br><span class="line">        log.info(<span class="string">&quot;[查询单个订单] result=&#123;&#125;&quot;</span>, result);</span><br><span class="line">        assertNotNull(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">findList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">request</span> <span class="operator">=</span> PageRequest.of(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">        Page&lt;OrderDTO&gt; orderDTOPage = orderService.findList(buyerOpenid, request);</span><br><span class="line">        log.info(<span class="string">&quot;查询订单List的结果：result=&#123;&#125;&quot;</span>, orderDTOPage.getContent());</span><br><span class="line">        assertNotEquals(<span class="number">0</span>, orderDTOPage.getTotalElements());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cancel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">result</span> <span class="operator">=</span> orderService.getOne(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> orderService.cancel(result);</span><br><span class="line">        assertEquals(OrderStatusEnum.CANCEL.getCode(), orderDTO.getOrderStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">finish</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">result</span> <span class="operator">=</span> orderService.getOne(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> orderService.finish(result);</span><br><span class="line">        assertEquals(OrderStatusEnum.FINISHED.getCode(), orderDTO.getOrderStatus());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">paid</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">result</span> <span class="operator">=</span> orderService.getOne(<span class="string">&quot;123456&quot;</span>);</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> orderService.paid(result);</span><br><span class="line">        assertEquals(PayStatusEnum.SUCCESS.getCode(), orderDTO.getPayStatus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="订单Controller层开发"><a href="#订单Controller层开发" class="headerlink" title="订单Controller层开发"></a>订单Controller层开发</h3><p>开发一个create页面，参数是一个OrderForm，其定义如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderForm</span> &#123;</span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;姓名必填&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;手机号必填&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;地址必填&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;微信openid必填&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String openid;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NotEmpty(message = &quot;购物车不能为空&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String items;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要求验证这个form的内容不为空，在定义时加入注解<code>@NotEmpty</code>，参数之前加入注解<code>@Valid</code></p>
<p>过程中要求把OrderFrom转换为OrderDTO，在converter包中新建类<code>OrderForm2OrderDTO</code>，用google的Gson工具，将string转换为对象，在pom.xml中需要加入依赖：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.code.gson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>gson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>OrderForm2OrderDTO</code>定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderForm2OrderDTO</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> OrderDTO <span class="title function_">convert</span><span class="params">(OrderForm orderForm)</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDTO</span>();</span><br><span class="line">        <span class="type">Gson</span> <span class="variable">gson</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Gson</span>();</span><br><span class="line">        orderDTO.setBuyerName(orderForm.getName());</span><br><span class="line">        orderDTO.setBuyerPhone(orderForm.getPhone());</span><br><span class="line">        orderDTO.setBuyerAddress(orderForm.getAddress());</span><br><span class="line">        orderDTO.setBuyerOpenid(orderForm.getOpenid());</span><br><span class="line">        List&lt;OrderDetail&gt; orderDetailList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            orderDetailList = gson.fromJson(orderForm.getItems(), <span class="keyword">new</span> <span class="title class_">TypeToken</span>&lt;List&lt;OrderDetail&gt;&gt;() &#123;</span><br><span class="line">            &#125;.getType());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[对象转换]错误，string=&#123;&#125;&quot;</span>, orderForm.getItems());</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PARAM_ERROR.getCode(), e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        orderDTO.setOrderDetailList(orderDetailList);</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查找订单的内容，需要判断用户id和订单是不是一样，我们将这部分代码放在BuyerService当中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuyerServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">BuyerService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">findOrderOne</span><span class="params">(String openid, String orderid)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> checkOrderOwner(orderid, openid);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> OrderDTO <span class="title function_">cancelOrder</span><span class="params">(String openid, String orderid)</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> checkOrderOwner(openid, orderid);</span><br><span class="line">        <span class="keyword">if</span> (orderDTO == <span class="literal">null</span>) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[取消订单]查不到该订单,orderid=&#123;&#125;&quot;</span>, orderid);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_NOT_EXSIT);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderService.cancel(orderDTO);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> OrderDTO <span class="title function_">checkOrderOwner</span><span class="params">(String openid, String orderid)</span> &#123;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> orderService.getOne(orderid);</span><br><span class="line">        <span class="keyword">if</span> (orderDTO == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断是不是自己的订单</span></span><br><span class="line">        <span class="keyword">if</span> (!orderDTO.getBuyerOpenid().equals(openid)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[查询订单]订单openid不一致，openid=&#123;&#125;,orderid=&#123;&#125;&quot;</span>, openid, orderid);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.ORDER_OWNER_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> orderDTO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>controller的定义如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/buyer/order&quot;)</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BuyerOrderController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BuyerService buyerService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//创建订单</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/create&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultVO <span class="title function_">create</span><span class="params">(<span class="meta">@Valid</span> OrderForm orderForm, BindingResult bindingResult)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (bindingResult.hasErrors()) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[创建订单]参数不正确，orderForm=&#123;&#125;&quot;</span>, orderForm);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PARAM_ERROR.getCode(), Objects.requireNonNull(bindingResult.getFieldError()).getDefaultMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OrderDTO</span>();</span><br><span class="line">        orderDTO = OrderForm2OrderDTO.convert(orderForm);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(orderDTO.getOrderDetailList())) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[创建订单]购物车不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.CART_EMPTY);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">createReuslt</span> <span class="operator">=</span> orderService.create(orderDTO);</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;orderId&quot;</span>, createReuslt.getOrderId());</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success(map);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单列表</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/list&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultVO <span class="title function_">list</span><span class="params">(<span class="meta">@RequestParam(&quot;openid&quot;)</span> String openid,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;0&quot;)</span> Integer page,</span></span><br><span class="line"><span class="params">                         <span class="meta">@RequestParam(value = &quot;size&quot;, defaultValue = &quot;10&quot;)</span> Integer size)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(openid)) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;[查询订单列表]openid为空&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SellException</span>(ResultEnum.PARAM_ERROR);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">PageRequest</span> <span class="variable">request</span> <span class="operator">=</span> PageRequest.of(page, size);</span><br><span class="line">        Page&lt;OrderDTO&gt; orderDTOPage = orderService.findList(openid, request);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success(orderDTOPage.getContent());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//取消订单</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/cancel&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultVO <span class="title function_">cancel</span><span class="params">(<span class="meta">@RequestParam(&quot;openid&quot;)</span> String openid,</span></span><br><span class="line"><span class="params">                           <span class="meta">@RequestParam(&quot;orderid&quot;)</span> String orderid)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO 不安全的做法需要改进</span></span><br><span class="line">		<span class="comment">// OrderDTO orderDTO = orderService.getOne(orderid);</span></span><br><span class="line">		<span class="comment">// orderService.cancel(orderDTO);</span></span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> buyerService.findOrderOne(openid, orderid);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//订单详情</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/detail&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> ResultVO <span class="title function_">detail</span><span class="params">(<span class="meta">@RequestParam(&quot;openid&quot;)</span> String openid,</span></span><br><span class="line"><span class="params">                           <span class="meta">@RequestParam(&quot;orderid&quot;)</span> String orderid)</span> &#123;</span><br><span class="line"><span class="comment">//        //TODO 不安全的做法，需要改进</span></span><br><span class="line"><span class="comment">//        OrderDTO orderDTO = orderService.getOne(orderid);</span></span><br><span class="line"><span class="comment">//        return ResultVOUtil.success(orderDTO);</span></span><br><span class="line">        <span class="type">OrderDTO</span> <span class="variable">orderDTO</span> <span class="operator">=</span> buyerService.findOrderOne(openid, orderid);</span><br><span class="line">        <span class="keyword">return</span> ResultVOUtil.success(orderDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面的内容主要是关于支付的，等开发有需要的时候再研究这部分。</p>
]]></content>
      <categories>
        <category>java</category>
        <category>网页</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>*args,**kwargs的使用方法</title>
    <url>/2017/11/25/args-kwargs%E7%9A%84%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p><code>*args</code>和<code>**kargs</code>是一种约定俗称的用法，目的是用于传入不定数量的参数，前者把传入的参数变成一个tuple，后者把传入的参数编程一个字典</p>
<span id="more"></span>

<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [1]: def foo(*args):</span><br><span class="line">   ...:     for a in args:</span><br><span class="line">   ...:         print a</span><br><span class="line">   ...:         </span><br><span class="line">   ...:         </span><br><span class="line"></span><br><span class="line">In [2]: foo(1)</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">In [4]: foo(1,2,3)</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>

<p>The <code>**kwargs</code> will give you all <strong>keyword arguments</strong> except for those corresponding to a formal parameter as a dictionary.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [5]: def bar(**kwargs):</span><br><span class="line">   ...:     for a in kwargs:</span><br><span class="line">   ...:         print a, kwargs[a]</span><br><span class="line">   ...:         </span><br><span class="line">   ...:         </span><br><span class="line"></span><br><span class="line">In [6]: bar(name=&#x27;one&#x27;, age=27)</span><br><span class="line">age 27</span><br><span class="line">name one</span><br></pre></td></tr></table></figure>

<p>Both idioms can be mixed with normal arguments to allow a set of fixed and some variable arguments:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def foo(kind, *args, **kwargs):</span><br><span class="line">   pass</span><br></pre></td></tr></table></figure>

<p>Another usage of the <code>*l</code> idiom is to <strong>unpack argument lists</strong> when calling a function.</p>
<p><code>*</code>的另外一个用途就是unpack(打开包裹)，比如调用zip的时候，zip的用法是传入n个对象进行zip，但是每一个都是单独的，比如你可以<code>zip(*[1,2,3])</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [9]: def foo(bar, lee):</span><br><span class="line">   ...:     print bar, lee</span><br><span class="line">   ...:     </span><br><span class="line">   ...:     </span><br><span class="line"></span><br><span class="line">In [10]: l = [1,2]</span><br><span class="line"></span><br><span class="line">In [11]: foo(*l)</span><br><span class="line">1 2</span><br></pre></td></tr></table></figure>]]></content>
  </entry>
  <entry>
    <title>css对网页进行布局</title>
    <url>/2017/07/05/css%E5%AF%B9%E7%BD%91%E9%A1%B5%E8%BF%9B%E8%A1%8C%E5%B8%83%E5%B1%80/</url>
    <content><![CDATA[<h2 id="一列布局使用"><a href="#一列布局使用" class="headerlink" title="一列布局使用"></a>一列布局使用</h2><p>三个<code>div</code>分别为上中下，分别设置每一个的高度和宽度以及背景颜色</p>
<span id="more"></span>

<p>居中效果的代码是<code>margin:0 auto</code>，意思是上下的宽度设置为0，左右的宽度设置为auto</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>1列布局<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>: <span class="number">0</span></span></span><br><span class="line"><span class="language-css">        &#125;     </span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.main</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">800px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">300px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#ccc</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.top</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: blue;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.foot</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">width</span>: <span class="number">800px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">height</span>: <span class="number">100px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background</span>: <span class="number">#900</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;top&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;foot&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="两列布局使用"><a href="#两列布局使用" class="headerlink" title="两列布局使用"></a>两列布局使用</h2><p>一个大的<code>div</code>，包含两个浮动于左右的<code>div</code>，<code>float:left</code>和<code>float:right</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>2列布局<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">body</span>&#123;<span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.main</span>&#123;<span class="attribute">margin</span>: <span class="number">0</span> auto;<span class="attribute">width</span>: <span class="number">800px</span>;&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.left</span>&#123;<span class="attribute">width</span>: <span class="number">200px</span>;<span class="attribute">height</span>: <span class="number">500px</span>;<span class="attribute">float</span>: left;<span class="attribute">background</span>: red&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.right</span>&#123;<span class="attribute">width</span>: <span class="number">520px</span>;<span class="attribute">height</span>: <span class="number">500px</span>;<span class="attribute">float</span>: right;<span class="attribute">background</span>: yellow&#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;left&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;right&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h2 id="三列布局使用"><a href="#三列布局使用" class="headerlink" title="三列布局使用"></a>三列布局使用</h2><p>三列布局有两种方式，第一种是通过设置三列的width：33.33%</p>
<p>第二种是绝对布局，左右都设置为<code>position:absolute</code></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE <span class="selector-tag">html</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">html</span> lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-<span class="number">8</span>&quot;&gt;</span><br><span class="line">    &lt;title&gt;<span class="number">3</span>列布局&lt;/title&gt;</span><br><span class="line">    &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">        <span class="selector-tag">body</span>&#123;<span class="attribute">margin</span>: <span class="number">0</span>;<span class="attribute">padding</span>: <span class="number">0</span>&#125;</span><br><span class="line">        <span class="selector-class">.main</span>&#123;<span class="attribute">margin</span>: <span class="number">0</span> auto;<span class="attribute">width</span>: <span class="number">800px</span>;&#125;</span><br><span class="line">        <span class="selector-class">.left</span>&#123;<span class="attribute">width</span>: <span class="number">200px</span>;<span class="attribute">height</span>: <span class="number">500px</span>;<span class="attribute">background</span>: red;<span class="attribute">position</span>: absolute;<span class="attribute">left</span>: <span class="number">0</span>;<span class="attribute">top</span>: <span class="number">0</span>&#125;</span><br><span class="line">        <span class="selector-class">.middle</span>&#123;<span class="attribute">height</span>: <span class="number">500px</span>;<span class="attribute">background</span>: green;<span class="attribute">margin</span>: <span class="number">0</span> <span class="number">310px</span> <span class="number">0</span> <span class="number">210px</span>&#125;</span><br><span class="line">        <span class="selector-class">.right</span>&#123;<span class="attribute">width</span>: <span class="number">300px</span>;<span class="attribute">height</span>: <span class="number">500px</span>;<span class="attribute">background</span>: yellow;<span class="attribute">position</span>: absolute;<span class="attribute">right</span>: <span class="number">0</span>;<span class="attribute">top</span>: <span class="number">0</span>&#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;<span class="selector-tag">body</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;<span class="attribute">left</span>&quot;&gt;<span class="number">200px</span>&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;middle&quot;&gt;middle&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;<span class="attribute">right</span>&quot;&gt;<span class="number">300px</span>&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">body</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">html</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="混合布局的使用"><a href="#混合布局的使用" class="headerlink" title="混合布局的使用"></a>混合布局的使用</h2><p>上下自动居中，中间使用浮动在左右</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE <span class="selector-tag">html</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">html</span> lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-<span class="number">8</span>&quot;/&gt;</span><br><span class="line">    &lt;title&gt;<span class="number">1</span>列布局&lt;/title&gt;</span><br><span class="line">    &lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line">        <span class="selector-tag">body</span>&#123;</span><br><span class="line">            <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">            <span class="attribute">padding</span>: <span class="number">0</span></span><br><span class="line">        &#125;     </span><br><span class="line">        <span class="selector-class">.main</span>&#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">800px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">            <span class="attribute">background</span>: <span class="number">#ccc</span>;</span><br><span class="line">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-class">.left</span>&#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">200px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">            <span class="attribute">background</span>: yellow;</span><br><span class="line">            <span class="attribute">float</span>: left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-class">.right</span>&#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">600px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">            <span class="attribute">background</span>: red;</span><br><span class="line">            <span class="attribute">float</span>: right;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-class">.top</span>&#123;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">800px</span>;</span><br><span class="line">            <span class="attribute">background</span>: blue;</span><br><span class="line">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">            <span class="attribute">text-align</span>: center;</span><br><span class="line">            <span class="attribute">vertical-align</span>: middle;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-class">.foot</span>&#123;</span><br><span class="line">            <span class="attribute">width</span>: <span class="number">800px</span>;</span><br><span class="line">            <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">            <span class="attribute">background</span>: <span class="number">#900</span>;</span><br><span class="line">            <span class="attribute">margin</span>: <span class="number">0</span> auto;</span><br><span class="line">        &#125;</span><br><span class="line">    &lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;<span class="selector-tag">body</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">div</span> class=&quot;<span class="attribute">top</span>&quot;&gt;<span class="attribute">top</span>&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">div</span> class=&quot;<span class="selector-tag">main</span>&quot;&gt;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;<span class="attribute">left</span>&quot;&gt;<span class="attribute">left</span>&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">    &lt;<span class="selector-tag">div</span> class=&quot;<span class="attribute">right</span>&quot;&gt;<span class="attribute">right</span>&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">div</span> class=&quot;foot&quot;&gt;foot&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">body</span>&gt;</span><br><span class="line">&lt;/<span class="selector-tag">html</span>&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>网页</tag>
        <tag>css</tag>
      </tags>
  </entry>
  <entry>
    <title>c++ primer 基础语法</title>
    <url>/2018/04/10/c++%20primer-%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<p>最近看了看c++基础语法，记录如下</p>
<span id="more"></span>

<p>感觉windows下面visual studio的代码提示不是很好用，还是用了熟悉的intelligJ的IDE——clion</p>
<p>安装clion之后安装MinGW，就可以开始编程了</p>
<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><h3 id="标准输入输出流"><a href="#标准输入输出流" class="headerlink" title="标准输入输出流"></a>标准输入输出流</h3><p>cin和cout用于输入输出，需要包含iostream头文件，并using namespace std;</p>
<p>可以用多个输入输出符号进行连续输出或者输入</p>
<p>cin连续输入的分隔符号是：空格、tab或换行符</p>
<p>格式是</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">  cout &lt;&lt; a &lt;&lt; <span class="string">&quot;字符串&quot;</span> &lt;&lt; b;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="循环及条件语句"><a href="#循环及条件语句" class="headerlink" title="循环及条件语句"></a>循环及条件语句</h3><p>while，for，if与c语言基本相同，没有什么说的</p>
<p>输入不定量的数据：while(cin &gt;&gt; value)，这样实现的原因是cin输入正常的时候，判定为true，没有值的时候判定为false</p>
<h2 id="第二章：内置类型"><a href="#第二章：内置类型" class="headerlink" title="第二章：内置类型"></a>第二章：内置类型</h2><h3 id="int和unsigned-int"><a href="#int和unsigned-int" class="headerlink" title="int和unsigned int"></a>int和unsigned int</h3><p>如果unsigned int表示一个负数的话，应该是取其补码（因为负数在计算机中是以补码的形式存储的），按unsigned int来计算值（无符号位），当然有一个简单的办法，比如你是32位机器，那么-1的表示形式就是$2^{32}-1$，-32的表示形式就是$2^{32}-32$</p>
<p>int 类型的第一位是符号位，0表示正数，1表示负数</p>
<h3 id="string"><a href="#string" class="headerlink" title="string"></a>string</h3><p>string在c++中一个要用双引号：””</p>
<p>单引号表示char： ‘’</p>
<p>多个字符串如果紧邻且中间仅用空格、缩进和换行符分隔，那么他们就是一个字符串</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    cout&lt;&lt; <span class="string">&quot;my name is&quot;</span></span><br><span class="line">           <span class="string">&quot;jeffrey&quot;</span>&lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="转义字符"><a href="#转义字符" class="headerlink" title="转义字符"></a>转义字符</h3><p>在反斜杠”&quot;后面紧跟着1个，2个或3个八进制字符</p>
<h3 id="指定字面值的类型"><a href="#指定字面值的类型" class="headerlink" title="指定字面值的类型"></a>指定字面值的类型</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="string">L&#x27;A&#x27;</span>  <span class="comment">//宽字符型，wchar_t</span></span><br><span class="line"><span class="string">u8&#x27;hi!&#x27;</span>  <span class="comment">//utf-8字符</span></span><br><span class="line"><span class="number">3.1315L</span>  <span class="comment">//long double</span></span><br><span class="line"><span class="number">1E-3</span>F   <span class="comment">//单精度浮点数，float E-3表示10的-3次方，小写的e效果一样</span></span><br><span class="line"><span class="number">42ULL</span>   <span class="comment">//Unsigned long long</span></span><br></pre></td></tr></table></figure>

<h3 id="变量赋值方法"><a href="#变量赋值方法" class="headerlink" title="变量赋值方法"></a>变量赋值方法</h3><p>c++有四种变量赋值方法：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> a = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> b = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span> c&#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">d</span><span class="params">(<span class="number">0</span>)</span></span>;</span><br></pre></td></tr></table></figure>

<p>上面四个方法分别对应把abcd赋值为0，花括号的赋值方法叫做<strong>列表初始化</strong>，但是这种方法有个问题就是如果存在精度损失的情况下，编译器会报错。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="type">double</span> ld=<span class="number">3.1424234</span>;</span><br><span class="line"><span class="type">int</span> a&#123;ld&#125;, b&#123;ld&#125;;  <span class="comment">//报错，因为列表初始化不允许存在精度损失</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">a</span><span class="params">(ld)</span>, <span class="title">b</span><span class="params">(ld)</span></span>;  <span class="comment">//不报错，但存在精度损失</span></span><br></pre></td></tr></table></figure>

<p>变量赋值<strong>不能使用连等号</strong></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> a=b=<span class="number">0</span>;  <span class="comment">//错误！！！</span></span><br><span class="line"><span class="type">int</span> a=<span class="number">0</span>, b=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><p>用两个冒号表示作用域，左边表示作用域，右边表示变量或函数名</p>
<p>比如常见的std::cout</p>
<p>全局作用域就是两个冒号，左边没有值，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a = 5</span><br><span class="line">int main(int argc, char *argv[])&#123;</span><br><span class="line">    cout &lt;&lt; ::a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="引用和指针"><a href="#引用和指针" class="headerlink" title="引用和指针"></a>引用和指针</h3><ol>
<li><p>引用<br>引用必须要初始化（定义的时候必须赋值），赋值为另一个已经定义好的变量，这样两个变量就相当于是同一个变量，只是名字不同而已</p>
</li>
<li><p>指针<br>空指针是指向某个对象，可以初始化为空指针nullptr或null或0</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> *p1=<span class="literal">nullptr</span></span><br></pre></td></tr></table></figure>

<p>指针必须指向相同类型的元素，void类型的指针可以指向任何元素</p>
</li>
</ol>
<h3 id="const限定符"><a href="#const限定符" class="headerlink" title="const限定符"></a>const限定符</h3><p>const用于定义一个无法改变的常数，在初始化的时候必须要赋值</p>
<p>声明变量用extern，如果想定义一个大家都能用的const值，那么在定义的时候必须同时用到external和const关键字</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">int</span> butSize = <span class="number">512</span>;</span><br><span class="line"><span class="comment">//在别的文件中用到这个值只需要声明一下</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="type">int</span> butSize;</span><br></pre></td></tr></table></figure>

<h4 id="const指针"><a href="#const指针" class="headerlink" title="const指针"></a>const指针</h4><p>常量指针因为值不能变，所以必须初始化</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> number=<span class="number">0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> *<span class="type">const</span> num = &amp;number;</span><br></pre></td></tr></table></figure>

<p>顶层const：指针本身是一个常量，如<code>int *const p = a;</code></p>
<p>底层const：指针所指向的是一个常量，如<code>const int a =1;const int *p=a;</code></p>
<h3 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h3><p>使用关键字typedef进行别名定义：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="type">double</span> wages; <span class="comment">//定义weges是double的别名</span></span><br></pre></td></tr></table></figure>

<p>或者别名声明进行定义using：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> wagees = <span class="type">double</span>;</span><br></pre></td></tr></table></figure>

<h3 id="auto类型说明符"><a href="#auto类型说明符" class="headerlink" title="auto类型说明符"></a>auto类型说明符</h3><p>auto可以自动识别数值类型，但是定义的时候必须初始化：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">auto</span> item = value1 + value2;</span><br></pre></td></tr></table></figure>

<h3 id="decl类型指示符"><a href="#decl类型指示符" class="headerlink" title="decl类型指示符"></a>decl类型指示符</h3><p>decl类型指示符是用于得到某个对象或变量的类型，来定义别的变量</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> i =<span class="number">0</span>;</span><br><span class="line"><span class="keyword">decltype</span>(ci) x=<span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<h3 id="标准库类型string"><a href="#标准库类型string" class="headerlink" title="标准库类型string"></a>标准库类型string</h3><p>用string之前要声明，<code>using std::string</code></p>
<p>初始化方法有直接初始化和拷贝初始化两种，不使用等号的就是直接初始化</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> std::string</span><br><span class="line">string s1;</span><br><span class="line">string s2 = s1;</span><br><span class="line">string s3 = <span class="string">&quot;hiya&quot;</span>;   <span class="comment">//拷贝初始化</span></span><br><span class="line"><span class="function">string <span class="title">s4</span><span class="params">(<span class="number">10</span>,<span class="string">&#x27;c&#x27;</span>)</span></span>;   <span class="comment">//直接初始化</span></span><br></pre></td></tr></table></figure>

<p>string的输入是以第一个不为空白的地方开始，到下一个空白符的地方结束</p>
<ul>
<li><p>判断string为空：string.empty()，为空返回true，否则返回false</p>
</li>
<li><p>读入一行：getline(string, line)函数，从string读入，读入之后放在line中</p>
</li>
<li><p>返回string长度：string.size()</p>
</li>
<li><p>string比较: <code>==</code>或者是<code>!=</code>，两个字符串如果a是b的子串，那么b&gt;a，如果ab有很多不同，那么他们的大小是按照第一个不相同的字符的比较来的</p>
</li>
</ul>
<p>c++的string也可以直接相加，但是区别是不能把两个都用双引号扩起来的字面值相加，相加的至少有一个是string类型：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">string s1 = <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">string s2 = <span class="string">&quot;world&quot;</span>;</span><br><span class="line">string s3 = s1 + <span class="string">&quot;, &quot;</span> + s2;   <span class="comment">//正确，因为s1和s2都是string类型</span></span><br><span class="line">string s3 = <span class="string">&quot;hello&quot;</span> + <span class="string">&quot;, &quot;</span>    <span class="comment">//错误，两个字面值不能直接相加</span></span><br></pre></td></tr></table></figure>

<h4 id="字符串处理函数"><a href="#字符串处理函数" class="headerlink" title="字符串处理函数"></a>字符串处理函数</h4><p>包含在cctype头文件中</p>
<table>
<thead>
<tr>
<th>isalnum():是字母或数字时为真</th>
</tr>
</thead>
<tbody><tr>
<td>isalpha()：是字母为真</td>
</tr>
<tr>
<td>iscntrl()：是控制字符为真</td>
</tr>
<tr>
<td>isdigit()：是数字为真</td>
</tr>
<tr>
<td>issupper()：大写字母为真</td>
</tr>
<tr>
<td>ispunct():是符号位真</td>
</tr>
<tr>
<td>isprint()：可打印时为真</td>
</tr>
<tr>
<td>isgraph()：不为空格且可打印时为真</td>
</tr>
<tr>
<td>tolower()，toupper()：大小写转换</td>
</tr>
</tbody></table>
<h4 id="对字符串进行迭代"><a href="#对字符串进行迭代" class="headerlink" title="对字符串进行迭代"></a>对字符串进行迭代</h4><p>使用范围for对字符串迭代</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> c : str)</span><br><span class="line">  cout &lt;&lt; c &lt;&lt;endl;</span><br></pre></td></tr></table></figure>

<p>使用范围for对字符串的值进行改变，每个c都定义为引用，改变c的时候就改变了原来的字符串</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;c : str)</span><br><span class="line">  c = <span class="built_in">topper</span>(c)</span><br></pre></td></tr></table></figure>

<h4 id="使用下标访问字符串"><a href="#使用下标访问字符串" class="headerlink" title="使用下标访问字符串"></a>使用下标访问字符串</h4><p>与python类似，c++也可以用下标访问string，开头为str[0]，结尾为str[str.size()-1]，要注意，str.size()的返回类型并不是int，而是<code>string::size_type</code>，因此定义index的时候要用到decltype()</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">string word = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">decltype</span>(word.<span class="built_in">size</span>()) index=<span class="number">0</span>; (index != word.<span class="built_in">size</span>()) &amp;&amp; (!<span class="built_in">isspace</span>(word[index])); ++index) &#123;</span><br><span class="line">  word[index] = <span class="built_in">toupper</span>(word[index]);</span><br><span class="line">&#125;</span><br><span class="line">cout &lt;&lt; word &lt;&lt; endl;</span><br></pre></td></tr></table></figure>

<h3 id="容器vector"><a href="#容器vector" class="headerlink" title="容器vector"></a>容器vector</h3><p>要想使用vector就要包含vector头文件<code>#include &lt;vector&gt;</code></p>
<p>vector有点像python里面的list，什么都可以放进去，vector基本可以容纳所有对象，但是引用不是对象，所以vector无法存放引用</p>
<p>初始化vector只需要<code>vector&lt;type&gt; i</code>就可以了，大体来说有以下几种初始化方法</p>
<table>
<thead>
<tr>
<th><code>vector&lt;T&gt; V1</code>:空vector，用于存放T</th>
</tr>
</thead>
<tbody><tr>
<td><code>vector&lt;t&gt; v2(v1)</code>：将v1赋值给v2</td>
</tr>
<tr>
<td><code>vecto&lt;T&gt; v3(n,val)</code>：v3包含n个val</td>
</tr>
<tr>
<td><code>vector&lt;T&gt; v4(n)</code>：包含n个重复执行值初始化的对象</td>
</tr>
<tr>
<td><code>vector&lt;T&gt; v5&#123;a,b,c...&#125;</code>： v5包含初始值个数的元素，每个元素在初始化阶段被赋值</td>
</tr>
<tr>
<td><code>vector&lt;T&gt; v5=&#123;a,b,c...&#125;</code> ：等价于v5</td>
</tr>
</tbody></table>
<p>注意：用圆括号的时候是用来构建vector的元素个数的，用花括号是用来表示初始值的</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">vector&lt;<span class="type">int</span>&gt; v1&#123;<span class="number">10</span>&#125;;  <span class="comment">//只有一个值为10</span></span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">v1</span><span class="params">(<span class="number">10</span>)</span></span>;  <span class="comment">//有10个初值为0的值</span></span><br></pre></td></tr></table></figure>

<h3 id="向vector中添加元素"><a href="#向vector中添加元素" class="headerlink" title="向vector中添加元素"></a>向vector中添加元素</h3><p>使用push_back方法，类似于python list的append方法，每次放在最后</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">vector&lt;<span class="type">int</span>&gt; a;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; ++i) &#123;</span><br><span class="line">  a.<span class="built_in">push_back</span>(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问vector的方法和访问string基本一致，用方括号加索引，vector也有size, empty,等等函数，也可以直接比较</p>
<p>将输入的字符串大写并输出，注意toupper之后返回一个int类型，不能直接用to_string方法，那样会让结果是ascii码的字符串类型，就是一串数字</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    vector&lt;string&gt; a;</span><br><span class="line">    string temp;</span><br><span class="line">    string temp_string=<span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">while</span> (cin &gt;&gt; temp)&#123;</span><br><span class="line">        temp_string = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> tempc : temp)</span><br><span class="line">            temp_string += <span class="built_in">toupper</span>(tempc);</span><br><span class="line">        a.<span class="built_in">push_back</span>(temp_string);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> i : a)&#123;</span><br><span class="line">        cout &lt;&lt; i &lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h3><p>迭代器有begin和end两种方法，分别指向第一个元素和<strong>最后一个元素的下一个元素</strong>，特殊地，空容器返回的begin和end是同一个迭代器</p>
<p>迭代器使用<code>==</code>或<code>!=</code>进行比较，用<code>++</code>向前移动一个位置，<code>+n</code>则移动n个位置，减法亦然，大小于符号用来比较同一个vector对象的两个迭代器，注意：两个迭代器可以做减法，但是不能做加法，加法只能加常数</p>
<p>比如迭代器访问一个string：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">string a = <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> i = a.<span class="built_in">begin</span>();  i != a.<span class="built_in">end</span>() ; i++) &#123;</span><br><span class="line">  *i = <span class="built_in">toupper</span>(*i);</span><br><span class="line">  cout &lt;&lt; *i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>c++在for当中的判断都是用的<code>!=</code>，这可以使得在用迭代器和普通的for时候的形式一样，因此用不等于符号</p>
<h4 id="迭代器类型"><a href="#迭代器类型" class="headerlink" title="迭代器类型"></a>迭代器类型</h4><p>包含普通迭代器和常量迭代器，普通迭代器可以读写，常量迭代器只能读</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">vector&lt;<span class="type">int</span>&gt;::iterator it; <span class="comment">//it能读写vector&lt;int&gt;元素</span></span><br><span class="line">string::iterator it2;		<span class="comment">//it2能读写string元素</span></span><br><span class="line">vector&lt;<span class="type">int</span>&gt;::const_iterator it3; <span class="comment">//it3只能读vector&lt;int&gt;元素</span></span><br></pre></td></tr></table></figure>

<p>c++11中引入两个新函数，cbegin和cend，是为了直接获得const_iterator的</p>
<h4 id="迭代器解引用"><a href="#迭代器解引用" class="headerlink" title="迭代器解引用"></a>迭代器解引用</h4><p>原始的解引用的方法是<code>(*it).function()</code>，c++引入了一种新的解引用的方法，用箭头运算符<code>it-&gt;function()</code></p>
<h3 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h3><p>字符串数组初始化的时候，会在后面加一个’\0’结束符，但用<code>&#123;&#125;</code>的形式初始化的时候不会加</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> a1[] = &#123;<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>&#125;; <span class="comment">//没有加&#x27;\0&#x27;</span></span><br><span class="line"><span class="type">char</span> a2[] = &#123;<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;\0&#x27;</span>&#125;; <span class="comment">//手动加&#x27;\0&#x27;</span></span><br><span class="line"><span class="type">char</span> a3[] = <span class="string">&quot;abc&quot;</span>; <span class="comment">//自动加&#x27;\0&#x27;</span></span><br></pre></td></tr></table></figure>

<p>有指针的数组，没有引用的数组，但是有数组的引用和数组的指针</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> *p[<span class="number">10</span>]; <span class="comment">//含有10个整型指针的数组</span></span><br><span class="line"><span class="built_in">int</span> (*p)[<span class="number">10</span>] = &amp;arr;  <span class="comment">//p指向含有10个整数的数组</span></span><br><span class="line"><span class="built_in">int</span> (&amp;p)[<span class="number">10</span>] = arr;<span class="comment">//p引用一个含有10个整数的数组</span></span><br></pre></td></tr></table></figure>

<p>数组也通过下标访问</p>
<h4 id="指针和数组"><a href="#指针和数组" class="headerlink" title="指针和数组"></a>指针和数组</h4><p>书组合指针联系紧密，对数组取地址则得到该元素的指针</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">string num[] = &#123;<span class="string">&quot;one&quot;</span>,<span class="string">&quot;two&quot;</span>,<span class="string">&quot;three&quot;</span>&#125;;</span><br><span class="line">string *p = &amp;num[<span class="number">0</span>];</span><br><span class="line">string *p2 = num;  <span class="comment">//等价于前一句</span></span><br></pre></td></tr></table></figure>

<p>指针也可以像数组一样进行加减整数的运算</p>
<p>注意指针的数组和数组的指针的区别</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> *ip[<span class="number">4</span>]; <span class="comment">//整型指针的数组</span></span><br><span class="line"><span class="built_in">int</span> (*ip)[<span class="number">4</span>]; <span class="comment">//指向含有4个整数的数组</span></span><br></pre></td></tr></table></figure>

<h4 id="c风格的字符串"><a href="#c风格的字符串" class="headerlink" title="c风格的字符串"></a>c风格的字符串</h4><p>c风格的字符串定义方式是<code>char *str = &quot;abcd&quot;</code>，如果要用string赋值给c类型的字符串，用<code>.c_str()</code>函数</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">string s = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line"><span class="type">char</span> *str = s.<span class="built_in">c_str</span>();</span><br></pre></td></tr></table></figure>

<h4 id="用数组初始化vector"><a href="#用数组初始化vector" class="headerlink" title="用数组初始化vector"></a>用数组初始化vector</h4><p>定义一个数组，用begin和end函数对vector进行初始化</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> int_arr[] = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;;</span><br><span class="line"><span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">ivec</span><span class="params">(begin(int_arr),end(int_arr))</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a>多维数组</h3><p>严格来说c++当中没有多维数组，所谓的多维数组就是数组的数组</p>
<h4 id="用范围for遍历多维数组"><a href="#用范围for遍历多维数组" class="headerlink" title="用范围for遍历多维数组"></a>用范围for遍历多维数组</h4><p>第一层循环要用引用，第二层循环直接auto，因为第一层循环如果不用引用的话，第一层就被自动转换成了指针，第二层再遍历就不合法了</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;row : ia)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;col : row)</span><br></pre></td></tr></table></figure>

<h2 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h2><p>大多数运算符和c当中的顺序没有明显差异，只记录一些比较生疏的运算符</p>
<p><code>?:</code> 运算符，用于选择运算，条件运算符的优先级非常低，如果在输出语句中包含，就不会执行</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">final_grade = (grade &gt; <span class="number">90</span>) ? <span class="string">&quot;high grade&quot;</span> : (grade &lt; <span class="number">60</span>) ? <span class="string">&quot;fail&quot;</span> : <span class="string">&quot;pass&quot;</span>;</span><br><span class="line">cout &lt;&lt; ( (grade &lt; <span class="number">60</span>) ? <span class="string">&quot;fail&quot;</span> : <span class="string">&quot;pass&quot;</span>); <span class="comment">//输出fail或pass</span></span><br><span class="line">cout &lt;&lt;  (grade &lt; <span class="number">60</span>) ? <span class="string">&quot;fail&quot;</span> : <span class="string">&quot;pass&quot;</span>;	<span class="comment">//输出1或0，即(grade&lt;60)的结果</span></span><br><span class="line">cout &lt;&lt; grade &lt; <span class="number">60</span> ? <span class="string">&quot;fail&quot;</span> : <span class="string">&quot;pass&quot;</span>;		<span class="comment">//错误，因为想当与cout&lt;&lt;grade;cout &lt; 60</span></span><br></pre></td></tr></table></figure>

<h3 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a>位运算符</h3><table>
<thead>
<tr>
<th>位运算符</th>
</tr>
</thead>
<tbody><tr>
<td>~：位求反</td>
</tr>
<tr>
<td>&lt;&lt;：左移</td>
</tr>
<tr>
<td><code>&gt;&gt;</code> ：右移</td>
</tr>
<tr>
<td>&amp;：位与</td>
</tr>
<tr>
<td>^：位异或</td>
</tr>
<tr>
<td>|：位或</td>
</tr>
</tbody></table>
<h3 id="逗号运算符"><a href="#逗号运算符" class="headerlink" title="逗号运算符"></a>逗号运算符</h3><p>逗号运算符通常放在for循环中，用以同时执行两个内容</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(vector&lt;<span class="type">int</span>&gt;::size_type ix=<span class="number">0</span>; ix!=ivec.<span class="built_in">size</span>(); ++ix,--cnt)</span><br></pre></td></tr></table></figure>

<h3 id="显示类型转换"><a href="#显示类型转换" class="headerlink" title="显示类型转换"></a>显示类型转换</h3><p>static_cast,dynamic_cast, const_cast, reinterpret_cast其中一种</p>
<p>任何明确定义的类型转换，只要不是底层const都可以用static_cast</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">double</span> slope = <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(j) / i ;强制类型转换以便执行浮点数除法</span><br></pre></td></tr></table></figure>

<p>dynamic_cast用于转换底层cosnt，将常量转换为非常量</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *pc;</span><br><span class="line"><span class="type">char</span> *p = <span class="built_in">const_cast</span>&lt;<span class="type">char</span>*&gt;(pc)</span><br></pre></td></tr></table></figure>

<p>reinterpret_cast用于对象底层的转换，比如char和int的转换</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> *ip;</span><br><span class="line"><span class="type">char</span> *pc = <span class="built_in">reinterpret_cast</span>&lt;<span class="type">char</span>*&gt;(ip);</span><br></pre></td></tr></table></figure>

<h2 id="语句"><a href="#语句" class="headerlink" title="语句"></a>语句</h2><p>大多数语句在c语言中已经学过，这里不多赘述，只详细讨论部分不熟悉的语句</p>
<p>if else语句用于条件判断</p>
<p>switch case语句也主要用于条件判断，记住switch语句要有break，不然就按顺序执行（不论条件是否满足都会往下执行），比如：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">switch</span>(ch)&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">    ++acnt;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:</span><br><span class="line">    ++ecnt;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;i&#x27;</span>:</span><br><span class="line">    ++icnt;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">    ++ocnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果输入的ch为e，此时++ecnt之后，没有break，接下来的++icnt和++ocnt都会被执行</p>
<p>没有可以匹配的时候，就匹配default标签</p>
<p>while和for语句用于循环，for比较特殊的就是范围for</p>
<p>do while语句是先执行，后判断</p>
<h3 id="跳转语句"><a href="#跳转语句" class="headerlink" title="跳转语句"></a>跳转语句</h3><p>c++有四种跳转语句：break，continue，goto，return</p>
<p>break用于跳出最近的循环</p>
<p>continue用于循环中的当前迭代，并立即开始下一次迭代</p>
<p>go to是直接跳到某一句，尽量不要用go to</p>
<h3 id="try语句和异常处理"><a href="#try语句和异常处理" class="headerlink" title="try语句和异常处理"></a>try语句和异常处理</h3><p>异常处理包括throw抛出异常和try catch处理异常</p>
<h4 id="throw"><a href="#throw" class="headerlink" title="throw"></a>throw</h4><p>直接throw 后面加上异常的内容</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (item1.<span class="built_in">isbn</span>() != item2.<span class="built_in">isbn</span>())&#123;</span><br><span class="line">  <span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;data should refer to same ISBN&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="try-catch语句"><a href="#try-catch语句" class="headerlink" title="try catch语句"></a>try catch语句</h4><p>用try尝试，多个catch抓住不同类型的错误，错误类型可以搜索c++标准异常</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> (cin &gt;&gt; item1 &gt;&gt; item2)&#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// 执行的语句</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">catch</span> (runtime_error err)&#123;</span><br><span class="line">    cout&lt;&lt;  err.<span class="built_in">what</span>() &lt;&lt;endl;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>这里只介绍不熟悉的函数重载</p>
<p>同一个作用域内几个函数，名字相同但形参不同，称为重载，编译器通过参数类型确定你调用的是哪个函数</p>
<h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><p>定义头文件的时候，用ifdef或者ifndef确保变量没有定义，然后用<code>#define</code>定义头文件变量<code>变量名_H</code>， 形式如下</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SALE_DATA_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SALE_DATA_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Sales_data</span>&#123;</span><br><span class="line">  std::string bookNo;</span><br><span class="line">  <span class="type">unsigned</span> units_sold=<span class="number">0</span>;</span><br><span class="line">  <span class="type">double</span> revenue=<span class="number">0.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>定义类当中的函数的时候，有时候会用到常量函数，就是在函数的名字后面添加一个const关键字，常量函数：</p>
<ul>
<li>如果尝试去改变这个类的成员变量，就会产生一个编译器错误；然而，在这个函数中读取一个类变量是允许的，但是不允许写一个类变量</li>
<li>还有一种理解就是对普通函数加一个this指针，而常量函数的this指针就是<code>const *this</code>， 比如定义一个<code>int Foo::Bar(int random_arg)</code>就等同于定义一个<code>int Foo::Bar(Foo *this, int random_arg)</code>，使用这个函数<code>Foo f;f.Bar(4)</code>就等同于<code>Foo f;f.Bar(&amp;f, 4)</code>，加了const在函数后面的话<code>int Foo::Bar(int random_arg) const</code>， 那么就可以理解为<code>int Foo::Bar(const Foo *this, int random_arg) const</code> ，在这种常量this指针的情况下，是不允许修改类成员变量的</li>
</ul>
<p>在这一章节中，函数常常返回的是<strong>引用</strong>，<strong>注意</strong>：不能返回局部的引用变量，如果要返回引用，那么你的函数参数里面至少有一个引用类型</p>
<h3 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h3><p>构造函数用于类的初始化，在没有定义构造函数的时候，有一个默认的default构造函数，当你定义了新的构造函数的时候，默认的构造函数失效</p>
<p><code>类名(参数类型1 参数名1,参数类型2, 参数2): 成员1(参数名1), 成员2(参数名2)&#123;&#125;</code>， 构造函数的通用形式</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Sale_data</span>&#123;</span><br><span class="line">    <span class="built_in">Sale_data</span>() = <span class="keyword">default</span>; <span class="comment">//默认构造函数</span></span><br><span class="line">    <span class="built_in">Sale_data</span>(<span class="type">const</span> string &amp;s):<span class="built_in">bookNo</span>(s)&#123;&#125;;  <span class="comment">//</span></span><br><span class="line">    <span class="built_in">Sale_data</span>(<span class="type">const</span> string &amp;s, <span class="type">unsigned</span> n, <span class="type">double</span> p):<span class="built_in">bookNo</span>(s),<span class="built_in">units_sold</span>(n),<span class="built_in">revenue</span>(p*n)&#123;&#125;</span><br><span class="line">  	<span class="built_in">Sale_data</span>(istream &amp;is)&#123;</span><br><span class="line">    	<span class="built_in">read</span>(is, *<span class="keyword">this</span>)</span><br><span class="line">  	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里string以引用方式传递，是因为在c++中，string是被视为指针的</p>
<p>class和struct的区别：当你希望所有成员都是public的时候用struct，只要有想要变成private的成员的情况下，都用class</p>
<h3 id="友元"><a href="#友元" class="headerlink" title="友元"></a>友元</h3><p>允许其他类或函数，访问类的非公有成员</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Sale_data</span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">friend</span> Sale_data <span class="title">add</span><span class="params">(<span class="type">const</span> <span class="type">int</span>&amp;)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">Sale_data <span class="title">add</span><span class="params">(<span class="type">const</span> Sale_data &amp;lhs, <span class="type">const</span> Sale_data &amp;rhs)</span></span>&#123;</span><br><span class="line">            Sale_data sum = lhs;</span><br><span class="line">            sum.<span class="built_in">combine</span>(rhs);</span><br><span class="line">            <span class="keyword">return</span> sum;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">        string bookNo;</span><br><span class="line">        <span class="type">unsigned</span> unints_sold=<span class="number">0</span>;</span><br><span class="line">        <span class="type">double</span> revenue=<span class="number">0.0</span>;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>类里面分public和private变量，public变量可以在类外访问，private变量不允许显式地访问，除非是想要进行访问的类是该类的友元，friend</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>c++</tag>
      </tags>
  </entry>
  <entry>
    <title>css教程</title>
    <url>/2017/06/30/css%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="CSS定义"><a href="#CSS定义" class="headerlink" title="CSS定义"></a>CSS定义</h1><span id="more"></span>

<p>CSS全称为“层叠样式表 (Cascading Style Sheets)”，它主要是用于定义HTML内容在浏览器内的<strong>显示样式</strong>，如文字大小、颜色、字体加粗等。</p>
<h2 id="css语法格式"><a href="#css语法格式" class="headerlink" title="css语法格式"></a>css语法格式</h2><p><strong>声明：</strong>在英文大括号“｛｝”中的的就是声明，属性和值之间用英文冒号“：”分隔。当有多条声明时，中间可以英文分号“;”分隔，如下所示：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">p</span>&#123;</span><br><span class="line">  <span class="attribute">font-size</span>:<span class="number">12px</span>;</span><br><span class="line">  <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="CSS-类型"><a href="#CSS-类型" class="headerlink" title="CSS 类型"></a>CSS 类型</h1><p>CSS样式可以写在哪些地方呢？从CSS 样式代码插入的形式来看基本可以分为以下3种：内联式、嵌入式和外部式三种。这一小节先来讲解内联式。</p>
<h2 id="内联式"><a href="#内联式" class="headerlink" title="内联式"></a>内联式</h2><p><code>内联式</code>css样式表就是把css代码直接写在现有的HTML标签中，<code>style=&quot;color=red&quot;</code>如下面代码：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;<span class="selector-tag">p</span> style=&quot;<span class="attribute">color</span>:red<span class="string">&quot;&gt;这里文字是红色。&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<p>并且css样式代码要写在style&#x3D;””双引号中，如果有多条css样式代码设置可以写在一起，中间用<strong>分号隔开</strong>。如下代码：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;<span class="selector-tag">p</span> style=&quot;<span class="attribute">color</span>:red;<span class="attribute">font-size</span>:<span class="number">12px</span><span class="string">&quot;&gt;这里文字是红色。&lt;/p&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="嵌入式"><a href="#嵌入式" class="headerlink" title="嵌入式"></a>嵌入式</h2><p><code>嵌入式</code>就是把内联式css样式写在<code>head</code>标签的<code>style</code>标签中，其属性为<code>type=&quot;text/css&quot;</code>，具体代码如下</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE <span class="selector-tag">HTML</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">html</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=&quot;<span class="attribute">Content</span>-Type&quot; <span class="attribute">content</span>=&quot;text/<span class="selector-tag">html</span>; charset=utf-<span class="number">8</span>&quot;&gt;</span><br><span class="line">&lt;title&gt;嵌入式css样式&lt;/title&gt;</span><br><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line"><span class="selector-tag">span</span>&#123;</span><br><span class="line">   <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br></pre></td></tr></table></figure>

<h2 id="外部式"><a href="#外部式" class="headerlink" title="外部式"></a>外部式</h2><p>外部式css样式(也可称为外联式)就是把css代码写一个单独的外部文件中，这个css样式文件以“<code>.css</code>”为扩展名，在<code>&lt;head&gt;</code>内（不是在<code>&lt;style&gt;</code>标签内）使用<code>&lt;link&gt;</code>标签将css样式文件链接到HTML文件内，如下面代码：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;link href=&quot;style<span class="selector-class">.css</span>&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;</span><br></pre></td></tr></table></figure>



<p>三种css属性的优先级是：</p>
<p><code>内联式 &gt; 嵌入式 &gt; 外部式</code></p>
<p>总的来说，css的优先级遵从就近原则</p>
<h2 id="类名"><a href="#类名" class="headerlink" title="类名"></a>类名</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line">.类选器名称&#123;css样式代码;&#125;</span><br></pre></td></tr></table></figure>

<p>使用方法：</p>
<p>第一步：使用合适的标签把要修饰的内容标记起来，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;span&gt;胆小如鼠&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<p>第二步：使用class&#x3D;”类选择器名称”为标签设置一个类，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;span class=&quot;stress&quot;&gt;胆小如鼠&lt;/span&gt;</span><br></pre></td></tr></table></figure>

<p>第三步：设置类选器css样式，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.stress&#123;color:red;&#125;/*类前面要加入一个英文圆点*/</span><br></pre></td></tr></table></figure>

<h2 id="id-选择器"><a href="#id-选择器" class="headerlink" title="id 选择器"></a>id 选择器</h2><p>ID选择器都类似于类选择符，但也有一些重要的区别：</p>
<p>1、为标签设置id&#x3D;”ID名称”，而不是class&#x3D;”类名称”。</p>
<p>2、ID选择符的前面是井号<strong>（#）</strong>号，而不是英文圆点<strong>（.）</strong>。</p>
<p><font color="red">id选择器只能用一次，每个元素只能有一个id，而类选择器可以有很多元素是同一个类，一个元素也可以同时属于多个类</font></p>
<h2 id="子选择器"><a href="#子选择器" class="headerlink" title="子选择器"></a>子选择器</h2><p>先写一个类，然后用大于符号<code>&gt;</code>指向类中的某个元素，对齐设置样式表：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.food</span>&gt;<span class="selector-tag">li</span>&#123;</span><br><span class="line">  <span class="attribute">border</span>:<span class="number">1px</span> red solid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>子选择器效果图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-4/44758217.jpg"></p>
<h2 id="包含后代的选择器"><a href="#包含后代的选择器" class="headerlink" title="包含后代的选择器"></a>包含后代的选择器</h2><p>把子选择器的<code>&gt;</code>符号换成空格，其与子选择器的主要区别是：包含后代的选择器会把子类中的所有符合条件的子类都改变，而子选择器只改变第一代后代，代码如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.food</span> <span class="selector-tag">li</span>&#123;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">1px</span> solid red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后代选择器效果图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-4/2102811.jpg"></p>
<h2 id="适配符"><a href="#适配符" class="headerlink" title="适配符"></a>适配符</h2><p>通用适配符：<code>*</code>，用于匹配任意样式</p>
<p>伪类适配符：<code>:hover</code>,它允许给html不存在的标签（标签的某种状态）设置样式，比如说我们给html中一个标签元素的鼠标滑过的状态来设置字体颜色:</p>
<p><code>a:hover&#123;color:red&#125;</code></p>
<p>分组选择符：<code>,</code>，同时为多个标签设置样式</p>
<h2 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h2><p>如果对某个父类标签设置了某种样式，其子标签也会自动继承这种样式，比如你为<code>&lt;p&gt;</code>标签设置了<code>color=red</code>，那么<code>&lt;p&gt;</code>标签包含的<code>&lt;span&gt;</code>标签也会自动继承这个颜色样式</p>
<h2 id="权重"><a href="#权重" class="headerlink" title="权重"></a>权重</h2><p>系统根据权重判断到底使用哪种样式，具体来说：继承权重为0.1，标签的权重为1，类选择符权重为10，id选择符权值为100</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">p</span>&#123;<span class="attribute">color</span>:red;&#125; <span class="comment">/*权值为1*/</span></span><br><span class="line"><span class="selector-tag">p</span> <span class="selector-tag">span</span>&#123;<span class="attribute">color</span>:green;&#125; <span class="comment">/*权值为1+1=2*/</span></span><br><span class="line"><span class="selector-class">.warning</span>&#123;<span class="attribute">color</span>:white;&#125; <span class="comment">/*权值为10*/</span></span><br><span class="line"><span class="selector-tag">p</span> <span class="selector-tag">span</span><span class="selector-class">.warning</span>&#123;<span class="attribute">color</span>:purple;&#125; <span class="comment">/*权值为1+1+10=12*/</span></span><br><span class="line"><span class="selector-id">#footer</span> <span class="selector-class">.note</span> <span class="selector-tag">p</span>&#123;<span class="attribute">color</span>:yellow;&#125; <span class="comment">/*权值为100+10+1=111*/</span></span><br></pre></td></tr></table></figure>

<p>如果遇到权重相同的情况：就近原则</p>
<p><strong>设置最高权重</strong>：在分号之前加入important<code>p.first&#123;color:green!important;&#125;</code>，注意<font color="red">后代选择器是空格，p.first中间不加空格（因为不是后代）,同理p#id也不加空格</font></p>
<h2 id="格式化排版"><a href="#格式化排版" class="headerlink" title="格式化排版"></a>格式化排版</h2><ul>
<li>设置字体：<code>font-family</code>属性</li>
<li>字号：<code>font-size:20px</code></li>
<li>颜色：<code>color:red</code></li>
<li>粗体：<code>font-weight：bold</code></li>
<li>斜体：<code>font-style:italic</code></li>
<li>下划线：<code>text-decoration：underline</code></li>
<li>删除线：<code>text-decoration：line-through</code></li>
<li>首行缩进：<code>text-indent：2em</code></li>
<li>行间距：<code>line-height：1.5em</code></li>
<li>字间距：<code>letter-spacing：50px</code></li>
<li>对齐方式：<code>text-align：center</code></li>
</ul>
<p>使用方式如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;!DOCTYPE <span class="selector-tag">HTML</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">html</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;style type=&quot;text/css&quot;&gt;</span><br><span class="line"><span class="selector-tag">body</span>&#123;</span><br><span class="line">  <span class="attribute">font-family</span>:<span class="string">&quot;微软雅黑&quot;</span>；</span><br><span class="line">  font-size:<span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>:red;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;/<span class="selector-tag">html</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="元素分类"><a href="#元素分类" class="headerlink" title="元素分类"></a>元素分类</h2><p>在讲解CSS布局之前，我们需要提前知道一些知识，在CSS中，html中的标签元素大体被分为三种不同的类型：<strong>块状元素</strong>、<strong>内联元素(又叫行内元素)<strong>和</strong>内联块状元素</strong>。</p>
<p><strong>常用的块状元素有：</strong></p>
<p><code>&lt;div&gt;、&lt;p&gt;、&lt;h1&gt;...&lt;h6&gt;、&lt;ol&gt;、&lt;ul&gt;、&lt;dl&gt;、&lt;table&gt;、&lt;address&gt;、&lt;blockquote&gt; 、&lt;form&gt;</code></p>
<p><strong>常用的内联元素有：</strong></p>
<p><code>&lt;a&gt;、&lt;span&gt;、&lt;br&gt;、&lt;i&gt;、&lt;em&gt;、&lt;strong&gt;、&lt;label&gt;、&lt;q&gt;、&lt;var&gt;、&lt;cite&gt;、&lt;code&gt;</code></p>
<p><strong>常用的</strong>内联块状元素有：</p>
<p><code>&lt;img&gt;、&lt;input&gt;</code></p>
<h3 id="块级元素"><a href="#块级元素" class="headerlink" title="块级元素"></a>块级元素</h3><p>什么是块级元素？在html中<code>&lt;div&gt;、 &lt;p&gt;、&lt;h1&gt;、&lt;form&gt;、&lt;ul&gt; 和 &lt;li&gt;</code>就是块级元素。设置<code>display:block</code>就是将元素显示为块级元素。如下代码就是将<strong>内联元素a</strong>转换为<strong>块状元素</strong>，从而使a元素具有<strong>块状元素</strong>特点。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">a&#123;display:block;&#125;</span><br></pre></td></tr></table></figure>

<p><strong>块级元素特点：</strong></p>
<p>1、每个块级元素都从新的一行开始，并且其后的元素也另起一行。（真霸道，一个块级元素独占一行）</p>
<p>2、元素的高度、宽度、行高以及顶和底边距都可设置。</p>
<p>3、元素<strong>宽度</strong>在不设置的情况下，是它本身父容器的100%（<strong>和父元素的宽度一致</strong>），除非设定一个宽度。</p>
<h3 id="内联元素"><a href="#内联元素" class="headerlink" title="内联元素"></a>内联元素</h3><p>在html中，<code>&lt;span&gt;、&lt;a&gt;、&lt;label&gt;、 &lt;strong&gt; 和&lt;em&gt;</code>就是典型的<strong>内联元素</strong>（<strong>行内元素</strong>）（inline）元素。当然<strong>块状元素</strong>也可以通过代码<code>display:inline</code>将元素设置为<strong>内联元素</strong>。如下代码就是将<strong>块状元素div</strong>转换为<strong>内联元素</strong>，从而使 div 元素具有<strong>内联元素</strong>特点。</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"> <span class="selector-tag">div</span>&#123;</span><br><span class="line">     <span class="attribute">display</span>:inline;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">&lt;<span class="selector-tag">div</span>&gt;我要变成内联元素&lt;/<span class="selector-tag">div</span>&gt;</span><br></pre></td></tr></table></figure>

<p><strong>内联元素特点：</strong></p>
<p>1、和其他元素都在一行上；</p>
<p>2、元素的高度、宽度及顶部和底部边距<strong>不可</strong>设置；</p>
<p>3、元素的宽度就是它包含的文字或图片的宽度，不可改变。</p>
<h3 id="内联块状"><a href="#内联块状" class="headerlink" title="内联块状"></a>内联块状</h3><p><strong>内联块状元素（</strong>inline-block<strong>）</strong>就是同时具备内联元素、块状元素的特点，代码<code>display:inline-block</code>就是将元素设置为内联块状元素。(css2.1新增)，<code>&lt;img&gt;、&lt;input&gt;</code>标签就是这种内联块状标签。</p>
<p>inline-block 元素特点：</p>
<p>1、和其他元素都在一行上；</p>
<p>2、元素的高度、宽度、行高以及顶和底边距都可设置。</p>
<h2 id="盒子模型"><a href="#盒子模型" class="headerlink" title="盒子模型"></a>盒子模型</h2><ul>
<li>盒子：<code>div</code></li>
<li>内容与盒子的距离：<code>padding</code>，一共四个方向，<code>padding-top</code>，<code>padding-bottom</code>，<code>padding-left</code>，<code>padding-right</code></li>
<li>盒子与另一个盒子的距离：<code>margin</code></li>
<li>盒子边框：<code>border</code></li>
</ul>
<h3 id="边框"><a href="#边框" class="headerlink" title="边框"></a>边框</h3><p>盒子模型的边框就是围绕着内容及补白的线，这条线你可以设置它的粗细、样式和颜色(边框三个属性)。</p>
<p>如下面代码为 div 来设置边框粗细为 2px、样式为实心的、颜色为红色的边框：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">2px</span>  dotted  red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面是 border 代码的缩写形式，可以分开写：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">border-width</span>:<span class="number">2px</span>;</span><br><span class="line">    <span class="attribute">border-style</span>:dotted;<span class="comment">/*虚线*/</span></span><br><span class="line">    <span class="attribute">border-color</span>:red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以单独为一边设置边框</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">border-bottom</span>:<span class="number">2px</span>  dotted  red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="宽度和高度"><a href="#宽度和高度" class="headerlink" title="宽度和高度"></a>宽度和高度</h3><p>宽度和高度分别使用<code>width</code>和<code>height</code>来表示</p>
<h3 id="填充"><a href="#填充" class="headerlink" title="填充"></a>填充</h3><p>元素与边框之间的距离用<code>padding</code>，其设置的顺序为：<strong>上，右，下，左</strong>(顺时针)</p>
<h2 id="CSS布局模型"><a href="#CSS布局模型" class="headerlink" title="CSS布局模型"></a>CSS布局模型</h2><p>CSS包含3种基本的布局模型，用英文概括为：Flow、Layer 和 Float。<br>在网页中，元素有三种布局模型：</p>
<ol>
<li>流动模型（Flow）</li>
<li>浮动模型 (Float)</li>
<li>层模型（Layer）</li>
</ol>
<h3 id="流动模型"><a href="#流动模型" class="headerlink" title="流动模型"></a>流动模型</h3><p>流动模型是默认的网页布局模式，2个典型特征：</p>
<ol>
<li><strong>块状元素</strong>都会在所处的<strong>包含元素内</strong>自上而下按顺序垂直延伸分布，因为在默认状态下，块状元素的宽度都为**100%**。实际上，块状元素都会以行的形式占据位置。如右侧代码编辑器中三个块状元素标签(div，h1，p)宽度显示为100%。</li>
<li>第二点，在流动模型下，<strong>内联元素</strong>都会在所处的包含元素内从左到右水平分布显示。（内联元素可不像块状元素这么霸道独占一行）</li>
</ol>
<p><strong>清除浮动</strong>：①clear：both ② width：100%，overflow：hidden</p>
<h3 id="浮动模型"><a href="#浮动模型" class="headerlink" title="浮动模型"></a>浮动模型</h3><p>块状元素这么霸道都是独占一行，如果现在我们想让两个块状元素并排显示，怎么办呢？不要着急，设置元素浮动就可以实现这一愿望。使用<code>float</code>属性设置浮动：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">2px</span> red solid;</span><br><span class="line">    <span class="attribute">float</span><span class="selector-pseudo">:left</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="selector-tag">div</span> id=&quot;div1&quot;&gt;&lt;/<span class="selector-tag">div</span>&gt;</span><br><span class="line">&lt;<span class="selector-tag">div</span> id=&quot;div2&quot;&gt;&lt;/<span class="selector-tag">div</span>&gt;</span><br></pre></td></tr></table></figure>

<h3 id="层模型"><a href="#层模型" class="headerlink" title="层模型"></a>层模型</h3><p>什么是层布局模型？层布局模型就像是图像软件PhotoShop中非常流行的图层编辑功能一样，每个图层能够精确定位操作。</p>
<p>CSS定义了一组定位（positioning）属性来支持层布局模型。层模型有三种形式：</p>
<p>1、<strong>绝对定位</strong>(position: absolute)<br>加入<code>position:absolute</code></p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>:<span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">200px</span>;</span><br><span class="line">    <span class="attribute">border</span>:<span class="number">2px</span> red solid;</span><br><span class="line">    <span class="attribute">position</span>:absolute;</span><br><span class="line">    <span class="attribute">left</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">top</span>:<span class="number">50px</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;<span class="selector-tag">div</span> id=&quot;div1&quot;&gt;&lt;/<span class="selector-tag">div</span>&gt;</span><br></pre></td></tr></table></figure>

<p>2、<strong>相对定位</strong>(position: relative)<br><strong>absolute表里如一，移动了就是移动了。relative只是表面显示移动了，但实际还在文档流中原有位置，别的元素无法占据。</strong>如果想为元素设置层模型中的相对定位，需要设置<code>position:relative</code>（表示相对定位），它通过left、right、top、bottom属性确定元素在<strong>正常文档流中</strong>的偏移位置</p>
<p>3、<strong>固定定位</strong>(position: fixed)<br>fixed：表示固定定位，与absolute定位类型类似，但它的相对移动的坐标是视图（<strong>屏幕内的网页窗口</strong>）本身。由于视图本身是固定的，<strong>它不会随浏览器窗口的滚动条滚动而变化</strong>，因此固定定位的元素会始终位于浏览器窗口内视图的某个位置，不会受文档流动影响，这与background-attachment:fixed;属性功能相同</p>
<h3 id="相对定位和绝对定位配合"><a href="#相对定位和绝对定位配合" class="headerlink" title="相对定位和绝对定位配合"></a>相对定位和绝对定位配合</h3><p>必须相对于父辈元素进行定位：在父辈元素加<code>position:relative</code>，需要进项相对的加<code>position:absolute</code></p>
<h2 id="盒模型代码简写"><a href="#盒模型代码简写" class="headerlink" title="盒模型代码简写"></a>盒模型代码简写</h2><p>通常有下面三种缩写方法:</p>
<p>1、如果top、right、bottom、left的值相同，如下面代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">margin:10px 10px 10px 10px;</span><br></pre></td></tr></table></figure>

<p>可缩写为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">margin:10px;</span><br></pre></td></tr></table></figure>

<p>2、如果top和bottom值相同、left和 right的值相同，如下面代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">margin:10px 20px 10px 20px;</span><br></pre></td></tr></table></figure>

<p>可缩写为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">margin:10px 20px;</span><br></pre></td></tr></table></figure>

<p>3、如果left和right的值相同，如下面代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">margin:10px 20px 30px 20px;</span><br></pre></td></tr></table></figure>

<p>可缩写为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">margin:10px 20px 30px;</span><br></pre></td></tr></table></figure>

<h3 id="颜色值缩写"><a href="#颜色值缩写" class="headerlink" title="颜色值缩写"></a>颜色值缩写</h3><p>关于颜色的css样式也是可以缩写的，当你设置的颜色是16进制的色彩值时，如果每两位的值相同，可以缩写一半。</p>
<p>例子1：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">p&#123;color:#000000;&#125;</span><br></pre></td></tr></table></figure>

<p>可以缩写为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">p&#123;color: #000;&#125;</span><br></pre></td></tr></table></figure>

<p>例子2：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">p&#123;color: #336699;&#125;</span><br></pre></td></tr></table></figure>

<p>可以缩写为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">p&#123;color: #369;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字体设置缩写"><a href="#字体设置缩写" class="headerlink" title="字体设置缩写"></a>字体设置缩写</h3><p>网页中的字体css样式代码也有他自己的缩写方式，下面是给网页设置字体的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">body&#123;</span><br><span class="line">    font-style:italic;</span><br><span class="line">    font-variant:small-caps; </span><br><span class="line">    font-weight:bold; </span><br><span class="line">    font-size:12px; </span><br><span class="line">    line-height:1.5em; </span><br><span class="line">    font-family:&quot;宋体&quot;,sans-serif;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这么多行的代码其实可以缩写为一句：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">body&#123;</span><br><span class="line">    font:italic  small-caps  bold  12px/1.5em  &quot;宋体&quot;,sans-serif;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：</p>
<p>1、使用这一简写方式你至少要指定 font-size 和 font-family 属性，其他的属性(如 font-weight、font-style、font-variant、line-height)如未指定将自动使用默认值。</p>
<p>2、在缩写时 font-size 与 line-height 中间要加入“&#x2F;”斜扛。</p>
<h3 id="颜色值"><a href="#颜色值" class="headerlink" title="颜色值"></a>颜色值</h3><p>颜色值有3中设置方式：</p>
<ol>
<li><p>英文命令颜色<br><code>p&#123;color:red;&#125;</code></p>
</li>
<li><p>RGB颜色</p>
<p><code>p&#123;color：RGB(133,45,200)</code></p>
</li>
<li><p>十六进制颜色</p>
<p><code>p&#123;color：#00ffff&#125;</code></p>
</li>
</ol>
<h3 id="长度值"><a href="#长度值" class="headerlink" title="长度值"></a>长度值</h3><ol>
<li>像素px</li>
<li>字体大小em：就是本元素的字体大小，比如字体大小为14px，那么em大小就位14px</li>
<li>百分比：<code>p&#123;font-size:12px;line-height:130%&#125;</code></li>
</ol>
<h2 id="CSS样式设置小技巧"><a href="#CSS样式设置小技巧" class="headerlink" title="CSS样式设置小技巧"></a>CSS样式设置小技巧</h2><h3 id="设置居中"><a href="#设置居中" class="headerlink" title="设置居中"></a>设置居中</h3><p><code>p&#123;text-align:center;&#125;</code></p>
<h3 id="定宽块状元素居中"><a href="#定宽块状元素居中" class="headerlink" title="定宽块状元素居中"></a>定宽块状元素居中</h3><p><code>div&#123;margn:20px auto;&#125;</code></p>
<p>不定宽度的块状元素有三种方法居中（这三种方法目前使用的都很多）：</p>
<ol>
<li>加入 <a href="http://www.imooc.com/code/292">table</a> 标签</li>
<li>设置 <a href="http://www.imooc.com/code/2049">display: inline</a> 方法：与第一种类似，显示类型设为 行内元素，进行不定宽元素的属性设置</li>
<li>设置 <a href="http://www.imooc.com/code/2074">position:relative</a> 和 left:50%：利用 相对定位 的方式，将元素向左偏移 50% ，即达到居中的目的<br>方法三：通过给父元素设置<a href="http://www.imooc.com/code/2071"> float</a>，然后给父元素设置 <a href="http://www.imooc.com/code/2074">position:relative</a> 和 left:50%，子元素设置 position:relative 和 left: -50% 来实现水平居中。</li>
</ol>
<h3 id="垂直居中"><a href="#垂直居中" class="headerlink" title="垂直居中"></a>垂直居中</h3><p>设置<code>height</code>和<code>line-height</code>值一样</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line"><span class="selector-class">.container</span>&#123;</span><br><span class="line">    <span class="attribute">height</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">line-height</span>:<span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">background</span>:<span class="number">#999</span>;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>



<p>父元素高度确定的多行文本、图片等的竖直居中的方法有两种：</p>
<ol>
<li>使用插入 <a href="http://www.imooc.com/code/292">table</a>  (包括tbody、tr、td)标签，同时设置 vertical-align：middle。</li>
<li>设置块级元素的 display 为 table-cell（设置为表格单元显示），激活 vertical-align 属性，但注意 IE6、7 并不支持这个样式, 兼容性比较差。</li>
</ol>
<h2 id="隐性改变display类型"><a href="#隐性改变display类型" class="headerlink" title="隐性改变display类型"></a>隐性改变display类型</h2><ol>
<li><a href="http://www.imooc.com/code/2073">position : absolute</a></li>
<li>float : left 或 <a href="http://www.imooc.com/code/2071">float:right</a></li>
</ol>
<p>简单来说，只要html代码中出现以上两句之一，元素的display显示类型就会自动变为以 <code>display:inline-block</code>（<a href="http://www.imooc.com/code/2048">块状元素</a>）的方式显示，当然就可以设置元素的 width 和 height 了，且默认宽度不占满父元素。</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>css</tag>
      </tags>
  </entry>
  <entry>
    <title>docker常用命令</title>
    <url>/2018/09/09/docker%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    <content><![CDATA[<p>从docker hub下载一个image</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker pull name:version</span><br></pre></td></tr></table></figure>

<p>运行一个docker，开启其bash</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -it ubuntu:18.04 bash</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>其中<code>-i</code>表示交互式，<code>-t</code>表示建立一个虚拟的terminal</p>
<p>继续运行一个已经退出的docker</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker start  `docker ps -q -l` <span class="comment"># restart it in the background</span></span><br><span class="line">docker attach `docker ps -q -l` <span class="comment"># reattach the terminal &amp; stdin</span></span><br></pre></td></tr></table></figure>

<h3 id="exec-命令"><a href="#exec-命令" class="headerlink" title="exec 命令"></a><code>exec</code> 命令</h3><h4 id="i-t-参数"><a href="#i-t-参数" class="headerlink" title="-i -t 参数"></a>-i -t 参数</h4><p><code>docker exec</code> 后边可以跟多个参数，这里主要说明 <code>-i</code> <code>-t</code> 参数。</p>
<p>只用 <code>-i</code> 参数时，由于没有分配伪终端，界面没有我们熟悉的 Linux 命令提示符，但命令执行结果仍然可以返回。</p>
<p>当 <code>-i</code> <code>-t</code> 参数一起使用时，则可以看到我们熟悉的 Linux 命令提示符。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ docker run -dit ubuntu</span><br><span class="line">69d137adef7a8a689cbcb059e94da5489d3cddd240ff675c640c8d96e84fe1f6</span><br><span class="line"></span><br><span class="line">$ docker container ls</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">69d137adef7a        ubuntu:latest       &quot;/bin/bash&quot;         18 seconds ago      Up 17 seconds                           zealous_swirles</span><br><span class="line"></span><br><span class="line">$ docker exec -i 69d1 bash</span><br><span class="line">ls</span><br><span class="line">bin</span><br><span class="line">boot</span><br><span class="line">dev</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ docker exec -it 69d1 bash</span><br><span class="line">root@69d137adef7a:/#</span><br></pre></td></tr></table></figure>

<p>如果从这个 stdin 中 exit，不会导致容器的停止。这就是为什么推荐大家使用 <code>docker exec</code> 的原因。</p>
<p>更多参数说明请使用 <code>docker exec --help</code> 查看。</p>
<h3 id="结束正在运行的docker"><a href="#结束正在运行的docker" class="headerlink" title="结束正在运行的docker"></a>结束正在运行的docker</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker container <span class="built_in">kill</span> `docker container <span class="built_in">ls</span> -q`</span><br></pre></td></tr></table></figure>

<h3 id="exec正在运行的docker"><a href="#exec正在运行的docker" class="headerlink" title="exec正在运行的docker"></a>exec正在运行的docker</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it `docker container <span class="built_in">ls</span> -q` bash</span><br></pre></td></tr></table></figure>

<h3 id="运行某个docker并添加端口映射"><a href="#运行某个docker并添加端口映射" class="headerlink" title="运行某个docker并添加端口映射"></a>运行某个docker并添加端口映射</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -itd -p 13389:3389 -p 10022:22 drawon/ubuntu-mate-xrdp</span><br></pre></td></tr></table></figure>

<p><strong>DOCKER 给运行中的容器添加映射端口</strong></p>
<p><strong>方法1</strong></p>
<p><strong>1、获得容器IP</strong></p>
<p>将container_name 换成实际环境中的容器名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker inspect `container_name` | grep IPAddress</span><br></pre></td></tr></table></figure>

<p><strong>2、 iptable转发端口</strong></p>
<p>将容器的8000端口映射到docker主机的8001端口</p>
<p>复制代码代码如下:</p>
<p>iptables -t nat -A  DOCKER -p tcp –dport 8001 -j DNAT –to-destination 172.17.0.19:8000</p>
<p><strong>方法2</strong></p>
<p>1.提交一个运行中的容器为镜像</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker commit containerid foo/live</span><br></pre></td></tr></table></figure>

<p>2.运行镜像并添加端口</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8000:80 foo/live /bin/bash</span><br></pre></td></tr></table></figure>

]]></content>
  </entry>
  <entry>
    <title>download-from-coursera-jupyter-notebook</title>
    <url>/2018/05/02/download-from-coursera-jupyter-notebook/</url>
    <content><![CDATA[<p>为了从coursera上面下载写过的jupyter notebook，可以在根目录下新建一个notebook，执行以下代码，然后生成一个currdir.tar的文件，下载这个文件即可</p>
<span id="more"></span>


<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> tarfile</span><br><span class="line">tarFileName=<span class="string">&#x27;currdir.tar&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RecursiveFiles</span>(<span class="params">dn=<span class="string">&#x27;.&#x27;</span>,ignoreTarFile=tarFileName</span>):</span><br><span class="line">    ignore=&#123;<span class="string">&#x27;.pynb_checkpoints&#x27;</span>,<span class="string">&#x27;pycache&#x27;</span>,ignoreTarFile&#125;</span><br><span class="line">    <span class="keyword">for</span> dirname,subdirs,files <span class="keyword">in</span> os.walk(dn):</span><br><span class="line">        <span class="keyword">if</span> os.path.basename(dirname) <span class="keyword">in</span> ignore: <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> fn <span class="keyword">in</span> files:</span><br><span class="line">            fname=os.path.join(dirname,fn)</span><br><span class="line">            <span class="keyword">yield</span>(fname)</span><br><span class="line">		<span class="comment">#return # 这个return在我的notebook中要注释掉，网上说有些情况下要不注释，因此需要尝试一下</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">makeTarFile</span>(<span class="params">dn=<span class="string">&#x27;.&#x27;</span>,tfn=tarFileName</span>):</span><br><span class="line">    tar=tarfile.<span class="built_in">open</span>(tfn,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> name <span class="keyword">in</span> RecursiveFiles(dn,tfn):</span><br><span class="line">        tar.add(name)</span><br><span class="line">    tar.close()</span><br><span class="line"></span><br><span class="line">makeTarFile()</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>coursera</tag>
      </tags>
  </entry>
  <entry>
    <title>flask快速入门</title>
    <url>/2017/07/15/flask%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>Flask是一个开源的易配置的web框架，基于Python进行书写</p>
<span id="more"></span>

<p>在<a href="http://docs.jinkan.org/docs/flask/quickstart.html#a-minimal-application">flask 快速入门中</a>，我们参照实例中的代码进行书写</p>
<ol>
<li><p><strong>首先我们建立一个app对象</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line">app = Flask(__name__)</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后我们就可以使用<code>app.route(&quot;/route&quot;)</code>这个装饰器书写每个页面的函数，如果需要在路由路径中使用变量，可以用<code>&lt;converter:parameter&gt;</code>的形式，用尖括号把变量扩起来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">root</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;root page&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hello&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello_world</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world page&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;username&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_name_page</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user name is %s&quot;</span>%username</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;int:user_id&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">user_id_page</span>(<span class="params">user_id</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user %d&quot;</span> % user_id</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>url重定向问题</strong><br>当访问一个地址<code>@app.route(&quot;/projects/&quot;)</code>的时候，当我们输入的地址<strong>没有斜杠时</strong>，浏览器会<strong>自动补全斜线</strong><br>当访问一个地址<code>@app.route(&quot;/project&quot;)</code>的时候，当我们输入的地址没有斜杠时可以正确到达要访问的地址，当输入的地址有斜杠时，会发生一个404 not found的错误</p>
</li>
<li><p><strong>构造URL</strong><br>既然我们可以自定义网页的路由地址，那么我们能否使用某个函数来自动生成一个复杂的地址呢？答案是肯定的，使用**<code>url_for()</code>**函数就可以构造复杂的路由地址。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;flasker&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/login&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/hello&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/user/&lt;username&gt;&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">profile</span>(<span class="params">username</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;user name is %s&quot;</span>%username</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> app.test_request_context():</span><br><span class="line">    <span class="built_in">print</span> url_for(<span class="string">&#x27;index&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> url_for(<span class="string">&#x27;login&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> url_for(<span class="string">&#x27;login&#x27;</span>, <span class="built_in">next</span>=<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> url_for(<span class="string">&#x27;profile&#x27;</span>,username=<span class="string">&#x27;John Doe&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里用到了<code>app.test_request_context()</code>方法，主要是用于在python shell中对flask代码进行调试，也就是不出现如下的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">* Debugger <span class="keyword">is</span> active!</span><br><span class="line">* Debugger pin code: <span class="number">197</span>-<span class="number">159</span>-<span class="number">436</span></span><br><span class="line">* Running on http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">5000</span>/ (Press CTRL+C to quit)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>HTTP方法</strong><br>   HTTP有多种访问url的方法，使用route装饰器传入methods参数可以改变访问方式</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method = <span class="string">&#x27;post&#x27;</span>:</span><br><span class="line">        do_the_login()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        show_the_login_form()</span><br></pre></td></tr></table></figure>

<blockquote>
<p>下面简单介绍一下http方法：</p>
<ul>
<li>GET：浏览器告知服务器：获取页面上的信息并发给我</li>
<li>HEAD：获取页面的HEAD信息并发给我</li>
<li>POST：浏览器告知服务项，想在url上面发布新信息。服务器保证数据已存储且只存储了一次，是html发送数据到服务器的方法</li>
<li>PUT：类似于post，但是存储过程触发了多次。这种请求允许浏览器与服务器之间的系统可以安全的第二次接受请求，而不破坏其他东西</li>
<li>DELETE：删除给定位置的信息</li>
<li>OPTIONS：给客户端提供一个迅速的方法弄清楚这个URL支持哪些http方法</li>
</ul>
</blockquote>
</li>
<li><p><strong>静态文件</strong><br>   即使是动态web也需要静态文件，通常是CSS和JavaScript文件。flask可以通过在包所在目录中新建一个名为<code>static</code>的文件夹，在应用中通过<code>/static</code>即可访问<br>   可以通过如下方法给静态文件生成URL，使用特殊的<code>static</code>端点名</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url_for(<span class="string">&#x27;static&#x27;</span>,filename=<span class="string">&#x27;style.css&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>   这个文件应该存储在文件系统中的<code>static/style.css</code> </p>
</li>
<li><p><strong>模板渲染</strong></p>
<p>   python配备了一个<code>jinja2</code>模块用于生成html文件<br>   可以使用flask包中的<code>render_template()</code>方法来渲染模板，方法如下：</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> render_template</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&#x27;</span></span>)</span></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/hello/&lt;username&gt;&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">name=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;hello.html&#x27;</span>,name=name)</span><br></pre></td></tr></table></figure>
<p>   此时flask会在templates文件夹下面查找<code>hello.html</code>文件</p>
</li>
<li><p><strong>请求对象</strong></p>
<p>   要获取http的访问方法，要用到flask里面的request库中的method方法</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line">    </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;PUT&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">	error = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">    	<span class="keyword">if</span> valid_login(request.form[<span class="string">&#x27;username&#x27;</span>],reuqest.form[<span class="string">&#x27;password&#x27;</span>]):</span><br><span class="line">        	<span class="keyword">return</span> log_the_user_in(request.form[<span class="string">&#x27;username&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">    	error = <span class="string">&#x27;invalid username/password&#x27;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>文件上传</strong></p>
<p>用flask上传文件，只需要在HTML表单中设置<code>enctype=&quot;mutipart/form-data&quot;</code>属性</p>
<p>已上传文件放在临时文件夹或者内存中，当然也可以通过<code>save（）</code>方法对其进行访问：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        f = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">        f.save(<span class="string">&#x27;/var/www/uploads/uploaded_file.txt&#x27;</span>)</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>如果你想知道文件上传之前的文件名是什么，你可以使用<code>filename</code>属性，不过这个属性可以伪造，因此并不值得信任，<code>secure_filename()</code>是值得信任的文件名获取函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"><span class="keyword">from</span> werkzeug <span class="keyword">import</span> secure_filename</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/upload&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>,<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">		f = request.files[<span class="string">&#x27;the_file&#x27;</span>]</span><br><span class="line">        f.save(<span class="string">&#x27;/var/www/uploads&#x27;</span> + secure_filename(f.filename))</span><br></pre></td></tr></table></figure>

<ol start="10">
<li><strong>Cookies</strong></li>
</ol>
<p>  如果在想访问网页中的cookies，可以使用<code>cookies</code>属性：</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> request</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    username = request.cookies.get(<span class="string">&#x27;username&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>  如果想要设置网页中的cookies，可以使用<code>set_cookie</code>对cookies进行存储</p>
  <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> make_response</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    resp = make_response(render_template(...))</span><br><span class="line">    resp.set_cookie(<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;the username&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>

<ol start="11">
<li><p><strong>重定向和错误</strong></p>
<p>可以使用<code>redirect</code>函数把用户重定向到另一个地方，用<code>abort</code>函数来放弃请求并返回错误代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> abort, redirect, url_for</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;login&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    abort(<span class="number">401</span>)</span><br><span class="line">    this_is never_executed()</span><br></pre></td></tr></table></figure>

<p>这个例子展现了从主页重定向到一个401页面的过程</p>
</li>
<li><p><strong>响应</strong><br>返回值应该是一个状态码，假如有如下视图：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">not_found</span>(<span class="params">error</span>):</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;error.html&#x27;</span>),<span class="number">404</span></span><br></pre></td></tr></table></figure>

<p>只需要把值传递给<code>make_response()</code>，获取结果对象并修改，然后再返回：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.errorhandler(<span class="params"><span class="number">404</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">not_found</span>(<span class="params">error</span>):</span><br><span class="line">	resp = make_response(render_template(<span class="string">&#x27;error.html&#x27;</span>),<span class="number">404</span>)</span><br><span class="line">    resp.headers[<span class="string">&#x27;x-something&#x27;</span>] = <span class="string">&#x27;a value&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> resp</span><br></pre></td></tr></table></figure>
</li>
<li><p>会话</p>
<p>除了请求对象以为，还有一个<code>session</code>对象，允许在不同请求间存储特定用户的信息。是基于cookies实现的，不过在cookies上面进行了密钥签证，用户可以查看你的cookies，但是如果不知道密钥的话是无法修改的</p>
<p>要使用<code>session</code>对象，需要设置一个密钥，方法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, session, redirect, url_for, flash, escape</span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">index</span>():</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;username&#x27;</span> <span class="keyword">in</span> session:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;log in as %s&#x27;</span> % escape(session[<span class="string">&#x27;username&#x27;</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;you are not logged in&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/login&#x27;</span>,methods=[<span class="string">&#x27;POST&#x27;</span>,<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>():</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        session[<span class="string">&#x27;username&#x27;</span>] = request.form[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;&#x27;&#x27;&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span></span><br><span class="line"><span class="string">              &lt;p&gt;&lt;input type=text name=username&gt;</span></span><br><span class="line"><span class="string">              &lt;p&gt;&lt;input type=submit value=login&gt;</span></span><br><span class="line"><span class="string">              &lt;/form&gt;</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/logout&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">logout</span>():</span><br><span class="line">    session.pop(<span class="string">&#x27;username&#x27;</span>,<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">return</span> redirect(url_for(<span class="string">&#x27;index&#x27;</span>))</span><br><span class="line"></span><br><span class="line">app.secret_key = os.urandom(<span class="number">24</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>消息闪现</strong><br>使用<code>flash()</code>可以闪现一条消息，要操作消息本身请使用<code>get_flashed_messages()</code></p>
</li>
<li><p><strong>日志记录</strong><br>flask有自带的日志记录系统，使用方法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app.logger.debug(<span class="string">&#x27;a value for debuging&#x27;</span>)</span><br><span class="line">app.logger.warning(<span class="string">&#x27;warning occurred&#x27;</span>,<span class="number">42</span>)</span><br><span class="line">app.logger.error(<span class="string">&#x27;an error occured&#x27;</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>整合wsgi中间件</strong><br>wsgi是指网络服务器网关接口，主要用于描述一个网页服务器如何与网页应用交互，使用方法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> werkzeug.contrib.fixers <span class="keyword">import</span> LighttpdCGIRootFix</span><br><span class="line">app.wsgi_app = LighttpdCGIRootFix(app.wsgi_app)</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>在自己主机上托管网页</strong><br>17.1 <strong>安装Apache</strong><br>首先安装apache（阿帕奇），这个软件主要是用于部署网页，下载方法如下：<br>①登录<a href="http://httpd.apache.org/download.cgi">apache下载网站</a>，找到如下的for windows的软件<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-23/17988963.jpg"></p>
<p>②选择下图中的任意一个第三方平台进行下载，会得到一个压缩包<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-23/7561754.jpg"></p>
</li>
</ol>
</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-23/10893416.jpg"></p>
<p>​	解压压缩包得到名为apache的文件夹，首先要修改<code>/Apache24/conf/htttpd.conf</code>，将其中<code>Define SRVROOT &quot;/Apache24&quot;</code>改为其现在的路径<code>Define SRVROOT &quot;D:/program files/Apache24&quot;</code>，</p>
<p>再把<code>Listen 80</code>改为<code>Listen 88</code>（因为80端口可能已经被占用）；</p>
<p><strong>然后</strong>，我们需要修改<code>/Apache24/conf/extra/thhpd-ssl.conf</code>以及<code>/Apache24/conf/extra/thhpd-ssl.conf</code>文件中的<code>Listen 443</code>改成<code>Listen 444</code>（因为443端口路被cmd占用）</p>
<p>​	通过cmd进入<code>Apache24/bin</code>，输入<code>httpd.exe -k install -n apache</code>，这条指令的意思就是安装httpd.exe程序为Windows服务，名称为apache，之后你就可以通过<code>ApacheMonitor.exe</code>直接打开或者关闭Apache。</p>
<p>​	③为了验证Apache是否安装成功，我们需要在打开Apache服务的时候，访问127.0.0.1，如果看到如下界面，表示安装成功：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-7-23/36787268.jpg"></p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>flask</tag>
      </tags>
  </entry>
  <entry>
    <title>git参与开源项目的方法</title>
    <url>/2019/11/14/git%E5%8F%82%E4%B8%8E%E5%BC%80%E6%BA%90%E9%A1%B9%E7%9B%AE%E7%9A%84%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>github上面有很多优秀的项目，如何参与其中的项目呢，其实github已经有了比较好的提示，经过搜索后总结如下。</p>
<span id="more"></span>

<ol>
<li><p>首先是要寻找优秀的开源项目，通过github tredings 或者 stars 可以找到最近比较热门的项目</p>
</li>
<li><p>找到项目之后，fork到自己的仓库，并且将fork后的项目clone到本地</p>
</li>
<li><p>为了保证fork后的仓库和主仓库保持同步，需要添加一个remote地址</p>
<p>先看看自己的本地地址有哪些：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote -v</span><br><span class="line">&gt; origin  https://github.com/YOUR_USERNAME/YOUR_FORK.git (fetch)</span><br><span class="line">&gt; origin  https://github.com/YOUR_USERNAME/YOUR_FORK.git (push)</span><br></pre></td></tr></table></figure>

<p>然后把原始项目的地址添加到remote当中，取名为upstream</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote add upstream https://github.com/ORIGINAL_OWNER/ORIGINAL_REPOSITORY.git</span><br></pre></td></tr></table></figure>

<p>最后确认一下是否添加成功</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git remote -v</span><br><span class="line">&gt; origin    https://github.com/YOUR_USERNAME/YOUR_FORK.git (fetch)</span><br><span class="line">&gt; origin    https://github.com/YOUR_USERNAME/YOUR_FORK.git (push)</span><br><span class="line">&gt; upstream  https://github.com/ORIGINAL_OWNER/ORIGINAL_REPOSITORY.git (fetch)</span><br><span class="line">&gt; upstream  https://github.com/ORIGINAL_OWNER/ORIGINAL_REPOSITORY.git (push)</span><br></pre></td></tr></table></figure>
</li>
<li><p>当你在本地项目对代码进行了大量修改后，为了与原项目代码同步，要fetch upstream</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git fetch upstream</span><br><span class="line">&gt; remote: Counting objects: 75, <span class="keyword">done</span>.</span><br><span class="line">&gt; remote: Compressing objects: 100% (53/53), <span class="keyword">done</span>.</span><br><span class="line">&gt; remote: Total 62 (delta 27), reused 44 (delta 9)</span><br><span class="line">&gt; Unpacking objects: 100% (62/62), <span class="keyword">done</span>.</span><br><span class="line">&gt; From https://github.com/ORIGINAL_OWNER/ORIGINAL_REPOSITORY&gt;  * [new branch]      master     -&gt; upstream/master</span><br></pre></td></tr></table></figure>

<p>然后切换到master分支</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git checkout dev</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Switched to branch <span class="string">&#x27;dev&#x27;</span></span></span><br></pre></td></tr></table></figure>

<p>最后合并两个分支</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git merge upstream/dev</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Updating a422352..5fdff0f</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Fast-forward</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"> README                    |    9 -------</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"> README.md                 |    7 ++++++</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"> 2 files changed, 7 insertions(+), 9 deletions(-)</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"> delete mode 100644 README</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash"> create mode 100644 README.md</span></span><br></pre></td></tr></table></figure>

<p>合并之后再push到自己的项目就行了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git push origin dev</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后在你的github项目中点pull request，就会提交到对方的邮件列表中，对方同意合并就合并成功了</p>
</li>
</ol>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>flink(blink)基础教程</title>
    <url>/2019/04/22/flink(blink)%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="安装-下载并开始使用Flink"><a href="#安装-下载并开始使用Flink" class="headerlink" title="安装: 下载并开始使用Flink"></a>安装: 下载并开始使用Flink</h2><p>Flink 可以运行在 Linux, Mac OS X和Windows上。为了运行Flink, 唯一的要求是必须在Java 7.x (或者更高版本)上安装。Windows 用户, 请查看 <a href="https://ci.apache.org/projects/flink/flink-docs-release-1.2/setup/flink_on_windows.html">Flink在Windows</a>上的安装指南。</p>
<span id="more"></span>

<p>你可以使用以下命令检查Java当前运行的版本：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java -version</span><br></pre></td></tr></table></figure>

<p>如果你有安装Java 8，命令行有如下回显</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">java version &quot;1.8.0_111&quot;</span><br><span class="line"></span><br><span class="line">Java(TM) SE Runtime Environment (build 1.8.0_111-b14)</span><br><span class="line"></span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)</span><br></pre></td></tr></table></figure>

<p>**下载和解压 ** </p>
<ol>
<li>从<a href="http://flink.apache.org/downloads.html">下载页</a>下载一个二进制的包，你可以选择任何你喜欢的Hadoop&#x2F;Scala组合包。如果你计划使用文件系统，那么可以使用任何Hadoop版本。</li>
<li>进入下载目录</li>
<li>解压下载的压缩包</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ cd ~/Downloads        # Go to download directory</span><br><span class="line">$ tar xzf flink-*.tgz   # Unpack the downloaded archive</span><br><span class="line">$ cd flink-1.2.0</span><br><span class="line">Start a Local Flink Cluster</span><br></pre></td></tr></table></figure>

<p><strong>MacOS X</strong></p>
<p>对于 MacOS X 用户, Flink 可以通过Homebrew 进行安装。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">~~~bash </span><br><span class="line">$ brew install apache-flink … </span><br><span class="line">$ flink –version </span><br><span class="line">Version: 1.2.0, Commit ID: 1c659cf ~~~</span><br></pre></td></tr></table></figure>

<p>使用maven可以直接常见一个flink项目</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mvn archetype:generate \</span><br><span class="line">    -DarchetypeGroupId=org.apache.flink \</span><br><span class="line">    -DarchetypeArtifactId=flink-quickstart-java \</span><br><span class="line">    -DarchetypeVersion=1.8.0 \</span><br><span class="line">    -DgroupId=wiki-edits \</span><br><span class="line">    -DartifactId=wiki-edits \</span><br><span class="line">    -Dversion=0.1 \</span><br><span class="line">    -Dpackage=wikiedits \</span><br><span class="line">    -DinteractiveMode=<span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>其中的groupId和ArtifactId可以按照自己的需要修改</p>
<p>建好的工程项目结构如下</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tree wiki-edits</span><br><span class="line">wiki-edits/</span><br><span class="line">├── pom.xml</span><br><span class="line">└── src</span><br><span class="line">    └── main</span><br><span class="line">        ├── java</span><br><span class="line">        │   └── wikiedits</span><br><span class="line">        │       ├── BatchJob.java</span><br><span class="line">        │       └── StreamingJob.java</span><br><span class="line">        └── resources</span><br><span class="line">            └── log4j.properties</span><br></pre></td></tr></table></figure>

<p>此时的pom.xml已经包含了flink的依赖，在java文件夹下有几个示例文件，可以将其删除，然后从0开始</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> wiki-edits/src/main/java/wikiedits/*.java</span><br></pre></td></tr></table></figure>

<p>最后我们需要在pom.xml中添加对维基百科的连接器，修改后的dependencies如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-connector-wikiedits_2.11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;flink.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用idea创建一个flink项目"><a href="#使用idea创建一个flink项目" class="headerlink" title="使用idea创建一个flink项目"></a>使用idea创建一个flink项目</h2><p>先用idea的maven创建一个scala项目</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190422204159.png"></p>
<p>在pom.xml中加入以下flink相关的依赖，记得保持Scala的版本和flink的版本相同，不然会报错</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Use this dependency if you are using the DataStream API --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-streaming-java_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Use this dependency if you are using the DataSet API --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.flink<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>flink-clients_2.10<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如果出现无法更新的状况，打开设置，勾选always update snapshots</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190423100503.png"></p>
<p>出现更新慢的情况，可以将maven的配置加入阿里云镜像</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时将sbt加入镜像，新建<code>~/.sbt/repositories</code>，修改其内容为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[repositories]</span><br><span class="line">local</span><br><span class="line">osc: http://maven.aliyun.com/nexus/content/groups/public</span><br><span class="line">typesafe: http://repo.typesafe.com/typesafe/ivy-releases/, [organization]/[module]/(scala_[scalaVersion]/)(sbt_[sbtVersion]/)[revision]/[type]s/[artifact](-[classifier]).[ext], bootOnly</span><br><span class="line">sonatype-oss-releases</span><br><span class="line">maven-central</span><br><span class="line">sonatype-oss-snapshots</span><br></pre></td></tr></table></figure>

<p>再次更新maven依赖即可</p>
<h2 id="编写一个flink程序"><a href="#编写一个flink程序" class="headerlink" title="编写一个flink程序"></a>编写一个flink程序</h2><p>导入刚才maven建立的项目，新建一个<code>src/main/java/wikiedits/WikipediaAnalysis.java</code>类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> wikiedits;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WikipediaAnalysis</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在程序还很基础，我们将一步一步填充程序内容。最后也将列出完整程序。</p>
<p>编写flink程序的第一步是要创建一个<code>StreamExecutionEnvironment</code>对象 (如果是批处理的话，建立<code>ExecutionEnvironment</code>对象)，这个对象将被用于设置执行参数，以及创建外部的数据输入源。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> <span class="variable">see</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br></pre></td></tr></table></figure>

<p>接下来我们创建一个源，从维基百科的IRC log读取数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataStream&lt;WikipediaEditEvent&gt; edits = see.addSource(<span class="keyword">new</span> <span class="title class_">WikipediaEditsSource</span>());</span><br></pre></td></tr></table></figure>

<p>至此我们创建了一个包含<code>WikipediaEditEvent</code>的<code>DataStream</code>对象，可以用于之后的处理。本例中，我们最重要挖掘的内容是，每个用户在特定窗口时间内添加或删除的字节数，比如五秒钟。因此，我们首先要将流在用户名上进行统计，也就是说对这个流的处理要讲用户名考虑在内。在这个例子中，特定时间内修改的字节数的和应该是对应到每个独立用户的。为了对某个数据流进行标记，我们要创建一个KeySelector，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">KeyedStream&lt;WikipediaEditEvent, String&gt; keyedEdits = edits</span><br><span class="line">    .keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;WikipediaEditEvent, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(WikipediaEditEvent event)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> event.getUser();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>上面的操作给我们提供了一个包含string key的WikipediaEditEvent，其key为用户名。</p>
<p>现在我们可以指定我们想要的windows size，并在这个数据流中计算我们想要的结果。在对无线数据流计算聚合结果的时候，窗口大小是一个必须的参数。在本例中，我们计算窗口大小为5s的聚合结果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; result = keyedEdits</span><br><span class="line">    .timeWindow(Time.seconds(<span class="number">5</span>))</span><br><span class="line">    .fold(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(<span class="string">&quot;&quot;</span>, <span class="number">0L</span>), <span class="keyword">new</span> <span class="title class_">FoldFunction</span>&lt;WikipediaEditEvent, Tuple2&lt;String, Long&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title function_">fold</span><span class="params">(Tuple2&lt;String, Long&gt; acc, WikipediaEditEvent event)</span> &#123;</span><br><span class="line">            acc.f0 = event.getUser();</span><br><span class="line">            acc.f1 += event.getByteDiff();</span><br><span class="line">            <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>第一个函数TimeWindow定义了一个大小为5s的，不重叠的时间窗口。第二个函数为每个特定的key，在每个窗口上指定了一个fold transformation。在该例中，初始值为(“”,0L)，并对其加上每个用户在时间窗口内，每次修改的byte difference。结果流Tuple2&lt;String, Long&gt;，包含了每个用户在每个时间窗口内的修改byte数量。</p>
<p>最后一件事情就是打印结果和开始执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">result.print();</span><br><span class="line"></span><br><span class="line">see.execute();</span><br></pre></td></tr></table></figure>

<p>完整程序如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> wikiedits;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FoldFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.functions.KeySelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.KeyedStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.windowing.time.Time;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.wikiedits.WikipediaEditEvent;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.connectors.wikiedits.WikipediaEditsSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WikipediaAnalysis</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">see</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    DataStream&lt;WikipediaEditEvent&gt; edits = see.addSource(<span class="keyword">new</span> <span class="title class_">WikipediaEditsSource</span>());</span><br><span class="line"></span><br><span class="line">    KeyedStream&lt;WikipediaEditEvent, String&gt; keyedEdits = edits</span><br><span class="line">      .keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;WikipediaEditEvent, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(WikipediaEditEvent event)</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> event.getUser();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    DataStream&lt;Tuple2&lt;String, Long&gt;&gt; result = keyedEdits</span><br><span class="line">      .timeWindow(Time.seconds(<span class="number">5</span>))</span><br><span class="line">      .fold(<span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;&gt;(<span class="string">&quot;&quot;</span>, <span class="number">0L</span>), <span class="keyword">new</span> <span class="title class_">FoldFunction</span>&lt;WikipediaEditEvent, Tuple2&lt;String, Long&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title function_">fold</span><span class="params">(Tuple2&lt;String, Long&gt; acc, WikipediaEditEvent event)</span> &#123;</span><br><span class="line">          acc.f0 = event.getUser();</span><br><span class="line">          acc.f1 += event.getByteDiff();</span><br><span class="line">          <span class="keyword">return</span> acc;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">    result.print();</span><br><span class="line"></span><br><span class="line">    see.execute();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Flink-API概念"><a href="#Flink-API概念" class="headerlink" title="Flink API概念"></a>Flink API概念</h2><p>Flink程序是实现分布式数据变换的常用程序（例如，filtering, mapping, updating state, joining, grouping, defining windows, aggregating）。 数据从source创建（例如，通过从文件，kafka topics或从本地的内存数据中读取）。结果通过sinks（接收器）返回，结果可以写入（分布式）文件或标准输出（例如，命令行终端）。 Flink程序可以在各种环境中运行，独立运行或嵌入其他程序中。 既可以在本地JVM中执行，也可以在多计算机的集群上执行。</p>
<p>根据数据源的类型，如有界（bounded）或无界（unbounded）源，您可以编写批处理(batch)程序或流处理(stream)程序，其中DataSet API用于批处理，DataStream API用于流式处理。 本指南将介绍两种API共有的基本概念。流式数据处理教程请参见<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/datastream_api.html">流式数据处理</a>，批处理教程请参加<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/batch/index.html">批处理</a>。</p>
<h3 id="DataSet和DataStream"><a href="#DataSet和DataStream" class="headerlink" title="DataSet和DataStream"></a>DataSet和DataStream</h3><p>Flink具有特殊类DataSet和DataStream来表示程序中的数据。 您可以将它们视为可以包含重复项的不可变数据集合。 在DataSet的情况下，数据是有限的，而对于DataStream，元素的数量可以是无限的。</p>
<p>这些集合在某些关键方面与常规Java集合不同。 首先，它们是不可变的，这意味着一旦创建它们就无法添加或删除元素。 你也不能简单地检查里面的元素。</p>
<p>通过在Flink程序中添加源来创建集合，并通过使用诸如map，filter等API方法对它们进行转换来从这些集合中派生新集合。</p>
<h3 id="Flink程序的剖析"><a href="#Flink程序的剖析" class="headerlink" title="Flink程序的剖析"></a>Flink程序的剖析</h3><p>Flink程序看起来像是转换数据集合的常规程序。 每个程序包含相同的基本部分：</p>
<ol>
<li>获得执行环境，Obtain an execution environment,</li>
<li>加载&#x2F;创建初始数据，Load&#x2F;create the initial data,</li>
<li>指定此数据的转换，Specify transformations on this data,</li>
<li>指定放置计算结果的位置，Specify where to put the results of your computations,</li>
<li>触发程序执行，Trigger the program execution</li>
</ol>
<p>我们现在将概述每个步骤，请参阅相应部分以获取更多详细信息。 请注意，Java DataSet API的所有核心类都可以在<a href="https://github.com/apache/flink/blob/master//flink-java/src/main/java/org/apache/flink/api/java">org.apache.flink.api.java</a>包中找到，而Java DataStream API的类可以在<a href="https://github.com/apache/flink/blob/master//flink-streaming-java/src/main/java/org/apache/flink/streaming/api">org.apache.flink.streaming.api</a>中找到。</p>
<p>StreamExecutionEnvironment是所有Flink程序的基础。 您可以在StreamExecutionEnvironment上使用这些静态方法获取一个StreamExecutionEnvironment实例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getExecutionEnvironment()</span><br><span class="line"></span><br><span class="line">createLocalEnvironment()</span><br><span class="line"></span><br><span class="line">createRemoteEnvironment(String host, <span class="type">int</span> port, String... jarFiles)</span><br></pre></td></tr></table></figure>

<p>通常，您只需要使用<code>getExecutionEnvironment()</code>，因为这将根据上下文执行正确的操作：如果您在IDE中执行程序或作为常规Java程序执行，它将创建一个本地环境，在你的本地机器执行程序。 如果您从程序中创建了一个JAR文件，并通过命令行调用它，则Flink集群管理器将执行您的main方法，同时<code>getExecutionEnvironment()</code>方法将返回一个执行环境，用于在集群上执行你的程序。</p>
<p>为了指定数据源，执行环境有几种方法可以从文件中读取数据：你可以逐行读，作为csv文监督，或者完全用一个你自定义的格式读取。为了读取一个text文件为一个序列，你可以用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">DataStream&lt;String&gt; text = env.readTextFile(<span class="string">&quot;file:///path/to/file&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这将为为你供一个DataStream，然后你可以对其应用transformation来创建新的派生DataStream。</p>
<p>您可以通过使用transformation函数，调用DataStream上的方法来应用转换。 例如，map函数转换如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataStream&lt;String&gt; input = ...;</span><br><span class="line"></span><br><span class="line">DataStream&lt;Integer&gt; parsed = input.map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;String, Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(String value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>这将原始集合中的每个String转换为Integer来创建新的DataStream。</p>
<p>一旦有了包含最终结果的DataStream，就可以通过创建接收器将其写入外部系统。下面是一个接收器sinks的示例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">writeAsText(String path)</span><br><span class="line"></span><br><span class="line">print()</span><br></pre></td></tr></table></figure>

<p>一旦指定了完整的程序，就需要通过调用<code>StreamExecutionEnvironment</code>上的<code>execute()</code>来触发程序执行。 根据ExecutionEnvironment的类型，决定在本地计算机上执行或提交程序在集群上执行。</p>
<p><code>execute()</code>方法返回一个<code>JobExecutionResult</code>，它包含执行次数和累计结果。</p>
<h3 id="懒惰执行"><a href="#懒惰执行" class="headerlink" title="懒惰执行"></a>懒惰执行</h3><p>所有Flink程序都是懒惰地执行：当执行程序的main方法时，数据加载和转换不会直接发生。 而是创建每个操作并将其添加到程序的计划中。 实际执行操作是在调用环境上的execute()方法后发生的，。 程序是在本地执行还是在集群上执行取决于执行环境的类型</p>
<p>懒惰的评估可以使构建Flink作为一个整体，添加各个单元以执行复杂的程序。</p>
<h3 id="指定keys"><a href="#指定keys" class="headerlink" title="指定keys"></a>指定keys</h3><p>某些数据变换（join，coGroup，keyBy，groupBy）要求在元素集合上定义keys。 其他转换（Reduce，GroupReduce，Aggregate，Windows）允许数据根据之前应用的key来分组。</p>
<p>A DataSet is grouped as：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataSet&lt;...&gt; input = <span class="comment">// [...]</span></span><br><span class="line">DataSet&lt;...&gt; reduced = input</span><br><span class="line">  .groupBy(<span class="comment">/*define key here*/</span>)</span><br><span class="line">  .reduceGroup(<span class="comment">/*do something*/</span>);</span><br></pre></td></tr></table></figure>

<p>Flink的数据模型不基于键值对。 因此，您无需将数据集类型物理打包到键和值中。 键是“虚拟的”：它们被定义为实际数据上的函数，以指导分组操作符。</p>
<p>注意：在下面的讨论中，我们将使用DataStream API和keyBy。 对于DataSet API，您只需要用DataSet和groupBy替换。</p>
<h3 id="为Tuple定义keys"><a href="#为Tuple定义keys" class="headerlink" title="为Tuple定义keys"></a>为Tuple定义keys</h3><p>最简单的情况是在元组的一个或多个字段上对元组进行分组：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Integer,String,Long&gt;&gt; input = <span class="comment">// [...]</span></span><br><span class="line">KeyedStream&lt;Tuple3&lt;Integer,String,Long&gt;,Tuple&gt; keyed = input.keyBy(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>元组在第一个字段（整数类型）上分组。</p>
<p>在这里，我们将元组分组在由第一个和第二个字段组成的复合键上。</p>
<p>关于嵌套元组的注释：如果你有一个带有嵌套元组的DataStream，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataStream&lt;Tuple3&lt;Tuple2&lt;Integer, Float&gt;,String,Long&gt;&gt; ds;</span><br></pre></td></tr></table></figure>

<p>指定<code>keyBy(0)</code>将使系统使用完整的Tuple2作为键（以Integer和Float为键）。 如果要“导航”到嵌套的Tuple2中，则必须使用下面解释的字段表达式键。</p>
<h3 id="用字段表达式定义keys"><a href="#用字段表达式定义keys" class="headerlink" title="用字段表达式定义keys"></a>用字段表达式定义keys</h3><p>您可以使用基于字符串的字段表达式来引用嵌套字段，并定义用于分组，排序，连接或coGrouping的键。</p>
<p>字段表达式可以非常轻松地选择（嵌套）复合类型中的字段，例如Tuple和POJO类型。</p>
<p>在下面的示例中，我们有一个WC POJO，其中包含两个字段“word”和“count”。 要按字段分组，我们只需将其名称传递给<code>keyBy()</code>函数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// some ordinary POJO (Plain old Java Object)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WC</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> String word;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> count;</span><br><span class="line">&#125;</span><br><span class="line">DataStream&lt;WC&gt; words = <span class="comment">// [...]</span></span><br><span class="line">DataStream&lt;WC&gt; wordCounts = words.keyBy(<span class="string">&quot;word&quot;</span>).window(<span class="comment">/*window specification*/</span>);</span><br></pre></td></tr></table></figure>

<p>字段表达式语法：</p>
<ul>
<li>按字段名称选择POJO字段。 例如，“user”指的是POJO类型的“user”字段。</li>
<li>按字段名称或0偏移字段索引选择元组字段。 例如，“f0”和“5”分别表示Java元组类型的第一和第六字段。</li>
<li>您可以在POJO和Tuples中选择嵌套字段。 例如，“user.zip”指的是POJO的“zip”字段，其存储在POJO类型的“user”字段中。 支持任意嵌套和混合POJO和元组，例如“f1.user.zip”或“user.f3.1.zip”。</li>
<li>您可以使用“*”通配符表达式选择完整类型。 这也适用于非Tuple或POJO类型的类型。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">WC</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> ComplexNestedClass complex; <span class="comment">//nested POJO</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> count;</span><br><span class="line">  <span class="comment">// getter / setter for private field (count)</span></span><br><span class="line">  <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCount</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.count = c;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ComplexNestedClass</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> Integer someNumber;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">float</span> someFloat;</span><br><span class="line">  <span class="keyword">public</span> Tuple3&lt;Long, Long, String&gt; word;</span><br><span class="line">  <span class="keyword">public</span> IntWritable hadoopCitizen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面展示了几个上面示例代码的有效字段表达式：</p>
<ol>
<li><p>“count”：WC类中的count字段。</p>
</li>
<li><p>“complex”：递归选择POJO类型ComplexNestedClass的字段复合体的所有字段。</p>
</li>
<li><p>“complex.word.f2”：选择嵌套Tuple3的最后一个字段。</p>
</li>
<li><p>“complex.hadoopCitizen”：选择Hadoop IntWritable类型。</p>
</li>
</ol>
<h3 id="用key-selector函数定义keys"><a href="#用key-selector函数定义keys" class="headerlink" title="用key selector函数定义keys"></a>用key selector函数定义keys</h3><p>定义keys的另一种方法是“key selector”函数。 key selector函数将单个元素作为输入，并返回元素的键。 keys可以是任何类型，并且可以从确定性计算中导出。</p>
<p>以下示例显示了一个key selector函数，它只返回一个对象的字段：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// some ordinary POJO</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WC</span> &#123;<span class="keyword">public</span> String word; <span class="keyword">public</span> <span class="type">int</span> count;&#125;</span><br><span class="line">DataStream&lt;WC&gt; words = <span class="comment">// [...]</span></span><br><span class="line">KeyedStream&lt;WC&gt; keyed = words</span><br><span class="line">  .keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;WC, String&gt;() &#123; <span class="comment">//WC是单个元素，string是返回的键类型</span></span><br><span class="line">     <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(WC wc)</span> &#123; <span class="keyword">return</span> wc.word; &#125;</span><br><span class="line">   &#125;);</span><br></pre></td></tr></table></figure>

<h3 id="指定transformation函数"><a href="#指定transformation函数" class="headerlink" title="指定transformation函数"></a>指定transformation函数</h3><p>大多数转换都需要用户定义的函数。 本节列出了如何指定它们的不同方法</p>
<h4 id="实现一个接口"><a href="#实现一个接口" class="headerlink" title="实现一个接口"></a>实现一个接口</h4><p>最基本的方法是实现一个提供的接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyMapFunction</span> <span class="keyword">implements</span> <span class="title class_">MapFunction</span>&lt;String, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(String value)</span> &#123; <span class="keyword">return</span> Integer.parseInt(value); &#125;</span><br><span class="line">&#125;;</span><br><span class="line">data.map(<span class="keyword">new</span> <span class="title class_">MyMapFunction</span>());</span><br></pre></td></tr></table></figure>

<h4 id="匿名类"><a href="#匿名类" class="headerlink" title="匿名类"></a>匿名类</h4><p>您可以将函数作为匿名类传递：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">data.map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;String, Integer&gt; () &#123;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(String value)</span> &#123; <span class="keyword">return</span> Integer.parseInt(value); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h4 id="Java-8-Lambdas表达式"><a href="#Java-8-Lambdas表达式" class="headerlink" title="Java 8 Lambdas表达式"></a>Java 8 Lambdas表达式</h4><p>Flink还支持Java API中的Java 8 Lambdas：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">data.filter(s -&gt; s.startsWith(<span class="string">&quot;http://&quot;</span>));</span><br><span class="line">data.reduce((i1,i2) -&gt; i1 + i2);</span><br></pre></td></tr></table></figure>

<h4 id="富函数-rich-functions"><a href="#富函数-rich-functions" class="headerlink" title="富函数(rich functions)"></a>富函数(rich functions)</h4><p>需要用户定义函数的所有变换，都可以将富函数作为参数。 例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyMapFunction</span> <span class="keyword">implements</span> <span class="title class_">MapFunction</span>&lt;String, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(String value)</span> &#123; <span class="keyword">return</span> Integer.parseInt(value); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>可以改写为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyMapFunction</span> <span class="keyword">extends</span> <span class="title class_">RichMapFunction</span>&lt;String, Integer&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(String value)</span> &#123; <span class="keyword">return</span> Integer.parseInt(value); &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>再把这个函数传给一个普通的map变换：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">data.map(<span class="keyword">new</span> <span class="title class_">MyMapFunction</span>());</span><br></pre></td></tr></table></figure>

<p>富函数也可以被定义为匿名类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">data.map (<span class="keyword">new</span> <span class="title class_">RichMapFunction</span>&lt;String, Integer&gt;() &#123;</span><br><span class="line">  <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(String value)</span> &#123; <span class="keyword">return</span> Integer.parseInt(value); &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>除了用户定义的函数（map，reduce等）之外，Rich函数还提供了四种方法：open，close，getRuntimeContext和setRuntimeContext。 这些对于将函数参数化有很大的用处（具体参考<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/batch/index.html#passing-parameters-to-functions">为函数传参</a>），创建和完成本地状态，访问<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/batch/index.html#broadcast-variables">广播变量</a>，以及访问运行时信息(比如<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/api_concepts.html#accumulators--counters">累计器和计数器</a>)，以及<a href="%5BIterations%5D(https://ci.apache.org/projects/flink/flink-docs-release-1.8/dev/batch/iterations.html)">迭代器</a>的信息。</p>
<h3 id="支持的数据类型"><a href="#支持的数据类型" class="headerlink" title="支持的数据类型"></a>支持的数据类型</h3><p>Flink对DataSet或DataStream中可以包含的元素类型设置了一些限制。 原因是系统需要对类型分析，以确定有效的执行策略。</p>
<p>flink支持六种不同类别的数据类型：</p>
<ol>
<li>Java元组和Scala案例类，Java Tuples and Scala Case Classes</li>
<li>Java POJOs</li>
<li>原始类型,Primitive Types</li>
<li>常规类,Regular Classes</li>
<li>值,Values</li>
<li>Hadoop Writables</li>
<li>特殊类型,Special Types</li>
</ol>
<h4 id="Tuples-and-Case-Classes"><a href="#Tuples-and-Case-Classes" class="headerlink" title="Tuples and Case Classes"></a>Tuples and Case Classes</h4><p>元组是包含固定数量的具有各种类型的字段的复合类型。 Java API提供从Tuple1到Tuple25的类。 元组的每个字段都可以是包含更多元组的任意Flink类型，从而产生嵌套元组。 可以使用字段名称tuple.f4直接访问元组的字段，也可以使用通用getter方法tuple.getField（int position）。 字段索引从0开始。请注意，这与Scala元组形成对比，但它与Java的一般索引更为一致。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Integer&gt;&gt; wordCounts = env.fromElements(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;String, Integer&gt;(<span class="string">&quot;hello&quot;</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Tuple2</span>&lt;String, Integer&gt;(<span class="string">&quot;world&quot;</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">wordCounts.map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;Tuple2&lt;String, Integer&gt;, Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">map</span><span class="params">(Tuple2&lt;String, Integer&gt; value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> value.f1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">wordCounts.keyBy(<span class="number">0</span>); <span class="comment">// also valid .keyBy(&quot;f0&quot;)</span></span><br></pre></td></tr></table></figure>

<h4 id="POJOs"><a href="#POJOs" class="headerlink" title="POJOs"></a>POJOs</h4><p>如果满足以下要求，则Flink将Java和Scala类视为特殊的POJO数据类型：</p>
<ol>
<li>这个类必须是public的</li>
<li>它必须有一个没有参数的public构造函数（默认构造函数）。</li>
<li>所有字段都是public的，或者可以通过getter和setter函数访问。 对于名为foo的字段，getter和setter方法必须命名为<code>getFoo()</code>和<code>setFoo()</code>。</li>
<li>Flink必须支持字段的类型。 目前，Flink使用Avro序列化任意对象（例如Date）。</li>
<li>Flink分析POJO类型的结构，即它了解POJO的字段。 因此，POJO类型比一般类型更容易使用。 此外，Flink可以比一般类型更有效地处理POJO。</li>
</ol>
<p>以下示例显示了一个包含两个public字段的简单POJO。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WordWithCount</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String word;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordWithCount</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordWithCount</span><span class="params">(String word, <span class="type">int</span> count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.word = word;</span><br><span class="line">        <span class="built_in">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream&lt;WordWithCount&gt; wordCounts = env.fromElements(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">WordWithCount</span>(<span class="string">&quot;hello&quot;</span>, <span class="number">1</span>),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">WordWithCount</span>(<span class="string">&quot;world&quot;</span>, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">wordCounts.keyBy(<span class="string">&quot;word&quot;</span>); <span class="comment">// key by field expression &quot;word&quot;</span></span><br></pre></td></tr></table></figure>

<h4 id="原始类型"><a href="#原始类型" class="headerlink" title="原始类型"></a>原始类型</h4><p>Flink支持所有Java和Scala原语类型，如Integer，String和Double。</p>
<h4 id="常规类"><a href="#常规类" class="headerlink" title="常规类"></a>常规类</h4><p>Flink支持大多数Java和Scala类（API和自定义）。 限制适用于包含无法序列化的字段的类，如文件指针，I&#x2F;O流或其他本机资源。 遵循Java Beans约定的类通常可以很好地工作。</p>
<p>所有未标识为POJO类型的类（请参阅上面的POJO要求）都由Flink作为常规类类型处理。 Flink将这些数据类型视为黑盒子，并且无法访问其内容（即，用于有效排序）。 使用序列化框架Kryo对常规类型进行反序列化。</p>
<h4 id="值"><a href="#值" class="headerlink" title="值"></a>值</h4><p>值类型手动描述其序列化和反序列化。它们不通过通用序列化框架进行序列化，而是通过使用读取和写入方法实现org.apache.flinktypes.Value接口来为这些操作提供自定义代码。当通用序列化方法效率非常低时，使用值类型是合理的。一个示例是将元素的稀疏向量实现为数组的数据类型。知道数组大部分为零，可以对非零元素使用特殊编码，而通用序列化只需编写所有数组元素。</p>
<p>org.apache.flinktypes.CopyableValue接口以类似的方式支持手动内部克隆逻辑。</p>
<p>Flink带有与基本数据类型对应的预定义值类型。 （ByteValue，ShortValue，IntValue，LongValue，FloatValue，DoubleValue，StringValue，CharValue，BooleanValue）。这些Value类型充当基本数据类型的可变变体：它们的值可以更改，允许程序员重用对象并减轻垃圾收集器的压力。</p>
<h3 id="类型擦除和类型推断"><a href="#类型擦除和类型推断" class="headerlink" title="类型擦除和类型推断"></a>类型擦除和类型推断</h3><p>注意：本节仅适用于Java。</p>
<p>Java编译器在编译后抛弃了大部分泛型类型信息。这在Java中称为类型擦除。这意味着在运行时，对象的实例不再知道其泛型类型。例如，<code>DataStream&lt;String&gt;</code>和<code>DataStream&lt;Long&gt;</code>的实例与JVM看起来相同。</p>
<p>Flink在准备执行程序时（当调用程序的主要方法时）需要类型信息。 Flink Java API尝试重建以各种方式丢弃的类型信息，并将其显式存储在数据集和运算符中。可以通过<code>DataStream.getType()</code>检索类型。该方法返回TypeInformation的一个实例，这是Flink表示类型的内部方式。</p>
<p>类型推断有其局限性，在某些情况下需要程序员的“合作”。这方面的示例是从集合创建数据集的方法，例如ExecutionEnvironment.fromCollection()，你可以在其中传递描述类型的参数。但是像<code>MapFunction &lt;I,O&gt;</code>这样的通用函数也可能需要额外的类型信息。</p>
<p>ResultTypeQueryable接口可以通过输入格式和函数实现，以明确告知API其返回类型。调用函数的输入类型通常可以通过先前操作的结果类型来推断。</p>
<h3 id="累计器和计数器"><a href="#累计器和计数器" class="headerlink" title="累计器和计数器"></a>累计器和计数器</h3><p>累加器是具有添加操作和最终累积结果的简单构造，可在任务结束后使用。</p>
<p>最直接的累加器是一个计数器：您可以使用Accumulator.add（V值）方法递增它。 在任务结束时，Flink将汇总（合并）所有部分结果并将结果发送给客户。 在调试过程中，或者如果您想快速了解有关数据的更多信息，累加器非常有用。</p>
<p>Flink目前有以下内置累加器。 它们中的每一个都实现了Accumulator接口。</p>
<ul>
<li><a href="https://github.com/apache/flink/blob/master//flink-core/src/main/java/org/apache/flink/api/common/accumulators/IntCounter.java">IntCounter</a>，<a href="https://github.com/apache/flink/blob/master//flink-core/src/main/java/org/apache/flink/api/common/accumulators/LongCounter.java">LongCounter</a>和<a href="https://github.com/apache/flink/blob/master//flink-core/src/main/java/org/apache/flink/api/common/accumulators/DoubleCounter.java">DoubleCounter</a>：请参阅下面的使用计数器的示例。</li>
<li><a href="https://github.com/apache/flink/blob/master//flink-core/src/main/java/org/apache/flink/api/common/accumulators/Histogram.java">直方图</a>：离散数量的区间的直方图实现。 在内部，它只是一个从Integer到Integer的映射。 您可以使用它来计算值的分布，例如 字数统计程序的每行字数分布。</li>
</ul>
<h4 id="如何使用累计器"><a href="#如何使用累计器" class="headerlink" title="如何使用累计器"></a>如何使用累计器</h4><p>首先，您必须在需要使用它的用户定义的转换函数中创建累加器对象（此处为计数器）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">IntCounter</span> <span class="variable">numLines</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntCounter</span>();</span><br></pre></td></tr></table></figure>

<p>其次，您必须注册累加器对象，通常在富函数的open（）方法中。 在这里您还可以定义名称。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getRuntimeContext().addAccumulator(<span class="string">&quot;num-lines&quot;</span>, <span class="built_in">this</span>.numLines);</span><br></pre></td></tr></table></figure>

<p>您现在可以在运算符函数中的任何位置使用累加器，包括<code>open()</code>和<code>close()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="built_in">this</span>.numLines.add(<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<p>整个结果将存储在JobExecutionResult对象中，该对象是从执行环境的execute()方法返回的（目前这仅在执行等待任务完成时才有效）。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">myJobExecutionResult.getAccumulatorResult(<span class="string">&quot;num-lines&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>所有累加器每个作业共享一个命名空间。 因此，您可以在任务的不同操作函数中使用相同的累加器。 Flink将在内部合并所有具有相同名称的累加器。</p>
<p>关于累加器和迭代的注释：目前累加器的结果仅在整个任务结束后才可用。 flink还计划在下一次迭代中使前一次迭代的结果可用。 您可以使用聚合器来计算每次迭代统计信息，并根据此类统计信息确定迭代的终止。</p>
<p>####自定义累加器</p>
<p>要实现自己的累加器，只需编写Accumulator接口的实现即可。 如果您认为您的自定义累加器应与Flink一共同使用，请随意创建pull请求。</p>
<p>您可以选择实现Accumulator或SimpleAccumulator。</p>
<p>累加器&lt;V，R&gt;最灵活：它为要添加的值定义类型V，为最终结果定义结果类型R. 例如。 对于直方图，V是数字，R是直方图。 SimpleAccumulator适用于两种类型相同的情况，例如计数器。</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>flink</tag>
        <tag>blink</tag>
      </tags>
  </entry>
  <entry>
    <title>git教程</title>
    <url>/2017/04/18/git%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="命令总结"><a href="#命令总结" class="headerlink" title="命令总结"></a>命令总结</h2><span id="more"></span>

<h3 id="本地git命令"><a href="#本地git命令" class="headerlink" title="本地git命令"></a>本地git命令</h3><p>感觉git常用的几个：add\commit\checkout\merge\reset\push\pull，其他的都没怎么用</p>
<p>git add filename</p>
<p>git commit -m “message”</p>
<h3 id="github命令"><a href="#github命令" class="headerlink" title="github命令"></a>github命令</h3><p><code>$ ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</code></p>
<h2 id="git-是什么"><a href="#git-是什么" class="headerlink" title="git 是什么"></a>git 是什么</h2><p>Git是目前世界上最先进的分布式版本控制系统，简而言之，可以用作回滚文件版本，把你在过程中的任何版本都保留下来。</p>
<h2 id="分布式和集中式的区别"><a href="#分布式和集中式的区别" class="headerlink" title="分布式和集中式的区别"></a>分布式和集中式的区别</h2><p>集中式：干活之前先从中央服务器获得文件的最新版本，干完活再推送给中央服务器，必须要联网（网速限制了其使用的效果）</p>
<p>分布式：每个人电脑上有一个完整的版本库，中央服务器只是用来交换大家的修改</p>
<h2 id="安装git"><a href="#安装git" class="headerlink" title="安装git"></a>安装git</h2><h3 id="Linux上安装git："><a href="#Linux上安装git：" class="headerlink" title="Linux上安装git："></a>Linux上安装git：</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git</span></span><br><span class="line"> The program &#x27;git&#x27; is currently not installed. You can install it by typing:</span><br><span class="line">sudo apt-get install git</span><br></pre></td></tr></table></figure>

<h3 id="Mac-OS-X上面安装git"><a href="#Mac-OS-X上面安装git" class="headerlink" title="Mac OS X上面安装git"></a>Mac OS X上面安装git</h3><p>Xcode里面自带了git，因此你只需要从App Store安装Xcode即可</p>
<h3 id="WINDOWS-安装git"><a href="#WINDOWS-安装git" class="headerlink" title="WINDOWS 安装git"></a>WINDOWS 安装git</h3><p>Windows下要使用很多Linux&#x2F;Unix的工具时，需要Cygwin这样的模拟环境，Git也一样。Cygwin的安装和配置都比较复杂，就不建议你折腾了。不过，有高人已经把模拟环境和Git都打包好了，名叫msysgit，只需要下载一个单独的exe安装程序，其他什么也不用装，绝对好用。</p>
<p>msysgit是Windows版的Git，从<a href="https://git-for-windows.github.io/">https://git-for-windows.github.io</a>下载（网速慢的同学请移步<a href="https://pan.baidu.com/s/1kU5OCOB#list/path=%2Fpub%2Fgit">国内镜像</a>），然后按默认选项安装即可。安装完成后，在开始菜单里找到“Git”-&gt;“Git Bash”，蹦出一个类似命令行窗口的东西，就说明Git安装成功！</p>
<p>安装完成之后，设置git的名字和email地址，用于在网络上区分用户</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global user.name <span class="string">&quot;Your Name&quot;</span></span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git config --global user.email <span class="string">&quot;email@example.com&quot;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="创建版本库"><a href="#创建版本库" class="headerlink" title="创建版本库"></a>创建版本库</h2><p>版本库又称为仓库，英文名为：repository，可以理解成一个目录，这个目录下任何文件的更改删除都能被git跟踪，任何时候都可以将其还原</p>
<h3 id="创建一个版本库"><a href="#创建一个版本库" class="headerlink" title="创建一个版本库"></a>创建一个版本库</h3><p>选择一个合适的地方创建一个空目录：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">mkdir</span> learngit</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> learngit</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">pwd</span></span></span><br><span class="line">/Users/michael/learngit</span><br></pre></td></tr></table></figure>

<p><font color=#ff0000>pwd</font>：用于显示当前所在目录的命令</p>
<p><font color=#ff0000>使用windows系统是，请确保文件路径中没有中文</font></p>
<p>初始化git<br>​&#96;&#96;&#96;shell<br>$ git init </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">此时你的文件夹中应该出现一个.git隐藏文件，如果要显示该隐藏文件，输入如下命令：</span><br><span class="line"></span><br><span class="line">​``` shell</span><br><span class="line">$ ls -a</span><br></pre></td></tr></table></figure>

<p>其中<font color="red">ls</font>的意思是list，列出</p>
<h2 id="把文件添加到版本库"><a href="#把文件添加到版本库" class="headerlink" title="把文件添加到版本库"></a>把文件添加到版本库</h2><p>首先这里再明确一下，所有的版本控制系统，其实只能跟踪文本文件的改动，比如TXT文件，网页，所有的程序代码等等，Git也不例外。版本控制系统可以告诉你每次的改动，比如在第5行加了一个单词“Linux”，在第8行删了一个单词“Windows”。而图片、视频这些二进制文件，虽然也能由版本控制系统管理，但没法跟踪文件的变化，只能把二进制文件每次改动串起来，<font color="red">也就是只知道图片从100KB改成了120KB，但到底改了啥，版本控制系统不知道</font>，也没法知道。同样，<font color="red">word的改动也不能被跟踪。</font></p>
<p>注意：不能用windows自带的记事本来编写文件，因为其UTF-8的标准有问题（在文本最前面加了一段十六进制字符）</p>
<p>现在我们先建立一个readme.txt 文件，内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Git is a version control system.</span><br><span class="line">Git is free software.</span><br></pre></td></tr></table></figure>

<h3 id="把一个文件放到git只需要两部"><a href="#把一个文件放到git只需要两部" class="headerlink" title="把一个文件放到git只需要两部"></a>把一个文件放到git只需要两部</h3><ol>
<li>用<font color="red"><code>git add</code></font>指令把文件添加到仓库<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add readme.txt</span></span><br></pre></td></tr></table></figure></li>
</ol>
<p>没有任何显示表示提交成功</p>
<ol start="2">
<li>用<font color="red"><code>git commit</code></font>指令告诉git，把文件提交到仓库</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;wrote a redme file&quot;</span></span></span><br><span class="line">[master (root-commit) cb926e7] wrote a readme file</span><br><span class="line"> 1 file changed, 2 insertions(+)</span><br><span class="line"> create mode 100644 readme.txt</span><br></pre></td></tr></table></figure>

<p>简单解释一下<code>git commit</code>命令，<code>-m</code>后面输入的是本次提交的说明，可以输入任意内容，当然最好是有意义的，这样你就能从历史记录里方便地找到改动记录</p>
<h2 id="查看文件的各个版本"><a href="#查看文件的各个版本" class="headerlink" title="查看文件的各个版本"></a>查看文件的各个版本</h2><p>我们现在修改readme.txt为如下内容:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Git is a distributed version control system.</span><br><span class="line">Git is free software.</span><br></pre></td></tr></table></figure>

<p>现在运行<code>git status</code>可以看到文件已经modified，但是还没有添加：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git status</span><br><span class="line"># On branch master</span><br><span class="line"># Changes not staged for commit:</span><br><span class="line">#   (use &quot;git add &lt;file&gt;...&quot; to update what will be committed)</span><br><span class="line">#   (use &quot;git checkout -- &lt;file&gt;...&quot; to discard changes in working directory)</span><br><span class="line">#</span><br><span class="line">#    modified:   readme.txt</span><br><span class="line">#</span><br><span class="line">no changes added to commit (use &quot;git add&quot; and/or &quot;git commit -a&quot;)</span><br></pre></td></tr></table></figure>

<p>接下来，我们使用<code>git diff</code>查看文件的具体变化：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git diff readme.txt </span><br><span class="line">diff --git a/readme.txt b/readme.txt</span><br><span class="line">index 46d49bf..9247db6 100644</span><br><span class="line">--- a/readme.txt</span><br><span class="line">+++ b/readme.txt</span><br><span class="line">@@ -1,2 +1,2 @@</span><br><span class="line">-Git is a version control system.</span><br><span class="line">+Git is a distributed version control system.</span><br><span class="line"> Git is free software.</span><br></pre></td></tr></table></figure>

<p>git diff 顾名思义就是 difference</p>
<p>接下来，我们将提交文件，<code>git add</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add readme.txt</span></span><br></pre></td></tr></table></figure>

<p>在执行<code>git commit</code>之前，我们先运行<code>git status</code>看看当前仓库状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">On branch master</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Changes to be committed:</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  (use <span class="string">&quot;git reset HEAD &lt;file&gt;...&quot;</span> to unstage)</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#       modified:   readme.txt</span></span></span><br><span class="line"><span class="meta prompt_">#</span></span><br></pre></td></tr></table></figure>

<p><code>git status</code>告诉我们，readme.txt文件将要被提交，接下来，我们是用<code>git commit</code>提交文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;add distributed&quot;</span></span></span><br><span class="line">[master ea34578] add distributed</span><br><span class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</span><br></pre></td></tr></table></figure>

<p>接下来，我们再用<code>git status</code>查看当前仓库的状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git status</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">On branch master</span></span><br><span class="line">nothing to commit (working directory clean)</span><br></pre></td></tr></table></figure>



<h2 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h2><p>现在已经学会了如何修改文件，那么我们再试着做一次，修改readme.txt文件内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Git is a distributed version control system.</span><br><span class="line">Git is free software distributed under the GPL.</span><br></pre></td></tr></table></figure>

<p>然后用<code>git status</code>查看git状态，然后用<code>git diff</code>查看修改的内容，最终用<code>git add</code>和<code>git commit</code>提交修改</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add readme.txt</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit -m <span class="string">&quot;append GPL&quot;</span></span></span><br><span class="line">[master 3628164] append GPL</span><br><span class="line"> 1 file changed, 1 insertion(+), 1 deletion(-)</span><br></pre></td></tr></table></figure>

<p>一旦出现错误，这样，我们就可以从最近的一个<code>commit</code>开始恢复</p>
<p>现在，我们回顾一下readme.txt文件一共有几个版本被提交到Git仓库里了：</p>
<p>版本1：wrote a readme file</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Git is a version control system.</span><br><span class="line">Git is free software.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>版本2：add distributed</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Git is a distributed version control system.</span><br><span class="line">Git is free software.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>版本3：append GPL</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Git is a distributed version control system.</span><br><span class="line">Git is free software distributed under the GPL.</span><br></pre></td></tr></table></figure>

<p>用<code>git log</code>命令，我们可以查看从最近到最远的提交日志，我们可以看到3次提交，最近的一次是<code>append GPL</code>，上一次是<code>add distributed</code>，最早的一次是<code>wrote a readme file</code>。如果嫌输出信息太多，看得眼花缭乱的，可以试试加上<code>--pretty=oneline</code>参数：</p>
<p>首先，Git必须知道当前版本是哪个版本，在Git中，用<code>HEAD</code>表示当前版本，也就是最新的提交<code>3628164...882e1e0</code>（注意我的提交ID和你的肯定不一样），上一个版本就是<code>HEAD^</code>，上上一个版本就是<code>HEAD^^</code>，当然往上100个版本写100个<code>^</code>比较容易数不过来，所以写成<code>HEAD~100</code>。</p>
<p>运行：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset --hard HEAD^</span></span><br><span class="line">HEAD is now at ea34578 add distributed</span><br></pre></td></tr></table></figure>

<p>hard指令的具体含义我们会在后面说明</p>
<p>此时看到，已经回到了上一个版本，但是我们会发现，最新的那个版本不见了。</p>
<p>为了找到最新的版本，我们应该向上找到那个版本号c82373d096fbc635b12d4cd，然后</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reset --hard c82373</span></span><br><span class="line">HEAD is now at c82373 add distributed</span><br></pre></td></tr></table></figure>

<p>版本号不用全部填写，只要写一部分就可以了</p>
<p>但是，如果我们已经关闭了串口怎么办，这个时候，我们就需要<code>git reflog</code>，找到之前的命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git reflog</span></span><br><span class="line">ea34578 HEAD@&#123;0&#125;: reset: moving to HEAD^</span><br><span class="line">3628164 HEAD@&#123;1&#125;: commit: append GPL</span><br><span class="line">ea34578 HEAD@&#123;2&#125;: commit: add distributed</span><br><span class="line">cb926e7 HEAD@&#123;3&#125;: commit (initial): wrote a readme file</span><br></pre></td></tr></table></figure>

<p>这样，我们看到第二行的id，我们就可以回滚了</p>
<h3 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h3><ul>
<li><code>HEAD</code>用来指定会退的版本，<code>git reset --hard commit_id</code>用来回退</li>
<li>可以用git log 查看历史版本</li>
<li>用git relog 查看历史命令，以回退历史版本</li>
</ul>
<h2 id="工作区和暂存区"><a href="#工作区和暂存区" class="headerlink" title="工作区和暂存区"></a>工作区和暂存区</h2><h3 id="工作区"><a href="#工作区" class="headerlink" title="工作区"></a>工作区</h3><p>工作区就是我们之前创建的git文件夹</p>
<h3 id="版本库"><a href="#版本库" class="headerlink" title="版本库"></a>版本库</h3><p>工作区当中有一个隐藏的<code>.git</code>文件，称为版本库，git版本库中保存了stage暂存区，和git自动创建的第一个分支<code>master</code>，以及指向<code>master</code>的一个指针叫<code>head</code></p>
<p><code>git add</code>命令实际上就是把要提交的所有修改放到暂存区（Stage），然后，执行<code>git commit</code>就可以一次性把暂存区的所有修改提交到分支。</p>
<p>Git管理的是修改，比如你的文件修改后-&gt;add-&gt;第二次修改-&gt;commit，那么此时系统中保留的是你第一次修改的内容，可以用<code>git diff HEAD -- readme.txt</code>命令查看当前Git中的文件和最新的文件的区别</p>
<h2 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h2><p>用命令<code>git reset HEAD file</code>可以把暂存区的修改撤销掉（unstage），重新放回工作区：</p>
<p>场景1：当你改乱了工作区某个文件的内容，想直接丢弃工作区的修改时，用命令<code>git checkout -- file</code>。</p>
<p>场景2：当你不但改乱了工作区某个文件的内容，还添加到了暂存区时，想丢弃修改，分两步，第一步用命令<code>git reset HEAD file</code>，就回到了场景1，第二步按场景1操作。</p>
<h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h2><p>一般情况下，你通常直接在文件管理器中把没用的文件删了，或者用<code>rm</code>命令删了：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ rm test.txt</span><br></pre></td></tr></table></figure>

<p>现在，你可以用<code>git rm test.txt</code>来删除git中的文件，要么你可以用<code>git checkout -- test.txt</code>来恢复文件</p>
<h2 id="使用github"><a href="#使用github" class="headerlink" title="使用github"></a>使用github</h2><p>第1步：创建SSH Key。在用户主目录下，看看有没有.ssh目录，如果有，再看看这个目录下有没有<code>id_rsa</code>和<code>id_rsa.pub</code>这两个文件，如果已经有了，可直接跳到下一步。如果没有，打开Shell（Windows下打开Git Bash），创建SSH Key：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ ssh-keygen -t rsa -C &quot;youremail@example.com&quot;</span><br></pre></td></tr></table></figure>

<p>如果一切顺利的话，可以在用户主目录里找到<code>.ssh</code>目录，里面有<code>id_rsa</code>和<code>id_rsa.pub</code>两个文件，这两个就是SSH Key的秘钥对，<code>id_rsa</code>是私钥，不能泄露出去，<code>id_rsa.pub</code>是公钥，可以放心地告诉任何人。</p>
<p>第2步：登陆GitHub，打开“Account settings”，“SSH Keys”页面：然后，</p>
<p>点“Add SSH Key”，填上任意Title，在Key文本框里粘贴<code>id_rsa.pub</code>文件的内容：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/githhubpage.png"></p>
<h2 id="添加远程库"><a href="#添加远程库" class="headerlink" title="添加远程库"></a>添加远程库</h2><p>首先，登陆GitHub，然后，在右上角找到“Create a new repo”按钮，创建一个新的仓库：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/new-repository.png"></p>
<p>在本地的<code>git</code>仓库下运行命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git remote add origin git@github.com:drawwon/learngit.git</span></span><br></pre></td></tr></table></figure>

<p>请千万注意，把上面的<code>drawwon</code>替换成你自己的GitHub账户名，否则，你在本地关联的就是我的远程库，关联没有问题，但是你以后推送是推不上去的，因为你的SSH Key公钥不在我的账户列表中。</p>
<p><font color="red">注意</font>：此时如果失败，可能是因为你创建库的时候添加了readme文件，那么本地文件就少一个readme.md，因此我们要先从远程pull下来才行，</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git pull origin master --allow-unrelated-histories</span><br></pre></td></tr></table></figure>

<p>最后的<code>--allow-unrelated-histories</code>：是因为github不允许两个没有建立连接的库进行通信</p>
<p>再次push</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push -u origin master</span></span><br></pre></td></tr></table></figure>

<p>-u：与远程库的master分支连接起来，在以后推送时简化命令</p>
<p>从现在开始，只需要在本地使用如下命令，即可push到github</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push origin master</span></span><br></pre></td></tr></table></figure>

<h3 id="命令小结"><a href="#命令小结" class="headerlink" title="命令小结"></a>命令小结</h3><p>要关联一个远程库，使用命令<code>git remote add origin git@github.com:drawwon/repo-name.git</code>；</p>
<p>关联后，使用命令<code>git push -u origin master</code>第一次推送master分支的所有内容；</p>
<p>此后，每次本地提交后，只要有必要，就可以使用命令<code>git push origin master</code>推送最新修改；</p>
<h2 id="从远程库克隆"><a href="#从远程库克隆" class="headerlink" title="从远程库克隆"></a>从远程库克隆</h2><p>要使用github开发最好的方式就是先在远程创建一个repository，勾选添加readme文件，然后<code>git clone</code>远程库</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git clone git@github.com:drawwon/learngit.git</span><br></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git clone https://github.com/drawwon/leargit.git</span><br></pre></td></tr></table></figure>

<p>但是通过原生git的方式最快</p>
<h2 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h2><h3 id="创建分支"><a href="#创建分支" class="headerlink" title="创建分支"></a>创建分支</h3><p>首先，我们传建一个dev分支，并切换到dev分支：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git checkout -b dev</span><br><span class="line">Switched to a new branch &#x27;dev&#x27;</span><br></pre></td></tr></table></figure>

<p><code>git checkout</code>命令加上<code>-b</code>参数表示创建并切换，相当于以下两条命令：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git branch dev</span><br><span class="line">$ git checkout dev</span><br><span class="line">Switched to branch &#x27;dev&#x27;</span><br></pre></td></tr></table></figure>

<p>我们修改readme.txt并提交：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ git add readme.txt </span><br><span class="line">$ git commit -m &quot;branch test&quot;</span><br><span class="line">[dev fec145a] branch test</span><br><span class="line"> 1 file changed, 1 insertion(+)</span><br></pre></td></tr></table></figure>

<p>先在切换回master分支：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git checkout master</span><br></pre></td></tr></table></figure>

<p>可以看到我们之前增加的内容不见了</p>
<p>现在，我们把dev分支的成果合并到master上面：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git merge &lt;name&gt;  #合并分支到当前分支上面</span><br></pre></td></tr></table></figure>

<p>如果需要有历史版本的merge，那么请使用–no-ff</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git merge --no-ff -m &quot;merge with no-ff&quot; dev </span><br></pre></td></tr></table></figure>



<h2 id="同步到github"><a href="#同步到github" class="headerlink" title="同步到github"></a>同步到github</h2><p><strong>接下来讲解一下如何将创建的工程同步到github上。</strong></p>
<ul>
<li>第一步：创建工程之后，用终端进入工程。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  cd /Users/hanwenguang/Desktop/pods/TestPreject</span><br></pre></td></tr></table></figure>

<ul>
<li>第二步：建立本地仓库</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git init</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步：将本地项目工作区的所有文件添加到暂存区</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git add .</span><br></pre></td></tr></table></figure>

<ul>
<li>第四步：将暂存区的文件提交到本地仓库</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git commit -m “注释&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>第五步： 在Github上创建自己的 New repository</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">与第一部分的1-4步骤相同。</span><br></pre></td></tr></table></figure>

<ul>
<li>第六步：将本地仓库关联到Github上（后加上仓库地址：第一部分中第五步的<em>地址</em>）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git remote add origin 地址</span><br></pre></td></tr></table></figure>

<ul>
<li>第七步：将代码由本地仓库上传到Github远程仓库，刷新即可看到上传成功。</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">//(不加这句可能报错出现错误的主要原因是github中的README.md文件不在本地代码目录中</span><br><span class="line">$  git pull --rebase origin master </span><br><span class="line">//可以通过该命令进行代码合并</span><br><span class="line">$  git push -u origin master</span><br><span class="line">//需要填写账号、密码时候，自己填写。通常一次通过之后就不需要了。</span><br></pre></td></tr></table></figure>

<p><strong>这样，上传文件存储和上传已有工程都已经成功。接下来下赠送提交代码的命令：</strong></p>
<ul>
<li>第一步： 查看目前代码的修改状态:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git status</span><br></pre></td></tr></table></figure>

<ul>
<li>第二步： 查看代码修改的内容</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git diff &lt;file&gt;</span><br><span class="line">    //如果该文件已暂存，那么应该使用</span><br><span class="line">$  git diff –cached &lt;file&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>第三步： 暂存需要提交的文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git add &lt;file&gt;</span><br><span class="line">    //如果是删除的文件则</span><br><span class="line">$  git rm &lt;file&gt;</span><br></pre></td></tr></table></figure>

<ul>
<li>第四步 ： 提交已暂存的文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$  git commit -m &quot;注释内容&quot;</span><br></pre></td></tr></table></figure>

<ul>
<li>第五步： 同步到服务器</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">同步到服务器前先需要将服务器代码同步到本地</span><br><span class="line">命令：$  git pull</span><br><span class="line">如果执行失败，就按照提示还原有冲突的文件，然后再次尝试同步。</span><br><span class="line">命令：$  git checkout – &lt;有冲突的文件路径&gt;</span><br><span class="line">同步到服务器</span><br><span class="line">命令：$  git push origin master</span><br></pre></td></tr></table></figure>

<p>参考</p>
<blockquote>
<p>作者：累了就回头_我在身后</p>
<p>链接：<a href="https://www.jianshu.com/p/6969de20cd52">https://www.jianshu.com/p/6969de20cd52</a></p>
</blockquote>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo升级</title>
    <url>/2018/06/05/hexo%E5%8D%87%E7%BA%A7/</url>
    <content><![CDATA[<p>其实所谓的升级，也很简单，先进入Blog的目录，看看到底有哪些需要更新的：</p>
<span id="more"></span>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm outdated</span><br><span class="line">Package                              Current  Wanted  Latest  Location</span><br><span class="line">hexo-deployer-git                      0.2.0   0.2.0   0.3.1  hexo-site</span><br><span class="line">hexo-generator-search                  1.0.4   1.0.4   2.2.1  hexo-site</span><br><span class="line">hexo-generator-seo-friendly-sitemap   0.0.19  0.0.19  0.0.21  hexo-site</span><br><span class="line">hexo-renderer-ejs                      0.2.0   0.2.0   0.3.1  hexo-site</span><br><span class="line">hexo-renderer-marked                  0.2.11  0.2.11   0.3.2  hexo-site</span><br><span class="line">hexo-server                            0.2.2   0.2.2   0.3.1  hexo-site</span><br></pre></td></tr></table></figure>

<p>嗯，还是有不少东西需要更新的，简单修改一下 <code>package.json</code> 文件：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo-site&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;private&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hexo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3.5.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hexo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.5.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-deployer-git&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.3.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-deployer-rsync&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.1.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-excerpt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.1.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-archive&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.1.5&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.1.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-feed&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.2.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-search&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.2.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-seo-friendly-sitemap&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.21&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-sitemap&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.1.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.2.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-renderer-ejs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.3.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-renderer-marked&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.3.2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-renderer-stylus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.3.3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.3.1&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>把 Hexo 的版本号从 <code>3.3.8</code> 修改为 <code>3.5.0</code>，其他的也根据情况更新一下。</p>
<p>都修改好了以后，就 npm 更新一下：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install --save</span><br></pre></td></tr></table></figure>

<p>搞掂，运行 Hexo 看看效果：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ hexo version</span><br><span class="line">hexo: 3.5.0</span><br><span class="line">hexo-cli: 1.0.4</span><br><span class="line">os: Darwin 17.4.0 darwin x64</span><br><span class="line">http_parser: 2.7.0</span><br><span class="line">node: 8.9.4</span><br><span class="line">v8: 6.1.534.50</span><br><span class="line">uv: 1.15.0</span><br><span class="line">zlib: 1.2.11</span><br><span class="line">ares: 1.10.1-DEV</span><br><span class="line">modules: 57</span><br><span class="line">nghttp2: 1.25.0</span><br><span class="line">openssl: 1.0.2n</span><br><span class="line">icu: 59.1</span><br><span class="line">unicode: 9.0</span><br><span class="line">cldr: 31.0.1</span><br><span class="line">tz: 2017b</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>hexo</category>
        <category>工具</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hexo设置图片大小</title>
    <url>/2019/01/07/hexo%E8%AE%BE%E7%BD%AE%E5%9B%BE%E7%89%87%E5%A4%A7%E5%B0%8F/</url>
    <content><![CDATA[<p>在hexo中一般插入图片的方式为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">!(图片名称)[图片地址]</span><br></pre></td></tr></table></figure>

<p>如果想要控制图片大小，可以用html的方式来插入图片</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;img src=&quot;图片地址&quot; width=&quot;50%&quot; height=&quot;50%&quot;  style=&quot;margin: 0 auto;&quot;/&gt;</span><br></pre></td></tr></table></figure>

<p>其中后面的<code>style=&quot;margin:0 auto;&quot;</code>用来控制图片的居中，图片大小有width和height控制，可以输入50%这样的比例，也可以直接输入大小200px这样的值</p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>hands on matchine learning</title>
    <url>/2017/12/05/hands-on-matchine-learning/</url>
    <content><![CDATA[<h2 id="机器学习分类"><a href="#机器学习分类" class="headerlink" title="机器学习分类"></a>机器学习分类</h2><span id="more"></span>

<ol>
<li>unsupervised learning</li>
</ol>
<ul>
<li><p>Clustering —k-Means</p>
<p>—Hierarchical Cluster Analysis (HCA)-层次聚类分析</p>
<p>​—Expectation Maximization </p>
</li>
<li><p>Visualization and dimensionality reduction 降维方法</p>
<p>—Principal Component Analysis (PCA)主成成分分析</p>
<p>—Kernel PCA </p>
<p>—Locally-Linear Embedding (LLE) 局部线性嵌入</p>
<p>—t-distributed Stochastic Neighbor Embedding (t-SNE)  t分布随机近邻嵌入</p>
</li>
<li><p>Association rule learning 关联规则挖掘</p>
<p>—Apriori 算法</p>
<p>—Eclat（大成功）</p>
</li>
</ul>
<ol start="2">
<li><p>Semisupervised learning（半监督学习）</p>
<p>大量无标签数据和少量标记数据</p>
<p>照片标记的时候</p>
</li>
<li><p>强化学习</p>
<p>奖励和惩罚机制</p>
</li>
<li><p>批学习和在线学习（batch learning and online learning）</p>
<p>从是否用新到来的数据进行学习来区分</p>
<ul>
<li>批学习每次把所有数据都放进去学习，如果数据集过大则不适用</li>
<li>在线学习：每次学习之后可以删除数据，占用计算资源也少<ul>
<li>学习率：接收新数据，以及遗忘旧数据的频率</li>
</ul>
</li>
</ul>
</li>
<li><p>基于实例的学习和基于模型的学习</p>
<ul>
<li>基于实例的学习：在邮件标记系统中，比较新邮件与已标记为垃圾邮件的相似度，由此来决定是否为垃圾邮件</li>
<li>基于模型的学习：先训练出模型（比如线性模型或者是多项式模型之类的），然后将新的数据输入模型得到结果</li>
</ul>
</li>
</ol>
<h2 id="机器学习问题解决思路"><a href="#机器学习问题解决思路" class="headerlink" title="机器学习问题解决思路"></a>机器学习问题解决思路</h2><h3 id="frame-the-problem"><a href="#frame-the-problem" class="headerlink" title="frame the problem"></a>frame the problem</h3><p>搞清楚真正的目标是什么。如何用结果去帮公司盈利之类的。</p>
<p>A sequence of data processing components is called a data pipeline.</p>
<p>data pipeline：一系列的数据处理组件被称为数据管道</p>
<p>随机排列数：np.random.permutation()</p>
<p>如果要固定随机的方式，可以在一开始使用np.random.seed(42)</p>
<p>train_test_split：把数据集按比例分成训练集和测试集</p>
<p>绘制带有colorbar的图，用圈的大小表示人口数量，用颜色表示放假的高低，红色最高，蓝色最低</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">housing.plot(kind=<span class="string">&quot;scatter&quot;</span>, x=<span class="string">&quot;longitude&quot;</span>, y=<span class="string">&quot;latitude&quot;</span>, alpha=<span class="number">0.4</span>,</span><br><span class="line">s=housing[<span class="string">&quot;population&quot;</span>]/<span class="number">100</span>, label=<span class="string">&quot;population&quot;</span>,</span><br><span class="line">c=<span class="string">&quot;median_house_value&quot;</span>, cmap=plt.get_cmap(<span class="string">&quot;jet&quot;</span>), colorbar=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line">plt.legend()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-12-7/30392919.jpg"></p>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>技术书籍</category>
      </categories>
      <tags>
        <tag>machine learning</tag>
      </tags>
  </entry>
  <entry>
    <title>jQuery教程</title>
    <url>/2017/07/09/jQuery%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="什么是jQuery"><a href="#什么是jQuery" class="headerlink" title="什么是jQuery"></a>什么是jQuery</h2><span id="more"></span>

<p>是一个JavaScript框架，或者说我们也可以把它称之为一个JavaScript库，里面封装了一些常用的JavaScript函数代码，其兼容性比较好，支持所有主流的浏览器。</p>
<h2 id="如何使用jQuery"><a href="#如何使用jQuery" class="headerlink" title="如何使用jQuery"></a>如何使用jQuery</h2><p>有两种方法可以引用jQuery代码，</p>
<ul>
<li>一是从官网上下载，和html文件放到同一个文件夹下，然后通过<code>&lt;script type = &quot;text/JavaScript&quot;, src = &quot;jquery-3.2.1.js&quot;&gt;&lt;/script&gt;</code></li>
<li>二是直接通过cdn的方式进行网页引用，<code>script type = &quot;text/JavaScript&quot;, src = “http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js&quot;</code>进行引用</li>
</ul>
<h2 id="使用jQuery写hello-world"><a href="#使用jQuery写hello-world" class="headerlink" title="使用jQuery写hello world"></a>使用jQuery写hello world</h2><p>$(document).ready()表示等网页上所有元素加载好之后再进行括号内的内容</p>
<p>$(“div”)表示寻找所有标签为div的元素</p>
<p>$(“div”).html()用于更改div的内容</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>第一个简单的jQuery程序<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">div</span>&#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">padding</span>:<span class="number">8px</span> <span class="number">0px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">font-size</span>:<span class="number">12px</span>;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">text-align</span>:center;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">border</span>:solid <span class="number">1px</span> <span class="number">#888</span>;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            $(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&quot;div&quot;</span>).<span class="title function_">html</span>(<span class="string">&quot;您好，通过慕课网学习jQuery才是最佳的途径。&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用jQuery获取元素对象"><a href="#使用jQuery获取元素对象" class="headerlink" title="使用jQuery获取元素对象"></a>使用jQuery获取元素对象</h2><p>通过<code>$</code>符号来进行对象获取，获取的对象是一个数组对象，比如文章中一共有三个<code>div</code>标签，那么<code>$(&quot;div&quot;)</code>获取到的是一个长度为3的数组，可以通过get方法转换成<code>DOM</code>对象，也可以直接用数组进行转换，方法如下：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> $div = $(<span class="string">&quot;div&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> div  = $div.<span class="title function_">get</span>(<span class="number">0</span>); <span class="comment">//或者var div = $div[0];</span></span><br></pre></td></tr></table></figure>

<p>将DOM对象转换为jQuery对象：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> div = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;div1&quot;</span>);</span><br><span class="line">$div = $(div);</span><br></pre></td></tr></table></figure>

<h2 id="jQuery的层级选择器"><a href="#jQuery的层级选择器" class="headerlink" title="jQuery的层级选择器"></a>jQuery的层级选择器</h2><p>一共有4种常用选择器如下：</p>
<ol>
<li>子选择器：<code>$(&quot;parent &gt; child&quot;)</code></li>
<li>后代选择器：<code>$(&quot;ancestor descendant&quot;)</code></li>
<li>相邻兄弟选择器：<code>$(&quot;prev + next&quot;)</code></li>
<li>一般兄弟选择器：<code>$(&quot;bro1 ~ bro2&quot;)</code></li>
</ol>
<h2 id="jQuery的一般筛选选择器"><a href="#jQuery的一般筛选选择器" class="headerlink" title="jQuery的一般筛选选择器"></a>jQuery的一般筛选选择器</h2><p>一共有12种常用筛选选择器，$(“:”)，美元符号加括号，引号，然后以冒号开头：</p>
<ol>
<li>$(“:eq(index)”)：选择等于给定索引的元素</li>
<li>$(“:lt(index)”)：选择小于给定索引的元素</li>
<li>$(“:gt(index)”)：选择大于给定索引的元素</li>
<li>$(“:odd”)：选择索引为奇数的元素</li>
<li>$(“:even”)：选择索引为偶数的元素</li>
<li>$(“:first”)：选择第一个元素</li>
<li>$(“:last”)：选择最后一个元素</li>
<li>$(“:animated”)：选择正在进行动画效果的元素</li>
<li>$(“:root”)：选择根元素</li>
<li>$(“lang(language)”)：选择指定语言的元素</li>
<li>$(“:header”)：选择标题元素</li>
<li>$(“not(selector)”)：选择除了不匹配给定的选择器元素</li>
</ol>
<h2 id="jQuery内容选择器"><a href="#jQuery内容选择器" class="headerlink" title="jQuery内容选择器"></a>jQuery内容选择器</h2><p>一共有四种常用的内容选择器：</p>
<ol>
<li><code>$(&quot;:contains(text)&quot;)</code>：选择含有指定文本内容的元素</li>
<li><code>$(&quot;:parent&quot;)</code>：选择所有含有子元素或者内容的元素</li>
<li><code>$(&quot;:has(selector)&quot;)</code>：选择符合选择器的元素</li>
<li><code>$(:empty)</code>：选择没有子元素的元素</li>
</ol>
<h2 id="jQuery可见性选择器"><a href="#jQuery可见性选择器" class="headerlink" title="jQuery可见性选择器"></a>jQuery可见性选择器</h2><p>有可见和不可见两种：</p>
<ol>
<li><code>$(&quot;:visible&quot;)</code>：显示所有可见元素</li>
<li>$(“:hidden”)：显示所有隐藏元素</li>
</ol>
<h2 id="jQuery属性选择器"><a href="#jQuery属性选择器" class="headerlink" title="jQuery属性选择器"></a>jQuery属性选择器</h2><p>属性选择器是判断属性与所给定值之间的关系，通常的形式是<code>$(&quot;[attribute=value]&quot;)</code>，有如下几种：</p>
<ol>
<li><code>$(&quot;[attribute|=value]&quot;)</code>：属性值等于所给值或者以所给值为前缀（在所给值最后加一个”-“）</li>
<li><code>$(&quot;[attribute=value]&quot;)</code>：属性值等于所给值</li>
<li><code>$(&quot;[attribute!=value]&quot;)</code>：属性值不等于所给值的元素</li>
<li><code>$(&quot;[attribute*=value]&quot;)</code>：属性值包含一个给定的子字符串的元素</li>
<li><code>$(&quot;[attribute~=value])&quot;</code>：以空格分隔的属性值中有一个给定值的元素</li>
<li><code>$(&quot;[attribute]&quot;)</code>：指定属性的元素</li>
<li><code>$(&quot;[attribute^=value]&quot;)</code>：以给定值为开始的元素</li>
<li><code>$(&quot;[attribute$=value]&quot;)</code>：以给定值为结束的元素</li>
<li><code>$(&quot;[attributeFilter1][attributeFilter2]&quot;)</code>：匹配所有属性选择器的元素</li>
</ol>
<h2 id="jQuery子元素选择器"><a href="#jQuery子元素选择器" class="headerlink" title="jQuery子元素选择器"></a>jQuery子元素选择器</h2><p>通常有如下5中子元素选择器：</p>
<ol>
<li><code>$(&quot;:first-child&quot;)</code>：选择第一个子元素</li>
<li><code>$(&quot;:last-child&quot;)</code>：选择最后一个子元素</li>
<li><code>$(&quot;:only-child&quot;)</code>：选择子元素为唯一元素的子元素</li>
<li><code>$（&quot;:nth-child&quot;）</code>：选择第n个子元素</li>
<li><code>$(&quot;:nth-last-child&quot;)</code>：选择父元素的第n个子元素，计数是从后到前的</li>
</ol>
<h2 id="jQuery表单元素选择器"><a href="#jQuery表单元素选择器" class="headerlink" title="jQuery表单元素选择器"></a>jQuery表单元素选择器</h2><p>表单选择器有如下10种：</p>
<ol>
<li><code>$(&quot;:input&quot;)</code>：选择所有的input,select,button和textarea元素</li>
<li><code>$(&quot;:text&quot;)</code>：选择所有文本框</li>
<li><code>$(&quot;:password&quot;)</code>：选择所有密码框</li>
<li><code>$(&quot;:radio&quot;)</code>：选择所有单选框</li>
<li><code>$(&quot;:checkbox&quot;)</code>：选择所有复选框</li>
<li><code>$(:submit)</code>：选择所有提交按钮</li>
<li><code>$(:image)</code>：选择所有图像域</li>
<li><code>$(&quot;:reset&quot;)</code>：匹配所有重置按钮</li>
<li><code>$(&quot;:button&quot;)</code>：匹配所有按钮</li>
<li><code>$(&quot;:file&quot;)</code>：匹配所有文件域</li>
</ol>
<h2 id="jQuery对象属性筛选选择器"><a href="#jQuery对象属性筛选选择器" class="headerlink" title="jQuery对象属性筛选选择器"></a>jQuery对象属性筛选选择器</h2><p>表单筛选选择器主要有一下4种：</p>
<ol>
<li><code>$(&quot;:enabled&quot;</code>：可用的表单元素</li>
<li><code>$(:disabled)</code>：选取不可用的表单元素</li>
<li><code>$(:checked)</code>：选取被选中的<code>&lt;input&gt;</code>元素</li>
<li><code>$(&quot;:selected&quot;)</code>：选取被选中的<code>&lt;option&gt;</code>元素</li>
</ol>
<p>添加点击事件的函数：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> p1 = <span class="title function_">getElementById</span>(<span class="string">&quot;p1&quot;</span>)</span><br><span class="line">p1.<span class="title function_">addEventListener</span>(<span class="string">&#x27;click&#x27;</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>编程</tag>
      </tags>
  </entry>
  <entry>
    <title>java反射</title>
    <url>/2020/06/08/java%E5%8F%8D%E5%B0%84/</url>
    <content><![CDATA[<p>java当中，除了基本类型外，其他都是class（interface），没有继承关系的数据类型是无法赋值的。本身class是一种数据类型（type）。</p>
<span id="more"></span>

<p>而class本身是在jvm执行过程中动态加载的，每加载一种class，JVM就为其创建一个Class类型的实例，并关联起来。</p>
<p>这里的<code>Class</code>类型是一个名叫<code>Class</code>的<code>class</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Class</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">Class</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以<code>String</code>类为例，当JVM加载<code>String</code>类的时候，它首先读取String.class文件到内存，然后为<code>String</code>类创建一个<code>Class</code>实例并关联起来。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Class</span>(String)</span><br></pre></td></tr></table></figure>

<p>查看<code>Class</code>源码时，可以发现Class的构造方法是private的，因此只有JVM能够创建<code>Class</code>实例。</p>
<p>所以，JVM持有的每个Class实例都指向一个数据类型。</p>
<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20200608172204.png" style="zoom:50%; margin-left:0px" />

<p>一个Class实例包含了该calss的所有完整信息。</p>
<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20200608172144.png" style="zoom:50%;margin-left:0px" />

<p>通过Class实例获取class信息的方法称为反射（Reflection）</p>
<p>有三个办法可以通过一个class获取对应的Class实例：</p>
<ol>
<li><p>通过class静态变量获取：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> String.class</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过实例变量的getClass()方法获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span><span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> s.getClass();</span><br></pre></td></tr></table></figure>
</li>
<li><p>知道一个class的完整类名，可以通过静态方法<code>Class.forName()</code>获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.String&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ol>
<p>因为<code>Class</code>实例在JVM当中是唯一的，因此上述三种方法获取的<code>Class</code>实例是同一个实例，可以用<code>==</code>比较。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls1</span> <span class="operator">=</span> String.class;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;abc&quot;</span>;</span><br><span class="line"><span class="type">Class</span> <span class="variable">cls2</span> <span class="operator">=</span> s.getClass();</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">sameClass</span> <span class="operator">=</span> cls1 == cls2; <span class="comment">// true</span></span><br></pre></td></tr></table></figure>

<p>注意Class实例比较和instanceof的区别：</p>
<ul>
<li><p><code>instanceof</code>是判断是否a是b的子类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Integer</span> <span class="variable">n</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">123</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b1</span> <span class="operator">=</span> n <span class="keyword">instanceof</span> Integer; <span class="comment">// true，因为n是Integer类型</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b2</span> <span class="operator">=</span> n <span class="keyword">instanceof</span> Number; <span class="comment">// true，因为n是Number类型的子类</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>==</code>判断的是是否是同一个class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="variable">b3</span> <span class="operator">=</span> n.getClass() == Integer.class; <span class="comment">// true，因为n.getClass()返回Integer.class</span></span><br><span class="line"><span class="type">boolean</span> <span class="variable">b4</span> <span class="operator">=</span> n.getClass() == Number.class; <span class="comment">// false，因为Integer.class!=Number.class</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>拿到某个对象的class后，就可以通过反射获取该<code>Object</code>的<code>class</code>信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon.reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Reflection</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        printClassInfo(<span class="string">&quot;&quot;</span>.getClass());</span><br><span class="line">        printClassInfo(Runnable.class);</span><br><span class="line">        printClassInfo(java.time.Month.class);</span><br><span class="line">        printClassInfo(String[].class);</span><br><span class="line">        printClassInfo(<span class="type">int</span>.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printClassInfo</span><span class="params">(Class cls)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Class name:&quot;</span> + cls.getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;Simple name: &quot;</span> + cls.getSimpleName());</span><br><span class="line">        <span class="keyword">if</span> (cls.getPackage() != <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Package name: &quot;</span> + cls.getPackage().getName());</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;is interface: &quot;</span> + cls.isInterface());</span><br><span class="line">        System.out.println(<span class="string">&quot;is enum: &quot;</span> + cls.isEnum());</span><br><span class="line">        System.out.println(<span class="string">&quot;is array: &quot;</span> + cls.isArray());</span><br><span class="line">        System.out.println(<span class="string">&quot;is primitive: &quot;</span> + cls.isPrimitive());</span><br><span class="line">        System.out.println(<span class="string">&quot;--------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：数组也是一种class（比如String[]），并且它不同于<code>String.class</code>，它的类名是<code>[Ljava.lang.String</code>。</p>
<p>如果获取到了一个Class实例，我们就可以通过该class实例来创建对应类型的实例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 获取String的Class实例:</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> String.class;</span><br><span class="line"><span class="comment">// 创建一个String实例:</span></span><br><span class="line"><span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> (String) cls.newInstance();</span><br></pre></td></tr></table></figure>

<p>上述代码等同于<code>new String()</code>。通过<code>newInstance（）</code>方法创建实例的局限是只能调用<code>public</code>的无参构造方法，带参数的活非<code>public</code>的构造方法都无法被<code>class.newInstance（）</code>方法调用</p>
<h4 id="动态加载"><a href="#动态加载" class="headerlink" title="动态加载"></a>动态加载</h4><p>JVM在执行java程序的时候，在需要用某个class时才对其进行加载。例如，Commons Logging总是优先使用Log4j，只有当Log4j不存在时，才使用JDK的logging。利用JVM动态加载特性，大致的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Commons Logging优先使用Log4j:</span></span><br><span class="line"><span class="type">LogFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (isClassPresent(<span class="string">&quot;org.apache.logging.log4j.Logger&quot;</span>)) &#123;</span><br><span class="line">    factory = createLog4j();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    factory = createJdkLog();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isClassPresent</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Class.forName(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就是为什么我们只需要把Log4j的jar包放到classpath中，Commons Logging就会自动使用Log4j的原因。</p>
<h3 id="访问字段"><a href="#访问字段" class="headerlink" title="访问字段"></a>访问字段</h3><p>通过获取某个Object的Class对象，就可以获取关于这个类的一切信息，</p>
<ul>
<li>Field getField(name)：根据字段名获取某个public的field（包括父类）</li>
<li>Field getDeclaredField(name)：根据字段名获取当前类的某个field（不包括父类）</li>
<li>Field[] getFields()：获取所有public的field（包括父类）</li>
<li>Field[] getDeclaredFields()：获取当前类的所有field（不包括父类）</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">stdClass</span> <span class="operator">=</span> Student.class;</span><br><span class="line">        <span class="comment">// 获取public字段&quot;score&quot;:</span></span><br><span class="line">        System.out.println(stdClass.getField(<span class="string">&quot;score&quot;</span>));</span><br><span class="line">        <span class="comment">// 获取继承的public字段&quot;name&quot;:</span></span><br><span class="line">        System.out.println(stdClass.getField(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        <span class="comment">// 获取private字段&quot;grade&quot;:</span></span><br><span class="line">        System.out.println(stdClass.getDeclaredField(<span class="string">&quot;grade&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> score;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> grade;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="获取字段值"><a href="#获取字段值" class="headerlink" title="获取字段值"></a>获取字段值</h4><p>利用反射拿到字段的一个<code>Field</code>实例只是第一步，我们还可以拿到一个实例对应的该字段的值。</p>
<p>例如，对于一个<code>Person</code>实例，我们可以先拿到<code>name</code>字段对应的<code>Field</code>，再获取这个实例的<code>name</code>字段的值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetFiled</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> p.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> f.get(p);</span><br><span class="line">        System.out.println(o);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取字段值的方法是：</p>
<ol>
<li>获取class</li>
<li>通过<code>getFiled()</code>函数获取field实例f</li>
<li>如果要获取的字段值是private的，需要先执行field.setAccessible(true);</li>
<li>通过field.get(object)获取字段值，返回类型为Object</li>
</ol>
<h4 id="设置字段值"><a href="#设置字段值" class="headerlink" title="设置字段值"></a>设置字段值</h4><p>除了获取字段值，还可以设置字段值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon.reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetFiled</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> p.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> cls.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        f.set(p,<span class="string">&quot;gugu&quot;</span>);</span><br><span class="line">        System.out.println(p.getName());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="调用方法"><a href="#调用方法" class="headerlink" title="调用方法"></a>调用方法</h3><p>除了<code>Field</code>对象，还可以通过class对象获取类的<code>Method</code></p>
<ul>
<li><code>Method getMethod(name, Class...)</code>：获取某个<code>public</code>的<code>Method</code>（包括父类）</li>
<li><code>Method getDeclaredMethod(name, Class...)</code>：获取当前类的某个<code>Method</code>（不包括父类）</li>
<li><code>Method[] getMethods()</code>：获取所有<code>public</code>的<code>Method</code>（包括父类）</li>
<li><code>Method[] getDeclaredMethods()</code>：获取当前类的所有<code>Method</code>（不包括父类）</li>
</ul>
<p>ps：所有public的属性和方法用getxxx()，所有private的方法用getDeclaredxxx()</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetMethod</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> p.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        System.out.println(method);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印出<code>public java.lang.String com.drawon.reflection.Person.getName()</code></p>
<p>method包含信息如下：</p>
<ul>
<li><code>getName()</code>：返回方法名称，例如：<code>&quot;getScore&quot;</code>；</li>
<li><code>getReturnType()</code>：返回方法返回值类型，也是一个Class实例，例如：<code>String.class</code>；</li>
<li><code>getParameterTypes()</code>：返回方法的参数类型，是一个Class数组，例如：<code>&#123;String.class, int.class&#125;</code>；</li>
<li><code>getModifiers()</code>：返回方法的修饰符，它是一个<code>int</code>，不同的bit表示不同的含义。</li>
</ul>
<h4 id="调用方法-1"><a href="#调用方法-1" class="headerlink" title="调用方法"></a>调用方法</h4><p>获取method之后，可以通过invoke来调用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetMethod</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;xiaoming&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> p.getClass();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method1</span> <span class="operator">=</span> cls.getMethod(<span class="string">&quot;getName&quot;</span>);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">method2</span> <span class="operator">=</span> cls.getMethod(<span class="string">&quot;getAge&quot;</span>, <span class="type">int</span>.class);</span><br><span class="line"></span><br><span class="line">        System.out.println(method1.invoke(p));</span><br><span class="line">        <span class="type">int</span> <span class="variable">age</span> <span class="operator">=</span> (<span class="type">int</span>) method2.invoke(p,<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="调用静态方法"><a href="#调用静态方法" class="headerlink" title="调用静态方法"></a>调用静态方法</h4><p>如果获取到的Method表示一个静态方法，调用静态方法时，由于无需指定实例对象，所以<code>invoke</code>方法传入的第一个参数永远为<code>null</code>。我们以<code>Integer.parseInt(String)</code>为例：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// reflection import java.lang.reflect.Method; </span><br><span class="line">public class Main &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        // 获取Integer.parseInt(String)方法，参数为String:</span><br><span class="line">        Method m = Integer.class.getMethod(&quot;parseInt&quot;, String.class);</span><br><span class="line">        // 调用该静态方法并获取结果:</span><br><span class="line">        Integer n = (Integer) m.invoke(null, &quot;12345&quot;);</span><br><span class="line">        // 打印调用结果:</span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="调用非public方法"><a href="#调用非public方法" class="headerlink" title="调用非public方法"></a>调用非public方法</h4><p>和Field类似，对于非public方法，我们虽然可以通过<code>Class.getDeclaredMethod()</code>获取该方法实例，但直接对其调用将得到一个<code>IllegalAccessException</code>。为了调用非public方法，我们通过<code>Method.setAccessible(true)</code>允许其调用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> p.getClass().getDeclaredMethod(<span class="string">&quot;setName&quot;</span>, String.class);</span><br><span class="line">        m.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        m.invoke(p, <span class="string">&quot;Bob&quot;</span>);</span><br><span class="line">        System.out.println(p.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h4><p>我们来考察这样一种情况：一个<code>Person</code>类定义了<code>hello()</code>方法，并且它的子类<code>Student</code>也覆写了<code>hello()</code>方法，那么，从<code>Person.class</code>获取的<code>Method</code>，作用于<code>Student</code>实例时，调用的方法到底是哪个？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取Person的hello方法:</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">h</span> <span class="operator">=</span> Person.class.getMethod(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="comment">// 对Student实例调用hello方法:</span></span><br><span class="line">        h.invoke(<span class="keyword">new</span> <span class="title class_">Student</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Person:hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Student:hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印结果为：<code>Student:hello</code></p>
<p>这表明在反射时，依旧遵守多态原则</p>
<h3 id="调用构造方法"><a href="#调用构造方法" class="headerlink" title="调用构造方法"></a>调用构造方法</h3><p>通常对象用<code>new</code>来创建</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br></pre></td></tr></table></figure>

<p>如果通过反射创建，可以调用<code>newInstance()</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> Person.class.newInstance();</span><br></pre></td></tr></table></figure>

<p>通过<code>newInstance()</code>新建对象的局限是只能调用该类的public无参构造方法</p>
<p>为了调用任意构造函数，反射提供了一个<code>Constructor</code>对象，包含构造方法的所有信息，<code>Constructor</code>和<code>Method</code>很像，只是Constructor调用的是构造方法，method使用invoke，constructor使用newinstance</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetConstructor</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Person.class;</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">cons</span> <span class="operator">=</span> cls.getConstructor(String.class);</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> (Person) cons.newInstance(<span class="string">&quot;kuku&quot;</span>);</span><br><span class="line">        System.out.println(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过class获取constructor的方法如下：</p>
<ul>
<li><code>getConstructor(Class...)</code>：获取某个<code>public</code>的<code>Constructor</code>；</li>
<li><code>getDeclaredConstructor(Class...)</code>：获取某个<code>Constructor</code>；</li>
<li><code>getConstructors()</code>：获取所有<code>public</code>的<code>Constructor</code>；</li>
<li><code>getDeclaredConstructors()</code>：获取所有<code>Constructor</code>。</li>
</ul>
<p>调用非<code>public</code>的<code>Constructor</code>时，必须首先通过<code>setAccessible(true)</code>设置允许访问。</p>
<h3 id="获取继承关系"><a href="#获取继承关系" class="headerlink" title="获取继承关系"></a>获取继承关系</h3><p>通过class实例的getSuperClass方法获取父类的class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">i</span> <span class="operator">=</span> Integer.class;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">n</span> <span class="operator">=</span> i.getSuperclass();</span><br><span class="line">        System.out.println(n);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">o</span> <span class="operator">=</span> n.getSuperclass();</span><br><span class="line">        System.out.println(o);</span><br><span class="line">        System.out.println(o.getSuperclass());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>打印结果为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">java</span>.lang.Number</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">java</span>.lang.Object</span><br><span class="line"><span class="literal">null</span></span><br></pre></td></tr></table></figure>

<p>表示integer的父类是Number，Number的父类是Object，Object的父类为null</p>
<h4 id="获取interface"><a href="#获取interface" class="headerlink" title="获取interface"></a>获取interface</h4><p>获取类实现的一个或多个接口，方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon.reflection;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetInterface</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Class[] interfaces = Integer.class.getInterfaces();</span><br><span class="line">        <span class="keyword">for</span> (Class i:interfaces)&#123;</span><br><span class="line">            System.out.println(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>发现Integer类实现了Comparable接口，打印结果如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">java</span>.lang.Comparable</span><br></pre></td></tr></table></figure>

<p>注意：<code>getInterfaces()</code>只返回当前类实现的接口，并不包含父类实现的接口。要找到父类实现的接口，需要用getSuperclass()方法。</p>
<p>但对interface使用getSuperClass得到的是null，获取接口的父接口需要用<code>getInterfaces()</code>，如果一个类没有实现任何接口，会返回null</p>
<h4 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a>继承关系</h4><p>判断是否属于某个类型，用<code>instanceof</code>来进行判断</p>
<p>如果两个class实例，判断是否能够向上转型，用<code>isAssignableFrom()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Integer i = ?</span></span><br><span class="line">Integer.class.isAssignableFrom(Integer.class); <span class="comment">// true，因为Integer可以赋值给Integer</span></span><br><span class="line"><span class="comment">// Number n = ?</span></span><br><span class="line">Number.class.isAssignableFrom(Integer.class); <span class="comment">// true，因为Integer可以赋值给Number</span></span><br><span class="line"><span class="comment">// Object o = ?</span></span><br><span class="line">Object.class.isAssignableFrom(Integer.class); <span class="comment">// true，因为Integer可以赋值给Object</span></span><br><span class="line"><span class="comment">// Integer i = ?</span></span><br><span class="line">Integer.class.isAssignableFrom(Number.class); <span class="comment">// false，因为Number不能赋值给Integer</span></span><br></pre></td></tr></table></figure>

<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>参考<a href="%5Bhttps://drawon.cn/2019/12/11/Spring-AOP%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/%5D(https://drawon.cn/2019/12/11/Spring-AOP%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%9C%BA%E5%88%B6/)">Spring AOP的实现机制</a></p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>java常用数据结构</title>
    <url>/2018/09/27/java%E5%B8%B8%E7%94%A8%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
    <content><![CDATA[<p>java.util包中三个重要的接口及特点：List（列表）、Set（保证集合中元素唯一）、Map（维护多个key-value键值对，保证key唯一）。其不同子类的实现各有差异，如是否同步（线程安全）、是否有序。</p>
<span id="more"></span>

<p>java常见数据结构：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-27/36575200.jpg"></p>
<p>java常见数据结构的主要方法</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-27/39355028.jpg"></p>
<p><strong>可根据实际情况来选择使用ArrayList（非同步、非频繁删除时选择）、Vector（需同步时选择）、LinkedList（频繁在任意位置插入、删除时选择）。</strong></p>
<h3 id="HashMap和Hashtable的区别"><a href="#HashMap和Hashtable的区别" class="headerlink" title="HashMap和Hashtable的区别"></a>HashMap和Hashtable的区别</h3><p> HashMap和Hashtable都实现了Map接口，但决定用哪一个之前先要弄清楚它们之间的分别。主要的区别有：线程安全性，同步(synchronization)，以及速度。</p>
<ol>
<li>HashMap几乎可以等价于Hashtable，除了HashMap是非synchronized的，并可以接受null(HashMap可以接受为null的键值(key)和值(value)，而Hashtable则不行)。</li>
<li>HashMap是非synchronized，而Hashtable是synchronized，这意味着Hashtable是线程安全的，多个线程可以共享一个Hashtable；而如果没有正确的同步的话，多个线程是不能共享HashMap的。Java 5提供了ConcurrentHashMap，它是HashTable的替代，比HashTable的扩展性更好。</li>
<li>另一个区别是HashMap的迭代器(Iterator)是fail-fast迭代器，而Hashtable的enumerator迭代器不是fail-fast的。所以当有其它线程改变了HashMap的结构（增加或者移除元素），将会抛出ConcurrentModificationException，但迭代器本身的remove()方法移除元素则不会抛出ConcurrentModificationException异常。但这并不是一个一定发生的行为，要看JVM。这条同样也是Enumeration和Iterator的区别。</li>
<li>由于Hashtable是线程安全的也是synchronized，所以在单线程环境下它比HashMap要慢。如果你不需要同步，只需要单一线程，那么使用HashMap性能要好过Hashtable。</li>
<li>HashMap不能保证随着时间的推移Map中的元素次序是不变的。</li>
</ol>
<h3 id="初始化方法"><a href="#初始化方法" class="headerlink" title="初始化方法"></a>初始化方法</h3><ol>
<li><p>list<br>初始化方法1：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; s = <span class="keyword">new</span> <span class="title class_">ArrayList</span>();</span><br><span class="line">s.add(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">s.add(<span class="string">&quot;b&quot;</span>);</span><br><span class="line">System.out.println(s.toString());</span><br></pre></td></tr></table></figure>

<p>初始化方法2：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; s = Arrays.asList(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">System.out.println(s.toString());</span><br></pre></td></tr></table></figure>
</li>
<li><p>Map</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;a&quot;</span>,<span class="string">&quot;b&quot;</span>);</span><br><span class="line">map.put(<span class="string">&quot;c&quot;</span>,<span class="string">&quot;d&quot;</span>);</span><br><span class="line">System.out.println(map.toString());</span><br><span class="line"><span class="comment">//输出格式为 &#123;a=b,c=d&#125;</span></span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>数据结构</tag>
      </tags>
  </entry>
  <entry>
    <title>jwt简介</title>
    <url>/2019/12/22/jwt%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<h3 id="什么是JWT"><a href="#什么是JWT" class="headerlink" title="什么是JWT"></a>什么是JWT</h3><p>jwt全称是JSON Web Tokens，是一个开放标准，它能够独立定义一个用json对象进行安全的多方信息传输，信息可以被验证和可信因为它拥有数字签名。jwt可以用加密算法(如HMAC)或者公钥私钥（RSA&#x2F;ECDSA）进行签名。</p>
<span id="more"></span>

<h3 id="JWT原理"><a href="#JWT原理" class="headerlink" title="JWT原理"></a>JWT原理</h3><p>传统的身份认证使用cookies或者session进行，用户向服务器发送账号密码，服务器验证后，在session中存储用户相关信息，服务端向客户端返回session_id，写入用户cookie；之后的每一次请求，用户都会通过cookie将session_id传回服务端，服务端收到session_id，验证是否存在于保存的数据中，以此验证用户身份。</p>
<p>这种方法存在弊端，就是扩展性问题。单机的时候没有问题，当使用服务器集群，每一台机器都要能够共享session数据。</p>
<p>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户，就像下面这样。</p>
<blockquote>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;姓名&quot;</span>: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">  <span class="string">&quot;角色&quot;</span>: <span class="string">&quot;管理员&quot;</span>,</span><br><span class="line">  <span class="string">&quot;到期时间&quot;</span>: <span class="string">&quot;2018年7月1日0点0分&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>以后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名（详见后文）。</p>
<p>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</p>
<h3 id="JWT数据结构"><a href="#JWT数据结构" class="headerlink" title="JWT数据结构"></a>JWT数据结构</h3><p>jwt一般来说是一个很长的字符串，由三部分组成，中间由(<code>.</code>)分隔：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">xxxxx.yyyyy.zzzzz</span><br></pre></td></tr></table></figure>

<p>JWT的三部分分别是：</p>
<ol>
<li>Header(头部)</li>
<li>Payload(负载)</li>
<li>Signature(签名)</li>
</ol>
<h4 id="1-Header"><a href="#1-Header" class="headerlink" title="1.Header"></a>1.Header</h4><p>header部分是一个json对象，描述JWT的元信息，一般来说包含两个部分，token的类型（一般来说是JWT）和签名算法，示意如下：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;alg&quot;</span><span class="punctuation">:</span> <span class="string">&quot;HS256&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;typ&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JWT&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>之后，这段json被Base64编码后，作为JWT的第一部分</p>
<h4 id="2-Payload"><a href="#2-Payload" class="headerlink" title="2. Payload"></a>2. Payload</h4><p>第二部分是payload，包含各种声明，包含三种声明：注册声明，公开声明，私有声明</p>
<ul>
<li>注册声明：包含以下七种</li>
</ul>
<p>iss (issuer)：签发人</p>
<p>exp (expiration time)：过期时间</p>
<p>sub (subject)：主题</p>
<p>aud (audience)：受众</p>
<p>nbf (Not Before)：生效时间</p>
<p>iat (Issued At)：签发时间</p>
<p>jti (JWT ID)：编号</p>
<ul>
<li><p>公开声明：可以在 <a href="https://www.iana.org/assignments/jwt/jwt.xhtml">IANA JSON Web Token Registry</a>中注册相关声明，以避免冲突</p>
</li>
<li><p>私有声明：订制的信息分享字段</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="string">&quot;name&quot;</span>: <span class="string">&quot;John Doe&quot;</span>,</span><br><span class="line">  <span class="string">&quot;admin&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>注意，JWT默认是不加密的，所有人都可以读到，因此不要将私密信息放在payload中</p>
<h4 id="3-Signature"><a href="#3-Signature" class="headerlink" title="3. Signature"></a>3. Signature</h4><p>创建签名，需要有编码过的header信息，payload信息和秘钥信息，以及特定的加密算法，如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + &quot;.&quot; +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>

<p>签名的目的是验证信息，保证信息不被更改，如果是用的公钥私钥的形式，还可以验证信息的发送方是否为生命的发送方</p>
<h3 id="JWT如何工作"><a href="#JWT如何工作" class="headerlink" title="JWT如何工作"></a>JWT如何工作</h3><p>在用户认证中，当用户成功登陆，服务端创建一个JSON Web Token并返回。当用户再次请求时，用户发送JWT信息，可以放在cookie中，不过这样无法跨域，放在头部的Authorization字段中，这样是可以跨域的</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jwt</tag>
      </tags>
  </entry>
  <entry>
    <title>kafka简介</title>
    <url>/2019/12/23/kafka%E7%AE%80%E4%BB%8B/</url>
    <content><![CDATA[<p>根据<a href="https://kafka.apache.org/intro">Kafka官网</a>的介绍，Kafka是一个分布式流平台，这个介绍的真正含义是什么呢？</p>
<p>流平台主要由三个关键的能力：</p>
<ol>
<li><p>发布和订阅记录流，类似于消息队列</p>
</li>
<li><p>以容错的方式持久化存储流数据</p>
</li>
<li><p>处理流式数据</p>
</li>
</ol>
<span id="more"></span>

<p>Kafka通常被用于两大类应用：</p>
<ol>
<li>建立实时数据管道，在各个系统或应用间可靠地获取数据</li>
<li>建立实时流失应用去传输或者是处理流式数据</li>
</ol>
<p>为了了解kafka是如何实现这些功能的，我们要从头到尾了解kafka的构成。</p>
<p>首先要了解一些概念：</p>
<ol>
<li>kafka是集群部署的，可以跨越多个数据中心</li>
<li>kafka集群按类存储流式数据，这些类别被称为topics</li>
<li>每一条数据由key，value和timestamp组成</li>
</ol>
<p>kafka主要有四类核心api：</p>
<ol>
<li>Producer API：允许应用发布流式数据到一个或多个kafka的topic上</li>
<li>Consumer API：允许应用订阅一个或多个topic，并处理其生成的数据流</li>
<li>Streams API：允许应用扮演流处理器的功能，从一个或多个topic中消费输入流，并产生一个输出流到一个或多个topic中，高效的将输入流转换为输出流</li>
<li>Connector API：允许建立和运行一个可复用的producer或consumer，将kafka的topics连接到已经存在的应用或数据系统中。比如，connector可以连接到一个关系型数据库，以监测数据库表的所有变化。</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191224104102.png"></p>
<p>kafka专用术语：</p>
<ul>
<li><p><strong>Broker</strong>：Kafka 集群包含一个或多个服务器，这种服务器被称为 broker。</p>
</li>
<li><p><strong>Topic</strong>：每条发布到 Kafka 集群的消息都有一个类别，这个类别被称为 Topic。（物理上不同 Topic 的消息分开存储，逻辑上一个 Topic 的消息虽然保存于一个或多个 broker 上，但用户只需指定消息的 Topic 即可生产或消费数据而不必关心数据存于何处）。</p>
</li>
<li><p><strong>Partition</strong>：Partition 是物理上的概念，每个 Topic 包含一个或多个 Partition。</p>
</li>
<li><p><strong>Producer</strong>：负责发布消息到 Kafka broker。</p>
</li>
<li><p><strong>Consumer</strong>：消息消费者，向 Kafka broker 读取消息的客户端。</p>
</li>
<li><p><strong>Consumer Group</strong>：每个 Consumer 属于一个特定的 Consumer Group（可为每个 Consumer 指定 group name，若不指定 group name 则属于默认的 group）。</p>
</li>
<li><p><strong>Partition offset：</strong>每条消息都有一个当前Partition下唯一的64字节的offset，它指明了这条消息的起始位置。</p>
</li>
<li><p><strong>Replicas of partition：</strong>副本是一个分区的备份。副本不会被消费者消费，副本只用于防止数据丢失，即消费者不从为follower的partition中消费数据，而是从为leader的partition中读取数据。</p>
</li>
<li><p><strong>Leader：</strong>每个partition有多个副本，其中有且仅有一个作为Leader，Leader是当前负责数据的读写的partition。</p>
</li>
<li><p><strong>Follower：</strong>Follower跟随Leader，所有写请求都通过Leader路由，数据变更会广播给所有Follower，Follower与Leader保持数据同步。如果Leader失效，则从Follower中选举出一个新的Leader。当Follower与Leader挂掉、卡住或者同步太慢，leader会把这个follower从“in sync replicas”（ISR）列表中删除，重新创建一个Follower。</p>
</li>
</ul>
<p>zookeeper的作用：</p>
<ul>
<li><strong>Zookeeper：</strong>Zookeeper负责维护和协调broker。当Kafka系统中新增了broker或者某个broker发生故障失效时，由ZooKeeper通知生产者和消费者。生产者和消费者依据Zookeeper的broker状态信息与broker协调数据的发布和订阅任务。</li>
</ul>
<h4 id="topics和logs"><a href="#topics和logs" class="headerlink" title="topics和logs"></a>topics和logs</h4><p>topic是消息发布的类别，在kafka中，topic总是有多个订阅者的，也就是说，可以有0个，1个或多个消费者去订阅写入的数据。</p>
<p>对于每一个topic，kafka集群保存一个分类log，如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191224105154.png"></p>
<p>每一个分类是一个有序的，不可数的记录序列，数据每次选择一个partion添加到最后。选择的partion号和在partion中的offset唯一定义了一条记录。</p>
<p>kafka集群会持久化消息数据，不管这条消息是否被消费。这个记录的周期是可以配置的，比如你设置为2天，那么一条消息被发布后，会持久化两天，然后被删除。</p>
<p>实际上，为每一个消费者存储的元数据只有消费的offeset，消费者可以控制offset的位置，比如跳过一些中间内容，直接消费最新的内容也是可以做到的。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191224105955.png"></p>
<h3 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h3><p>每一个partition有一个服务器扮演leader角色，有0个或多个服务器扮演follower角色。leader处理所有当前partion的读写请求，follower只是被动地复制leader，如果leader机宕机，剩下的follower中会自动产生新的leader。</p>
<h3 id="一个消费者订阅数据："><a href="#一个消费者订阅数据：" class="headerlink" title="一个消费者订阅数据："></a>一个消费者订阅数据：</h3><ul>
<li>生产者将数据发送到指定topic中</li>
<li>Kafka将数据以partition的方式存储到broker上。Kafka支持数据均衡，例如生产者生成了两条消息，topic有两个partition，那么Kafka将在两个partition上分别存储一条消息</li>
<li>消费者订阅指定topic的数据</li>
<li>当消费者订阅topic中消息时，Kafka将当前的offset发给消费者，同时将offset存储到Zookeeper中</li>
<li>消费者以特定的间隔（如100ms）向Kafka请求数据</li>
<li>当Kafka接收到生产者发送的数据时，Kafka将这些数据推送给消费者</li>
<li>消费者受到Kafka推送的数据，并进行处理</li>
<li>当消费者处理完该条消息后，消费者向Kafka broker发送一个该消息已被消费的反馈</li>
<li>当Kafka接到消费者的反馈后，Kafka更新offset包括Zookeeper中的offset。</li>
<li>以上过程一直重复，直到消费者停止请求数据</li>
<li>消费者可以重置offset，从而可以灵活消费存储在Kafka上的数据</li>
</ul>
<h3 id="消费者组数据消费流程"><a href="#消费者组数据消费流程" class="headerlink" title="消费者组数据消费流程"></a>消费者组数据消费流程</h3><p>Kafka支持消费者组内的多个消费者同时消费一个topic，一个消费者组由具有同一个Group ID的多个消费者组成。具体流程如下：</p>
<ul>
<li>生产者发送数据到指定的topic</li>
<li>Kafka将数据存储到broker上的partition中</li>
<li>假设现在有一个消费者订阅了一个topic，topic名字为“test”，消费者的Group ID为“Group1”</li>
<li>此时Kafka的处理方式与只有一个消费者的情况一样</li>
<li>当Kafka接收到一个同样Group ID为“Group1”、消费的topic同样为“test”的消费者的请求时，Kafka把数据操作模式切换为分享模式，此时数据将在两个消费者上共享。</li>
<li>当消费者的数目超过topic的partition数目时，后来的消费者将消费不到Kafka中的数据。因为在Kafka给每一个消费者消费者至少分配一个partition，一旦partition都被指派给消费者了，新来的消费者将不会再分配partition。即一个partition只能分配给一个消费者，一个消费者可以消费多个partition。</li>
</ul>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>kaggle-titanic实战--数据挖掘实例</title>
    <url>/2017/09/25/kaggle-titanic%E5%AE%9E%E6%88%98-%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<p>kaggle是一个国外的数据挖掘竞赛平台，大家做完竞赛之后会写一些指导，因此可以通过其他人写的指导文件进行学习，<a href="https://www.kaggle.com/">kaggle传送门</a>。</p>
<p>其中有一个入门类的分析问题是分析Titanic号的救援问题，分析哪些因素会影响到是否被救援，首先打开Titanic这个问题的具体页面，<a href="https://www.kaggle.com/c/titanic">Titanic: Machine Learning from Disaster</a>,</p>
<span id="more"></span>![](https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-25/69961399.jpg)

<!--more-->
<p>先看一看overview里面的description和evaluation，看看问题背景和最终需要预测的内容，然后点击数据，下载三个csv格式的数据集，第一个<code>train.csv</code>是训练集，第二个<code>test.csv</code>是测试集，第三个<code>gender_submission.csv</code>是验证集，</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-25/35388132.jpg"></p>
<p>下载好之后打开pycharm，新建名为Titanic的工程，新建Titanic.py开始进行分析</p>
<p>首先，导入需要用到的包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplot.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">from</span> pandas <span class="keyword">import</span> DataFrame,Series</span><br></pre></td></tr></table></figure>

<p>接下来导入数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train_data = pd.read_csv(<span class="string">&#x27;train.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>查看数据的信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train_data.info()</span><br></pre></td></tr></table></figure>

<p>得到的数据信息如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;<span class="keyword">class</span> <span class="string">&#x27;pandas.core.frame.DataFrame&#x27;</span>&gt;</span><br><span class="line">RangeIndex: <span class="number">891</span> entries, <span class="number">0</span> to <span class="number">890</span></span><br><span class="line">Data columns (total <span class="number">12</span> columns):</span><br><span class="line">PassengerId    <span class="number">891</span> non-null int64</span><br><span class="line">Survived       <span class="number">891</span> non-null int64</span><br><span class="line">Pclass         <span class="number">891</span> non-null int64</span><br><span class="line">Name           <span class="number">891</span> non-null <span class="built_in">object</span></span><br><span class="line">Sex            <span class="number">891</span> non-null <span class="built_in">object</span></span><br><span class="line">Age            <span class="number">714</span> non-null float64</span><br><span class="line">SibSp          <span class="number">891</span> non-null int64</span><br><span class="line">Parch          <span class="number">891</span> non-null int64</span><br><span class="line">Ticket         <span class="number">891</span> non-null <span class="built_in">object</span></span><br><span class="line">Fare           <span class="number">891</span> non-null float64</span><br><span class="line">Cabin          <span class="number">204</span> non-null <span class="built_in">object</span></span><br><span class="line">Embarked       <span class="number">889</span> non-null <span class="built_in">object</span></span><br><span class="line">dtypes: float64(<span class="number">2</span>), int64(<span class="number">5</span>), <span class="built_in">object</span>(<span class="number">5</span>)</span><br><span class="line">memory usage: <span class="number">83.6</span>+ KB</span><br></pre></td></tr></table></figure>

<p>一共是891行，12列，其中Age列和Cabin列还有Embarked列数据不完整，每一列的含义如下：</p>
<ul>
<li>PassengerId &#x3D;&gt; 乘客ID</li>
<li>Pclass &#x3D;&gt; 乘客等级(1&#x2F;2&#x2F;3等舱位)</li>
<li>Name &#x3D;&gt; 乘客姓名</li>
<li>Sex &#x3D;&gt; 性别</li>
<li>Age &#x3D;&gt; 年龄</li>
<li>SibSp &#x3D;&gt; 堂兄弟&#x2F;妹个数</li>
<li>Parch &#x3D;&gt; 父母与小孩个数</li>
<li>Ticket &#x3D;&gt; 船票信息</li>
<li>Fare &#x3D;&gt; 票价</li>
<li>Cabin &#x3D;&gt; 客舱</li>
<li>Embarked &#x3D;&gt; 登船港口</li>
</ul>
<p>然后我们可以看看各个数据的统计值</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">train_data.describe()</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th></th>
<th>PassengerId</th>
<th>Survived</th>
<th>Pclass</th>
<th>Age</th>
<th>SibSp</th>
<th>Parch</th>
<th>Fare</th>
</tr>
</thead>
<tbody><tr>
<td>count</td>
<td>891</td>
<td>891</td>
<td>891</td>
<td>714</td>
<td>891</td>
<td>891</td>
<td>891</td>
</tr>
<tr>
<td>mean</td>
<td>446</td>
<td>0.383838</td>
<td>2.308642</td>
<td>29.69912</td>
<td>0.523008</td>
<td>0.381594</td>
<td>32.20421</td>
</tr>
<tr>
<td>std</td>
<td>257.3538</td>
<td>0.486592</td>
<td>0.836071</td>
<td>14.5265</td>
<td>1.102743</td>
<td>0.806057</td>
<td>49.69343</td>
</tr>
<tr>
<td>min</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>0.42</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>25%</td>
<td>223.5</td>
<td>0</td>
<td>2</td>
<td>20.125</td>
<td>0</td>
<td>0</td>
<td>7.9104</td>
</tr>
<tr>
<td>50%</td>
<td>446</td>
<td>0</td>
<td>3</td>
<td>28</td>
<td>0</td>
<td>0</td>
<td>14.4542</td>
</tr>
<tr>
<td>75%</td>
<td>668.5</td>
<td>1</td>
<td>3</td>
<td>38</td>
<td>1</td>
<td>0</td>
<td>31</td>
</tr>
<tr>
<td>max</td>
<td>891</td>
<td>1</td>
<td>3</td>
<td>80</td>
<td>8</td>
<td>6</td>
<td>512.3292</td>
</tr>
</tbody></table>
<p>得到一个如图的描述，可以看到被救援的人数只有38%，且二，三等舱位人数居多，平均年龄29岁</p>
<p>这样得到的数据有一定的参考性，但是这么多个属性，究竟哪些和最终被救援有关系呢，我们可以画出图像来进行更加形象的描述</p>
<p>所有DataFrame类型的数据都可以在其后面直接调用plot函数，然后在其中输入kind来选择图的类型，绘制代码如下，</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">## 绘制被救情况</span></span><br><span class="line">plt.subplot2grid((<span class="number">2</span>,<span class="number">3</span>),(<span class="number">0</span>,<span class="number">0</span>))<span class="comment">## 画子图的第一个</span></span><br><span class="line">fig1 = train_data.Survived.value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;救援情况(1为被救)&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;人数&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> patch <span class="keyword">in</span> fig1.patches:</span><br><span class="line">    fig1.annotate(<span class="built_in">str</span>(<span class="built_in">int</span>(patch.get_height())),(patch.get_x(),patch.get_height()))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 绘制被救援和舱位之间的关系</span></span><br><span class="line">ax2 = plt.subplot2grid((<span class="number">2</span>,<span class="number">3</span>),(<span class="number">0</span>,<span class="number">1</span>))</span><br><span class="line">Survived_0 = train_data.Pclass[train_data.Survived == <span class="number">0</span>].value_counts()</span><br><span class="line">Survived_1 = train_data.Pclass[train_data.Survived == <span class="number">1</span>].value_counts()</span><br><span class="line">df=pd.DataFrame(&#123; <span class="string">u&#x27;未获救&#x27;</span>:Survived_0, <span class="string">u&#x27;获救&#x27;</span>:Survived_1&#125;)</span><br><span class="line">fig2 = df.plot(kind=<span class="string">&#x27;bar&#x27;</span>, stacked=<span class="literal">False</span> , ax=ax2)</span><br><span class="line">plt.title(<span class="string">u&quot;各乘客等级的获救情况&quot;</span>)</span><br><span class="line">plt.xlabel(<span class="string">u&quot;乘客等级&quot;</span>)</span><br><span class="line">plt.ylabel(<span class="string">u&quot;人数&quot;</span>)</span><br><span class="line"><span class="comment">## 用于标注直方图</span></span><br><span class="line"><span class="keyword">for</span> patch <span class="keyword">in</span> fig2.patches:</span><br><span class="line">    fig2.annotate(<span class="built_in">str</span>(<span class="built_in">int</span>(patch.get_height())),(patch.get_x(),patch.get_height()))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 年龄与获救的关系</span></span><br><span class="line">ax3 = plt.subplot2grid((<span class="number">2</span>,<span class="number">3</span>),(<span class="number">0</span>,<span class="number">2</span>))</span><br><span class="line">plt.scatter(train_data.Survived, train_data.Age)</span><br><span class="line">plt.title(<span class="string">&#x27;获救与年龄的关系&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;年龄&#x27;</span>)</span><br><span class="line"><span class="comment"># plt.xlim([0,1])</span></span><br><span class="line">plt.xticks([<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">## 各等级舱位年龄分布</span></span><br><span class="line">plt.subplot2grid((<span class="number">2</span>,<span class="number">3</span>),(<span class="number">1</span>,<span class="number">0</span>),colspan=<span class="number">2</span>)</span><br><span class="line">train_data.Age[train_data.Pclass == <span class="number">1</span>].plot(kind=<span class="string">&#x27;kde&#x27;</span>)</span><br><span class="line">train_data.Age[train_data.Pclass == <span class="number">2</span>].plot(kind=<span class="string">&#x27;kde&#x27;</span>)</span><br><span class="line">train_data.Age[train_data.Pclass == <span class="number">3</span>].plot(kind=<span class="string">&#x27;kde&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;各等级舱位年龄分布&#x27;</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;头等舱&#x27;</span>,<span class="string">&#x27;二等舱&#x27;</span>,<span class="string">&#x27;三等舱&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">## 各个口岸登船人数</span></span><br><span class="line">plt.subplot2grid((<span class="number">2</span>,<span class="number">3</span>),(<span class="number">1</span>,<span class="number">2</span>))</span><br><span class="line">train_data.Embarked.value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;各个口岸登船人数&#x27;</span>)</span><br><span class="line"></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>绘制得到的图片如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-25/98568081.jpg"></p>
<p>其中标注直方图的代码为：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Annotate</span>(<span class="params">fig,plus_times=<span class="number">1.005</span></span>):</span><br><span class="line">    <span class="keyword">for</span> patch <span class="keyword">in</span> fig.patches:</span><br><span class="line">        fig.text(patch.get_x()+patch.get_width()/<span class="number">2</span>,patch.get_height()*plus_times,</span><br><span class="line">                 <span class="built_in">str</span>(<span class="built_in">int</span>(patch.get_height())),ha=<span class="string">&#x27;center&#x27;</span>,va=<span class="string">&#x27;bottom&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>接下来具体看看每个属性和是否被救援的关系</p>
<p>首先画出被<strong>救援和性别之间的关系</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">survived_m = train_data.Survived[train_data.Sex == <span class="string">&#x27;male&#x27;</span>].value_counts()</span><br><span class="line">survived_f = train_data.Survived[train_data.Sex == <span class="string">&#x27;female&#x27;</span>].value_counts()</span><br><span class="line">df_sex =  DataFrame(data=&#123;<span class="string">&#x27;男性&#x27;</span>:survived_m,<span class="string">&#x27;女性&#x27;</span>:survived_f&#125;)</span><br><span class="line">df_sex.plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;被救援和性别的关系&#x27;</span>,fontsize=<span class="number">20</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;人数&#x27;</span>,fontsize=<span class="number">15</span>)</span><br><span class="line"><span class="comment">## 将横坐标的值改成中文</span></span><br><span class="line">plt.xticks(<span class="built_in">range</span>(<span class="number">2</span>),[<span class="string">&#x27;未获救&#x27;</span>,<span class="string">&#x27;获救&#x27;</span>],fontsize=<span class="number">15</span>,rotation=<span class="number">360</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;男性&#x27;</span>,<span class="string">&#x27;女性&#x27;</span>],fontsize=<span class="number">15</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>其中的字体大小设置可以用<code>ctrl+B</code>跳到原始代码中去看，大多数情况都是直接设置<code>fontsize</code></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-25/4950204.jpg"></p>
<p>舱位级别和性别对获救的影响</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">plt.suptitle(<span class="string">&#x27;舱位级别和性别对获救的影响&#x27;</span>,fontsize=<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#用于标注和设置横坐标的xticklables</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Annotate</span>(<span class="params">fig,plus_times=<span class="number">1.005</span></span>):</span><br><span class="line">    <span class="keyword">for</span> patch <span class="keyword">in</span> fig.patches:</span><br><span class="line">        fig.text(patch.get_x()+patch.get_width()/<span class="number">2</span>,patch.get_height()*plus_times,</span><br><span class="line">                 <span class="built_in">str</span>(<span class="built_in">int</span>(patch.get_height())),ha=<span class="string">&#x27;center&#x27;</span>,va=<span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">    fig.set_xticklabels([<span class="string">&#x27;未获救&#x27;</span>,<span class="string">&#x27;获救&#x27;</span>],rotation=<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 第一幅图</span></span><br><span class="line">ax1 = fig.add_subplot(<span class="number">1</span>,<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">a = train_data.Survived[train_data.Sex == <span class="string">&#x27;female&#x27;</span>][train_data.Pclass == <span class="number">1</span>].sort_values()</span><br><span class="line"><span class="comment"># train_data.Survived[train_data.Sex == &#x27;female&#x27;][train_data.Pclass == 1].value_counts().plot(kind=&#x27;bar&#x27;,color=&#x27;pink&#x27;)</span></span><br><span class="line">unsurvived = <span class="built_in">len</span>(train_data.Survived[train_data.Survived==<span class="number">0</span>][train_data.Sex == <span class="string">&#x27;female&#x27;</span>][train_data.Pclass == <span class="number">1</span>])</span><br><span class="line">survived = <span class="built_in">len</span>(train_data.Survived[train_data.Sex == <span class="string">&#x27;female&#x27;</span>][train_data.Pclass == <span class="number">1</span>][train_data.Survived==<span class="number">1</span>])</span><br><span class="line">ax1.bar(<span class="built_in">range</span>(<span class="number">0</span>,<span class="number">2</span>),[unsurvived,survived],width=<span class="number">0.3</span>,color=<span class="string">&#x27;pink&#x27;</span>)</span><br><span class="line">ax1.set_title(<span class="string">&#x27;高级舱女性获救情况&#x27;</span>)</span><br><span class="line">plt.xticks([<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line">Annotate(ax1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第二幅图</span></span><br><span class="line">ax2 = fig.add_subplot(<span class="number">1</span>,<span class="number">4</span>,<span class="number">2</span>)</span><br><span class="line">train_data.Survived[train_data.Sex == <span class="string">&#x27;female&#x27;</span>][train_data.Pclass == <span class="number">3</span>].value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>,color=<span class="string">&#x27;green&#x27;</span>)</span><br><span class="line">Annotate(ax2)</span><br><span class="line">ax2.set_title(<span class="string">&#x27;低级舱女性获救情况&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第三幅图</span></span><br><span class="line">ax1 = fig.add_subplot(<span class="number">1</span>,<span class="number">4</span>,<span class="number">3</span>)</span><br><span class="line">train_data.Survived[train_data.Sex == <span class="string">&#x27;male&#x27;</span>][train_data.Pclass == <span class="number">1</span>].value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>,color=[<span class="string">&#x27;blue&#x27;</span>,<span class="string">&#x27;yellow&#x27;</span>])</span><br><span class="line">ax1.set_title(<span class="string">&#x27;高级舱男性性获救情况&#x27;</span>)</span><br><span class="line">Annotate(ax1)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第四幅图</span></span><br><span class="line">ax1 = fig.add_subplot(<span class="number">1</span>,<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">train_data.Survived[train_data.Sex == <span class="string">&#x27;male&#x27;</span>][train_data.Pclass == <span class="number">3</span>].value_counts().plot(kind=<span class="string">&#x27;bar&#x27;</span>,color=<span class="string">&#x27;grey&#x27;</span>)</span><br><span class="line">ax1.set_title(<span class="string">&#x27;低级舱男性性获救情况&#x27;</span>)</span><br><span class="line">Annotate(ax1)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>接下来画出登船港口与是否获救的关系：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Annotate</span>(<span class="params">fig,plus_times=<span class="number">1.005</span></span>):</span><br><span class="line">    <span class="keyword">for</span> patch <span class="keyword">in</span> fig.patches:</span><br><span class="line">        fig.text(patch.get_x() + patch.get_width() / <span class="number">2</span>, patch.get_height() * plus_times,</span><br><span class="line">                                   <span class="built_in">str</span>(<span class="built_in">int</span>(patch.get_height())),ha=<span class="string">&#x27;center&#x27;</span>,va=<span class="string">&#x27;bottom&#x27;</span>)</span><br><span class="line">unsurvived_Embarked = train_data.Embarked[train_data.Survived == <span class="number">0</span>].value_counts()</span><br><span class="line">survived_Embarked = train_data.Embarked[train_data.Survived == <span class="number">1</span>].value_counts()</span><br><span class="line">ax = pd.DataFrame(data=&#123;<span class="string">&#x27;获救&#x27;</span>:survived_Embarked,<span class="string">&#x27;未获救&#x27;</span>:unsurvived_Embarked&#125;).plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line">plt.legend([<span class="string">&#x27;获救&#x27;</span>,<span class="string">&#x27;未获救&#x27;</span>],fontsize=<span class="number">15</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;登船港口与是否获救的关系&#x27;</span>,fontsize=<span class="number">20</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;人数&#x27;</span>,fontsize=<span class="number">15</span>)</span><br><span class="line">ax.set_xticklabels([<span class="string">&#x27;s&#x27;</span>,<span class="string">&#x27;c&#x27;</span>,<span class="string">&#x27;q&#x27;</span>],rotation=<span class="number">0</span>,fontsize=<span class="number">15</span>)</span><br><span class="line">Annotate(ax)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-26/88248188.jpg"></p>
<p>接下来画出堂兄弟姐妹对是否获救的影响：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 堂兄弟/妹对是否获救的影响</span></span><br><span class="line">g = train_data.groupby([<span class="string">&#x27;SibSp&#x27;</span>,<span class="string">&#x27;Survived&#x27;</span>])</span><br><span class="line">a=g.count()[<span class="string">&#x27;PassengerId&#x27;</span>]</span><br><span class="line">colors = [<span class="string">&#x27;blue&#x27;</span>,<span class="string">&#x27;green&#x27;</span>]</span><br><span class="line">fig = plt.figure()</span><br><span class="line">x = [<span class="number">2</span>*i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">int</span>(<span class="built_in">len</span>(a)/<span class="number">2</span>))]</span><br><span class="line">plt.bar(x,a.iloc[x].values,color=<span class="string">&#x27;blue&#x27;</span>,label=<span class="string">&#x27;未获救&#x27;</span>,width=<span class="number">0.3</span>)</span><br><span class="line">plt.bar(x,a.iloc[::<span class="number">2</span>].values,color=<span class="string">&#x27;blue&#x27;</span>,label=<span class="string">&#x27;未获救&#x27;</span>,width=<span class="number">0.3</span>)</span><br><span class="line">plt.bar([i+<span class="number">0.4</span> <span class="keyword">for</span> i <span class="keyword">in</span> x],a.iloc[<span class="number">1</span>::<span class="number">2</span>].values,color=<span class="string">&#x27;green&#x27;</span>,label=<span class="string">&#x27;未获救&#x27;</span>,width=<span class="number">0.3</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<p>pandas选取偶数行和奇数行分别为：df.iloc[::2], df.iloc[1::2]</p>
<p>要获得Mutiindex的值只需要:df.index.values</p>
<p>下面看看cabin这个参数，这个参数的缺失很多，并且值的种类实在是太多了，基本是每个值都不同，我们要把这个参数作为一个特征的话，也许可以试试cabin是否缺失作为特征</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">survived_cabin = train_data.Survived[pd.notnull(train_data.Cabin)].value_counts()</span><br><span class="line">survived_nocabin = train_data.Survived[pd.isnull(train_data.Cabin)].value_counts()</span><br><span class="line">df = DataFrame(data=&#123;<span class="string">&#x27;有&#x27;</span>:survived_cabin, <span class="string">&#x27;没有&#x27;</span>:survived_nocabin&#125;).T</span><br><span class="line">ax = df.plot(kind=<span class="string">&#x27;bar&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(df)</span><br><span class="line"><span class="comment"># plt.xticks([0,1],[&#x27;未获救&#x27;,&#x27;获救&#x27;])</span></span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-26/70177085.jpg"></p>
<p>看来有cabin这个参数更容易获救</p>
<p>因此我们需要将Cabin的有无转化为bool型变量：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 将cabin的有无转化为bool型变量</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bool_Cabin</span>(<span class="params">df</span>):</span><br><span class="line">    df.loc[pd.notnull(df.Cabin), <span class="string">&#x27;Cabin&#x27;</span>]= <span class="string">&#x27;Yes&#x27;</span></span><br><span class="line">    df.loc[pd.isnull(df.Cabin), <span class="string">&#x27;Cabin&#x27;</span>]= <span class="string">&#x27;No&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> df</span><br></pre></td></tr></table></figure>



<h3 id="使用RandomForest-Regression-对年龄数据进行拟合"><a href="#使用RandomForest-Regression-对年龄数据进行拟合" class="headerlink" title="使用RandomForest Regression 对年龄数据进行拟合"></a>使用RandomForest Regression 对年龄数据进行拟合</h3><p>因为年龄数据差的比较多，所以我们想到要将年龄数据进行补全，所以想到了拟合年龄的曲线，在这里我们使用的方法是RandomForestRegressor</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">matchAge</span>(<span class="params">df</span>):</span><br><span class="line">  	<span class="comment"># 通过已知的数值型变量来拟合Age这个参数</span></span><br><span class="line">    age_df = df[[<span class="string">&#x27;Age&#x27;</span>,<span class="string">&#x27;Pclass&#x27;</span>,<span class="string">&#x27;SibSp&#x27;</span>,<span class="string">&#x27;Parch&#x27;</span>,<span class="string">&#x27;Fare&#x27;</span>]]</span><br><span class="line">	</span><br><span class="line">    <span class="comment">#通过pd.notnull和pd.isnull来判断是否有年龄这个值，并转化为as_matrix()</span></span><br><span class="line">    knowAge = age_df[pd.notnull(age_df.Age)].as_matrix()</span><br><span class="line">    unknowAge = age_df[pd.isnull(age_df.Age)].as_matrix()</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 建立label，即为需要预测的标签的已知值，即训练时用到的标签</span></span><br><span class="line">    lable = knowAge[:,<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># 建立x，即输入的训练样本</span></span><br><span class="line">    x = knowAge[:,<span class="number">1</span>:]</span><br><span class="line">    </span><br><span class="line">  <span class="comment"># 初始化随机森林回归的参数，n_estimators=2000表示迭代2000次，n_jobs=-1表示用cpu的所有核进行并行计算</span></span><br><span class="line">    rfc = RandomForestRegressor(random_state=<span class="number">0</span>, n_estimators=<span class="number">2000</span>, n_jobs=-<span class="number">1</span>)</span><br><span class="line">   <span class="comment"># 开始训练</span></span><br><span class="line">    rfc.fit(x,lable)</span><br><span class="line">   </span><br><span class="line">  <span class="comment"># 开始利用训练好的模型进行预测</span></span><br><span class="line">    predictedAges = rfc.predict(unknowAge[:, <span class="number">1</span>:])</span><br><span class="line">    </span><br><span class="line">   <span class="comment"># 将原始数据的空值部分赋值为预测的数据</span></span><br><span class="line">    df.Age[pd.isnull(df.Age)] = predictedAges</span><br><span class="line">    <span class="comment"># 返回数据集</span></span><br><span class="line">    <span class="keyword">return</span> df,rfc</span><br></pre></td></tr></table></figure>



<h3 id="将非数字的值转化为数字"><a href="#将非数字的值转化为数字" class="headerlink" title="将非数字的值转化为数字"></a>将非数字的值转化为数字</h3><p>pandas提供了一个get_dummies函数，可以直接把可以分类的数据转换为多个成标量值，比如下面的将Cabin转化为了Cabin_yes 和Cabin_no:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dummies_Cabin = pd.get_dummies(train_data[<span class="string">&#x27;Cabin&#x27;</span>], prefix=<span class="string">&#x27;Cabin&#x27;</span>)</span><br><span class="line">dummies_Embarked = pd.get_dummies(train_data[<span class="string">&#x27;Embarked&#x27;</span>], prefix=<span class="string">&#x27;Embarked&#x27;</span>)</span><br><span class="line">dummies_Sex = pd.get_dummies(train_data[<span class="string">&#x27;Sex&#x27;</span>], prefix=<span class="string">&#x27;Sex&#x27;</span>)</span><br><span class="line">dummies_Pclass = pd.get_dummies(train_data[<span class="string">&#x27;Pclass&#x27;</span>], prefix=<span class="string">&#x27;Pclass&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="连接两个DataFrame"><a href="#连接两个DataFrame" class="headerlink" title="连接两个DataFrame"></a>连接两个DataFrame</h3><p>只要用<code>pd.concat([df1,df2], axis=1)</code>，就可以按列连接</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">train_data = pd.concat([train_data,dummies_Cabin,dummies_Embarked,dummies_Sex,dummies_Pclass],axis=1)</span><br></pre></td></tr></table></figure>



<h3 id="删除某些列"><a href="#删除某些列" class="headerlink" title="删除某些列"></a>删除某些列</h3><p>直接<code>df.drop([&#39;column1&#39;,&#39;column2&#39;], axis=1, inplace=True)</code>，就是按列删除，并且inplace&#x3D;True表示将原来的df直接替换成删除掉某些列之后的数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train_data.drop([<span class="string">&#x27;Name&#x27;</span>,<span class="string">&#x27;Sex&#x27;</span>,<span class="string">&#x27;Ticket&#x27;</span>,<span class="string">&#x27;Cabin&#x27;</span>,<span class="string">&#x27;Embarked&#x27;</span>],axis=<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>



<h3 id="数据归一化"><a href="#数据归一化" class="headerlink" title="数据归一化"></a>数据归一化</h3><p>使用<code>sklearn.preprocessing</code>包的preprocessing函数，先定义一个scaler实例，用<code>preprocessing</code>的<code>StandardScaler</code>，用scaler先fit出你想要归一化的那一列的参数，然后用fit_transform进行归一化，传入的参数是需要归一化的值和归一化参数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#数据预处理</span><br><span class="line">import sklearn.preprocessing as preprocessing</span><br><span class="line"></span><br><span class="line">scaler = preprocessing.StandardScaler()</span><br><span class="line">age_scale_param = scaler.fit(train_data[[&#x27;Age&#x27;]])</span><br><span class="line">train_data[&#x27;Age_scaled&#x27;] = scaler.fit_transform(train_data[[&#x27;Age&#x27;]],age_scale_param)</span><br><span class="line">Fare_scale_param = scaler.fit(train_data[[&#x27;Fare&#x27;]])</span><br><span class="line">train_data[&#x27;Fare_scaled&#x27;] = scaler.fit_transform(train_data[[&#x27;Fare&#x27;]],Fare_scale_param)</span><br></pre></td></tr></table></figure>



<h3 id="逻辑回归预测"><a href="#逻辑回归预测" class="headerlink" title="逻辑回归预测"></a>逻辑回归预测</h3><p>计算完这些部分，将测试数据导入并进行与训练数据相同的预处理，然后进行逻辑回归预测，先用train_data进行fit，然后用训练数据的x进行预测</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn <span class="keyword">import</span> linear_model</span><br><span class="line"></span><br><span class="line">train_data = pd.read_csv(<span class="string">&#x27;prepross_train.csv&#x27;</span>,index_col=<span class="number">0</span>)</span><br><span class="line">train_data.info()</span><br><span class="line"></span><br><span class="line">train_df = train_data.iloc[:,<span class="number">1</span>:].as_matrix()</span><br><span class="line">y = train_df[:,<span class="number">0</span>]</span><br><span class="line">x = train_df[:,<span class="number">1</span>:]</span><br><span class="line"><span class="comment"># test_data = prepross(&#x27;test.csv&#x27;,&#x27;prepross_test.csv&#x27;)</span></span><br><span class="line">test_data = pd.read_csv(<span class="string">&#x27;prepross_test.csv&#x27;</span>,index_col=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">clf = linear_model.LogisticRegression(penalty=<span class="string">&#x27;l1&#x27;</span>,C=<span class="number">1.0</span>,tol=<span class="number">1e-6</span>)</span><br><span class="line">clf.fit(x, y)</span><br><span class="line">test_x = test_data.iloc[:,<span class="number">1</span>:]</span><br><span class="line">prediction = clf.predict(test_x)</span><br><span class="line"></span><br><span class="line">result = DataFrame(data=&#123;<span class="string">&#x27;PassengerId&#x27;</span>:test_data[<span class="string">&#x27;PassengerId&#x27;</span>].as_matrix(),<span class="string">&#x27;Survived&#x27;</span>:[<span class="built_in">int</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> prediction]&#125;)</span><br><span class="line">result.to_csv(<span class="string">&#x27;result.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>



<h3 id="检验预测精度"><a href="#检验预测精度" class="headerlink" title="检验预测精度"></a>检验预测精度</h3><p>因为我们一开始在进行测试数据预处理的时候，删除了一行，所以在比较的时候应该把这一行补上，在补充完毕之后index是乱的，所以我们直接reset_index，并且sort_values，按照PassengerId排序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">auth_df = pd.read_csv(<span class="string">&#x27;gender_submission.csv&#x27;</span>)</span><br><span class="line">result_df = pd.read_csv(<span class="string">&#x27;result.csv&#x27;</span>,index_col=<span class="number">0</span>)</span><br><span class="line">s = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">a = result_df[<span class="string">&#x27;PassengerId&#x27;</span>].values</span><br><span class="line">b = auth_df[<span class="string">&#x27;PassengerId&#x27;</span>].values</span><br><span class="line">c = [c <span class="keyword">for</span> c <span class="keyword">in</span> b <span class="keyword">if</span> c <span class="keyword">not</span> <span class="keyword">in</span> a][<span class="number">0</span>]</span><br><span class="line">result_df = pd.concat([result_df,auth_df[auth_df.PassengerId == c]],axis=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">result_df.reset_index(drop=<span class="literal">True</span>,inplace=<span class="literal">True</span>)</span><br><span class="line">result_df.sort_values(by=<span class="string">&#x27;PassengerId&#x27;</span>,inplace=<span class="literal">True</span>)</span><br><span class="line">result_df.reset_index(drop=<span class="literal">True</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">result_df.loc[auth_df.PassengerId == c,<span class="string">&#x27;Survived&#x27;</span>] = <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i,j <span class="keyword">in</span> <span class="built_in">zip</span>(result_df[<span class="string">&#x27;Survived&#x27;</span>].values, auth_df[<span class="string">&#x27;Survived&#x27;</span>].values):</span><br><span class="line">    <span class="keyword">if</span> i == j:</span><br><span class="line">        s += <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(s)</span><br><span class="line">precession = <span class="built_in">float</span>(s/<span class="built_in">len</span>(auth_df[<span class="string">&#x27;Survived&#x27;</span>]))</span><br><span class="line"><span class="built_in">print</span>(precession)</span><br></pre></td></tr></table></figure>

<p>精度得到为<code>0.9330143540669856</code> </p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>kaggle</tag>
        <tag>数据挖掘</tag>
      </tags>
  </entry>
  <entry>
    <title>keras TensorFlow 搭建验证码识别系统</title>
    <url>/2018/08/11/keras-TensorFlow-%E6%90%AD%E5%BB%BA%E9%AA%8C%E8%AF%81%E7%A0%81%E8%AF%86%E5%88%AB%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<p>keras整体来说是一个非常简单易用的框架，搭建一个网络非常地快捷和方便，这篇博客主要是记录之前用keras搭建的一个cnn识别验证码的步骤。</p>
<span id="more"></span>

<h2 id="数据生成"><a href="#数据生成" class="headerlink" title="数据生成"></a>数据生成</h2><p>首先用<code>ImageCaptcha</code>这个库来生成验证码，这里有两种生成的方式，一种是直接生成很多张，放在电脑中，然后每次读一部分进来进行训练，还有一种方式就是用生成器的方式来生成数据，然后用keras model的<code>fit_generator</code>方法进行训练。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> captcha.image <span class="keyword">import</span> ImageCaptcha</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> random,os</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br><span class="line">%matplotlib inline</span><br><span class="line">%config InlineBackend.figure_format = <span class="string">&#x27;retina&#x27;</span></span><br><span class="line"><span class="keyword">import</span> keras</span><br><span class="line"><span class="keyword">from</span> keras <span class="keyword">import</span> backend <span class="keyword">as</span> K</span><br><span class="line"><span class="keyword">from</span> keras_tqdm <span class="keyword">import</span> TQDMNotebookCallback</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line">characters = string.digits + string.ascii_uppercase</span><br><span class="line"><span class="comment"># print(characters)</span></span><br><span class="line"></span><br><span class="line">width, height, n_len, n_class = <span class="number">160</span>, <span class="number">80</span>, <span class="number">4</span>, <span class="built_in">len</span>(characters)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">generator = ImageCaptcha(width=width, height=height)</span><br><span class="line"><span class="comment"># for i in range(1000):</span></span><br><span class="line"><span class="comment">#     random_str = &#x27;&#x27;.join([random.choice(characters) for j in range(4)])</span></span><br><span class="line"><span class="comment">#     img = generator.generate_image(random_str)</span></span><br><span class="line"><span class="comment">#     img.save(&#x27;./pic/&#x27;+str(i) +&#x27;_&#x27;+ random_str + &#x27;.jpg&#x27;)</span></span><br><span class="line"></span><br><span class="line">imgs = []</span><br><span class="line">labels =[]</span><br><span class="line">temp = [[] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理生成的数据，通过opencv的二值化和高斯模糊函数来去噪声</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">deal_img</span>(<span class="params">img</span>):</span><br><span class="line"><span class="comment">#     img = load_img(path,grayscale=True)</span></span><br><span class="line">    kernel = np.ones((<span class="number">3</span>,<span class="number">1</span>), np.uint8)</span><br><span class="line">    img = img_to_array(img).astype(np.uint8)</span><br><span class="line">    img = cv.cvtColor(img, cv.COLOR_BGR2GRAY) </span><br><span class="line"><span class="comment">#     img= cv.bilateralFilter(img,9,75,75)</span></span><br><span class="line"><span class="comment">#     img = cv.Canny(img, 100, 200)</span></span><br><span class="line">    blur = cv.GaussianBlur(img, (<span class="number">5</span>, <span class="number">5</span>), <span class="number">0</span>)</span><br><span class="line">    _, img = cv.threshold(blur, <span class="number">0</span>, <span class="number">255</span>, cv.THRESH_BINARY + cv.THRESH_OTSU)</span><br><span class="line">    img = cv.dilate(img, kernel, iterations=<span class="number">1</span>)</span><br><span class="line">    img = cv.erode(img, kernel, iterations=<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> img.reshape(height,width,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据生成器，每次生成batch_size张图片</span></span><br><span class="line"><span class="comment"># 输出的y的格式是[144,1]</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen</span>(<span class="params">batch_size=<span class="number">32</span></span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        imgs=[]</span><br><span class="line">        labels = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(batch_size):</span><br><span class="line">            random_str = <span class="string">&#x27;&#x27;</span>.join([random.choice(characters) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)])</span><br><span class="line">            img = generator.generate_image(random_str)</span><br><span class="line">            img = deal_img(img)</span><br><span class="line">            imgs.append(img)</span><br><span class="line">            y=np.zeros((<span class="built_in">len</span>(characters)*<span class="number">4</span>))</span><br><span class="line">            <span class="keyword">for</span> i,char <span class="keyword">in</span> <span class="built_in">enumerate</span>(random_str):</span><br><span class="line">                y[characters.find(char)+i*<span class="built_in">len</span>(characters)] = <span class="number">1</span></span><br><span class="line">            labels.append(y)   </span><br><span class="line">        train_x = np.array(imgs)</span><br><span class="line">        train_y = np.array(labels)</span><br><span class="line">        <span class="keyword">yield</span> train_x, train_y</span><br></pre></td></tr></table></figure>

<h2 id="网络构建"><a href="#网络构建" class="headerlink" title="网络构建"></a>网络构建</h2><p>构建一个类似于vgg16的网络</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> keras.preprocessing.image <span class="keyword">import</span> img_to_array,load_img</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> keras.layers <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keras.models <span class="keyword">import</span> Model</span><br><span class="line"><span class="keyword">import</span> cv2 <span class="keyword">as</span> cv</span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建类似于vgg16的网络结构</span></span><br><span class="line">input_tensor = Input(shape=(height, width, <span class="number">1</span>))</span><br><span class="line">x = input_tensor</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    x = Conv2D(<span class="number">32</span>*<span class="number">2</span>**i, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">    x = Conv2D(<span class="number">32</span>*<span class="number">2</span>**i, (<span class="number">3</span>, <span class="number">3</span>), activation=<span class="string">&#x27;relu&#x27;</span>)(x)</span><br><span class="line">    x = MaxPooling2D((<span class="number">2</span>, <span class="number">2</span>))(x)</span><br><span class="line"></span><br><span class="line">x = Flatten()(x)</span><br><span class="line">x = Dropout(<span class="number">0.25</span>)(x)</span><br><span class="line">x = [Dense(n_class, activation=<span class="string">&#x27;softmax&#x27;</span>, name=<span class="string">&#x27;c%d&#x27;</span>%(i+<span class="number">1</span>))(x) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">x = concatenate(x)</span><br><span class="line">model = Model(inputs=input_tensor, outputs=x)</span><br></pre></td></tr></table></figure>

<p>我们来看看模型的结构，画出模型结构图，在使用plot_model之前要先<code>pip install pydot-ng &amp; apt install graphviz </code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> keras.utils <span class="keyword">import</span> plot_model</span><br><span class="line">plot_model(model, to_file=<span class="string">&#x27;model.png&#x27;</span>)</span><br><span class="line">model.summary()</span><br></pre></td></tr></table></figure>



<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-8-11/86737125.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">model.summary()</span><br><span class="line">___________________________________________________________________________________</span><br><span class="line">Layer (<span class="built_in">type</span>)                    Output Shape         Param <span class="comment">#     Connected to                    ================================================================================================</span></span><br><span class="line">input_1 (InputLayer)            (<span class="literal">None</span>, <span class="number">80</span>, <span class="number">160</span>, <span class="number">1</span>)   <span class="number">0</span>                                           </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_1 (Conv2D)               (<span class="literal">None</span>, <span class="number">78</span>, <span class="number">158</span>, <span class="number">32</span>)  <span class="number">320</span>         input_1[<span class="number">0</span>][<span class="number">0</span>]                  </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_2 (Conv2D)               (<span class="literal">None</span>, <span class="number">76</span>, <span class="number">156</span>, <span class="number">32</span>)  <span class="number">9248</span>        conv2d_1[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_1 (MaxPooling2D)  (<span class="literal">None</span>, <span class="number">38</span>, <span class="number">78</span>, <span class="number">32</span>)   <span class="number">0</span>           conv2d_2[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_3 (Conv2D)               (<span class="literal">None</span>, <span class="number">36</span>, <span class="number">76</span>, <span class="number">64</span>)   <span class="number">18496</span>       max_pooling2d_1[<span class="number">0</span>][<span class="number">0</span>]           </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_4 (Conv2D)               (<span class="literal">None</span>, <span class="number">34</span>, <span class="number">74</span>, <span class="number">64</span>)   <span class="number">36928</span>       conv2d_3[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_2 (MaxPooling2D)  (<span class="literal">None</span>, <span class="number">17</span>, <span class="number">37</span>, <span class="number">64</span>)   <span class="number">0</span>           conv2d_4[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_5 (Conv2D)               (<span class="literal">None</span>, <span class="number">15</span>, <span class="number">35</span>, <span class="number">128</span>)  <span class="number">73856</span>       max_pooling2d_2[<span class="number">0</span>][<span class="number">0</span>]           </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_6 (Conv2D)               (<span class="literal">None</span>, <span class="number">13</span>, <span class="number">33</span>, <span class="number">128</span>)  <span class="number">147584</span>      conv2d_5[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">_______________________________________________________________________________________________</span><br><span class="line">max_pooling2d_3 (MaxPooling2D)  (<span class="literal">None</span>, <span class="number">6</span>, <span class="number">16</span>, <span class="number">128</span>)   <span class="number">0</span>           conv2d_6[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_7 (Conv2D)               (<span class="literal">None</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">256</span>)   <span class="number">295168</span>      max_pooling2d_3[<span class="number">0</span>][<span class="number">0</span>]           </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">conv2d_8 (Conv2D)               (<span class="literal">None</span>, <span class="number">2</span>, <span class="number">12</span>, <span class="number">256</span>)   <span class="number">590080</span>      conv2d_7[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">max_pooling2d_4 (MaxPooling2D)  (<span class="literal">None</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">256</span>)    <span class="number">0</span>           conv2d_8[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">flatten_1 (Flatten)             (<span class="literal">None</span>, <span class="number">1536</span>)         <span class="number">0</span>           max_pooling2d_4[<span class="number">0</span>][<span class="number">0</span>]           </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">dropout_1 (Dropout)             (<span class="literal">None</span>, <span class="number">1536</span>)         <span class="number">0</span>           flatten_1[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">c1 (Dense)                      (<span class="literal">None</span>, <span class="number">36</span>)           <span class="number">55332</span>       dropout_1[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">c2 (Dense)                      (<span class="literal">None</span>, <span class="number">36</span>)           <span class="number">55332</span>       dropout_1[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">c3 (Dense)                      (<span class="literal">None</span>, <span class="number">36</span>)           <span class="number">55332</span>       dropout_1[<span class="number">0</span>][<span class="number">0</span>]                 </span><br><span class="line">________________________________________________________________________________________________</span><br><span class="line">c4 (Dense)                      (<span class="literal">None</span>, <span class="number">36</span>)           <span class="number">55332</span>       dropout_1[<span class="number">0</span>][<span class="number">0</span>]                 ________________________________________________________________________________________________</span><br><span class="line">concatenate_1 (Concatenate)     (<span class="literal">None</span>, <span class="number">144</span>)          <span class="number">0</span>           c1[<span class="number">0</span>][<span class="number">0</span>]                       </span><br><span class="line">                                                                 c2[<span class="number">0</span>][<span class="number">0</span>]                       </span><br><span class="line">                                                                 c3[<span class="number">0</span>][<span class="number">0</span>]                       </span><br><span class="line">                                                                 c4[<span class="number">0</span>][<span class="number">0</span>]                       </span><br><span class="line">================================================================================================</span><br><span class="line">Total params: <span class="number">1</span>,<span class="number">393</span>,008</span><br><span class="line">Trainable params: <span class="number">1</span>,<span class="number">393</span>,008</span><br><span class="line">Non-trainable params: <span class="number">0</span></span><br><span class="line">_______________________________________________________________________________________________</span><br></pre></td></tr></table></figure>

<h3 id="定义loss和acc"><a href="#定义loss和acc" class="headerlink" title="定义loss和acc"></a>定义loss和acc</h3><p>这里的loss不能用系统自带的几个loss和acc，因为我们这里是分4个字符的验证码，不是一个分对了就是对，而是四个都对了才是对</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tf_session = K.get_session()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_acc</span>(<span class="params">y_true, y_pred</span>):</span><br><span class="line">    predict = tf.reshape(y_pred, [-<span class="number">1</span>, n_len, <span class="built_in">len</span>(characters)])</span><br><span class="line">    max_idx_p = tf.argmax(predict, -<span class="number">1</span>)</span><br><span class="line">    max_idx_l = tf.argmax(tf.reshape(y_true, [-<span class="number">1</span>,n_len, <span class="built_in">len</span>(characters)]), -<span class="number">1</span>)</span><br><span class="line">    <span class="built_in">print</span>(K.int_shape(max_idx_p))</span><br><span class="line">    <span class="built_in">print</span>(K.int_shape(max_idx_l))</span><br><span class="line">    correct_pred = tf.reduce_all(tf.equal(max_idx_p, max_idx_l),axis=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> tf.reduce_mean(tf.cast(correct_pred, tf.float32))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_loss</span>(<span class="params">y_true, y_pred</span>):</span><br><span class="line">    loss = tf.zeros((<span class="number">1</span>,))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_len):</span><br><span class="line">        a = tf.reshape(y_pred[:,i*<span class="number">36</span>:(i+<span class="number">1</span>)*<span class="number">36</span>],shape=(-<span class="number">1</span>,<span class="number">36</span>))</span><br><span class="line">        b = tf.reshape(y_true[:,i*<span class="number">36</span>:(i+<span class="number">1</span>)*<span class="number">36</span>],shape=(-<span class="number">1</span>,<span class="number">36</span>))</span><br><span class="line">        loss = tf.add(loss,tf.keras.losses.categorical_crossentropy(b,a))</span><br><span class="line">    <span class="keyword">return</span> loss</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">model.<span class="built_in">compile</span>(loss = my_loss,</span><br><span class="line">              optimizer=<span class="string">&#x27;adam&#x27;</span>,</span><br><span class="line">              metrics=[my_acc,<span class="string">&#x27;acc&#x27;</span>])</span><br><span class="line">checkpointer = keras.callbacks.ModelCheckpoint(filepath=<span class="string">&#x27;output/weight.h5&#x27;</span>,<span class="comment">#&quot;output/weights.&#123;epoch:02d&#125;--&#123;val_loss:.2f&#125;-&#123;val_my_acc:.4f&#125;.hdf5&quot;, </span></span><br><span class="line">                               verbose=<span class="number">2</span>, save_weights_only=<span class="literal">True</span>)</span><br><span class="line">model.fit_generator(gen(<span class="number">32</span>),steps_per_epoch=<span class="number">15000</span>,epochs=<span class="number">1</span>,verbose=<span class="number">1</span>,validation_data=gen(<span class="number">100</span>),validation_steps=<span class="number">1</span>,callbacks=[checkpointer])</span><br><span class="line"></span><br><span class="line">(<span class="literal">None</span>, <span class="number">4</span>)</span><br><span class="line">(<span class="literal">None</span>, <span class="number">4</span>)</span><br><span class="line">Epoch <span class="number">1</span>/<span class="number">1</span></span><br><span class="line"><span class="number">15000</span>/<span class="number">15000</span> [==============================] - 13561s 904ms/step - loss: <span class="number">0.4114</span> - my_acc: <span class="number">0.9086</span> - acc: <span class="number">0.3406</span> - val_loss: <span class="number">0.6470</span> - val_my_acc: <span class="number">0.8500</span> - val_acc: <span class="number">0.3700</span></span><br><span class="line"></span><br><span class="line">Epoch 00001: saving model to output/weight.h5</span><br></pre></td></tr></table></figure>

<p>至此，模型训练结束，你可以生成更多的数据来训练一次达到更高的模型精度</p>
<h3 id="测试模型精度"><a href="#测试模型精度" class="headerlink" title="测试模型精度"></a>测试模型精度</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decode_str</span>(<span class="params">result</span>):</span><br><span class="line">    strings =[]</span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(result.shape[<span class="number">0</span>]):</span><br><span class="line">        string = [characters[result[s,i*<span class="built_in">len</span>(characters):(i+<span class="number">1</span>)*<span class="built_in">len</span>(characters)].argmax()] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n_len)]</span><br><span class="line">        strings.append(string)</span><br><span class="line">    <span class="keyword">return</span> [<span class="string">&#x27;&#x27;</span>.join(string) <span class="keyword">for</span> string <span class="keyword">in</span> strings]</span><br><span class="line"></span><br><span class="line">x,y = <span class="built_in">next</span>(gen(<span class="number">1000</span>))</span><br><span class="line">true_label = decode_str(y)</span><br><span class="line">score = model.evaluate(x,y,verbose=<span class="number">2</span>)</span><br><span class="line">result = model.predict(x,verbose=<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#最后得出的精度值为93.3%</span></span><br><span class="line">score</span><br><span class="line">[<span class="number">0.3298118329048157</span>, <span class="number">0.933</span>, <span class="number">0.298</span>]</span><br></pre></td></tr></table></figure>

<h3 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h3><p>一开始随便搭建了一个conv加dense层组合的网络，效果很差，所以还是要用一些成熟的网络。还有一个问题就是loss不下降，这个问题的原因是一开始用的adam optimizer，step设置得太小了，后来用了adadelta，step的初始值就是1，这样下降很快，效果提升就比较明显。</p>
]]></content>
      <categories>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>latex入门教程</title>
    <url>/2017/08/08/latex%E5%85%A5%E9%97%A8%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<p>最近几天改论文，因为information science 只提供latex模板，所以突击学习了一下latex</p>
<p>latex的编辑软件主要用到的是ctxt，安装地址</p>
<span id="more"></span>

<p>链接：<a href="http://pan.baidu.com/s/1o8BNpHK">http://pan.baidu.com/s/1o8BNpHK</a> 密码：vv9y</p>
<p>一路点击下一步就可以了</p>
<p>然后安装插文献的软件jabref，安装地址</p>
<p>链接：<a href="http://pan.baidu.com/s/1c2mzkWw">http://pan.baidu.com/s/1c2mzkWw</a> 密码：2q7p</p>
<p>打开Elsevier提供的latex模板文件<code>elsarticle-template-num.tex</code>就可以开始编辑了、</p>
<p>首先确认你要用的模板类型及版面大小，Elsevier一共提供了2种文件类型，一种是preprint就是默认提交给elsevier的格式，review是增加了行间距的格式，有3种版面大小设置，1p，3p和5p，通过<code>\documentclass[preview,3p,12pt]&#123;elsarticle&#125;</code>进行设置</p>
<p>接下来设置需要的参考文献的格式类型，我们在文中用到的是[1-4]这种压缩的格式，用的是数字，所以设置成</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\biboptions</span>&#123;numbers,sort<span class="built_in">&amp;</span>compress&#125;</span><br></pre></td></tr></table></figure>



<p>接下来开始写文章</p>
<p>整体来说，latex有点类似于html的语法，文章从<code>\begin&#123;document&#125;</code>开始，到<code>\end&#123;document&#125;</code>结束</p>
<p>我们按照提示填入<code>\title&#123;&#125;</code>，<code>\author[1]&#123;chao shen&#125;</code>,<code>\author[2]&#123;zhao wang&#125;</code>,<code>\address[1]&#123;xi&#39;an jiaotong university&#125;</code></p>
<p>然后填入摘要，关键字等等<code>\begin&#123;abstract&#125;…………\end&#123;abstract&#125;</code>,<code>\begin&#123;keyword&#125;…………\end&#123;keyword&#125;</code></p>
<p>下面就开始写正式章节了</p>
<p>一级标题应该用 <code>\section&#123;Introduction&#125;</code>这样的形式</p>
<p>二级标题用<code>\subsection&#123;xxx&#125;</code></p>
<p>三级标题用<code>\subsubsection&#123;xxx&#125;</code></p>
<p>四级标题没有定义，应该用<code>\paragraph&#123;(1)Detection Performance Comparison&#125;</code></p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p>参考文献直接用jabref插入，在jabref中选好文件之后，点击右上角的推送到winedt，winedt的路径要先选一下，在首选项，外部程序里面找到<code>D:\program files\CTEX\WinEdt\WinEdt.exe</code>，选择之后确认。</p>
<p>建立bib文件，每一条搜索之后铜鼓google导出bib，复制粘贴就加入了一条记录，记得要把库文件保存到个tex文件同一个文件夹，然后在tex文件中指定参考文件<code>\bibliographystyle&#123;elsarticle-num&#125;</code>，<code>\bibliography&#123;ref&#125;</code></p>
<p>在推送之前，一定要先编译纯粹的latex，然后编译bib，再编译latex，再编译bib之后才能推送，不然文献会是<code>？</code> </p>
<p>编译无法通过的时候可以加入<code>\usepackage&#123;epstopdf&#125;</code></p>
<p>然后每次选中几条，鼠标放到tex文件中需要插入的地方，直接点击推送到winedt就行了</p>
<p>插入url时要用到如下包<code>\usepackage&#123;url&#125;</code></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-10/8740980.jpg"></p>
<h2 id="插入图片"><a href="#插入图片" class="headerlink" title="插入图片"></a>插入图片</h2><p>我们要插入的方式是一行插入多张图片，使用下述的程序段</p>
<p>使用前要先声明用了如下包：<code>\usepackage&#123;subfigure&#125;</code></p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="comment">%</span></span><br><span class="line"><span class="keyword">\begin</span>&#123;figure&#125;[t]</span><br><span class="line"><span class="keyword">\noindent</span></span><br><span class="line"><span class="keyword">\centering</span></span><br><span class="line"><span class="keyword">\subfigure</span>[]&#123;</span><br><span class="line"><span class="keyword">\includegraphics</span>[width=.3<span class="keyword">\textwidth</span>]&#123;6-1.eps&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">\subfigure</span>[]&#123;</span><br><span class="line"><span class="keyword">\includegraphics</span>[width=.3<span class="keyword">\textwidth</span>]&#123;6-2.eps&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">\subfigure</span>[]&#123;</span><br><span class="line"><span class="keyword">\includegraphics</span>[width=.3<span class="keyword">\textwidth</span>]&#123;6-3.eps&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">\caption</span>&#123;EER curves against different user sizes:(a) nearest neighbor (Mahalanobis), (b) One-class support vector machine, (c) Mahalanobis (normed).&#125;</span><br><span class="line"><span class="keyword">\label</span>&#123;Figure 6&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;figure&#125;</span><br><span class="line"><span class="comment">%</span></span><br></pre></td></tr></table></figure>

<p>放一张图时用如下程序</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\begin</span>&#123;figure&#125;[t]</span><br><span class="line">  <span class="keyword">\centering</span></span><br><span class="line">  <span class="comment">% Requires \usepackage&#123;graphicx&#125;</span></span><br><span class="line">  <span class="keyword">\includegraphics</span>[width=0.5<span class="keyword">\textwidth</span>]&#123;2.eps&#125;<span class="keyword">\\</span></span><br><span class="line">  <span class="keyword">\caption</span>&#123;EER curves at varying operating length using the three detectors. X-axis represents the number of touch operations to verify a user&#x27;s identity&#125;</span><br><span class="line">  <span class="keyword">\label</span>&#123;Figure 2&#125;</span><br><span class="line"><span class="keyword">\end</span>&#123;figure&#125;</span><br></pre></td></tr></table></figure>



<h2 id="插入表格"><a href="#插入表格" class="headerlink" title="插入表格"></a>插入表格</h2><p>latex绘制表格比较麻烦，因此我们用网站进行绘制：<a href="http://www.tablesgenerator.com/latex_tables">table generator</a></p>
<p>在网站上绘制好之后，我们使用<code>compress whitespace</code>然后点击<code>scale</code>缩放到跟纸张一样大</p>
<p>之后直接粘贴到我们的文件中就行了，要声明用到如下包：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\usepackage</span>&#123;multirow&#125;</span><br><span class="line"><span class="keyword">\usepackage</span>&#123;booktabs,graphicx&#125;</span><br></pre></td></tr></table></figure>

<p>如果某条线要加粗，需要把<code>hline</code>替换为<code>\Xhline&#123;1.2pt&#125;</code></p>
<p>插入的时候可以在<code>\begin&#123;table&#125;</code>后面加上选择放置的位置,[t]代表top，[h]表示hear，[b]表示bottom</p>
<p>在表格中要加入空格的时候可以用这个命令<code>\hspace*&#123;75pt&#125;</code></p>
<p>如果要改变表格与文字之间的距离，使用<code>\setlength&#123;\textfloatsep&#125;&#123;10pt plus 1.0pt minus 2.0pt&#125;</code></p>
<p>其中后面这个<code>\textfloatsep</code>分类如下所示：</p>
<p>Change one or more of the following lengths:</p>
<ul>
<li><code>\textfloatsep</code> — distance between floats on the top or the bottom and the text;</li>
<li>\floatsep — distance between two floats;</li>
<li>\intextsep — distance between floats inserted inside the page text (using h) and the text proper.</li>
</ul>
<h2 id="参考文献-1"><a href="#参考文献-1" class="headerlink" title="参考文献"></a>参考文献</h2><p>参考文献的插入主要有两种方式,</p>
<ol>
<li><p>第一种是通过JabRef, 在google上下载bibtxt文件, 保存到jabref的库中, 保存为bib文件,通过jabref菜单中的插入winedit进行插入, 在tex文件中写入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">\bibliographystyle&#123;elsarticle-num&#125;</span><br><span class="line">\bibliography&#123;ref&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>第二种是直接将参考文献放入tex文件中：</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line"><span class="keyword">\bibliographystyle</span>&#123;named&#125;</span><br><span class="line"><span class="keyword">\begin</span>&#123;thebibliography&#125;&#123;&#125;</span><br><span class="line"><span class="keyword">\bibitem</span>&#123;Password1&#125;</span><br><span class="line">Klein D V. Foiling the cracker: A survey of, and improvements to, password security[C]//Proceedings of the 2nd USENIX Security Workshop. 1990: 5-14.</span><br></pre></td></tr></table></figure>

<p>​</p>
</li>
</ol>
]]></content>
      <categories>
        <category>论文</category>
      </categories>
      <tags>
        <tag>latex</tag>
      </tags>
  </entry>
  <entry>
    <title>leetcode-22解答</title>
    <url>/2018/08/27/leetcode-22%E8%A7%A3%E7%AD%94/</url>
    <content><![CDATA[<p>给定一个值n，要求能生成n对括号的组合数，题目具体如下：</p>
<p>Given <em>n</em> pairs of parentheses, write a function to generate all combinations of well-formed parentheses.</p>
<span id="more"></span>

<p>For example, given <em>n</em> &#x3D; 3, a solution set is:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  &quot;((()))&quot;,</span><br><span class="line">  &quot;(()())&quot;,</span><br><span class="line">  &quot;(())()&quot;,</span><br><span class="line">  &quot;()(())&quot;,</span><br><span class="line">  &quot;()()()&quot;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="方法一：暴力求解"><a href="#方法一：暴力求解" class="headerlink" title="方法一：暴力求解"></a>方法一：暴力求解</h3><p>把所有有可能的情况全部列出来，判断是否符合要求，符合的留下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generateParenthesis</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        :type n: int</span></span><br><span class="line"><span class="string">        :rtype: List[str]</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">is_valid</span>(<span class="params">str_list</span>):</span><br><span class="line">            count=<span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> str_list:</span><br><span class="line">                <span class="keyword">if</span> i==<span class="string">&#x27;(&#x27;</span>:count+=<span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>:count-=<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> count&lt;<span class="number">0</span>:<span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span> count==<span class="number">0</span></span><br><span class="line">        res = [<span class="string">&quot;(&quot;</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>*n-<span class="number">1</span>):</span><br><span class="line">            cur_res = []</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> res:</span><br><span class="line">                cur_res.append(j+<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">                cur_res.append(j+<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">            res = cur_res</span><br><span class="line">        fin = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> res:</span><br><span class="line">            <span class="keyword">if</span> is_valid(i):</span><br><span class="line">                fin.append(i)</span><br><span class="line">        <span class="keyword">return</span> fin</span><br></pre></td></tr></table></figure>

<h3 id="方法二：递归"><a href="#方法二：递归" class="headerlink" title="方法二：递归"></a>方法二：递归</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generateParenthesis</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">generate</span>(<span class="params">A = []</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(A) == <span class="number">2</span>*n:</span><br><span class="line">                <span class="keyword">if</span> valid(A):</span><br><span class="line">                    ans.append(<span class="string">&quot;&quot;</span>.join(A))</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                A.append(<span class="string">&#x27;(&#x27;</span>)</span><br><span class="line">                generate(A)</span><br><span class="line">                A.pop()</span><br><span class="line">                A.append(<span class="string">&#x27;)&#x27;</span>)</span><br><span class="line">                generate(A)</span><br><span class="line">                A.pop()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">valid</span>(<span class="params">A</span>):</span><br><span class="line">            bal = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> c <span class="keyword">in</span> A:</span><br><span class="line">                <span class="keyword">if</span> c == <span class="string">&#x27;(&#x27;</span>: bal += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span>: bal -= <span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> bal &lt; <span class="number">0</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">return</span> bal == <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        ans = []</span><br><span class="line">        generate()</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

<h3 id="方法三：回溯"><a href="#方法三：回溯" class="headerlink" title="方法三：回溯"></a>方法三：回溯</h3><p>只加那些可能是正确的情况，不像前面两种方法枚举所有情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">generateParenthesis</span>(<span class="params">self, N</span>):</span><br><span class="line">        ans = []</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">backtrack</span>(<span class="params">S = <span class="string">&#x27;&#x27;</span>, left = <span class="number">0</span>, right = <span class="number">0</span></span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(S) == <span class="number">2</span> * N:</span><br><span class="line">                ans.append(S)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">if</span> left &lt; N:</span><br><span class="line">                backtrack(S+<span class="string">&#x27;(&#x27;</span>, left+<span class="number">1</span>, right)</span><br><span class="line">            <span class="keyword">if</span> right &lt; left:</span><br><span class="line">                backtrack(S+<span class="string">&#x27;)&#x27;</span>, left, right+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        backtrack()</span><br><span class="line">        <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>算法</category>
        <category>leetcode</category>
      </categories>
      <tags>
        <tag>leetcode</tag>
      </tags>
  </entry>
  <entry>
    <title>leetcode 322 解答--动态规划</title>
    <url>/2018/04/23/leetcode-322-%E8%A7%A3%E7%AD%94-%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/</url>
    <content><![CDATA[<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><p>给定不同面额的硬币(coins)和一个总金额(amount)。写一个函数来计算可以凑成总金额所需的最少的硬币个数。如果没有任何一种硬币组合方式能组成总金额，返回<code>-1</code>。</p>
<span id="more"></span>

<p><strong>示例 1:</strong><br>coins &#x3D; <code>[1, 2, 5]</code>, amount &#x3D; <code>11</code><br>return <code>3</code> (11 &#x3D; 5 + 5 + 1)</p>
<p><strong>示例 2:</strong><br>coins &#x3D; <code>[2]</code>, amount &#x3D; <code>3</code><br>return <code>-1</code>.</p>
<p><strong>注意</strong>:</p>
<p>你可以认为每种硬币的数量是无限的。</p>
<h2 id="解答"><a href="#解答" class="headerlink" title="解答"></a>解答</h2><p>动态规划的思路是用一个数组来存放需要的值，在零钱问题中，用dp[i]来表示凑齐钱数i所需要的最少硬币。</p>
<p>考虑凑齐钱数amount需要的最少硬币：如果需要<code>coin[j]</code> 硬币一枚，那么就相当于求<code>dp[amount-coin[j]]</code>，j的遍历范围是从0到<code>len(coin)-1</code> </p>
<p>本来我们应该要把所有dp赋值为正无穷，但是因为就算是最小的面值为1，那么组成amount也只需要amount枚硬币，因此我们把所有的值都赋值为amount+1，首先定义一个迭代的起始值，组成0元钱只需要0枚硬币，即dp[0]&#x3D;0</p>
<p>接下来开始遍历所有的coins，再遍历所有的dp，dp[i]应该等于自身和dp[i-c]+1当中小的那个，相当于用了一枚面值为c的硬币之后，dp[i-c]所用的最少的硬币，加上这一枚面值c硬币需要的总数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">coinChange</span>(<span class="params">self, coins, amount</span>):</span><br><span class="line">        dp = [amount+<span class="number">1</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(amount+<span class="number">1</span>)]</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> coins:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(c,amount+<span class="number">1</span>):</span><br><span class="line">                dp[i] = <span class="built_in">min</span>(dp[i],dp[i-c]+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span> <span class="keyword">if</span> dp[amount]==amount+<span class="number">1</span> <span class="keyword">else</span> dp[amount]</span><br></pre></td></tr></table></figure>



<p>变形：给定不同面额的硬币(coins)和一个总金额(amount)。写一个函数来计算可以凑成总金额可能的组合情况。如果没有任何一种硬币组合方式能组成总金额，返回0。</p>
<p>这里的区别和上面只是初始dp的方法和起始值dp[0]不同</p>
<p>此时的dp[0]&#x3D;1，因为用所有硬币组合成0元钱只有一种方法，那就是所有的硬币都取0枚</p>
<p>然后dp其余值初始化为0，因为一开始是没有组成后面的可能的，迭代条件变为dp[i] &#x3D; dp[i] + dp[i-c]，表示用一枚硬币c的时候，组合的情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">coinChange</span>(<span class="params">self, coins, amount</span>):</span><br><span class="line">        dp = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(amount+<span class="number">1</span>)]</span><br><span class="line">        dp[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> coins:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(c,amount+<span class="number">1</span>):</span><br><span class="line">                dp[i] += dp[i-c]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span> <span class="keyword">if</span> dp[amount]==amount+<span class="number">1</span> <span class="keyword">else</span> dp[amount]</span><br></pre></td></tr></table></figure>





<h3 id="循环数组的不相邻求和最大值"><a href="#循环数组的不相邻求和最大值" class="headerlink" title="循环数组的不相邻求和最大值"></a>循环数组的不相邻求和最大值</h3><p>因为结果不能同时包含最后一个值和第一个值，因此做两次调用，一次是1到最后，一次是0到倒数第二个，取其中最大值</p>
<p>迭代的条件是<code>dp[i] = max(my_list[i]+dp[i-2],dp[i-1])</code>，因为要么当前值加上跳过上一个值的和，要么不要当前值，要上一个值的和，取两者的最大值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sum_max</span>(<span class="params">my_list</span>):</span><br><span class="line">    dp = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> my_list]</span><br><span class="line">    dp[<span class="number">0</span>] = my_list[<span class="number">0</span>]</span><br><span class="line">    dp[<span class="number">1</span>] = <span class="built_in">max</span>(my_list[<span class="number">1</span>],my_list[<span class="number">0</span>])</span><br><span class="line">    dp[<span class="number">2</span>] = <span class="built_in">max</span>(my_list[<span class="number">1</span>],my_list[<span class="number">0</span>] + my_list[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>,<span class="built_in">len</span>(my_list)):</span><br><span class="line">        dp[i] = <span class="built_in">max</span>(my_list[i]+dp[i-<span class="number">2</span>],dp[i-<span class="number">1</span>])</span><br><span class="line">    <span class="comment"># if max(dp) == dp[i]:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">max</span>(dp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_list = [<span class="number">10</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">9</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">max</span>(sum_max(my_list=test_list[<span class="number">1</span>:]),sum_max(test_list[:-<span class="number">1</span>])))</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>编程练习</category>
      </categories>
      <tags>
        <tag>leetcode</tag>
        <tag>动态规划</tag>
      </tags>
  </entry>
  <entry>
    <title>java常见面试题</title>
    <url>/2018/03/15/java%E5%B8%B8%E8%A7%81%E9%9D%A2%E8%AF%95%E9%A2%98/</url>
    <content><![CDATA[<h4 id="1-面向对象特征"><a href="#1-面向对象特征" class="headerlink" title="1. 面向对象特征"></a>1. 面向对象特征</h4><span id="more"></span>

<p>封装，继承，多态和抽象</p>
<ol>
<li>封装<br>封装给对象提供了隐藏内部特性和行为的能力。对象提供一些能被其他对象访问的方法来改<br>变它内部的数据。在 Java 当中，有 3 种修饰符： public， private 和 protected。每一种修饰符<br>给其他的位于同一个包或者不同包下面对象赋予了不同的访问权限。<br>下面列出了使用封装的一些好处：<ul>
<li>通过隐藏对象的属性来保护对象内部的状态。</li>
<li>提高了代码的可用性和可维护性，因为对象的行为可以被单独的改变或者是扩展。</li>
<li>禁止对象之间的不良交互提高模块化</li>
</ul>
</li>
<li>继承：给对象提供了从基类获取字段和方法的能力。继承提供了代码的重用性，也可以在不修改类的情况下给现存的类添加新特性。</li>
<li>多态：是编程语言给不同的底层数据类型做相同的接口展示的一种能力。一个多态类型上的操作可以应用到其他类型的值上面。</li>
<li>抽象：是把想法从具体的实例中分离出来的步骤，因此，要根据他们的功能而不是实现细节来创建类。 Java 支持创建只暴漏接口而不包含方法实现的抽象的类。这种抽象技术的主要目的是把类的行为和实现细节分离开。</li>
</ol>
<h4 id="2-final-finally-finalize-的区别"><a href="#2-final-finally-finalize-的区别" class="headerlink" title="2. final, finally, finalize 的区别"></a>2. final, finally, finalize 的区别</h4><ol>
<li>final修饰符（关键字）如果一个类被声明为final，意味着它不能再派生出新的子类，不能作为父类被继承。因此一个类不能既被声明为 abstract的，又被声明为final的。将变量或方法声明为final，可以保证它们在使用中不被改变。被声明为final的变量必须在声明时给定初值，而在以后的引用中只能读取，不可修改。被声明为final的方法也同样只能使用（可以被继承，但不能被重写），同样也不能重载。</li>
<li>finally在异常处理时提供 finally 块来执行任何清除操作。如果抛出一个异常，那么相匹配的 catch 子句就会执行，然后控制就会进入 finally 块（如果有的话）。</li>
<li>finalize方法名。Java 技术允许使用 finalize() 方法在垃圾收集器将对象从内存中清除出去之前做必要的清理工作。这个方法是由垃圾收集器在确定这个对象没有被引用时对这个对象调用的。它是在 Object 类中定义的，因此所有的类都继承了它。子类覆盖 finalize() 方法以整理系统资源或者执行其他清理工作。finalize() 方法是在垃圾收集器删除对象之前对这个对象调用的。</li>
</ol>
<h4 id="3-int-和-Integer-有什么区别"><a href="#3-int-和-Integer-有什么区别" class="headerlink" title="3. int 和 Integer 有什么区别"></a>3. int 和 Integer 有什么区别</h4><p>int 是基本数据类型<br>Integer是其包装类，注意是一个类。</p>
<p>java包含8个基本类型：byte（字节型）、short（短整型）、int（整型）、long（长整型）、float（单精度浮点型）、double（双精度浮点型）、boolean（布尔型）、char（字符型）</p>
<p>为什么要提供包装类呢？？？<br>一是为了在各种类型间转化，通过各种方法的调用。否则 你无法直接通过变量转化。<br>比如，现在int要转为String</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> a=<span class="number">0</span>;</span><br><span class="line">String result=Integer.toString(a);</span><br></pre></td></tr></table></figure>

<p>在java中包装类，比较多的用途是用在于各种数据类型的转化中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> num=Integer.valueOf(<span class="string">&quot;12&quot;</span>);<span class="comment">// 返回包装类型</span></span><br><span class="line"><span class="type">int</span> num2=Integer.parseInt(<span class="string">&quot;12&quot;</span>); <span class="comment">//返回基本数据类型</span></span><br></pre></td></tr></table></figure>

<p>再举例下。比如我现在要用泛型</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Integer&gt; nums;</span><br></pre></td></tr></table></figure>

<p>这里&lt;&gt;需要类。如果你用int。它会报错的。</p>
<h4 id="4-重载和重写的区别"><a href="#4-重载和重写的区别" class="headerlink" title="4. 重载和重写的区别"></a>4. 重载和重写的区别</h4><p><strong>override（重写）</strong></p>
<ol>
<li><p>方法名、参数、返回值相同。</p>
</li>
<li><p>子类方法不能缩小父类方法的访问权限。</p>
</li>
<li><p>子类方法不能抛出比父类方法更多的异常(但子类方法可以不抛出异常)。</p>
</li>
<li><p>存在于父类和子类之间。</p>
</li>
<li><p>方法被定义为final不能被重写。</p>
</li>
</ol>
<p><strong>overload（重载）</strong></p>
<ol>
<li><p>参数类型、个数、顺序至少有一个不相同。</p>
</li>
<li><p>不能重载只有返回值不同的方法名。</p>
</li>
<li><p>存在于父类和子类、同类中。</p>
</li>
</ol>
<h4 id="5-抽象类和接口有什么区别"><a href="#5-抽象类和接口有什么区别" class="headerlink" title="5. 抽象类和接口有什么区别"></a>5. 抽象类和接口有什么区别</h4><p>总结：接口没有私有变量，接口可以用于实现多继承，实现接口必须实现所有其中定义的方法</p>
<p>接口是公开的，里面不能有私有的方法或变量，是用于让别人使用的，而抽象类是可以有私有方法或私有变量的，<br>另外，实现接口的一定要实现接口里定义的所有方法，而实现抽象类可以有选择地重写需要用到的方法，一般的应用里，最顶级的是接口，然后是抽象类实现接口，最后才到具体类实现。<br>还有，接口可以实现多重继承，而一个类只能继承一个超类，但可以通过继承多个接口实现多重继承，接口还有标识（里面没有任何方法，如Remote接口）和数据共享（里面的变量全是常量）的作用。</p>
<h4 id="6-说说反射的用途及实现"><a href="#6-说说反射的用途及实现" class="headerlink" title="6. 说说反射的用途及实现"></a>6. 说说反射的用途及实现</h4><p>Java 反射机制在程序<strong>运行时</strong>，对于任意一个类，都能够知道这个类的所有属性和方法；对于任意一个对象，都能够调用它的任意一个方法和属性。这种 <strong>动态的获取信息</strong> 以及 <strong>动态调用对象的方法</strong> 的功能称为 <strong>java 的反射机制</strong>。</p>
<p>Java反射机制主要提供了以下功能：在运行时构造一个类的对象；判断一个类所具有的成员变量和方法；调用一个对象的方法；生成动态代理。反射最大的应用就是框架</p>
<p>Java反射的主要功能：</p>
<ul>
<li>确定一个对象的类</li>
<li>取出类的modifiers,数据成员,方法,构造器,和超类.</li>
<li>找出某个接口里定义的常量和方法说明.</li>
<li>创建一个类实例,这个实例在运行时刻才有名字(运行时间才生成的对象).</li>
<li>取得和设定对象数据成员的值,如果数据成员名是运行时刻确定的也能做到.</li>
<li>在运行时刻调用动态对象的方法.</li>
<li>创建数组,数组大小和类型在运行时刻才确定,也能更改数组成员的值.</li>
</ul>
<p>反射的应用很多，很多框架都有用到</p>
<p>spring 的 ioc&#x2F;di 也是反射….<br>javaBean和jsp之间调用也是反射….<br>struts的 FormBean 和页面之间…也是通过反射调用….<br>JDBC 的 classForName()也是反射…..<br>hibernate的 find(Class clazz) 也是反射….</p>
<p>反射还有一个不得不说的问题，就是性能问题，大量使用反射系统性能大打折扣。怎么使用使你的系统达到最优就看你系统架构和综合使用问题啦，这里就不多说了。</p>
<h4 id="7-HTTP-请求的-GET-与-POST-方式的区别"><a href="#7-HTTP-请求的-GET-与-POST-方式的区别" class="headerlink" title="7. HTTP 请求的 GET 与 POST 方式的区别"></a>7. HTTP 请求的 GET 与 POST 方式的区别</h4><p>GET方法会把名值对追加在请求的URL后面。因为URL对字符数目有限制，进而限制了用在客户端请求的参数值的数目。并且请求中的参数值是可见的，因此，敏感信息不能用这种方式传递。</p>
<p>POST方法通过把请求参数值放在请求体中来克服GET方法的限制，因此，可以发送的参数的数目是没有限制的。最后，通过POST请求传递的敏感信息对外部客户端是不可见的。</p>
<h4 id="8-cookie-和session-的区别："><a href="#8-cookie-和session-的区别：" class="headerlink" title="8.cookie 和session 的区别："></a>8.cookie 和session 的区别：</h4><p>1、cookie数据存放在客户的浏览器上，session数据放在服务器上。</p>
<p>2、cookie不是很安全，别人可以分析存放在本地的COOKIE并进行COOKIE欺骗<br>   考虑到安全应当使用session。</p>
<p>3、session会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能<br>   考虑到减轻服务器性能方面，应当使用COOKIE。</p>
<p>4、单个cookie保存的数据不能超过4K，很多浏览器都限制一个站点最多保存20个cookie。</p>
<p>5、所以个人建议：<br>   将登陆信息等重要信息存放为SESSION<br>   其他信息如果需要保留，可以放在COOKIE中</p>
<p>具体来说cookie机制采用的是在客户端保持状态的方案，而session机制采用的是在服务器端保持状态的方案</p>
<h4 id="JDBC-流程"><a href="#JDBC-流程" class="headerlink" title="JDBC 流程"></a>JDBC 流程</h4><p><strong>1、 加载JDBC驱动程序：</strong><br>在连接数据库之前，首先要加载想要连接的数据库的驱动到JVM（Java虚拟机），<br>这通过java.lang.Class类的静态方法forName(String className)实现。</p>
<p><strong>2、 提供JDBC连接的URL</strong></p>
<ul>
<li>连接URL定义了连接数据库时的协议、子协议、数据源标识。</li>
<li>书写形式：协议：子协议：数据源标识</li>
</ul>
<p>协议：在JDBC中总是以jdbc开始 子协议：是桥连接的驱动程序或是数据库管理系统名称。<br>数据源标识：标记找到数据库来源的地址与连接端口。</p>
<p><strong>3、创建数据库的连接</strong></p>
<ul>
<li>要连接数据库，需要向java.sql.DriverManager请求并获得Connection对象， 该对象就代表一个数据库的连接。</li>
<li>使用DriverManager的getConnectin(String url , String username , String password )方法传入指定的欲连接的数据库的路径、数据库的用户名和 密码来获得。</li>
</ul>
<p><strong>4、 创建一个Statement</strong></p>
<p>要执行SQL语句，必须获得java.sql.Statement实例，Statement实例分为以下3 种类型：<br>1、执行静态SQL语句。通常通过Statement实例实现。<br>2、执行动态SQL语句。通常通过PreparedStatement实例实现。<br>3、执行数据库存储过程。通常通过CallableStatement实例实现。</p>
<p><strong>5、执行SQL语句</strong><br>Statement接口提供了三种执行SQL语句的方法：executeQuery 、executeUpdate 和execute<br>1、ResultSet executeQuery(String sqlString)：执行查询数据库的SQL语句 ，返回一个结果集（ResultSet）对象。<br>2、int executeUpdate(String sqlString)：用于执行INSERT、UPDATE或 DELETE语句以及SQL DDL语句，如：CREATE TABLE和DROP TABLE等<br>3、execute(sqlString):用于执行返回多个结果集、多个更新计数或二者组合的 语句。 具体实现的代码：</p>
<p><strong>6、处理结果</strong><br>两种情况：<br>1、执行更新返回的是本次操作影响到的记录数。<br>2、执行查询返回的结果是一个ResultSet对象。</p>
<p><strong>7、关闭JDBC对象</strong><br>操作完成以后要把所有使用的JDBC对象全都关闭，以释放JDBC资源，关闭顺序和声 明顺序相反：<br>1、关闭记录集<br>2、关闭声明<br>3、关闭连接对象</p>
<h4 id="MVC-设计思想"><a href="#MVC-设计思想" class="headerlink" title="MVC 设计思想"></a>MVC 设计思想</h4><p>MVC就是<br>M:Model 模型<br>V:View 视图<br>C:Controller 控制器<br>模型就是封装业务逻辑和数据的一个一个的模块,控制器就是调用这些模块的(java中通常是用Servlet来实现,框架的话很多是用Struts2来实现这一层),视图就主要是你看到的,比如JSP等.<br>当用户发出请求的时候,控制器根据请求来选择要处理的业务逻辑和要选择的数据,再返回去把结果输出到视图层,这里可能是进行重定向或转发等.</p>
<h4 id="equals-与-x3D-x3D-的区别"><a href="#equals-与-x3D-x3D-的区别" class="headerlink" title="equals 与 &#x3D;&#x3D; 的区别"></a>equals 与 &#x3D;&#x3D; 的区别</h4><p>值类型（int,char,long,boolean等）都是用&#x3D;&#x3D;判断相等性。对象引用的话，&#x3D;&#x3D;判断引用所指的对象是否是同一个。</p>
<p>equals是Object的成员函数，有些类会覆盖（override）这个方法，用于判断对象的等价性。例如String类，两个引用所指向的String都是”abc”，但可能出现他们实际对应的对象并不是同一个（和jvm实现方式有关），因此用&#x3D;&#x3D;判断他们可能不相等，但用equals判断一定是相等的。</p>
<h3 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h3><h4 id="List-和-Set-区别"><a href="#List-和-Set-区别" class="headerlink" title="List 和 Set 区别"></a>List 和 Set 区别</h4><p>List,Set都是继承自Collection接口</p>
<p>List特点：元素有放入顺序，元素可重复</p>
<p>Set特点：元素无放入顺序，元素不可重复，重复元素会覆盖掉</p>
<p>（注意：元素虽然无放入顺序，但是元素在set中的位置是有该元素的HashCode决定的，其位置其实是固定的，加入Set 的Object必须定义equals()方法 ，另外list支持for循环，也就是通过下标来遍历，也可以用迭代器，但是set只能用迭代，因为他无序，无法用下标来取得想要的值。）</p>
<p>Set和List对比：</p>
<p>Set：检索元素效率低下，删除和插入效率高，插入和删除不会引起元素位置改变。</p>
<p>List：和数组类似，List可以动态增长，查找元素效率高，插入删除元素效率低，因为会引起其他元素位置改变。</p>
<h4 id="List-和-Map-区别"><a href="#List-和-Map-区别" class="headerlink" title="List 和 Map 区别"></a>List 和 Map 区别</h4><p>List是对象集合，允许对象重复。</p>
<p>Map是键值对的集合，不允许key重复。</p>
<h4 id="Arraylist-与-LinkedList-区别"><a href="#Arraylist-与-LinkedList-区别" class="headerlink" title="Arraylist 与 LinkedList 区别"></a>Arraylist 与 LinkedList 区别</h4><p><strong>Arraylist</strong>：</p>
<p>优点：ArrayList是实现了基于动态数组的数据结构,因为地址连续，一旦数据存储好了，查询操作效率会比较高（在内存里是连着放的）。</p>
<p>缺点：因为地址连续， ArrayList要移动数据，所以插入和删除操作效率比较低。</p>
<p><strong>LinkedList</strong>：</p>
<p>优点：LinkedList基于链表的数据结构,地址是任意的，所以在开辟内存空间的时候不需要等一个连续的地址，对于新增和删除操作add和remove，LinedList比较占优势。LinkedList 适用于要头尾操作或插入指定位置的场景</p>
<p>缺点：因为LinkedList要移动指针,所以查询操作性能比较低。</p>
<p><strong>适用场景分析：</strong></p>
<p>当需要对数据进行顺序访问的情况下选用ArrayList，当需要对数据进行多次增加删除修改时采用LinkedList。</p>
<h4 id="ArrayList-与-Vector-区别"><a href="#ArrayList-与-Vector-区别" class="headerlink" title="ArrayList 与 Vector 区别"></a>ArrayList 与 Vector 区别</h4><p>ArrayList和Vector都是用数组实现的，主要有这么三个区别：</p>
<ol>
<li>Vector是多线程安全的，线程安全就是说多线程访问同一代码，不会产生不确定的结果。而ArrayList不是，这个可以从源码中看出，Vector类中的方法很多有synchronized进行修饰，这样就导致了Vector在效率上无法与ArrayList相比；</li>
<li>两个都是采用的线性连续空间存储元素，但是当空间不足的时候，两个类的增加方式是不同。</li>
<li>Vector可以设置增长因子，而ArrayList不可以。</li>
<li>Vector是一种老的动态数组，是线程同步的，效率很低，一般不赞成使用。</li>
</ol>
<p><strong>适用场景分析</strong>：</p>
<ol>
<li>Vector是线程同步的，所以它也是线程安全的，而ArrayList是线程异步的，是不安全的。如果不考虑到线程的安全因素，一般用ArrayList效率比较高。</li>
<li>如果集合中的元素的数目大于目前集合数组的长度时，在集合中使用数据量比较大的数据，用Vector有一定的优势。</li>
</ol>
<h4 id="HashMap-和-Hashtable-的区别"><a href="#HashMap-和-Hashtable-的区别" class="headerlink" title="HashMap 和 Hashtable 的区别"></a>HashMap 和 Hashtable 的区别</h4><p>1.hashMap去掉了HashTable 的contains方法，但是加上了containsValue（）和containsKey（）方法。</p>
<p>2.hashTable同步的，而HashMap是非同步的，效率上比hashTable要高。</p>
<p>3.hashMap允许空键值，而hashTable不允许。</p>
<p>注意：TreeMap：非线程安全基于红黑树实现。TreeMap没有调优选项，因为该树总处于平衡状态。</p>
<p>Treemap：适用于按自然顺序或自定义顺序遍历键(key)。</p>
<h4 id="HashSet-和-HashMap-区别"><a href="#HashSet-和-HashMap-区别" class="headerlink" title="HashSet 和 HashMap 区别"></a>HashSet 和 HashMap 区别</h4><p>set是线性结构，set中的值不能重复，hashset是set的hash实现，hashset中值不能重复是用hashmap的key来实现的。</p>
<p>map是键值对映射，可以空键空值。HashMap是Map接口的hash实现，key的唯一性是通过key值hash值的唯一来确定，value值是则是链表结构。</p>
<p>他们的共同点都是hash算法实现的唯一性，他们都不能持有基本类型，只能持有对象</p>
<h4 id="HashMap-和-ConcurrentHashMap-的区别"><a href="#HashMap-和-ConcurrentHashMap-的区别" class="headerlink" title="HashMap 和 ConcurrentHashMap 的区别"></a>HashMap 和 ConcurrentHashMap 的区别</h4><p>ConcurrentHashMap是线程安全的HashMap的实现。</p>
<p>（1）ConcurrentHashMap对整个桶数组进行了分割分段(Segment)，然后在每一个分段上都用lock锁进行保护，相对于HashTable的syn关键字锁的粒度更精细了一些，并发性能更好，而HashMap没有锁机制，不是线程安全的。</p>
<p>（2）HashMap的键值对允许有null，但是ConCurrentHashMap都不允许。</p>
<h4 id="ConcurrentHashMap-的工作原理及代码实现"><a href="#ConcurrentHashMap-的工作原理及代码实现" class="headerlink" title="ConcurrentHashMap 的工作原理及代码实现"></a>ConcurrentHashMap 的工作原理及代码实现</h4><p>HashTable里使用的是synchronized关键字，这其实是对对象加锁，锁住的都是对象整体，当Hashtable的大小增加到一定的时候，性能会急剧下降，因为迭代时需要被锁定很长的时间。</p>
<p>ConcurrentHashMap引入了分割(Segment)，在put方法中，会根据hash(paramK.hashCode())来决定具体存放进哪个Segment，如果查看Segment的put操作，我们会发现内部使用的同步机制是基于lock操作的，这样就可以对Map的一部分（Segment）进行上锁，这样影响的只是将要放入同一个Segment的元素的put操作，保证同步的时候，锁住的不是整个Map（HashTable就是这么做的），相对于HashTable提高了多线程环境下的性能，因此HashTable已经被淘汰了。</p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><h4 id="创建线程的方式及实现"><a href="#创建线程的方式及实现" class="headerlink" title="创建线程的方式及实现"></a>创建线程的方式及实现</h4><p>Java中创建线程主要有三种方式：</p>
<p><strong>一、继承Thread类创建线程类</strong></p>
<p>（1）定义Thread类的子类，并重写该类的run方法，该run方法的方法体就代表了线程要完成的任务。因此把run()方法称为执行体。</p>
<p>（2）创建Thread子类的实例，即创建了线程对象。</p>
<p>（3）调用线程对象的start()方法来启动该线程。</p>
<p><strong>二、通过Runnable接口创建线程类</strong></p>
<p>（1）定义runnable接口的实现类，并重写该接口的run()方法，该run()方法的方法体同样是该线程的线程执行体。</p>
<p>（2）创建 Runnable实现类的实例，并依此实例作为Thread的target来创建Thread对象，该Thread对象才是真正的线程对象。</p>
<p>（3）调用线程对象的start()方法来启动该线程。</p>
<p><strong>三、通过Callable和FutureTask创建线程</strong></p>
<p>（1）创建Callable接口的实现类，并实现call()方法，该call()方法将作为线程执行体，并且有返回值。</p>
<p>（2）创建Callable实现类的实例，使用FutureTask类来包装Callable对象，该FutureTask对象封装了该Callable对象的call()方法的返回值。</p>
<p>（3）使用FutureTask对象作为Thread对象的target创建并启动新线程。</p>
<p>（4）调用FutureTask对象的get()方法来获得子线程执行结束后的返回值</p>
<p><strong>创建线程的三种方式的对比</strong></p>
<p>采用实现Runnable、Callable接口的方式创见多线程时，优势是：</p>
<p>线程类只是实现了Runnable接口或Callable接口，还可以继承其他类。</p>
<p>在这种方式下，多个线程可以共享同一个target对象，所以非常适合多个相同线程来处理同一份资源的情况，从而可以将CPU、代码和数据分开，形成清晰的模型，较好地体现了面向对象的思想。</p>
<p>劣势是：</p>
<p>编程稍微复杂，如果要访问当前线程，则必须使用Thread.currentThread()方法。</p>
<p>使用继承Thread类的方式创建多线程时优势是：</p>
<p>编写简单，如果需要访问当前线程，则无需使用Thread.currentThread()方法，直接使用this即可获得当前线程。</p>
<p>劣势是：</p>
<p>线程类已经继承了Thread类，所以不能再继承其他父类。</p>
<h4 id="sleep-、yield（）、join（）有什么区别"><a href="#sleep-、yield（）、join（）有什么区别" class="headerlink" title="sleep() 、yield（）、join（）有什么区别"></a>sleep() 、yield（）、join（）有什么区别</h4><p><strong>1、sleep()方法</strong></p>
<p>在指定的毫秒数内让当前正在执行的线程休眠（暂停执行），此操作受到系统计时器和调度程序精度和准确性的影响。 让其他线程有机会继续执行，但它并不释放对象锁。也就是如果有Synchronized同步块，其他线程仍然不能访问共享数据。注意该方法要捕获异常</p>
<p>比如有两个线程同时执行(没有Synchronized)，一个线程优先级为MAX_PRIORITY，另一个为MIN_PRIORITY，如果没有Sleep()方法，只有高优先级的线程执行完成后，低优先级的线程才能执行；但当高优先级的线程sleep(5000)后，低优先级就有机会执行了。总之，sleep()可以使低优先级的线程得到执行的机会，当然也可以让同优先级、高优先级的线程有执行的机会。</p>
<p><strong>2、yield()方法</strong></p>
<p>yield()方法和sleep()方法类似，也不会释放“锁标志”，区别在于，它没有参数，即yield()方法只是使当前线程重新回到可执行状态，所以执行yield()的线程有可能在进入到可执行状态后马上又被执行，另外yield()方法只能使同优先级或者高优先级的线程得到执行机会，这也和sleep()方法不同。</p>
<p><strong>线程的sleep()方法和yield()方法有什么区别？</strong></p>
<p>答：</p>
<p>① sleep()方法给其他线程运行机会时不考虑线程的优先级，因此会给低优先级的线程以运行的机会；yield()方法只会给相同优先级或更高优先级的线程以运行的机会；</p>
<p>② 线程执行sleep()方法后转入阻塞（blocked）状态，而执行yield()方法后转入就绪（ready）状态；</p>
<p>③ sleep()方法声明抛出InterruptedException，而yield()方法没有声明任何异常； </p>
<p>④ sleep()方法比yield()方法（跟操作系统CPU调度相关）具有更好的可移植性。</p>
<p><strong>3、join()方法</strong></p>
<p>Thread的非静态方法join()让一个线程B“加入”到另外一个线程A的尾部。在A执行完毕之前，B不能工作。</p>
<h4 id="讲讲线程池的实现原理"><a href="#讲讲线程池的实现原理" class="headerlink" title="讲讲线程池的实现原理"></a>讲讲线程池的实现原理</h4><p>主要是ThreadPoolExecutor的实现原理，在面向对象编程中，创建和销毁对象是很费时间的，因为创建一个对象要获取内存资源或者其它更多资源。在Java中更是如此，虚拟机将试图跟踪每一个对象，以便能够在对象销毁后进行垃圾回收。所以提高服务程序效率的一个手段就是尽可能减少创建和销毁对象的次数，特别是一些很耗资源的对象创建和销毁，这就是”池化资源”技术产生的原因。线程池顾名思义就是事先创建若干个可执行的线程放入一个池（容器）中，需要的时候从池中获取线程不用自行创建，使用完毕不需要销毁线程而是放回池中，从而减少创建和销毁线程对象的开销。</p>
<h4 id="线程池的几种方式"><a href="#线程池的几种方式" class="headerlink" title="线程池的几种方式"></a>线程池的几种方式</h4><p>newFixedThreadPool(int nThreads)<br>创建一个固定长度的线程池，每当提交一个任务就创建一个线程，直到达到线程池的最大数量，这时线程规模将不再变化，当线程发生未预期的错误而结束时，线程池会补充一个新的线程</p>
<p>newCachedThreadPool()<br>创建一个可缓存的线程池，如果线程池的规模超过了处理需求，将自动回收空闲线程，而当需求增加时，则可以自动添加新线程，线程池的规模不存在任何限制</p>
<p>newSingleThreadExecutor()<br>这是一个单线程的Executor，它创建单个工作线程来执行任务，如果这个线程异常结束，会创建一个新的来替代它；它的特点是能确保依照任务在队列中的顺序来串行执行</p>
<p>newScheduledThreadPool(int corePoolSize)<br>创建了一个固定长度的线程池，而且以延迟或定时的方式来执行任务，类似于Timer。</p>
<h4 id="线程的生命周期"><a href="#线程的生命周期" class="headerlink" title="线程的生命周期"></a>线程的生命周期</h4><p>新建(New)、就绪（Runnable）、运行（Running）、 阻塞(Blocked)和死亡(Dead)5种状态</p>
<p>(1)生命周期的五种状态</p>
<p><strong>新建（new Thread）</strong><br>当创建Thread类的一个实例（对象）时，此线程进入新建状态（未被启动）。<br>例如：Thread t1&#x3D;new Thread();</p>
<p><strong>就绪（runnable）</strong><br>线程已经被启动，正在等待被分配给CPU时间片，也就是说此时线程正在就绪队列中排队等候得到CPU资源。例如：t1.start();</p>
<p><strong>运行（running）</strong><br>线程获得CPU资源正在执行任务（run()方法），此时除非此线程自动放弃CPU资源或者有优先级更高的线程进入，线程将一直运行到结束。</p>
<p><strong>死亡（dead）</strong><br>当线程执行完毕或被其它线程杀死，线程就进入死亡状态，这时线程不可能再进入就绪状态等待执行。</p>
<p>自然终止：正常运行run()方法后终止</p>
<p>异常终止：调用stop()方法让一个线程终止运行</p>
<p><strong>堵塞（blocked）</strong><br>由于某种原因导致正在运行的线程让出CPU并暂停自己的执行，即进入堵塞状态。</p>
<p>正在睡眠：用sleep(long t) 方法可使线程进入睡眠方式。一个睡眠着的线程在指定的时间过去可进入就绪状态。</p>
<p>正在等待：调用wait()方法。（调用notify()方法回到就绪状态）</p>
<p>被另一个线程所阻塞：调用suspend()方法。（调用resume()方法恢复）</p>
<h3 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h3><h4 id="说说线程安全问题"><a href="#说说线程安全问题" class="headerlink" title="说说线程安全问题"></a>说说线程安全问题</h4><p>线程安全是指要控制多个线程对某个资源的有序访问或修改，而在这些线程之间没有产生冲突。<br>在Java里，线程安全一般体现在两个方面：<br>1、多个thread对同一个java实例的访问（read和modify）不会相互干扰。</p>
<p>它主要体现在关键字synchronized。如ArrayList和Vector，HashMap和Hashtable（后者每个方法前都有synchronized关键字）。如果你在interator一个List对象时，其它线程remove一个element，问题就出现了。<br>2、每个线程都有自己的字段，而不会在多个线程之间共享。</p>
<p>它主要体现在java.lang.ThreadLocal类，而没有Java关键字支持，如像static、transient那样。</p>
<h4 id="悲观锁-乐观锁"><a href="#悲观锁-乐观锁" class="headerlink" title="悲观锁 乐观锁"></a>悲观锁 乐观锁</h4><p>乐观锁 悲观锁是一种思想。可以用在很多方面。</p>
<p>比如数据库方面。<br>悲观锁就是for update（锁定查询的行）<br>乐观锁就是 version字段（比较跟上一次的版本号，如果一样则更新，如果失败则要重复读-比较-写的操作。）</p>
<p>JDK方面：<br>悲观锁就是sync<br>乐观锁就是原子类（内部使用CAS实现）</p>
<p>本质来说，就是悲观锁认为总会有人抢我的。乐观锁就认为，基本没人抢。</p>
<h4 id="CAS-乐观锁"><a href="#CAS-乐观锁" class="headerlink" title="CAS 乐观锁"></a>CAS 乐观锁</h4><p>乐观锁是一种思想，即认为读多写少，遇到并发写的可能性比较低，所以采取在写时先读出当前版本号，然后加锁操作（比较跟上一次的版本号，如果一样则更新），如果失败则要重复读-比较-写的操作。</p>
<p>CAS是一种更新的原子操作，比较当前值跟传入值是否一样，一样则更新，否则失败。CAS顶多算是乐观锁写那一步操作的一种实现方式罢了，不用CAS自己加锁也是可以的。</p>
<h4 id="ABA-问题"><a href="#ABA-问题" class="headerlink" title="ABA 问题"></a>ABA 问题</h4><p>ABA：如果另一个线程修改V值假设原来是A，先修改成B，再修改回成A，当前线程的CAS操作无法分辨当前V值是否发生过变化。</p>
<p>乐观锁（Optimistic Lock）：每次获取数据的时候，都不会担心数据被修改，所以每次获取数据的时候都不会进行加锁，但是在更新数据的时候需要判断该数据是否被别人修改过。如果数据被其他线程修改，则不进行数据更新，如果数据没有被其他线程修改，则进行数据更新。由于数据没有进行加锁，期间该数据可以被其他线程进行读写操作。</p>
<p>乐观锁：比较适合读取操作比较频繁的场景，如果出现大量的写入操作，数据发生冲突的可能性就会增大，为了保证数据的一致性，应用层需要不断的重新获取数据，这样会增加大量的查询操作，降低了系统的吞吐量。</p>
<h4 id="1-什么是Java虚拟机？为什么Java被称作是“平台无关的编程语言”？"><a href="#1-什么是Java虚拟机？为什么Java被称作是“平台无关的编程语言”？" class="headerlink" title="1.什么是Java虚拟机？为什么Java被称作是“平台无关的编程语言”？"></a>1.什么是Java虚拟机？为什么Java被称作是“平台无关的编程语言”？</h4><p>Java 虚拟机是一个可以执行 Java 字节码的虚拟机进程。Java 源文件被编译成能被 Java 虚拟机执行的字节码文件。</p>
<p> Java 被设计成允许应用程序可以运行在任意的平台，而不需要程序员为每一个平台单独重写或者是重新编译。</p>
<p> Java 虚拟机让这个变为可能，因为它知道底层硬件平台的指令长度和其他特性。</p>
<h4 id="2-JDK和JRE的区别是什么？"><a href="#2-JDK和JRE的区别是什么？" class="headerlink" title="2.JDK和JRE的区别是什么？"></a>2.JDK和JRE的区别是什么？</h4><p>JDK: java开发工具包,包含了JRE、编译器和其它工具（如：javaDOc、java调试器)</p>
<p>JRE: java运行环境,包含java虚拟机和java程序所需的核心类库。</p>
<p>如果只是想跑java程序，那么只需安装JRE，如果要写java程序并且运行，那就需要JDK了。</p>
<h4 id="3-”static”关键字是什么意思？Java中是否可以覆盖一个private或者是static的方法？"><a href="#3-”static”关键字是什么意思？Java中是否可以覆盖一个private或者是static的方法？" class="headerlink" title="3.”static”关键字是什么意思？Java中是否可以覆盖一个private或者是static的方法？"></a>3.”static”关键字是什么意思？Java中是否可以覆盖一个private或者是static的方法？</h4><p>如果一个类的变量或者方法前面有<strong>static</strong>修饰，那么表明这个方法或者变量属于这个类，也就是说可以在不创建对象的情况下直接使用</p>
<p> 当父类的方法被<strong>private</strong>修饰时，表明该方法为父类私有，对其他任何类都是不可见的，因此如果子类定了一个与父类一样的方法，这对于子类来说相当于是一个新的私有方法，且如果要进行向上转型，然后去调用该“覆盖方法”，会产生编译错误。</p>
<p>static方法也是不能覆盖的，就算覆盖了父类的static方法，也没有多态的效果，因此不算是覆盖。</p>
<h4 id="4-Java支持的基本数据类型有哪些？什么是自动拆装箱？"><a href="#4-Java支持的基本数据类型有哪些？什么是自动拆装箱？" class="headerlink" title="4.Java支持的基本数据类型有哪些？什么是自动拆装箱？"></a>4.Java支持的基本数据类型有哪些？什么是自动拆装箱？</h4><p>java支持的基本数据类型有以下9种:byte,short,int,long,float,double,char,boolean,void.</p>
<p>自动拆装箱是java从jdk1.5引用，目的是将原始类型自动的装换为相对应的对象，也可以逆向进行，即拆箱。这也体现java中一切皆对象的宗旨。</p>
<p>所谓自动装箱就是将原始类型自动的转换为对应的对象，而拆箱就是将对象类型转换为基本类型。java中的自动拆装箱通常发生在变量赋值的过程中。</p>
<h4 id="5-重写和重载是什么"><a href="#5-重写和重载是什么" class="headerlink" title="5. 重写和重载是什么?"></a>5. 重写和重载是什么?</h4><p><strong>重写</strong>，发生在子类与父类之间，表示子类中的方法可以与父类中的某个方法的名称和参数完全相同，通过子类创建的实例对象调用这个方法时，将调用子类中的定义方法，这相当于把父类中定义的那个完全相同的方法给覆盖了，这也是面向对象编程的多态性的一种表现。</p>
<p><strong>重载</strong>是指在一个类中，可以有多个相同名称的方法，但是他们的参数列表的个数或类型不同，当调用该方法时，根据传递的参数类型调用对应参数列表的方法。当参数列表相同但返回值不同时，将会出现编译错误，这并不是重载，因为jvm无法根据返回值类型来判断应该调用哪个方法。</p>
<h4 id="6-Java支持多继承么？如果不支持，如何实现"><a href="#6-Java支持多继承么？如果不支持，如何实现" class="headerlink" title="6.Java支持多继承么？如果不支持，如何实现?"></a>6.Java支持多继承么？如果不支持，如何实现?</h4><p>在java中是单继承的，也就是说一个类只能继承一个父类。</p>
<p>java中实现多继承有两种方式,一是接口，而是内部类.</p>
<h3 id="7-什么是值传递和引用传递？java中是值传递还是引用传递，还是都有"><a href="#7-什么是值传递和引用传递？java中是值传递还是引用传递，还是都有" class="headerlink" title="7.什么是值传递和引用传递？java中是值传递还是引用传递，还是都有?"></a>7.什么是值传递和引用传递？java中是值传递还是引用传递，还是都有?</h3><p><strong>值传递</strong> 就是在方法调用的时候，实参是将自己的一份拷贝赋给形参，在方法内，对该参数值的修改不影响原来实参，常见的例子就是刚开始学习c语言的时候那个交换方法的例子了。</p>
<p><strong>引用传递</strong> 是在方法调用的时候，实参将自己的地址传递给形参，此时方法内对该参数值的改变，就是对该实参的实际操作。</p>
<p>在java中只有值传递。</p>
<h4 id="8-接口和抽象类的区别是什么"><a href="#8-接口和抽象类的区别是什么" class="headerlink" title="8.接口和抽象类的区别是什么?"></a>8.接口和抽象类的区别是什么?</h4><p>区别：</p>
<ol>
<li><p>接口中所有的方法隐含的都是抽象的。而抽象类则可以同时包含抽象和非抽象的方法。</p>
</li>
<li><p>类可以实现很多个接口，但是只能继承一个抽象类</p>
</li>
<li><p>类如果要实现一个接口，它必须要实现接口声明的所有方法。但是，类可以不实现抽象类声明的所有方法，当然，在这种情况下，类也必须得声明成是抽象的。</p>
</li>
<li><p>抽象类可以在不提供接口方法实现的情况下实现接口。</p>
</li>
<li><p>Java 接口中声明的变量默认都是 final 的。抽象类可以包含非 final 的变量。</p>
</li>
<li><p>Java 接口中的成员函数默认是 public 的。抽象类的成员函数可以是 private，protected 或者是 public 。</p>
</li>
<li><p>接口是绝对抽象的，不可以被实例化(java 8已支持在接口中实现默认的方法)。抽象类也不可以被实例化，但是，如果它包含 main 方法的话是可以被调用的。</p>
</li>
</ol>
<p>####9.构造器（constructor）是否可被重写（override）?<br>构造方法不能被子类继承，所以是不能被子类重写的，但是构造方法可以重载，也就是说一个类可以有多个构造方法。</p>
<h4 id="10-Math-round-11-5-等于多少-Math-round-11-5-等于多少"><a href="#10-Math-round-11-5-等于多少-Math-round-11-5-等于多少" class="headerlink" title="10.Math.round(11.5) 等于多少? Math.round(-11.5)等于多少?"></a>10.Math.round(11.5) 等于多少? Math.round(-11.5)等于多少?</h4><p>Math.round(11.5)&#x3D;&#x3D;12 Math.round(-11.5)&#x3D;&#x3D;-11 round 方法返回与参数 最接近的长整数，参数加 1&#x2F;2 后求其 floor.</p>
<h4 id="11-String-StringBuffer-StringBuilder的区别。"><a href="#11-String-StringBuffer-StringBuilder的区别。" class="headerlink" title="11. String, StringBuffer StringBuilder的区别。"></a>11. String, StringBuffer StringBuilder的区别。</h4><p>String 的长度是不可变的；</p>
<p>StringBuffer的长度是可变的，如果你对字符串中的内容经常进行操作，特别是内容要修改时，那么使用 StringBuffer，如果最后需要 &gt;String，那么使用 StringBuffer 的 toString() 方法；线程安全；</p>
<p>StringBuilder 是从 JDK 5 开始，为StringBuffer该类补充了一个单个线程使用的等价类；通常应该优先使用 StringBuilder 类，因为它支持所有相同的操作，但由于它不执行同步（线程不安全），所以速度更快。</p>
<p>使用字符串的时候要特别小心，如果对一个字符串要经常改变的话，就一定不要用String,否则会创建许多无用的对象出来.</p>
<h4 id="12-JVM内存分哪几个区，每个区的作用是什么"><a href="#12-JVM内存分哪几个区，每个区的作用是什么" class="headerlink" title="12.JVM内存分哪几个区，每个区的作用是什么?"></a>12.JVM内存分哪几个区，每个区的作用是什么?</h4><p>java虚拟机主要分为以下五个区: 方虚本程堆</p>
<p><strong>方法区：</strong></p>
<ol>
<li>有时候也称为<strong>永久代</strong>，在该区内很少发生垃圾回收，但是并不代表不发生GC，在这里进行的GC主要是对方法区里的常量池和对类型的卸载</li>
<li>方法区主要用来存储已被虚拟机加载的类的信息、常量、静态变量和即时编译器编译后的代码等数据。</li>
<li>该区域是被线程共享的。</li>
<li>方法区里有一个运行时常量池，用于存放静态编译产生的字面量和符号引用。该常量池具有动态性，也就是说常量并不一定是编译时确定，运行时生成的常量也会存在这个常量池中。</li>
</ol>
<p><strong>虚拟机栈:</strong></p>
<ol>
<li>虚拟机栈也就是我们平常所称的<strong>栈内存</strong>,它为java方法服务，每个方法在执行的时候都会创建一个栈帧，用于存储局部变量表、操作数栈、动态链接和方法出口等信息。</li>
<li>虚拟机栈是线程私有的，它的生命周期与线程相同。</li>
<li>局部变量表里存储的是基本数据类型、returnAddress类型（指向一条字节码指令的地址）和对象引用，这个对象引用有可能是指向对象起始地址的一个指针，也有可能是代表对象的句柄或者与对象相关联的位置。局部变量所需的内存空间在编译器间确定</li>
<li>操作数栈的作用主要用来存储运算结果以及运算的操作数，它不同于局部变量表通过索引来访问，而是压栈和出栈的方式</li>
<li>每个栈帧都包含一个指向运行时常量池中该栈帧所属方法的引用，持有这个引用是为了支持方法调用过程中的动态连接.动态链接就是将常量池中的符号引用在运行期转化为直接引用。</li>
</ol>
<p><strong>本地方法栈</strong></p>
<p>本地方法栈和虚拟机栈类似，只不过本地方法栈为Native方法服务。</p>
<p><strong>堆</strong></p>
<p> java堆是所有线程所共享的一块内存，在虚拟机启动时创建，几乎所有的对象实例都在这里创建，因此该区域经常发生垃圾回收操作。</p>
<p><strong>程序计数器</strong></p>
<p>内存空间小，字节码解释器工作时通过改变这个计数值可以选取下一条需要执行的字节码指令，分支、循环、跳转、异常处理和线程恢复等功能都需要依赖这个计数器完成。该内存区域是唯一一个java虚拟机规范没有规定任何out of memory情况的区域。</p>
<h3 id="13-如何判断一个对象是否存活-或者GC对象的判定方法"><a href="#13-如何判断一个对象是否存活-或者GC对象的判定方法" class="headerlink" title="13.如何判断一个对象是否存活?(或者GC对象的判定方法)"></a>13.如何判断一个对象是否存活?(或者GC对象的判定方法)</h3><p>判断一个对象是否存活有两种方法:</p>
<p> <strong>引用计数法</strong></p>
<p>所谓引用计数法就是给每一个对象设置一个引用计数器，每当有一个地方引用这个对象时，就将计数器加一，引用失效时，计数器就减一。当一个对象的引用计数器为零时，说明此对象没有被引用，也就是“死对象”,将会被垃圾回收.</p>
<p>引用计数法有一个缺陷就是无法解决循环引用问题，也就是说当对象A引用对象B，对象B又引用者对象A，那么此时A,B对象的引用计数器都不为零，也就造成无法完成垃圾回收，所以主流的虚拟机都没有采用这种算法。</p>
<p>2.<strong>可达性算法</strong>(引用链法)</p>
<p>该算法的思想是：从一个被称为<strong>GC Roots</strong>的对象开始向下搜索，如果一个对象到GC Roots没有任何引用链相连时，则说明此对象不可用。</p>
<p>在java中可以作为GC Roots的对象有以下几种:</p>
<p>虚拟机栈中引用的对象<br>方法区类静态属性引用的对象<br>方法区常量池引用的对象<br>本地方法栈JNI引用的对象</p>
<h3 id="14-简述java垃圾回收机制"><a href="#14-简述java垃圾回收机制" class="headerlink" title="14.简述java垃圾回收机制?"></a>14.简述java垃圾回收机制?</h3><p>在java中，程序员是不需要显示的去释放一个对象的内存的，而是由虚拟机自行执行。在JVM中，有一个垃圾回收线程，它是低优先级的，在正常情况下是不会执行的，只有在虚拟机空闲或者当前堆内存不足时，才会触发执行，扫面那些没有被任何引用的对象，并将它们添加到要回收的集合中，进行回收。</p>
<h3 id="15-java中垃圾回收的方法有哪些"><a href="#15-java中垃圾回收的方法有哪些" class="headerlink" title="15.java中垃圾回收的方法有哪些?"></a>15.java中垃圾回收的方法有哪些?</h3><ol>
<li><p><strong>标记-清除:</strong></p>
<p> 这是垃圾收集算法中最基础的，根据名字就可以知道，它的思想就是标记哪些要被回收的对象，然后统一回收。这种方法很简单，但是会有两个主要问题：1.效率不高，标记和清除的效率都很低；2.会产生大量不连续的内存碎片，导致以后程序在分配较大的对象时，由于没有充足的连续内存而提前触发一次GC动作。</p>
</li>
<li><p><strong>复制算法:</strong></p>
<p> 为了解决效率问题，复制算法将可用内存按容量划分为相等的两部分，然后每次只使用其中的一块，当一块内存用完时，就将还存活的对象复制到第二块内存上，然后一次性清除完第一块内存，再将第二块上的对象复制到第一块。但是这种方式，内存的代价太高，每次基本上都要浪费一半的内存。</p>
<p> 于是将该算法进行了改进，内存区域不再是按照1：1去划分，而是将内存划分为8:1:1三部分，较大那份内存交Eden区，其余是两块较小的内存区叫Survior区。每次都会优先使用Eden区，若Eden区满，就将对象复制到第二块内存区上，然后清除Eden区，如果此时存活的对象太多，以至于Survivor不够时，会将这些对象通过分配担保机制复制到老年代中。(java堆又分为新生代和老年代)</p>
</li>
<li><p><strong>标记-整理</strong></p>
<p> 该算法主要是为了解决标记-清除，产生大量内存碎片的问题；当对象存活率较高时，也解决了复制算法的效率问题。它的不同之处就是在清除对象的时候先将可回收对象移动到一端，然后清除掉端边界以外的对象，这样就不会产生内存碎片了。</p>
</li>
<li><p><strong>分代收集</strong> </p>
<p>  现在的虚拟机垃圾收集大多采用这种方式，它根据对象的生存周期，将堆分为新生代和老年代。在新生代中，由于对象生存期短，每次回收都会有大量对象死去，那么这时就采用<strong>复制</strong>算法。老年代里的对象存活率较高，没有额外的空间进行分配担保，所以可以使用<strong>标记-整理</strong> 或者 <strong>标记-清除</strong>。</p>
</li>
</ol>
<h4 id="15-1-CMS-收集器"><a href="#15-1-CMS-收集器" class="headerlink" title="15.1 CMS 收集器"></a>15.1 CMS 收集器</h4><p><strong>CMS（Concurrent Mark Sweep）收集器是一种以获取最短回收停顿时间为目标的收集器。它非常符合在注重用户体验的应用上使用。</strong></p>
<p><strong>CMS（Concurrent Mark Sweep）收集器是 HotSpot 虚拟机第一款真正意义上的并发收集器，它第一次实现了让垃圾收集线程与用户线程（基本上）同时工作。</strong></p>
<p>从名字中的<strong>Mark Sweep</strong>这两个词可以看出，CMS 收集器是一种 <strong>“标记-清除”算法</strong>实现的，它的运作过程相比于前面几种垃圾收集器来说更加复杂一些。整个过程分为四个步骤：(初并重清)</p>
<ul>
<li><strong>初始标记：</strong> 暂停所有的其他线程，并记录下直接与 root 相连的对象，速度很快 ；</li>
<li><strong>并发标记：</strong> 同时开启 GC 和用户线程，用一个闭包结构去记录可达对象。但在这个阶段结束，这个闭包结构并不能保证包含当前所有的可达对象。因为用户线程可能会不断的更新引用域，所以 GC 线程无法保证可达性分析的实时性。所以这个算法里会跟踪记录这些发生引用更新的地方。</li>
<li><strong>重新标记：</strong> 重新标记阶段就是为了修正并发标记期间因为用户程序继续运行而导致标记产生变动的那一部分对象的标记记录，这个阶段的停顿时间一般会比初始标记阶段的时间稍长，远远比并发标记阶段时间短</li>
<li><strong>并发清除：</strong> 开启用户线程，同时 GC 线程开始对为标记的区域做清扫。</li>
</ul>
<p>从它的名字就可以看出它是一款优秀的垃圾收集器，主要优点：<strong>并发收集、低停顿</strong>。但是它有下面三个明显的缺点：</p>
<ul>
<li><strong>对 CPU 资源敏感；</strong></li>
<li><strong>无法处理浮动垃圾；</strong></li>
<li><strong>它使用的回收算法-“标记-清除”算法会导致收集结束时会有大量空间碎片产生。</strong></li>
</ul>
<h4 id="15-2-G1-收集器"><a href="#15-2-G1-收集器" class="headerlink" title="15.2 G1 收集器"></a>15.2 G1 收集器</h4><p><strong>G1 (Garbage-First) 是一款面向服务器的垃圾收集器,主要针对配备多颗处理器及大容量内存的机器. 以极高概率满足 GC 停顿时间要求的同时,还具备高吞吐量性能特征.</strong></p>
<p>G1 收集器的运作大致分为以下几个步骤：</p>
<ul>
<li><strong>初始标记</strong></li>
<li><strong>并发标记</strong></li>
<li><strong>最终标记</strong></li>
<li><strong>筛选回收</strong></li>
</ul>
<p>**G1 收集器在后台维护了一个优先列表，每次根据允许的收集时间，优先选择回收价值最大的 Region(这也就是它的名字 Garbage-First 的由来)**。这种使用 Region 划分内存空间以及有优先级的区域回收方式，保证了 GF 收集器在有限时间内可以尽可能高的收集效率（把内存化整为零）。</p>
<h4 id="16-java内存模型"><a href="#16-java内存模型" class="headerlink" title="16.java内存模型"></a>16.java内存模型</h4><p>java内存模型(JMM)是线程间通信的控制机制.JMM定义了主内存和线程之间抽象关系。线程之间的共享变量存储在主内存（main memory）中，每个线程都有一个私有的本地内存（local memory），本地内存中存储了该线程以读&#x2F;写共享变量的副本。本地内存是JMM的一个抽象概念，并不真实存在。它涵盖了缓存，写缓冲区，寄存器以及其他的硬件和编译器优化。</p>
<h4 id="17-java类加载过程"><a href="#17-java类加载过程" class="headerlink" title="17.java类加载过程?"></a>17.java类加载过程?</h4><p> java类加载需要经历以下5个过程：加验准解初</p>
<p><strong>加载（通过名字获取类并生成class文件），</strong></p>
<p><strong>验证（保证字节流不危害到虚拟机），</strong></p>
<p><strong>准备（为静态变量分配内存），</strong></p>
<p><strong>解析（符号引用变为直接引用），</strong></p>
<p><strong>初始化（之前的都由虚拟机控制，这一步才真正执行类中的java代码）</strong></p>
<p> <strong>加载</strong></p>
<p> 加载时类加载的第一个过程，在这个阶段，将完成一下三件事情：</p>
<ol>
<li><p>通过一个类的全限定名获取该类的二进制流。</p>
</li>
<li><p>将该二进制流中的静态存储结构转化为方法去运行时数据结构。</p>
</li>
<li><p>在内存中生成该类的Class对象，作为该类的数据访问入口。</p>
</li>
</ol>
<p> <strong>验证</strong></p>
<p>验证的目的是为了确保Class文件的字节流中的信息不会危害到虚拟机.在该阶段主要完成以下四钟验证:</p>
<ol>
<li><p>文件格式验证：验证字节流是否符合Class文件的规范，如主次版本号是否在当前虚拟机范围内，常量池中的常量是否有不被支持的类型.</p>
</li>
<li><p>元数据验证:对字节码描述的信息进行语义分析，如这个类是否有父类，是否集成了不被继承的类等。</p>
</li>
<li><p>字节码验证：是整个验证过程中最复杂的一个阶段，通过验证数据流和控制流的分析，确定程序语义是否正确，主要针对方法体的验证。如：方法中的类型转换是否正确，跳转指令是否正确等。</p>
</li>
<li><p>符号引用验证：这个动作在后面的解析过程中发生，主要是为了确保解析动作能正确执行。</p>
</li>
</ol>
<p> <strong>准备</strong></p>
<p>准备阶段是为类的静态变量分配内存并将其初始化为默认值，这些内存都将在方法区中进行分配。准备阶段不分配类中的实例变量的内存，实例变量将会在对象实例化时随着对象一起分配在Java堆中。</p>
<p><strong>解析</strong> </p>
<p>该阶段主要完成符号引用到直接引用的转换动作。解析动作并不一定在初始化动作完成之前，也有可能在初始化之后。</p>
<p><strong>初始化</strong></p>
<p>初始化时类加载的最后一步，前面的类加载过程，除了在加载阶段用户应用程序可以通过自定义类加载器参与之外，其余动作完全由虚拟机主导和控制。到了初始化阶段，才真正开始执行类中定义的Java程序代码。</p>
<h4 id="18-简述java类加载机制"><a href="#18-简述java类加载机制" class="headerlink" title="18.简述java类加载机制?"></a>18.简述java类加载机制?</h4><p>虚拟机把描述类的数据从Class文件加载到内存，并对数据进行校验，解析和初始化，最终形成可以被虚拟机直接使用的java类型。</p>
<p>####19.类加载器双亲委派模型机制？<br>当一个类收到了类加载请求时，不会自己先去加载这个类，而是将其委派给父类，由父类去加载，如果此时父类不能加载，反馈给子类，由子类去完成类的加载。</p>
<h4 id="20-什么是类加载器，类加载器有哪些"><a href="#20-什么是类加载器，类加载器有哪些" class="headerlink" title="20.什么是类加载器，类加载器有哪些?"></a>20.什么是类加载器，类加载器有哪些?</h4><p>实现通过类的权限定名获取该类的二进制字节流的代码块叫做类加载器。</p>
<p>主要有一下四种类加载器:</p>
<ol>
<li><p>启动类加载器(Bootstrap ClassLoader)用来加载java核心类库，无法被java程序直接引用。</p>
</li>
<li><p>扩展类加载器(extensions class loader):它用来加载 Java 的扩展库。Java 虚拟机的实现会提供一个扩展库目录。该类加载器在此目录里面查找并加载 Java 类。</p>
</li>
<li><p>应用类加载器（Application class loader）：它根据 Java 应用的类路径（CLASSPATH）来加载 Java 类。一般来说，Java 应用的类都是由它来完成加载的。可以通过 ClassLoader.getSystemClassLoader()来获取它。</p>
</li>
<li><p>用户自定义类加载器，通过继承 java.lang.ClassLoader类的方式实现。</p>
</li>
</ol>
<h4 id="21-简述java内存分配与回收策率以及Minor-GC和Major-GC"><a href="#21-简述java内存分配与回收策率以及Minor-GC和Major-GC" class="headerlink" title="21.简述java内存分配与回收策率以及Minor GC和Major GC"></a><strong>21.简述java内存分配与回收策率以及Minor GC和Major GC</strong></h4><ol>
<li><p>对象优先在堆的Eden区分配。</p>
</li>
<li><p>大对象直接进入老年代.</p>
</li>
<li><p>长期存活的对象将直接进入老年代.</p>
</li>
</ol>
<p>当Eden区没有足够的空间进行分配时，虚拟机会执行一次Minor GC.Minor Gc通常发生在新生代的Eden区，在这个区的对象生存期短，往往发生Gc的频率较高，回收速度比较快;Full Gc&#x2F;Major GC 发生在老年代，一般情况下，触发老年代GC的时候不会触发Minor GC,但是通过配置，可以在Full GC之前进行一次Minor GC这样可以加快老年代的回收速度。</p>
<p><strong>Minor GC条件</strong></p>
<p>当Eden区空间不足以继续分配对象，发起Minor GC。</p>
<p><strong>Full GC条件</strong></p>
<ol>
<li>调用System.gc时，系统建议执行Full GC，但是不必然执行</li>
<li>老年代空间不足（通过Minor GC后进入老年代的大小大于老年代的可用内存）</li>
<li>方法区空间不足</li>
</ol>
<h3 id="22-HashMap的工作原理是什么"><a href="#22-HashMap的工作原理是什么" class="headerlink" title="22.HashMap的工作原理是什么?"></a><strong>22.HashMap的工作原理是什么?</strong></h3><p>HashMap内部是通过一个数组实现的，只是这个数组比较特殊，数组里存储的元素是一个Entry实体(jdk 8为Node)，这个Entry实体主要包含key、value以及一个指向自身的next指针。HashMap是基于hashing实现的，当我们进行put操作时，根据传递的key值得到它的hashcode，然后再用这个hashcode与数组的长度进行模运算，得到一个int值，就是Entry要存储在数组的位置（下标）；当通过get方法获取指定key的值时，会根据这个key算出它的hash值（数组下标），根据这个hash值获取数组下标对应的Entry，然后判断Entry里的key，hash值或者通过equals()比较是否与要查找的相同，如果相同，返回value，否则的话，遍历该链表（有可能就只有一个Entry，此时直接返回null），直到找到为止，否则返回null。</p>
<p>HashMap之所以在每个数组元素存储的是一个链表，是为了解决hash冲突问题，当两个对象的hash值相等时，那么一个位置肯定是放不下两个值的，于是hashmap采用链表来解决这种冲突，hash值相等的两个元素会形成一个链表。</p>
<h3 id="23-HashMap与HashTable的区别是什么"><a href="#23-HashMap与HashTable的区别是什么" class="headerlink" title="23.HashMap与HashTable的区别是什么?"></a><strong>23.HashMap与HashTable的区别是什么?</strong></h3><ol>
<li><p>HashTable基于Dictionary类，而HashMap是基于AbstractMap。Dictionary是任何可将键映射到相应值的类的抽象父类，而AbstractMap是基于Map接口的实现，它以最大限度地减少实现此接口所需的工作。</p>
</li>
<li><p>HashMap的key和value都允许为null，而Hashtable的key和value都不允许为null。HashMap遇到key为null的时候，调用putForNullKey方法进行处理，而对value没有处理；Hashtable遇到null，直接返回NullPointerException。</p>
</li>
<li><p>Hashtable是同步的，而HashMap是非同步的，但是我们也可以通过Collections.synchronizedMap(hashMap),使其实现同步。</p>
</li>
</ol>
<h3 id="24-CorrentHashMap的工作原理"><a href="#24-CorrentHashMap的工作原理" class="headerlink" title="24.CorrentHashMap的工作原理?"></a>24.CorrentHashMap的工作原理?</h3><p><strong>jdk 1.6版:</strong> ConcurrenHashMap可以说是HashMap的升级版，ConcurrentHashMap是线程安全的，但是与Hashtablea相比，实现线程安全的方式不同。Hashtable是通过对hash表结构进行锁定，是阻塞式的，当一个线程占有这个锁时，其他线程必须阻塞等待其释放锁。ConcurrentHashMap是采用分离锁的方式，它并没有对整个hash表进行锁定，而是局部锁定，也就是说当一个线程占有这个局部锁时，不影响其他线程对hash表其他地方的访问。</p>
<p>具体实现:ConcurrentHashMap内部有一个Segment&lt;K,V&gt;数组,该Segment对象可以充当锁。Segment对象内部有一个HashEntry&lt;K,V&gt;数组，于是每个Segment可以守护若干个桶(HashEntry),每个桶又有可能是一个HashEntry连接起来的链表，存储发生碰撞的元素。</p>
<p> 每个ConcurrentHashMap在默认并发级下会创建包含16个Segment对象的数组，每个数组有若干个桶，当我们进行put方法时，通过hash方法对key进行计算，得到hash值，找到对应的segment，然后对该segment进行加锁，然后调用segment的put方法进行存储操作，此时其他线程就不能访问当前的segment，但可以访问其他的segment对象，不会发生阻塞等待。</p>
<p> <strong>jdk 1.8版</strong> 在jdk 8中，ConcurrentHashMap不再使用Segment分离锁，而是采用一种乐观锁CAS算法来实现同步问题，但其底层还是“数组+链表-&gt;红黑树”的实现。</p>
<h3 id="27-Array和ArrayList有何区别？什么时候更适合用Array？"><a href="#27-Array和ArrayList有何区别？什么时候更适合用Array？" class="headerlink" title="27.Array和ArrayList有何区别？什么时候更适合用Array？"></a>27.Array和ArrayList有何区别？什么时候更适合用Array？</h3><ol>
<li><p>Array可以容纳基本类型和对象，而ArrayList只能容纳对象。</p>
</li>
<li><p>Array是指定大小的，而ArrayList大小是不固定的</p>
</li>
</ol>
<h3 id="28-哪些集合类提供对元素的随机访问？"><a href="#28-哪些集合类提供对元素的随机访问？" class="headerlink" title="28.哪些集合类提供对元素的随机访问？"></a>28.哪些集合类提供对元素的随机访问？</h3><p>ArrayList、HashMap、TreeMap和HashTable类提供对元素的随机访问。</p>
<h3 id="29-HashSet的底层实现是什么"><a href="#29-HashSet的底层实现是什么" class="headerlink" title="29.HashSet的底层实现是什么?"></a>29.HashSet的底层实现是什么?</h3><p>通过看源码知道HashSet的实现是依赖于HashMap的，HashSet的值都是存储在HashMap中的。在HashSet的构造法中会初始化一个HashMap对象，HashSet不允许值重复，因此，HashSet的值是作为HashMap的key存储在HashMap中的，当存储的值已经存在时返回false。</p>
<h3 id="30-LinkedHashMap的实现原理"><a href="#30-LinkedHashMap的实现原理" class="headerlink" title="30.LinkedHashMap的实现原理?"></a>30.LinkedHashMap的实现原理?</h3><p>LinkedHashMap也是基于HashMap实现的，他继承自HashMap，不同的是其将hashmap的每个元素加了一个before和after指针，由此组成了一个双向链表。linkedHashMap是有序的。</p>
<p>TreeMap也是有序的map容器，红黑树的插入删除访问时间复杂度为O(logn)，是按照key的排序方式排序的（通过comparotor进行排序的，可以自定义）。</p>
<h3 id="33-Thread-类中的start-和-run-方法有什么区别？"><a href="#33-Thread-类中的start-和-run-方法有什么区别？" class="headerlink" title="33.Thread 类中的start() 和 run() 方法有什么区别？"></a>33.Thread 类中的start() 和 run() 方法有什么区别？</h3><p>start()方法被用来启动新创建的线程，而且start()内部调用了run()方法，这和直接调用run()方法的效果不一样。当你调用run()方法的时候，只会是在原来的线程中调用，没有新的线程启动，start()方法才会启动新线程。</p>
<h3 id="35-Java中有哪几种锁"><a href="#35-Java中有哪几种锁" class="headerlink" title="35.Java中有哪几种锁?"></a>35.Java中有哪几种锁?</h3><p><strong>自旋锁:</strong> 自旋锁在JDK1.6之后就默认开启了。基于之前的观察，共享数据的锁定状态只会持续很短的时间，为了这一小段时间而去挂起和恢复线程有点浪费，所以这里就做了一个处理，让后面请求锁的那个线程在稍等一会，但是不放弃处理器的执行时间，看看持有锁的线程能否快速释放。为了让线程等待，所以需要让线程执行一个忙循环也就是自旋操作。</p>
<p>在jdk6之后，引入了自适应的自旋锁，也就是等待的时间不再固定了，而是由上一次在同一个锁上的自旋时间及锁的拥有者状态来决定</p>
<p><strong>偏向锁:</strong> 在JDK1.之后引入的一项锁优化，目的是消除数据在无竞争情况下的同步原语。进一步提升程序的运行性能。 偏向锁就是偏心的偏，意思是这个锁会偏向第一个获得他的线程，如果接下来的执行过程中，该锁没有被其他线程获取，则持有偏向锁的线程将永远不需要再进行同步。偏向锁可以提高带有同步但无竞争的程序性能，也就是说他并不一定总是对程序运行有利，如果程序中大多数的锁都是被多个不同的线程访问，那偏向模式就是多余的，在具体问题具体分析的前提下，可以考虑是否使用偏向锁。</p>
<p><strong>轻量级锁:</strong> 为了减少获得锁和释放锁所带来的性能消耗，引入了“偏向锁”和“轻量级锁”，所以在Java SE1.6里锁一共有四种状态，无锁状态，偏向锁状态，轻量级锁状态和重量级锁状态，它会随着竞争情况逐渐升级。锁可以升级但不能降级，意味着偏向锁升级成轻量级锁后不能降级成偏向锁。这种锁升级却不能降级的策略，目的是为了提高获得锁和释放锁的效率。</p>
<h3 id="37-ThreadLocal理解"><a href="#37-ThreadLocal理解" class="headerlink" title="37.ThreadLocal理解"></a>37.ThreadLocal理解</h3><p>ThreadLocal是一个创建——线程局部变量的类。通常情况下我们创建的变量,可以被多个线程访问并修改，通过ThreadLocal创建的变量只能被当前线程访问。</p>
<p><strong>ThreadLocal内部实现</strong></p>
<p>ThreadLocal提供了set和get方法.<br>因为一个线程内可以存在多个 ThreadLocal 对象，所以其实是 ThreadLocal 内部维护了一个 Map ，这个 Map 不是直接使用的 HashMap ，而是 ThreadLocal 实现的一个叫做 ThreadLocalMap 的静态内部类。而我们使用的 get()、set() 方法其实都是调用了这个ThreadLocalMap类对应的 get()、set() 方法。</p>
<h4 id="38-synchronized和lock的区别？"><a href="#38-synchronized和lock的区别？" class="headerlink" title="38. synchronized和lock的区别？"></a>38. synchronized和lock的区别？</h4><ul>
<li>主要相同点：Lock能完成synchronized所实现的所有功能。</li>
<li>主要不同点：Lock有比synchronized更精确的线程予以和更好的性能。</li>
</ul>
<ol>
<li>synchronized会自动释放锁，但是Lock一定要求程序员手工释放，并且必须在finally从句中释放。</li>
<li>synchronized修饰方法时,表示同一个对象在不同的线程中,表现为同步队列,如果实例化不同的对象,那么synchronized就不会出现同步效果了。</li>
</ol>
<p>具体用法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span></span><br><span class="line"><span class="keyword">if</span>(lock.trylock)&#123;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">xxxx</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">e.printStackTrace()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span>&#123;</span><br><span class="line">lock.unlock();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="39-单例模式"><a href="#39-单例模式" class="headerlink" title="39. 单例模式"></a>39. 单例模式</h4><p>单例模式（Singleton Pattern）是 Java 中最简单的设计模式之一。这种类型的设计模式属于创建型模式，它提供了一种创建对象的最佳方式。</p>
<p>这种模式涉及到一个单一的类，该类负责创建自己的对象，同时确保只有单个对象被创建。这个类提供了一种访问其唯一的对象的方式，可以直接访问，不需要实例化该类的对象。 </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Singleton singleton;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Singleton <span class="title function_">getSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Singleton.class)&#123;</span><br><span class="line">                <span class="keyword">if</span> (singleton==<span class="literal">null</span>)&#123;</span><br><span class="line">                    singleton = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="40-数据库的四种隔离等级"><a href="#40-数据库的四种隔离等级" class="headerlink" title="40.数据库的四种隔离等级"></a>40.数据库的四种隔离等级</h4><ul>
<li><p>未提交读(Read Uncommitted)：允许脏读，也就是可能读取到其他会话中未提交事务修改的数据</p>
</li>
<li><p>提交读(Read Committed)：写禁止读写，只限制同一数据写事务禁止其它读写事务。解决”脏读”和”更新丢失”。Oracle等多数数据库默认都是该级别 (不重复读)</p>
</li>
<li><p>可重复读(Repeated Read)：读写禁止其它读写。限制同一数据写事务禁止其他读写事务，读事务禁止其它写事务(允许读)。InnoDB默认级别。在SQL标准中，该隔离级别消除了不可重复读，但是还存在幻读</p>
</li>
<li><p>串行读(Serializable)：完全串行化的读，每次读都需要获得表级共享锁，读写相互都会阻塞</p>
</li>
</ul>
<p><strong>① 脏读:</strong> 脏读就是指当一个事务正在访问数据，并且对数据进行了修改，而这种修改还没有提交到数据库中，这时，另外一个事务也访问这个数据，然后使用了这个数据。</p>
<p><strong>②不可重复读</strong>：是指在一个事务内，多次读同一数据。在这个事务还没有结束时，另外一个事务也访问该同一数据。那么，在第一个事务中的两次读数据之间，由于第二个事务的修改，那么第一个事务两次读到的的数据可能是不一样的。</p>
<p>**④ 幻读:**事务 T1 读取一条指定的 Where 子句所返回的结果集，然后 T2 事务新插入一行记录，这行记录恰好可以满足T1 所使用的查询条件。然后 T1 再次对表进行检索，但又看到了 T2 插入的数据。 （和可重复读类似，但是事务 T2 的数据操作仅仅是插入和删除，不是修改数据，读取的记录数量前后不一致）</p>
<h4 id="倒排索引"><a href="#倒排索引" class="headerlink" title="倒排索引"></a>倒排索引</h4><p>倒排索引主要是一种搜索引擎使用的索引方式，记录每个单词出现的文档ID和出现的位置。</p>
<p>普通的正向索引是：{文档ID：单词A：出现位置a，单词B：出现位置b}，那么当你要搜索一句话的时候，要遍历所有的文档。</p>
<p>倒排索引是：{单词A：(文档id-M：出现的位置m), (文档ID-N:出现的位置n)}，当你要找what is it这句话的时候，那么就是找到what，is，it三个单词的交集，得到的结果就是三个单词都出现了的文档，然后在找到的文档结果中，找到按照what is it的顺序排序的文档，返回文档ID。</p>
<h4 id="是否可以在static环境中访问非static变量？"><a href="#是否可以在static环境中访问非static变量？" class="headerlink" title="是否可以在static环境中访问非static变量？"></a>是否可以在static环境中访问非static变量？</h4><p>static变量在Java中是属于类的，它在所有的实例中的值是一样的。当类被Java虚拟机载入的时候，会对static变量进行初始化。如果你的代码尝试不用实例来访问非static的变量，编译器会报错，因为这些变量还没有被创建出来，还没有跟任何实例关联上。</p>
<h4 id="Java支持的数据类型有哪些？什么是自动拆装箱？"><a href="#Java支持的数据类型有哪些？什么是自动拆装箱？" class="headerlink" title="Java支持的数据类型有哪些？什么是自动拆装箱？"></a>Java支持的数据类型有哪些？什么是自动拆装箱？</h4><p>Java语言支持的8种基本数据类型是：</p>
<p>byte、short、int、long、float、double、boolean、char</p>
<p>自动装箱是Java编译器在基本数据类型和对应的对象包装类型之间做的一个转化。比如：把int转化成Integer，double转化成Double，等等。反之就是自动拆箱。</p>
<h4 id="概括的解释下线程的几种可用状态。线程状态"><a href="#概括的解释下线程的几种可用状态。线程状态" class="headerlink" title="概括的解释下线程的几种可用状态。线程状态"></a>概括的解释下线程的几种可用状态。线程状态</h4><ol>
<li>新建</li>
<li>可运行：新建后调用了start方法，放入线程池等待调度，获取cpu使用权</li>
<li>运行：可运行的线程获取了cpu时间片</li>
<li>阻塞：线程因某种原因放弃了cpu时间片<br>1）同步阻塞：因为没有获取到同步锁而阻塞<br>2）等待阻塞：调用了wait方法，等待notify方法解出阻塞状态<br>3）其他阻塞：sleep方法之类的，等sleep超时之后恢复</li>
<li>死亡：run结束，或异常退出run，死亡不可再生</li>
</ol>
<h4 id="线程状态之间的关系"><a href="#线程状态之间的关系" class="headerlink" title="线程状态之间的关系"></a>线程状态之间的关系</h4><p>new一个线程之后，处于新建状态，调用start之后，处于可运行状态，获得cpu之后处于运行状态，调用wait，sleep，join之后处于阻塞状态，解出阻塞之后变为可运行状态，运行态调用yield处于可运行状态，运行中结束或异常处于死亡状态。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190331160617.png"></p>
<h4 id="同步方法和同步代码块的区别是什么？"><a href="#同步方法和同步代码块的区别是什么？" class="headerlink" title="同步方法和同步代码块的区别是什么？"></a>同步方法和同步代码块的区别是什么？</h4><p>同步方法默认用this或者当前类class对象作为锁；</p>
<p>同步代码块可以选择以什么来加锁，比同步方法要更细颗粒度，我们可以选择只同步会发生同步问题的部分代码而不是整个方法；</p>
<p>同步方法使用关键字 synchronized修饰方法，而同步代码块主要是修饰需要进行同步的代码，用   synchronized（object）{代码内容}进行修饰；</p>
<h4 id="在监视器-Monitor-内部，是如何做线程同步的？程序应该做哪种级别的同步？"><a href="#在监视器-Monitor-内部，是如何做线程同步的？程序应该做哪种级别的同步？" class="headerlink" title="在监视器(Monitor)内部，是如何做线程同步的？程序应该做哪种级别的同步？"></a>在监视器(Monitor)内部，是如何做线程同步的？程序应该做哪种级别的同步？</h4><p>监视器和锁在Java虚拟机中是一块使用的。监视器监视一块同步代码块，确保一次只有一个线程执行同步代码块。每一个监视器都和一个对象引用相关联。线程在获取锁之前不允许执行同步代码。</p>
<h4 id="什么是死锁-deadlock-？"><a href="#什么是死锁-deadlock-？" class="headerlink" title="什么是死锁(deadlock)？"></a>什么是死锁(deadlock)？</h4><p><strong>死锁</strong> <strong>:<strong>是指两个或两个以上的进程在执行过程中,因争夺资源而造成的一种</strong>互相等待</strong>的现象,若无<strong>外力</strong>作用,它们都将无法推进下去</p>
<p>（1） <strong>互斥条件</strong>：一个资源每次只能被一个进程使用。  </p>
<p>（2） <strong>请求与保持条件</strong>：一个进程因请求资源而阻塞时，对已获得的资源保持不放。  </p>
<p>（3） <strong>不可抢占</strong>:进程已获得的资源，在末使用完之前，不能强行剥夺。  </p>
<p>（4） <strong>循环等待</strong>:有两个或者两个以上的进程组成一条环路，该环路中的每个进程都在等待下一个进程所占有的资源。</p>
<h4 id="如何确保N个线程可以访问N个资源同时又不导致死锁？"><a href="#如何确保N个线程可以访问N个资源同时又不导致死锁？" class="headerlink" title="如何确保N个线程可以访问N个资源同时又不导致死锁？"></a>如何确保N个线程可以访问N个资源同时又不导致死锁？</h4><p>使用多线程的时候，一种非常简单的避免死锁的方式就是：指定获取锁的顺序，并强制线程按照指定的顺序获取锁。因此，如果所有的线程都是以同样的顺序加锁和释放锁，就不会出现死锁了。</p>
<h4 id="快速失败-fail-fast-和安全失败-fail-safe-的区别是什么？"><a href="#快速失败-fail-fast-和安全失败-fail-safe-的区别是什么？" class="headerlink" title="快速失败(fail-fast)和安全失败(fail-safe)的区别是什么？"></a>快速失败(fail-fast)和安全失败(fail-safe)的区别是什么？</h4><p>一：快速失败（fail—fast）</p>
<p>在用迭代器遍历一个集合对象时，如果遍历过程中对集合对象的结构进行了修改（增加、删除），则会抛出Concurrent Modification Exception。</p>
<p>原理：迭代器在遍历时直接访问集合中的内容，并且在遍历过程中使用一个 modCount 变量。集合在被遍历期间如果结构发生变化，就会改变modCount的值。每当迭代器使用hashNext()&#x2F;next()遍历下一个元素之前，都会检测modCount变量是否为expectedmodCount值，是的话就返回遍历；否则抛出异常，终止遍历。</p>
<p>注意：这里异常的抛出条件是检测到 modCount！&#x3D;expectedmodCount 这个条件。如果集合发生变化时修改modCount值刚好又设置为了expectedmodCount值，则异常不会抛出。因此，不能依赖于这个异常是否抛出而进行并发操作的编程，这个异常只建议用于检测并发修改的bug。</p>
<p>​      场景：java.util包下的集合类都是快速失败的，不能在多线程下发生并发修改（迭代过程中被修改）。</p>
<p>​    二：安全失败（fail—safe）</p>
<p>​      采用安全失败机制的集合容器，在遍历时不是直接在集合内容上访问的，而是先复制原有集合内容，在拷贝的集合上进行遍历。</p>
<p>​      原理：由于迭代时是对原集合的拷贝进行遍历，所以在遍历过程中对原集合所作的修改并不能被迭代器检测到，所以不会触发Concurrent Modification Exception。</p>
<p>​      缺点：基于拷贝内容的优点是避免了Concurrent Modification Exception，但同样地，迭代器并不能访问到修改后的内容，即：迭代器遍历的是开始遍历那一刻拿到的集合拷贝，在遍历期间原集合发生的修改迭代器是不知道的。</p>
<p>​          场景：java.util.concurrent包下的容器都是安全失败，可以在多线程下并发使用，并发修改。</p>
<p>####数组(Array)和列表(ArrayList)有什么区别？什么时候应该使用Array而不是ArrayList？</p>
<ol>
<li>Array可以包含基本类型和对象类型，ArrayList只能包含对象类型。</li>
<li>Array大小是固定的，ArrayList的大小是动态变化的。</li>
<li>ArrayList提供了更多的方法和特性，比如：addAll()，removeAll()，iterator()等等。<br>对于基本类型数据，集合使用自动装箱来减少编码工作量。但是，当处理固定大小的基本数据类型的时候，这种方式相对比较慢。</li>
</ol>
<h4 id="什么是优先级队列"><a href="#什么是优先级队列" class="headerlink" title="什么是优先级队列"></a>什么是优先级队列</h4><p>优先级队列就是可以排序的队列，必须继承comparator接口，使插入队列的对象是可以比较的。但是优先队列PriorityQueue是线程不安全的，concurrent包下面有线程安全的实现方式，是PriorityBlockingQueue</p>
<h4 id="串行-serial-收集器和吞吐量-throughput-收集器的区别是什么？"><a href="#串行-serial-收集器和吞吐量-throughput-收集器的区别是什么？" class="headerlink" title="串行(serial)收集器和吞吐量(throughput)收集器的区别是什么？"></a>串行(serial)收集器和吞吐量(throughput)收集器的区别是什么？</h4><p>吞吐量收集器使用并行版本的新生代垃圾收集器，它用于中等规模和大规模数据的应用程序。而串行收集器对大多数的小应用(在现代处理器上需要大概100M左右的内存)就足够了。</p>
<h4 id="数据库四个特性"><a href="#数据库四个特性" class="headerlink" title="数据库四个特性"></a>数据库四个特性</h4><ol>
<li>原子性（Atomicity）</li>
</ol>
<p>　　原子性是指事务是一个不可分割的工作单位，事务中的操作要么全部成功，要么全部失败。比如在同一个事务中的SQL语句，要么全部执行成功，要么全部执行失败。</p>
<p>　　回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。</p>
<ol start="2">
<li>一致性（Consistency）</li>
</ol>
<p>　　事务必须使数据库从一个一致性状态变换到另外一个一致性状态。以转账为例子，A向B转账，假设转账之前这两个用户的钱加起来总共是2000，那么A向B转账之后，不管这两个账户怎么转，A用户的钱和B用户的钱加起来的总额还是2000，这个就是事务的一致性。</p>
<ol start="3">
<li>隔离性（Isolation）</li>
</ol>
<p>　　隔离性是当多个用户并发访问数据库时，比如操作同一张表时，数据库为每一个用户开启的事务，不能被其他事务的操作所干扰，多个并发事务之间要相互隔离。</p>
<p>　　即要达到这么一种效果：对于任意两个并发的事务 T1 和 T2，在事务 T1 看来，T2 要么在 T1 开始之前就已经结束，要么在 T1 结束之后才开始，这样每个事务都感觉不到有其他事务在并发地执行。</p>
<ol start="4">
<li>持久性（Durability）</li>
</ol>
<p>　　一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。</p>
<p>　　可以通过数据库备份和恢复来实现，在系统发生奔溃时，使用备份的数据库进行数据恢复。</p>
<h4 id="什么情况下不推荐使用索引？"><a href="#什么情况下不推荐使用索引？" class="headerlink" title="什么情况下不推荐使用索引？"></a>什么情况下不推荐使用索引？</h4><ol>
<li>数据唯一性差（一个字段的取值只有几种时）的字段不要使用索引</li>
</ol>
<blockquote>
<p>比如性别，只有两种可能数据。意味着索引的二叉树级别少，多是平级。这样的二叉树查找无异于全表扫描。</p>
</blockquote>
<p>2）频繁更新的字段不要使用索引</p>
<blockquote>
<p>比如logincount登录次数，频繁变化导致索引也频繁变化，增大数据库工作量，降低效率。</p>
</blockquote>
<ol start="3">
<li>字段不在where语句出现时不要添加索引,如果where后含IS NULL &#x2F;IS NOT NULL&#x2F; like ‘%输入符%’等条件，不建议使用索引</li>
</ol>
<blockquote>
<p>只有在where语句出现，mysql才会去使用索引</p>
</blockquote>
<p>4） where 子句里对索引列使用不等于（&lt;&gt;），使用索引效果一般</p>
<h4 id="IOC和AOP"><a href="#IOC和AOP" class="headerlink" title="IOC和AOP"></a>IOC和AOP</h4><p><strong>IOC（DI）</strong></p>
<p>控制反转：原来是自己主动去new一个对象去用，现在是由容器工具配置文件创建实例让自己用，说白了就是用面向接口编程和配置文件减少对象间的耦合，同时解决硬编码的问题（XML）</p>
<p>依赖注入：在运行过程中当你需要这个对象才给你实例化并注入其中，不需要管什么时候注入的，只需要写好成员变量和set方法</p>
<p><strong>AOP</strong></p>
<p>介绍</p>
<p>面向切面的编程，是一种编程技术，是OOP（面向对象编程）的补充和完善。OOP的执行是一种从上往下的流程，并没有从左到右的关系。因此在OOP编程中，会有大量的重复代码。而AOP则是将这些与业务无关的重复代码抽取出来，然后再嵌入到业务代码当中。常见的应用有：权限管理、日志、事务管理等。</p>
<p>实现方式</p>
<p>实现AOP的技术，主要分为两大类：一是采用动态代理技术，利用截取消息的方式，对该消息进行装饰，以取代原有对象行为的执行；二是采用静态织入的方式，引入特定的语法创建“方面”，从而使得编译器可以在编译期间织入有关“方面”的代码。Spring AOP实现用的是动态代理的方式。</p>
<h3 id="java加载器类型"><a href="#java加载器类型" class="headerlink" title="java加载器类型"></a>java加载器类型</h3><h4 id="启动（Bootstrap）类加载器"><a href="#启动（Bootstrap）类加载器" class="headerlink" title="启动（Bootstrap）类加载器"></a>启动（Bootstrap）类加载器</h4><p>启动类加载器主要加载的是JVM自身需要的类，这个类加载使用C++语言实现的，包含<code>/lib</code></p>
<h4 id="扩展（Extension）类加载器"><a href="#扩展（Extension）类加载器" class="headerlink" title="扩展（Extension）类加载器"></a>扩展（Extension）类加载器</h4><p>扩展类加载器是指Sun公司(已被Oracle收购)实现的sun.misc.Launcher$ExtClassLoader类，包含<code>/lib/ext</code></p>
<h4 id="应用（Application）类加载器"><a href="#应用（Application）类加载器" class="headerlink" title="应用（Application）类加载器"></a>应用（Application）类加载器</h4><p>也称应用程序加载器是指 Sun公司实现的sun.misc.Launcher$AppClassLoader，<code>java.class.path</code></p>
<h4 id="双亲委派模式工作原理"><a href="#双亲委派模式工作原理" class="headerlink" title="双亲委派模式工作原理"></a>双亲委派模式工作原理</h4><p>双亲委派模式要求除了顶层的启动类加载器外，其余的类加载器都应当由自己的父类加载器来进行加载。</p>
<p>####双亲委派模型的原因</p>
<ol>
<li>避免重复加载：类加载耗时耗内存，如果父类加载的话，同一个类加载器只加载一次（JVM 区分不同类的方式不仅仅根据类名，相同的类文件被不同的类加载器加载产生的是两个不同的类）</li>
<li>避免系统类被替换,比如java.lang.Integer，如果你自己写了一个，不用双亲委派，就会出现多个不同的Integer</li>
</ol>
<h4 id="双亲委派模型的破坏"><a href="#双亲委派模型的破坏" class="headerlink" title="双亲委派模型的破坏"></a>双亲委派模型的破坏</h4><p>举个例子，driver接口定义在jdk中，对各个数据库厂商，他们都定义了自己的数据库连接类，需要数据库连接的时候，就需要由子类加载器来加载，此时就需要破坏双亲委派模型。打破方法是：继承classLoader类，重写classloader的loadclass方法。</p>
<h3 id="classnotfoundError"><a href="#classnotfoundError" class="headerlink" title="classnotfoundError"></a>classnotfoundError</h3><p>什么时候会抛出classnotfoundException异常呢？</p>
<p>这涉及到底层的API。当程序试图使用class类中的forname方法、classloader类中的findsystemclass方法，classloader类中loadclass方法通过字符串名的形式加载此类时，会抛出该异常<br>解决方案</p>
<ol>
<li>首先检查一下你的环境变量classpath的配置，看一看所需要的支持类库是否放在类路径里面</li>
<li>类名错了，在调用class类中的forname方法时会出异常，很明显，我的是在调用classloader的loadclass方法时出错</li>
</ol>
<h3 id="NoSuchMethodError"><a href="#NoSuchMethodError" class="headerlink" title="NoSuchMethodError"></a>NoSuchMethodError</h3><p>在Java项目开发时一般会使用maven作为项目jar包依赖管理工具，但随着工程依赖的jar包越来越多，“jar包冲突”这个潜在隐患随时可能爆发出来。大部分情况下，我们都会见到“java.lang.NoSuchMethodError”异常信息，这种情况一般都是由于包冲突引起的。</p>
<h3 id="垃圾回收器种类"><a href="#垃圾回收器种类" class="headerlink" title="垃圾回收器种类"></a>垃圾回收器种类</h3><p>Java有四种类型的垃圾回收器：</p>
<p>串行垃圾回收器（Serial Garbage Collector）<br>并行垃圾回收器（Parallel Garbage Collector）<br>并发标记扫描垃圾回收器（CMS Garbage Collector）<br>G1垃圾回收器（G1 Garbage Collector）</p>
<h4 id="红黑树定义"><a href="#红黑树定义" class="headerlink" title="红黑树定义"></a>红黑树定义</h4><ol>
<li>结点是红色或黑色</li>
<li>根结点始终是黑色</li>
<li>叶子结点（NIL 结点）都是黑色</li>
<li>红色结点的两个直接孩子结点都是黑色（即从叶子到根的所有路径上不存在两个连续的红色结点）</li>
<li>从任一结点到每个叶子的所有简单路径都包含相同数目的黑色结点</li>
</ol>
<h4 id="红黑树-vs-AVL树"><a href="#红黑树-vs-AVL树" class="headerlink" title="红黑树 vs AVL树"></a>红黑树 vs AVL树</h4><p>AVL树是严格平衡二叉树，红黑树严格程度更低。因此红黑树的插入效率更高，因为需要旋转的次数更少。但是avl的搜索效率更高</p>
<h4 id="树的用途"><a href="#树的用途" class="headerlink" title="树的用途"></a>树的用途</h4><p>AVL树：:  最早的平衡二叉树之一。应用相对其他数据结构比较少。windows对进程地址空间的管理用到了AVL树。</p>
<p>红黑树：: 平衡二叉树，广泛用在C++的STL中。如map和set都是用红黑树实现的。java的treemap也是红黑树实现的。</p>
<p>B树，b+树：用在磁盘文件组织 数据索引和数据库索引。</p>
<h4 id="为什么hashmap线程不安全"><a href="#为什么hashmap线程不安全" class="headerlink" title="为什么hashmap线程不安全"></a>为什么hashmap线程不安全</h4><p>两个不安全的要点：</p>
<ol>
<li><p>put函数，两个线程同时put的时候，会丢失一个数据；</p>
</li>
<li><p>resize函数，大小超过阈值的时候，扩容，新建一个更大的数组，将原来的数据复制到新数组中。因为是数组中的元素是链表，复制之后顺序改变，而如果两个线程同时复制，那么将一会变正，一会变反，形成死锁。</p>
</li>
</ol>
<h4 id="手写LRU算法-页面置换算法"><a href="#手写LRU算法-页面置换算法" class="headerlink" title="手写LRU算法(页面置换算法)"></a>手写LRU算法(页面置换算法)</h4><p>LRU（Least recently used，最近最少使用）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LRU</span>&lt;K, V&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">hashLoadFactory</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br><span class="line">    <span class="keyword">private</span> LinkedHashMap&lt;K, V&gt; map;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> cacheSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">LRU</span><span class="params">(<span class="type">int</span> cacheSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cacheSize = cacheSize;</span><br><span class="line">        <span class="type">int</span> <span class="variable">capicity</span> <span class="operator">=</span> (<span class="type">int</span>) Math.ceil(cacheSize / hashLoadFactory) + <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">this</span>.map = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;K, V&gt;(capicity, hashLoadFactory, <span class="literal">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">removeEldestEntry</span><span class="params">(Map.Entry&lt;K, V&gt; eldest)</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> size() &gt; LRU.<span class="built_in">this</span>.cacheSize;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> V <span class="title function_">get</span><span class="params">(K key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">clear</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.map.clear();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.map.size();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="一致性hash"><a href="#一致性hash" class="headerlink" title="一致性hash"></a>一致性hash</h4><p>redis集群，假如现在有2000w条数据，你有8台服务器，组成组从复制（将主服务器数据复制到从服务器，所有增删改操作在主服务器，读操作在从服务器，这样能减轻主服务器压力，也只用给远端暴露从服务器，增强安全性）的四组(每组两台)，你通过hash算法，这样可以快速找到哪个数据存在哪个服务器上。</p>
<p>但是现在比如你多了一组服务器，原本的hash结果对4求余(hash(key)%4)，现在的hash结果对5求余，那所有数据的hash值都变了，全部要重新放一遍，效率很低。</p>
<p>这时就需要一致性hash算法，假设整个hash值空间为0-2^32-1，我将这个范围连成一个环。对每个主机hash后放到环上，一个元素该放到哪个主机，就是hash结果顺时针方向走过的第一个主机节点，如下图所示。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190326120000.png"></p>
<p>当新增一个节点比如Node X，假如增加到了B和C之间，那么受到影响的元素只有原先在C的元素</p>
<p>又比如C节点坏了，那么就把c节点所有元素复制到D就行了。如下图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190326120228.png"></p>
<p>一致性hash有个问题就是假如两个节点hash值在环上距离太近，那么会造成不平衡的问题。解决办法是增加虚拟节点，一个节点多次hash，放到环上，这样就消除了数据不平衡的问题。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190326120322.png"></p>
<h4 id="线程池参数"><a href="#线程池参数" class="headerlink" title="线程池参数"></a>线程池参数</h4><ol>
<li><p>corePoolSize:核心线程数，值为每秒任务数*每个任务耗时，设置为80%时间出现的任务书的值，比如每秒200<del>1000个任务，每个处理0.1秒，那么需要20</del>100个线程，核心线程数至少大于20，根据80%准则，设置为40</p>
</li>
<li><p>队列长度：核心线程数&#x2F;每个任务的时间*响应时间，例子中是40&#x2F;0.1*1&#x3D;400，假设系统响应时间最多为1s</p>
</li>
<li><p>最大线程数：（最大线程数-队列长度）*每个线程花费时间，(1000-400)*0.1&#x3D;60</p>
</li>
<li><p>keepAliveTime:当负载降低时，如果一个空闲线程时间达到keepAliveTime，就退出</p>
</li>
<li><p>allowCoreThreadTimeout:默认不允许核心线程退出，设为true的时候可以退出</p>
</li>
</ol>
<p><strong>线程池按以下方式执行任务</strong></p>
<ol>
<li>当线程数小于核心线程数时，创建线程。</li>
<li>当线程数大于等于核心线程数，且任务队列未满时，将任务放入任务队列。</li>
<li>当线程数大于等于核心线程数，且任务队列已满<ol>
<li>若线程数小于最大线程数，创建线程</li>
<li>若线程数等于最大线程数，抛出异常，拒绝任务</li>
</ol>
</li>
</ol>
<h4 id="hash冲突的解决办法"><a href="#hash冲突的解决办法" class="headerlink" title="hash冲突的解决办法"></a>hash冲突的解决办法</h4><ol>
<li>开放地址法：按原始数据顺序计算hash值，如果某个位置算出来已经有值了，就向后找到第一个没有值的位置放这个值<br><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190326154149.png"></li>
<li>链地址法：数组每个位置存的都是链表，冲突的加入链表末尾</li>
<li>再hash法：冲突就用新的hash函数计算，直到不冲突</li>
<li>公共溢出区：如果溢出就放入公共溢出区</li>
</ol>
<p>####CAS和ABA问题</p>
<p>CAS（compare and swap)：对于内存中的某一个值V，提供一个旧值A和一个新值B。如果提供的旧值V和A相等就把B写入V。这个过程是原子性的。</p>
<p>解决方法：</p>
<p>AtomicStampedReference解决aba问题，不光比较值是否相同，还比较版本号是否相同</p>
<h4 id="数据库引擎"><a href="#数据库引擎" class="headerlink" title="数据库引擎"></a>数据库引擎</h4><p><strong>Myiasm</strong></p>
<p>MyIASM是MySQL默认的引擎，但是它没有提供对数据库事务的支持，也不支持行级锁和外键，因此当INSERT(插入)或UPDATE(更新)数据时即写操作需要锁定整个表，效率便会低一些。不过和Innodb不同，MyIASM中存储了表的行数，于是SELECT COUNT(*) FROM TABLE时只需要直接读取已经保存好的值而不需要进行全表扫描。如果表的读操作远远多于写操作且不需要数据库事务的支持，那么MyIASM也是很好的选择。</p>
<p><strong>Innodb</strong></p>
<p>Innodb引擎提供了对数据库ACID事务的支持，并且实现了SQL标准的四种隔离级别。该引擎还提供了行级锁和外键约束，它的设计目标是处理大容量数据库系统，它本身其实就是基于MySQL后台的完整数据库系统，MySQL运行时Innodb会在内存中建立缓冲池，用于缓冲数据和索引。但是该引擎不支持FULLTEXT类型的索引，而且它没有保存表的行数，当SELECT COUNT(*) FROM TABLE时需要扫描全表。当需要使用数据库事务时，该引擎当然是首选。由于锁的粒度更小，写操作不会锁定全表，所以在并发较高时，使用Innodb引擎会提升效率。但是使用行级锁也不是绝对的，如果在执行一个SQL语句时MySQL不能确定要扫描的范围，InnoDB表同样会锁全表。</p>
<p><strong>总结：</strong></p>
<ol>
<li>innodb支持四种SQL隔离，ACID四种特性，支持事物和行级锁，对于大数据一般用innodb</li>
<li>Myiasm保存了行数，seleclt count(*)的效率比较高，更新数据需要锁定整个表。如果大量读，也可以用myiasm</li>
</ol>
<h4 id="spring-boot如何启动一个项目"><a href="#spring-boot如何启动一个项目" class="headerlink" title="spring boot如何启动一个项目"></a>spring boot如何启动一个项目</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line">SpringApplication.run(SellApplicaiton.class,args)</span><br></pre></td></tr></table></figure>

<h4 id="aop底层实现"><a href="#aop底层实现" class="headerlink" title="aop底层实现"></a>aop底层实现</h4><p>AOP思想的实现一般都是基于 <strong>代理模式</strong> ，在JAVA中一般采用JDK动态代理模式，但是我们都知道，<strong>JDK动态代理模式只能代理接口而不能代理类</strong>。因此，Spring AOP 会这样子来进行切换，因为Spring AOP 同时支持 CGLIB、ASPECTJ、JDK动态代理。</p>
<ul>
<li>如果目标对象的实现类实现了接口，Spring AOP 将会采用 JDK 动态代理来生成 AOP 代理类；</li>
<li>如果目标对象的实现类没有实现接口，Spring AOP 将会采用 CGLIB 来生成 AOP 代理类——不过这个选择过程对开发者完全透明、开发者也无需关心。</li>
</ul>
<h4 id="数据库分页"><a href="#数据库分页" class="headerlink" title="数据库分页"></a>数据库分页</h4><p>在mysql当中是用limit实现的，select * from table limit 0,10</p>
<h4 id="数据库索引失效"><a href="#数据库索引失效" class="headerlink" title="数据库索引失效"></a>数据库索引失效</h4><ol>
<li>如果条件中有or，即使其中有条件带索引也不会使用(这也是为什么尽量少用or的原因)</li>
<li>对于多列索引，不是使用的第一部分(第一个)，则不会使用索引</li>
<li>like查询是以%开头</li>
<li>如果列类型是字符串，那一定要在条件中将数据使用引号引用起来,否则不使用索引</li>
<li>如果mysql估计使用全表扫描要比使用索引快,则不使用索引</li>
</ol>
<h4 id="redis分布式锁"><a href="#redis分布式锁" class="headerlink" title="redis分布式锁"></a>redis分布式锁</h4><p>通过redlock实现，先按顺序加锁，如果锁住的服务器已经超过一半，并且如果锁的持续时间超过加锁耗费的时间，那么锁就加成功了，否则依次释放所有的锁。</p>
<h4 id="java获取系统时间"><a href="#java获取系统时间" class="headerlink" title="java获取系统时间"></a>java获取系统时间</h4><p>calendar库和date库</p>
<h4 id="时间的格式化方法"><a href="#时间的格式化方法" class="headerlink" title="时间的格式化方法"></a>时间的格式化方法</h4><p>calendar库和date库，</p>
<p>格式化方法是simpledateFormat(format和parse函数)或者string.format(“%tY”)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Date day=<span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line"></span><br><span class="line"><span class="type">SimpleDateFormat</span> <span class="variable">df</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(“yyyy-MM-dd HH:mm:ss”);</span><br><span class="line"></span><br><span class="line"><span class="type">Calendar</span> <span class="variable">c</span> <span class="operator">=</span> Calendar.getInstance();<span class="comment">//可以对每个时间域单独修改</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="variable">year</span> <span class="operator">=</span> c.get(Calendar.YEAR);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="序列化反序列化"><a href="#序列化反序列化" class="headerlink" title="序列化反序列化"></a>序列化反序列化</h4><p>Java序列化是指把Java对象保存为二进制的过程，Java反序列化是指把二进制码重新转换成Java对象的过程。</p>
<p>那么为什么需要序列化呢？</p>
<p>第一种情况是：对java对象持久化保存</p>
<p>第二种情况是：需要把Java对象通过网络进行传输的时候。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;temp.out&quot;</span>);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line"><span class="type">TestObject</span> <span class="variable">testObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestObject</span>();</span><br><span class="line">oos.writeObject(testObject);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;temp.out&quot;</span>);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line"><span class="type">TestObject</span> <span class="variable">deTest</span> <span class="operator">=</span> (TestObject) ois.readObject();</span><br><span class="line">System.out.println(deTest.testValue);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TestObject</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="线程共享变量"><a href="#线程共享变量" class="headerlink" title="线程共享变量"></a>线程共享变量</h4><p>因为java对共享变量的读写需要从主存中复制到工作内存中成为副本，更改之后再从工作内存复制到主存中，如果多个线程对共享变量进行更改，需要保证更改后及时更新到主存，其他线程能够及时从主存中读取新的变量值更新到工作内存中。这就要求可见性。实现方式有synchronized 和 volatile 以及 java.concurrent.automic</p>
<p><strong>volatile适用情况</strong></p>
<p>a.对变量的写入操作不依赖当前值</p>
<p>比如自增自减、number &#x3D; number + 5等（不满足）</p>
<p>b.当前volatile变量不依赖于别的volatile变量</p>
<p>比如 volatile_var &gt; volatile_var2这个不等式（不满足）</p>
<p><strong>volatile实现原理</strong></p>
<p>用单例模式，对应的汇编代码有一个lock 的add 0操作，对应的x86的操作者手册，有lock的汇编操作有两个：1.将缓存数据写回到系统内存，2.当前写回操作会使其他内存中的对应地址无效。</p>
<p><strong>synchronized和volatile比较</strong></p>
<p>a. volatile不需要同步操作，所以效率更高，不会阻塞线程，但是适用情况比较窄</p>
<p>b. volatile读变量相当于加锁（即进入synchronized代码块），而写变量相当于解锁（退出synchronized代码块）</p>
<p>c. synchronized既能保证共享变量可见性，也可以保证锁内操作的原子性；volatile只能保证可见性</p>
<p>d. <code>volatile</code>关键字会禁止指令重排。<code>synchronized</code>关键字保证同一时刻只允许一条线程操作。</p>
<h4 id="java内存模型"><a href="#java内存模型" class="headerlink" title="java内存模型"></a>java内存模型</h4><p>有一个主存，所有变量都要从主存里面复制到工作内存中使用，如果一个变量改了，那么要立刻刷新回主存中，让其他变量知道，这就是可见性。一个操作要么执行，要么不执行，这就是原子性。sychronized保证的是原子性和可见性，volatile只保证可见性，但禁止了指令重排。</p>
<h4 id="Synchronized"><a href="#Synchronized" class="headerlink" title="Synchronized"></a>Synchronized</h4><p>synchronize关键字主要是用于解决多线程访问临界资源的同步性，保证被其修饰的代码块同时只有一个线程可以执行。早期版本synchronize关键字的monitor实现方式要用系统的mutex lock(互斥锁)实现，但是jdk6之后对其进行了优化，出现了自旋锁，偏向锁，轻量锁，重量锁等方法，效率提高</p>
<p>有三种使用方式：</p>
<ol>
<li>修饰实例方法：对实例加锁</li>
<li>修饰静态方法：对类加锁</li>
<li>修饰代码块：对指定对象加锁</li>
</ol>
<h4 id="synchronized-关键字的底层原理"><a href="#synchronized-关键字的底层原理" class="headerlink" title="synchronized 关键字的底层原理"></a>synchronized 关键字的底层原理</h4><ol>
<li><p>修饰代码块</p>
<p>使用monitor实现，用的是monitorenter和monitorexit函数，早期是调用系统的mutex lock实现，后来引入了自旋锁，偏心锁，轻量锁，重量锁。计数器为0的时候，可以获取锁，获取之后计数器变为1，释放锁的时候计数器变为0。如果获取锁失败就阻塞等待。</p>
</li>
<li><p>修饰方法</p>
<p>用一个acc_synchronized标志，通过访问标志确定是否加锁。</p>
</li>
</ol>
<h4 id="Synchronized和ReentrantLock的区别"><a href="#Synchronized和ReentrantLock的区别" class="headerlink" title="Synchronized和ReentrantLock的区别"></a>Synchronized和ReentrantLock的区别</h4><p><strong>① 两者都是可重入锁</strong></p>
<p>两者都是可重入锁。“可重入锁”概念是：自己可以再次获取自己的内部锁。比如一个线程获得了某个对象的锁，此时这个对象锁还没有释放，当其再次想要获取这个对象的锁的时候还是可以获取的，如果不可锁重入的话，就会造成死锁。同一个线程每次获取锁，锁的计数器都自增1，所以要等到锁的计数器下降为0时才能释放锁。</p>
<p><strong>② synchronized 依赖于 JVM 而 ReenTrantLock 依赖于 API</strong></p>
<p>synchronized 是依赖于 JVM 实现的，前面我们也讲到了 虚拟机团队在 JDK1.6 为 synchronized 关键字进行了很多优化，但是这些优化都是在虚拟机层面实现的，并没有直接暴露给我们。ReenTrantLock 是 JDK 层面实现的（也就是 API 层面，需要 lock() 和 unlock 方法配合 try&#x2F;finally 语句块来完成），所以我们可以通过查看它的源代码，来看它是如何实现的。</p>
<p><strong>③ ReenTrantLock 比 synchronized 增加了一些高级功能</strong></p>
<p>相比synchronized，ReenTrantLock增加了一些高级功能。主要来说主要有三点：<strong>①等待可中断；②可实现公平锁；③可实现选择性通知（锁可以绑定多个条件）</strong></p>
<ul>
<li><strong>ReenTrantLock提供了一种能够中断等待锁的线程的机制</strong>，通过lock.lockInterruptibly()来实现这个机制。也就是说正在等待的线程可以选择放弃等待，改为处理其他事情。</li>
<li><strong>ReenTrantLock可以指定是公平锁还是非公平锁。而synchronized只能是非公平锁。所谓的公平锁就是先等待的线程先获得锁。</strong> ReenTrantLock默认情况是非公平的，可以通过 ReenTrantLock类的<code>ReentrantLock(boolean fair)</code>构造方法来制定是否是公平的。</li>
<li>synchronized关键字与wait()和notify&#x2F;notifyAll()方法相结合可以实现等待&#x2F;通知机制，ReentrantLock类当然也可以实现，但是需要借助于Condition接口与newCondition() 方法。Condition是JDK1.5之后才有的，它具有很好的灵活性，比如可以实现多路通知功能也就是在一个Lock对象中可以创建多个Condition实例（即对象监视器），<strong>线程对象可以注册在指定的Condition中，从而可以有选择性的进行线程通知，在调度线程上更加灵活。 在使用notify&#x2F;notifyAll()方法进行通知时，被通知的线程是由 JVM 选择的，用ReentrantLock类结合Condition实例可以实现“选择性通知”</strong> ，这个功能非常重要，而且是Condition接口默认提供的。而synchronized关键字就相当于整个Lock对象中只有一个Condition实例，所有的线程都注册在它一个身上。如果执行notifyAll()方法的话就会通知所有处于等待状态的线程这样会造成很大的效率问题，而Condition实例的signalAll()方法 只会唤醒注册在该Condition实例中的所有等待线程。</li>
</ul>
<h4 id="AQS底层原理"><a href="#AQS底层原理" class="headerlink" title="AQS底层原理"></a>AQS底层原理</h4><p>AQS：AbstractQueuedSynchronizer</p>
<p>AQS是一个用来构建锁和同步器的框架，使用AQS能简单且高效地构造出应用广泛的大量的同步器，比如我们提到的ReentrantLock，Semaphore，其他的诸如ReentrantReadWriteLock，SynchronousQueue，FutureTask等等皆是基于AQS的。当然，我们自己也能利用AQS非常轻松容易地构造出符合我们自己需求的同步器。</p>
<p>AQS的核心思想是如果请求一个共享资源，他是没有被占用的，就把请求资源这个线程设置为有效的工作线程。如果被占用，就加入一个CLH双端队列</p>
<p>AQS用一个state来表示同步状态，AQS用CAS对这个同步状态进行原子操作，为1表示被锁定，为0表示空闲。</p>
<p>AQS有两种资源访问的形式，一种是独占的，一种是共享的(信号量，倒计时器，循环栅栏)</p>
<ol>
<li><p><strong>Semaphore(信号量)-允许多个线程同时访问</strong></p>
<p>设置一个许可证数量，如果一个线程开始执行时，要先acquire一个许可证，在许可证数量大于0的情况下，可以直接获取成功，否则获取失败被阻塞。线程执行完之后会释放一个许可，供后面到来的线程使用。</p>
<p>场景：工厂有5台机器，8个工人，只有有机器空闲的时候，空闲工人才能上机。</p>
</li>
<li><p><strong>CountDwonLatch（倒计时器）</strong></p>
<p>倒计时器是一开始设置为n，n就是线程的数量，每执行完一个线程，调用await方法，使倒计时器值减1，直到倒计时器减为0，所有线程执行完毕。倒计时器是一次性的，无法重用。</p>
<p>场景：马拉松比赛，排名。要等所有人跑完才能计算排名。</p>
</li>
<li><p><strong>CyclicBarrier(循环栅栏)</strong></p>
<p>循环栅栏，顾名思义，就是一个可以循环使用的栅栏，栅栏是什么意思呢，就是等待一定数量的线程到达栅栏，然后一起执行。每个线程用await方法告诉循环栅栏自己到达栅栏了。</p>
<p>主要应用场景是：十个人约着去吃饭，等大家都到了才能出发。与倒计时器的区别主要是这个栅栏可以重置留着下次用。</p>
</li>
</ol>
<h4 id="加锁会带来哪些性能问题。如何解决？"><a href="#加锁会带来哪些性能问题。如何解决？" class="headerlink" title="加锁会带来哪些性能问题。如何解决？"></a>加锁会带来哪些性能问题。如何解决？</h4><p>缩小锁的范围，锁住变量而不是方法。使用java.util.concurrent下面的并发容器。</p>
<h4 id="NginX如何做负载均衡、常见的负载均衡算法有哪些"><a href="#NginX如何做负载均衡、常见的负载均衡算法有哪些" class="headerlink" title="NginX如何做负载均衡、常见的负载均衡算法有哪些"></a>NginX如何做负载均衡、常见的负载均衡算法有哪些</h4><p>Nginx的upstream目前支持的6种方式的分配，分别是：轮询策略，权重轮询策略，ip_hash策略，fair策略，url_hash策略，sticky策略等。</p>
<p>轮询就是来一个请求就按顺序分给多台服务器</p>
<p>权重轮询就是给每个服务器一个权重，请求按权重的比例为概率分给服务器</p>
<p>ip_hash是根据ip的hash值选择服务器</p>
<p>url_hash就是根据urlhash值选择服务器</p>
<p>fair就是挑选目前负载最小的服务器</p>
<p>sticky就是一个客户端只与一个后端服务器交互，直到断开之后再选一个服务器</p>
<h4 id="出现-OOM-后你会怎么排查问题？"><a href="#出现-OOM-后你会怎么排查问题？" class="headerlink" title="出现 OOM 后你会怎么排查问题？"></a>出现 OOM 后你会怎么排查问题？</h4><ol>
<li>堆空间大小不足</li>
<li>内存泄漏：比如hashmap每次插入数据，数据重写了hashcode方法，但是数据没有重写equals方法</li>
</ol>
<h4 id="操作系统的内存管理机制"><a href="#操作系统的内存管理机制" class="headerlink" title="操作系统的内存管理机制"></a>操作系统的内存管理机制</h4><p>虚拟内存，将物理地址映射成逻辑地址，通过页表查询，当程序需要的虚拟内存不在内存中时，产生缺页中断，通过页表去内存中找到需要的逻辑地址对应的物理地址，如果内存满了就用页面置换算法（最佳，最久未使用，最近未使用，先进先出，第二次机会，时钟算法）。</p>
<h4 id="说下你对线程安全的理解"><a href="#说下你对线程安全的理解" class="headerlink" title="说下你对线程安全的理解"></a>说下你对线程安全的理解</h4><p>当多个线程需要访问同一个互斥资源的时候，就会产生线程安全问题。</p>
<h4 id="哈夫曼编码是怎么回事"><a href="#哈夫曼编码是怎么回事" class="headerlink" title="哈夫曼编码是怎么回事"></a>哈夫曼编码是怎么回事</h4><p>哈弗曼编码是一种无损压缩编码技术，出现次数多的内容用较短的编码，出现次数少的用较长的编码。</p>
<p>假如我有A,B,C,D,E五个字符，出现的频率（即权值）分别为5,4,3,2,1,那么我们第一步先取两个最小权值作为左右子树构造一个新树，即取1，2构成新树，其结点为1+2&#x3D;3，如图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190327215224.png"><br>　　虚线为新生成的结点，第二步再把新生成的权值为3的结点放到剩下的集合中，所以集合变成{5,4,3,3}，再根据第二步，取最小的两个权值构成新树，如图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190327215238.png"></p>
<p>再依次建立哈夫曼树，如下图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190327215252.png"></p>
<p>其中各个权值替换对应的字符即为下图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190327215308.png"></p>
<p>所以各字符对应的编码为：A-&gt;11,B-&gt;10,C-&gt;00,D-&gt;011,E-&gt;010</p>
<h4 id="直接调用线程的start和run有什么区别"><a href="#直接调用线程的start和run有什么区别" class="headerlink" title="直接调用线程的start和run有什么区别"></a>直接调用线程的start和run有什么区别</h4><p>start是真正的多线程运行，run方法是按顺序执行的。</p>
<h4 id="线程池的好处"><a href="#线程池的好处" class="headerlink" title="线程池的好处"></a>线程池的好处</h4><ul>
<li><strong>降低资源消耗。</strong> 通过重复利用已创建的线程降低线程创建和销毁造成的消耗。</li>
<li><strong>提高响应速度。</strong> 当任务到达时，任务可以不需要的等到线程创建就能立即执行。</li>
<li><strong>提高线程的可管理性。</strong> 线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池可以进行统一的分配，调优和监控。</li>
</ul>
<h4 id="泛型怎么实现的"><a href="#泛型怎么实现的" class="headerlink" title="泛型怎么实现的"></a>泛型怎么实现的</h4><p>​       Java中的泛型基本上都是在编译器这个层次来实现的。在生成的Java字节码中是不包含泛型中的类型信息的。使用泛型的时候加上的类型参数，会在编译器在编译的时候去掉。这个过程就称为类型擦除。</p>
<h4 id="常见hash算法"><a href="#常见hash算法" class="headerlink" title="常见hash算法"></a>常见hash算法</h4><p>md4,md5,sha1</p>
<h4 id="Object-类方法"><a href="#Object-类方法" class="headerlink" title="Object 类方法"></a>Object 类方法</h4><p>getClass，hashcode，equals，clone，toString，notify，notifyAll，wait，finalize</p>
<h4 id="String为啥不可变"><a href="#String为啥不可变" class="headerlink" title="String为啥不可变"></a>String为啥不可变</h4><p>string里面放的是一个char的数组，定义是final的，并且string本身也是final的，所以string是不可变的</p>
<p>string设计为不可变是为了线程安全，同时string通常被用于hashmap的key，可变容易引起冲突</p>
<h4 id="java浮点数精度问题"><a href="#java浮点数精度问题" class="headerlink" title="java浮点数精度问题"></a>java浮点数精度问题</h4><p>java会出现<code>double result = 1.0 - 0.9;</code>result的结果是0.09999999999999998的情况，要理解这个问题，就要看10进制数是如何存入计算机变为二进制的，比如11，每次除以2，直到为0，所有计算过程中的余数组成它的二进制表示；而十进制的小数，小数部分是每次*2，然后取整数部分，直到没有小数为止，比如0.9一直乘以2，永远无法结束，就循环了，因此精度就不准了。</p>
<p>解决方法是用bigDecimal类型。</p>
<h4 id="java跳出多重循环"><a href="#java跳出多重循环" class="headerlink" title="java跳出多重循环"></a>java跳出多重循环</h4><p>三种方法：意识lable标签，用break label的方法跳出，还有一种是写到函数里面，用return跳出；用一个flag标志，每次循环要判断flag的值。</p>
<h4 id="正则表达式原理"><a href="#正则表达式原理" class="headerlink" title="正则表达式原理"></a>正则表达式原理</h4><p>nfa（Nondeterministic Finite Automata非确定有穷）自动机</p>
<h4 id="i-线程安全吗"><a href="#i-线程安全吗" class="headerlink" title="i++线程安全吗"></a>i++线程安全吗</h4><p>不安全，比如多个线程同时执行i++，那么他们相加的结果可能会重复，比如两个线程，一个执行1000次i++，结果肯定小于2000，同时读到0，同时+1，同时返回1，本来预期结果是2。解决方法是加入原子操作，或者用synchronize关键字修饰</p>
<h4 id="collection和collections的区别"><a href="#collection和collections的区别" class="headerlink" title="collection和collections的区别"></a>collection和collections的区别</h4><p>collection是一个集合接口，提供了一大堆通用方法，java中常用的集合都是从collection接口实现的。</p>
<p>collections是一个工具类，提供了很多对集合的操作方法，比如排序之类的。</p>
<h4 id="java线程同步的几种方式"><a href="#java线程同步的几种方式" class="headerlink" title="java线程同步的几种方式"></a>java线程同步的几种方式</h4><ol>
<li>synchronized修饰方法</li>
<li>synchronized同步代码块</li>
<li>用volatile实现</li>
<li>可重入锁，reentreantlock</li>
<li>局部变量：threadLocal</li>
</ol>
<h4 id="生产者-消费者模型"><a href="#生产者-消费者模型" class="headerlink" title="生产者-消费者模型"></a>生产者-消费者模型</h4><ul>
<li>生产者持续生产，直到缓冲区满，阻塞；缓冲区不满后，继续生产</li>
<li>消费者持续消费，直到缓冲区空，阻塞；缓冲区不空后，继续消费</li>
<li>生产者可以有多个，消费者也可以有多个</li>
</ul>
<p>可通过如下条件验证模型实现的正确性：</p>
<ul>
<li>同一产品的消费行为一定发生在生产行为之后</li>
<li>任意时刻，缓冲区大小不小于0，不大于限制容量</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BlockingQueueModel</span> <span class="keyword">implements</span> <span class="title class_">Model</span> &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Task&gt; queue;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">increTaskNo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">BlockingQueueModel</span><span class="params">(<span class="type">int</span> cap)</span> &#123;</span><br><span class="line">    <span class="comment">// LinkedBlockingQueue 的队列是 lazy-init 的，但 ArrayBlockingQueue 在创建时就已经 init</span></span><br><span class="line">    <span class="built_in">this</span>.queue = <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;&gt;(cap);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Runnable <span class="title function_">newRunnableConsumer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConsumerImpl</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> Runnable <span class="title function_">newRunnableProducer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProducerImpl</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ConsumerImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractConsumer</span> <span class="keyword">implements</span> <span class="title class_">Consumer</span>, Runnable &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consume</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">      <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> queue.take();</span><br><span class="line">      <span class="comment">// 固定时间范围的消费，模拟相对稳定的服务器处理过程</span></span><br><span class="line">      Thread.sleep(<span class="number">500</span> + (<span class="type">long</span>) (Math.random() * <span class="number">500</span>));</span><br><span class="line">      System.out.println(<span class="string">&quot;consume: &quot;</span> + task.no);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">class</span> <span class="title class_">ProducerImpl</span> <span class="keyword">extends</span> <span class="title class_">AbstractProducer</span> <span class="keyword">implements</span> <span class="title class_">Producer</span>, Runnable &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">      <span class="comment">// 不定期生产，模拟随机的用户请求</span></span><br><span class="line">      Thread.sleep((<span class="type">long</span>) (Math.random() * <span class="number">1000</span>));</span><br><span class="line">      <span class="type">Task</span> <span class="variable">task</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Task</span>(increTaskNo.getAndIncrement());</span><br><span class="line">      queue.put(task);</span><br><span class="line">      System.out.println(<span class="string">&quot;produce: &quot;</span> + task.no);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Model</span> <span class="variable">model</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BlockingQueueModel</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Thread</span>(model.newRunnableConsumer()).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Thread</span>(model.newRunnableProducer()).start();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="为什么不推荐使用suspend和stop"><a href="#为什么不推荐使用suspend和stop" class="headerlink" title="为什么不推荐使用suspend和stop"></a>为什么不推荐使用suspend和stop</h4><p>stop会解出线程获得的所有锁，线程所有运行的内容立即停止。</p>
<p>suspend容易造成死锁，调用的时候，suspend会停下来，但仍获得之前的锁，其他线程无法访问锁定的资源，除非线程被恢复。</p>
<h4 id="非公平锁和公平锁在reetrantlock里的实现"><a href="#非公平锁和公平锁在reetrantlock里的实现" class="headerlink" title="非公平锁和公平锁在reetrantlock里的实现"></a>非公平锁和公平锁在reetrantlock里的实现</h4><p>公平锁就是按先来后到的顺序执行线程，非公平锁是按优先级执行线程。在reetrantlock里面，实现公平锁是tryAcquire，如果发现当前要lock的线程是阻塞队列中的头元素或者阻塞队列为空，那么就获取锁成功，否则按照fifo的原则加入阻塞队列中。</p>
<p>非公平锁就是每个线程获取锁的概率是一样的，这样减少了jvm在线程调度的开销，实际调用的是sync的nofairtryAcquire方法，获取当前线程，查看aqs维护的锁的状态，如果状态为0，则经aqs的setStatus从0设为1。</p>
<h4 id="LongAdder与AtomicLong区别"><a href="#LongAdder与AtomicLong区别" class="headerlink" title="LongAdder与AtomicLong区别"></a>LongAdder与AtomicLong区别</h4><p>LongAdder在AtomicLong的基础上将单点的更新压力分散到各个节点，在低并发的时候通过对base的直接更新可以很好的保障和AtomicLong的性能基本保持一致，而在高并发的时候通过分散提高了性能。 </p>
<p>缺点是LongAdder在统计的时候如果有并发更新，可能导致统计的数据有误差。</p>
<h4 id="聚集索引与非聚集索引"><a href="#聚集索引与非聚集索引" class="headerlink" title="聚集索引与非聚集索引"></a>聚集索引与非聚集索引</h4><p>聚集索引：<strong>叶子结点即存储了真实的数据行，不再有另外单独的数据页。 在一张表上最多只能创建一个聚集索引</strong></p>
<p>非聚集索引：MyISAM的<strong>B+Tree的叶子节点上的data，并不是数据本身，而是数据存放的地址</strong>。</p>
<h4 id="用户态，内核态"><a href="#用户态，内核态" class="headerlink" title="用户态，内核态"></a>用户态，内核态</h4><p>所有用户程序都是运行在用户态的, 但是有时候程序确实需要做一些内核态的事情, 例如从硬盘读取数据, 或者从键盘获取输入等. 而唯一可以做这些事情的就是操作系统, 所以此时程序就需要先操作系统请求以程序的名义来执行这些操作.</p>
<p>这时需要一个这样的机制: 用户态程序切换到内核态, 但是不能控制在内核态中执行的指令</p>
<p>这种机制叫系统调用, 在CPU中的实现称之为陷阱指令(Trap Instruction)</p>
<p><strong>他们的工作流程如下:</strong></p>
<p>用户态程序将一些数据值放在寄存器中, 或者使用参数创建一个堆栈(stack frame), 以此表明需要操作系统提供的服务.<br>用户态程序执行陷阱指令<br>CPU切换到内核态, 并跳到位于内存指定位置的指令, 这些指令是操作系统的一部分, 他们具有内存保护, 不可被用户态程序访问<br>这些指令称之为陷阱(trap)或者系统调用处理器(system call handler). 他们会读取程序放入内存的数据参数, 并执行程序请求的服务<br>系统调用完成后, 操作系统会重置CPU为用户态并返回系统调用的结果</p>
<h4 id="数据库select太慢怎么办"><a href="#数据库select太慢怎么办" class="headerlink" title="数据库select太慢怎么办"></a>数据库select太慢怎么办</h4><p>用缓存数据库，比如redis</p>
<h4 id="缓存穿透，缓存雪崩，缓存击穿"><a href="#缓存穿透，缓存雪崩，缓存击穿" class="headerlink" title="缓存穿透，缓存雪崩，缓存击穿"></a>缓存穿透，缓存雪崩，缓存击穿</h4><p><strong>缓存穿透</strong></p>
<p>缓存穿透是指查询一个一定不存在的数据，由于缓存是不命中时被动写的，并且出于容错考虑，如果从存储层查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。在流量大时，可能DB就挂掉了，要是有人利用不存在的key频繁攻击我们的应用，这就是漏洞。</p>
<p><strong>解决方法</strong></p>
<p>有很多种方法可以有效地解决缓存穿透问题，最常见的则是采用布隆过滤器，将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被 这个bitmap拦截掉，从而避免了对底层存储系统的查询压力。另外也有一个更为简单粗暴的方法（我们采用的就是这种），如果一个查询返回的数据为空（不管是数 据不存在，还是系统故障），我们仍然把这个空结果进行缓存，但它的过期时间会很短，最长不超过五分钟。</p>
<p><strong>缓存雪崩</strong></p>
<p>缓存雪崩是指在我们设置缓存时采用了相同的过期时间，导致缓存在某一时刻同时失效，请求全部转发到DB，DB瞬时压力过重雪崩。</p>
<p><strong>解决方案</strong></p>
<p>缓存失效时的雪崩效应对底层系统的冲击非常可怕。大多数系统设计者考虑用加锁或者队列的方式保证缓存的单线 程（进程）写，从而避免失效时大量的并发请求落到底层存储系统上。这里分享一个简单方案就时讲缓存失效时间分散开，比如我们可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>
<p><strong>缓存击穿</strong></p>
<p>对于一些设置了过期时间的key，如果这些key可能会在某些时间点被超高并发地访问，是一种非常“热点”的数据。这个时候，需要考虑一个问题：缓存被“击穿”的问题，这个和缓存雪崩的区别在于这里针对某一key缓存，前者则是很多key。</p>
<p>缓存在某个时间点过期的时候，恰好在这个时间点对这个Key有大量的并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。</p>
<p><strong>解决方案</strong><br>1.使用互斥锁(mutex key)</p>
<p>业界比较常用的做法，是使用mutex。简单地来说，就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db，而是先使用缓存工具的某些带成功操作返回值的操作（比如Redis的SETNX或者Memcache的ADD）去set一个mutex key，当操作返回成功时，再进行load db的操作并回设缓存；否则，就重试整个get缓存的方法。</p>
<p>SETNX，是「SET if Not eXists」的缩写，也就是只有不存在的时候才设置，可以利用它来实现锁的效果。</p>
<p>2.”提前”使用互斥锁(mutex key)：</p>
<p>在value内部设置1个超时值(timeout1), timeout1比实际的memcache timeout(timeout2)小。当从cache读取到timeout1发现它已经过期时候，马上延长timeout1并重新设置到cache。然后再从数据库加载数据并设置到cache中。</p>
<p>3.”永远不过期”：<br>这里的“永远不过期”包含两层意思：</p>
<p>(1) 从redis上看，确实没有设置过期时间，这就保证了，不会出现热点key过期问题，也就是“物理”不过期。</p>
<p>(2) 从功能上看，如果不过期，那不就成静态的了吗？所以我们把过期时间存在key对应的value里，如果发现要过期了，通过一个后台的异步线程进行缓存的构建，也就是“逻辑”过期</p>
<h4 id="线上频繁gc的原因"><a href="#线上频繁gc的原因" class="headerlink" title="线上频繁gc的原因"></a>线上频繁gc的原因</h4><p>用jstat查看内存使用情况，如果是频繁gc，用jmap把情况dump下来</p>
<p>用jvisualvm查看dump文件，找出占用内存大的对象，并查看其引用情况，查看对应关键代码，是否存在大量写情况。</p>
<h4 id="java-8-新特性"><a href="#java-8-新特性" class="headerlink" title="java 8 新特性"></a>java 8 新特性</h4><p>函数式编程，lambda表达式，就是把一个函数作为参数传入lambda表达式里面</p>
<p>默认方法：接口可以定义默认方法，实现接口的类可以重写这个默认方法，也可以不重写</p>
<p>重复注解：可以在同一个函数上定义多个相同的注解</p>
<p>stream：stream API得到完善，集合类不用遍历，而转换为stream然后用lambda表达式进行操作</p>
<h4 id="length-length-size-的区别"><a href="#length-length-size-的区别" class="headerlink" title="length, length(), size()的区别"></a>length, length(), size()的区别</h4><p>1 java中的length属性是针对数组说的,比如说你声明了一个数组,想知道这个数组的长度则用到了length这个属性.</p>
<p>2 java中的length()方法是针对字符串String说的,如果想看这个字符串的长度则用到length()这个方法.</p>
<p>3.java中的size()方法是针对泛型集合说的,如果想看这个泛型有多少个元素,就调用此方法来查看!</p>
<h4 id="Spring-中的-bean-的作用域有哪些"><a href="#Spring-中的-bean-的作用域有哪些" class="headerlink" title="Spring 中的 bean 的作用域有哪些?"></a>Spring 中的 bean 的作用域有哪些?</h4><ul>
<li>singleton : 唯一 bean 实例，Spring 中的 bean 默认都是单例的。</li>
<li>prototype : 每次请求都会创建一个新的 bean 实例。</li>
<li>request : 每一次HTTP请求都会产生一个新的bean，该bean仅在当前HTTP request内有效。</li>
<li>session : 每一次HTTP请求都会产生一个新的 bean，该bean仅在当前 HTTP session 内有效。</li>
<li>global-session： 全局session作用域，仅仅在基于portlet的web应用中才有意义，Spring5已经没有了。Portlet是能够生成语义代码(例如：HTML)片段的小型Java Web插件。它们基于portlet容器，可以像servlet一样处理HTTP请求。但是，与 servlet 不同，每个 portlet 都有不同的会话</li>
</ul>
<h4 id="Spring-中的单例-bean-的线程安全问题了解吗？"><a href="#Spring-中的单例-bean-的线程安全问题了解吗？" class="headerlink" title="Spring 中的单例 bean 的线程安全问题了解吗？"></a>Spring 中的单例 bean 的线程安全问题了解吗？</h4><p>单例 bean 存在线程问题，主要是因为当多个线程操作同一个对象的时候，对这个对象的非静态成员变量的写操作会存在线程安全问题。</p>
<p>常见的有两种解决办法：</p>
<ol>
<li>在Bean对象中尽量避免定义可变的成员变量（不太现实）。</li>
<li>在类中定义一个ThreadLocal成员变量，将需要的可变成员变量保存在 ThreadLocal 中（推荐的一种方式）。</li>
</ol>
<h4 id="Spring-中的-bean-生命周期"><a href="#Spring-中的-bean-生命周期" class="headerlink" title="Spring 中的 bean 生命周期?"></a>Spring 中的 bean 生命周期?</h4><ul>
<li>Bean 容器找到配置文件中 Spring Bean 的定义。</li>
<li>Bean 容器利用 Java Reflection API 创建一个Bean的实例。</li>
<li>如果涉及到一些属性值 利用 <code>set()</code>方法设置一些属性值。</li>
<li>如果 Bean 实现了 <code>BeanNameAware</code> 接口，调用 <code>setBeanName()</code>方法，传入Bean的名字。</li>
<li>如果 Bean 实现了 <code>BeanClassLoaderAware</code> 接口，调用 <code>setBeanClassLoader()</code>方法，传入 <code>ClassLoader</code>对象的实例。</li>
<li>如果Bean实现了 <code>BeanFactoryAware</code> 接口，调用 <code>setBeanClassLoader()</code>方法，传入 <code>ClassLoade</code> r对象的实例。</li>
<li>与上面的类似，如果实现了其他 <code>*.Aware</code>接口，就调用相应的方法。</li>
<li>如果有和加载这个 Bean 的 Spring 容器相关的 <code>BeanPostProcessor</code> 对象，执行<code>postProcessBeforeInitialization()</code> 方法</li>
<li>如果Bean实现了<code>InitializingBean</code>接口，执行<code>afterPropertiesSet()</code>方法。</li>
<li>如果 Bean 在配置文件中的定义包含 init-method 属性，执行指定的方法。</li>
<li>如果有和加载这个 Bean的 Spring 容器相关的 <code>BeanPostProcessor</code> 对象，执行<code>postProcessAfterInitialization()</code> 方法</li>
<li>当要销毁 Bean 的时候，如果 Bean 实现了 <code>DisposableBean</code> 接口，执行 <code>destroy()</code> 方法。</li>
<li>当要销毁 Bean 的时候，如果 Bean 在配置文件中的定义包含 destroy-method 属性，执行指定的方法。</li>
</ul>
<p>图示如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190823110438.png"></p>
<h4 id="说说自己对于-Spring-MVC-了解"><a href="#说说自己对于-Spring-MVC-了解" class="headerlink" title="说说自己对于 Spring MVC 了解?"></a>说说自己对于 Spring MVC 了解?</h4><p>MVC 是一种设计模式,Spring MVC 是一款很优秀的 MVC 框架。Spring MVC 可以帮助我们进行更简洁的Web层的开发，并且它天生与 Spring 框架集成。Spring MVC 下我们一般把后端项目分为 Service层（处理业务）、Dao层（数据库操作）、Entity层（实体类）、Controller层(控制层，返回数据给前台页面)。</p>
<p>用户请求发送到controller，交给模型层：service,dao,entity处理，返回结果给View层渲染，将响应交还给用户。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190823111145.png"></p>
<h4 id="Spring-MVC工作原理"><a href="#Spring-MVC工作原理" class="headerlink" title="Spring MVC工作原理"></a>Spring MVC工作原理</h4><ol>
<li>客户端（浏览器）发送请求，直接请求到 <code>DispatcherServlet</code>。</li>
<li><code>DispatcherServlet</code> 根据请求信息调用 <code>HandlerMapping</code>，解析请求对应的 <code>Handler</code>。</li>
<li>解析到对应的 <code>Handler</code>（也就是我们平常说的 <code>Controller</code> 控制器）后，开始由 <code>HandlerAdapter</code> 适配器处理。</li>
<li><code>HandlerAdapter</code> 会根据 <code>Handler </code>来调用真正的处理器开处理请求，并处理相应的业务逻辑。</li>
<li>处理器处理完业务后，会返回一个 <code>ModelAndView</code> 对象，<code>Model</code> 是返回的数据对象，<code>View</code> 是个逻辑上的 <code>View</code>。</li>
<li><code>ViewResolver</code> 会根据逻辑 <code>View</code> 查找实际的 <code>View</code>。</li>
<li><code>DispaterServlet</code> 把返回的 <code>Model</code> 传给 <code>View</code>（视图渲染）。</li>
<li>把 <code>View</code> 返回给请求者（浏览器）</li>
</ol>
<h4 id="简单SQL"><a href="#简单SQL" class="headerlink" title="简单SQL"></a>简单SQL</h4><ol>
<li><p>查：select column from table where column&#x3D;xx;</p>
</li>
<li><p>更新：update table set (columnA&#x3D;a,columnB&#x3D;b….) where  column&#x3D;xx;</p>
</li>
<li><p>插入：insert into table (columnA,columnB,…)VALUES(a,b,c,d);</p>
</li>
<li><p>删除：delete from table where column&#x3D;xx;</p>
</li>
<li><p>建表：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> xx(</span><br><span class="line">`id` <span class="type">bigint</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="keyword">null</span> AUTO_INCREMENT <span class="keyword">primary</span> key,</span><br><span class="line">`name` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">`money` <span class="type">float</span>(<span class="number">32</span>) <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">`birthday` <span class="type">date</span> <span class="keyword">default</span> <span class="keyword">null</span>,</span><br><span class="line">  key `mutliKey` (`id`,`name`)</span><br><span class="line">)ENGINE<span class="operator">=</span><span class="string">&#x27;InnoDB&#x27;</span> <span class="keyword">default</span> charset<span class="operator">=</span><span class="string">&#x27;utf8mb4&#x27;</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="SQL-join"><a href="#SQL-join" class="headerlink" title="SQL join"></a>SQL join</h4><p>left&#x2F;right join：以左&#x2F;右边为基础</p>
<p>inner join：交集</p>
<p>full outer join：并集</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190826113127.png"></p>
<h4 id="SQL-group-by"><a href="#SQL-group-by" class="headerlink" title="SQL group by"></a>SQL group by</h4><p>select coulum, 聚合函数(column) from table group by column;</p>
<p>比如从销售数据中提取出每个用户总共花过多少钱：</p>
<h4 id="c-虚函数"><a href="#c-虚函数" class="headerlink" title="c++虚函数"></a>c++虚函数</h4><p>每个包含了虚函数的类都包含一个虚表。 虚表是一个指针数组，其元素是虚函数的指针，在代码的编译阶段，虚表就可以构造出来了。为了让每个包含虚表的类的对象都拥有一个虚表指针，编译器在类中添加了一个指针，*__vptr，用来指向虚表。虚表是属于类的，而不是属于某个具体的对象，一个类只需要一个虚表即可。同一个类的所有对象都使用同一个虚表。</p>
<p>如果子类继承了父类的虚函数，并重写了虚函数，那么新的虚函数表中，重写部分指向新地址，没重新部分依然指向旧地址。如果此时用一个父类指针，指向子类的对象，调用重写的方法，就会出现多态的效果。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc1</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc2</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_data1, m_data2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> : <span class="keyword">public</span> A &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">vfunc1</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_data3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>此时新建对象，并调用，会发现调用A指针的vfunc1方法，实际调用到的是B对象的vfunc1()方法，实现了多态。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">B bObject;</span><br><span class="line">A *p = &amp; bObject;</span><br><span class="line">p-&gt;<span class="built_in">vfunc1</span>();</span><br></pre></td></tr></table></figure>

<h4 id="i-x3D-i-1和i-x3D-1的区别"><a href="#i-x3D-i-1和i-x3D-1的区别" class="headerlink" title="i&#x3D;i+1和i+&#x3D;1的区别"></a>i&#x3D;i+1和i+&#x3D;1的区别</h4><p>区别是i+&#x3D;1会自动将右侧的运算结果转型成左侧的值；</p>
<h4 id="malloc和new，free和delete的区别"><a href="#malloc和new，free和delete的区别" class="headerlink" title="malloc和new，free和delete的区别"></a>malloc和new，free和delete的区别</h4><ol>
<li>malloc与free是C++&#x2F;C语言的标准库函数，new&#x2F;delete是C++的运算符。它们都可用于申请动态内存和释放内存。 </li>
<li>对于非内部数据类型的对象而言，光用maloc&#x2F;free无法满足动态对象的要求。对象在创建的同时要自动执行构造函数，对象在消亡之前要自动执行析构函数。由于malloc&#x2F;free是库函数而不是运算符，不在编译器控制权限之内，不能够把执行构造函数和析构函数的任务强加于malloc&#x2F;free。 </li>
<li>因此C++语言需要一个能完成动态内存分配和初始化工作的运算符new，以一个能完成清理与释放内存工作的运算符delete。注意new&#x2F;delete不是库函数。</li>
<li>C++程序经常要调用C函数，而C程序只能用malloc&#x2F;free管理动态内存。  </li>
<li>new可以认为是malloc加构造函数的执行。new出来的指针是直接带类型信息的。而malloc返回的都是void指针。</li>
</ol>
<p>如何保证缓存（Redis）与数据库的双写一致性？ </p>
<h4 id="重写equals方法"><a href="#重写equals方法" class="headerlink" title="重写equals方法"></a>重写equals方法</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public class Person&#123;</span><br><span class="line">  int age;</span><br><span class="line">  String name;</span><br><span class="line">  @override</span><br><span class="line">  public boolean equals(Object o)&#123;</span><br><span class="line">    if(o isinstanceof Person)&#123;</span><br><span class="line">      Person p = (Person) o;</span><br><span class="line">      if(age==p.age &amp;&amp; name.equals(p.name))&#123;</span><br><span class="line">        return true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return false;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<p>Kafka 如何处理消息丢失的问题? </p>
<p>如何设计 HBase 的 rowKey？依据哪些设计原则？ </p>
<p>Java 中会出现内存泄漏的情况吗？（OOM）如何解决？ </p>
<p>说一下 volatile 的原理及应用场景 </p>
<p>了解 Java NIO 吗？了解的话说一下 </p>
<p>说一下 Java 反射的原理及应用场景</p>
]]></content>
      <categories>
        <category>工作</category>
      </categories>
      <tags>
        <tag>java</tag>
      </tags>
  </entry>
  <entry>
    <title>markdown基础语法</title>
    <url>/2017/04/18/markdown%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/</url>
    <content><![CDATA[<p>#表示标题级别</p>
]]></content>
      <categories>
        <category>编程</category>
      </categories>
      <tags>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>metaspace解析</title>
    <url>/2019/07/02/metaspace%E8%A7%A3%E6%9E%90/</url>
    <content><![CDATA[<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>metaspace：顾名思义元数据空间，专门用来存储元数据，他是jdk8中特有的数据结构用来代替perm (permanent space：永久代)。</p>
<span id="more"></span>

<h2 id="为什么有metaspace"><a href="#为什么有metaspace" class="headerlink" title="为什么有metaspace"></a>为什么有metaspace</h2><p>jdk8之前有perm这一整块内存来寸klass等信息，我们的参数也会配置perm区域的大小：-XX: PermSize以及-XX：MaxPermSize来控制这块内存的大小，jvm在启动时会根据这些配置来分配一块连续的内存块，但随着动态类加载的轻快越来越多，这块内存变得不太可控，到底设置多大合适是每个开发这一要考虑的问题，设置太小，系统容易出现内存溢出，设置太大会造成浪费。基于这样的一个原因，metaspace出现了，希望内存的管理不再受到限制，也不要怎么关注元数据这块的OOM问题。到目前为止，没有完美解决这个问题。</p>
<p>从JVM代码中可以看出一些问题，比如MaxMetaSpaceSize默认值很大，CompressedClassSpaceSize默认值也有1G，从这些参数可以看到metaspace的作者不希望出现OOM相关的问题。</p>
<h3 id="oop-klass-model-概述"><a href="#oop-klass-model-概述" class="headerlink" title="oop-klass model 概述"></a>oop-klass model 概述</h3><p>上文提到了klass这个信息，这里有必要解释一下。</p>
<p>HotSpot JVM 并没有根据 Java 实例对象直接通过虚拟机映射到新建的 C++ 对象，而是设计了一个 oop-klass model。</p>
<p>当时第一次看到 oop，我的第一反应就是 object-oriented programming，其实这里的 <code>oop</code> 指的是 <em>Ordinary Object Pointer</em>（普通对象指针），它用来表示对象的实例信息，看起来像个指针实际上是藏在指针里的对象。而 <code>klass</code> 则包含 <strong>元数据和方法信息</strong>，用来描述 Java 类。</p>
<p>那么为何要设计这样一个一分为二的对象模型呢？这是因为 HotSopt JVM 的设计者不想让每个对象中都含有一个 vtable（虚函数表），所以就把对象模型拆成 klass 和 oop，其中 oop 中不含有任何虚函数，而 klass 就含有虚函数表，可以进行 method dispatch。这个模型其实是参照的 <strong>Strongtalk VM</strong> 底层的对象模型。</p>
<h2 id="metaspace的组成"><a href="#metaspace的组成" class="headerlink" title="metaspace的组成"></a>metaspace的组成</h2><p>metaspace主要有由两大部分组成：</p>
<ul>
<li>Klass MetaSpace</li>
<li>NoKlass MetaSpace</li>
</ul>
<p>Klass MetaSpace就是用来寸klass的，klass是我们熟知的class文件在jvm里的运行时数据结构，不过有点要提到的是我们看到的类似A.class其实是存在heap里的，是java.lang.class的一个对象实例，这块内存是近接着Heap的，和之前的perm一样，这块内存大小可通过-XX:CompressedClassSpaceSize参数来控制住，这个参数默认是1G，但是这块内存可以没有，假如没有开启压缩指针就不会有这块内存，这种情况下klass都会存在NoKlass Metaspace里面，另外如果我们把-Xmx设置大于32G的话，也没有这块内存，隐者这么大内存会关闭压缩指针开关，还有就是这块内存最多存在一块。</p>
<p>NoKlass MetaSpace专门用来存放klass相关的其他内容，比如method，constantPool等，这块内存是由多块内存组合起来的。所以可以认为是不连续的内存块组成的，这块内存是必须的，虽然叫NoKlass MetaSpace，但是也可以寸klass的内容。</p>
<p>Klass MetaSpace和NoKlass MetaSpace都是所有classloader共享的，所以类加载器们要分配内存，每个类加载器都有一个SpaceManager，来管理属于这个类加载的内存小块，如果klass metaspace用完了，就会OOM，不过一般情况下，NoKlass MetaSpace是由一块块内存组合起来的，在没有达到限制条件的情况下，会不断增长这条链，让它可以继续工作。</p>
<h2 id="metaspace的几个参数"><a href="#metaspace的几个参数" class="headerlink" title="metaspace的几个参数"></a>metaspace的几个参数</h2><ul>
<li>UseLargePagesInMetaspace</li>
<li>InitialBootClassLoaderMetaspaceSize</li>
<li>MetaspaceSize</li>
<li>MaxMetaspaceSize</li>
<li>CompressedClassSpaceSize</li>
<li>MinMetaspaceExpansion</li>
<li>MaxMetaspaceExpansion</li>
<li>MinMetaspaceFreeRatio</li>
<li>MaxMetaspaceFreeRatio</li>
</ul>
<h3 id="UseLargePagesInMetaspace"><a href="#UseLargePagesInMetaspace" class="headerlink" title="UseLargePagesInMetaspace"></a>UseLargePagesInMetaspace</h3><p>默认false，这个参数是说是否在metaspace里使用LargePage，一般情况下我们使用4KB的page size，这个参数依赖于UseLargePages这个参数开启，不过这个参数我们一般不开。</p>
<h3 id="InitialBootClassLoaderMetaspaceSize"><a href="#InitialBootClassLoaderMetaspaceSize" class="headerlink" title="InitialBootClassLoaderMetaspaceSize"></a>InitialBootClassLoaderMetaspaceSize</h3><p>64位下默认4M，32位下默认2200K，metasapce前面已经提到主要分了两大块，Klass Metaspace以及NoKlass Metaspace，而NoKlass Metaspace是由一块块内存组合起来的，这个参数决定了NoKlass Metaspace的第一个内存Block的大小，即2*InitialBootClassLoaderMetaspaceSize，同时为bootstrapClassLoader的第一块内存chunk分配了InitialBootClassLoaderMetaspaceSize的大小</p>
<h3 id="MetaspaceSize"><a href="#MetaspaceSize" class="headerlink" title="MetaspaceSize"></a>MetaspaceSize</h3><p>默认20.8M左右(x86下开启c2模式)，主要是控制metaspaceGC发生的初始阈值，也是最小阈值，但是触发metaspaceGC的阈值是不断变化的，与之对比的主要是指Klass Metaspace与NoKlass Metaspace两块committed的内存和。</p>
<h3 id="MaxMetaspaceSize"><a href="#MaxMetaspaceSize" class="headerlink" title="MaxMetaspaceSize"></a>MaxMetaspaceSize</h3><p>默认基本是无穷大，但是我还是建议大家设置这个参数，因为很可能会因为没有限制而导致metaspace被无止境使用(一般是内存泄漏)而被OS Kill。这个参数会限制metaspace(包括了Klass Metaspace以及NoKlass Metaspace)被committed的内存大小，会保证committed的内存不会超过这个值，一旦超过就会触发GC，这里要注意和MaxPermSize的区别，MaxMetaspaceSize并不会在jvm启动的时候分配一块这么大的内存出来，而MaxPermSize是会分配一块这么大的内存的。</p>
<h3 id="CompressedClassSpaceSize"><a href="#CompressedClassSpaceSize" class="headerlink" title="CompressedClassSpaceSize"></a>CompressedClassSpaceSize</h3><p>默认1G，这个参数主要是设置Klass Metaspace的大小，不过这个参数设置了也不一定起作用，前提是能开启压缩指针，假如-Xmx超过了32G，压缩指针是开启不来的。如果有Klass Metaspace，那这块内存是和Heap连着的。</p>
<h3 id="MinMetaspaceExpansion"><a href="#MinMetaspaceExpansion" class="headerlink" title="MinMetaspaceExpansion"></a>MinMetaspaceExpansion</h3><p>MinMetaspaceExpansion和MaxMetaspaceExpansion这两个参数或许和大家认识的并不一样，也许很多人会认为这两个参数不就是内存不够的时候，然后扩容的最小大小吗？其实不然</p>
<p>这两个参数和扩容其实并没有直接的关系，也就是并不是为了增大committed的内存，而是为了增大触发metaspace GC的阈值</p>
<p>这两个参数主要是在比较特殊的场景下救急使用，比如gcLocker或者<code>should_concurrent_collect</code>的一些场景，因为这些场景下接下来会做一次GC，相信在接下来的GC中可能会释放一些metaspace的内存，于是先临时扩大下metaspace触发GC的阈值，而有些内存分配失败其实正好是因为这个阈值触顶导致的，于是可以通过增大阈值暂时绕过去</p>
<p>默认332.8K，增大触发metaspace GC阈值的最小要求。假如我们要救急分配的内存很小，没有达到MinMetaspaceExpansion，但是我们会将这次触发metaspace GC的阈值提升MinMetaspaceExpansion，之所以要大于这次要分配的内存大小主要是为了防止别的线程也有类似的请求而频繁触发相关的操作，不过如果要分配的内存超过了MaxMetaspaceExpansion，那MinMetaspaceExpansion将会是要分配的内存大小基础上的一个增量</p>
<h3 id="MaxMetaspaceExpansion"><a href="#MaxMetaspaceExpansion" class="headerlink" title="MaxMetaspaceExpansion"></a>MaxMetaspaceExpansion</h3><p>默认5.2M，增大触发metaspace GC阈值的最大要求。假如说我们要分配的内存超过了MinMetaspaceExpansion但是低于MaxMetaspaceExpansion，那增量是MaxMetaspaceExpansion，如果超过了MaxMetaspaceExpansion，那增量是MinMetaspaceExpansion加上要分配的内存大小</p>
<p>注：每次分配只会给对应的线程一次扩展触发metaspace GC阈值的机会，如果扩展了，但是还不能分配，那就只能等着做GC了</p>
<h3 id="MinMetaspaceFreeRatio"><a href="#MinMetaspaceFreeRatio" class="headerlink" title="MinMetaspaceFreeRatio"></a>MinMetaspaceFreeRatio</h3><p>MinMetaspaceFreeRatio和下面的MaxMetaspaceFreeRatio，主要是影响触发metaspaceGC的阈值</p>
<p>默认40，表示每次GC完之后，假设我们允许接下来metaspace可以继续被commit的内存占到了被commit之后总共committed的内存量的MinMetaspaceFreeRatio%，如果这个总共被committed的量比当前触发metaspaceGC的阈值要大，那么将尝试做扩容，也就是增大触发metaspaceGC的阈值，不过这个增量至少是MinMetaspaceExpansion才会做，不然不会增加这个阈值</p>
<p>这个参数主要是为了避免触发metaspaceGC的阈值和gc之后committed的内存的量比较接近，于是将这个阈值进行扩大</p>
<p>一般情况下在gc完之后，如果被committed的量还是比较大的时候，换个说法就是离触发metaspaceGC的阈值比较接近的时候，这个调整会比较明显</p>
<p>注：这里不用gc之后used的量来算，主要是担心可能出现committed的量超过了触发metaspaceGC的阈值，这种情况一旦发生会很危险，会不断做gc，这应该是jdk8在某个版本之后才修复的bug</p>
<h3 id="MaxMetaspaceFreeRatio"><a href="#MaxMetaspaceFreeRatio" class="headerlink" title="MaxMetaspaceFreeRatio"></a>MaxMetaspaceFreeRatio</h3><p>默认70，这个参数和上面的参数基本是相反的，是为了避免触发metaspaceGC的阈值过大，而想对这个值进行缩小。这个参数在gc之后committed的内存比较小的时候并且离触发metaspaceGC的阈值比较远的时候，调整会比较明显</p>
<h2 id="jstat里的metaspace字段"><a href="#jstat里的metaspace字段" class="headerlink" title="jstat里的metaspace字段"></a>jstat里的metaspace字段</h2><p>我们看GC是否异常，除了通过GC日志来做分析之外，我们还可以通过jstat这样的工具展示的数据来分析，前面我公众号里有篇文章介绍了jstat这块的实现，有兴趣的可以到我的公众号<code>你假笨</code>里去翻阅下jstat的这篇文章。</p>
<p>我们通过jstat可以看到metaspace相关的这么一些指标，分别是<code>M</code>，<code>CCS</code>，<code>MC</code>，<code>MU</code>，<code>CCSC</code>，<code>CCSU</code>，<code>MCMN</code>，<code>MCMX</code>，<code>CCSMN</code>，<code>CCSMX</code></p>
<p>它们的定义如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">column &#123;</span><br><span class="line">    header &quot;^M^&quot;  /* Metaspace - Percent Used */</span><br><span class="line">    data (1-((sun.gc.metaspace.capacity - sun.gc.metaspace.used)/sun.gc.metaspace.capacity)) * 100</span><br><span class="line">    align right</span><br><span class="line">    width 6</span><br><span class="line">    scale raw</span><br><span class="line">    format &quot;0.00&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^CCS^&quot;    /* Compressed Class Space - Percent Used */</span><br><span class="line">    data (1-((sun.gc.compressedclassspace.capacity - sun.gc.compressedclassspace.used)/sun.gc.compressedclassspace.capacity)) * 100</span><br><span class="line">    align right</span><br><span class="line">    width 6</span><br><span class="line">    scale raw</span><br><span class="line">    format &quot;0.00&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^MC^&quot; /* Metaspace Capacity - Current */</span><br><span class="line">    data sun.gc.metaspace.capacity</span><br><span class="line">    align center</span><br><span class="line">    width 6</span><br><span class="line">    scale K</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^MU^&quot; /* Metaspae Used */</span><br><span class="line">    data sun.gc.metaspace.used</span><br><span class="line">    align center</span><br><span class="line">    width 6</span><br><span class="line">    scale K</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">   column &#123;</span><br><span class="line">    header &quot;^CCSC^&quot;   /* Compressed Class Space Capacity - Current */</span><br><span class="line">    data sun.gc.compressedclassspace.capacity</span><br><span class="line">    width 8</span><br><span class="line">    align right</span><br><span class="line">    scale K</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^CCSU^&quot;   /* Compressed Class Space Used */</span><br><span class="line">    data sun.gc.compressedclassspace.used</span><br><span class="line">    width 8</span><br><span class="line">    align right</span><br><span class="line">    scale K</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^MCMN^&quot;   /* Metaspace Capacity - Minimum */</span><br><span class="line">    data sun.gc.metaspace.minCapacity</span><br><span class="line">    scale K</span><br><span class="line">    align right</span><br><span class="line">    width 8</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^MCMX^&quot;   /* Metaspace Capacity - Maximum */</span><br><span class="line">    data sun.gc.metaspace.maxCapacity</span><br><span class="line">    scale K</span><br><span class="line">    align right</span><br><span class="line">    width 8</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^CCSMN^&quot;    /* Compressed Class Space Capacity - Minimum */</span><br><span class="line">    data sun.gc.compressedclassspace.minCapacity</span><br><span class="line">    scale K</span><br><span class="line">    align right</span><br><span class="line">    width 8</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  column &#123;</span><br><span class="line">    header &quot;^CCSMX^&quot;  /* Compressed Class Space Capacity - Maximum */</span><br><span class="line">    data sun.gc.compressedclassspace.maxCapacity</span><br><span class="line">    scale K</span><br><span class="line">    align right</span><br><span class="line">    width 8</span><br><span class="line">    format &quot;0.0&quot;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>我这里对这些字段分类介绍下</p>
<h3 id="MC-amp-MU-amp-CCSC-amp-CCSU"><a href="#MC-amp-MU-amp-CCSC-amp-CCSU" class="headerlink" title="MC &amp; MU &amp; CCSC &amp; CCSU"></a>MC &amp; MU &amp; CCSC &amp; CCSU</h3><ul>
<li>MC表示Klass Metaspace以及NoKlass Metaspace两者总共committed的内存大小，单位是KB，虽然从上面的定义里我们看到了是capacity，但是实质上计算的时候并不是capacity，而是committed，这个是要注意的</li>
<li>MU这个无可厚非，说的就是Klass Metaspace以及NoKlass Metaspace两者已经使用了的内存大小</li>
<li>CCSC表示的是Klass Metaspace的已经被commit的内存大小，单位也是KB</li>
<li>CCSU表示Klass Metaspace的已经被使用的内存大小</li>
</ul>
<h3 id="M-amp-CCS"><a href="#M-amp-CCS" class="headerlink" title="M &amp; CCS"></a>M &amp; CCS</h3><ul>
<li>M表示的是Klass Metaspace以及NoKlass Metaspace两者总共的使用率，其实可以根据上面的四个指标算出来，即(CCSU+MU)&#x2F;(CCSC+MC)</li>
<li>CCS表示的是NoKlass Metaspace的使用率，也就是CCSU&#x2F;CCSC算出来的</li>
</ul>
<p>PS：所以我们有时候看到M的值达到了90%以上，其实这个并不一定说明metaspace用了很多了，因为内存是慢慢commit的，所以我们的分母是慢慢变大的，不过当我们committed到一定量的时候就不会再增长了</p>
<h3 id="MCMN-amp-MCMX-amp-CCSMN-amp-CCSMX"><a href="#MCMN-amp-MCMX-amp-CCSMN-amp-CCSMX" class="headerlink" title="MCMN &amp; MCMX &amp; CCSMN &amp; CCSMX"></a>MCMN &amp; MCMX &amp; CCSMN &amp; CCSMX</h3><ul>
<li>MCMN和CCSMN这两个值大家可以忽略，一直都是0</li>
<li>MCMX表示Klass Metaspace以及NoKlass Metaspace两者总共的reserved的内存大小，比如默认情况下Klass Metaspace是通过CompressedClassSpaceSize这个参数来reserved 1G的内存，NoKlass Metaspace默认reserved的内存大小是2* InitialBootClassLoaderMetaspaceSize</li>
<li>CCSMX表示Klass Metaspace reserved的内存大小</li>
</ul>
<p>综上所述，其实看metaspace最主要的还是看<code>MC</code>，<code>MU</code>，<code>CCSC</code>，<code>CCSU</code>这几个具体的大小来判断metaspace到底用了多少更靠谱</p>
<p>本来还想写metaspace内存分配和GC的内容，不过那块说起来又是一个比较大的话题，因为那块大家看起来可能会比较枯燥，有机会再写</p>
<p>PS:本文最先发布在听云博客</p>
]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>jvm</tag>
      </tags>
  </entry>
  <entry>
    <title>mybatis generator使用</title>
    <url>/2019/12/25/mybatis-generator%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>mybatis generator可以说是java开发中必备的工具，可以根据数据库结构生成对应的java object，mapper接口以及<code>mappers.xml</code>文件，可以极大节省开发的时间，提高开发效率。</p>
<span id="more"></span>

<p>mybatis generator又被称为mbg，其有多种运行方式，这里主要讲基于java的方式和基于jar包的方式</p>
<h3 id="基于jar包的方式"><a href="#基于jar包的方式" class="headerlink" title="基于jar包的方式"></a>基于jar包的方式</h3><p>添加如下插件配置，因为<code>mybatis-generator-maven-plugin</code>这个插件的classpath只包含mybatis-generator-core，所以要使用mysql driver的话，需要添加响应的依赖。然后点击maven插件的generate就可以了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;plugin&gt;</span><br><span class="line">  &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">  &lt;executions&gt;</span><br><span class="line">    &lt;execution&gt;</span><br><span class="line">      &lt;id&gt;Generate MyBatis Artifacts&lt;/id&gt;</span><br><span class="line">      &lt;goals&gt;</span><br><span class="line">        &lt;goal&gt;generate&lt;/goal&gt;</span><br><span class="line">      &lt;/goals&gt;</span><br><span class="line">    &lt;/execution&gt;</span><br><span class="line">  &lt;/executions&gt;</span><br><span class="line">  &lt;configuration&gt;</span><br><span class="line">    &lt;configurationFile&gt;src/main/resources/generatorConfig.xml&lt;/configurationFile&gt;</span><br><span class="line">    &lt;verbose&gt;true&lt;/verbose&gt;</span><br><span class="line">    &lt;overwrite&gt;true&lt;/overwrite&gt;</span><br><span class="line">  &lt;/configuration&gt;</span><br><span class="line">  &lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;8.0.18&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt;</span><br><span class="line">      &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">  &lt;/dependencies&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20191225213404.png"></p>
<h3 id="使用java生成"><a href="#使用java生成" class="headerlink" title="使用java生成"></a>使用java生成</h3><p>首先添加依赖，需要mysql和mybatis两个的依赖</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;8.0.18&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>然后创建生成类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.mybatis.generator.api.MyBatisGenerator;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.config.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.config.xml.ConfigurationParser;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.internal.DefaultShellCallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.ClassPathResource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.Resource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Generate</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        List&lt;String&gt; warnings = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">overwrite</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">configFile</span> <span class="operator">=</span> Generate.class.getResourceAsStream(<span class="string">&quot;/generatorConfig.xml&quot;</span>);</span><br><span class="line">        <span class="type">ConfigurationParser</span> <span class="variable">cp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConfigurationParser</span>(warnings);</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">config</span> <span class="operator">=</span> cp.parseConfiguration(configFile);</span><br><span class="line">        <span class="type">DefaultShellCallback</span> <span class="variable">callback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultShellCallback</span>(overwrite);</span><br><span class="line">        <span class="type">MyBatisGenerator</span> <span class="variable">myBatisGenerator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyBatisGenerator</span>(config, callback, warnings);</span><br><span class="line">        myBatisGenerator.generate(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置文件如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">&quot;generator.properties&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">&quot;MySqlContext&quot;</span> <span class="attr">targetRuntime</span>=<span class="string">&quot;MyBatis3&quot;</span> <span class="attr">defaultModelType</span>=<span class="string">&quot;flat&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beginningDelimiter&quot;</span> <span class="attr">value</span>=<span class="string">&quot;`&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;endingDelimiter&quot;</span> <span class="attr">value</span>=<span class="string">&quot;`&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;javaFileEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 为模型生成序列化方法--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">&quot;org.mybatis.generator.plugins.SerializablePlugin&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 为生成的Java模型创建一个toString方法 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">&quot;org.mybatis.generator.plugins.ToStringPlugin&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--生成mapper.xml时覆盖原文件--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">&quot;org.mybatis.generator.plugins.UnmergeableXmlMappersPlugin&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commentGenerator</span> <span class="attr">type</span>=<span class="string">&quot;com.drawon.mall.mbg.CustomCommentGenerator&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suppressAllComments&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suppressDate&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;addRemarkComments&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">&quot;$&#123;jdbc.driverClass&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">connectionURL</span>=<span class="string">&quot;$&#123;jdbc.connectionURL&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">userId</span>=<span class="string">&quot;$&#123;jdbc.username&#125;&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">password</span>=<span class="string">&quot;$&#123;jdbc.password&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--解决mysql驱动升级到8.0后不生成指定数据库代码的问题--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;nullCatalogMeansCurrent&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.drawon.mall.model&quot;</span> <span class="attr">targetProject</span>=<span class="string">&quot;src/main/java/&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.drawon.mall.mapper&quot;</span> <span class="attr">targetProject</span>=<span class="string">&quot;src/main/resources/&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">&quot;XMLMAPPER&quot;</span> <span class="attr">targetPackage</span>=<span class="string">&quot;com.drawon.mall.mapper&quot;</span></span></span><br><span class="line"><span class="tag">                             <span class="attr">targetProject</span>=<span class="string">&quot;src/main/java/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--生成全部表tableName设为%--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">&quot;%&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">sqlStatement</span>=<span class="string">&quot;MySql&quot;</span> <span class="attr">identity</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="自定义注解"><a href="#自定义注解" class="headerlink" title="自定义注解"></a>自定义注解</h3><p>配置文件中commentGenerator是用于生成注解的，我们关闭所有注解，然后再添加自定义的注解，注解生成的配置类是<code>com.drawon.mall.mbg.CustomCommentGenerator</code>，自定义注解继承<code>DefaultCommentGenerator</code>类，覆写其中的<code>addFieldComment</code>和<code>addJavaFileComment</code>函数，如下，这里自定义的主要目的是，添加swagger2的相关注解，用于自动生成接口文档</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javafx.beans.property.Property;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.api.IntrospectedColumn;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.api.IntrospectedTable;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.api.dom.java.CompilationUnit;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.api.dom.java.Field;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.api.dom.java.FullyQualifiedJavaType;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.config.PropertyRegistry;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.internal.DefaultCommentGenerator;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.generator.internal.util.StringUtility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> org.mybatis.generator.internal.util.StringUtility.isTrue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomCommentGenerator</span> <span class="keyword">extends</span> <span class="title class_">DefaultCommentGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXAMPLE_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot;Example&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">API_MODEL_PROPERTY_FULL_CLASS_NAME</span> <span class="operator">=</span> <span class="string">&quot;io.swagger.annotations.ApiModelProperty&quot;</span>;</span><br><span class="line">    <span class="type">boolean</span> addRemarkComments;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addConfigurationProperties</span><span class="params">(Properties properties)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addConfigurationProperties(properties);</span><br><span class="line">        <span class="built_in">this</span>.addRemarkComments = isTrue(properties.getProperty(PropertyRegistry.COMMENT_GENERATOR_ADD_REMARK_COMMENTS));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addFieldComment</span><span class="params">(Field field, IntrospectedTable introspectedTable, IntrospectedColumn introspectedColumn)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">remarks</span> <span class="operator">=</span> introspectedColumn.getRemarks();</span><br><span class="line">        <span class="keyword">if</span> (addRemarkComments &amp;&amp; StringUtility.stringHasValue(remarks)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (remarks.contains(<span class="string">&quot;\&quot;&quot;</span>)) &#123;</span><br><span class="line">                remarks = remarks.replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            field.addAnnotation(<span class="string">&quot;@ApiModelProperty(value = \&quot;&quot;</span> + remarks + <span class="string">&quot;\&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addJavaFileComment</span><span class="params">(CompilationUnit compilationUnit)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.addJavaFileComment(compilationUnit);</span><br><span class="line">        <span class="keyword">if</span> (!compilationUnit.getClass().isInterface() &amp;&amp;</span><br><span class="line">                !compilationUnit.getType().getFullyQualifiedName().contains(EXAMPLE_SUFFIX)) &#123;</span><br><span class="line">            compilationUnit.addImportedType(<span class="keyword">new</span> <span class="title class_">FullyQualifiedJavaType</span>(API_MODEL_PROPERTY_FULL_CLASS_NAME));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
        <category>中间件</category>
      </categories>
      <tags>
        <tag>mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>pandas入门</title>
    <url>/2017/09/24/pandas%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>pandas当中最重要的部分就是pandas提供的dataframe和series类型，可以用来保存任何形式的数据，保存之后的结果类似于二维表的形式</p>
<span id="more"></span>

<h3 id="Series"><a href="#Series" class="headerlink" title="Series"></a>Series</h3><p>series有两个重要的参数是values和index</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [76]: obj = pd.Series([4,5,6,7])</span><br><span class="line"></span><br><span class="line">In [77]: obj</span><br><span class="line">Out[77]:</span><br><span class="line">0    4</span><br><span class="line">1    5</span><br><span class="line">2    6</span><br><span class="line">3    7</span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [78]: obj.index</span><br><span class="line">Out[78]: RangeIndex(start=0, stop=4, step=1)</span><br><span class="line"></span><br><span class="line">In [79]: obj.values</span><br><span class="line">Out[79]: array([4, 5, 6, 7], dtype=int64)</span><br></pre></td></tr></table></figure>

<p>Series本身和索引都有一个index属性，<font color='red'><strong>pandas有一个重要特征就是其iloc选择时是后包含的</strong>，比如df[:4,1]是指的0,1,2,3,4行的第1列</font></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [81]: obj.name = &#x27;population&#x27;</span><br><span class="line"></span><br><span class="line">In [82]: obj.index.name = &#x27;state&#x27;</span><br><span class="line"></span><br><span class="line">In [83]: obj</span><br><span class="line">Out[83]:</span><br><span class="line">state</span><br><span class="line">0    4</span><br><span class="line">1    5</span><br><span class="line">2    6</span><br><span class="line">3    7</span><br><span class="line">Name: population, dtype: int64</span><br></pre></td></tr></table></figure>

<h3 id="DataFrame"><a href="#DataFrame" class="headerlink" title="DataFrame"></a>DataFrame</h3><p>DataFrame是一个表格型数据结构，同时有行索引和列索引，列的索引被称为columns，行索引被称为index</p>
<p>DataFrame的值仍然存储在values属性里面</p>
<p>更换列的顺序只需要在创建dataframe的时候指定columns的值</p>
<p>其columns和index也可以分别指定名字</p>
<h3 id="index"><a href="#index" class="headerlink" title="index"></a>index</h3><p>index对象是不可更改的</p>
<p>reindex方法可以改变原先index的顺序，不过值也会跟着变，相当于换行的顺序，其中的columns参数可以重新索引列，其中的method可以指定对于不存在的index的插值方法，ffill或pad表示向前填充，bfill和backfill表示向后填充</p>
<h3 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h3><p>drop用于删除某些行或某些列，删除index行的时候只需要传入index，删除列的时候要传入columns的名字和axis&#x3D;1</p>
<h3 id="applymap和apply"><a href="#applymap和apply" class="headerlink" title="applymap和apply"></a>applymap和apply</h3><p>apply可以应用函数到dataframe上，applymap可以应用函数到元素集级别上</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [8]: df = pd.DataFrame(np.arange(0,1,0.1).reshape(2,5))</span><br><span class="line"></span><br><span class="line">In [9]: df</span><br><span class="line">Out[9]:</span><br><span class="line">     0    1    2    3    4</span><br><span class="line">0  0.0  0.1  0.2  0.3  0.4</span><br><span class="line">1  0.5  0.6  0.7  0.8  0.9</span><br><span class="line"></span><br><span class="line">In [12]: df.applymap(format)</span><br><span class="line">Out[12]:</span><br><span class="line">          0         1         2         3         4</span><br><span class="line">0  0.000000  0.100000  0.200000  0.300000  0.400000</span><br><span class="line">1  0.500000  0.600000  0.700000  0.800000  0.900000</span><br></pre></td></tr></table></figure>



<h3 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h3><ol>
<li>sort_index：按照索引排序，传入axis&#x3D;1则按columns进行排序，传入by参数则按照某列的值进行排序</li>
<li>order：对Series进行排序</li>
</ol>
<h3 id="描述和汇总统计"><a href="#描述和汇总统计" class="headerlink" title="描述和汇总统计"></a>描述和汇总统计</h3><table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>count</td>
<td>非NA的值的数量</td>
</tr>
<tr>
<td>decribe</td>
<td>统计性描述，包括max，min，mena等</td>
</tr>
<tr>
<td>max，min</td>
<td>最大最小值</td>
</tr>
<tr>
<td>argmax, argmin</td>
<td>获取到最大最小值的索引位置（整数）</td>
</tr>
<tr>
<td>quantile</td>
<td>计算样本的分位数</td>
</tr>
<tr>
<td>sum</td>
<td>总和</td>
</tr>
<tr>
<td>median</td>
<td>中位数</td>
</tr>
<tr>
<td>mad</td>
<td>平均绝对离差</td>
</tr>
<tr>
<td>var、std</td>
<td>方差、标准差</td>
</tr>
<tr>
<td>skew</td>
<td>三阶矩（样本的偏度）</td>
</tr>
<tr>
<td>kurt</td>
<td>四阶矩（样本的峰度）</td>
</tr>
<tr>
<td>cumsum</td>
<td>累积和</td>
</tr>
<tr>
<td>cummin,cummax</td>
<td>样本的累计最大值和累积最小值</td>
</tr>
<tr>
<td>cumprod（cum表示cumulative累积的，prod表示product乘积）</td>
<td>样本的累计积</td>
</tr>
<tr>
<td>diff</td>
<td>一阶差分</td>
</tr>
<tr>
<td>pct_change</td>
<td>计算百分数变化（比如股票涨跌计算）</td>
</tr>
</tbody></table>
<p>初始化一个dataFrame，可以read_csv从csv文件获取，也可以通过如下代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">df = pd.DataFrame(data, index, columns)</span><br></pre></td></tr></table></figure>
<p>其中data是numpy中提供的数组或者是字典，index表示每行最左边用于索引的列，columns表示每一列的名称</p>
<p>要取出DataFrame的值，只需要df.column_name，用<code>.</code>加上列的名字就可以了</p>
<h2 id="查看数据"><a href="#查看数据" class="headerlink" title="查看数据"></a>查看数据</h2><p>通过</p>
<ol>
<li><code>df.head</code>：查看前五行数据，</li>
<li><code>df.columns</code>：查看列名</li>
<li><code>df.values</code>：查看矩阵的值</li>
<li><code>df.describe()</code>：查看矩阵的统计描述，包括值的个数，平均值，标准差，最大最小值等等</li>
<li><code>df.T</code>：转置矩阵</li>
<li><code>df.sort_index(axis=1, ascending=False)</code>：通过列的大小值比较进行排序，axis&#x3D;0时按照行的大小值进行排序</li>
<li><code>df.sort_values(by=&#39;B&#39;)</code></li>
<li><code>df.A</code>或者<code>df[&#39;A&#39;]</code>：选取某一列的值</li>
<li><code>df[0:3]</code>：通过行号选取某几行的值</li>
<li><code>df[&#39;20101010&#39;:&#39;20101030&#39;]</code>：通过索引选取某些行的值</li>
<li><code>df.loc[data[0]]</code>：通过索引进行选取，<strong>表示的是loc</strong></li>
<li><code>df.iloc[1:3,1:4]</code>：通过位置进行选取</li>
<li><code>df.iloc[[1,3,4],[0,2]]</code>：通过位置跳跃式选取，<strong>表示的是int loc，通过正数进行索引</strong></li>
<li><code>df[df.A &gt; 0]</code>：条件选择</li>
</ol>
<h2 id="处理丢失数据"><a href="#处理丢失数据" class="headerlink" title="处理丢失数据"></a>处理丢失数据</h2><p>首先复制并修改一下df的索引和columns</p>
<p><code> df1 = df.reindex(index=dates[0:4], columns=list(df.columns) + [&#39;E&#39;])</code></p>
<p>这样因为第E列是没有赋值的所以全部为NAN</p>
<p>对于nan数据的处理有两种方法，分别是<code>dropna</code>和<code>fillna</code></p>
<ol>
<li><code>df1.dropnan(how=&#39;any&#39;)</code>：删除所有值为nan的行</li>
<li><code>df1.fillnan(value=5)</code>：将所有nan的值填充为5，可以用字典的形式指定每一列的填充值</li>
</ol>
<p>查找所有的nan，<code>pd.isnull(df1)</code>或者是<code>pd.notnull(df)</code></p>
<h2 id="对数据进行统计操作"><a href="#对数据进行统计操作" class="headerlink" title="对数据进行统计操作"></a>对数据进行统计操作</h2><ol>
<li><code>df.mean()</code>：默认求取的是每列的值，得到一个行向量</li>
<li><code>df.mean(1)</code>：按行求平均值，得到一个列向量</li>
<li><code>df.apply(lambda:x:x.max()-x.min())</code>：apply应用一个函数到</li>
</ol>
<h2 id="DataFrame拼接"><a href="#DataFrame拼接" class="headerlink" title="DataFrame拼接"></a>DataFrame拼接</h2><p><strong>增加行</strong>：append，<strong>增加列</strong>：assign，<code>df.assign(age=[1,2,3])</code></p>
<p><strong>将list连接成DataFrame</strong>或者<strong>增加列</strong>，concat，参数为axes，指定按行合并还是按列合并；参数key，按行合并时可以建立层次化索引，按列合并时作为列的名称。ignore_index&#x3D;true，可以让合并之后的index是行号而没有重复。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(np.random.randn(<span class="number">10</span>, <span class="number">4</span>))</span><br><span class="line">pieces = [df[:<span class="number">3</span>], df[<span class="number">3</span>:<span class="number">7</span>], df[<span class="number">7</span>:]]</span><br><span class="line">pd.concat(pieces)</span><br></pre></td></tr></table></figure>

<p>将两个DataFrame按值连接在一起（数据库风格的合并），merge，参数为on，表示按那一列进行合并，默认的how参数为Inner，即内连接，如果要保留所有的值，可以将how设置为outer（外连接时等同于join）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">left = pd.DataFrame(&#123;<span class="string">&#x27;key&#x27;</span>: [<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>], <span class="string">&#x27;lval&#x27;</span>: [<span class="number">1</span>, <span class="number">2</span>]&#125;)</span><br><span class="line">right = pd.DataFrame(&#123;<span class="string">&#x27;key&#x27;</span>: [<span class="string">&#x27;foo&#x27;</span>, <span class="string">&#x27;foo&#x27;</span>], <span class="string">&#x27;rval&#x27;</span>: [<span class="number">4</span>, <span class="number">5</span>]&#125;)</span><br><span class="line">In [<span class="number">79</span>]: left</span><br><span class="line">Out[<span class="number">79</span>]: </span><br><span class="line">   key  lval</span><br><span class="line"><span class="number">0</span>  foo     <span class="number">1</span></span><br><span class="line"><span class="number">1</span>  foo     <span class="number">2</span></span><br><span class="line">In [<span class="number">80</span>]: right</span><br><span class="line">Out[<span class="number">80</span>]: </span><br><span class="line">   key  rval</span><br><span class="line"><span class="number">0</span>  foo     <span class="number">4</span></span><br><span class="line"><span class="number">1</span>  foo     <span class="number">5</span></span><br><span class="line">In [<span class="number">81</span>]: pd.merge(left, right, on=<span class="string">&#x27;key&#x27;</span>)</span><br><span class="line">Out[<span class="number">81</span>]: </span><br><span class="line">   key  lval  rval</span><br><span class="line"><span class="number">0</span>  foo     <span class="number">1</span>     <span class="number">4</span></span><br><span class="line"><span class="number">1</span>  foo     <span class="number">1</span>     <span class="number">5</span></span><br><span class="line"><span class="number">2</span>  foo     <span class="number">2</span>     <span class="number">4</span></span><br><span class="line"><span class="number">3</span>  foo     <span class="number">2</span>     <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>将两个DataFrame按行连接在一起，Append</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(np.random.randn(<span class="number">8</span>, <span class="number">4</span>), columns=[<span class="string">&#x27;A&#x27;</span>,<span class="string">&#x27;B&#x27;</span>,<span class="string">&#x27;C&#x27;</span>,<span class="string">&#x27;D&#x27;</span>])</span><br><span class="line">s = df.iloc[<span class="number">3</span>]</span><br><span class="line">df.append(s, ignore_index=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>按条件分组，groupby</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">df.groupby(&#x27;A&#x27;).sum()</span><br></pre></td></tr></table></figure>

<h3 id="对数据进行分类"><a href="#对数据进行分类" class="headerlink" title="对数据进行分类"></a>对数据进行分类</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">df = pd.DataFrame(&#123;&quot;id&quot;:[1,2,3,4,5,6], &quot;raw_grade&quot;:[&#x27;a&#x27;, &#x27;b&#x27;, &#x27;b&#x27;, &#x27;a&#x27;, &#x27;a&#x27;, &#x27;e&#x27;]&#125;)</span><br><span class="line">df[&quot;grade&quot;] = df[&quot;raw_grade&quot;].astype(&quot;category&quot;)</span><br></pre></td></tr></table></figure>

<p>对分类重命名：<code>Series.cat.categories</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">df[&quot;grade&quot;].cat.categories = [&quot;very good&quot;, &quot;good&quot;, &quot;very bad&quot;]</span><br></pre></td></tr></table></figure>

<h2 id="正则表达式条件判定"><a href="#正则表达式条件判定" class="headerlink" title="正则表达式条件判定"></a>正则表达式条件判定</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">operating_system = np.where(cframe[<span class="string">&#x27;a&#x27;</span>].<span class="built_in">str</span>.contains(<span class="string">&#x27;Windows&#x27;</span>),<span class="string">&#x27;Windows&#x27;</span>,<span class="string">&#x27;Not Windows&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>这里用<code>np.where</code>和<code>DataFrame.str.contains(&#39;&#39;)</code>来进行判定一个字符串是否包含windows，如果包含则将其改为windows，否则将其改为’not windows’</p>
<h2 id="数据规整"><a href="#数据规整" class="headerlink" title="数据规整"></a>数据规整</h2><h3 id="stack和unstack"><a href="#stack和unstack" class="headerlink" title="stack和unstack"></a>stack和unstack</h3><p><code>stack</code>：将行旋转为列</p>
<p><code>unstack</code>：将列旋转为行，默认进行的是最内层的一列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>data=DataFrame(np.arange(<span class="number">6</span>).reshape((<span class="number">2</span>,<span class="number">3</span>)),index=[<span class="string">&#x27;ohio&#x27;</span>,<span class="string">&#x27;colorado&#x27;</span>],columns=[<span class="string">&#x27;one&#x27;</span>,<span class="string">&#x27;two&#x27;</span>,<span class="string">&#x27;three&#x27;</span>])</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data</span><br><span class="line">          one  two  three</span><br><span class="line">ohio        <span class="number">0</span>    <span class="number">1</span>      <span class="number">2</span></span><br><span class="line">colorado    <span class="number">3</span>    <span class="number">4</span>      <span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.index.name=<span class="string">&#x27;state&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.columns.name=<span class="string">&#x27;number&#x27;</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data</span><br><span class="line">number    one  two  three</span><br><span class="line">state                    </span><br><span class="line">ohio        <span class="number">0</span>    <span class="number">1</span>      <span class="number">2</span></span><br><span class="line">colorado    <span class="number">3</span>    <span class="number">4</span>      <span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>data.stack()</span><br><span class="line">state     number</span><br><span class="line">ohio      one       <span class="number">0</span></span><br><span class="line">          two       <span class="number">1</span></span><br><span class="line">          three     <span class="number">2</span></span><br><span class="line">colorado  one       <span class="number">3</span></span><br><span class="line">          two       <span class="number">4</span></span><br><span class="line">          three     <span class="number">5</span></span><br><span class="line"><span class="comment">#将列转化为行，得到一个Series</span></span><br><span class="line"><span class="comment">#对于一个层次化索引的Series，可以用unstack将其重排为一个DataFrame</span></span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">result.unstack(<span class="number">0</span>)</span><br><span class="line">state   ohio  colorado</span><br><span class="line">number                </span><br><span class="line">one        <span class="number">0</span>         <span class="number">3</span></span><br><span class="line">two        <span class="number">1</span>         <span class="number">4</span></span><br><span class="line">three      <span class="number">2</span>         <span class="number">5</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>result.unstack(<span class="string">&#x27;state&#x27;</span>)</span><br><span class="line">state   ohio  colorado</span><br><span class="line">number                </span><br><span class="line">one        <span class="number">0</span>         <span class="number">3</span></span><br><span class="line">two        <span class="number">1</span>         <span class="number">4</span></span><br><span class="line">three      <span class="number">2</span>         <span class="number">5</span></span><br></pre></td></tr></table></figure>

<h3 id="pivot-table：数据透视表"><a href="#pivot-table：数据透视表" class="headerlink" title="pivot_table：数据透视表"></a>pivot_table：数据透视表</h3><p>比如在电影打分里面，想得到男女对不同电影的打分，可以使用以下的函数</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mean_ratings = data.pivot_table(&#x27;rating&#x27;, index=&#x27;title&#x27;, columns=&#x27;gender&#x27;, aggfunc=&#x27;mean&#x27;)</span><br></pre></td></tr></table></figure>

<h2 id="数据类型转换"><a href="#数据类型转换" class="headerlink" title="数据类型转换"></a>数据类型转换</h2><p><code>df.astype(int)</code>：将所有数据转换为int类型</p>
<h2 id="数据排序"><a href="#数据排序" class="headerlink" title="数据排序"></a>数据排序</h2><p><code>argsort</code>：直接将值改为排序后的标号</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Africa/Cairo                      <span class="number">20</span></span><br><span class="line">Africa/Casablanca                 <span class="number">21</span></span><br><span class="line">Africa/Ceuta                      <span class="number">92</span></span><br><span class="line">Africa/Johannesburg               <span class="number">87</span></span><br><span class="line">Africa/Lusaka                     <span class="number">53</span></span><br><span class="line"><span class="comment"># 右边得出的是他们经过排序之后的序号</span></span><br></pre></td></tr></table></figure>
<p>通过<code>take</code>函数可以取出以<code>argsort</code>为index的数据</p>
<p>##将多个文件里面的数据连接在一起</p>
<p>用一个循环，每次用<code>read_csv</code>或者是<code>read_table</code>函数读出一个dataframe，然后append到一个空list里面，最后通过<code>pd.concat(frame,ignore_index=True)</code>连接成一个大的dataframe</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">years = range(1880,2011)</span><br><span class="line">frame = []</span><br><span class="line">for year in years:</span><br><span class="line">    filename = &#x27;yob&#123;&#125;.txt&#x27;.format(year)</span><br><span class="line">    df = pd.read_csv(filename,names=[&#x27;name&#x27;,&#x27;sex&#x27;,&#x27;births&#x27;])</span><br><span class="line">    frame.append(df)</span><br><span class="line">data = pd.concat(frame,ignore_index=True)</span><br><span class="line">data.to_csv(&#x27;birth_data.csv&#x27;)</span><br></pre></td></tr></table></figure>

<h2 id="多列索引重新排序"><a href="#多列索引重新排序" class="headerlink" title="多列索引重新排序"></a>多列索引重新排序</h2><p>swaplevel：交换索引<br>sortlevel：索引排序</p>
<p>set_index：和stack很像，将列值变成索引</p>
<p>reset_index：和unstack很像，将多级索引编程列值</p>
<h2 id="数据读入"><a href="#数据读入" class="headerlink" title="数据读入"></a>数据读入</h2><p>读入方法</p>
<ol>
<li><code>read_csv</code>：用于读取csv，默认分隔符为逗号，需要修改默认分隔符用seperator参数，指定列名用header，无列名时用header&#x3D;None，无index用index&#x3D;None</li>
<li><code>read_table</code>：读取txt文件，默认分隔符’\t’，如果分隔符不止一个\t的空格，那么用seperator&#x3D;’\s+’</li>
<li><code>read_fwf</code>：fixed-width file，读取定宽文件，也就是没有分隔符</li>
<li><code>read_clipboard</code>：读取剪贴板中的数据，在将网页转换为表格时很有用</li>
</ol>
<ul>
<li>如果只想读入前n行，可以使用nrows参数，指定读入的行数</li>
</ul>
<p>读入json的方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="comment">#将json读入为python对象-字典</span></span><br><span class="line">result = json.loads(obj)</span><br><span class="line"><span class="comment">#将python对象转化为json</span></span><br><span class="line">asjson = json.dumps(result)</span><br></pre></td></tr></table></figure>

<h2 id="将长格式转换为宽格式"><a href="#将长格式转换为宽格式" class="headerlink" title="将长格式转换为宽格式"></a>将长格式转换为宽格式</h2><p>pivot函数：第一个参数表示行索引的列，第二个参数表示列索引的列</p>
<h2 id="移除重复数据"><a href="#移除重复数据" class="headerlink" title="移除重复数据"></a>移除重复数据</h2><p>duplicated()：返回一个布尔型变量</p>
<p>drop_duplicates：移除重复行的DataFrame，默认保留第一个出现的值，如果要保存最后一个应该传入take_last&#x3D;True</p>
<h2 id="对某列传入一个函数"><a href="#对某列传入一个函数" class="headerlink" title="对某列传入一个函数"></a>对某列传入一个函数</h2><p>map</p>
<h2 id="重命名轴索引"><a href="#重命名轴索引" class="headerlink" title="重命名轴索引"></a>重命名轴索引</h2><p>rename：得到原始的轴索引的转换版（比如首字母大写或者是全大写）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">data.rename(index=str.title，columns=str.upper)</span><br></pre></td></tr></table></figure>

<h2 id="值分区"><a href="#值分区" class="headerlink" title="值分区"></a>值分区</h2><p>pd.cut(data, [0, 5, 15, 20], right&#x3D;False)：将数据按照[0,5),[5,15),[15,20)进行划分</p>
<p>pd.qcut（data，4）将数据按分位数等分为4份</p>
<h2 id="随机重排"><a href="#随机重排" class="headerlink" title="随机重排"></a>随机重排</h2><p>np.random.permutation(x)：若x是一个整数，那么返回打乱的np.arange(x)，然后通过df.take随机选出这若干行；若x是一个数组，那么返回一个打乱的数组的copy</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">r = np.random.permutation(len(df))[:5]</span><br><span class="line">df_r = df.take(r)</span><br></pre></td></tr></table></figure>

<h2 id="计算哑变量"><a href="#计算哑变量" class="headerlink" title="计算哑变量"></a>计算哑变量</h2><p>get_dummies</p>
<h2 id="Series字符串处理"><a href="#Series字符串处理" class="headerlink" title="Series字符串处理"></a>Series字符串处理</h2><p>series.str.xxx</p>
<p>其中包含了一大堆字符串处理函数，比如：contains，findall</p>
<p>也可以使用map和正则表达式来完成</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>数据分析</tag>
        <tag>pandas</tag>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>numpy教程</title>
    <url>/2017/10/22/numpy%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h2 id="使用jupyter-notebook-分析数据之前导入的包"><a href="#使用jupyter-notebook-分析数据之前导入的包" class="headerlink" title="使用jupyter notebook 分析数据之前导入的包"></a>使用jupyter notebook 分析数据之前导入的包</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import numpy as np # linear algebra</span><br><span class="line">import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)</span><br><span class="line"></span><br><span class="line">%matplotlib inline</span><br><span class="line">import matplotlib.pyplot as plt  # Matlab-style plotting</span><br><span class="line">import seaborn as sns</span><br><span class="line">color = sns.color_palette()</span><br><span class="line">sns.set_style(&#x27;darkgrid&#x27;)</span><br><span class="line"></span><br><span class="line">import warnings</span><br><span class="line">def ignore_warn(*args, **kwargs):</span><br><span class="line">    pass</span><br><span class="line">warnings.warn = ignore_warn #ignore annoying warning (from sklearn and seaborn)</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>在<code>numpy</code>的使用过程中，最重要的概念就是<code>ndarray</code>，实质上就是数组，在<code>numpy</code>中的所有对象都是<code>ndarray</code> </p>
<p>每一个ndarray对象都有一个shape和dtype属性，用于存储<strong>数组的形状</strong>和<strong>数据类型</strong></p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">array</td>
<td align="left">将输入的数据转换为ndarray</td>
</tr>
<tr>
<td align="left">asarray</td>
<td align="left">将输入转换为ndarray</td>
</tr>
<tr>
<td align="left">arange</td>
<td align="left">range的数组版本</td>
</tr>
<tr>
<td align="left">ones、ones_like</td>
<td align="left">根据指定的形状创建一个全1的数组，ones_like以另一个数组为参数，创建一个与该数组大小相同的全为1的数组</td>
</tr>
<tr>
<td align="left">zero、zeros_like</td>
<td align="left">与ones和ones_like类似</td>
</tr>
<tr>
<td align="left">empty、empty_like</td>
<td align="left">创建一个没有赋予初始值的数组，用法与ones和ones_like类似</td>
</tr>
<tr>
<td align="left">eye，identity</td>
<td align="left">创建一个单位矩阵</td>
</tr>
</tbody></table>
<p>可以通过ndarray的astype方法将数组的数据类型转换为其他类型</p>
<h3 id="乘法"><a href="#乘法" class="headerlink" title="乘法"></a>乘法</h3><p>*：直接用乘号或者除号，表示数组<strong>元素之间直接相乘</strong>，这个操作称之为广播（不同大小数组之间的运算）</p>
<p><strong>np.dot(x,y)或x.dot(y)：用于矩阵乘积</strong></p>
<h3 id="索引和复制"><a href="#索引和复制" class="headerlink" title="索引和复制"></a>索引和复制</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: arr = np.arange(<span class="number">10</span>)</span><br><span class="line">In [<span class="number">2</span>]: arr</span><br><span class="line">Out[<span class="number">2</span>]: array([<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>])</span><br><span class="line">In [<span class="number">3</span>]: arr[<span class="number">5</span>:<span class="number">8</span>] = <span class="number">12</span></span><br><span class="line">In [<span class="number">4</span>]: arr</span><br><span class="line">Out[<span class="number">4</span>]: array([ <span class="number">0</span>,  <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>,  <span class="number">4</span>, <span class="number">12</span>, <span class="number">12</span>, <span class="number">12</span>,  <span class="number">8</span>,  <span class="number">9</span>])</span><br><span class="line">In [<span class="number">5</span>]: arr_slice = arr[<span class="number">5</span>:<span class="number">8</span>]</span><br><span class="line">In [<span class="number">6</span>]: arr_slice[<span class="number">1</span>] = <span class="number">12345</span></span><br><span class="line">In [<span class="number">7</span>]: arr</span><br><span class="line">Out[<span class="number">7</span>]: array([    <span class="number">0</span>,     <span class="number">1</span>,     <span class="number">2</span>,     <span class="number">3</span>,     <span class="number">4</span>,    <span class="number">12</span>, <span class="number">12345</span>,    <span class="number">12</span>,     <span class="number">8</span>,     <span class="number">9</span>])</span><br></pre></td></tr></table></figure>

<p>numpy当中所有数据切片赋值时都是没有进行复制的，视图上的任何修改都会直接反映到原数组上，因为numpy一般处理非常大的数据集，如果numpy每次进行操作的话就是复制非常多的数据。</p>
<h3 id="花式索引（fancy-indexing）"><a href="#花式索引（fancy-indexing）" class="headerlink" title="花式索引（fancy indexing）"></a>花式索引（fancy indexing）</h3> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [1]: arr = np.arange(32).reshape((8,4))</span><br><span class="line"></span><br><span class="line">In [2]: arr</span><br><span class="line">Out[2]:</span><br><span class="line">array([[ 0,  1,  2,  3],</span><br><span class="line">       [ 4,  5,  6,  7],</span><br><span class="line">       [ 8,  9, 10, 11],</span><br><span class="line">       [12, 13, 14, 15],</span><br><span class="line">       [16, 17, 18, 19],</span><br><span class="line">       [20, 21, 22, 23],</span><br><span class="line">       [24, 25, 26, 27],</span><br><span class="line">       [28, 29, 30, 31]])</span><br><span class="line"></span><br><span class="line">In [3]: arr[[-1,1,3]]</span><br><span class="line">Out[3]:</span><br><span class="line">array([[28, 29, 30, 31],</span><br><span class="line">       [ 4,  5,  6,  7],</span><br><span class="line">       [12, 13, 14, 15]])</span><br><span class="line">In [4]: arr[[1,2,3,-1],[3,2,1,0]]</span><br><span class="line">Out[4]: array([ 7, 10, 13, 28])</span><br></pre></td></tr></table></figure>

<p>同时传入多个索引，一次索引出多个值</p>
<h3 id="转置"><a href="#转置" class="headerlink" title="转置"></a>转置</h3><p>arr.T表示arr的转置，或者transpose方法表示转置</p>
<p>tanspose有一个换维度的操作</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [4]: arr = np.arange(16).reshape((2,2,4))</span><br><span class="line"></span><br><span class="line">In [5]: arr</span><br><span class="line">Out[5]:</span><br><span class="line">array([[[ 0,  1,  2,  3],</span><br><span class="line">        [ 4,  5,  6,  7]],</span><br><span class="line"></span><br><span class="line">       [[ 8,  9, 10, 11],</span><br><span class="line">        [12, 13, 14, 15]]])</span><br><span class="line"></span><br><span class="line">In [6]: arr.transpose((1,0,2))</span><br><span class="line">Out[6]:</span><br><span class="line">array([[[ 0,  1,  2,  3],</span><br><span class="line">        [ 8,  9, 10, 11]],</span><br><span class="line"></span><br><span class="line">       [[ 4,  5,  6,  7],</span><br><span class="line">        [12, 13, 14, 15]]])</span><br><span class="line">简而言之就是将原来的0，1，2轴变成现在的1，0，2，转换后的0轴是原来的1轴，转换后的1轴是原来的0轴，2轴未变。</span><br><span class="line">换种解释：比如说8元素的索引是[1,0,0]，0，1轴变换后是[0,1,0]。</span><br></pre></td></tr></table></figure>

<h3 id="通用函数"><a href="#通用函数" class="headerlink" title="通用函数"></a>通用函数</h3><p>（ufunc）：快速的元素级数组函数</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>abs,fabs</td>
<td>计算绝对值，对于非复数，可以使用更快的fabs</td>
</tr>
<tr>
<td>sqrt</td>
<td>计算元素的平方根，相当于arr**0.5</td>
</tr>
<tr>
<td>square</td>
<td>计算各元素平，相当于arr**2</td>
</tr>
<tr>
<td>log，log10，log2，log1p</td>
<td>计算自然对数，以10位底的对数，底数为2的对数，以及log（1+x）</td>
</tr>
<tr>
<td>sign</td>
<td>取元素的符号，1正，0零，-1负</td>
</tr>
<tr>
<td>ceil</td>
<td>向上取整</td>
</tr>
<tr>
<td></td>
<td>向下取整</td>
</tr>
<tr>
<td></td>
<td>四舍五入取整</td>
</tr>
<tr>
<td></td>
<td>将数组的小数和整数部分分别用两个数组返回</td>
</tr>
<tr>
<td>isfinite,isinf</td>
<td>返回哪些元素是有穷的，哪些元素是无穷的布尔型数组</td>
</tr>
<tr>
<td>cos,cosh,sin,sinh,tan,tanh</td>
<td>三角函数</td>
</tr>
<tr>
<td>logical_not</td>
<td>计算各元素not x的真值，相当于-arr</td>
</tr>
</tbody></table>
<p>二元ufunc</p>
<table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>add</td>
<td>将数组对应元素相加</td>
</tr>
<tr>
<td>subtract</td>
<td>对应元素相减</td>
</tr>
<tr>
<td>multiply</td>
<td>对应元素相乘</td>
</tr>
<tr>
<td>divide，floor_divide</td>
<td>除法或丢掉余数的整除法</td>
</tr>
<tr>
<td>pow</td>
<td>计算$A^B$</td>
</tr>
<tr>
<td>maximum, fmax</td>
<td>元素级的最大值计算，fmax忽略nana</td>
</tr>
<tr>
<td>minimum,fmin</td>
<td>最小值计算</td>
</tr>
<tr>
<td>mod</td>
<td>求模运算</td>
</tr>
<tr>
<td>copysign</td>
<td>将B数组的符号复制给第一个数组</td>
</tr>
<tr>
<td>greater，greater_equal，less，less_equal,equal, not_equal</td>
<td>元素比较</td>
</tr>
<tr>
<td>logical_and, logical_or，logical_xor</td>
<td>元素级别真值逻辑运算</td>
</tr>
</tbody></table>
<h3 id="meshgrid函数"><a href="#meshgrid函数" class="headerlink" title="meshgrid函数"></a>meshgrid函数</h3><p><code>X,Y = np.meshgrid(a,b)</code> 得到X为a作为行向量，扩展b.shape那么多行，Y是以b为列向量，扩展a.shape那么多列</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [67]: xnums</span><br><span class="line">Out[67]: array([0,1, 2, 3])</span><br><span class="line"> </span><br><span class="line">In [68]: ynums</span><br><span class="line">Out[68]: array([0,1, 2, 3, 4])</span><br><span class="line"> </span><br><span class="line">In [69]: data_list= np.meshgrid(xnums,ynums)</span><br><span class="line"> </span><br><span class="line">In [70]: data_list</span><br><span class="line">Out[70]:</span><br><span class="line">[array([[0, 1, 2,3],</span><br><span class="line">        [0, 1, 2, 3],</span><br><span class="line">        [0, 1, 2, 3],</span><br><span class="line">        [0, 1, 2, 3],</span><br><span class="line">        [0, 1, 2, 3]]), array([[0, 0, 0, 0],</span><br><span class="line">        [1, 1, 1, 1],</span><br><span class="line">        [2, 2, 2, 2],</span><br><span class="line">        [3, 3, 3, 3],</span><br><span class="line">        [4, 4, 4, 4]])]</span><br></pre></td></tr></table></figure>

<h3 id="np-where（）"><a href="#np-where（）" class="headerlink" title="np.where（）"></a>np.where（）</h3><p>np.where可以进行<code>x if condition else y</code>的快捷形式</p>
<p>比如我们在下面的例子中，将所有正数替换为2，负数替换为1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [7]: arr = np.random.randn(4,4)</span><br><span class="line"></span><br><span class="line">In [8]: arr</span><br><span class="line">Out[8]:</span><br><span class="line">array([[ 0.67616266, -0.05338506,  1.24429511, -0.01608611],</span><br><span class="line">       [ 1.19887484, -0.26227917, -1.06689128,  1.6256341 ],</span><br><span class="line">       [ 1.33528028, -0.56730727,  0.00761954,  0.15508178],</span><br><span class="line">       [-1.4552253 ,  0.12884633,  0.63242436, -0.62763473]])</span><br><span class="line"></span><br><span class="line">In [9]: np.where(arr&gt;0, 2, 1)</span><br><span class="line">Out[9]:</span><br><span class="line">array([[2, 1, 2, 1],</span><br><span class="line">       [2, 1, 1, 2],</span><br><span class="line">       [2, 1, 2, 2],</span><br><span class="line">       [1, 2, 2, 1]])</span><br></pre></td></tr></table></figure>

<h3 id="基本统计方法"><a href="#基本统计方法" class="headerlink" title="基本统计方法"></a>基本统计方法</h3><p>sum求和，mean均值，std标准差，var方差，min，max最小最大值</p>
<p><strong>argmin，argmax最小最大值的索引</strong></p>
<p><strong>cumsum：所有元素的累积和</strong>，和search_sorted方法配合可以算出分位数所在的位置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [10]: arr = np.random.randn(1000)</span><br><span class="line"></span><br><span class="line">In [11]: arr.sort()</span><br><span class="line"></span><br><span class="line">In [12]: arr.searchsorted(int(0.05*(max(arr)-min(arr))))</span><br><span class="line">Out[12]: 458</span><br></pre></td></tr></table></figure>

<p><strong>cumprod：所有元素的累积积</strong></p>
<h3 id="唯一化及逻辑运算"><a href="#唯一化及逻辑运算" class="headerlink" title="唯一化及逻辑运算"></a>唯一化及逻辑运算</h3><p><code>np.unique</code>效果与python中的set对于list的效果一样，只保留不相同的值</p>
<p><code>np.in1d</code>用于测试参数是否在数组中</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">In [13]: arr = np.arange(6)</span><br><span class="line"></span><br><span class="line">In [14]: arr</span><br><span class="line">Out[14]: array([0, 1, 2, 3, 4, 5])</span><br><span class="line"></span><br><span class="line">In [15]: np.in1d(arr,[0,3,4])</span><br><span class="line">Out[15]: array([ True, False, False,  True,  True, False], dtype=bool)</span><br></pre></td></tr></table></figure>

<h3 id="集合运算的函数"><a href="#集合运算的函数" class="headerlink" title="集合运算的函数"></a>集合运算的函数</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>unique</td>
<td>返回唯一元素的有序结果</td>
</tr>
<tr>
<td>intersect1d(x,y)</td>
<td>交集（计算xy的公共元素并返回有序结果）</td>
</tr>
<tr>
<td>union</td>
<td>并集</td>
</tr>
<tr>
<td>in1d（x,y）</td>
<td>y是否存在于x中的布尔数组</td>
</tr>
<tr>
<td>setdiff1d</td>
<td>差集</td>
</tr>
<tr>
<td>setxor1d</td>
<td>对称差，存在于一个数组中但不同时存在于两个书注重的元素</td>
</tr>
</tbody></table>
<h3 id="元素保存"><a href="#元素保存" class="headerlink" title="元素保存"></a>元素保存</h3><p><code>np.save(&#39;filename&#39;, arr)</code>:如果没有加后缀会自动加上.npy，然后可以使用np.load读取这个array</p>
<p><code>np.savez(&#39;filename&#39;, a=arr1, b=arr2)</code>:存储到压缩文件，后缀为.npz，读取时用load，然后通过字典key，value的索引方式分别取出a和b</p>
<p><code>np.loadtxt(&#39;array.txt&#39;,delimiter=&#39;,&#39;)</code>：读取txt文件，指定分隔符号为delimiter</p>
<p><code>np.savetxt(&#39;filename&#39;, arr)</code>：保存为txt文件</p>
<h3 id="线性代数运算"><a href="#线性代数运算" class="headerlink" title="线性代数运算"></a>线性代数运算</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>diag</td>
<td>返回方阵的对角线元素，或者把一维数组转化为方阵</td>
</tr>
<tr>
<td>dot</td>
<td>矩阵乘法</td>
</tr>
<tr>
<td>trace</td>
<td>对角线元素和</td>
</tr>
<tr>
<td>det</td>
<td>矩阵行列式</td>
</tr>
<tr>
<td>eig</td>
<td>计算方阵的特征值和特征向量</td>
</tr>
<tr>
<td>inv</td>
<td>求方阵的逆</td>
</tr>
<tr>
<td>pinv</td>
<td>伪逆</td>
</tr>
<tr>
<td></td>
<td>计算QR分解值</td>
</tr>
<tr>
<td>svd</td>
<td>奇异值分解</td>
</tr>
<tr>
<td></td>
<td>解线性方程Ax&#x3D;b，其中A是一个矩阵</td>
</tr>
<tr>
<td></td>
<td>计算Ax&#x3D;b的最小二乘解</td>
</tr>
</tbody></table>
<h3 id="随机数生成"><a href="#随机数生成" class="headerlink" title="随机数生成"></a>随机数生成</h3><table>
<thead>
<tr>
<th>函数</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>seed</td>
<td>确定随机数生成器的种子</td>
</tr>
<tr>
<td>permutation</td>
<td>返回一个序列的随机排列或者一个随机排列的范围</td>
</tr>
<tr>
<td><strong>shuffle</strong></td>
<td><strong>随机打乱一个序列</strong></td>
</tr>
<tr>
<td><strong>rand</strong></td>
<td>产生均匀随机分布的样本值</td>
</tr>
<tr>
<td><strong>randint</strong></td>
<td><strong>从给定的上下范围内随机选取整数</strong></td>
</tr>
<tr>
<td>randn</td>
<td>产生正态分布（平均值为0，标准差为1）的样本值</td>
</tr>
<tr>
<td></td>
<td>产生二项分布的样本值</td>
</tr>
<tr>
<td></td>
<td>产生正态分布的样本值</td>
</tr>
<tr>
<td></td>
<td>产生beta分布的样本值</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>数据分析</tag>
      </tags>
  </entry>
  <entry>
    <title>pip换源</title>
    <url>/2017/09/06/pip%E6%8D%A2%E6%BA%90/</url>
    <content><![CDATA[<p>在windows文件管理器中输入<code>%APPDATA%</code>，进入到一个文件夹，新建名为pip的文件夹，然后在其中新建pip.ini文件，输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">timeout = 6000</span><br><span class="line">index-url = https://pypi.douban.com/simple</span><br><span class="line">trusted-host = pypi.douban.com</span><br></pre></td></tr></table></figure>

<p>转换为豆瓣源</p>
<p>或者输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://mirrors.xjtu.edu.cn/pypi/web/simple/</span><br></pre></td></tr></table></figure>

<p>转换为西安交大源</p>
]]></content>
      <categories>
        <category>软件配置</category>
      </categories>
      <tags>
        <tag>pip</tag>
      </tags>
  </entry>
  <entry>
    <title>python数据分析过程--kaggle房价预测</title>
    <url>/2018/03/11/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B-kaggle%E6%88%BF%E4%BB%B7%E9%A2%84%E6%B5%8B/</url>
    <content><![CDATA[<p>具体来说可以分为五个部分:</p>
<ol>
<li>问题理解</li>
<li>单变量分析</li>
<li>多变量分析</li>
<li>基本的数据清理</li>
<li>假设测验</li>
</ol>
<span id="more"></span>

<p>首先导入过程中需要用到的python库</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> norm</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>)</span><br><span class="line">%matplotlib inline</span><br></pre></td></tr></table></figure>
<p>接下来读入数据:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df_train = pd.read_csv(<span class="string">&#x27;../input/train.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>看一下每列都是些什么值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df_train.columns</span><br></pre></td></tr></table></figure>
<p>得到如下的结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Index([<span class="string">&#x27;Id&#x27;</span>, <span class="string">&#x27;MSSubClass&#x27;</span>, <span class="string">&#x27;MSZoning&#x27;</span>, <span class="string">&#x27;LotFrontage&#x27;</span>, <span class="string">&#x27;LotArea&#x27;</span>, <span class="string">&#x27;Street&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;Alley&#x27;</span>, <span class="string">&#x27;LotShape&#x27;</span>, <span class="string">&#x27;LandContour&#x27;</span>, <span class="string">&#x27;Utilities&#x27;</span>, <span class="string">&#x27;LotConfig&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;LandSlope&#x27;</span>, <span class="string">&#x27;Neighborhood&#x27;</span>, <span class="string">&#x27;Condition1&#x27;</span>, <span class="string">&#x27;Condition2&#x27;</span>, <span class="string">&#x27;BldgType&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;HouseStyle&#x27;</span>, <span class="string">&#x27;OverallQual&#x27;</span>, <span class="string">&#x27;OverallCond&#x27;</span>, <span class="string">&#x27;YearBuilt&#x27;</span>, <span class="string">&#x27;YearRemodAdd&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;RoofStyle&#x27;</span>, <span class="string">&#x27;RoofMatl&#x27;</span>, <span class="string">&#x27;Exterior1st&#x27;</span>, <span class="string">&#x27;Exterior2nd&#x27;</span>, <span class="string">&#x27;MasVnrType&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;MasVnrArea&#x27;</span>, <span class="string">&#x27;ExterQual&#x27;</span>, <span class="string">&#x27;ExterCond&#x27;</span>, <span class="string">&#x27;Foundation&#x27;</span>, <span class="string">&#x27;BsmtQual&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;BsmtCond&#x27;</span>, <span class="string">&#x27;BsmtExposure&#x27;</span>, <span class="string">&#x27;BsmtFinType1&#x27;</span>, <span class="string">&#x27;BsmtFinSF1&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;BsmtFinType2&#x27;</span>, <span class="string">&#x27;BsmtFinSF2&#x27;</span>, <span class="string">&#x27;BsmtUnfSF&#x27;</span>, <span class="string">&#x27;TotalBsmtSF&#x27;</span>, <span class="string">&#x27;Heating&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;HeatingQC&#x27;</span>, <span class="string">&#x27;CentralAir&#x27;</span>, <span class="string">&#x27;Electrical&#x27;</span>, <span class="string">&#x27;1stFlrSF&#x27;</span>, <span class="string">&#x27;2ndFlrSF&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;LowQualFinSF&#x27;</span>, <span class="string">&#x27;GrLivArea&#x27;</span>, <span class="string">&#x27;BsmtFullBath&#x27;</span>, <span class="string">&#x27;BsmtHalfBath&#x27;</span>, <span class="string">&#x27;FullBath&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;HalfBath&#x27;</span>, <span class="string">&#x27;BedroomAbvGr&#x27;</span>, <span class="string">&#x27;KitchenAbvGr&#x27;</span>, <span class="string">&#x27;KitchenQual&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;TotRmsAbvGrd&#x27;</span>, <span class="string">&#x27;Functional&#x27;</span>, <span class="string">&#x27;Fireplaces&#x27;</span>, <span class="string">&#x27;FireplaceQu&#x27;</span>, <span class="string">&#x27;GarageType&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;GarageYrBlt&#x27;</span>, <span class="string">&#x27;GarageFinish&#x27;</span>, <span class="string">&#x27;GarageCars&#x27;</span>, <span class="string">&#x27;GarageArea&#x27;</span>, <span class="string">&#x27;GarageQual&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;GarageCond&#x27;</span>, <span class="string">&#x27;PavedDrive&#x27;</span>, <span class="string">&#x27;WoodDeckSF&#x27;</span>, <span class="string">&#x27;OpenPorchSF&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;EnclosedPorch&#x27;</span>, <span class="string">&#x27;3SsnPorch&#x27;</span>, <span class="string">&#x27;ScreenPorch&#x27;</span>, <span class="string">&#x27;PoolArea&#x27;</span>, <span class="string">&#x27;PoolQC&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;Fence&#x27;</span>, <span class="string">&#x27;MiscFeature&#x27;</span>, <span class="string">&#x27;MiscVal&#x27;</span>, <span class="string">&#x27;MoSold&#x27;</span>, <span class="string">&#x27;YrSold&#x27;</span>, <span class="string">&#x27;SaleType&#x27;</span>,</span><br><span class="line">       <span class="string">&#x27;SaleCondition&#x27;</span>, <span class="string">&#x27;SalePrice&#x27;</span>],</span><br><span class="line">      dtype=<span class="string">&#x27;object&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="接下来我们需要做些什么"><a href="#接下来我们需要做些什么" class="headerlink" title="接下来我们需要做些什么"></a>接下来我们需要做些什么</h2><p>为了理解数据，我推荐用excel做一个如下的表格，每一列数据变成一类，包含6部分内容：</p>
<ol>
<li>变量名；</li>
<li>变量类型：有两种可能的值在这个域中，“数值型”或者是“分类型”，数值型意味着数据都是数值，而“分类型”意味着变量值是类别；</li>
<li>变量分割：根据大类对变量分段。比如在房价问题中，可以大致分为3大类：“建筑本身”，“空间大小”，“位置”，当我们说建筑本身的时候，我们意味着建筑的物理特征；说空间大小的时候，指的是空间特征，比如有几个卫生间之类的；说位置的时候，指的是地理位置相关的特征，比如街区之类的；</li>
<li>期望：我们自认为的哪些因素对最终分析目标的影响，可以分为高中低三类。</li>
<li>结论：我们认为这个变量重要性的结论，可以跟期望一样分为几类</li>
<li>补充评论：任何我们能想到的一般性评论</li>
</ol>
<p>最后，我们结合自身实际，看看哪些因素是真的重要的，比如买房子的时候，房子外观重要吗？<br>再看看哪些因素可能重复了，地势等高线之后就不需要地势斜度了</p>
<p>在房价预测这个问题中，我们总结了四个最重要的影响因素：</p>
<ol>
<li>OverallQual ：整体质量，虽然不知道怎么算出来的，但是很有可能是通过其余所有变量综合计算得到的；</li>
<li>YearBuilt：建筑年份</li>
<li>TotalBsmtSF：总地下室面积</li>
<li>GrLivArea：总的非地下室面积</li>
</ol>
<p>在这个问题中，我们最终是以2个“建筑本身”变量（整体质量和建筑年份），和2个“空间大小”变量（地下室面积和非地下室面积）结束。</p>
<h2 id="先说最重要的：分析房价"><a href="#先说最重要的：分析房价" class="headerlink" title="先说最重要的：分析房价"></a>先说最重要的：分析房价</h2><p>房价是我们这个问题探索的目标，首先看看数据描述</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#获得数据的整体性描述</span></span><br><span class="line">df_train[<span class="string">&#x27;SalePrice&#x27;</span>].describe()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">count      <span class="number">1460.000000</span></span><br><span class="line">mean     <span class="number">180921.195890</span></span><br><span class="line">std       <span class="number">79442.502883</span></span><br><span class="line"><span class="built_in">min</span>       <span class="number">34900.000000</span></span><br><span class="line"><span class="number">25</span>%      <span class="number">129975.000000</span></span><br><span class="line"><span class="number">50</span>%      <span class="number">163000.000000</span></span><br><span class="line"><span class="number">75</span>%      <span class="number">214000.000000</span></span><br><span class="line"><span class="built_in">max</span>      <span class="number">755000.000000</span></span><br><span class="line">Name: SalePrice, dtype: float64</span><br></pre></td></tr></table></figure>
<p>非常好，至少最低的房价是大于0的</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#画个直方图来看看数据分布</span></span><br><span class="line">sns.distplot(df_train[<span class="string">&#x27;SalePrice&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/82259654.jpg"></p>
<p>看上去似乎是一个变形的正态分布图片，我们来计算机下他的偏度和峰度：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#skewness and kurtosis</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Skewness: %f&quot;</span> % df_train[<span class="string">&#x27;SalePrice&#x27;</span>].skew())</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Kurtosis: %f&quot;</span> % df_train[<span class="string">&#x27;SalePrice&#x27;</span>].kurt())</span><br></pre></td></tr></table></figure>

<p>得到结果如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Skewness: <span class="number">1.882876</span></span><br><span class="line">Kurtosis: <span class="number">6.536282</span></span><br></pre></td></tr></table></figure>



<p>其中峰度和偏度的解释如下：</p>
<ol>
<li>峰度（skewness）：峰度衡量数据分布的平坦度（flatness）。尾部大的数据分布，其峰度值较大。正态分布的峰度值为3<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/48112617.jpg"><br>如图，黑线的峰度值大于3，红线峰度值等于3</li>
<li>偏态（Skewness）：偏态量度对称性。0说明是最完美的对称性，正态分布的偏态就是0。如图所示，右偏态为正，表明平均值大于中位数。反之为左偏态，为负。</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/6978903.jpg"></p>
<h2 id="数值类型因素之间的关系"><a href="#数值类型因素之间的关系" class="headerlink" title="数值类型因素之间的关系"></a>数值类型因素之间的关系</h2><p>先来画一画grlivarea&#x2F;saleprice两者之间的散点图</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#scatter plot grlivarea/saleprice</span></span><br><span class="line">var = <span class="string">&#x27;GrLivArea&#x27;</span></span><br><span class="line">data = pd.concat([df_train[<span class="string">&#x27;SalePrice&#x27;</span>], df_train[var]], axis=<span class="number">1</span>)</span><br><span class="line">data.plot.scatter(x=var, y=<span class="string">&#x27;SalePrice&#x27;</span>, ylim=(<span class="number">0</span>,<span class="number">800000</span>));</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/83913021.jpg"></p>
<p>可以看到两者几乎呈现正相关，也就是非地下室面积和售价呈现正相关</p>
<p>我们再来画一下totalbsmtsf和售价的关系</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#scatter plot totalbsmtsf/saleprice</span><br><span class="line">var = &#x27;TotalBsmtSF&#x27;</span><br><span class="line">data = pd.concat([df_train[&#x27;SalePrice&#x27;], df_train[var]], axis=1)</span><br><span class="line">data.plot.scatter(x=var, y=&#x27;SalePrice&#x27;, ylim=(0,800000));</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/38930281.jpg"></p>
<p>可以看到两者同样几乎呈现正相关，关系似乎是指数关系</p>
<h2 id="分类类型变量的关系"><a href="#分类类型变量的关系" class="headerlink" title="分类类型变量的关系"></a>分类类型变量的关系</h2><p>画一个box图（箱形图），看看整体质量和售价之间的关系</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var = <span class="string">&#x27;OverallQual&#x27;</span></span><br><span class="line">data = pd.concat([train[<span class="string">&#x27;SalePrice&#x27;</span>], train[var]], axis=<span class="number">1</span>)</span><br><span class="line">sns.boxplot(x=var,y=<span class="string">&#x27;SalePrice&#x27;</span>,data=data)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/97679736.jpg"></p>
<ul>
<li>箱形图的解释：又称为<strong>盒须图</strong>、<strong>盒式图</strong>、<strong>盒状图</strong>或<strong>箱线图</strong>，是一种用作显示一组数据分散情况资料的<a href="https://zh.wikipedia.org/wiki/%E7%BB%9F%E8%AE%A1%E5%9B%BE">统计图</a>。因型状如箱子而得名。在各种领域也经常被使用，常见于品质管理。不过作法相对较繁琐。它能显示出一组数据的<a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E5%A4%A7%E5%80%BC">最大值</a>、<a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E5%B0%8F%E5%80%BC">最小值</a>、<a href="https://zh.wikipedia.org/wiki/%E4%B8%AD%E4%BD%8D%E6%95%B8">中位数</a>、及<a href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%88%86%E4%BD%8D%E6%95%B0">上下四分位数</a>。</li>
<li>上四分位数Q3-下四分位数Q1 &#x3D; 四分位间距$\Delta{Q}$</li>
<li>在区间$Q3+1.5\Delta{Q}$和区间$Q1-1.5\Delta{Q}$之外的值应该被忽视，被称为异常值，异常值被画在图上</li>
</ul>
<p>再看看建造年份和售价的关系</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var = <span class="string">&#x27;YearBuilt&#x27;</span></span><br><span class="line">data = pd.concat([train[<span class="string">&#x27;SalePrice&#x27;</span>], train[var]], axis=<span class="number">1</span>)</span><br><span class="line">fig = sns.boxplot(x=var,y=<span class="string">&#x27;SalePrice&#x27;</span>,data=data)</span><br><span class="line"><span class="comment"># 将x轴坐标旋转90度</span></span><br><span class="line">plt.xticks(rotation=<span class="number">90</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-11/60100096.jpg"></p>
<p>看上去似乎并没有什么强烈的关系</p>
<h2 id="关系总结"><a href="#关系总结" class="headerlink" title="关系总结"></a>关系总结</h2><ul>
<li>地上面积和总的地下面积看上去和房价线性相关，两者的关系都是正向的；并且在总地下面积的关系中可以看到，其与售价面积相关性的斜度非常大</li>
<li>总体质量和建筑年代似乎与售价也有一定关系，其中总体质量关系比较大，箱形图显示出房价随着整体质量的上升而上涨</li>
</ul>
<h2 id="试验性分析"><a href="#试验性分析" class="headerlink" title="试验性分析"></a>试验性分析</h2><p>为了更加理性的对房价数据进行分析，我们先用一下几个办法来进行分析：</p>
<ul>
<li>相关矩阵（热力图heatmap）</li>
<li>房价的相关矩阵（缩放热力图）</li>
<li>大多数相关变量之间的散点图</li>
</ul>
<h3 id="相关矩阵"><a href="#相关矩阵" class="headerlink" title="相关矩阵"></a>相关矩阵</h3><p>画个热力图看看相关系数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cormat = train.corr()</span><br><span class="line">f, ax = plt.subplots(figsize=(<span class="number">12</span>, <span class="number">9</span>))</span><br><span class="line">sns.heatmap(cormat,vmax=<span class="number">.8</span>,square=<span class="literal">True</span>)</span><br><span class="line">plt.xticks(rotation=<span class="number">90</span>)</span><br><span class="line">plt.yticks(rotation=<span class="number">360</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-12/40765273.jpg"></p>
<p>在我看来，热力图的确是一个最好的看一个大致影响程度的方法。</p>
<p>可以看到，总地下室面积和一楼面积很大程度上影响了房价，还有关于车库的好几个因素都很大程度上影响了房价。这让我们感觉到heatmap非常适合做特征选择。</p>
<h3 id="售价相关矩阵"><a href="#售价相关矩阵" class="headerlink" title="售价相关矩阵"></a>售价相关矩阵</h3><p>看完了上面的heatmap的最后一行，我们只是从颜色上看出了各个因素与售价的关系，接下来我们画一个缩放的heatmap来具体看看每个因素的影响有多大</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">cormat = train.corr()</span><br><span class="line">k = <span class="number">10</span></span><br><span class="line">cols = cormat.nlargest(<span class="number">10</span>, <span class="string">&#x27;SalePrice&#x27;</span>)[<span class="string">&#x27;SalePrice&#x27;</span>].index</span><br><span class="line">cm = train[cols].corr()<span class="comment">#np.corrcoef(train[cols].values.T)</span></span><br><span class="line"><span class="built_in">print</span>(train[cols].values)</span><br><span class="line">sns.<span class="built_in">set</span>(font_scale=<span class="number">1.25</span>)</span><br><span class="line">hm = sns.heatmap(cm, cbar=<span class="literal">True</span>, annot= <span class="literal">True</span>, fmt=<span class="string">&#x27;.2f&#x27;</span>, annot_kws=&#123;<span class="string">&#x27;size&#x27;</span>:<span class="number">10</span>&#125;, yticklabels=cols.values, xticklabels=cols.values)</span><br><span class="line">plt.xticks(rotation=<span class="number">90</span>)</span><br><span class="line">plt.yticks(rotation=<span class="number">360</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-12/35746800.jpg"></p>
<p>可以看到这些变量是影响房价最大的10个因素，从图中的数值可以看出来，OverallQual和GrLiveArea以及GarageCars和GarageArea是影响房价最大的几个因素。</p>
<ul>
<li>然而我们可以看到，GarageArea和GarageCars是有因果关系的，车库面积决定了可以停多少车，所以我们最终选择影响更大的GarageCars这个因素</li>
<li>总地下室面积（<strong>TotalBsmtSF</strong>）和一楼面积<strong>1stFlrSF</strong>似乎也有强烈相关性，我们选择地下室面积作为因素</li>
<li>地上房间数目（<strong>TotRmsAbvGrd</strong>）和地上居住面积（<strong>GrLivArea</strong>）也有相当大关系，所以选其中一个</li>
</ul>
<h3 id="售价和相关变量之间的散点图"><a href="#售价和相关变量之间的散点图" class="headerlink" title="售价和相关变量之间的散点图"></a>售价和相关变量之间的散点图</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#画出所有与售价相关的10个因素之间的关系图pairplot</span></span><br><span class="line">k = <span class="number">10</span></span><br><span class="line">cols = train.corr().nlargest(<span class="number">10</span>, <span class="string">&#x27;SalePrice&#x27;</span>).index.values</span><br><span class="line">sns.pairplot(train[cols],size=<span class="number">2.5</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-12/86254176.jpg"></p>
<p>大量的散点图给了我们一个变量之间关系的合理解释</p>
<h2 id="缺失数据的处理"><a href="#缺失数据的处理" class="headerlink" title="缺失数据的处理"></a>缺失数据的处理</h2><p>在处理缺失数据之前不妨问一下以下两个问题：</p>
<ul>
<li>缺失数据的比例有多大</li>
<li>缺失数据是随机的吗还是说缺失数据有一定的模式</li>
</ul>
<p>这两个问题非常重要，因为缺失数据可能就意味着训练数据的减少，对我们的分析不利。</p>
<p>先来找到缺失的数据：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#isnumll()函数将返回与原dataframe同样形状的dataframe，不过原来为空的地方标为1，原来不为空的地方标0</span></span><br><span class="line">total = train.isnull().<span class="built_in">sum</span>().sort_values(ascending=<span class="literal">False</span>)</span><br><span class="line">miss_percent = (train.isnull().<span class="built_in">sum</span>()/train.isnull().count()).sort_values(ascending=<span class="literal">False</span>)</span><br><span class="line">miss_data = pd.concat([total,miss_percent],axis=<span class="number">1</span>,keys=[<span class="string">&#x27;total&#x27;</span>,<span class="string">&#x27;percent&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(miss_data.head())  </span><br></pre></td></tr></table></figure>


<p>得到如下的结果</p>
<table>
<thead>
<tr>
<th></th>
<th>total</th>
<th>percent</th>
</tr>
</thead>
<tbody><tr>
<td>PoolQC</td>
<td>1453</td>
<td>0.995205</td>
</tr>
<tr>
<td>MiscFeature</td>
<td>1406</td>
<td>0.963014</td>
</tr>
<tr>
<td>Alley</td>
<td>1369</td>
<td>0.937671</td>
</tr>
<tr>
<td>Fence</td>
<td>1179</td>
<td>0.807534</td>
</tr>
<tr>
<td>FireplaceQu</td>
<td>690</td>
<td>0.472603</td>
</tr>
<tr>
<td>LotFrontage</td>
<td>259</td>
<td>0.177397</td>
</tr>
<tr>
<td>GarageCond</td>
<td>81</td>
<td>0.055479</td>
</tr>
<tr>
<td>GarageType</td>
<td>81</td>
<td>0.055479</td>
</tr>
<tr>
<td>GarageYrBlt</td>
<td>81</td>
<td>0.055479</td>
</tr>
<tr>
<td>GarageFinish</td>
<td>81</td>
<td>0.055479</td>
</tr>
<tr>
<td>GarageQual</td>
<td>81</td>
<td>0.055479</td>
</tr>
<tr>
<td>BsmtExposure</td>
<td>38</td>
<td>0.026027</td>
</tr>
<tr>
<td>BsmtFinType2</td>
<td>38</td>
<td>0.026027</td>
</tr>
<tr>
<td>BsmtFinType1</td>
<td>37</td>
<td>0.025342</td>
</tr>
<tr>
<td>BsmtCond</td>
<td>37</td>
<td>0.025342</td>
</tr>
<tr>
<td>BsmtQual</td>
<td>37</td>
<td>0.025342</td>
</tr>
<tr>
<td>MasVnrArea</td>
<td>8</td>
<td>0.005479</td>
</tr>
<tr>
<td>MasVnrType</td>
<td>8</td>
<td>0.005479</td>
</tr>
<tr>
<td>Electrical</td>
<td>1</td>
<td>0.000685</td>
</tr>
<tr>
<td>Utilities</td>
<td>0</td>
<td>0</td>
</tr>
</tbody></table>
<p>看一看到缺失最多的达到了99.5%，我们现在制定一个原则，当数据缺失超过15%的时候，我们就把这个变量删掉</p>
<p>同样，虽然Garage相关的数据只缺失5%，但是“GarageCars”已经可以表示车库相关的问题，我们把garage相关的信息删掉，同样BsmtX相关的变量也删掉</p>
<p>最后，我们的删除方案是，除了只有一个缺失值的Electrical列删除缺失值所在行，别的都删除所在列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train = train.drop((miss_data[miss_data[<span class="string">&#x27;total&#x27;</span>] &gt; <span class="number">1</span>]).index,<span class="number">1</span>)</span><br><span class="line">train = train.drop(train.loc[train[<span class="string">&#x27;Electrical&#x27;</span>].isnull()].index,<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(train.isnull().<span class="built_in">sum</span>().<span class="built_in">max</span>())</span><br></pre></td></tr></table></figure>

<h2 id="异常值处理"><a href="#异常值处理" class="headerlink" title="异常值处理"></a>异常值处理</h2><p>异常值会对模型产生很大的影响，因此需要格外注意</p>
<h3 id="单变量分析"><a href="#单变量分析" class="headerlink" title="单变量分析"></a>单变量分析</h3><p>这里最主要的问题就是建立一个阈值去筛选出异常值，因此我们需要对数据进行标准化。意味着将数据值变化到均值为0，标准差为1的数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 标准化数据</span></span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> StandardScaler</span><br><span class="line">saleprice_scaled = StandardScaler().fit_transform(train[<span class="string">&#x27;SalePrice&#x27;</span>].values)</span><br></pre></td></tr></table></figure>

<p>找到标准化之后数据的最大最小的10个值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">lowrange = np.sort(saleprice_scaled)[:<span class="number">10</span>]</span><br><span class="line">highrange = np.sort(saleprice_scaled)[-<span class="number">10</span>:]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;lowrange 10 values&#x27;</span>,lowrange)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;highrange 10 values&#x27;</span>,highrange)</span><br></pre></td></tr></table></figure>

<p>得到结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">[-<span class="number">1.83820775</span> -<span class="number">1.83303414</span> -<span class="number">1.80044422</span> -<span class="number">1.78282123</span> -<span class="number">1.77400974</span> -<span class="number">1.62295562</span></span><br><span class="line"> -<span class="number">1.6166617</span>  -<span class="number">1.58519209</span> -<span class="number">1.58519209</span> -<span class="number">1.57269236</span>]</span><br><span class="line">[ <span class="number">3.82758058</span>  <span class="number">4.0395221</span>   <span class="number">4.49473628</span>  <span class="number">4.70872962</span>  <span class="number">4.728631</span>    <span class="number">5.06034585</span></span><br><span class="line">  <span class="number">5.42191907</span>  <span class="number">5.58987866</span>  <span class="number">7.10041987</span>  <span class="number">7.22629831</span>]</span><br></pre></td></tr></table></figure>

<p>可以看到，最小值都比较相近且接近0，最大值相差比较大，且远离0，特别是有几个7点几的几乎可以肯定是异常值</p>
<h2 id="二元变量分析"><a href="#二元变量分析" class="headerlink" title="二元变量分析"></a>二元变量分析</h2><p>我们画出地面居住面积和房价的散点图</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 二元分析房价与地上居住面积</span></span><br><span class="line">var = <span class="string">&#x27;GrLivArea&#x27;</span></span><br><span class="line">data = pd.concat([df_train[<span class="string">&#x27;SalePrice&#x27;</span>], df_train[var]], axis=<span class="number">1</span>)</span><br><span class="line">data.plot.scatter(x=var, y=<span class="string">&#x27;SalePrice&#x27;</span>, ylim=(<span class="number">0</span>,<span class="number">800000</span>));</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/17899296.jpg"></p>
<ul>
<li>有两个面积很大但是价格很低的点，我们可以推断他们对我们的分析意义不大，可能是偏远农村的房子。我们认为这两个点是异常值并删除他们。</li>
<li>最高处的两个点，应该就是我们在标准化数据的时候得到的7点几的两个点，然而他们两个点好像符合这个线性关系，我们暂时决定保留他们。</li>
</ul>
<p>我们先删除两个异常值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除异常值</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;删除之前的矩阵：&#x27;</span>,train.shape)</span><br><span class="line">train = train.drop(train[(train[<span class="string">&#x27;SalePrice&#x27;</span>]&lt;<span class="number">300000</span>) &amp; (train[<span class="string">&#x27;GrLivArea&#x27;</span>]&gt;<span class="number">4000</span>)].index)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;删除之后的矩阵：&#x27;</span>,train.shape)</span><br></pre></td></tr></table></figure>

<p>得到：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">删除之前的矩阵：(1459, 63)</span><br><span class="line">删除之后的矩阵：(1457, 63)</span><br></pre></td></tr></table></figure>

<p>接下来进行售价和总地下室面积的二元分析</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var = <span class="string">&#x27;TotalBsmtSF&#x27;</span></span><br><span class="line">data = pd.concat([train[<span class="string">&#x27;SalePrice&#x27;</span>],train[var]],<span class="number">1</span>)</span><br><span class="line">data.plot.scatter(x=var,y=<span class="string">&#x27;SalePrice&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/319136.jpg"></p>
<p>我们可能很想要删除那几个居住面积大于3000的值，但是在这里我们先保留他们</p>
<h2 id="得到模型"><a href="#得到模型" class="headerlink" title="得到模型"></a>得到模型</h2><p>我们已经完成了数据清理，现在需要对售价的模型提出假设：</p>
<p>根据论文Hair et al. (2013)中提到，我们需要对数据进行四类假设：</p>
<ul>
<li>正态性：说到正态性就是说数据长得比较像正态分布，这非常重要，因为好几种统计测试方法都依赖于这个（比如t-statistics)。在这个问题中我们只是检查售价这个单变量的正态性，记住：单变量的正态性并不意味着多变量的正态性，还有，在样本超过200的时候，正态性并不是个问题。如果我们解决了正态性，那么就避免了很多别的问题，比如heteroscedacity（异方差），这个就是我们为什么要做这个分析的原因，</li>
<li>同方差性：所有自变量的方差相同</li>
<li>线性：最好的检查现行的方法就是画散点图，看看上面有没有直线。</li>
<li>相关误差的缺乏：相关误差是在一个误差发生的时候，与其相关联的值也会发生误差。</li>
</ul>
<h3 id="寻找正态性"><a href="#寻找正态性" class="headerlink" title="寻找正态性"></a>寻找正态性</h3><p>我们之前已经看了房屋售价的histgram的图，找到了峰度和偏态。</p>
<p>那么我们再画一个正态概率图，用来找到我们的histgram和正态分布的区别</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sns.distplot(train.loc[:,<span class="string">&#x27;SalePrice&#x27;</span>], fit=norm)</span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[<span class="string">&#x27;SalePrice&#x27;</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>得到下面两张图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/40543531.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/27227032.jpg"></p>
<p>显然，售价并不是正态分布，他有一个尖峰，并且正的偏度。然而我们可以通过一个简单的变换把这些数据变成正态的，在统计学中可以知道，当数据分布是有正的偏度的时候，log变换非常有效。</p>
<p>进行log变换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train[<span class="string">&#x27;SalePrice&#x27;</span>] = np.log(train[<span class="string">&#x27;SalePrice&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>变换之后的数据</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/85975518.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/6789786.jpg"></p>
<p>同样，我们对GrLivArea进行一个log变换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train[<span class="string">&#x27;GrLivArea&#x27;</span>] = np.log(train[<span class="string">&#x27;GrLivArea&#x27;</span>])</span><br><span class="line"><span class="comment">#正态概率图</span></span><br><span class="line">sns.distplot(train.loc[:,<span class="string">&#x27;GrLivArea&#x27;</span>], fit=norm)</span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[<span class="string">&#x27;GrLivArea&#x27;</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>得到变换之后的图形如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/68294229.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/30007186.jpg"></p>
<p>我们再来看看TotalBsmtSF本来的数据长什么样子：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sns.distplot(train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>], fit=norm)</span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/52896292.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/19573516.jpg"></p>
<ul>
<li>我们可以看到好多值都是0，这样我们就不能用log变换了</li>
<li>我们在做log变换之前需要把所有为0的值变为1，这样变换之后，值还是0</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;等于0平的地下室&#x27;</span>,train[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>] == <span class="number">0</span>][<span class="string">&#x27;TotalBsmtSF&#x27;</span>].shape)</span><br><span class="line"><span class="built_in">print</span>(train.loc[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>,<span class="string">&#x27;TotalBsmtSF&#x27;</span>].shape)</span><br><span class="line">train.loc[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>,<span class="string">&#x27;TotalBsmtSF&#x27;</span>] = np.log(train.loc[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>,<span class="string">&#x27;TotalBsmtSF&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>].head())</span><br><span class="line"><span class="comment">#正态概率图</span></span><br><span class="line">sns.distplot(train[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>][<span class="string">&#x27;TotalBsmtSF&#x27;</span>], fit=norm)</span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>][<span class="string">&#x27;TotalBsmtSF&#x27;</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>我们只画出为正的那部分的地下室的变化之后的分布，也服从正态分布</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/60859543.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/50279551.jpg"></p>
<h3 id="验证同方差性"><a href="#验证同方差性" class="headerlink" title="验证同方差性"></a>验证同方差性</h3><p>最好的验证同方差性的办法就是图形。</p>
<p>先看看‘SalePrice’ and ‘GrLivArea’的分布</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.scatter(df_train[<span class="string">&#x27;GrLivArea&#x27;</span>], df_train[<span class="string">&#x27;SalePrice&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/76915160.jpg"></p>
<p>对比log变化之前的图形，可以看到这个图没有之前那种锥形的样子了，这就是正态性的效果，确保了正态性往往就确保了同方差性</p>
<p>再看看’SalePrice’ with ‘TotalBsmtSF’.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.scatter(train[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>][<span class="string">&#x27;TotalBsmtSF&#x27;</span>], train[train[<span class="string">&#x27;TotalBsmtSF&#x27;</span>]&gt;<span class="number">0</span>][<span class="string">&#x27;SalePrice&#x27;</span>]);</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/11730894.jpg"></p>
<h2 id="哑变量"><a href="#哑变量" class="headerlink" title="哑变量"></a>哑变量</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df_train = pd.get_dummies(df_train)</span><br></pre></td></tr></table></figure>

<p>一句话就可以推出哑变量</p>
]]></content>
      <categories>
        <category>python</category>
        <category>编程练习</category>
        <category>数据分析</category>
      </categories>
      <tags>
        <tag>kaggle</tag>
        <tag>数据分析</tag>
      </tags>
  </entry>
  <entry>
    <title>python基础教程（十五）：Python和Web</title>
    <url>/2017/04/20/python%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B%EF%BC%88%E5%8D%81%E4%BA%94%EF%BC%89%EF%BC%9Apython%E5%92%8Cweb/</url>
    <content><![CDATA[<h2 id="屏幕抓取"><a href="#屏幕抓取" class="headerlink" title="屏幕抓取"></a>屏幕抓取</h2><p>想要抓取网页信息，可以用urllib和正则表达式做到：</p>
<span id="more"></span>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">p = re.<span class="built_in">compile</span>(<span class="string">&#x27;&lt;h3&gt;&lt;a .*?&gt;&lt;a .*? href=&quot;(.*?)&quot;&gt;(.*?)&lt;/a&gt;&#x27;</span>)</span><br><span class="line">text = urlopen(<span class="string">&#x27;http://python.org/community/jobs&#x27;</span>).read()</span><br><span class="line"><span class="keyword">for</span> url, name <span class="keyword">in</span> p.findall(text):</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;%s (%s)&#x27;</span>%(name, url)</span><br></pre></td></tr></table></figure>

<p>正则表达式的模式相对固定，下面我们介绍Tidy和XHTML解析</p>
<h3 id="Tidy和XHTML解析"><a href="#Tidy和XHTML解析" class="headerlink" title="Tidy和XHTML解析"></a>Tidy和XHTML解析</h3><p>XHTML是HTML最新的方言，是XML的一种形式。</p>
<h3 id="tidy-是什么"><a href="#tidy-是什么" class="headerlink" title="tidy 是什么"></a>tidy 是什么</h3><p>tidy是用来修复不规范且有些随意的HTML文档的工具。</p>
<h3 id="XHTML和HTML区别"><a href="#XHTML和HTML区别" class="headerlink" title="XHTML和HTML区别"></a>XHTML和HTML区别</h3><p>xhtml对显示关闭更加严格</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>pyplot入门</title>
    <url>/2017/11/28/pyplot%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<h2 id="plt画图"><a href="#plt画图" class="headerlink" title="plt画图"></a>plt画图</h2><p>总体思想，先使用<code>fig = plt.figure(),ax=fig.add_subplot()</code>创建图片，画好图之后，用ax.set_xxx来设置各项参数</p>
<span id="more"></span>

<h3 id="设置子图之间的间距"><a href="#设置子图之间的间距" class="headerlink" title="设置子图之间的间距"></a>设置子图之间的间距</h3><p>plt.subplots_adjust(wspace, hspace)：参数分别代表水平间距和竖直间距</p>
<h3 id="设置x轴坐标及范围"><a href="#设置x轴坐标及范围" class="headerlink" title="设置x轴坐标及范围"></a>设置x轴坐标及范围</h3><p>set_xticks：刻度值的显示值</p>
<p>set_xticklabels：将任意标签转换为x轴标签</p>
<p>set_xlim：只显示某一部分的时候使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ax.set_xticks(range(0,1001,250))</span><br><span class="line">ax.set_xticklabels([&#x27;one&#x27;,&#x27;two&#x27;,&#x27;three&#x27;,&#x27;four&#x27;,&#x27;five&#x27;],rotation=30,fontsize=&#x27;small&#x27;)</span><br></pre></td></tr></table></figure>

<p>同样y轴同理</p>
<h3 id="设置title-label"><a href="#设置title-label" class="headerlink" title="设置title,label"></a>设置title,label</h3><p>set_title：设置图片title</p>
<p>set_xlabel：设置x轴的名称</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(1,1,1)</span><br><span class="line">ax.plot(randn(1000).cumsum(),&#x27;k-&#x27;)</span><br><span class="line">ax.set_xticks(range(0,1001,250))</span><br><span class="line">ax.set_xticklabels([&#x27;one&#x27;,&#x27;two&#x27;,&#x27;three&#x27;,&#x27;four&#x27;,&#x27;five&#x27;],rotation=30,fontsize=&#x27;small&#x27;)</span><br><span class="line">ax.set_xlabel(&#x27;stage&#x27;)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<h3 id="添加图例"><a href="#添加图例" class="headerlink" title="添加图例"></a>添加图例</h3><p>在画图的时候传入label，在添加图例的时候用legend就好了</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ax.plot(randn(1000).cumsum(),&#x27;k-&#x27;,label=&#x27;one&#x27;)</span><br><span class="line">ax.plot(randn(1000).cumsum(),&#x27;g--&#x27;,label=&#x27;two&#x27;)</span><br><span class="line">ax.plot(randn(1000).cumsum(),&#x27;r-&#x27;,label=&#x27;three&#x27;)</span><br><span class="line">ax.legend(loc=&#x27;best&#x27;)</span><br></pre></td></tr></table></figure>

<h3 id="添加注释"><a href="#添加注释" class="headerlink" title="添加注释"></a>添加注释</h3><p>注释可以通过text，arrow，annotate等函数添加</p>
<h3 id="保存图片到文件"><a href="#保存图片到文件" class="headerlink" title="保存图片到文件"></a>保存图片到文件</h3><p><code>plt.savefig(&#39;a.svg&#39;)</code></p>
<h2 id="pandas当中的plot"><a href="#pandas当中的plot" class="headerlink" title="pandas当中的plot"></a>pandas当中的plot</h2><h3 id="Series-plot绘图参数"><a href="#Series-plot绘图参数" class="headerlink" title="Series.plot绘图参数"></a>Series.plot绘图参数</h3><p>label：用于图例的标签</p>
<p>ax：绘制的画布</p>
<p>style：风格，包括颜色和线型</p>
<p>alpha：不透明度，0-1</p>
<p>kind：’line’,’bar’,’barh’,’kde’</p>
<p>logy：对y轴做对数</p>
<p>use_index：将对象的索引用作刻度标签</p>
<p>rot：旋转刻度标签（0-360）</p>
<p>xticks：用作x轴刻度的值</p>
<p>yticks：用作y刻度的值</p>
<p>xlim，ylim：x，y轴界限</p>
<p>grid：显示网格线</p>
<h3 id="DataFrame-plot参数"><a href="#DataFrame-plot参数" class="headerlink" title="DataFrame.plot参数"></a>DataFrame.plot参数</h3><p>subplots：将各个dataframe列绘制到单独的subplot中</p>
<p>sharex，sharey：如果subplots为true，共用一个x轴，或y轴</p>
<p>figsize：图像大小</p>
<p>title：名称</p>
<p>legend：添加图例，默认为true</p>
<p>sort_columns：以字母表顺序绘制各列</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>plt</tag>
      </tags>
  </entry>
  <entry>
    <title>python爬虫从入门到精通</title>
    <url>/2017/05/22/python%E7%88%AC%E8%99%AB%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/</url>
    <content><![CDATA[<h1 id="第一讲"><a href="#第一讲" class="headerlink" title="第一讲"></a>第一讲</h1><h2 id="什么是爬虫"><a href="#什么是爬虫" class="headerlink" title="什么是爬虫"></a>什么是爬虫</h2><span id="more"></span>

<blockquote>
<p>网络蜘蛛（Web spider）也叫网络爬虫（Web crawler），蚂蚁（ant），自动检索工具（automatic indexer），或者（在FOAF软件概念中）网络疾走（WEB scutter），是一种“自动化浏览网络”的程序，或者说是一种网络机器人。它们被广泛用于互联网搜索引擎或其他类似网站，以获取或更新这些网站的内容和检索方式。它们可以自动采集所有其能够访问到的页面内容，以供搜索引擎做进一步处理（分检整理下载的页面），而使得用户能更快的检索到他们需要的信息。</p>
</blockquote>
<p><strong>总结：自动抓取数据</strong> </p>
<h2 id="爬虫能做什么"><a href="#爬虫能做什么" class="headerlink" title="爬虫能做什么"></a>爬虫能做什么</h2><ul>
<li>搜索引擎</li>
<li>抢票</li>
<li>下载资料（图片等）</li>
</ul>
<h2 id="爬虫的本质是什么"><a href="#爬虫的本质是什么" class="headerlink" title="爬虫的本质是什么"></a>爬虫的本质是什么</h2><p><strong>模仿浏览器打开网页</strong></p>
<h1 id="第二讲-HTTP协议"><a href="#第二讲-HTTP协议" class="headerlink" title="第二讲:HTTP协议"></a>第二讲:HTTP协议</h1><h2 id="什么是HTTP协议"><a href="#什么是HTTP协议" class="headerlink" title="什么是HTTP协议"></a>什么是HTTP协议</h2><blockquote>
<p>超文本传输协议（英文：HyperText Transfer Protocol，缩写：HTTP）是互联网上应用最为广泛的一种网络协议。设计HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。通过HTTP或者HTTPS协议请求的资源由统一资源标识符（Uniform Resource Identifiers，URI）来标识。 HTTP的发展是由蒂姆·伯纳斯-李于1989年在欧洲核子研究组织（CERN）所发起。由万维网协会（World Wide Web Consortium，W3C）和互联网工程任务组（Internet Engineering Task Force，IETF）制定标准，最终发布了一系列的RFC，其中最著名的是1999年6月公布的 RFC 2616，定义了HTTP协议中现今广泛使用的一个版本——HTTP 1.1。 2014年12月，互联网工程任务组（IETF）的Hypertext Transfer Protocol Bis（httpbis）工作小组将HTTP&#x2F;2标准提议递交至IESG进行讨论[1]，于2015年2月17日被批准。[2] HTTP&#x2F;2标准于2015年5月以RFC 7540正式发表，替换HTTP 1.1成为HTTP的实现标准。[3]</p>
<p>HTTP是一个客户端终端（用户）和服务器端（网站）请求和应答的标准（TCP）。通过使用网页浏览器、网络爬虫或者其它的工具，客户端发起一个HTTP请求到服务器上指定端口（默认端口为80）。我们称这个客户端为用户代理程序（user agent）。应答的服务器上存储着一些资源，比如HTML文件和图像。我们称这个应答服务器为源服务器（origin server）。在用户代理和源服务器中间可能存在多个“中间层”，比如代理服务器、网关或者隧道（tunnel）。 尽管TCP&#x2F;IP协议是互联网上最流行的应用，HTTP协议中，并没有规定必须使用它或它支持的层。事实上，HTTP可以在任何互联网协议上，或其他网络上实现。HTTP假定其下层协议提供可靠的传输。因此，任何能够提供这种保证的协议都可以被其使用。因此也就是其在TCP&#x2F;IP协议族使用TCP作为其传输层。 通常，由HTTP客户端发起一个请求，创建一个到服务器指定端口（默认是80端口）的TCP连接。HTTP服务器则在那个端口监听客户端的请求。一旦收到请求，服务器会向客户端返回一个状态，比如”HTTP&#x2F;1.1 200 OK”，以及返回的内容，如请求的文件、错误消息、或者其它信息。</p>
</blockquote>
<h2 id="具体例子"><a href="#具体例子" class="headerlink" title="具体例子"></a>具体例子</h2><p>打开<a href="https://zhuanlan.zhihu.com/p/25296437">知乎页面</a>，按浏览器的F12键，点击network，点击doc，然后刷新页面，再点击headers，可以看到如下界面：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-5-22/61930610-file_1495457286738_5f3e.png"></p>
<p>其中：</p>
<ol>
<li>HTTP协议中的<strong>统一资源定位符</strong>也就是我们打开的网址</li>
</ol>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">Request URL:https://zhuanlan.zhihu.com/p/25296437 （爬虫会用到）</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>HTTP协议中的<strong>请求方法</strong>,我们这次用的是GET</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Request Method:GET				#（爬虫会用到）</span><br></pre></td></tr></table></figure>

<p>请求方法有以下这些，常用的是<strong>GET</strong>,<strong>POST</strong></p>
<ul>
<li>GET：向指定的资源发出“显示”请求。使用GET方法应该只用在读取数据，而不应当被用于产生“副作用”的操作中，例如在Web Application中。其中一个原因是GET可能会被网络蜘蛛等随意访问。参见安全方法</li>
<li>POST：向指定资源提交数据，请求服务器进行处理（例如提交表单或者上传文件）。数据被包含在请求本文中。这个请求可能会创建新的资源或修改现有资源，或二者皆有。</li>
<li>OPTIONS：这个方法可使服务器传回该资源所支持的所有HTTP请求方法。用’*’来代替资源名称，向Web服务器发送OPTIONS请求，可以测试服务器功能是否正常运作。</li>
<li>HEAD：与GET方法一样，都是向服务器发出指定资源的请求。只不过服务器将不传回资源的本文部分。它的好处在于，使用这个方法可以在不必传输全部内容的情况下，就可以获取其中“关于该资源的信息”（元信息或称元数据）。</li>
<li>PUT：向指定资源位置上传其最新内容。</li>
<li>DELETE：请求服务器删除Request-URI所标识的资源。</li>
<li>TRACE：回显服务器收到的请求，主要用于测试或诊断。</li>
<li>CONNECT：HTTP&#x2F;1.1协议中预留给能够将连接改为管道方式的代理服务器。通常用于SSL加密服务器的链接（经由非加密的HTTP代理服务器）。</li>
</ul>
<ol start="3">
<li>对应HTTP协议中的<strong>状态码</strong>,我们这次返回的是200 OK、</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Status Code:200 OK（爬虫会用到）</span><br></pre></td></tr></table></figure>

<p>状态码的含义：</p>
<ul>
<li>1xx消息——请求已被服务器接收，继续处理</li>
<li>2xx成功——请求已成功被服务器接收、理解、并接受</li>
<li>3xx重定向——需要后续操作才能完成这一请求</li>
<li>4xx请求错误——请求含有词法错误或者无法被执行</li>
<li>5xx服务器错误——服务器在处理某个正确请求时发生错误</li>
</ul>
<blockquote>
<p>常见状态代码、状态描述、说明：</p>
</blockquote>
<ul>
<li>200 OK &#x2F;&#x2F;请求成功</li>
<li>400 Bad Request &#x2F;&#x2F;客户端请求有语法错误，不能被服务器所理解</li>
<li>401 Unauthorized &#x2F;&#x2F;请求未经授权，这个状态代码必须和WWW-Authenticate报头域一起使用</li>
<li>403 Forbidden &#x2F;&#x2F;服务器收到请求，但是拒绝提供服务</li>
<li>404 Not Found &#x2F;&#x2F;请求资源不存在，eg：输入了错误的URL</li>
<li>500 Internal Server Error &#x2F;&#x2F;服务器发生不可预期的错误</li>
<li>503 Server Unavailable &#x2F;&#x2F;服务器当前不能处理客户端的请求，一段时间后可能恢复正常</li>
</ul>
<ol start="4">
<li>请求头</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Accept:text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8（爬虫会用到）</span><br></pre></td></tr></table></figure>

<p>其中</p>
<ul>
<li><p><code>Accept</code>代表客户端请求接受的信息类型，这里请求的是<code>text/html类型</code></p>
</li>
<li><p><code>Accept-Encoding：gzip, deflate, sdch, br</code>：请求报头域类似于<code>Accept</code>，但是它是用于指定可接受的内容编码。<code>eg：Accept-Encoding:gzip.deflate</code>.如果请求消息中没有设置这个域服务器假定客户端对各种内容编码都可以接受。</p>
</li>
<li><p><code>Accept-Language:zh-CN,zh;q=0.8</code>：指定语言类型，如果没有报头域，那么各种语言都可以接受</p>
</li>
<li><p><code>Cache-Control:no-cache</code>：用于控制网页缓存</p>
</li>
<li><p><code>Connection:keep-alive</code>：HTTP持久连接，使用同一个TCP来发送和接收多个HTTP请求&#x2F;应答</p>
</li>
<li><p>**<code>Cookie:d_c0=&quot;AACAWNtZswqPTnJ8dFXqaygiq82ekPD5_-xxxx</code>**：cookie，小型文本文件，某些网站为了辨别用户身份而存储在本地终端上的数据</p>
</li>
<li><p><code>Host:zhuanlan.zhihu.com</code>：当前请求网页的请求域</p>
</li>
<li><p><strong><code>Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36</code></strong></p>
<p> 用户是通过什么工具来请求的，（因为我用的Google浏览器，所以显示的是Chrome）</p>
</li>
<li><p><strong><code>Referer:https://www.zhihu.com/people/pa-chong-21/activities</code></strong></p>
<p>是通过哪个页面到当前页面的</p>
</li>
<li><pre><code>If-Modified-Since:Wed, 15 Feb 2017 09:14:13 GMT
If-None-Match:W/&quot;58a41be5-190aa&quot;
Last-Modified:Wed, 15 Feb 2017 09:14:13 GMT
ETag:&quot;58a41be5-190aa&quot;
</code></pre>
<p>这4个一般静态页面会用到 If-Modified-Since,If-None-Match这两个是请求头，ETag,Last-Modified是返回头（服务器返回的）</p>
<p>如果If-Modified-Since的值和Last-Modified相等 则表明当前请求的内容没有变动，服务器返回<code>Status Code:304 Not Modified</code></p>
</li>
<li><p>​</p>
</li>
</ul>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>python进行数据挖掘中的常见问题及经验</title>
    <url>/2017/10/09/python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E4%B8%AD%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E5%8F%8A%E7%BB%8F%E9%AA%8C/</url>
    <content><![CDATA[<h2 id="在数据分析程序中需要引入的包及设置"><a href="#在数据分析程序中需要引入的包及设置" class="headerlink" title="在数据分析程序中需要引入的包及设置"></a>在数据分析程序中需要引入的包及设置</h2><p>用python进行数据分析的时候，需要在文件开头导入一下包</p>
<span id="more"></span>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np <span class="comment"># linear algebra 引入线性代数包numpy</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd <span class="comment"># data processing, CSV file I/O (e.g. pd.read_csv)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#%matplotlib inline</span></span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt  <span class="comment"># Matlab-style plotting 画图工具包</span></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns <span class="comment"># 画图美化工具包</span></span><br><span class="line">color = sns.color_palette()</span><br><span class="line">sns.set_style(<span class="string">&#x27;darkgrid&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ignore_warn</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">warnings.warn = ignore_warn <span class="comment">#ignore annoying warning (from sklearn and seaborn)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> norm, skew <span class="comment">#for some statistics</span></span><br><span class="line"></span><br><span class="line">pd.set_option(<span class="string">&#x27;display.float_format&#x27;</span>, <span class="keyword">lambda</span> x: <span class="string">&#x27;&#123;:.3f&#125;&#x27;</span>.<span class="built_in">format</span>(x)) <span class="comment">#Limiting floats output to 3 decimal points 设置在pd中只显示3位小数</span></span><br></pre></td></tr></table></figure>

<h2 id="画数据分布图"><a href="#画数据分布图" class="headerlink" title="画数据分布图"></a>画数据分布图</h2><p>使用<code>seaborn</code>包进行画图，其中数据分布图为<code>distplot</code>，fit参数表示需要拟合的分布类型，<code>norm</code>表示拟合正态分布，正态分布的参数可以由<code>norm.fit</code>来获得</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sns.distplot(data_train[&#x27;SalePrice&#x27;],fit=norm)</span><br><span class="line">(mu, sigma) = norm.fit(data_train[&#x27;SalePrice&#x27;])</span><br><span class="line">plt.legend([&#x27;norm distribution with $\mu$=&#123;:.2f&#125;,$\sigma$=&#123;:.2f&#125;&#x27;.format(mu,sigma)])</span><br></pre></td></tr></table></figure>

<h2 id="将分类描述变量转换为数值类型"><a href="#将分类描述变量转换为数值类型" class="headerlink" title="将分类描述变量转换为数值类型"></a>将分类描述变量转换为数值类型</h2><p>有两种方式可以进行转换：</p>
<ol>
<li><p><code>pd.get_dummies(train)</code>：直接传入一个DataFrame，就可以得到改变之后的结果</p>
</li>
<li><pre><code class="python">from sklean.preprocessing import LabelEncoder
for label in train.index:
    encoder = LabelEncoder()
    train[label] = labencoder.fit_transform(train[encoder])
</code></pre>
</li>
</ol>
<h2 id="矩阵相乘"><a href="#矩阵相乘" class="headerlink" title="矩阵相乘"></a>矩阵相乘</h2><p>对应元素相乘:<code>np.multiply(A,B)</code>或者是直接用<code>*</code></p>
<p>矩阵乘法:<code>np.dot(A,B)</code></p>
<h2 id="参数axis"><a href="#参数axis" class="headerlink" title="参数axis"></a>参数axis</h2><ul>
<li>当<code>axis=0</code>时表示按照行来求值，比如在max函数中，原始数据是一个$40000\times785$的矩阵，那么<code>data.max(axis=0)</code>得到一个$1\times785$的<strong>行向量</strong>结果，按行就是在行的维度上求最大值</li>
<li>当<code>axis=1</code>时，同理可以得到结果是$785\times1$的<strong>列向量</strong>数据，按列求值就是在列的维度上进行求值</li>
</ul>
]]></content>
      <categories>
        <category>编程学习</category>
        <category>数据挖掘</category>
      </categories>
      <tags>
        <tag>数据挖掘</tag>
        <tag>pandas</tag>
      </tags>
  </entry>
  <entry>
    <title>python练习册 from github</title>
    <url>/2017/05/09/python%E7%BB%83%E4%B9%A0%E5%86%8C-from-github/</url>
    <content><![CDATA[<h1 id="第-0001-题："><a href="#第-0001-题：" class="headerlink" title="第 0001 题："></a><strong>第 0001 题：</strong></h1><span id="more"></span>

<p><strong>做为 Apple Store App 独立开发者，你要搞限时促销，为你的应用生成激活码</strong>（或者优惠券），使用 Python 如何生成 200 个激活码（或者优惠券）？</p>
<h2 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a><strong>解决思路</strong></h2><ol>
<li><p>首先，我们想到要编写一个200大小的循环，放置一个new_active的激活码生成函数 </p>
</li>
<li><p>new_active函数：既然要随机，那么我们就要有random模块，import random模块进来，主要使用的是random.choice 函数，从大写字母，小写字母以及数字当中选择</p>
</li>
<li><p>大写字母:<code>string.upper</code>，小写字母：<code>string.lower</code>，数字<code>range(0,10)</code>，但是前两个是<code>string</code>类型的<code>list</code>，<code>range</code>是<font color = "red" ><code>int</code></font>类型，在后面<font color='red'><code>&quot;&quot;.join(list)</code></font>的时候就无法拼接，所以我们用了<code>[str(i) for i in range(0,10) ]</code>，这样就保证了在最后可以把生成的字符串拼接起来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"><span class="comment"># from random import *</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">new_activation</span>(<span class="params">n</span>):</span><br><span class="line">    choice_list = <span class="built_in">list</span>(string.lowercase) + <span class="built_in">list</span>(string.uppercase) + [<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="number">10</span>)]</span><br><span class="line">    string_temp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(n):</span><br><span class="line">        temp_string = random.choice(choice_list)</span><br><span class="line">        string_temp.append(temp_string)</span><br><span class="line">    string_temp = <span class="string">&quot;&quot;</span>.join(string_temp)</span><br><span class="line">    <span class="keyword">return</span> string_temp</span><br><span class="line"></span><br><span class="line">activa_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    activa_list.append(new_activation(<span class="number">110</span>))</span><br><span class="line"></span><br><span class="line">pprint.pprint(activa_list)</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="第-0002-题："><a href="#第-0002-题：" class="headerlink" title="第 0002 题："></a><strong>第 0002 题</strong>：</h1><p>将 0001 题生成的 200 个激活码（或者优惠券）保存到 <strong>MySQL</strong> 关系型数据库中。 </p>
<h2 id="解决思路-1"><a href="#解决思路-1" class="headerlink" title="解决思路"></a><strong>解决思路</strong></h2><ol>
<li>MySql教程详见<a href="http://drawon.site/2017/05/11/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/">mysql教程</a></li>
<li>安装数据库，仅需要安装SQL sever即可</li>
<li>使用SQlite3包，连接只需要<code>conn = sqlite3.connect(&#39;xx.db&#39;)</code>，然后建立cursor，<code>cursor = conn.cursor</code>,之后就可以建立数据表，然后存储数据了</li>
<li>建表的sql命令，</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sql = <span class="string">&#x27;&#x27;&#x27;CREATE TABLE `activate`(\</span></span><br><span class="line"><span class="string">         `ID` integer PRIMARY KEY NOT NULL,\               # integer表示自增</span></span><br><span class="line"><span class="string">         `ACTIVATE_CODE` char(20) NOT NULL )&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="5">
<li>存储的命令</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sql1 = <span class="string">&quot;INSERT INTO ACTIVATE (ACTIVATE_CODE) VALUES (&#x27;%s&#x27;)&quot;</span>%activate_list[i]</span><br></pre></td></tr></table></figure>

<p>其中<code>activate_list[i]</code>表示每次需要存储的激活码的值</p>
<p><strong>详细代码</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/11 18:27</span></span><br><span class="line"><span class="keyword">from</span> activate <span class="keyword">import</span> new_activation</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sqlite3</span><br><span class="line">activate_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    activate_list.append(new_activation(<span class="number">20</span>))</span><br><span class="line"><span class="keyword">if</span> os.path.exists(<span class="string">&#x27;./active.db&#x27;</span>):</span><br><span class="line">    os.remove(<span class="string">&#x27;./active.db&#x27;</span>)</span><br><span class="line">conn = sqlite3.connect(<span class="string">&#x27;./active.db&#x27;</span>)</span><br><span class="line">cursor = conn.cursor()</span><br><span class="line">sql = <span class="string">&#x27;&#x27;&#x27;CREATE TABLE `activate`(\</span></span><br><span class="line"><span class="string">         `ID` integer PRIMARY KEY NOT NULL,\</span></span><br><span class="line"><span class="string">         `ACTIVATE_CODE` char(20) NOT NULL )&#x27;&#x27;&#x27;</span></span><br><span class="line">cursor.execute(sql)</span><br><span class="line">conn.commit()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        sql1 = <span class="string">&quot;INSERT INTO ACTIVATE (ACTIVATE_CODE) VALUES (&#x27;%s&#x27;)&quot;</span>%activate_list[i]</span><br><span class="line">        <span class="built_in">print</span> sql1</span><br><span class="line">        cursor.execute(sql1)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="keyword">raise</span> e</span><br><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    sql2 = <span class="string">&#x27;select * from activate&#x27;</span></span><br><span class="line">    cursor.execute(sql2)</span><br><span class="line">    <span class="built_in">print</span> cursor.fetchall()</span><br><span class="line">    conn.commit()</span><br><span class="line">    cursor.close()</span><br><span class="line">    conn.close()</span><br></pre></td></tr></table></figure>

<h1 id="第-0003-题："><a href="#第-0003-题：" class="headerlink" title="第 0003 题："></a><strong>第 0003 题</strong>：</h1><p><strong>第 0003 题：</strong>将 0001 题生成的 200 个激活码（或者优惠券）保存到 <strong>Redis</strong> 非关系型数据库中。 </p>
<h2 id="解决思路-2"><a href="#解决思路-2" class="headerlink" title="解决思路"></a><strong>解决思路</strong></h2><ol>
<li><p>ridis非关系型数据库就是一个简化的关系型数据库，没有建表这些复杂的操作</p>
</li>
<li><p>连接数据库的函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>利用<code>r.set(&#39;列名&#39;,数据值)</code>存储数据，用<code>r.get(&#39;列名&#39;)</code>获取数据值</p>
</li>
</ol>
<p>**完整代码 **</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/11 18:27</span></span><br><span class="line"><span class="keyword">from</span> activate <span class="keyword">import</span> new_activation</span><br><span class="line"><span class="keyword">import</span> redis</span><br><span class="line">activate_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    activate_list.append(new_activation(<span class="number">20</span>))</span><br><span class="line">r = redis.Redis(host=<span class="string">&#x27;localhost&#x27;</span>,port=<span class="number">6379</span>,db=<span class="number">0</span>)</span><br><span class="line">r.<span class="built_in">set</span>(<span class="string">&#x27;activate&#x27;</span>,activate_list)</span><br><span class="line"><span class="built_in">print</span> r.get(<span class="string">&#x27;activate&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="第0004题"><a href="#第0004题" class="headerlink" title="第0004题"></a>第0004题</h1><p>任一个英文的纯文本文件，统计其中的单词出现的个数。</p>
<h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>首先要分离出每一个单词，主要用到<code>re</code>模块和<code>string.punctuation</code>，这样就可以从文本中用<code>punctuation</code>分离开来</li>
<li>其次要统计单词个数，就要去重，最简单的去重方式就是利用<code>set</code></li>
</ol>
<p><strong>具体代码</strong></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/11 22:21</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> punctuation</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(raw_input(<span class="string">&#x27;filename:&#x27;</span>)) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read()</span><br><span class="line">    punctuation = punctuation+<span class="string">&#x27; &#x27;</span></span><br><span class="line">    pat = <span class="string">&#x27;[%s]+&#x27;</span> % punctuation</span><br><span class="line">    word = re.split(pat,text)</span><br><span class="line">    <span class="built_in">print</span> word</span><br><span class="line">    <span class="built_in">print</span> <span class="built_in">len</span>(<span class="built_in">set</span>(word))</span><br></pre></td></tr></table></figure>

<h1 id="第0005题"><a href="#第0005题" class="headerlink" title="第0005题"></a>第0005题</h1><p>你有一个目录，装了很多照片，把它们的尺寸变成都不大于 iPhone5 分辨率的大小。</p>
<h2 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>引用<code>PIL</code>(python image library)的<code>Image</code>包，其中的<code>resize</code>方法，可以调整图片大小</li>
<li><code>os.walk</code>方法返回一个元组迭代器，然后用<code>for root, dirs, files in list_dir:</code>可以得到根目录，目录名和文件名</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize</span>(<span class="params">filename,new_name</span>):</span><br><span class="line">    pic = Image.<span class="built_in">open</span>(filename)</span><br><span class="line">    out = pic.resize((<span class="number">100</span>,<span class="number">200</span>),Image.ANTIALIAS)</span><br><span class="line">    out.save(new_name,quality=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">list_dir = os.walk(<span class="string">r&#x27;C:\Users\jeffrey\Desktop\python exercise\python练习册\5\pic&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> list_dir:</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">        a = os.path.join(root, f)</span><br><span class="line">        <span class="built_in">print</span> a</span><br><span class="line">        new_name = os.path.join(root,<span class="string">&#x27;new_1&#x27;</span>+f)</span><br><span class="line">        <span class="built_in">print</span> new_name</span><br><span class="line">        resize(a,new_name)</span><br></pre></td></tr></table></figure>

<h1 id="第-0006-题："><a href="#第-0006-题：" class="headerlink" title="第 0006 题："></a><strong>第 0006 题：</strong></h1><p>你有一个目录，放了你一个月的日记，都是 txt，为了避免分词的问题，假设内容都是英文，请统计出你认为每篇日记最重要的词。</p>
<h2 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>引用第0004题的方法，可以分离单词，然后遍历单词，就可以得到每个单词的出现次数</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/12 20:24</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> punctuation</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;a.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read()</span><br><span class="line">    punctuation = punctuation+<span class="string">&#x27; &#x27;</span></span><br><span class="line">    pat = <span class="string">&#x27;[%s]+&#x27;</span> % punctuation</span><br><span class="line">    word = re.split(pat,text)</span><br><span class="line">    w = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> w1 <span class="keyword">in</span> word:</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> w2 <span class="keyword">in</span> word:</span><br><span class="line">            <span class="keyword">if</span> w1 == w2:</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">        w[w1]=count</span><br><span class="line">    <span class="built_in">print</span> w</span><br><span class="line">    cou = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> key,value <span class="keyword">in</span> w.iteritems():</span><br><span class="line">        <span class="keyword">if</span> value &gt; cou:</span><br><span class="line">            cou = value</span><br><span class="line">            key_temp = key</span><br><span class="line"><span class="built_in">print</span> key_temp</span><br></pre></td></tr></table></figure>

<h1 id="第-0007-题："><a href="#第-0007-题：" class="headerlink" title="第 0007 题："></a>第 0007 题：</h1><p>有个目录，里面是你自己写过的程序，统计一下你写过多少行代码。包括空行和注释，但是要分别列出来。</p>
<h2 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h2><p>1.有目录的问题，一定会用到<code>os.walk</code>函数,使用方法如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">list_dir = os.walk(raw_input(<span class="string">&quot;dictionary name:&quot;</span>))</span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> list_dir:</span><br><span class="line">	<span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(os.path.join(root,f))</span><br></pre></td></tr></table></figure>

<p><strong><font color='red'>注意</font>，这里只需要<code>join(root，f)</code>就可以得到所有文件的地址</strong></p>
<p>具体代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: gbk -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/14 18:31</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    list_dir = os.walk(raw_input(<span class="string">&quot;dictionary name:&quot;</span>))</span><br><span class="line">    pat = <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">    code_num = <span class="number">0</span></span><br><span class="line">    annotation_num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> list_dir:</span><br><span class="line">        <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">            file_name = os.path.join(root,f)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_name) <span class="keyword">as</span> ff:</span><br><span class="line">                text = ff.read()</span><br><span class="line">                sentence = text.split(pat)</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> sentence:</span><br><span class="line">                    <span class="keyword">if</span> line.strip().startswith(<span class="string">&#x27;#&#x27;</span>) <span class="keyword">or</span> line.strip() == <span class="string">&#x27;&#x27;</span>:</span><br><span class="line">                        annotation_num = annotation_num + <span class="number">1</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        code_num += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span> annotation_num</span><br><span class="line">    <span class="built_in">print</span> code_num</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="第0008题："><a href="#第0008题：" class="headerlink" title="第0008题："></a>第0008题：</h1><p>一个HTML文件，找出里面的<strong>正文</strong>。</p>
<h2 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>先要获取网页内容，<code>urlib2.open(&#39;www.baidu.com&#39;).read()</code></li>
<li>要想解析网页，想到网页解析器，在网上查到可以利用<code>readability</code>模块的<code>Document</code> ，找出正文的话就用<code>get_content</code>函数就可以了</li>
</ol>
<h3 id="源码："><a href="#源码：" class="headerlink" title="源码："></a>源码：</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> readability <span class="keyword">import</span> Document</span><br><span class="line">html = urllib2.urlopen(<span class="string">&#x27;https://github.com/drawwon/show-me-the-code&#x27;</span>)<span class="comment">#(raw_input(&#x27;please input the file name:&#x27;))</span></span><br><span class="line">text = html.read()</span><br><span class="line">doc = Document(text)</span><br><span class="line"><span class="built_in">print</span> doc.content()</span><br></pre></td></tr></table></figure>

<h1 id="第0009题："><a href="#第0009题：" class="headerlink" title="第0009题："></a>第0009题：</h1><p>一个HTML文件，找出里面的<strong>链接</strong>。</p>
<h2 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>获取网页内容，<code>urlib2.open(&#39;www.baidu.com&#39;).read()</code></li>
<li>找出连接，只要用<code>re</code>模块匹配<code>(http://.+)</code>，<code>re.findall(pat,text)</code>就找到了</li>
</ol>
<h3 id="源码：-1"><a href="#源码：-1" class="headerlink" title="源码："></a>源码：</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">from</span> readability <span class="keyword">import</span> Document</span><br><span class="line">html = urllib2.urlopen(<span class="string">&#x27;https://github.com/drawwon/show-me-the-code&#x27;</span>)<span class="comment">#(raw_input(&#x27;please input the file name:&#x27;))</span></span><br><span class="line">text = html.read()</span><br><span class="line">pat = re.<span class="built_in">compile</span>(<span class="string">&#x27;&quot;(http.+?)&quot;&#x27;</span>)</span><br><span class="line">links = re.findall(pat, text)</span><br><span class="line"><span class="built_in">print</span> links</span><br></pre></td></tr></table></figure>

<h1 id="第0010题"><a href="#第0010题" class="headerlink" title="第0010题"></a>第0010题</h1><p>使用 Python 生成类似于下图中的<strong>字母验证码图片</strong></p>
<p><img src="http://i.imgur.com/aVhbegV.jpg" alt="字母验证码"></p>
<h2 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>要处理图片，肯定用到<code>PIL</code>(Python Image Library)</p>
</li>
<li><p>首先用<code>pil.Image.new(&#39;RGB&#39;,(width,height),0xffff)</code>新建一张空白图片</p>
</li>
<li><p>从字母(<code>string.letters</code>)和数字<code>&#39;&#39;.join([str(i) for i in range(10)])</code>里面随机选值，用到<code>random.choice</code></p>
</li>
<li><p>要画图就要用到<code>ImageDraw.Draw(pic)</code></p>
</li>
<li><p>然后从三个随机的颜色中选一个来填满图片，<code>draw.point(xy,fill=random.choice(color1))</code></p>
</li>
<li><p>然后字母随机取颜色并画上，<code>draw.text(xy,text,fill,font=font))</code>，其中字体是<code>ImageFont.truetype(&quot;arial.ttf&quot;,80)</code></p>
</li>
<li><p>要得到模糊图片，用<code>PIL</code>当中的<code>filter</code>函数进行高斯滤波，参数为<code>ImageFilter.BLUR</code></p>
<p>​</p>
<p>效果</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-5-19/17092919-file_1495191243805_2e7f.jpg"></p>
</li>
</ol>
<h3 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> division</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> ImageDraw</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image,ImageFont,ImageFilter</span><br><span class="line">l = []</span><br><span class="line">num = <span class="number">4</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(num):</span><br><span class="line">    l.append(random.choice(string.letters+<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)])))</span><br><span class="line">pic = Image.new(<span class="string">&#x27;RGB&#x27;</span>,(<span class="number">500</span>,<span class="number">200</span>),<span class="number">0xffff</span>)</span><br><span class="line">draw = ImageDraw.Draw(pic)</span><br><span class="line">color2 = [<span class="string">&#x27;purple&#x27;</span>,<span class="string">&#x27;green&#x27;</span>,<span class="string">&#x27;brown&#x27;</span>]</span><br><span class="line">color1 = [<span class="string">&#x27;BurlyWood&#x27;</span>,<span class="string">&#x27;DarkGray&#x27;</span>,<span class="string">&#x27;DarkOliveGreen&#x27;</span>]</span><br><span class="line">width, height = pic.size</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(width+<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(height+<span class="number">1</span>):</span><br><span class="line">        draw.point(xy=(i,j),fill=random.choice(color1))</span><br><span class="line">font = ImageFont.truetype(<span class="string">&quot;arial.ttf&quot;</span>, <span class="number">100</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(l)):</span><br><span class="line">    x = i*width/num+<span class="number">5</span></span><br><span class="line">    c = random.choice(color2)</span><br><span class="line">    draw.text(xy=(x,<span class="number">50</span>),text=l[i],fill=c,font=font)</span><br><span class="line"></span><br><span class="line">pic = pic.<span class="built_in">filter</span>(ImageFilter.BLUR)</span><br><span class="line">pic.show()</span><br><span class="line">pic.save(<span class="string">&#x27;a.jpg&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="第-0011-题"><a href="#第-0011-题" class="headerlink" title="第 0011 题"></a><strong>第 0011 题</strong></h1><p>敏感词文本文件 filtered_words.txt，里面的内容为以下内容，当用户输入敏感词语时，则打印出 Freedom，否则打印出 Human Rights。<code>北京 程序员 公务员 领导 牛比 牛逼 你娘 你妈 love sex jiangge</code></p>
<h2 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><code>while 1</code>的循环，如果在列表里打印freedom，否则打印Human rights</li>
</ol>
<h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">b_list = [<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;程序员&#x27;</span>,<span class="string">&#x27;公务员&#x27;</span>,<span class="string">&#x27;领导&#x27;</span>,<span class="string">&#x27;牛比&#x27;</span>,<span class="string">&#x27;牛逼&#x27;</span>,<span class="string">&#x27;你娘&#x27;</span>,<span class="string">&#x27;你妈&#x27;</span>,<span class="string">&#x27;love&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>,<span class="string">&#x27;jiangge&#x27;</span>]</span><br><span class="line"><span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">    a = raw_input(<span class="string">&#x27;请输入词汇:&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> a <span class="keyword">in</span> b_list:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;freedom&#x27;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;human 中国&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="第-0012-题"><a href="#第-0012-题" class="headerlink" title="第 0012 题"></a><strong>第 0012 题</strong></h1><p>敏感词文本文件 filtered_words.txt，里面的内容 和 0011题一样，当用户输入敏感词语，则用 星号 * 替换，例如当用户输入「北京是个好城市」，则变成「**是个好城市」。</p>
<h2 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>一个txt文件读入之后是ascii的编码，是不能用于正则表达式的，从其他编码到unicode需要<code>decode</code>，而从unicode到utf-8之类的编码需要encode，因为系统认为unicode是通用编码，其他编码都是通过通用编码再编码得到的</p>
</li>
<li><p>打开文件的时候，可以用<code>codecs.open</code>指定编码格式</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">with</span> codecs.<span class="built_in">open</span>(filename,<span class="string">&#x27;r&#x27;</span>,<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read</span><br></pre></td></tr></table></figure>
</li>
<li><p>正则表达式匹配的时候，最好都变成unicode编码来匹配</p>
</li>
<li><p>要匹配多个关键词的时候，可以用for 一个一个的匹配</p>
</li>
</ol>
<h3 id="源代码-1"><a href="#源代码-1" class="headerlink" title="源代码"></a>源代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/19 18:59</span></span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> chardet</span><br><span class="line">b_list = [<span class="string">&#x27;北京&#x27;</span>,<span class="string">&#x27;程序员&#x27;</span>,<span class="string">&#x27;公务员&#x27;</span>,<span class="string">&#x27;领导&#x27;</span>,<span class="string">&#x27;牛比&#x27;</span>,<span class="string">&#x27;牛逼&#x27;</span>,<span class="string">&#x27;你娘&#x27;</span>,<span class="string">&#x27;你妈&#x27;</span>,<span class="string">&#x27;love&#x27;</span>,<span class="string">&#x27;sex&#x27;</span>,<span class="string">&#x27;jiangge&#x27;</span>]</span><br><span class="line"><span class="comment"># with codecs.open(&#x27;a.txt&#x27;,&#x27;r&#x27;,&#x27;utf-8&#x27;) as f:</span></span><br><span class="line"><span class="comment">#     text =  f.read()</span></span><br><span class="line"><span class="comment">#     print text</span></span><br><span class="line">text = <span class="built_in">open</span>(<span class="string">&#x27;a.txt&#x27;</span>).read().decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">pat_f = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> b_list:</span><br><span class="line">    pat_f = pat_f + <span class="string">&#x27;[&#x27;</span> + i + <span class="string">&#x27;]&#x27;</span> + <span class="string">&#x27;+&#x27;</span></span><br><span class="line"><span class="comment"># pat_f = pat_f.encode(&#x27;utf-8&#x27;, &#x27;unicode&#x27;)</span></span><br><span class="line"><span class="comment"># b = re.findall(u&#x27;(北京)+&#x27;, text)</span></span><br><span class="line">pat_f = pat_f.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">type</span>(pat_f)</span><br><span class="line"><span class="built_in">print</span> <span class="built_in">type</span>(text)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> b_list:</span><br><span class="line">    pat = <span class="built_in">str</span>(<span class="string">&#x27;(&#x27;</span>+ i +<span class="string">&#x27;)&#x27;</span> + <span class="string">&#x27;+&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    text = re.sub(<span class="string">u&#x27;%s&#x27;</span>%pat, <span class="string">u&#x27;*&#x27;</span>*(<span class="built_in">len</span>(pat)-<span class="number">3</span>), unicode(text))</span><br><span class="line"><span class="comment"># a = re.sub(pat_f, &#x27;*&#x27;, text)</span></span><br><span class="line"><span class="comment"># print a</span></span><br><span class="line"><span class="built_in">print</span> text</span><br><span class="line"><span class="comment"># print &#x27;&#x27;.join(b).encode(&#x27;utf-8&#x27;,&#x27;gbk&#x27;)</span></span><br></pre></td></tr></table></figure>

<h1 id="第0013题"><a href="#第0013题" class="headerlink" title="第0013题"></a>第0013题</h1><p>用 Python 写一个爬图片的程序，爬 <a href="http://tieba.baidu.com/p/2166231880">这个链接里的日本妹子图片 :-)</a></p>
<h2 id="解题思路-9"><a href="#解题思路-9" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>用<code>urllib2.urlopen(&#39;***.com&#39;).read()</code>打开网页获得网页内容</li>
<li><code>(r&#39;src=&quot;(http[s]?://.+?\.jp[e]?g)&quot;&#39;)</code> 正则表达式，提取图片</li>
<li>用<code>urllib.urlretrieve</code>下载图片文件，其中的链接需要去重复，用<code>set</code>就可以去重了</li>
</ol>
<h3 id="源代码-2"><a href="#源代码-2" class="headerlink" title="源代码"></a>源代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/20 14:11</span></span><br><span class="line"><span class="keyword">import</span> re,os</span><br><span class="line"><span class="keyword">import</span> urllib2,urllib,socket</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"></span><br><span class="line">text = urllib2.urlopen(<span class="string">&#x27;https://www.zhihu.com/question/23535321&#x27;</span>).read()</span><br><span class="line">pat = re.<span class="built_in">compile</span>(<span class="string">r&#x27;src=&quot;(http[s]?://.+?\.(jp[e]?g|png))&quot;&#x27;</span>)</span><br><span class="line"><span class="comment"># pat2 = re.compile(r&#x27;src=&quot;(.+?\.png)&quot;&#x27;)</span></span><br><span class="line">links = re.findall(pat, text)</span><br><span class="line">socket.setdefaulttimeout(<span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span> links</span><br><span class="line">links = <span class="built_in">set</span>(links)</span><br><span class="line"><span class="comment"># links2 = re.findall(pat2, text)</span></span><br><span class="line"><span class="comment"># print len(links2)</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(<span class="string">r&#x27;.\pic&#x27;</span>):</span><br><span class="line">    os.makedirs(<span class="string">r&#x27;.\pic&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i,p <span class="keyword">in</span> <span class="built_in">enumerate</span>(links):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># print p[0]</span></span><br><span class="line">        urllib.urlretrieve(p[<span class="number">0</span>],<span class="string">r&#x27;.\pic\%s.jpg&#x27;</span>%i)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;%s.jpg is downloading&#x27;</span>%i</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;%s.jpg download fail&#x27;</span> % i</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h1 id="第0014题"><a href="#第0014题" class="headerlink" title="第0014题"></a>第0014题</h1><p>纯文本文件 student.txt为学生信息, 里面的内容（包括花括号）如下所示：</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;1&quot;:[&quot;张三&quot;,150,120,100],</span><br><span class="line">	&quot;2&quot;:[&quot;李四&quot;,90,99,95],</span><br><span class="line">	&quot;3&quot;:[&quot;王五&quot;,60,66,68]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>请将上述内容写到 student.xls 文件中，如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-5-25/96708619.jpg"></p>
<h2 id="解题思路-10"><a href="#解题思路-10" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>txt文件是json格式，那我们那就引入<code>json</code>包，用<code>json.loads()</code>函数将txt转换为一个列表</li>
<li>要把列表写到excel中，要用到<code>xlwt</code>包，先用<code>excel = wlwt.workbook()</code>新建一个工作簿，然后用<code>sheet = excel.add_sheet()</code>加入一个sheet，然后用<code>sheet.write(row,col, text)</code>写入内容，最后<code>excel.save(filename)</code>保存xls</li>
<li>要遍历一个字典的key和value，用到<code>for k,v in dict.items()</code></li>
<li>字典排序<code>sorted(dict.items, key = lambda: x:x[0])</code>，其中x是指前面要排序内容中的每一个元素</li>
</ol>
<h3 id="源代码-3"><a href="#源代码-3" class="headerlink" title="源代码"></a>源代码</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/25 15:42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> csv,json,xlwt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_json</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">return</span> json.loads(<span class="built_in">open</span>(filename).read().encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_to_csv</span>(<span class="params">data,filename</span>):</span><br><span class="line"></span><br><span class="line">    dw = xlwt.Workbook()</span><br><span class="line">    ws = dw.add_sheet(<span class="string">&quot;student&quot;</span>,cell_overwrite_ok=<span class="literal">True</span>)</span><br><span class="line">    row = <span class="number">0</span></span><br><span class="line">    col = <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(data.items())</span><br><span class="line">    <span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">sorted</span>(data.items(), key=<span class="keyword">lambda</span> d:d[<span class="number">0</span>]):</span><br><span class="line">        ws.write(row, col, k)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> v:</span><br><span class="line">            col = col+<span class="number">1</span></span><br><span class="line">            ws.write(row,col,i)</span><br><span class="line">        row+=<span class="number">1</span></span><br><span class="line">        col=<span class="number">0</span></span><br><span class="line">    dw.save(filename)</span><br><span class="line"></span><br><span class="line">write_to_csv(read_json(<span class="string">&#x27;a.txt&#x27;</span>),<span class="string">&#x27;student.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="第0015题"><a href="#第0015题" class="headerlink" title="第0015题"></a>第0015题</h1><p>纯文本文件 city.txt为城市信息, 里面的内容（包括花括号）如下所示：</p>
<blockquote>
<p>   {<br>   “1” : “上海”,<br>   “2” : “北京”,<br>   “3” : “成都”<br>   }<br>   请将上述内容写到 city.xls 文件中，如下图所示：</p>
</blockquote>
<p><img src="http://i.imgur.com/rOHbUzg.png" alt="city.xls"></p>
<h2 id="解题思路-11"><a href="#解题思路-11" class="headerlink" title="解题思路"></a>解题思路</h2><p>主要方法同上题相似：</p>
<ol>
<li>使用<code>json</code>包的<code>json.loads()</code>读入数据</li>
<li>使用<code>xlwt</code>，打开workbook，通过<code>xlwt.add_sheet()</code>添加新的子表格，通过<code>for k,v in sorted(data,key= lambda d:d[0])</code>得到经过排序后的key和value值，并通过<code>xlrd</code>的<code>write</code>方法写入表格<br>ps.如果想输出在字典或者是list当中的中文，可以使用<code>json.dumps(list, ensure_ascii=False)</code>进行输出</li>
</ol>
<h2 id="源代码-4"><a href="#源代码-4" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/25 20:42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xlwt,json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">excel_write</span>(<span class="params">txtfile, csvfile</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(txtfile) <span class="keyword">as</span> f:</span><br><span class="line">        data = json.loads(f.read().encode(<span class="string">&#x27;gbk&#x27;</span>))</span><br><span class="line">    cs = xlwt.Workbook()</span><br><span class="line">    shet = cs.add_sheet(<span class="string">&#x27;student&#x27;</span>)</span><br><span class="line">    row = <span class="number">0</span></span><br><span class="line">    col = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i,j <span class="keyword">in</span> data.items():</span><br><span class="line">        shet.write(row,col,i)</span><br><span class="line">        shet.write(row,col+<span class="number">1</span>,j)</span><br><span class="line">        row += <span class="number">1</span></span><br><span class="line">        col = <span class="number">0</span></span><br><span class="line">    cs.save(csvfile)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    excel_write(<span class="string">&#x27;a.txt&#x27;</span>,<span class="string">&#x27;student.xls&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="第0016题"><a href="#第0016题" class="headerlink" title="第0016题"></a>第0016题</h1><p> 纯文本文件 numbers.txt, 里面的内容（包括方括号）如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">	[1, 82, 65535], </span><br><span class="line">	[20, 90, 13],</span><br><span class="line">	[26, 809, 1024]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>请将上述内容写到 numbers.xls 文件中，如下图所示：</p>
<p><img src="http://i.imgur.com/iuz0Pbv.png" alt="numbers.xls"></p>
<h2 id="解题思路-12"><a href="#解题思路-12" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>与上题类似，先使用<code>json</code>包的<code>load</code>方法导入数据</li>
<li>使用<code>xlwt</code>包对数据写入xls文件中，在建立表格的时候，需要设置表格覆盖：<code>wb.add_sheet(&#39;num&#39;,cell_overwrite_ok=True)</code></li>
</ol>
<h2 id="源代码-5"><a href="#源代码-5" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/5/25 21:28</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xlwt,json</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read_txt_to_xlsfile</span>(<span class="params">txtfile,xlsfile</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(txtfile) <span class="keyword">as</span> f:</span><br><span class="line">        data = json.loads(f.read().encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    wb = xlwt.Workbook()</span><br><span class="line">    sheet = wb.add_sheet(<span class="string">&#x27;num&#x27;</span>,cell_overwrite_ok=<span class="literal">True</span>)</span><br><span class="line">    row = col = <span class="number">0</span></span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> i:</span><br><span class="line">            sheet.write(row,col,j)</span><br><span class="line">            col = col+<span class="number">1</span></span><br><span class="line">        row = row+<span class="number">1</span></span><br><span class="line">        col = <span class="number">0</span></span><br><span class="line">    wb.save(xlsfile)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    read_txt_to_xlsfile(<span class="string">&#x27;number.txt&#x27;</span>,<span class="string">&#x27;number.xls&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h1 id="第0017题"><a href="#第0017题" class="headerlink" title="第0017题"></a>第0017题</h1><p>将 第 0014 题中的 student.xls 文件中的内容写到 student.xml 文件中，如下所示：</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;students&gt;</span><br><span class="line">&lt;!-- </span><br><span class="line">	学生信息表</span><br><span class="line">	<span class="string">&quot;id&quot;</span> : [名字, 数学, 语文, 英文]</span><br><span class="line">--&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;1&quot;</span> : [<span class="string">&quot;张三&quot;</span>, <span class="number">150</span>, <span class="number">120</span>, <span class="number">100</span>],</span><br><span class="line">	<span class="string">&quot;2&quot;</span> : [<span class="string">&quot;李四&quot;</span>, <span class="number">90</span>, <span class="number">99</span>, <span class="number">95</span>],</span><br><span class="line">	<span class="string">&quot;3&quot;</span> : [<span class="string">&quot;王五&quot;</span>, <span class="number">60</span>, <span class="number">66</span>, <span class="number">68</span>]</span><br><span class="line">&#125;</span><br><span class="line">&lt;/students&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="解题思路-13"><a href="#解题思路-13" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>要将xls文件写入到xml文件中，首先要将数据读取出来，使用<code>xlrd</code>模块的<code>xlrd.open_workbook</code>方法打开xls文件，然后<code>ws = wb.sheet_by_index[0]</code>找到工作表，然后通过有序字典存储学生信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">table = OrderDict()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ws.nrows) :</span><br><span class="line">	key = ws.row_values(i)[<span class="number">0</span>]</span><br><span class="line">	value = ws.row_values(i)[<span class="number">1</span>:]</span><br><span class="line">	table[key] = value</span><br></pre></td></tr></table></figure>
</li>
<li><p>打开<code>xml</code>文件，用<code>with open(&#39;students.xml&#39;,&#39;w&#39;) as f：</code>打开</p>
</li>
<li><p>要写xml文件要用到<code>etree</code>模块，</p>
<ul>
<li>首先建立根节点<code>root=etree.Element(&quot;root&quot;)</code>，</li>
<li>然后以root为根节点建立树<code>e_root = ElementTree(root)</code>，建立子节点students<code>e_students = etree.subElement(root,&#39;students&#39;)</code>，</li>
<li>写students子节点的内容<code>e_students.text = &#39;\n&#39;+json.dumps(table, indent=4 , ensure_ascii=False)</code>，</li>
<li>然后添加注释comment<code>e_students.append(etree.Comment(&#39;\n    学生信息表\n    &quot;id&quot; : [名字，数学，语文，英语]\n&#39;))</code>，</li>
<li>最后写入etree的unicode元素，<code>f.write((&#39;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#39;+etree.tounicode(e_root.getroot())))</code></li>
</ul>
</li>
</ol>
<h2 id="源代码-6"><a href="#源代码-6" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/6/27 14:59</span></span><br><span class="line"><span class="keyword">import</span> xlrd,json</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xls2xml</span>(<span class="params">xls_filename</span>):</span><br><span class="line">    <span class="keyword">with</span> xlrd.open_workbook(xls_filename) <span class="keyword">as</span> wb:</span><br><span class="line">        ws = wb.sheet_by_index(<span class="number">0</span>)</span><br><span class="line">    table = OrderedDict()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ws.nrows):</span><br><span class="line">        key = <span class="built_in">int</span>(ws.row_values(i)[<span class="number">0</span>])</span><br><span class="line">        value = <span class="built_in">str</span>(ws.row_values(i)[<span class="number">1</span>:])</span><br><span class="line">        table[key] = value</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;student.xml&quot;</span>,<span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        root = etree.Element(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">        e_root = etree.ElementTree(root)</span><br><span class="line">        e_students = etree.SubElement(root,<span class="string">&#x27;students&#x27;</span>)</span><br><span class="line">        e_students.text = <span class="string">&#x27;\n&#x27;</span>+json.dumps(table,indent=<span class="number">4</span>,ensure_ascii=<span class="literal">False</span>)+<span class="string">&#x27;\n&#x27;</span></span><br><span class="line">        e_students.append(etree.Comment(<span class="string">&#x27;\n    学生信息表\n    &quot;id&quot; : [名字，数学，语文，英语]\n&#x27;</span>))</span><br><span class="line">        f.write((<span class="string">&#x27;&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&#x27;</span>+etree.tounicode(e_root.getroot())))</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    xls2xml(<span class="string">&#x27;student.xls&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> <span class="string">&#x27;done&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="第0018题"><a href="#第0018题" class="headerlink" title="第0018题"></a>第0018题</h1><p>将 第 0015 题中的 city.xls 文件中的内容写到 city.xml 文件中，如下所示：</p>
<blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&lt;?xmlversion=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;citys&gt;</span><br><span class="line">&lt;!-- </span><br><span class="line">	城市信息</span><br><span class="line">--&gt;</span><br><span class="line">&#123;</span><br><span class="line">	<span class="string">&quot;1&quot;</span> : <span class="string">&quot;上海&quot;</span>,</span><br><span class="line">	<span class="string">&quot;2&quot;</span> : <span class="string">&quot;北京&quot;</span>,</span><br><span class="line">	<span class="string">&quot;3&quot;</span> : <span class="string">&quot;成都&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&lt;/citys&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="解题思路-14"><a href="#解题思路-14" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>方法类似于0017题，首先将xls文件通过<code>xlrd</code>读出来，放在有序字典中</li>
<li>然后通过<code>xml.dom.minidom</code>模块建立<code>Document</code>，然后创建元素root<code>root = xml.createElement(&#39;root&#39;)</code>，然后建立子节点，最后写入xml文件中</li>
</ol>
<h2 id="源代码-7"><a href="#源代码-7" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/6/10 17:09</span></span><br><span class="line"><span class="keyword">import</span> xlrd,json</span><br><span class="line"><span class="keyword">from</span> xml.dom <span class="keyword">import</span> minidom</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def list2dict(list_name):</span></span><br><span class="line"><span class="comment">#     dic = &#123;&#125;</span></span><br><span class="line"><span class="comment">#     for list_element in list_name:</span></span><br><span class="line"><span class="comment">#         dic[list_element[0]] = list_element[1:]</span></span><br><span class="line"><span class="comment">#     return dic</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">creat_and_write_xml</span>(<span class="params">filename,row_data</span>):</span><br><span class="line">    xml = minidom.Document()</span><br><span class="line">    root = xml.createElement(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">    xml.appendChild(root)</span><br><span class="line">    city = xml.createElement(<span class="string">&#x27;city&#x27;</span>)</span><br><span class="line">    root.appendChild(city)</span><br><span class="line">    city.appendChild(xml.createComment(<span class="string">&quot;城市信息&quot;</span>))</span><br><span class="line">    row_data = json.dumps(row_data,ensure_ascii=<span class="literal">False</span>,indent=<span class="number">1</span>)</span><br><span class="line">    text = xml.createTextNode(row_data.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    city.appendChild(text)</span><br><span class="line">    f = <span class="built_in">open</span>(filename,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    f.write(xml.toprettyxml())</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data = xlrd.open_workbook(<span class="string">&#x27;city.xls&#x27;</span>)</span><br><span class="line">    table = data.sheet_by_index(<span class="number">0</span>)</span><br><span class="line">    row_data = &#123;&#125;</span><br><span class="line">    <span class="comment"># res=[]</span></span><br><span class="line">    <span class="comment"># for i in range(table.nrows):</span></span><br><span class="line">    <span class="comment">#     for j in range(table.ncols):</span></span><br><span class="line">    <span class="comment">#         if isinstance(table.cell(i,j).value,unicode):</span></span><br><span class="line">    <span class="comment">#             a = table.cell(i,j).value.encode(&#x27;gb2312&#x27;)</span></span><br><span class="line">    <span class="comment">#             # print table.cell(i,j).value</span></span><br><span class="line">    <span class="comment">#         elif isinstance(table.cell(i,j).value,float) or isinstance(table.cell(i,j).value, int):</span></span><br><span class="line">    <span class="comment">#             a = unicode(table.cell(i,j).value).decode(&#x27;utf-8&#x27;).encode(&#x27;gb2312&#x27;)</span></span><br><span class="line">    <span class="comment">#             # print table.cell(i, j).value</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#         # table.cell(i, j).value = str(table.cell(i, j).value).decode(&#x27;utf-8&#x27;).encode(&#x27;gb2312&#x27;)</span></span><br><span class="line">    <span class="comment">#         res.append(a)</span></span><br><span class="line">    <span class="comment">#     res.append(&quot;|&quot;)</span></span><br><span class="line">    <span class="comment"># # print res</span></span><br><span class="line">    <span class="comment"># res_string = &#x27; &#x27;.join(res).split(&quot;|&quot;)</span></span><br><span class="line">    <span class="comment"># res_string.pop(-1)</span></span><br><span class="line">    <span class="comment"># print res_string,&#x27;11111111112&#x27;</span></span><br><span class="line">    <span class="comment"># for i in range(len(res_string)):</span></span><br><span class="line">    <span class="comment">#     row_data[i+1] = res_string[i][1:]</span></span><br><span class="line">    <span class="comment"># print row_data</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(table.nrows):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;&#x27;</span>.join(table.row_values(i)[<span class="number">1</span>:])</span><br><span class="line">        row_data[i+<span class="number">1</span>] = <span class="string">&#x27;&#x27;</span>.join(table.row_values(i)[<span class="number">1</span>:])</span><br><span class="line">    filename = <span class="string">&#x27;city.xml&#x27;</span></span><br><span class="line">    creat_and_write_xml(filename, row_data)</span><br></pre></td></tr></table></figure>

<h1 id="第0019题"><a href="#第0019题" class="headerlink" title="第0019题"></a>第0019题</h1><p>将 第 0016 题中的 numbers.xls 文件中的内容写到 numbers.xml 文件中，如下所示：</p>
<blockquote>
 <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">numbers</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- </span></span><br><span class="line"><span class="comment">	数字信息</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">	[1, 82, 65535],</span><br><span class="line">	[20, 90, 13],</span><br><span class="line">	[26, 809, 1024]</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">numbers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="解题思路-15"><a href="#解题思路-15" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>整体思路与0018题类似，用<code>xlrd</code>文件读取xls文件内容</li>
<li>用<code>xml.dom.minidom</code>创建<code>Document</code>对象，然后通过创建名为root的element<code>xml.createElement(&#39;root&#39;)</code>，然后通过<code>xml.appendChild(root)</code>把root添加为xml文件的根节点，创建并添加number节点，添加<code>comment</code>注释节点并添加为子节点，添加文本节点并添加为子节点，最终用<code>topreetyxml</code>写入xml</li>
</ol>
<h2 id="源代码-8"><a href="#源代码-8" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/6/10 17:09</span></span><br><span class="line"><span class="keyword">import</span> xlrd,json</span><br><span class="line"><span class="keyword">from</span> xml.dom <span class="keyword">import</span> minidom</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">creat_and_write_xml</span>(<span class="params">filename,row_data</span>):</span><br><span class="line">    xml = minidom.Document()</span><br><span class="line">    root = xml.createElement(<span class="string">&#x27;root&#x27;</span>)</span><br><span class="line">    xml.appendChild(root)</span><br><span class="line">    number = xml.createElement(<span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">    root.appendChild(number)</span><br><span class="line">    number.appendChild(xml.createComment(<span class="string">&quot;城市信息&quot;</span>))</span><br><span class="line">    row_data = json.dumps(row_data,ensure_ascii=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    text = xml.createTextNode(row_data.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"></span><br><span class="line">    number.appendChild(text)</span><br><span class="line">    f = <span class="built_in">open</span>(filename,<span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    f.write(xml.toprettyxml())</span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    data = xlrd.open_workbook(<span class="string">&#x27;number.xls&#x27;</span>)</span><br><span class="line">    table = data.sheet_by_index(<span class="number">0</span>)</span><br><span class="line">    row_data = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(table.nrows):</span><br><span class="line">        row_data[i+<span class="number">1</span>] = table.row_values(i)[<span class="number">1</span>:]</span><br><span class="line">    filename = <span class="string">&#x27;number.xml&#x27;</span></span><br><span class="line">    creat_and_write_xml(filename, row_data)</span><br></pre></td></tr></table></figure>

<h1 id="第0020题"><a href="#第0020题" class="headerlink" title="第0020题"></a>第0020题</h1><p> <a href="http://iservice.10010.com/index_.html">登陆中国联通网上营业厅</a> 后选择「自助服务」 –&gt; 「详单查询」，然后选择你要查询的时间段，点击「查询」按钮，查询结果页面的最下方，点击「导出」，就会生成类似于 2014年10月01日～2014年10月31日通话详单.xls 文件。写代码，对每月通话时间做个统计。</p>
<h2 id="解题思路-16"><a href="#解题思路-16" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>导出的文件是一个xls文件，我们使用<code>xlrd</code>模块读入内容</p>
</li>
<li><p>统计数据并通过<code>plt.bar</code>画直方图，第一个参数为横坐标，第二个参数为纵坐标，<font color="red">要想plt显示中文标注</font>，需要：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;SimHei&#x27;</span>] <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>]=<span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="源代码-9"><a href="#源代码-9" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/6/27 16:50</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> xlrd,re,pprint</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> seaborn</span><br><span class="line">plt.rcParams[<span class="string">&#x27;font.sans-serif&#x27;</span>]=[<span class="string">&#x27;SimHei&#x27;</span>] <span class="comment">#用来正常显示中文标签</span></span><br><span class="line">plt.rcParams[<span class="string">&#x27;axes.unicode_minus&#x27;</span>]=<span class="literal">False</span> <span class="comment">#用来正常显示负号</span></span><br><span class="line">wb = xlrd.open_workbook(<span class="string">&#x27;2017-6.xls&#x27;</span>)</span><br><span class="line">ws = wb.sheet_by_index(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">time2second</span>(<span class="params">time</span>):</span><br><span class="line">    second_pattern = <span class="string">u&#x27;([0-9]+)秒&#x27;</span></span><br><span class="line">    minute_pattern = <span class="string">u&#x27;([0-9]+)分&#x27;</span></span><br><span class="line">    minute = re.findall(minute_pattern, time)</span><br><span class="line">    second = re.findall(second_pattern, time)</span><br><span class="line">    <span class="comment"># print minute,second</span></span><br><span class="line">    <span class="keyword">if</span> minute:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(minute[<span class="number">0</span>]) * <span class="number">60</span> + <span class="built_in">int</span>(second[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> second:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">int</span>(second[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">data=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(ws.nrows):</span><br><span class="line">    data.append(ws.row_values(i))</span><br><span class="line">data.pop(<span class="number">0</span>)</span><br><span class="line">call_num = OrderedDict()</span><br><span class="line">call_time = OrderedDict()</span><br><span class="line">month = <span class="string">&#x27;2017-06-&#x27;</span></span><br><span class="line">day_range = <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">31</span>)</span><br><span class="line"><span class="keyword">for</span> i,item <span class="keyword">in</span> <span class="built_in">enumerate</span>(day_range):</span><br><span class="line">    <span class="keyword">if</span> item &lt; <span class="number">10</span>:</span><br><span class="line">        day_range[i] = <span class="string">&#x27;0&#x27;</span>+<span class="built_in">str</span>(item)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        day_range[i] = <span class="built_in">str</span>(i)</span><br><span class="line">date_range = [ month + day + <span class="string">&quot; &quot;</span> <span class="keyword">for</span> day <span class="keyword">in</span> day_range]</span><br><span class="line"><span class="keyword">for</span> date <span class="keyword">in</span> date_range:</span><br><span class="line">    call_num[date] = <span class="number">0</span></span><br><span class="line">    call_time[date] = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(data)):</span><br><span class="line">    row_value = data[row]</span><br><span class="line">    time = time2second(row_value[<span class="number">3</span>])</span><br><span class="line">    <span class="keyword">for</span> element <span class="keyword">in</span> row_value:</span><br><span class="line">        <span class="keyword">for</span> date <span class="keyword">in</span> date_range:</span><br><span class="line">            <span class="keyword">if</span> re.<span class="keyword">match</span>(date,element):</span><br><span class="line">                <span class="comment"># print element</span></span><br><span class="line">                call_num[date] = call_num[date] + <span class="number">1</span></span><br><span class="line">                call_time[date] = call_time[date] + time</span><br><span class="line"><span class="comment"># print call_num</span></span><br><span class="line"><span class="comment"># print call_time</span></span><br><span class="line">num = []</span><br><span class="line">time = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> call_num.iteritems():</span><br><span class="line">    num.append(i[<span class="number">1</span>])</span><br><span class="line">    time.append(i[<span class="number">0</span>])</span><br><span class="line"><span class="built_in">print</span> num</span><br><span class="line"><span class="built_in">print</span> np.arange(<span class="built_in">len</span>(num))</span><br><span class="line">plt.bar(np.arange(<span class="built_in">len</span>(num)),num)</span><br><span class="line">plt.xticks(<span class="built_in">range</span>(<span class="built_in">len</span>(num)))</span><br><span class="line">plt.xlabel(<span class="string">u&#x27;6月通话时间&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i, v <span class="keyword">in</span> <span class="built_in">enumerate</span>(num):</span><br><span class="line">    plt.text(i-<span class="number">0.35</span>,v+<span class="number">0.2</span>, <span class="built_in">str</span>(v), color=<span class="string">&#x27;blue&#x27;</span>, fontweight=<span class="string">&#x27;bold&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<h1 id="第0021题"><a href="#第0021题" class="headerlink" title="第0021题"></a>第0021题</h1><p>通常，登陆某个网站或者 APP，需要使用用户名和密码。密码是如何加密后存储起来的呢？请使用 Python 对密码加密。</p>
<h2 id="解题思路-17"><a href="#解题思路-17" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>要想加密，可以使用<code>hashlib.sha256</code>库，使用<code>os.random(8)</code>生成一个长度为8位的salt，让密码与salt一起进行哈希，进行哈希的函数是<code>hmac.HMAC</code></li>
<li>判定输入的密码是不是正确，只需要将新接受到的密码与原先的salt一起进行一次hash看是否等于之前的hash结果</li>
</ol>
<h2 id="源代码-10"><a href="#源代码-10" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/6/28 11:00</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> hmac <span class="keyword">import</span> HMAC</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hash_password</span>(<span class="params">password, salt = <span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(password, unicode):</span><br><span class="line">        password = password.encode(<span class="string">&#x27;UTF-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> salt <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        salt = os.urandom(<span class="number">8</span>)</span><br><span class="line">    result = HMAC(password, salt, sha256).digest()</span><br><span class="line">    <span class="keyword">return</span> result,salt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">authen_password</span>(<span class="params">result, new_password, salt</span>):</span><br><span class="line">    <span class="keyword">return</span> hash_password(new_password,salt)[<span class="number">0</span>] == result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    password = raw_input(<span class="string">&#x27;please input the password: &#x27;</span>)</span><br><span class="line">    result,salt = hash_password(password)</span><br><span class="line">    <span class="built_in">print</span> result</span><br><span class="line">    new_password = raw_input(<span class="string">&#x27;please input the password again: &#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span> authen_password(result,password,salt)</span><br></pre></td></tr></table></figure>

<h1 id="第0022题"><a href="#第0022题" class="headerlink" title="第0022题"></a>第0022题</h1><p> iPhone 6、iPhone 6 Plus 早已上市开卖。请查看你写得 第 0005 题的代码是否可以复用。</p>
<h2 id="解题思路-18"><a href="#解题思路-18" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li>整体思路与0005题类似，利用<code>PIL.Image.resize</code>函数对图片进行重塑大小</li>
</ol>
<h2 id="源代码-11"><a href="#源代码-11" class="headerlink" title="源代码"></a>源代码</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: gbk -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/6/28 13:53</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">resize</span>(<span class="params">filename,new_name</span>):</span><br><span class="line">    pic = Image.<span class="built_in">open</span>(filename)</span><br><span class="line">    out = pic.resize((<span class="number">1000</span>,<span class="number">800</span>),Image.ANTIALIAS)</span><br><span class="line">    out.save(new_name,quality=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">list_dir = os.walk(<span class="string">r&#x27;C:\Users\jeffrey\Desktop\python exercise\python练习册\22\pic&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> root, dirs, files <span class="keyword">in</span> list_dir:</span><br><span class="line">    <span class="keyword">for</span> f <span class="keyword">in</span> files:</span><br><span class="line">        a = os.path.join(root, f)</span><br><span class="line">        <span class="built_in">print</span> a</span><br><span class="line">        new_name = os.path.join(root,<span class="string">&#x27;new_1&#x27;</span>+f)</span><br><span class="line">        <span class="built_in">print</span> new_name</span><br><span class="line">        resize(a,new_name)</span><br></pre></td></tr></table></figure>

<h1 id="第0023题"><a href="#第0023题" class="headerlink" title="第0023题"></a>第0023题</h1><p>使用 Python 的 Web 框架，做一个 Web 版本 留言簿 应用。</p>
<p><a href="http://v2ex.com/t/151643#reply53">阅读资料：Python 有哪些 Web 框架</a></p>
<p><img src="http://i.imgur.com/VIyCZ0i.jpg" alt="留言簿参考"></p>
<h2 id="解题思路-19"><a href="#解题思路-19" class="headerlink" title="解题思路"></a>解题思路</h2><ol>
<li><p>使用的是flask框架，参照网上的示例，先在app文件夹下建立<code>__init__.py</code>，在文件中写入如下内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> FLASK</span><br><span class="line"><span class="keyword">from</span> flask_mongoengine <span class="keyword">import</span> MongoEngine</span><br><span class="line"></span><br><span class="line">app = FLASK(__name__)</span><br><span class="line">app.config.from_object(<span class="string">&quot;config&quot;</span>)</span><br><span class="line">db = MongoEngine(app)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> views,models</span><br></pre></td></tr></table></figure>

<p>其中的<code>models.py</code>定义了Todo类，包含内容，时间，和状态三个属性，如下所示:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> db</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> flask_mongoengine.wtf <span class="keyword">import</span> model_form</span><br></pre></td></tr></table></figure>


<p>class Todo(db.Document):<br>content &#x3D; db.StringField(required&#x3D;True, max_length&#x3D;20)<br>time &#x3D; db.DateTimeField(default&#x3D;datetime.datetime.now())<br>status &#x3D; db.IntField(default&#x3D;0)<br>TodoForm &#x3D; model_form(Todo)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">其中`views.py`定义了每个页面的函数，如下：</span><br><span class="line"></span><br><span class="line">```python</span><br><span class="line">from . import app</span><br><span class="line">from flask import render_template, request</span><br><span class="line">from models import Todo, TodoForm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/&#x27;)</span><br><span class="line">def index():</span><br><span class="line">    form = TodoForm()</span><br><span class="line">    todos = Todo.objects.order_by(&#x27;-time&#x27;)</span><br><span class="line">    return render_template(&quot;index.html&quot;, todos=todos, form=form)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/add&#x27;, methods=[&#x27;POST&#x27;, ])</span><br><span class="line">def add():</span><br><span class="line">    form = TodoForm(request.form)</span><br><span class="line">    if form.validate():</span><br><span class="line">        content = form.content.data</span><br><span class="line">        todo = Todo(content=content)</span><br><span class="line">        todo.save()</span><br><span class="line">    todos = Todo.objects.order_by(&#x27;-time&#x27;)</span><br><span class="line">    return render_template(&quot;index.html&quot;, todos=todos, form=form)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/done/&lt;string:todo_id&gt;&#x27;)</span><br><span class="line">def done(todo_id):</span><br><span class="line">    form = TodoForm()</span><br><span class="line">    todo = Todo.objects.get_or_404(id=todo_id)</span><br><span class="line">    todo.status = 1</span><br><span class="line">    todo.save()</span><br><span class="line">    todos = Todo.objects.all()</span><br><span class="line">    return render_template(&#x27;index.html&#x27;, todos=todos, form=form)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/undone/&lt;string:todo_id&gt;&#x27;)</span><br><span class="line">def undone(todo_id):</span><br><span class="line">    form = TodoForm()</span><br><span class="line">    todo = Todo.objects.get_or_404(id=todo_id)</span><br><span class="line">    todo.status = 0</span><br><span class="line">    todo.save()</span><br><span class="line">    todos = Todo.objects.all()</span><br><span class="line">    return render_template(&quot;index.html&quot;, todos=todos,form=form)</span><br><span class="line"></span><br><span class="line">@app.route(&#x27;/delete/&lt;string:todo_id&gt;&#x27;)</span><br><span class="line">def delete(todo_id):</span><br><span class="line">    form = TodoForm()</span><br><span class="line">    todo = Todo.objects.get_or_404(id=todo_id)</span><br><span class="line">    todo.delete()</span><br><span class="line">    todos = Todo.objects.all()</span><br><span class="line">    return render_template(&#x27;index.html&#x27;, todos=todos,form=form)</span><br><span class="line"></span><br><span class="line">@app.errorhandler(404)</span><br><span class="line">def not_found(e):</span><br><span class="line">    return render_template(&#x27;404.html&#x27;),404</span><br></pre></td></tr></table></figure>

<p>​</p>
<p><strong>其中<code>index.html</code>文件是放在<code>app/templates</code>文件夹下的网页模板文件</strong></p>
<p><strong>所有关于<code>index.html</code>文件的静态文件（如js和css文件）均放在<code>app/statics</code>下面</strong></p>
</li>
<li><p>在<code>index.html</code>文件中写入网页模板如下：<br>如果要用到循环：大括号加百分号的形式，<code>&#123; % for error in form.error.content % &#125;</code><br>要用到某个变量：双大括号，<code>&#123; &#123; &#125; &#125; t.content &#125;&#125;</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123; % extends &quot;base.html&quot; % &#125; &#123; % block content % &#125; <span class="comment">&lt;!--继承base.html--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">td</span>&#123;<span class="attribute">text-align</span>: center&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.content_td</span>&#123;<span class="attribute">width</span>: <span class="number">100px</span>&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.time_td</span>&#123;<span class="attribute">width</span>: <span class="number">300px</span>&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-class">.done_td</span>&#123;<span class="attribute">width</span>: <span class="number">100px</span>&#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">class</span>=<span class="string">&quot;input-form&quot;</span> <span class="attr">action</span>=<span class="string">&quot;/add&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span>   <span class="comment">&lt;!--输入框，记录输入的内容--&gt;</span></span><br><span class="line">    &#123; &#123; &#125; &#125; form.hidden_tag() &#125;&#125;</span><br><span class="line">    &#123; &#123; &#125; &#125; form.content(class=&quot;form-control&quot;) &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;input-btn&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;btn-primary&quot;</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span>Add<span class="tag">&lt;/<span class="name">button</span>&gt;</span>  <span class="comment">&lt;!--提交按钮--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">&#123; % for error in form.errors.content % &#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;flash alert&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>&#123; &#123; &#125; &#125; error &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123; % endfor % &#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Todo List<span class="tag">&lt;/<span class="name">h2</span>&gt;</span> </span><br><span class="line">    &#123; % if todos % &#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin: 0 auto&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;content_td&quot;</span>&gt;</span>Content<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;time_td&quot;</span>&gt;</span>Time<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;done_td&quot;</span>&gt;</span>Operation<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">            &#123; % for t in todos % &#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;content_td&quot;</span>&gt;</span>&#123; &#123; &#125; &#125; t.content &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;time_td&quot;</span>&gt;</span>&#123; &#123; &#125; &#125; t.time.strftime(&#x27; %m-%d %H:%M&#x27;) &#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">td</span> <span class="attr">class</span>=<span class="string">&quot;done_td&quot;</span>&gt;</span></span><br><span class="line">                    &#123; % if t.status == 0 % &#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/done/&#123; &#123; &#125; &#125; t.id &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color: blue&quot;</span>&gt;</span>Done<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">                    &#123; % else % &#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/undone/&#123; &#123; &#125; &#125; t.id &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color: red&quot;</span>&gt;</span>Undone<span class="tag">&lt;/<span class="name">a</span>&gt;</span> </span><br><span class="line">                    &#123; % endif % &#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/delete/&#123; &#123; &#125; &#125; t.id &#125;&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;delete btn&quot;</span>&gt;</span>Delete<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">            &#123; % endfor % &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    &#123; % else % &#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span> <span class="attr">style</span>=<span class="string">&quot;color: red&quot;</span>&gt;</span>NO Todos, please add things<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    &#123; % endif % &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123; % endblock % &#125;</span><br></pre></td></tr></table></figure>

<p><strong>而<code>index.html</code>文件继承于<code>base.html</code>文件如下：</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        *&#123;<span class="attribute">text-align</span>: center&#125;</span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">td</span>&#123;<span class="attribute">line-height</span>: <span class="number">30px</span>&#125;</span></span><br><span class="line"><span class="language-css">        </span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>to_do<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123; &#123; &#125; &#125; url_for(&#x27;static&#x27;,filename=&#x27;bootstrap.css&#x27;) &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;&#123; &#123; &#125; &#125; url_for(&#x27;static&#x27;,filename=&#x27;index.css&#x27;) &#125;&#125;&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;page-header&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>my-flask-todo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-lg-10&quot;</span>&gt;</span></span><br><span class="line">           &#123; % block content % &#125;</span><br><span class="line">           &#123; % endblock % &#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">&quot;footer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;text-muted&quot;</span>&gt;</span>Copyright © drawon 2015<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>my_to_do/app</code>的<code>my_to_do</code>文件夹下，写配置文件<code>config.py</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">SECRET_KEY = <span class="string">&quot;never tell you&quot;</span></span><br><span class="line">MONGODB_SETTINGS = &#123;<span class="string">&#x27;DB&#x27;</span>: <span class="string">&#x27;todo_db&#x27;</span>&#125;</span><br><span class="line">WTF_CSRF_ENABLED = <span class="literal">False</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>my_to_do/app</code>的<code>my_to_do</code>文件夹下，写管理文件<code>manage.py</code>，通过这个py文件启动flask：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> flask.ext.script <span class="keyword">import</span> Manager, Server</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> app</span><br><span class="line"><span class="keyword">from</span> app.models <span class="keyword">import</span> Todo</span><br><span class="line"></span><br><span class="line">manager = Manager(app)                     <span class="comment">#定义Manager对象</span></span><br><span class="line"></span><br><span class="line">manager.add_command(<span class="string">&quot;runserver&quot;</span>,</span><br><span class="line">                    Server(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">                           port=<span class="number">5000</span>,</span><br><span class="line">                           use_debugger=<span class="literal">True</span>)) <span class="comment">#通过add_command命令添加网页启动命令 runserver </span></span><br><span class="line"></span><br><span class="line"><span class="meta">@manager.command    </span><span class="comment"># 添加新的命令save_todo</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_todo</span>():</span><br><span class="line">todo = Todo(content=<span class="string">&quot;my first todo&quot;</span>)</span><br><span class="line">todo.save()</span><br><span class="line"><span class="keyword">if</span> name == <span class="string">&#x27;main&#x27;</span>:</span><br><span class="line">	manager.run()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>在命令行运行 <code>python manage.py runserver</code>即可开启网页</p>
</li>
</ol>
<h2 id="源代码-12"><a href="#源代码-12" class="headerlink" title="源代码"></a>源代码</h2><p>具体请查看<a href="https://github.com/drawwon/show-me-the-code/tree/master/23">github</a></p>
]]></content>
      <categories>
        <category>编程练习</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>react+react-router搭建管理系统</title>
    <url>/2018/06/17/react-react-router%E6%90%AD%E5%BB%BA%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h3 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h3><p>因为http是一种无状态的请求，如果需要记录访问者的身份，那么就需要借助cookie和session</p>
<p>cookie是浏览器保存的一系列值，其字段及定义如下：</p>
<span id="more"></span>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-6-17/92453069.jpg"></p>
<p>与cookie对应的是session，session由服务器端产生记录请求者身份，其字段定义如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-6-17/62150518.jpg"></p>
<p>session在关闭页面之后就会自动删除</p>
<p>localStorage是H5引入的机制，是一些key-value的键值对，有域名限制（完全匹配，不存在域的概念），关闭浏览器之后内容仍然存在，用setItem和removeItem进行添加和删除</p>
<p>sessionStorage与localStorage很相似，在关闭浏览器之后消失</p>
<h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><h3 id="页面的三种路由"><a href="#页面的三种路由" class="headerlink" title="页面的三种路由"></a>页面的三种路由</h3><p>管理浏览器不同页面跳转的机制</p>
<p>包含三个部分：</p>
<ol>
<li>历史：堆栈的结构，入栈和出栈记录访问历史</li>
<li>跳转：在不同页面之间的跳转，并且可以传递参数</li>
<li>事件：打开新页面或者退回上一页面的逻辑</li>
</ol>
<p>常见的router：</p>
<ol>
<li>页面Router：整个页面重新加载</li>
<li>hash router：跳转时只有页面的hash值变化，页面本身并没有重新加载</li>
<li>H5 Router：可以操作整个路径，既能操作hash又能操作页面</li>
</ol>
<p>用浏览器尝试进行跳转，用下面这条指令可以跳到baidu：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">href</span> = <span class="string">&#x27;http://www.baidu.com&#x27;</span></span><br><span class="line">history.<span class="title function_">back</span>()</span><br></pre></td></tr></table></figure>

<p>点返回按钮，可以看到整个的路由历史</p>
<p>再试一下hash跳转：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">location</span> = <span class="string">&#x27;#test&#x27;</span></span><br><span class="line">windows.<span class="property">onhashChange</span> = <span class="function">()=&gt;</span>&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;current hash&#x27;</span>, <span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">hash</span>)&#125; <span class="comment">//监听所有的hash改变的情况</span></span><br></pre></td></tr></table></figure>

<p>发现只是在原本的地址后面加了一个<code>#test</code></p>
<p>再试一下H5的跳转方法，H5是用<code>history.pushState</code>来手动改变地址，既可以hash跳转，也可以直接跳转到其他页面</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">history.<span class="title function_">pushState</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;#test&#x27;</span>)</span><br><span class="line">history.<span class="title function_">pushState</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;/index/user&#x27;</span>)</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onpopstate</span> = <span class="function"><span class="params">e</span>=&gt;</span>&#123;            <span class="comment">//监听后退的事件,也就是pop栈的时候</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;h5 router change&#x27;</span>,e.<span class="property">state</span> );</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;绝对路径&#x27;</span>,<span class="variable language_">window</span>.<span class="property">location</span>,href);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;相对路径&#x27;</span>,<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">pathname</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;hash值&#x27;</span>,windows.<span class="property">location</span>.<span class="property">hash</span>);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;search值&#x27;</span>,windows.<span class="property">location</span>.<span class="property">search</span>);</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">history.<span class="title function_">replaceState</span>(<span class="string">&#x27;name&#x27;</span>,<span class="string">&#x27;title&#x27;</span>,<span class="string">&#x27;#test&#x27;</span>)<span class="comment">//替换当前的路由，但是不记录上一次的路由，就是直接替换，不入栈</span></span><br></pre></td></tr></table></figure>

<h3 id="react-router-1"><a href="#react-router-1" class="headerlink" title="react-router"></a>react-router</h3><p>提供了两种router，<code>&lt;BrowsorRouter&gt;</code>和<code>&lt;HashRouter&gt;</code></p>
<ul>
<li><code>&lt;Route&gt;</code>：router里面的路由选项，哪个页面对应哪个组件</li>
<li><code>&lt;Switch&gt;</code>：解决多次匹配的问题，返回第一个符合规则的匹配</li>
<li><code>&lt;Link&gt;</code>和<code>&lt;NavLink&gt;</code>：跳转导航，相当于HTML当中的<code>&lt;a&gt;</code>，后者是加了选中状态的处理，适合做导航菜单</li>
<li><code>&lt;Redirect&gt;</code>：用于自动跳转，匹配到某个路径的时候，自动跳转到另外的路径</li>
</ul>
]]></content>
      <categories>
        <category>react</category>
        <category>前端</category>
      </categories>
      <tags>
        <tag>react</tag>
      </tags>
  </entry>
  <entry>
    <title>react初探</title>
    <url>/2018/06/07/react%E5%88%9D%E6%8E%A2/</url>
    <content><![CDATA[<p>React是Facebook用来开发insgram的</p>
<p>MVC：Model，View，Control，称之为模型，视图，控制，react属于视图部分</p>
<p>ES5和ES6之间的转换工具叫做Babel，是Nodejs的一个包</p>
<span id="more"></span>

<h2 id="npm与nodejs及react的安装"><a href="#npm与nodejs及react的安装" class="headerlink" title="npm与nodejs及react的安装"></a>npm与nodejs及react的安装</h2><p>安装好Nodejs和npm环境，查看是否安装成功</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">node -v</span><br><span class="line">npm -v</span><br></pre></td></tr></table></figure>

<p>配置国内镜像</p>
<p>淘宝镜像提供了一个cnpm的工具，可以用<code>cnpm</code>命令来安装所有的包</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<p>也可以直接配置全局文件改变下载地址，mac和Linux的配置文件在<code>~/.npm/.npmrc</code>，windows的在node安装目录下<code>/node_modules/npm/npmrc</code>。在其中添加：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure>

<h3 id="旧版react的配置方式"><a href="#旧版react的配置方式" class="headerlink" title="旧版react的配置方式"></a>旧版react的配置方式</h3><p>mooc教程中用到的方法比较旧，具体是首先执行<code>npm init</code>，生成一个<code>package.json</code>文件，这个文件记录了项目的所有信息，然后通过<code>npm install --sava xxxx</code>各种包，<code>--save</code>的意思是将这个包的安装同步到<code>package.json</code>文件中</p>
<h3 id="新版react的配置方式"><a href="#新版react的配置方式" class="headerlink" title="新版react的配置方式"></a>新版react的配置方式</h3><p>现在react官网已经提供了一个专门用于管理react项目的npm包——<code>create-react-app</code>，用<code>npm install -g</code>安装，<code>-g</code>的意思是global，全局安装</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">npm install -g create-react-app</span><br><span class="line">create-react-app my-app</span><br><span class="line"><span class="comment">#删除所有/src文件夹下面的内容</span></span><br><span class="line"><span class="built_in">cd</span> my-app</span><br><span class="line"><span class="built_in">rm</span> -f src/*</span><br><span class="line"><span class="comment">#添加一个index.css在src/目录下，其内容在https://codepen.io/gaearon/pen/oWWQNa?editors=0100</span></span><br><span class="line"><span class="comment">#添加一个index.js在src/目录下，其内容为 https://codepen.io/gaearon/pen/oWWQNa?editors=0010</span></span><br></pre></td></tr></table></figure>

<p>再加入以下几行到index.js最上面，用于引用React的相关包</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.css&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>然后在项目文件夹下运行<code>npm star</code>，打开浏览器<a href="http://localhost:3000/">http://localhost:3000</a>，就可以看到一个九宫格页面</p>
<p>运行时如果发现端口占用，在windows下就执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">netstat -ano | findstr 3000</span><br><span class="line">tskill xxx</span><br></pre></td></tr></table></figure>

<p>在Linux下执行</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">netstat -aux | grep 3000</span><br><span class="line"><span class="built_in">kill</span> xxx</span><br></pre></td></tr></table></figure>

<h3 id="webpack热加载配置"><a href="#webpack热加载配置" class="headerlink" title="webpack热加载配置"></a>webpack热加载配置</h3><p>通过<code>npm install webpack --save</code>和<code>npm install webpack-dev-server --sava</code>之后，新建一个<code>webpack.config.js</code>，输入以下内容用于打包整个文件，然后在命令行执行<code>webpack</code>，就生成了一个名为<code>bundle.js</code>的文件，你在html当中应该包含的就是这个<code>bundle.js</code>文件。</p>
<p>可以使用<code>webpack --watch</code>命令进入debug模式，这样在你保存文件之后就可以自动打包，不然每次都需要自己去执行<code>webpack</code>命令。</p>
<p>但是这样还需要自己刷新页面，如果需要自动刷新网页，运行<code>webpack-dev-server --contentbase src --inline --hot</code>，这样在你更改js之后网页会自动刷新</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> debug = process.<span class="property">env</span>.<span class="property">NODE_ENV</span> !== <span class="string">&quot;production&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> webpack = <span class="built_in">require</span>(<span class="string">&#x27;webpack&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = &#123;</span><br><span class="line">  <span class="attr">context</span>: path.<span class="title function_">join</span>(__dirname),</span><br><span class="line">  <span class="attr">devtool</span>: debug ? <span class="string">&quot;inline-sourcemap&quot;</span> : <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">entry</span>: <span class="string">&quot;./src/js/root.js&quot;</span>,</span><br><span class="line">  <span class="attr">module</span>: &#123;</span><br><span class="line">    <span class="attr">loaders</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">test</span>: <span class="regexp">/\.js?$/</span>,</span><br><span class="line">        <span class="attr">exclude</span>: <span class="regexp">/(node_modules)/</span>,</span><br><span class="line">        <span class="attr">loader</span>: <span class="string">&#x27;babel-loader&#x27;</span>,</span><br><span class="line">        <span class="attr">query</span>: &#123;</span><br><span class="line">          <span class="attr">presets</span>: [<span class="string">&#x27;react&#x27;</span>, <span class="string">&#x27;es2015&#x27;</span>],</span><br><span class="line">          <span class="attr">plugins</span>: [<span class="string">&#x27;react-html-attrs&#x27;</span>], <span class="comment">//添加组件的插件配置</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">//下面是使用 ant-design 的配置文件</span></span><br><span class="line">      &#123; <span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">loader</span>: <span class="string">&#x27;style-loader!css-loader&#x27;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">output</span>: &#123;</span><br><span class="line">    <span class="attr">path</span>: __dirname,</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;./src/bundle.js&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">plugins</span>: debug ? [] : [</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">DedupePlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">OccurenceOrderPlugin</span>(),</span><br><span class="line">    <span class="keyword">new</span> webpack.<span class="property">optimize</span>.<span class="title class_">UglifyJsPlugin</span>(&#123; <span class="attr">mangle</span>: <span class="literal">false</span>, <span class="attr">sourcemap</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">  ],</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>不过新的react的安装方式已经可以自动打包了，就不用手动安装<code>webpack</code>了</p>
<h2 id="React基本概念"><a href="#React基本概念" class="headerlink" title="React基本概念"></a>React基本概念</h2><h3 id="React-Virtual-DOM"><a href="#React-Virtual-DOM" class="headerlink" title="React Virtual DOM"></a>React Virtual DOM</h3><p>在页面和DOM之间加了一层virtual DOM，dom本身是document object model，有了虚拟DOM之后就可以利用virtual DOM对页面进行更改，virtual DOM由于在数据结构上面的优化，使得原本对不同的DOM的比较的复杂度由$O(n^3)$变成了$O(n)$，</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-6-8/98201829.jpg"></p>
<h3 id="React组件"><a href="#React组件" class="headerlink" title="React组件"></a>React组件</h3><p>组件就是一个个小模块，小模块在不同的页面之间都需要用，那么就可以复用，这样开发起来就很快。</p>
<p>我们先开发一个页面头部文件，在<code>src</code>目录中新建<code>components</code>文件夹，在其中新建<code>header.js</code>：</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ComponentHeader</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是头部<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的逻辑是首先从<code>React</code>这个包里面引入<code>React</code>和<code>React.Component</code>两个内容，<code>&#123;&#125;</code>的作用就是引入包当中的某个变量，然后定义一个外部可访问(<code>export</code>)的类叫做<code>ComponentHeader</code>，继承自引入的<code>Component</code>，类名一定要大写，在其中调用render方法，return一段html内容，注意：返回的一定是一个闭合的HTML标签，也就是最终是一个大的HTML节点，不能有多个，有多个的时候你可以尝试用一个大的节点把他们包裹起来</p>
<p>然后在<code>index.js</code>当中引用定义的<code>ComponentHeader</code>组件，render到html文件的header这个id之下，其中定义的ComponentHeader要用tag标记扩起来</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span> <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ReactDOM</span> <span class="keyword">from</span> <span class="string">&#x27;react-dom&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;./index.css&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ComponentHeader</span> <span class="keyword">from</span> <span class="string">&quot;./components/header&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">ComponentHeader</span> /&gt;</span></span>,<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;header&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>用同样的方法我们可以建立<code>footer.js</code>和<code>body.js</code></p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// footer.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ComponentFooter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是尾部<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">//indexBody.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123; <span class="title class_">Component</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">IndexBody</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>页面Body的内容<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>index.js</code>里面再定义一个class用于包含已有的三个<code>header</code>，<code>indexbody</code>,<code>footer</code>三个类</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ComponentHeader</span> <span class="keyword">from</span> <span class="string">&quot;./components/header&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="title class_">ComponentFooter</span> <span class="keyword">from</span> <span class="string">&quot;./components/footer.js&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">IndexBody</span> <span class="keyword">from</span> <span class="string">&quot;./components/indexBody&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ComponentHeader</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">IndexBody</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ComponentFooter</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：所有的class的name一定要是大写开头的，不然无法识别 </p>
<h3 id="JSX内置表达式"><a href="#JSX内置表达式" class="headerlink" title="JSX内置表达式"></a>JSX内置表达式</h3><figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">IndexBody</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> userName = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="keyword">var</span> boolinput = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">var</span> html = <span class="string">&quot;this\u0020is&quot;</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>页面主体内容<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;userName==&#x27;&#x27; ? &#x27;用户还没有登陆&#x27;:&#x27;用户名:&#x27;+userName&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;默认按钮&quot;</span> <span class="attr">disabled</span>=<span class="string">&#123;boolinput&#125;/</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;html&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/* 注释 */&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="三元表达式"><a href="#三元表达式" class="headerlink" title="三元表达式"></a>三元表达式</h4><p>三元表达式主要是用来进行条件判断的，比如我们在上面的代码汇总，需要判断<code>username</code>是否为空，用三元表达式<code>a==b?c:d</code>，判断ab是否相等，如果相等执行c，如果不相等执行d，这个判断语句要包含在大括号中</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">&lt;p&gt;&#123;userName==<span class="string">&#x27;&#x27;</span> ? <span class="string">&#x27;用户还没有登陆&#x27;</span>:<span class="string">&#x27;用户名:&#x27;</span>+userName&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure>

<h4 id="绑定参数"><a href="#绑定参数" class="headerlink" title="绑定参数"></a>绑定参数</h4><p>如果要对一个input的button绑定是否disable的属性，只需要用一个大括号带参数就可以直接绑定成功</p>
<p><strong>注意</strong>：绑定js参数的时候，<strong>没有引号</strong>，有引号会被解析为字符串</p>
<h4 id="解析HTML"><a href="#解析HTML" class="headerlink" title="解析HTML"></a>解析HTML</h4><p>如果我们现在有一串HTML代码，需要让render之后可以正确被解析，有两种方法：</p>
<ol>
<li><p>使用在线的转码工具，将html代码转成unicode编码的内容，然后传给内容html，比如下面的空格被转换成<code>\u0020</code>再传给render</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> html = <span class="string">&quot;this\u0020is&quot;</span></span><br><span class="line">&lt;p&gt;&#123;html&#125;&lt;/p&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用不推荐的<code>dangerouslySetInnerHTML</code>，因为这种方法可能造成xss攻击，因此不推荐</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> html = <span class="string">&quot;this\u0020is&quot;</span></span><br><span class="line">&lt;p dangerouslySetInnerHTML==&#123;&#123;__html : html&#125;&#125;&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>react本身定义了一系列的关于页面加载状态的函数，你可以用这些函数来判断页面加载的状态，并在不同状态的时候定义不同的命令</p>
<p>常用的生命周期函数有如下几种，示意图如下</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="title function_">componentWillMount</span>(<span class="params"></span>) &#123;&#125;  <span class="comment">//将要加载成功</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">componentDidMount</span>(<span class="params"></span>) &#123;&#125;	<span class="comment">//已经加载成功</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">componentWillReceiveProps</span>(<span class="params">nextProps</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">shouldComponentUpdate</span>(<span class="params">nextProps, nextState</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">componentWillUpdate</span>(<span class="params">nextProps, nextState</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">componentDidUpdate</span>(<span class="params">prevProps, prevState</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">componentWillUnmount</span>(<span class="params"></span>) &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-6-9/88589699.jpg"></p>
<h2 id="React事件与属性"><a href="#React事件与属性" class="headerlink" title="React事件与属性"></a>React事件与属性</h2><h3 id="state属性"><a href="#state属性" class="headerlink" title="state属性"></a>state属性</h3><p>state用于存放react组件的状态，一般赋值为一个json类型，放在<code>constructor</code>里面</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">IndexBody</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">username</span>: <span class="string">&#x27;carry&#x27;</span>,</span><br><span class="line">            <span class="attr">age</span>: <span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">username</span>: <span class="string">&quot;ohjj&quot;</span>&#125;)</span><br><span class="line">        &#125;, <span class="number">4000</span>);</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>页面主体内容<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;this.state.username&#125; &#123;this.state.age&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/* 注释 */&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过<code>setState</code>函数可以改变组件的状态值</p>
<h3 id="props属性"><a href="#props属性" class="headerlink" title="props属性"></a>props属性</h3><p>想要把外来的属性传给某个组件，就需要用到props属性，在render的内容中加入<code>参数名=&#123;参数值&#125;</code>就可以直接传回参数，在对应的js文件中直接用<code>&#123;this.props.参数名&#125;</code>就可以调用</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">//index.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ComponentHeader</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">IndexBody</span> <span class="attr">userid</span>=<span class="string">&#123;123456&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">ComponentFooter</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">App</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// indexbody.js</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">IndexBody</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">username</span>: <span class="string">&#x27;carry&#x27;</span>,</span><br><span class="line">            <span class="attr">age</span>: <span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">username</span>: <span class="string">&quot;ohjj&quot;</span>&#125;)</span><br><span class="line">        &#125;, <span class="number">4000</span>);</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>页面主体内容<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;this.state.username&#125; &#123;this.state.age&#125; &#123;this.props.userid&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                &#123;/* 注释 */&#125;</span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="事件与数据的双向绑定"><a href="#事件与数据的双向绑定" class="headerlink" title="事件与数据的双向绑定"></a>事件与数据的双向绑定</h3><p>父页面向子页面传递参数是在父页面直接定义变量，在子页面使用props属性来获取。</p>
<p>那么子页面如何向父页面传递参数呢，就需要由父页面向子页面传递一个处理函数，处理函数的event参数可以取到子页面中的值，比如在子页面的输入框中输入内容，改变父页面的某个参数值：</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">//父页面 indexbody.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">Bodychild</span> <span class="keyword">from</span> <span class="string">&quot;./bodychild&quot;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">IndexBody</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            <span class="attr">username</span>: <span class="string">&#x27;carry&#x27;</span>,</span><br><span class="line">            <span class="attr">age</span>: <span class="number">20</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">changeUserInfo</span>(<span class="params">age</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">age</span>: age&#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">handleChildChange</span>(<span class="params">event</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;<span class="attr">age</span>: event.<span class="property">target</span>.<span class="property">value</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>页面主体内容<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.changeUserInfo.bind(this,99)&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;this.state.username&#125; &#123;this.state.age&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Bodychild</span> <span class="attr">handleChildChange</span>=<span class="string">&#123;this.handleChildChange.bind(this)&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//子页面 bodychild.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bodychild</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>子页面输入：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">onChange</span>=<span class="string">&#123;this.props.handleChildChange&#125;/</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">Bodychild</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bind方法"><a href="#bind方法" class="headerlink" title="bind方法"></a>bind方法</h4><p>bind方法和call方法以及apply方法差不多，主要是用于解决this的指向问题的，</p>
<p>call方法参数第一个是需要执行的对象，后面依次表示不同的参数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a=&#123;</span><br><span class="line">    <span class="attr">age</span>:<span class="number">10</span>,</span><br><span class="line">    <span class="attr">fn</span>:<span class="keyword">function</span> <span class="title function_">getAge</span>(<span class="params"></span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">age</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line">a.<span class="title function_">fn</span>();<span class="comment">//输出10</span></span><br><span class="line"><span class="keyword">var</span> b = a.<span class="title function_">fn</span>();</span><br><span class="line">b;	<span class="comment">//输出undefined，因为此时的this指向b，this.age就相当于b.age，当然是未定义</span></span><br><span class="line">b.<span class="title function_">call</span>(a) <span class="comment">//输出10，call的格式是function.call(object,params)</span></span><br></pre></td></tr></table></figure>

<p>apply方法与call方法基本类似，只是apply后面第一个参数是object，第二个参数是一个打包好的array对象，用于存放所有的后面的参数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a=&#123;</span><br><span class="line">    <span class="attr">age</span>:<span class="number">10</span>,</span><br><span class="line">    <span class="attr">fn</span>:<span class="keyword">function</span> <span class="title function_">getAge</span>(<span class="params">params</span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">age</span>+<span class="variable language_">this</span>.<span class="property">params</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line">a.<span class="title function_">fn</span>(<span class="number">5</span>);<span class="comment">//输出15</span></span><br><span class="line"><span class="keyword">var</span> b = a.<span class="title function_">fn</span>();</span><br><span class="line">b;	<span class="comment">//输出undefined</span></span><br><span class="line">b.<span class="title function_">apply</span>(a,[<span class="number">5</span>]) <span class="comment">//输出15，apply的格式是function.apply(object,[params])</span></span><br></pre></td></tr></table></figure>

<p>bind方法与apply和call略有不同，但是三者都是用来改变this指向的</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a=&#123;</span><br><span class="line">    <span class="attr">age</span>:<span class="number">10</span>,</span><br><span class="line">    <span class="attr">fn</span>:<span class="keyword">function</span> <span class="title function_">getAge</span>(<span class="params">params</span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">age</span>+<span class="variable language_">this</span>.<span class="property">params</span>)&#125;</span><br><span class="line">&#125;</span><br><span class="line">a.<span class="title function_">fn</span>(<span class="number">5</span>);<span class="comment">//输出15</span></span><br><span class="line"><span class="keyword">var</span> b = a.<span class="property">fn</span>;</span><br><span class="line">b.<span class="title function_">bind</span>(a);<span class="comment">//发现没有任何输出，其实bind只是绑定了，但是没有执行</span></span><br><span class="line"><span class="keyword">var</span> c = b.<span class="title function_">bind</span>(a);</span><br><span class="line"><span class="title function_">c</span>();<span class="comment">//输出15，bind的格式是function.apply(object,params)()</span></span><br></pre></td></tr></table></figure>

<h3 id="prop验证"><a href="#prop验证" class="headerlink" title="prop验证"></a>prop验证</h3><p>用<code>propTypes</code>来约束类中的props的类型，<code>isRequired</code>表示必须给定这个值</p>
<p>用<code>defaultProps</code>来给定props的默认值</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> defaultProps=&#123;</span><br><span class="line">    <span class="attr">userid</span>:<span class="string">&#x27;默认的userid&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">IndexBody</span>.<span class="property">propTypes</span> = &#123;</span><br><span class="line">    <span class="attr">userid</span>: <span class="title class_">PropTypes</span>.<span class="property">number</span>.<span class="property">isRequired</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="title class_">IndexBody</span>.<span class="property">defaultProps</span> = defaultProps;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还有一个技巧：如果有多个参数从父页面传递到子页面，子页面需要再传给自身的子页面的时候，可以用<code>...this.props</code>，三个点的前两个表示上级页面，第三个点表示上级页面自身的this</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line">&lt;<span class="title class_">Bodychild</span> &#123;...<span class="variable language_">this</span>.<span class="property">props</span>&#125;/&gt;</span><br></pre></td></tr></table></figure>

<h3 id="组件refs"><a href="#组件refs" class="headerlink" title="组件refs"></a>组件refs</h3><p>refs可以用来找到某个组件，类似于js当中的<code>getElementById</code>的作用，在某个组建中定义一个ref，在改变的时候只需要用<code>this.refs.xxx</code></p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="title function_">changeUserInfo</span>(<span class="params">age</span>) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">        <span class="attr">age</span>: age</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//第一种方法，原生js的方法</span></span><br><span class="line">    <span class="keyword">let</span> mySubmitButton = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;submitButton&#x27;</span>);</span><br><span class="line">    <span class="title class_">ReactDOM</span>.<span class="title function_">findDOMNode</span>(mySubmitButton).<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;red&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二种方法，refs的方法</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">submitButton</span>);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">refs</span>.<span class="property">submitButton</span>.<span class="property">style</span>.<span class="property">color</span> = <span class="string">&#x27;blue&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>)&#123;</span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;submitButton&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;submitButton&quot;</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.changeUserInfo.bind(this,</span> <span class="attr">99</span>)&#125;/&gt;</span></span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="独立组件间共享Mixins"><a href="#独立组件间共享Mixins" class="headerlink" title="独立组件间共享Mixins"></a>独立组件间共享Mixins</h3><p>官方完全不推荐这个方法，因为ES6本身语法不支持，并且可能造成很多问题</p>
<p>如果非要用可以安装一个<code>react-mixin</code>的库，在需要用到这个东西的地方用<code>React.Mixin(类名.prototypem, 用到的mixins名称)</code></p>
<h2 id="React样式"><a href="#React样式" class="headerlink" title="React样式"></a>React样式</h2><h3 id="React内联样式"><a href="#React内联样式" class="headerlink" title="React内联样式"></a>React内联样式</h3><p>直接定义在render函数里面，然后通过className引用，这样相当于在html当中直接嵌入了css代码，是比较不美观的</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> styleHeader = &#123;</span><br><span class="line">        <span class="attr">header</span>: &#123;</span><br><span class="line">            <span class="attr">backgroundColor</span>: <span class="string">&quot;#333333&quot;</span>,</span><br><span class="line">            <span class="attr">color</span>: <span class="string">&quot;#FFFFFF&quot;</span>,</span><br><span class="line">            <span class="attr">paddingTop</span>: <span class="string">&quot;15px&quot;</span>,</span><br><span class="line">            <span class="attr">paddingBottom</span>: <span class="string">&quot;15px&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        <span class="language-xml"><span class="tag">&lt;<span class="name">header</span>  <span class="attr">className</span>=<span class="string">&quot;styleHeader&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是头部<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还可以单独定义css文件</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// style.css</span></span><br><span class="line">.<span class="property">smallFontSize</span> h1&#123;</span><br><span class="line">    font-<span class="attr">size</span>: 12px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//header.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../css/style.css&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ComponentHeader</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">header</span>  <span class="attr">className</span>=<span class="string">&quot;smallFontSize&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是头部<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="内联css当中的表达式"><a href="#内联css当中的表达式" class="headerlink" title="内联css当中的表达式"></a>内联css当中的表达式</h3><p>内联css当中可以嵌套一些简单的三元条件表达式，下面这个例子是在点击使得状态<code>miniHeader</code>改变的时候，调整header的padding值</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">ComponentHeader</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            miniHeader : <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">swithHeader</span>(<span class="params"></span>)&#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="title function_">setState</span>(&#123;</span><br><span class="line">                miniHeader : !<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">miniHeader</span></span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> styleHeader = &#123;</span><br><span class="line">            <span class="attr">header</span>: &#123;</span><br><span class="line">                <span class="attr">backgroundColor</span>: <span class="string">&quot;#333333&quot;</span>,</span><br><span class="line">                <span class="attr">color</span>: <span class="string">&quot;#FFFFFF&quot;</span>,</span><br><span class="line">                <span class="attr">paddingTop</span>: (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">miniHeader</span>) ? <span class="string">&quot;3px&quot;</span> : <span class="string">&quot;15px&quot;</span>,</span><br><span class="line">                <span class="attr">paddingBottom</span>: (<span class="variable language_">this</span>.<span class="property">state</span>.<span class="property">miniHeader</span>) ? <span class="string">&quot;3px&quot;</span> : <span class="string">&quot;15px&quot;</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">header</span> <span class="attr">style</span>=<span class="string">&#123;styleHeader.header&#125;</span> <span class="attr">onClick</span>=<span class="string">&#123;this.swithHeader.bind(this)&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是头部<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="css模块化"><a href="#css模块化" class="headerlink" title="css模块化"></a>css模块化</h3><p>css模块化就是在css引入的时候的第二种方法，引入css文件，给组件的ClassName赋值</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../css/style.css&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">header</span> <span class="attr">className</span>=<span class="string">&quot;smallFontSize&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">h1</span>&gt;</span>这是头部<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>

<h3 id="css与React内联样式互转"><a href="#css与React内联样式互转" class="headerlink" title="css与React内联样式互转"></a>css与React内联样式互转</h3><p>如果你有一个很大的css文件，在开发React-native的时候，你只能使用内联样式，这时你可以使用在线转换工具把css转换为React内联样式，<a href="https://staxmanade.com/CssToReact/">转换工具地址</a></p>
<h3 id="Ant-Design框架"><a href="#Ant-Design框架" class="headerlink" title="Ant Design框架"></a>Ant Design框架</h3><p>Ant Design是蚂蚁金服出的一个React UI框架，其中有一部分是介绍设计审美的，是非常值得一看的</p>
<p>通过<a href="https://ant.design/docs/react/use-with-create-react-app-cn">https://ant.design/docs/react/use-with-create-react-app-cn</a>进行使用</p>
<h4 id="引入Ant-Design"><a href="#引入Ant-Design" class="headerlink" title="引入Ant Design"></a>引入Ant Design</h4><p>现在从 yarn 或 npm 安装并引入 antd。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$ yarn add antd</span><br></pre></td></tr></table></figure>

<p>修改 <code>src/App.js</code>，引入 antd 的按钮组件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import React, &#123; Component &#125; from &#x27;react&#x27;;</span><br><span class="line">import Button from &#x27;antd/lib/button&#x27;;</span><br><span class="line">import &#x27;./App.css&#x27;;</span><br><span class="line"></span><br><span class="line">class App extends Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div className=&quot;App&quot;&gt;</span><br><span class="line">        &lt;Button type=&quot;primary&quot;&gt;Button&lt;/Button&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default App;</span><br></pre></td></tr></table></figure>

<p>修改 <code>src/App.css</code>，在文件顶部引入 <code>antd/dist/antd.css</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@import &#x27;~antd/dist/antd.css&#x27;;</span><br><span class="line"></span><br><span class="line">.App &#123;</span><br><span class="line">  text-align: center;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>好了，现在你应该能看到页面上已经有了 antd 的蓝色按钮组件，接下来就可以继续选用其他组件开发应用了。其他开发流程你可以参考 create-react-app 的<a href="https://github.com/facebookincubator/create-react-app/blob/master/packages/react-scripts/template/README.md">官方文档</a>。</p>
<h2 id="React-Router"><a href="#React-Router" class="headerlink" title="React-Router"></a>React-Router</h2><p>React-Router用于页面之间的跳转</p>
<h3 id="刷新部分页面内容"><a href="#刷新部分页面内容" class="headerlink" title="刷新部分页面内容"></a>刷新部分页面内容</h3><p>如果需要刷新部分页面内容，可以用<code>BrowserRouter</code>或者是<code>HashRouter</code>当中的一个，引入方法如下</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">HashRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>, <span class="title class_">Route</span>, <span class="title class_">Link</span>&#125; <span class="keyword">from</span> <span class="string">&quot;react-router-dom&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>然后在<code>index</code>类当中加入链接地址和<code>Route</code></p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/`&#125;&gt;</span>首页<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/<span class="attr">list1</span>`&#125;&gt;</span>list1<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/<span class="attr">list2</span>`&#125;&gt;</span>list2<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ComponentHeader</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">IndexBody</span> <span class="attr">userid</span>=<span class="string">&#123;1111&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ComponentFooter</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary marb10&quot;</span>&gt;</span>button<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入内容&quot;</span> <span class="attr">size</span>=<span class="string">&quot;small&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">App</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                            <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/list1&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;List&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/list2&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;List2&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Index</span>/&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));、</span><br></pre></td></tr></table></figure>

<p>Route是专门用来改变内容的，Route那一部分在哪，就改变哪一部分的内容，比如现在Route在<code>&lt;APP /&gt;</code>后面，那么就改变<code>&lt;App /&gt;</code>后面的内容</p>
<h3 id="重新定向到新页面"><a href="#重新定向到新页面" class="headerlink" title="重新定向到新页面"></a>重新定向到新页面</h3><p>如果需要定向到新页面，需要用到<code>Switch</code>参数，导入方法是：</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">HashRouter</span> <span class="keyword">as</span> <span class="title class_">Router</span>, <span class="title class_">Switch</span>, <span class="title class_">Route</span>, <span class="title class_">Link</span>&#125; <span class="keyword">from</span> <span class="string">&quot;react-router-dom&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>此时需要将Index当成一个普通的类，嵌套到另一个export的类当中（因为一个js页面只能有1个export的类），比如我们现在定义一个<code>Root</code>类，在<code>Root</code>类当中定义一个<code>Router</code>，在<code>Router</code>中嵌套<code>Switch</code>方法（因为官方规定Switch只能在Router当中使用），再在Switch当中嵌套一堆<code>Route</code>，用于定于需要路由的地址（第一个地址默认解析，后面的在你点的时候解析），代码如下：</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Index</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/`&#125;&gt;</span>首页<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/<span class="attr">list1</span>`&#125;&gt;</span>list1<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">Link</span> <span class="attr">to</span>=<span class="string">&#123;</span>`/<span class="attr">list2</span>`&#125;&gt;</span>list2<span class="tag">&lt;/<span class="name">Link</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ComponentHeader</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">IndexBody</span> <span class="attr">userid</span>=<span class="string">&#123;1111&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">ComponentFooter</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Button</span> <span class="attr">type</span>=<span class="string">&quot;primary marb10&quot;</span>&gt;</span>button<span class="tag">&lt;/<span class="name">Button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Input</span> <span class="attr">placeholder</span>=<span class="string">&quot;请输入内容&quot;</span> <span class="attr">size</span>=<span class="string">&quot;small&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">App</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">Router</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        &#123;/*第一个默认解析*/&#125;</span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">exact</span> <span class="attr">path</span>=<span class="string">&#x27;/&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;Index&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/list1&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;List&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Route</span> <span class="attr">path</span>=<span class="string">&#x27;/list2&#x27;</span> <span class="attr">component</span>=<span class="string">&#123;List2&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Switch</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">Router</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">ReactDOM</span>.<span class="title function_">render</span>(<span class="language-xml"><span class="tag">&lt;<span class="name">Root</span>/&gt;</span></span>, <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;root&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h2 id="网站开发常用技巧及资源"><a href="#网站开发常用技巧及资源" class="headerlink" title="网站开发常用技巧及资源"></a>网站开发常用技巧及资源</h2><h3 id="chrome模拟手机端"><a href="#chrome模拟手机端" class="headerlink" title="chrome模拟手机端"></a>chrome模拟手机端</h3><p>直接在chrome的开发者工具中点审查元素旁边的按钮，就可以模拟手机的显示效果，还可以显示手机边框</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-6-11/73459277.jpg"></p>
<h3 id="findIcon找图标"><a href="#findIcon找图标" class="headerlink" title="findIcon找图标"></a>findIcon找图标</h3><p>一个非常好的网站图标资源网站，地址：<a href="https://www.iconfinder.com/">https://www.iconfinder.com/</a></p>
<h2 id="项目实战开发"><a href="#项目实战开发" class="headerlink" title="项目实战开发"></a>项目实战开发</h2><h3 id="pc端页头的开发"><a href="#pc端页头的开发" class="headerlink" title="pc端页头的开发"></a>pc端页头的开发</h3><p>用到ant design的menu组件，还有ant desing的flex布局，flex布局将整个页面一共分为24列，我们这里左右各空2列，4列用于放logo，16列用于放menu</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">//pc_header.js</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>, &#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="comment">// import ReactDOM from &#x27;react-dom&#x27;;</span></span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Row</span>, <span class="title class_">Col</span>, <span class="title class_">Menu</span>, <span class="title class_">Icon</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> logo <span class="keyword">from</span> <span class="string">&#x27;../img/logo.png&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&#x27;../css/pc.css&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PCHeader</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">props</span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>(props);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">state</span> = &#123;</span><br><span class="line">            current : <span class="string">&quot;top&quot;</span>&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">header</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Row</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;2&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;4&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span> <span class="attr">className</span>=<span class="string">&quot;logo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;logo&#125;</span> <span class="attr">alt</span>=<span class="string">&quot;logo&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">span</span>&gt;</span>ReactNews<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Col</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;16&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;<span class="name">Menu</span> <span class="attr">mode</span>=<span class="string">&quot;horizontal&quot;</span> <span class="attr">selectedKeys</span>=<span class="string">&#123;[this.state.current]&#125;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;top&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>头条</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;shehui&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>社会</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;guonei&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>国内</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;guoji&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>国际</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;yule&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>娱乐</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;tiyu&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>体育</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;keji&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>科技</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;<span class="name">Menu.Item</span> <span class="attr">key</span>=<span class="string">&quot;shishang&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                                <span class="tag">&lt;<span class="name">Icon</span> <span class="attr">type</span>=<span class="string">&quot;appstore&quot;</span> /&gt;</span>时尚</span></span><br><span class="line"><span class="language-xml">                            <span class="tag">&lt;/<span class="name">Menu.Item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        <span class="tag">&lt;/<span class="name">Menu</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Col</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;2&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Row</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">PCHeader</span>.<span class="property">propTypes</span> = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">PCHeader</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*pc.css*/</span></span><br><span class="line"><span class="selector-class">.logo</span>&#123;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.logo</span> <span class="selector-tag">img</span>&#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">48px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">48px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.logo</span> <span class="selector-tag">span</span>&#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">24px</span>;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意**：引入图片的时候要用import的方法来引入，不然会找不到图片</p>
<p>menu菜单有两个属性，<code>mode</code>用于控制菜单的水平或者是竖直，<code>selectedKeys</code>用于设置一开始选中的标签</p>
<p><code> mode=&quot;horizontal&quot; selectedKeys=&#123;[this.state.current]&#125;</code></p>
<h3 id="移动端header的开发"><a href="#移动端header的开发" class="headerlink" title="移动端header的开发"></a>移动端header的开发</h3><p>要判断是pc端还是移动端用到一个<code>react-responsive</code>这个库，通过<code>npm install --save react-responsive</code>进行安装</p>
<p>在<code>index.js</code>中进行判断是pc则返回fc端index，是手机则返回手机端index</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Root</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">MediaQuery</span> <span class="attr">query</span>=<span class="string">&quot;(min-device-width: 1224px)&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">PCIndex</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">MediaQuery</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">MediaQuery</span> <span class="attr">query</span>=<span class="string">&quot;(max-device-width: 1224px)&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">MobileIndex</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">MediaQuery</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在mobile header中先放入图标和名称，别的先不动</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="comment">// mobile_header.js</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileHeader</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line"><span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">header</span> <span class="attr">id</span>=<span class="string">&quot;mobileheader&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span> <span class="attr">className</span>=<span class="string">&quot;logo&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&#123;logo&#125;</span> <span class="attr">alt</span>=<span class="string">&quot;logo&quot;</span>/&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>ReactNews<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span></span><br><span class="line">            ）</span><br><span class="line">  &#125;           </span><br></pre></td></tr></table></figure>

<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">html</span>&#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">50px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*mobile.css*/</span></span><br><span class="line"><span class="selector-id">#mobileheader</span>&#123;</span><br><span class="line">    <span class="attribute">flex</span>: <span class="number">1</span>;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">5px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#mobileheader</span>&#123;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">1px</span> solid <span class="number">#2db7f5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#mobileheader</span> <span class="selector-tag">img</span>&#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">50px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#mobileheader</span> <span class="selector-tag">span</span>&#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">35px</span>;</span><br><span class="line">    <span class="attribute">vertical-align</span>: center;</span><br><span class="line">    <span class="attribute">padding-left</span>: <span class="number">10px</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#2db7f5</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mobile及pc的footer开发"><a href="#mobile及pc的footer开发" class="headerlink" title="mobile及pc的footer开发"></a>mobile及pc的footer开发</h3><p>两者内容基本相同，这里贴出一个<code>mobile_footer.js</code></p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">React</span>,&#123;<span class="title class_">Component</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;react&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> &#123;<span class="title class_">Row</span>, <span class="title class_">Col</span>&#125; <span class="keyword">from</span> <span class="string">&#x27;antd&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MobileFooter</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Component</span> &#123;</span><br><span class="line">    <span class="title function_">render</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;<span class="name">Row</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;2&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;20&#125;</span> <span class="attr">className</span>=<span class="string">&quot;footer&quot;</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                        @ 2018 ReactNews. All Rights Reseved.</span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;/<span class="name">Col</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">                    <span class="tag">&lt;<span class="name">Col</span> <span class="attr">span</span>=<span class="string">&#123;2&#125;/</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">                <span class="tag">&lt;/<span class="name">Row</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="title class_">MobileFooter</span>;</span><br></pre></td></tr></table></figure>





]]></content>
      <categories>
        <category>js</category>
        <category>前端</category>
      </categories>
      <tags>
        <tag>js</tag>
        <tag>前端</tag>
      </tags>
  </entry>
  <entry>
    <title>redis知识总结</title>
    <url>/2018/03/24/redis%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="一、Redis"><a href="#一、Redis" class="headerlink" title="一、Redis"></a>一、Redis</h1><h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p><strong>单线程为什么这么快？</strong></p>
<ol>
<li>纯内存</li>
<li>非阻塞IO</li>
<li>避免线程切换和竞争消耗</li>
</ol>
<p><strong>单线程Redis注意事项</strong></p>
<ol>
<li>一次只运行一条命令</li>
<li>拒绝长（慢）命令，例如：keys、flushall、flushdb、slow lua script、mutil&#x2F;exec、operate big value(collection)</li>
<li>Redis其实不是单线程，fysnc file descriptor进行持久化</li>
</ol>
<p><strong>Redis特点</strong></p>
<ol>
<li>速度快</li>
<li>持久化</li>
<li>多钟数据结构</li>
<li>支持多种编程语言</li>
<li>功能丰富</li>
<li>简单</li>
<li>主从复制</li>
<li>高可用，分布式</li>
</ol>
<p><strong>补充知识：同步非同步，阻塞非阻塞</strong></p>
<p><strong>1. 同步和异步关注的是消息通信机制</strong> (synchronous communication&#x2F; asynchronous communication)</p>
<p>所谓同步，就是在发出一个调用时，在没有得到结果之前，该调用就不返回。但是一旦调用返回，就得到返回值了。换句话说，就是由调用者主动等待这个调用的结果。</p>
<p>异步则是相反，调用在发出之后，这个调用就直接返回了，所以没有返回结果。换句话说，当一个异步过程调用发出后，调用者不会立刻得到结果。而是在调用发出后，被调用者通过状态、通知来通知调用者，或通过回调函数处理这个调用。</p>
<p>总结：同步和异步主要关注的是不是调用函数自己返回调用结果，同步是调用者返回调用结果，异步是调用发出后立马返回空值，由回调函数返回调用结果</p>
<p><strong>2.阻塞与非阻塞</strong></p>
<p><strong>阻塞和非阻塞关注的是程序在等待调用结果（消息，返回值）时的状态.</strong></p>
<p>阻塞调用是指调用结果返回之前，当前线程会被挂起。调用线程只有在得到结果之后才会返回。<br>非阻塞调用指在不能立刻得到结果之前，该调用不会阻塞当前线程。</p>
<h2 id="2-应用场景"><a href="#2-应用场景" class="headerlink" title="2. 应用场景"></a>2. 应用场景</h2><p>缓存系统、排行榜、计数器、社交网络、消息队列系统、实时系统</p>
<h2 id="3-数据类型"><a href="#3-数据类型" class="headerlink" title="3. 数据类型"></a>3. 数据类型</h2><p>支持的数据类型：字符串、列表、集合、字典（hash）、有序集合(ZSET)</p>
<h2 id="4-持久化"><a href="#4-持久化" class="headerlink" title="4.持久化"></a>4.持久化</h2><ol>
<li><p>Redis 默认开启RDB持久化方式，在指定的时间间隔内，执行指定次数的写操作，则将内存中的数据写入到磁盘中。</p>
</li>
<li><p>RDB (Redis Database Backup)持久化适合大规模的数据恢复但它的数据一致性和完整性较差。</p>
<p><strong>针对RDB方式的持久化，可以使用：</strong></p>
<ul>
<li>save：会阻塞当前Redis服务器，直到持久化完成，线上应该禁止使用。</li>
<li>bgsave：该触发方式会fork一个子进程，由子进程负责持久化过程，因此阻塞只会发生在fork子进程的时候。</li>
</ul>
<p>  Redis借助了fork命令的copy on write机制。在生成快照时，将当前进程fork出一个子进程，然后在子进程中循环所有的数据，将数据写成为RDB文件。</p>
<p>  另一点需要注意的是，每次快照持久化都是将内存数据完整写入到磁盘一次，并不是增量的只同步脏数据。如果数据量大的话，而且写操作比较多，必然会引起大量的磁盘io操作，可能会严重影响性能。</p>
<p>  而且由于快照方式是在一定间隔时间做一次的，所以如果redis意外down掉的话，就会丢失最后一次快照后的所有修改。如果应用要求不能丢失任何修改的话，必须采用AOF持久化方式。</p>
</li>
<li><p>RDB持久化原理：</p>
</li>
</ol>
<ul>
<li>Redis调用fork()，产生一个子进程。</li>
<li>父进程继续处理client请求，子进程把内存数据写到一个临时的RDB文件。由于os的写时复制机制（copy on write)父子进程会共享相同的物理页面，当父进程处理写请求时os会为父进程要修改的页面创建副本，而不是写共享的页面。所以子进程的地址空间内的数据是fork时刻整个数据库的一个快照。</li>
<li>当子进程将快照写入临时文件完毕后，用临时文件替换原来的快照文件，然后子进程退出</li>
</ul>
<ol start="3">
<li>Redis 需要手动开启AOF(Append Only File)持久化方式，默认是每秒将写操作日志追加到AOF文件中。</li>
<li>AOF 的数据完整性比RDB高，但记录内容多了，会影响数据恢复的效率。</li>
<li>AOF原理：<ul>
<li>redis调用fork ，现在有父子两个进程；</li>
<li>子进程根据内存中的数据库快照，往临时文件中写入重建数据库状态的命令；</li>
<li>父进程继续处理client请求，除了把写命令写入到原来的AOF文件中，同时把收到的写命令缓存起来。这样就能保证如果子进程重写失败的话并不会出问题；</li>
<li>当子进程把快照内容写入已命令方式写到临时文件中后，子进程发信号通知父进程。然后父进程把缓存的写命令也写入到临时文件；</li>
<li>现在父进程可以使用临时文件替换老的AOF文件，并重命名，后面收到的写命令也开始往新的AOF文件中追加。</li>
</ul>
</li>
<li>日志重写<br>  随着写操作的不断增加，AOF文件会越来越大。例如你递增一个计数器100次，那么最终结果就是数据集里的计数器的值为最终的递增结果，但是AOF文件里却会把这100次操作完整的记录下来。而事实上要恢复这个记录，只需要1个命令就行了，也就是说AOF文件里那100条命令其实可以精简为1条。所以Redis支持这样一个功能：在不中断服务的情况下在后台重建AOF文件。<br><strong>工作原理如下：</strong><ul>
<li>Redis调用fork()，产生一个子进程。</li>
<li>子进程把新的AOF写到一个临时文件里。</li>
<li>主进程持续把新的变动写到内存里的buffer，同时也会把这些新的变动写到旧的AOF里，这样即使重写失败也能保证数据的安全。</li>
<li>当子进程完成文件的重写后，主进程会获得一个信号，然后把内存里的buffer追加到子进程生成的那个新AOF里。</li>
</ul>
</li>
</ol>
<h2 id="5-基本指令"><a href="#5-基本指令" class="headerlink" title="5.基本指令"></a>5.基本指令</h2><ol>
<li>string</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set key value [EX seconds] [PX ms] [nx|xx]</span><br></pre></td></tr></table></figure>

<ul>
<li>key: 键名</li>
<li>value: 键值</li>
<li>ex seconds: 键秒级过期时间</li>
<li>ex ms: 键毫秒及过期时间</li>
<li>nx: 键不存在才能设置，setnx和nx选项作用一样，用于添加，分布式锁的实现</li>
<li>xx: 键存在才能设置，setxx和xx选项作用一样，用于更新</li>
</ul>
<ol start="2">
<li><p>list</p>
<p>rpush：右边插入</p>
<p>lrange list-key start end：列出start到end范围的key值</p>
</li>
<li><p>set</p>
<p>sadd set-key item：set插入值</p>
<p>smembers set-key：列出set的key值</p>
<p>sismember set-key item4：查看是否set的member</p>
<p>srem set-key item2：set remove key</p>
</li>
<li><p>hash</p>
<p>hset user name LotusChing：设置user的name为lotus</p>
<p>hset user age 21</p>
<p>hget user name：获取user的name</p>
<p>hkeys user：获取user的key值</p>
<p>hvals user：获取user的键值</p>
<p>hdel user age：删除hash中某个键</p>
<p>hlen user：获取user的键值对个数</p>
<p>hmset user name “LotusChing” age 21 gender “Male”：批量设置key-value</p>
<p>hmget user name age gender：批量获取value</p>
</li>
<li><p>zset</p>
<p>zadd zset-key 728 member1：加入值为728，key为member1的键值对</p>
</li>
</ol>
<h2 id="什么是-RedLock"><a href="#什么是-RedLock" class="headerlink" title="什么是 RedLock"></a>什么是 RedLock</h2><p>Redis 官方站这篇文章提出了一种权威的基于 Redis 实现分布式锁的方式名叫 <em>Redlock</em>，此种方式比原先的单节点的方法更安全。它可以保证以下特性：</p>
<ol>
<li>安全特性：互斥访问，即永远只有一个 client 能拿到锁</li>
<li>避免死锁：最终 client 都可能拿到锁，不会出现死锁的情况，即使原本锁住某资源的 client crash 了或者出现了网络分区</li>
<li>容错性：只要大部分 Redis 节点存活就可以正常提供服务</li>
</ol>
<h3 id="redlock的实现方式"><a href="#redlock的实现方式" class="headerlink" title="redlock的实现方式"></a><strong>redlock的实现方式</strong></h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">set key value nx px</span><br></pre></td></tr></table></figure>

<h2 id="Redlock-算法"><a href="#Redlock-算法" class="headerlink" title="Redlock 算法"></a>Redlock 算法</h2><p>算法很易懂，起 5 个 master 节点，分布在不同的机房尽量保证可用性。为了获得锁，client 会进行如下操作：</p>
<ol>
<li>得到当前的时间，微妙单位</li>
<li>尝试顺序地在 5 个实例上申请锁，当然需要使用相同的 key 和 random value，这里一个 client 需要合理设置与 master 节点沟通的 timeout 大小，避免长时间和一个 fail 了的节点浪费时间</li>
<li>当 client 在大于等于 3 个 master 上成功申请到锁的时候，且它会计算申请锁消耗了多少时间，这部分消耗的时间采用获得锁的当下时间减去第一步获得的时间戳得到，如果锁的持续时长（lock validity time）比流逝的时间多的话，那么锁就真正获取到了。</li>
<li>如果锁申请到了，那么锁真正的 lock validity time 应该是 origin（lock validity time） - 申请锁期间流逝的时间</li>
<li>如果 client 申请锁失败了，那么它就会在少部分申请成功锁的 master 节点上执行释放锁的操作，重置状态</li>
</ol>
<h2 id="放锁"><a href="#放锁" class="headerlink" title="放锁"></a>放锁</h2><p>放锁操作很简单，就是依次释放所有节点上的锁就行了</p>
<h2 id="性能、崩溃恢复和-fsync"><a href="#性能、崩溃恢复和-fsync" class="headerlink" title="性能、崩溃恢复和 fsync"></a>性能、崩溃恢复和 fsync</h2><p>如果我们的节点没有持久化机制，client 从 5 个 master 中的 3 个处获得了锁，然后其中一个重启了，这是注意 <strong>整个环境中又出现了 3 个 master 可供另一个 client 申请同一把锁！</strong> 违反了互斥性。如果我们开启了 AOF 持久化那么情况会稍微好转一些，因为 Redis 的过期机制是语义层面实现的，所以在 server 挂了的时候时间依旧在流逝，重启之后锁状态不会受到污染。但是考虑断电之后呢，AOF部分命令没来得及刷回磁盘直接丢失了，除非我们配置刷回策略为 fsync &#x3D; always，但这会损伤性能。解决这个问题的方法是，当一个节点重启之后，我们规定在 max TTL 期间它是不可用的，这样它就不会干扰原本已经申请到的锁，等到它 crash 前的那部分锁都过期了，环境不存在历史锁了，那么再把这个节点加进来正常工作。</p>
<h4 id="Redlock可靠吗"><a href="#Redlock可靠吗" class="headerlink" title="Redlock可靠吗"></a><strong>Redlock可靠吗</strong></h4><p>不可靠，因为万一多个节点之间的通信延迟，就会出错。可靠的方式是使用zookeeper和fencing token（每次获取锁共享变量+1）。</p>
]]></content>
      <categories>
        <category>工作</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title>requests库详解</title>
    <url>/2017/08/12/requests%E5%BA%93%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p>request库，主要用于网络爬虫</p>
<p>首先通过<code>pip install request</code>安装request库</p>
<p>写一个简单的入门程序，访问以下百度首页：</p>
<span id="more"></span>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">r = requets.get(<span class="string">&#x27;http:://www.baidu.com&#x27;</span>)</span><br><span class="line">r.encoding = <span class="string">&#x27;utf-8&#x27;</span></span><br><span class="line"><span class="built_in">print</span> r.text</span><br><span class="line"><span class="built_in">print</span> r.statuscode</span><br></pre></td></tr></table></figure>

<p>request库一共有7个主要方法</p>
<ul>
<li>requests.request()：构造一个请求</li>
<li>requests.get()：获取网页</li>
<li>requests.head()：获取网页头信息</li>
<li>requests.post()：向网页提交post方法</li>
<li>requests.put()：向网页提交put方法</li>
<li>requests.patch()：向网页提交局部修改请求</li>
<li>requests.delete()：向网页提交删除请求</li>
</ul>
<p>最常见的五个网页response属性：</p>
<ul>
<li>status_code：200表示成功</li>
<li>text：http响应内容的字符串形式</li>
<li>encoding：从http header中猜测的响应内容编码方式</li>
<li>apparent_encoding：从内容解析出的响应内容编码方式（备选编码方式）</li>
<li>r.content：响应内容的二进制形式</li>
</ul>
<p>一般是先判断status_code，如果是200再进行找text和content</p>
<p>requests库可以看做只有一个函数，那就是requests.request（）方法，只是第一个参数分别换为’GET’,’POST’等等。</p>
<p>request参数一共有如下13个字段：</p>
<ol>
<li>params：获取网页的方法</li>
<li>data：字典，字节序列或文件</li>
<li>json</li>
<li>headers参数可以模拟浏览器，</li>
<li>cookies可以从http协议中解析cookie，</li>
<li>auth：提供http认证</li>
<li>timeout指设置的超时时间，proxies设置代理服务器（字典类型）</li>
<li>allow_redirects：是否允许重定向</li>
<li>stream：内容立即下载开关</li>
<li>verify：认证ssl开关</li>
<li>cert：本地存放正数地址</li>
</ol>
<p>基础的网页爬取代码框架：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">  r = requests.get(url, timeout=<span class="number">30</span>)</span><br><span class="line">  r.raise_for_status()</span><br><span class="line">  r.encoding = r.apparent_encoding</span><br><span class="line">  <span class="keyword">return</span> r.text</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">  <span class="keyword">return</span> <span class="string">u&#x27;产生异常&#x27;</span></span><br></pre></td></tr></table></figure>

<p>首先用request.get获取网页内容，同时设置timeout为30，r.raise_for_status()表示如果状态码不为200则报异常，设置encoding方式为apparent_encoding，最后返回r.text</p>
<p>一定要在try，except里面进行，网页访问是常常出错的</p>
<h2 id="使用Beautifulsopu解析网页"><a href="#使用Beautifulsopu解析网页" class="headerlink" title="使用Beautifulsopu解析网页"></a>使用Beautifulsopu解析网页</h2><p>主要是用于网页代码解析，第一个参数指定网页代码，第二个参数指定使用的解析器</p>
<p>一共有4类常用的解析器：分别是’html.parser’，<code>&#39;lxml&#39;</code>要先安装lxml, <code>&#39;xml&#39;</code>要先安装lxml,<code>&#39;html5lib&#39;</code>要先安装html5lib</p>
<p>用法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Beautifulsoup(r.text,<span class="string">&#x27;html.parser&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p>Beautifulsoup的基本元素</p>
<ul>
<li>tag：标签<code>&lt;&gt;&lt;/&gt;</code></li>
<li>name:标签的名字</li>
<li>Attribute：标签的属性，字典形式，格式<code>&lt;tag&gt;.attrs</code></li>
<li>NavigableString：标签内分数性字符串<code>&lt;tag&gt;.attrs</code></li>
<li>Comment：标签内字符串的注释部分</li>
</ul>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-12/96633935.jpg"></p>
<p>一共有3种遍历方式，上行，下行，平行遍历</p>
<ol>
<li><p>下行遍历有3种</p>
<ul>
<li>.contents:子节点的列表，将所有儿子节点存入列表</li>
<li>children：子节点的迭代类型，与.contents类似，用于循环遍历儿子节点</li>
<li>.descendants：子孙节点的迭代烈性，包含所有子孙节点，用于循环遍历</li>
</ul>
</li>
<li><p>上行遍历有2种</p>
<ul>
<li>.parent：节点的父亲标签</li>
<li>.parents：节点先辈标签的迭代类型，用于循环遍历先辈节点</li>
</ul>
<p>上行遍历的代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(demo, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> parent <span class="keyword">in</span> soup.a.parents:</span><br><span class="line">  <span class="keyword">if</span> parent <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="built_in">print</span>(parent)</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(parent.name)</span><br></pre></td></tr></table></figure>
</li>
<li><p>平行遍历有4种</p>
<ul>
<li>.next_sibling：返回按照HTML文本书序的下一个平行节点标签</li>
<li>.previous_sibling：上一个平行节点标签</li>
<li>next_siblings：迭代类型，返回后续所有平行节点标签</li>
<li>previous_siblings：迭代类型，返回前续所有平行节点标签</li>
</ul>
</li>
</ol>
<p>prettyfy方法用于更好地打印标签</p>
<h2 id="数据标记"><a href="#数据标记" class="headerlink" title="数据标记"></a>数据标记</h2><ol>
<li><p>xml：类似于HTML格式</p>
</li>
<li><p>json：JavaScript object notation，用键值对的形式记录数据，比如</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&quot;name&quot; : &quot;xi&#x27;an jiaotong&quot;</span><br><span class="line">&quot;address&quot;: &quot;xi&#x27;an&quot;</span><br><span class="line"># 用大括号表示嵌套的键值对</span><br><span class="line">&quot;university&#123;</span><br><span class="line">   &quot;name&quot;: &quot;jiaotong&quot;,</span><br><span class="line">   &quot;address&quot;:&quot;xi&#x27;an&quot;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>   json的键值对都是有类型的</p>
</li>
<li><p>yaml格式是无类型的，用缩进进行所属，用法：</p>
</li>
</ol>
   <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">uninversity:</span><br><span class="line">name: xi&#x27;an</span><br><span class="line">address: beijing</span><br><span class="line">#用 | 表示整块数据</span><br><span class="line">text: |</span><br><span class="line">这是一大段话xxxxxxxxxxxxxxxxxxxxxxx</span><br><span class="line">xxxxxxxxxxxx</span><br><span class="line">xxxxxxxxx</span><br><span class="line"># 用-表示并列所属关系</span><br><span class="line">name：</span><br><span class="line">-交通大学</span><br><span class="line">-先交大</span><br></pre></td></tr></table></figure>

<h2 id="通过BeautifulSoup数据获取"><a href="#通过BeautifulSoup数据获取" class="headerlink" title="通过BeautifulSoup数据获取"></a>通过BeautifulSoup数据获取</h2><p>   通过find_all函数找到所有的标签，通过.get获得某个具体的属性</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(r.text,<span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> link <span class="keyword">in</span> soup.find_all(<span class="string">&#x27;a&#x27;</span>):</span><br><span class="line">    <span class="built_in">print</span>(link.get(<span class="string">&#x27;href&#x27;</span>))</span><br></pre></td></tr></table></figure>

<p>   如果查找多个标签，可以把标签部分用列表放入<code>soup.find_all([&#39;a&#39;,&#39;b&#39;])</code></p>
<p>   第二个参数可以放属性，比如id&#x3D;link1</p>
<p>   第三个参数是recursive：表示是否对子孙节点进行检索，默认为是</p>
<p>   第四个参数是string，查找某个string，结合正则表达式可以进行搜索</p>
<p>   同样，find_all也有find，find_parent,find_next_sibling之类的方法</p>
<p>   ​</p>
<p>   格式化输出时如果遇到中文不对齐的情况：用chr(12288)作为填充:</p>
   <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#123;0:^10&#125; \t &#123;1:&#123;3&#125;^10&#125; \t &#123;2:&#123;3&#125;^10&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&#x27;排名&#x27;</span>,<span class="string">&#x27;学校名称&#x27;</span>,<span class="string">&#x27;省市&#x27;</span>,<span class="built_in">chr</span>(<span class="number">12288</span>)))</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>request</tag>
      </tags>
  </entry>
  <entry>
    <title>scrapy库详解</title>
    <url>/2017/08/13/scrapy%E5%BA%93%E8%AF%A6%E8%A7%A3/</url>
    <content><![CDATA[<p><code>scrapy</code>是一个完整的爬虫框架，一共有5个部分组成和2个中间部分，最主要的是一下五个部分：</p>
<ol>
<li>ENGINE</li>
<li>SCHEDULER</li>
<li>ITEM PIPELINES</li>
<li>SPIDERS</li>
<li>DOWNLOADER</li>
</ol>
<span id="more"></span>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-14/88536273.jpg"></p>
<p>用户主要编写spider和item pipelines，其余三个模块是事先写好的，不需要修改</p>
<p>可以通过修改downloader middleware中间键来对engine，scheduler和Downloader进行配置</p>
<p>scrapy通过命令行运行</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scrapy command [options] [args]</span><br></pre></td></tr></table></figure>

<p>scrapy有6个常用命令</p>
<ol>
<li><strong>startproject</strong>：创建一个新的工程</li>
<li><strong>genspider</strong>：创建一个爬虫</li>
<li>settings：获得爬虫配置信息</li>
<li><strong>crawl</strong>：运行一个爬虫</li>
<li>list：列出工程中所有爬虫</li>
<li>shell：启动url调试命令行</li>
</ol>
<p>建立一个scrapy工程的方法</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">scrapy startproject python123demo</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-14/62349910.jpg"></p>
<p>建立完成之后可以看到的文件夹下产生了一个名为python123的文件，进入该文件可以看到一个<code>scrapy.cfg</code>的文件，这是一个部署scrapy的配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">│ scrapy.cfg</span><br><span class="line">│</span><br><span class="line">└─python123demo</span><br><span class="line">    │  items.py</span><br><span class="line">    │  middlewares.py</span><br><span class="line">    │  pipelines.py</span><br><span class="line">    │  settings.py</span><br><span class="line">    │  __init__.py</span><br><span class="line">    │</span><br><span class="line">    └─spiders</span><br><span class="line">            __init__.py</span><br></pre></td></tr></table></figure>

<p>文件树目录如下， 在windows中通过<code>tree /F python123demo</code>查看</p>
<p>使用如下命令生成名为demo的爬虫，爬取的网页为python123.io</p>
<p><code>scrapy genspider demo python123.io</code></p>
<p>产生的demo.py如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DemoSpider</span>(scrapy.Spider):</span><br><span class="line">    name = <span class="string">&#x27;demo&#x27;</span></span><br><span class="line">    allowed_domains = [<span class="string">&#x27;python123.io&#x27;</span>]</span><br><span class="line">    start_urls = [<span class="string">&#x27;http://python123.io/&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, response</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>



<p>scrapy的<strong>request</strong>类里面有一下几个方法：</p>
<ol>
<li>.url：request对应的请求url地址</li>
<li>.method：对应的请求方法，’GET’,’POST’等等</li>
<li>.headers：字典类型的请求头</li>
<li>.body：请求内容主体，字符串类型</li>
<li>.meta：用户添加的扩展信息，在scrapy内部模块间传递信息使用</li>
<li>.copy()：复制该请求</li>
</ol>
<p><strong>Rsponse</strong>类7个常用方法：</p>
<ol>
<li>.url：response对应的url地址</li>
<li>.status：状态码，默认是200</li>
<li>.headers：response头部信息</li>
<li>.body:response对应的内容信息，字符串类型</li>
<li>.flags：一组标记</li>
<li>request：产生Response类型对应的request对象</li>
<li>.copy():复制该响应</li>
</ol>
<h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><p>爬取股票数据</p>
<h3 id="步骤一"><a href="#步骤一" class="headerlink" title="步骤一"></a>步骤一</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">scrapy startproject BaiduStocks</span><br><span class="line">cd BaiduStocks</span><br><span class="line">scrapy genspider stocks baidu.com</span><br></pre></td></tr></table></figure>

<h3 id="步骤二"><a href="#步骤二" class="headerlink" title="步骤二"></a>步骤二</h3><p>修改spider文件夹下的stocks.py文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> scrapy</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StocksSpider</span>(scrapy.Spider):</span><br><span class="line">    name = <span class="string">&#x27;stocks&#x27;</span></span><br><span class="line">    start_urls = [<span class="string">&#x27;http://quote.eastmoney.com/stocklist.html&#x27;</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parse</span>(<span class="params">self, response</span>):</span><br><span class="line">        <span class="keyword">for</span> href <span class="keyword">in</span> response.css(<span class="string">&#x27;a::attr(href)&#x27;</span>).extract():</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                stock = re.findall(<span class="string">r&quot;[s][hz]\d&#123;6&#125;&quot;</span>, href)[<span class="number">0</span>]</span><br><span class="line">                url = <span class="string">&#x27;https://gupiao.baidu.com/stock/&#x27;</span> + stock + <span class="string">&#x27;.html&#x27;</span></span><br><span class="line">                <span class="keyword">yield</span> scrapy.Request(url, callback=self.parse_stock)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">parser_stock</span>(<span class="params">self,response</span>):</span><br><span class="line">        infodict = &#123;&#125;</span><br><span class="line">        stockInfo = response.css(<span class="string">&#x27;.stock-bets&#x27;</span>)</span><br><span class="line">        name = stockInfo.css(<span class="string">&#x27;.bets-name&#x27;</span>).extract()[<span class="number">0</span>]</span><br><span class="line">        keyList = stockInfo.css(<span class="string">&#x27;dt&#x27;</span>).extract()</span><br><span class="line">        ValueList = stockInfo.css(<span class="string">&#x27;dd&#x27;</span>).extract()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(keyList)):</span><br><span class="line">            key = re.findall(<span class="string">r&#x27;&gt;.*&lt;/dt&gt;&#x27;</span>,keyList[i])[<span class="number">0</span>][<span class="number">1</span>:-<span class="number">5</span>]</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                val = re.findall(<span class="string">r&#x27;\d+\.?.*&lt;/dd&gt;&#x27;</span>,ValueList[i])[<span class="number">0</span>][<span class="number">0</span>:-<span class="number">5</span>]</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                val = <span class="string">&#x27;--&#x27;</span></span><br><span class="line">            infodict[key] = val</span><br><span class="line">            <span class="comment"># infodict[&#x27;股票名称&#x27;] = name</span></span><br><span class="line">        infoDict.update(</span><br><span class="line">            &#123;<span class="string">&#x27;股票名称&#x27;</span>: re.findall(<span class="string">&#x27;\s.*\(&#x27;</span>, name)[<span class="number">0</span>].split()[<span class="number">0</span>] + \</span><br><span class="line">                        re.findall(<span class="string">&#x27;\&gt;.*\&lt;&#x27;</span>, name)[<span class="number">0</span>][<span class="number">1</span>:-<span class="number">1</span>]&#125;)</span><br><span class="line">        <span class="keyword">yield</span> infodict</span><br></pre></td></tr></table></figure>

<p>通过东方财富网获得stock的代码，然后同过百度股票爬取信息，其中parse和perser_stock函数都通过yield变成生成器</p>
<h3 id="第三步"><a href="#第三步" class="headerlink" title="第三步"></a>第三步</h3><p>更改pipeline.py，用于数据处理，定义一个新的处理数据的类称为BaiduStockInfoPipeline，定义open_spider，close_spider，以及process_item三个函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BaiduStockInfoPipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">open_spider</span>(<span class="params">self,spider</span>):</span><br><span class="line">        self.f = <span class="built_in">open</span>(<span class="string">&#x27;BaiduStockInfo.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self,spider</span>):</span><br><span class="line">        self.f.close()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self,item,spider</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            line = <span class="built_in">str</span>(<span class="built_in">dict</span>(item)) + <span class="string">&#x27;\n&#x27;</span></span><br><span class="line">            self.f.write(line)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<h3 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h3><p>修改settings.py，把ITEM_PIPELINES里面用到的类改为自己定义的BaiduStockInfoPipeline：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;BaiduStocks.pipelines.BaiduStockInfoPipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>






]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>爬虫</tag>
        <tag>scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>scrapy实战伯乐网文章爬虫</title>
    <url>/2017/09/18/scrapy%E5%AE%9E%E6%88%98%E4%BC%AF%E4%B9%90%E7%BD%91%E6%96%87%E7%AB%A0%E7%88%AC%E8%99%AB/</url>
    <content><![CDATA[<h1 id="scrapy实战伯乐网爬虫"><a href="#scrapy实战伯乐网爬虫" class="headerlink" title="scrapy实战伯乐网爬虫"></a>scrapy实战伯乐网爬虫</h1><p>因为我们要对scrapy进行调试，所以我们建立一个main函数来达到调试的目的，以后每次调试只要debug这个main文件就行了</p>
<span id="more"></span>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.cmdline <span class="keyword">import</span> execute</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">sys.path.append(os.path.dirname(os.path.abspath(__file__)))</span><br><span class="line"></span><br><span class="line">execute([<span class="string">&quot;scrapy&quot;</span>, <span class="string">&#x27;crawl&#x27;</span>, <span class="string">&#x27;jobbole&#x27;</span>])</span><br></pre></td></tr></table></figure>

<p>在spider文件夹中初始化爬虫之后，可以看到一个parse函数，这个是用来处理具体的网页内容的，可以用Xpath对网页源码进行解析，其中的<code>response</code>参数表示scrapy返回的网页</p>
<p>我们要爬取所有的文章，就要先找到所有文章的存放地点，我们将<code>class JobboleSpider</code>里面的<code>start_urls</code>改为<code>http://blog.jobbole.com/all-posts/</code>，这个页面存放了所有的posts内容</p>
<p>从第一页开始，每次爬取该页所有posts的链接，进入每一个链接进行处理，要处理一个链接，就是将这个链接<code>yield</code>出来，首先我们先编写在每一页中提取出所有posts的方法，在parse函数中，先找到所有存放posts文件的地方：通过chrome的元素选择快捷键（如下图所示），找到所有的存放posts文件的链接</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">response_nodes = response.css(<span class="string">&#x27;#archive .floated-thumb .post-thumb a&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-10/51186543.jpg"></p>
<p>然后我们在找到的response_nodes中进行循环，并找到其中的首页图片地址和post地址，并将posts地址yield出去，交给<code>scrapy.http.Request</code>处理：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> response_node <span class="keyword">in</span> response_nodes:</span><br><span class="line">    post_url = response_node.css(<span class="string">&#x27;::attr(href)&#x27;</span>).extract_first(default=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    image_url = response_node.css(<span class="string">&#x27;img::attr(src)&#x27;</span>).extract_first(default=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">yield</span> Request(url=post_url, meta=&#123;<span class="string">&#x27;front_image_url&#x27;</span>:image_url&#125;,</span><br><span class="line">                  callback=self.parse_detail)</span><br></pre></td></tr></table></figure>

<p>其中的回调函数是用于具体处理网页内容的函数，meta用于传送首页的图片地址，传送的形式是字典的形式</p>
<p>接下来编写解析下一页的方法：</p>
<p>通过找到下一页这个标签的地址，来进行下一页的访问，首先我们通过css选择器选择出下一页的标签，如果存在下一页，那么我们就将下一页<code>yield</code>到Request来处理，回调函数就是这个函数本身：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#jobbole.py  parse</span></span><br><span class="line">next_page_url = response.css(<span class="string">&#x27;a[class=&quot;next page numbers&quot;]::attr(href)&#x27;</span>).extract_first(default=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> next_page_url:</span><br><span class="line">            <span class="keyword">yield</span> Request(url=next_page_url, callback=self.parse)</span><br></pre></td></tr></table></figure>

<p>接下来完成具体的parse_detail函数，用于具体解析每一页的posts内容的函数：</p>
<p>首先拿出来meta里面的内容，为了防止意外报错，我们使用字典的get函数，并将默认值设置为空</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">front_image_url = response.meta.get(<span class="string">&#x27;front_image_url&#x27;</span>,<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>然后通过css或者是xpath解析器依次解析自己需要的内容</p>
<p>接下来需要通过<code>items.py</code>建立自己的item，这个item就是你最后想要保存下来的数据：</p>
<p>默认系统会自动帮你建立一个跟工程名字一样的类，继承的是<code>scrapy.Item</code>，如果你自己需要一个新的item的话，只需要按照相同的方法，在<code>item.py</code>中新建一个类，继承<code>scrapy.Item</code>，然后把你需要的字段一个个定义出来，定义的方法是<code>字段名 = scrapy.Field()</code>，具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#items.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JobBoleArticleItem</span>(scrapy.Item):</span><br><span class="line">    head = scrapy.Field()</span><br><span class="line">    post_time = scrapy.Field()</span><br><span class="line">    url = scrapy.Field()</span><br><span class="line">    url_id = scrapy.Field()</span><br><span class="line">    front_image_url = scrapy.Field()</span><br><span class="line">    front_image_path = scrapy.Field()</span><br><span class="line">    vote_num = scrapy.Field()</span><br><span class="line">    comment_num = scrapy.Field()</span><br><span class="line">    collection_num = scrapy.Field()</span><br><span class="line">    tags = scrapy.Field()</span><br><span class="line">    content = scrapy.Field()</span><br></pre></td></tr></table></figure>

<p>然后我们需要在爬虫文件中引入定义的item，在<code>parse_detail</code>中实例化item类，并将每一个字段都赋上从网页上解析出来的值，赋值方法是类似于字典的赋值方法：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#jobbole.py</span></span><br><span class="line"><span class="keyword">from</span> ..items <span class="keyword">import</span> JobBoleArticleItem</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_detail</span>():</span><br><span class="line">  article_item = JobBoleArticleItem()</span><br><span class="line">  article_item[<span class="string">&#x27;url&#x27;</span>] = response.url</span><br><span class="line">  article_item[<span class="string">&#x27;head&#x27;</span>] = head</span><br><span class="line">  <span class="keyword">yield</span> article_item</span><br></pre></td></tr></table></figure>

<p>剩余字段的赋值方法跟上面这两个是一样的，最后把item实例yield出来，交给<code>pipelines</code>处理，我们定义了一个专门用于处理图片的pipeline，继承的是<code>scrapy.pipelines.images.ImagesPipeline</code>，重构其中的<code>item_completed</code>函数，参数<code>results</code>中的value表示的是在<code>settings.py</code>中设置的跟<code>image</code>相关的参数，取出其中的<code>path</code>，赋值给<code>item[&#39;front_image_path&#39;]</code>，最后<code>return item</code>即可：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#pipelines.py</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">articleImagePipeline</span>(<span class="title class_ inherited__">ImagesPipeline</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">item_completed</span>(<span class="params">self, results, item, info</span>):</span><br><span class="line">        <span class="keyword">for</span> ok,value <span class="keyword">in</span> results:</span><br><span class="line">            image_file_path = value[<span class="string">&#x27;path&#x27;</span>]</span><br><span class="line">            item[<span class="string">&#x27;front_image_path&#x27;</span>] = os.path.abspath(image_file_path)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>

<p>在<code>settings.py</code>中取消掉<code>ITEM_PIPELINES</code>的注释，并增加新的自己定义的<code>articleImagePipeline</code>，后面的数字表示进入pipelines的顺序，数字越小，越早进入。</p>
<p>此时设置好<code>IMAGES_URLS_FIELD</code>，<code>IMAGES_STORE</code>，这样就可以开始下载图片</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#settings.py</span></span><br><span class="line">ITEM_PIPELINES = &#123;</span><br><span class="line">   <span class="string">&#x27;bole.pipelines.BolePipeline&#x27;</span>: <span class="number">300</span>,</span><br><span class="line">    <span class="comment"># &#x27;scrapy.pipelines.images.ImagesPipeline&#x27;: 1,</span></span><br><span class="line">    <span class="string">&#x27;bole.pipelines.articleImagePipeline&#x27;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">IMAGES_URLS_FIELD = <span class="string">&#x27;front_image_url&#x27;</span></span><br><span class="line">IMAGES_STORE = <span class="string">&#x27;../IMAGES&#x27;</span></span><br></pre></td></tr></table></figure>

<p>最后还有把url进行hash成固定长度的过程，建立一个python包叫做<code>utils</code>，里面建立一个<code>common.py</code>，在其中建立<code>get_md5</code>函数，其中的url要以utf8传入，所以一开始要检测其是不是unicode，python3里面的str就是unicode：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#common.py</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_md5</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(url, <span class="built_in">str</span>):</span><br><span class="line">        url = url.encode(<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    m = hashlib.md5()</span><br><span class="line">    m.update(url)</span><br><span class="line">    <span class="keyword">return</span> m.hexdigest()</span><br></pre></td></tr></table></figure>



<p>接下来解决数据保存的问题，在这里我们使用两种方式，分别是：json文件和mysql数据库保存</p>
<p>I. json的保存</p>
<p>json保存有两种方式，一种是自己写json，一种是利用<code>scrapy.exporter</code>提供的<code>JsonItemExporter</code>类</p>
<p>①自定义<code>json</code>文件，先用codecs打开json文件（这样打开不会有编码错误问题），然后重写<code>process_item</code>方法，将item先dumps为json，其中设置<code>ensure_ascii=False</code>以支持中文，最后写一个close_spider方法，关闭文件</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> codecs, json</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyjsonPipelines</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="comment">#自定义的json导出</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="comment">#打开文件</span></span><br><span class="line">        self.file = codecs.<span class="built_in">open</span>(<span class="string">&#x27;myarticle.json&#x27;</span>, mode=<span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">      <span class="comment">#写入数据</span></span><br><span class="line">        line = json.dumps(<span class="built_in">dict</span>(item),ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        self.file.write(line)</span><br><span class="line">        <span class="keyword">return</span> item</span><br><span class="line">      </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">spider_close</span>(<span class="params">self,spider</span>):</span><br><span class="line">      <span class="comment">#关闭文件</span></span><br><span class="line">        self.file.close()</span><br></pre></td></tr></table></figure>

<p>②利用scrapy提供的<code>JsonItemExporter</code>，先定义打开的文件以及exporter，重写处理数据的方法process_item，最后关闭spider</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.exporters <span class="keyword">import</span> JsonItemExporter</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">jsonPipelines</span>(<span class="title class_ inherited__">JsonItemExporter</span>):</span><br><span class="line">    <span class="comment">#调用scrapy提供的json exporter来导出json文件</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.file = <span class="built_in">open</span>(<span class="string">&#x27;article.json&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">        self.exporter = JsonItemExporter(self.file, encoding=<span class="string">&#x27;utf8&#x27;</span>, ensure_ascii=<span class="literal">False</span>)</span><br><span class="line">        self.exporter.start_exporting()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">close_spider</span>(<span class="params">self</span>):</span><br><span class="line">        self.exporter.finish_exporting()</span><br><span class="line">        self.file.close()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">        self.exporter.export_item(item)</span><br><span class="line">        <span class="keyword">return</span> item</span><br></pre></td></tr></table></figure>



<p>II. 写入mysql</p>
<p>写入MySQL同样有两种方法，第一种是自己写函数同步写入，第二种是利用<code>twisted.enterprise</code>框架提供的<code>adbapi</code>异步写入，第二种写入的方法更快，但也更复杂</p>
<p>①利用MySQLdb，建立连接，数据库部分可以参考之前写的<a href="http://drawon.site/2017/05/11/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/">数据库基础教程</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> MySQLdb</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MysqlPipeline</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">      <span class="comment">#建立连接和cursor</span></span><br><span class="line">        self.conn = MySQLdb.connect(host=<span class="string">&#x27;127.0.0.1&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">                                    database=<span class="string">&#x27;scrapy&#x27;</span>, 			</span><br><span class="line">                                    port=<span class="number">3306</span>,charset=<span class="string">&#x27;utf8&#x27;</span>,use_unicode=<span class="literal">True</span>)</span><br><span class="line">        self.cursor = self.conn.cursor()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">      <span class="comment">#数据插入的sql语句并执行和提交(excecute &amp; commit)</span></span><br><span class="line">        insert_sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            INSERT INTO article (head, post_time, url, url_id) VALUES (%s,%s,%s,%s)</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        self.cursor.execute(insert_sql,(item[<span class="string">&#x27;head&#x27;</span>],item[<span class="string">&#x27;post_time&#x27;</span>],item[<span class="string">&#x27;url&#x27;</span>],item[<span class="string">&#x27;url_id&#x27;</span>]))</span><br><span class="line">        self.conn.commit()</span><br></pre></td></tr></table></figure>

<p>②利用<code>twisted.enterprise</code>提供的<code>adbapi</code>插入数据到mysql，这里用到了一个<code>@classmethod</code>的方法，主要是用于初始化类之前，先进行一个操作的函数，比如在这里我们在初始化<code>twisted_mysql_pipelines</code>之前，先连接了数据库，我们将连接数据库的参数都放在了<code>settings.py</code>里面，要将其取出来要用到<code>def from_settings(cls, settings)</code>，第二个参数是一个字典类型，取值可以通过字典的方法来取。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> twisted.enterprise <span class="keyword">import</span> adbapi</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">twisted_mysql_pipelines</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, dbpool</span>):</span><br><span class="line">        self.dbpool = dbpool</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">from_settings</span>(<span class="params">cls, settings</span>):</span><br><span class="line">      <span class="comment">#连接数据库，返回dbpool</span></span><br><span class="line">        dbparm = <span class="built_in">dict</span>(host=settings[<span class="string">&#x27;MYSQL_HOST&#x27;</span>],</span><br><span class="line">                      user=settings[<span class="string">&#x27;MYSQL_USER&#x27;</span>],</span><br><span class="line">                      password=settings[<span class="string">&#x27;MYSQL_PASSWORD&#x27;</span>],</span><br><span class="line">                      database=settings[<span class="string">&#x27;MYSQL_DBNAME&#x27;</span>],</span><br><span class="line">                      cursorclass = MySQLdb.cursors.DictCursor,</span><br><span class="line">                      charset=<span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">                      use_unicode=<span class="literal">True</span>)</span><br><span class="line">        dbpool = adbapi.ConnectionPool(<span class="string">&#x27;MySQLdb&#x27;</span>, **dbparm)<span class="comment">#建立连接池</span></span><br><span class="line">        <span class="keyword">return</span> cls(dbpool)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">self, item, spider</span>):</span><br><span class="line">        query = self.dbpool.runInteraction(self.do_insert, item)<span class="comment">#开始异步插入数据</span></span><br><span class="line">        query.addErrback(self.error_handler)<span class="comment">#处理异常</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">error_handler</span>(<span class="params">self, error</span>):</span><br><span class="line">      <span class="comment">#异常处理函数</span></span><br><span class="line">        <span class="built_in">print</span>(error)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_insert</span>(<span class="params">self, cursor, item</span>):</span><br><span class="line">      <span class="comment">#插入数据的sql语句</span></span><br><span class="line">        insert_sql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    INSERT INTO article (head, post_time, url, url_id) VALUES (%s,%s,%s,%s)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span></span><br><span class="line">        cursor.execute(insert_sql, (item[<span class="string">&#x27;head&#x27;</span>], item[<span class="string">&#x27;post_time&#x27;</span>], item[<span class="string">&#x27;url&#x27;</span>], item[<span class="string">&#x27;url_id&#x27;</span>]))</span><br></pre></td></tr></table></figure>

<h4 id="itemloader"><a href="#itemloader" class="headerlink" title="itemloader"></a>itemloader</h4><p>之前的item是直接用字典的形式进行赋值的，如果使用itemloader会使得整个css查询过程看起来更加简洁清晰，具体使用方法如下：</p>
<p>①先在<code>item.py</code>中新建一个<code>myItemLoader</code>类，继承<code>scrapy.loader.ItemLoader</code>，修改其默认的输出处理函数为<code>TakeFirst()</code>(因为默认输出时一个列表，所以我们需要从里面取第一个)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">item.py</span><br><span class="line">from scrapy.loader import ItemLoader</span><br><span class="line">from scrapy.loader.processors import TakeFirst</span><br><span class="line">class myItemLoader(ItemLoader):</span><br><span class="line">    default_output_processor = TakeFirst()</span><br></pre></td></tr></table></figure>

<p>②在<code>jobbole.py</code>中的<code>parse_detail</code>函数中实例化item_loader，并使用<code>add_css</code>和<code>add_value</code>方法，分别直接添加值或者是通过css寻找值，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">jobbole.py</span><br><span class="line">from ..items import myItemLoader</span><br><span class="line">from ..items import JobBoleArticleItem</span><br><span class="line">def parse_detail(self,response):</span><br><span class="line">    item_loader = myItemLoader(item=JobBoleArticleItem(),response=response)</span><br><span class="line">    item_loader.add_css(&#x27;head&#x27;, &#x27;.entry-header h1::text&#x27;)</span><br><span class="line">    item_loader.add_value(&#x27;url&#x27;, response.url)</span><br><span class="line">    item_loader.add_value(&#x27;url_id&#x27;, get_md5(response.url))</span><br><span class="line">    item_loader.add_css(&#x27;post_time&#x27;,&#x27;.entry-meta-hide-on-mobile::text&#x27;)</span><br><span class="line">    item_loader.add_css(&#x27;comment_num&#x27;,&#x27;a[href=&quot;#article-comment&quot;] span::text&#x27;)</span><br><span class="line">    item_loader.add_css(&#x27;vote_num&#x27;,&#x27;.vote-post-up h10::text&#x27;)</span><br><span class="line">    item_loader.add_css(&#x27;collection_num&#x27;,&#x27;span.bookmark-btn::text&#x27;)</span><br><span class="line">    item_loader.add_css(&#x27;tags&#x27;,&#x27;p.entry-meta-hide-on-mobile a::text&#x27;)</span><br><span class="line">    front_image_url = response.meta.get(&#x27;front_image_url&#x27;,&#x27;&#x27;)</span><br><span class="line">    item_loader.add_value(&#x27;front_image_url&#x27;,front_image_url)</span><br><span class="line">    article_item = item_loader.load_item()</span><br></pre></td></tr></table></figure>

<p>③此时通过css找出来的是原始的数据，需要在<code>item.py</code>中写处理方法</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">item.py</span><br><span class="line"><span class="keyword">from</span> scrapy.loader.processors <span class="keyword">import</span> MapCompose,TakeFirst,Join</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_time_handle</span>(<span class="params">value</span>):</span><br><span class="line">    time_pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\d&#123;4&#125;/\d&#123;2&#125;/\d&#123;2&#125;&#x27;</span>)</span><br><span class="line">    <span class="keyword">match</span> = re.findall(time_pattern, value.strip())</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="keyword">match</span>)</span><br><span class="line">        post_time = <span class="keyword">match</span>[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">return</span> post_time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_nums</span>(<span class="params">value</span>):</span><br><span class="line">    match_re = re.<span class="keyword">match</span>(<span class="string">&quot;.*?(\d+).*&quot;</span>, value)</span><br><span class="line">    <span class="keyword">if</span> match_re:</span><br><span class="line">        nums = <span class="built_in">int</span>(match_re.group(<span class="number">1</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        nums = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> nums</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">remove_comment_tags</span>(<span class="params">value</span>):</span><br><span class="line">    <span class="comment">#去掉tag中提取的评论</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;评论&quot;</span> <span class="keyword">in</span> value:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>

<p>④修改<code>item.py</code>中<code>JobBoleArticleItem</code>类的<code>input_processor</code>，使其等于<code>MapCompose(function)</code>，其中tags用到的<code>output_processor</code>是<code>scrapy.loader.processors.Join</code>，将各个值用逗号连接起来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">JobBoleArticleItem</span>(scrapy.Item):</span><br><span class="line">    head = scrapy.Field(input_processor = MapCompose(<span class="keyword">lambda</span> x:x+<span class="string">&#x27;jobbole&#x27;</span>))</span><br><span class="line">    post_time = scrapy.Field(input_processor=MapCompose(post_time_handle))</span><br><span class="line">    url = scrapy.Field()</span><br><span class="line">    url_id = scrapy.Field()</span><br><span class="line">    front_image_url = scrapy.Field()</span><br><span class="line">    front_image_path = scrapy.Field()</span><br><span class="line">    vote_num = scrapy.Field(input_processor=MapCompose(get_nums))</span><br><span class="line">    comment_num = scrapy.Field(input_processor=MapCompose(get_nums))</span><br><span class="line">    collection_num = scrapy.Field(input_processor=MapCompose(get_nums))</span><br><span class="line">    tags = scrapy.Field(input_processor=MapCompose(remove_comment_tags),</span><br><span class="line">                        output_processor=Join(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line">    content = scrapy.Field()</span><br><span class="line"></span><br></pre></td></tr></table></figure>









<h2 id="Xpath语法"><a href="#Xpath语法" class="headerlink" title="Xpath语法"></a>Xpath语法</h2><ul>
<li><code>article</code>:选取所有article元素的所有子节点</li>
<li><code>/article</code>：选取根元素article</li>
<li><code>article/a</code>：选取属于article的子元素（只能是子节点，不能是后辈节点）的a元素</li>
<li><code>//div</code>：选取所有div子元素（不论出现在文档任何地方）</li>
<li><code>article//div</code>：选取所有属于article元素后代的div元素</li>
<li><code>//@class</code>：选取所有名为class的属性</li>
<li><code>/article/div[1]</code>：选取属于article子元素的第一个div元素</li>
<li><code>/article/div[last()]</code>：属于article的最后一个div</li>
<li><code>/article/div[last()-1]</code>：倒数第二个</li>
<li><code>//div[@lang]</code>：拥有lang属性的div元素</li>
<li><code>//div[@lang=&#39;eng&#39;]</code>：选取所有lang属性为eng的div元素</li>
<li><code>/div/*</code>：div元素的所有子节点</li>
<li><code>//*</code>：选取所有元素</li>
<li><code>//div[@*]</code>：所有带有属性的div元素</li>
<li><code>/div/a | //div/p</code>：所有div元素的a或p元素</li>
<li><code>//sapn | //ul</code>：所有文档中的span和ul元素</li>
<li><code>article/div/p | //span</code>：所有属于article元素的div元素的p元素以及文档中所有span元素</li>
</ul>
<p>用xpath进行提取的方法类似于beautifulsoup，但是xpath的提取速度更快，提取的例子如下：</p>
<p>1、我要提取页面中的title信息，通过F12打开网页控制，点击选择元素，点中需要爬取的部分，可以找到他的源码，右键复制xpath或者是自己写xpath进行爬取(要爬取内容的话在xpath后面要加上&#x2F;xpath)，之后通过extract()提取为列表，选择第[0]个元素，但是此时有可能列表为空，<strong>所以使用<code>extract_first(default=0)</code>，表示提取第一个元素如果为空则返回0</strong>，写法如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">head_selector = response.xpath(<span class="string">&#x27;//*[@class=&quot;entry-header&quot;]/h1/text()&#x27;</span>)</span><br><span class="line">head = head_selector.extract()[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">post_time_selector = response.xpath(<span class="string">&#x27;//p[@class=&quot;entry-meta-hide-on-mobile&quot;]/text()&#x27;</span>)</span><br><span class="line">time_pattern = re.<span class="built_in">compile</span>(<span class="string">r&#x27;\d&#123;4&#125;/\d&#123;2&#125;/\d&#123;2&#125;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F;*：表示选取所有的任意元素</p>
<p>&#x2F;&#x2F;p：选取所有的p元素</p>
<p>&#x2F;&#x2F;p[@class&#x3D;”dd”]：表示选取所有类为dd的p标签</p>
<p>&#x2F;&#x2F;p[contains(@class,”dd”)]：选取类名包含dd的p元素</p>
<h3 id="CSS选择器"><a href="#CSS选择器" class="headerlink" title="CSS选择器"></a>CSS选择器</h3><ul>
<li><code>*</code>：选择所有节点</li>
<li><code>#container</code>：选择id为container的节点</li>
<li><code>.container</code>：选取所有class中包含container的节点 </li>
<li><code>li a</code>：选取所有li下面的所有a节点</li>
<li><code>ul + p</code>：选取ul后面的第一个p元素</li>
<li><code>div#container &gt; ul </code>：选取id为container的div的第一个ul子元素 </li>
<li><code>ul ~ p</code>：选取与ul相邻的所有p元素</li>
<li><code>a[title]</code>：选择所有有title属性的a元素</li>
<li><code>a[href=&quot;http://jobbole.com&quot;]</code>：选取所有href属性为<code>http://jobbole.com</code>的a元素</li>
<li><code>a[href*=&quot;jobbole&quot;]</code>：选取所有href属性包含jobbole的a元素</li>
<li><code>a[href^=&quot;http&quot;]</code>：选取所有href以http开头的a元素</li>
<li><code>a[href$=&quot;.jpg&quot;]</code>：选取所有href以.jpg结尾的a元素</li>
<li><code>input[type=radio]:checked</code>：选择选中的radio元素</li>
<li><code>div:not(#container)</code>：选择id不是container的div属性</li>
<li><code>li:nth-child(3)</code>：选取第三个li元素</li>
<li><code>tr:nth-child(2n)</code>：选择第偶数个tr</li>
</ul>
<p>pycharm单步调试的快捷键是<code>F8</code></p>
]]></content>
      <categories>
        <category>编程练习</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>scrapy爬取知乎问题实战</title>
    <url>/2017/09/18/scrapy%E7%88%AC%E5%8F%96%E7%9F%A5%E4%B9%8E%E9%97%AE%E9%A2%98%E5%AE%9E%E6%88%98/</url>
    <content><![CDATA[<p>首先,需要理解cookies的含义，是存储在浏览器中的内容，在本地存储任意键值对，第一次访问时服务器返回一个id存储到本地cookie中，第二次访问将cookies一起发送到服务器中</p>
<span id="more"></span>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-18/23468729.jpg"></p>
<p>常见http状态码</p>
<table>
<thead>
<tr>
<th>code</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>200</td>
<td>请求成功</td>
</tr>
<tr>
<td>301&#x2F;302</td>
<td>永久重定向&#x2F;临时重定向</td>
</tr>
<tr>
<td>403</td>
<td>没有权限访问</td>
</tr>
<tr>
<td>404</td>
<td>没有对应的资源</td>
</tr>
<tr>
<td>500</td>
<td>服务器错误</td>
</tr>
<tr>
<td>503</td>
<td>服务器停机或正在维护</td>
</tr>
</tbody></table>
<p> 要爬取知乎内容首先需要进行登录，在本文中我们主要介绍2种登录方式，第一种是通过requests的session保存cookies进行登录，第二种是通过<code>scrapy</code>修改<code>start_requests</code>函数进行登录</p>
<h2 id="requests进行登录"><a href="#requests进行登录" class="headerlink" title="requests进行登录"></a>requests进行登录</h2><p>在utils中新建<code>zhihu_login.py</code>，实例化一个session对象，设置其cookies对象为<code>cookiesjar</code>库中的<code>LWPCookieJar</code>对象，设置requests库需要用到的headrs（从浏览器中进行拷贝），</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">session = requests.session()</span><br><span class="line">session.cookies = cookiejar.LWPCookieJar(filename=<span class="string">&#x27;zhihu_cookies.txt&#x27;</span>)</span><br><span class="line">headers = &#123;</span><br><span class="line">        <span class="string">&#x27;User-Agent&#x27;</span>:<span class="string">&#x27;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/60.0.3112.113 Safari/537.36&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Origin&#x27;</span>:<span class="string">&#x27;https://www.zhihu.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Accept-Language&#x27;</span>:<span class="string">&#x27;zh-CN,zh;q=0.8,en;q=0.6&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Host&#x27;</span>:<span class="string">&#x27;www.zhihu.com&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;Referer&#x27;</span>:<span class="string">&#x27;https://www.zhihu.com/&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们要寻找登录发送数据的页面，首先打开<code>zhihu.com</code>退出之前的登录，来到一个登录页面，在登陆页面中使用手机号码登录，此时需要<strong>发送一个错误的信息给页面</strong>，以找到post数据的网页（如果输入正确的账号密码就直接登录成功了，一大堆网页请求就找不到我们需要的网页了）</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-19/72348150.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-9-19/12704910.jpg"></p>
<p>找到了需要post的网页，发现post的数据有<code>_xsrf</code>,<code>passoword</code>,<code>phone_num</code>，另外一个<code>captcha_type</code>没有用，加了之后反而无法访问（不知道为什么）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">zhihu_login</span>(<span class="params">account, password</span>):</span><br><span class="line">    <span class="keyword">if</span> re.<span class="keyword">match</span>(<span class="string">&#x27;1\d&#123;10&#125;&#x27;</span>, account):</span><br><span class="line">        phone_post_url = <span class="string">&#x27;https://www.zhihu.com/login/phone_num&#x27;</span></span><br><span class="line">        post_data=&#123;</span><br><span class="line">            <span class="string">&#x27;_xsrf&#x27;</span>:get_xsrf(),</span><br><span class="line">            <span class="string">&#x27;phone_num&#x27;</span>:account,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>:password,</span><br><span class="line">            <span class="comment"># &#x27;captcha_type&#x27;:&#x27;cn&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># session_response = session.post(phone_post_url, data=post_data, headers=header)</span></span><br><span class="line">        <span class="comment"># print(session_response.text)</span></span><br><span class="line">        <span class="comment"># result_list = re.findall(&#x27;&quot;msg&quot;: &quot;(.*?)&quot;&#x27;,session_response.text)[0]</span></span><br><span class="line">        <span class="comment"># print(result_list.encode(&#x27;utf8&#x27;).decode(&#x27;unicode-escape&#x27;))</span></span><br><span class="line">        <span class="comment"># try:</span></span><br><span class="line">        <span class="comment">#     login_page = session.post(phone_post_url, data=post_data, headers=headers)</span></span><br><span class="line">        <span class="comment">#     print(&#x27;不要验证码,login_code:&#123;&#125;&#x27;.format(login_page.status_code))</span></span><br><span class="line">        <span class="comment"># except:</span></span><br><span class="line">        post_data[<span class="string">&#x27;captcha&#x27;</span>] = get_captcha()</span><br><span class="line">        login_page = session.post(phone_post_url, data=post_data, headers=headers)</span><br><span class="line">        result_list = re.findall(<span class="string">&#x27;&quot;msg&quot;: &quot;(.*?)&quot;&#x27;</span>, login_page.text)[<span class="number">0</span>]</span><br><span class="line">        <span class="built_in">print</span>(result_list.encode(<span class="string">&#x27;utf8&#x27;</span>).decode(<span class="string">&#x27;unicode-escape&#x27;</span>))</span><br><span class="line">        session.cookies.save()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;保存成功&#x27;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这里我们一开始没有使用验证码，发现只要是爬虫登录都会被识别到，所以我们编写了一个用于生成验证码的代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_captcha</span>():</span><br><span class="line">    t = <span class="built_in">str</span>(<span class="built_in">int</span>(time.time()*<span class="number">1000</span>))</span><br><span class="line">    captcha_url = <span class="string">&#x27;https://www.zhihu.com/captcha.gif?r=&#x27;</span> + t + <span class="string">&quot;&amp;type=login&quot;</span></span><br><span class="line">    r = session.get(captcha_url, headers=headers)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;captcha.jpg&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(r.content)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        im = Image.<span class="built_in">open</span>(<span class="string">&#x27;captcha.jpg&#x27;</span>)</span><br><span class="line">        im.show()</span><br><span class="line">        im.close()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;wrong&#x27;</span>)</span><br><span class="line">    captcha = <span class="built_in">input</span>(<span class="string">&#x27;请输入验证码:&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> captcha</span><br></pre></td></tr></table></figure>

<p>保存完cookies，我们尝试使用这个cookies再次登录</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_again</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        session.cookies.load(ignore_discard=<span class="literal">True</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;cookies加载成功\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;cookies加载失败&#x27;</span>)</span><br><span class="line">    response = session.get(<span class="string">&#x27;https://www.zhihu.com&#x27;</span>,headers=headers)</span><br><span class="line">    <span class="comment"># response.encoding = response.apparent_encoding</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;my_zhihu_login.html&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(response.text.encode(<span class="string">&#x27;utf8&#x27;</span>))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;保存页面成功&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>查看这个页面发现不停地刷新，暂时还没有找到办法</p>
<h3 id="scrapy模拟登陆知乎"><a href="#scrapy模拟登陆知乎" class="headerlink" title="scrapy模拟登陆知乎"></a>scrapy模拟登陆知乎</h3><p>首先生成一个新的spider，名字为zhihu</p>
<p>在class zhihu中定义headers等信息，重写<code>start_requests</code>函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">start_requests</span>(<span class="params">self</span>):</span><br><span class="line">     <span class="keyword">return</span> [scrapy.Request(<span class="string">&#x27;https://www.zhihu.com/#signin&#x27;</span>,headers=self.headers, callback=self.login)]</span><br></pre></td></tr></table></figure>

<p>在<code>start_requests</code>里面返回一个新的Request，其回调函数设置为一个新的login函数如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">login</span>(<span class="params">self,response</span>):</span><br><span class="line">  <span class="comment"># print(response.text)</span></span><br><span class="line">  <span class="comment"># a = &#x27;&lt;input type=&quot;hidden&quot; name=&quot;_xsrf&quot; value=&quot;36424865b408db8c3f976a1a676cad60&quot;/&gt;&#x27;</span></span><br><span class="line">  match_obj = re.<span class="keyword">match</span>(<span class="string">&#x27;.*name=&quot;_xsrf&quot; value=&quot;(.*?)&quot;&#x27;</span>, response.text, re.DOTALL)</span><br><span class="line">  <span class="keyword">if</span> match_obj:</span><br><span class="line">    _xsrf = match_obj.group(<span class="number">1</span>)</span><br><span class="line">    post_data = &#123;</span><br><span class="line">      <span class="string">&#x27;_xsrf&#x27;</span>: _xsrf,</span><br><span class="line">      <span class="string">&#x27;phone_num&#x27;</span>: <span class="string">&#x27;xxxxxxxxxxx&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;password&#x27;</span>: <span class="string">&#x27;xxxxxxx&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;captcha&#x27;</span>:<span class="string">&#x27;&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    t = <span class="built_in">str</span>(<span class="built_in">int</span>(time.time() * <span class="number">1000</span>))</span><br><span class="line">    captcha_url = <span class="string">&#x27;https://www.zhihu.com/captcha.gif?r=&#x27;</span> + t + <span class="string">&quot;&amp;type=login&quot;</span></span><br><span class="line">    <span class="keyword">return</span> [scrapy.Request(url=captcha_url,</span><br><span class="line">                           meta=&#123;<span class="string">&#x27;post_data&#x27;</span>:post_data&#125;,</span><br><span class="line">                           headers=self.headers,</span><br><span class="line">                           callback=self.get_captcha_login)]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">raise</span> EOFError</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程练习</category>
        <category>爬虫</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>爬虫</tag>
        <tag>scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title>selenium 爬取ajax动态网页</title>
    <url>/2018/04/16/selenium-%E7%88%AC%E5%8F%96ajax%E5%8A%A8%E6%80%81%E7%BD%91%E9%A1%B5/</url>
    <content><![CDATA[<p>最近有一个爬取教育部数据库的任务，一开始用了requests库，能获取到网页验证码什么的，但是各种的ajax动态加载太麻烦了，最后想到了用selenium进行爬取</p>
<p>初始化webdriver，用chrome进行爬取，此时需要下载chrome的驱动，<a href="http://chromedriver.storage.googleapis.com/index.html">下载地址</a></p>
<span id="more"></span>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">url1 = <span class="string">&#x27;https://isisn.nsfc.gov.cn/egrantindex/funcindex/prjsearch-list&#x27;</span></span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> WebDriverWait</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.by <span class="keyword">import</span> By</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support <span class="keyword">import</span> expected_conditions <span class="keyword">as</span> EC</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.common.keys <span class="keyword">import</span> Keys</span><br><span class="line"><span class="keyword">from</span> selenium.webdriver.support.ui <span class="keyword">import</span> Select</span><br><span class="line"></span><br><span class="line">browser = webdriver.Chrome()</span><br><span class="line">browser.get(url1)</span><br></pre></td></tr></table></figure>

<p>接下来填充网页内容，因为有ajax动态加载的部分，我们填入一部分之后需要等待一会，用time.sleep(0.5)等0.5秒就行了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">browser.find_element_by_name(<span class="string">&#x27;subjectCode&#x27;</span>).click()</span><br><span class="line">browser.find_element_by_name(<span class="string">&#x27;subjectCode&#x27;</span>).send_keys(<span class="string">&#x27;F030203&#x27;</span>)</span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">browser.find_element_by_name(<span class="string">&#x27;subjectCode&#x27;</span>).send_keys(Keys.RETURN)</span><br></pre></td></tr></table></figure>

<p>然后对下拉选择的内容用Select对象进行选择</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s1 = Select(browser.find_element_by_id(<span class="string">&#x27;f_grantCode&#x27;</span>))</span><br><span class="line">s1.select_by_index(<span class="number">1</span>)</span><br><span class="line">s2 = Select(browser.find_element_by_id(<span class="string">&#x27;f_year&#x27;</span>))</span><br><span class="line">s2.select_by_value(<span class="string">&#x27;2017&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>用pytesseract进行验证码识别，在安装pytesseract之后，还要安装Tesseract-OCR这个程序，在安装完成之后，只需要    一句<code>code = pytesseract.image_to_string(im)</code>就可以进行验证码识别，这样识别的精度并不高，因此我们需要用try ，except来catch意外</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pytesseract</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_captcha</span>(<span class="params">browser</span>):</span><br><span class="line">    browser.get_screenshot_as_file(<span class="string">&#x27;screenshot.jpg&#x27;</span>)</span><br><span class="line">    element = browser.find_element_by_id(<span class="string">&#x27;img_checkcode&#x27;</span>)</span><br><span class="line">    left = <span class="built_in">int</span>(element.location[<span class="string">&#x27;x&#x27;</span>])</span><br><span class="line">    top = <span class="built_in">int</span>(element.location[<span class="string">&#x27;y&#x27;</span>])</span><br><span class="line">    right = <span class="built_in">int</span>(element.location[<span class="string">&#x27;x&#x27;</span>] + element.size[<span class="string">&#x27;width&#x27;</span>])</span><br><span class="line">    bottom = <span class="built_in">int</span>(element.location[<span class="string">&#x27;y&#x27;</span>] + element.size[<span class="string">&#x27;height&#x27;</span>])</span><br><span class="line">    im = Image.<span class="built_in">open</span>(<span class="string">&#x27;screenshot.jpg&#x27;</span>)</span><br><span class="line">    im = im.crop((left, top, right, bottom))</span><br><span class="line">    im.save(<span class="string">&#x27;screenshot.jpg&#x27;</span>)</span><br><span class="line">    im = Image.<span class="built_in">open</span>(<span class="string">&#x27;screenshot.jpg&#x27;</span>)</span><br><span class="line">    pytesseract.pytesseract.tesseract_cmd = <span class="string">&#x27;C:\\Program Files (x86)\\Tesseract-OCR\\tesseract&#x27;</span></span><br><span class="line">    code = pytesseract.image_to_string(im)</span><br><span class="line">    <span class="keyword">return</span> code</span><br></pre></td></tr></table></figure>

<p>输入验证码，并保存网页。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">code = get_captcha(browser)</span><br><span class="line"><span class="built_in">print</span>(code)</span><br><span class="line">browser.find_element_by_id(<span class="string">&#x27;f_checkcode&#x27;</span>).send_keys(code)</span><br><span class="line">browser.find_element_by_id(<span class="string">&#x27;searchBt&#x27;</span>).click()</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;my.html&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(browser.page_source)</span><br></pre></td></tr></table></figure>

<p>如果验证失败，一直输入直到成功</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> browser.find_element_by_id(<span class="string">&#x27;f_checkcode&#x27;</span>):</span><br><span class="line">            code = get_captcha(browser)</span><br><span class="line">            browser.find_element_by_id(<span class="string">&#x27;f_checkcode&#x27;</span>).clear()</span><br><span class="line">            browser.find_element_by_id(<span class="string">&#x27;f_checkcode&#x27;</span>).send_keys(code)</span><br><span class="line">            browser.find_element_by_id(<span class="string">&#x27;searchBt&#x27;</span>).click()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>进入搜索结果之后需要点击下一页，直到最后一页，此时用到的方法就是通过看next button上面的class，直到class变成disable就可以停止了，用正则表达式，正则表达式搜不到的时候返回是None，但是好像返回的是字符串类型的None，判断是应该是 while re.search(xxx) is None</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">click_next_page</span>():</span><br><span class="line">    code = get_captcha(browser)</span><br><span class="line">    browser.find_element_by_id(<span class="string">&#x27;checkCode&#x27;</span>).send_keys(code)</span><br><span class="line">    browser.find_element_by_css_selector(<span class="string">&#x27;.ui-icon.ui-icon-seek-next&#x27;</span>).click()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> re.search(<span class="string">&#x27;ui-state-disabled&#x27;</span>,browser.find_element_by_id(<span class="string">&#x27;next_t_TopBarMnt&#x27;</span>).get_attribute(<span class="string">&quot;class&quot;</span>)) <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    click_next_page()</span><br></pre></td></tr></table></figure>

<p>然后把所有网页的内容用beautifulsoup进行解析就行了 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">soup = BeautifulSoup(browser.page_source,<span class="string">&#x27;lxml&#x27;</span>)</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程练习</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>爬虫</tag>
      </tags>
  </entry>
  <entry>
    <title>springboot热部署</title>
    <url>/2019/04/24/springboot%E7%83%AD%E9%83%A8%E7%BD%B2/</url>
    <content><![CDATA[<p>spring-boot-devtools是一个专门用于springboot热部署的插件</p>
<h2 id="devtools原理"><a href="#devtools原理" class="headerlink" title="devtools原理"></a>devtools原理</h2><p>深层原理是使用了两个ClassLoader，一个Classloader加载那些不会改变的类（第三方Jar包），另一个ClassLoader加载会更改的类，称为restart ClassLoader,这样在有代码更改的时候，原来的restart ClassLoader 被丢弃，重新创建一个restart ClassLoader，由于需要加载的类相比较少，所以实现了较快的重启时间。</p>
<span id="more"></span>

<p>总的来说，一共需要两个步骤：<br>第一步：</p>
<p>先设置我们的pom.xml文件，加入依赖，首先是把下面代码在<code>&lt;dependencies&gt;</code>中</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--添加热部署--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>true<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>另外下面的代码是放在<code>&lt;build&gt;  </code>下面<code>&lt;plugins&gt;</code>里的</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--热部署配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--fork:如果没有该项配置,整个devtools不会起作用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">fork</span>&gt;</span>true<span class="tag">&lt;/<span class="name">fork</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>第二步：</p>
<p>设置IDEA的自动编译：<br>（1）File-Settings-Compiler勾选 Build Project automatically</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190424173336.png"></p>
<p>（2）快捷键 ctrl + shift + alt + &#x2F;,选择Registry,勾上 Compiler autoMake allow when app running</p>
<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190424173533.png" width="500px"/>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190424173459.png"></p>
<p>这样我们的热部署就完成了，可以再我们的项目中修改返回值，或者修改Mapping的value值后，在我们的页面中刷新试试。(注意，可能要重启项目才能生效)</p>
]]></content>
      <categories>
        <category>spirng</category>
      </categories>
      <tags>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring实战读书笔记</title>
    <url>/2019/04/10/spring%E5%AE%9E%E6%88%98%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>曾经流行的框架名称是<code>SSH</code>，由Spring，spring MVC，hibernate组成</p>
<p>后来逐渐切换到<code>SSM</code>，由Spring，Spring MVC，MyBatis组成</p>
<p>再到现在流行的框架已经变成SpringBoot和MyBatis组成了</p>
<span id="more"></span>

<h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><p>Maven是一个构建项目的工具，他的主要思想是通过配置一个pom.xml文件（project object model），一键式迁移java环境，不管在哪个环境中，只要拿到这个pom.xml，相关依赖就可以一键下载部署。</p>
<p>因为之前对spring了解不多，先看看《spring 实战》这本书</p>
<h3 id="spring基本概念"><a href="#spring基本概念" class="headerlink" title="spring基本概念"></a>spring基本概念</h3><p>bean是spring的基本应用组件，spring最核心的内容就是IOC（DI）与AOP</p>
<p>我们考虑一下DI是怎么实现的。先看一个例子DamselRescuingKnight，实现的Knight接口，有个私有变量quest表示他能干的事情，比如拯救女子，或者是屠杀恶龙，如果你将quest写死为RescueDamselQuest，那么DamselRescuingKnight和RescueDamselQuest的耦合程度就太大了，这样不利于代码的修改和复用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.knights;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DamselRescuingKnight</span> <span class="keyword">implements</span> <span class="title class_">Knight</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> RescueDamselQuest quest;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DamselRescuingKnight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.quest = <span class="keyword">new</span> <span class="title class_">RescueDamselQuest</span>(); <span class="comment">//与RescueDamselQuest紧耦合</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">embarkOnQuest</span><span class="params">()</span> &#123;</span><br><span class="line">        quest.emark();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所谓的耦合就是互相依赖，如果一个类里面完全依赖另外一个类，需要改动的时候，那么要改动的地方可能就很多，所以spring的第一个好处是依赖注入，减少代码耦合。</p>
<p>第一个注入方式，是通过构造器注入，就是在构造器中传入参数，那么这个quest就可以是任何类型的quest了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.knights;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BraveKnight</span> <span class="keyword">implements</span> <span class="title class_">Knight</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Quest quest;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BraveKnight</span><span class="params">(Quest quest)</span> &#123; <span class="comment">// Quest实例被注入</span></span><br><span class="line">        <span class="built_in">this</span>.quest = quest;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">embarkOnQuest</span><span class="params">()</span> &#123;</span><br><span class="line">        quest.emark();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二个注入方式就是Spring当中常用的，叫做装配(创建应用组件之间写作的行为称为装配)，就是用xml的方式来配置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.knights;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SlayDragonQuest</span> <span class="keyword">implements</span> <span class="title class_">Quest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> PrintStream stream;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SlayDragonQuest</span><span class="params">(PrintStream stream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stream = stream;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">emark</span><span class="params">()</span> &#123;</span><br><span class="line">        stream.println(<span class="string">&quot;Embarking on quest to slay the dragon!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>装配的xml文件如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;knight&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.sample.knights.BraveKnight&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;quest&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;quest&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.sample.knights.SlayDragonQuest&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(System).out&#125;&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>Spring 3.0引入了JavaConfig，这种写法比xml文件的好处是具备类型安全检查，例如，上面XML配置文件可以这么写：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.knights.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.spring.sample.knights.BraveKnight;</span><br><span class="line"><span class="keyword">import</span> com.spring.sample.knights.Knight;</span><br><span class="line"><span class="keyword">import</span> com.spring.sample.knights.Quest;</span><br><span class="line"><span class="keyword">import</span> com.spring.sample.knights.SlayDragonQuest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KnightConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Knight <span class="title function_">knight</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BraveKnight</span>(quest());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Quest <span class="title function_">quest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SlayDragonQuest</span>(System.out);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不论是基于XML的配置还是基于Java文件的配置，都由Spring框架负责管理beans之间的依赖关系。</p>
<h4 id="启动依赖注入"><a href="#启动依赖注入" class="headerlink" title="启动依赖注入"></a>启动依赖注入</h4><p>在Spring应用中，由<em>application context</em>负责加载beans，并将这些beans根据配置文件编织在一起。Spring框架提供了几种application context的实现：</p>
<ol>
<li>如果使用XML格式的配置文件，则使用<code>ClassPathXmlApplicationContext</code>；</li>
<li>如果使用Java文件形式的配置文件，则使用<code>AnnotationConfigApplicationContext</code>。</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.knights;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.spring.sample.knights.config.KnightConfig;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.AnnotationConfigApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KnightMain</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"><span class="comment">//        ClassPathXmlApplicationContext context =</span></span><br><span class="line"><span class="comment">//                new ClassPathXmlApplicationContext(&quot;classpath:/knight.xml&quot;);</span></span><br><span class="line">        <span class="type">AnnotationConfigApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(KnightConfig.class);</span><br><span class="line">        <span class="type">Knight</span> <span class="variable">knight</span> <span class="operator">=</span> context.getBean(Knight.class);</span><br><span class="line">        knight.embarkOnQuest();</span><br><span class="line">        context.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中，根据<code>KnightConfig.java</code>文件创建Spring应用上下文，可以把该应用上下文看成对象工厂，来获取idknight的bean。</p>
<h4 id="1-1-3-切面编程"><a href="#1-1-3-切面编程" class="headerlink" title="1.1.3 切面编程"></a>1.1.3 切面编程</h4><p>依赖注入（DI）实现了模块之间的松耦合，而利用面向切面编程（AOP）可以将涉及整个应用的基础功能（安全、日志）放在一个可复用的模块中。</p>
<p>AOP是一种在软件系统中实现关注点分离的技术。软件系统由几个模块构成，每个模块负责一种功能，不过在系统中有些需求需要涉及到所有的模块，例如日志、事务管理和安全等。如果将这些需求相关的代码都分散在各个模块中，一方面是不方便维护、另一方面是与原来每个模块的业务逻辑代码混淆在一起，不符合单一职责原则。</p>
<ul>
<li>实现系统级别处理的代码分散在多个子模块中，这意味着如果要修改这些处理代码，则要在每个模块中都进行修改。即使将这些代码封装到一个模块中，在没给个子模块中只保留对方法的调用，这些方法调用还是在各个模块中重复出现。</li>
<li>业务逻辑代码与非核心功能的代码混淆在一起。例如，一个添加address book的方法应该只关心如何添加address book，而不应该关心该操作是否安全或者是否能够实现事务处理。</li>
</ul>
<p>下面这张图可以体现这种复杂性，左边的业务逻辑模块与右边的系统服务模块沟通太过密切，每个业务模块需要自己负责调用这些系统服务模块。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190422105019.png"></p>
<p>AOP可以模块化这些系统服务，然后利用声明式编程定义该模块需要应用到那些业务逻辑模块上。这使得业务模块更简洁，更专注于处理业务逻辑，简而言之，切面（aspects）确保POJO仍然是普通的Java类。</p>
<p>可以将切面想象为覆盖在一些业务模块上的毯子，如下图所示。在系统中有一些模块负责核心的业务逻辑，利用AOP可以为所有这些模块增加额外的功能，而且核心业务模块无需知道切面模块的存在。</p>
<p>![image-20190422105135247](&#x2F;Users&#x2F;apple&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20190422105135247.png)</p>
<h4 id="AOP实践"><a href="#AOP实践" class="headerlink" title="AOP实践"></a>AOP实践</h4><p>继续上面的例子，如果需要一个人记录<em>BraveKnight</em>的所作所为，下面代码是该日志服务：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.knights;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.PrintStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Minstrel</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> PrintStream stream;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Minstrel</span><span class="params">(PrintStream stream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.stream = stream;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">singBeforeQuest</span><span class="params">()</span> &#123;</span><br><span class="line">        stream.println(<span class="string">&quot;Fa la la, the knight is so brave!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">singAfterQuest</span><span class="params">()</span> &#123;</span><br><span class="line">        stream.println(<span class="string">&quot;Tee hee hee, the brave knight did embark on a quest!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在XML文件中定义Minstrel对应的切面：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance xmlns:aop=&quot;</span><span class="attr">http:</span>//<span class="attr">www.springframework.org</span>/<span class="attr">schema</span>/<span class="attr">aop</span>&quot;</span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;knight&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.sample.knights.BraveKnight&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;quest&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;quest&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.sample.knights.SlayDragonQuest&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(System).out&#125;&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;minstrel&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.spring.sample.knights.Minstrel&quot;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;#&#123;T(System).out&#125;&quot;</span> /&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">ref</span>=<span class="string">&quot;minstrel&quot;</span>&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;embark&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* *.embarkOnQuest(..))&quot;</span>/&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">&quot;singBeforeQuest&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;embark&quot;</span> /&gt;</span></span><br><span class="line">                     <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">&quot;singAfterQuest&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;embark&quot;</span> /&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这个配置文件中增加了<em>aop</em>配置名字空间。首先定义Minstrel的bean，然后利用<code>&lt;aop:config&gt;</code>标签定义aop相关的配置；然后在<code>&lt;aop:aspect&gt;</code>节点中引用minstrel，定义方面；aspect负责将pointcut和要执行的函数（before、after或者around）连接在一起。</p>
<h4 id="1-1-4-使用模板消除重复代码"><a href="#1-1-4-使用模板消除重复代码" class="headerlink" title="1.1.4 使用模板消除重复代码"></a>1.1.4 使用模板消除重复代码</h4><p>在编程过程中有没有感觉经常需要写重复无用的代码才能实现简单的功能，最经典的例子是JDBC的使用，这些代码就是样板式代码（boilerplate code）。</p>
<p>以JDBC的使用举个例子，这种原始的写法你一定见过：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Employee <span class="title function_">getEmployeeById</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">PreparedStatement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        conn = dataSource.getConnection();</span><br><span class="line">        stmt = conn.prepareStatement(<span class="string">&quot;select id, name from employee where id=?&quot;</span>);</span><br><span class="line">        stmt.setLong(<span class="number">1</span>, id);</span><br><span class="line">        rs = stmt.executeQuery();</span><br><span class="line">        <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (rs.next()) &#123;</span><br><span class="line">            employee = <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">            employee.setId(rs.getLong(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">            employee.setName(rs.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> employee;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rs != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                rs.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; </span><br><span class="line">       <span class="keyword">if</span> (stmt != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stmt.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (conn != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                conn.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，上面这么一坨代码中只有少数是真正用于查询数据（业务逻辑）的。除了JDBC的接口，其他JMS、JNDI以及REST服务的客户端API等也有类似的情况出现。</p>
<p>Spring试图通过模板来消除重复代码，这里所用的是模板设计模式。对于JDBC接口，Spring提供了JdbcTemplate模板来消除上面那个代码片段中的样板式代码，例子代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Employee <span class="title function_">getEmployeeById</span><span class="params">(<span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> jdbcTemplate.queryForObject(</span><br><span class="line">            <span class="string">&quot;select id, name from employee where id=?&quot;</span>,</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">RowMapper</span>&lt;Employee&gt;() &#123;</span><br><span class="line">                <span class="keyword">public</span> Employee <span class="title function_">mapRow</span><span class="params">(ResultSet resultSet, <span class="type">int</span> i)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                    <span class="type">Employee</span> <span class="variable">employee</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Employee</span>();</span><br><span class="line">                    employee.setId(resultSet.getLong(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">                    employee.setName(resultSet.getString(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">                    <span class="keyword">return</span> employee;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们上面已经演示了Spring简化Java开发的四种策略：面向POJO开发、依赖注入（DI）、面向切面编程和模板工具。在举例的过程中，我们稍微提到一点如何使用XML配置文件定义bean和AOP相关的对象，但是这些配置文件的加载原理是怎样的？这就需要研究下Spring的容器，Spring中所定义的bean都由Spring容器管理。</p>
<h3 id="1-2-使用容器管理beans"><a href="#1-2-使用容器管理beans" class="headerlink" title="1.2 使用容器管理beans"></a>1.2 使用容器管理beans</h3><p>基于Spring框架构建的应用中的对象，都由Spring容器（container）管理，如下图所示。Spring容器负责创建对象、编织对象和配置对象，负责对象的整个生命周期。</p>
<p>容器是Spring框架的核心，通过依赖注入（DI）管理构成Spring应用的组件。正是因为有容器管理各个组件之间的协作关系，使得每个Spring组件都很好理解、便于复用和单元测试。</p>
<p>Spring容器有多种实现，可以分为两类：</p>
<ul>
<li><code>Bean factories</code>（由<em>org.springframework.beans.factory.BeanFactory</em>接口定义）是最简单的容器，只提供基本的依赖注入功能；</li>
<li><code>Application context</code>（由<em>org.springframework.context.ApplicationContext</em>接口定义）在bean factory的基础上提供application-framework框架服务，例如可以从properties文件中解析配置信息、可以对外公布application events。</li>
</ul>
<h4 id="1-2-1-应用上下文（application-context）"><a href="#1-2-1-应用上下文（application-context）" class="headerlink" title="1.2.1 应用上下文（application context）"></a>1.2.1 应用上下文（application context）</h4><p>Spring提供了多种application context，可列举如下：</p>
<ul>
<li><em>AnnotationConfigApplicationContext</em>——从Java配置文件中加载应用上下文；</li>
<li><em>AnnotationConfigWebApplicationContext</em>——从Java配置文件中加载Spring web应用上下文；</li>
<li><em>ClassPathXmlApplicationContext</em>——从classpath（resources目录）下加载XML格式的应用上下文定义文件；</li>
<li><em>FileSystemXmlApplicationContext</em>——从指定文件系统目录下加载XML格式的应用上下文定义文件；</li>
<li><em>XmlWebApplicationContext</em>——从classpath（resources目录）下加载XML格式的Spring web应用上下文。</li>
</ul>
<p>通过应用上下文实例，可以通过<code>getBean()</code>方法获得对应的bean。</p>
<h4 id="1-2-2-bean的生命周期"><a href="#1-2-2-bean的生命周期" class="headerlink" title="1.2.2 bean的生命周期"></a>1.2.2 bean的生命周期</h4><p>在传统的Java应用中，一个对象的生命周期非常简单：通过new创建一个对象，然后该对象就可以使用，当这个对象不再使用时，由Java垃圾回收机制进行处理和回收。</p>
<p>在Spring应用中，bean的生命周期的控制更加精细。Spring提供了很多节点供开发人员定制某个bean的创建过程，掌握这些节点如何使用非常重要。Spring中bean的生命周期如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190422110224.png"></p>
<p>可以看出，bean factory负责bean创建的最初四步，然后移交给应用上下文做后续创建过程：</p>
<ol>
<li>Spring初始化bean</li>
<li>Spring将值和其他bean的引用注入（inject）到当前bean的对应属性中；</li>
<li>如果Bean实现了<em>BeanNameAware</em>接口，Spring会传入bean的ID来调用<em>setBeanName</em>方法；</li>
<li>如果Bean实现了<em>BeanFactoryAware</em>接口，Spring传入bean factory的引用来调用<em>setBeanFactory</em>方法；</li>
<li>如果Bean实现了<em>ApplicationContextAware</em>接口，Spring将传入应用上下文的引用来调用<em>setApplicationContext</em>方法；</li>
<li>如果Bean实现了<em>BeanPostProcessor</em>接口，则Spring调用<em>postProcessBeforeInitialization</em>方法，这个方法在初始化和属性注入之后调用，在任何初始化代码之前调用；</li>
<li>如果Bean实现了<em>InitializingBean</em>接口，则需要调用该接口的<em>afterPropertiesSet</em>方法；如果在bean定义的时候设置了<em>init-method</em>属性，则需要调用该属性指定的初始化方法；</li>
<li>如果Bean实现了<em>BeanPostProcessor</em>接口，则Spring调用<em>postProcessAfterInitialization</em>方法</li>
<li>在这个时候bean就可以用于在应用上下文中使用了，当上下文退出时bean也会被销毁；</li>
<li>如果Bean实现了<em>DisposableBean</em>接口，Spring会调用<em>destroy()<em>方法;如果在bean定义的时候设置了</em>destroy-method</em>， 则此时需要调用指定的方法。</li>
</ol>
<p>本节主要总结了如何启动Spring容器，以及Spring应用中bean的生命周期。</p>
<h4 id="1-3-1-Spring模块"><a href="#1-3-1-Spring模块" class="headerlink" title="1.3.1 Spring模块"></a>1.3.1 Spring模块</h4><p>Spring 4.0you 20个独立的模块，每个包含三个文件：二进制库、源文件和文档，完整的库列表如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190422111002.png"></p>
<p>按照功能划分，这些模块可以分成六组，如下图所示：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190422111020.png"></p>
<p>这些模块几乎可以满足所有企业级应用开发的需求，但是开发人员并不需要完全使用Spring的这些模块，可以自由选择符合项目需求的第三方模块——Spring为一些第三方模块提供了交互接口。</p>
<h2 id="装配bean—依赖注入的本质"><a href="#装配bean—依赖注入的本质" class="headerlink" title="装配bean—依赖注入的本质"></a>装配bean—依赖注入的本质</h2><p>在Spring应用中，对象无需自己负责查找或者创建与其关联的其他对象，由容器负责将创建各个对象，并创建各个对象之间的依赖关系。例如，一个订单管理组件需要使用信用卡认证组件，它不需要自己创建信用卡认证组件，只需要定义它需要使用信用卡认证组件即可，容器会创建信用卡认证组件然后将该组件的引用注入给订单管理组件。</p>
<p>创建各个对象之间协作关系的行为通常被称为<strong>装配（wiring）</strong>，这就是依赖注入（DI）的本质。</p>
<h3 id="2-1-Spring的配置方法概览"><a href="#2-1-Spring的配置方法概览" class="headerlink" title="2.1 Spring的配置方法概览"></a>2.1 Spring的配置方法概览</h3><p>Spring容器负责创建应用中的bean，并通过DI维护这些bean之间的协作关系。作为开发人员，你应该负责告诉Spring容器需要创建哪些bean以及如何将各个bean装配到一起。Spring提供三种装配bean的方式：</p>
<ul>
<li>基于XML文件的显式装配</li>
<li>基于Java文件的显式装配</li>
<li>隐式bean发现机制和自动装配</li>
</ul>
<p>我的建议是：尽可能使用自动装配，越少写显式的配置文件越好；当你必须使用显式配置时（例如，你要配置一个bean，但是该bean的源码不是由你维护），尽可能使用类型安全、功能更强大的基于Java文件的装配方式；最后，在某些情况下只有XML文件中才有你需要使用的名字空间时，再选择使用基于XML文件的装配方式。</p>
<h3 id="2-2-自动装配bean"><a href="#2-2-自动装配bean" class="headerlink" title="2.2 自动装配bean"></a>2.2 自动装配bean</h3><p>Spring通过两个特性实现自动装配：</p>
<ul>
<li><em>Component scanning</em>——Spring自动扫描和创建应用上下文中的beans；</li>
<li><em>Autowiring</em>——Spring自动建立bean之间的依赖关系；</li>
</ul>
<p>这里用一个例子来说明：假设你需要实现一个音响系统，该系统中包含CDPlayer和CompactDisc两个组件，Spring将自动发现这两个bean，并将CompactDisc的引用注入到CDPlayer中。</p>
<h4 id="2-2-1-创建可发现的beans"><a href="#2-2-1-创建可发现的beans" class="headerlink" title="2.2.1 创建可发现的beans"></a>2.2.1 创建可发现的beans</h4><p>首先创建CD的概念——CompactDisc接口，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.soundsystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CompactDisc</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CompactDisc接口的作用是将CDPlayer与具体的CD实现解耦合，即面向接口编程。这里还需定义一个具体的CD实现，如下所示：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.soundsystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SgtPeppers</span> <span class="keyword">implements</span> <span class="title class_">CompactDisc</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> <span class="string">&quot;Sgt. Perppers&#x27; Lonely Hearts Club Band&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">artist</span> <span class="operator">=</span> <span class="string">&quot;The Beatles&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Playing &quot;</span> + title + <span class="string">&quot; by &quot;</span> + artist);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里最重要的是*@Component*注解，它告诉Spring需要创建SgtPeppers bean。除此之外，还需要启动自动扫描机制，有两种方法：基于XML配置文件；基于Java配置文件，代码如下（二选一）：</p>
<ol>
<li>创建soundsystem.xml配置文件</li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">       </span><br><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.spring.sample.soundsystem&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在这个XML配置文件中，使用<code>&lt;context:component-scan&gt;</code>标签启动Component扫描功能，并可设置base-package属性。</p>
<ul>
<li>创建Java配置文件</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.ComponentScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &quot;com.spring.sample.soundsystem&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoundSystemConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这个Java配置文件中有两个注解值得注意：</p>
<ul>
<li><code>@Configuration</code>表示这个.java文件是一个配置文件；</li>
<li><code>@ComponentScan</code>表示开启Component扫描，并且可以设置basePackages属性——Spring将会设置该目录以及子目录下所有被*@Component*注解修饰的类。</li>
</ul>
<p>自动配置的另一个关键注解是*@Autowired*，基于之前的两个类和一个Java配置文件，可以写个测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.soundsystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.spring.sample.config.SoundSystemConfig;</span><br><span class="line"><span class="keyword">import</span> org.junit.Assert;<span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SoundSystemConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoundSystemTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CompactDisc cd;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">cdShouldNotBeNull</span><span class="params">()</span> &#123;</span><br><span class="line">        Assert.assertNotNull(cd);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行测试，测试通过，说明*@Autowired*注解起作用了：自动将扫描机制创建的CompactDisc类型的bean注入到SoundSystemTest这个bean中。</p>
<h4 id="2-2-2-给被扫描的bean命名"><a href="#2-2-2-给被扫描的bean命名" class="headerlink" title="2.2.2 给被扫描的bean命名"></a>2.2.2 给被扫描的bean命名</h4><p>在Spring上下文中，每个bean都有自己的ID。在上一个小节的例子中并没有提到这一点，但Spring在扫描到<em>SgtPeppers</em>这个组件并创建对应的bean时，默认给它设置的ID为<em>sgtPeppers</em>——是的，这个ID就是将类名称的首字母小写。</p>
<p>如果你需要给某个类对应的bean一个特别的名字，则可以给*@Component*注解传入指定的参数，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component(&quot;lonelyHeartsClub&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SgtPeppers</span> <span class="keyword">implements</span> <span class="title class_">CompactDisc</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-2-3-设置需要扫描的目标basepackage"><a href="#2-2-3-设置需要扫描的目标basepackage" class="headerlink" title="2.2.3 设置需要扫描的目标basepackage"></a>2.2.3 设置需要扫描的目标basepackage</h4><p>在之前的例子中，我们通过给*@Component*注解传入字符串形式的包路径，来设置需要扫描指定目录下的类并为之创建bean。</p>
<p>可以看出，<em>basePackages</em>是复数，意味着你可以设置多个目标目录，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackages = &#123;&quot;com.spring.sample.soundsystem&quot;, &quot;com.spring.sample.video&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoundSystemConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种字符串形式的表示虽然可以，但是不具备“类型安全”，因此Spring也提供了更加类型安全的机制，即通过类或者接口来设置扫描机制的目标目录，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = &#123;CDPlayer.class, DVDPlayer.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoundSystemConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过如上设置，会将CDPlayer和DVDPlayer各自所在的目录作为扫描机制的目标根目录。</p>
<p>如果应用中的对象是孤立的，并且互相之间没有依赖关系，例如<em>SgtPeppers</em>bean，那么这就够了。</p>
<h4 id="2-2-4-自动装配bean"><a href="#2-2-4-自动装配bean" class="headerlink" title="2.2.4 自动装配bean"></a>2.2.4 自动装配bean</h4><p>简单得说，自动装配的意思是让Spring从应用上下文中找到对应的bean的引用，并将它们注入到指定的bean。通过<code>@Autowired</code>注解可以完成自动装配。</p>
<p>例如，考虑下面代码中的<em>CDPlayer</em>类，它的构造函数被*@Autowired*修饰，表明当Spring创建CDPlayer的bean时，会给这个构造函数传入一个CompactDisc的bean对应的引用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.soundsystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CDPlayer</span> <span class="keyword">implements</span> <span class="title class_">MediaPlayer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> CompactDisc cd;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CDPlayer</span><span class="params">(CompactDisc cd)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.cd = cd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">play</span><span class="params">()</span> &#123;</span><br><span class="line">        cd.play();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>还有别的实现方法，例如将*@Autowired<em>注解作用在</em>setCompactDisc()*方法上:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCd</span><span class="params">(CompactDisc cd)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cd = cd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者是其他名字的方法上，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertCD</span><span class="params">(CompactDisc cd)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.cd = cd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>更简单的用法是，可以将*@Autowired*注解直接作用在成员变量之上，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> CompactDisc cd;</span><br></pre></td></tr></table></figure>

<p>只要对应类型的bean有且只有一个，则会自动装配到该属性上。如果没有找到对应的bean，应用会抛出对应的异常，如果想避免抛出这个异常，则需要设置*@Autowired(required&#x3D;false)<em>。不过，在应用程序设计中，应该谨慎设置这个属性，因为这会使得你必须面对</em>NullPointerException*的问题。</p>
<p>如果存在多个同一类型的bean，则Spring会抛出异常，表示装配有歧义，解决办法有两个：（1）通过*@Qualifier<em>注解指定需要的bean的ID；（2）通过</em>@Resource*注解指定注入特定ID的bean；</p>
<h4 id="2-2-5-验证自动配置"><a href="#2-2-5-验证自动配置" class="headerlink" title="2.2.5 验证自动配置"></a>2.2.5 验证自动配置</h4><p>通过下列代码，可以验证：CompactDisc的bean已经注入到CDPlayer的bean中，同时在测试用例中是将CDPlayer的bean注入到当前测试用例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.spring.sample.soundsystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.spring.sample.config.SoundSystemConfig;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;<span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.ContextConfiguration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringJUnit4ClassRunner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = SoundSystemConfig.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CDPlayerTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">log</span> <span class="operator">=</span> LoggerFactory.getLogger(CDPlayerTest.class);</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MediaPlayer player;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">playTest</span><span class="params">()</span> &#123;</span><br><span class="line">        player.play();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-3-基于Java配置文件装配bean"><a href="#2-3-基于Java配置文件装配bean" class="headerlink" title="2.3 基于Java配置文件装配bean"></a>2.3 基于Java配置文件装配bean</h3><p>Java配置文件不同于其他用于实现业务逻辑的Java代码，因此不能将Java配置文件业务逻辑代码混在一起。一般都会给Java配置文件新建一个单独的package。</p>
<h4 id="2-3-1-创建配置类"><a href="#2-3-1-创建配置类" class="headerlink" title="2.3.1 创建配置类"></a>2.3.1 创建配置类</h4><p>实际上在之前的例子中我们已经实践过基于Java的配置文件，看如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ComponentScan(basePackageClasses = &#123;CDPlayer.class, DVDPlayer.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SoundSystemConfig</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>@Configuration</em>注解表示这个类是配置类，之前我们是通过*@ComponentScan*注解实现bean的自动扫描和创建，这里我们重点是学习如何显式创建bean，因此首先将<code>@ComponentScan(basePackageClasses = &#123;CDPlayer.class, DVDPlayer.class&#125;)</code>这行代码去掉。</p>
<h4 id="2-3-2-定义bean"><a href="#2-3-2-定义bean" class="headerlink" title="2.3.2 定义bean"></a>2.3.2 定义bean</h4><p>通过*@Bean*注解创建一个Spring bean，该bean的默认ID和函数的方法名相同，即sgtPeppers。例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CompactDisc <span class="title function_">sgtPeppers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SgtPeppers</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样，可以指定bean的ID，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean(name = &quot;lonelyHeartsClub&quot;)</span></span><br><span class="line"><span class="keyword">public</span> CompactDisc <span class="title function_">sgtPeppers</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SgtPeppers</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以利用Java语言的表达能力，实现类似工厂模式的代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CompactDisc <span class="title function_">randomBeatlesCD</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">choice</span> <span class="operator">=</span> (<span class="type">int</span>)Math.floor(Math.random() * <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (choice == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SgtPeppers</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WhiteAlbum</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HardDaysNight</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">3</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Revolover</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-3-3-JavaConfig中的属性注入"><a href="#2-3-3-JavaConfig中的属性注入" class="headerlink" title="2.3.3 JavaConfig中的属性注入"></a>2.3.3 JavaConfig中的属性注入</h4><p>最简单的办法是将被引用的bean的生成函数传入到构造函数或者set函数中，例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CDPlayer <span class="title function_">cdPlayer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CDPlayer</span>(sgtPeppers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看起来是函数调用，实际上不是：由于sgtPeppers()方法被*@Bean*注解修饰，所以Spring会拦截这个函数调用，并返回之前已经创建好的bean——确保该SgtPeppers bean为单例。</p>
<p>假如有下列代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CDPlayer <span class="title function_">cdPlayer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CDPlayer</span>(sgtPeppers());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CDPlayer <span class="title function_">anotherCDPlayer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CDPlayer</span>(sgtPeppers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果把<em>sgtPeppers()<em>方法当作普通Java方法对待，则</em>cdPlayer</em>bean和<em>anotherCDPlayer</em>bean会持有不同的<em>SgtPeppers</em>实例——结合CDPlayer的业务场景看：就相当于将一片CD同时装入两个CD播放机中，显然这不可能。</p>
<p>默认情况下，Spring中所有的bean都是单例模式，因此<em>cdPlayer</em>和<em>anotherCDPlayer</em>这俩bean持有相同的<em>SgtPeppers</em>实例。</p>
<p>当然，还有一种更清楚的写法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CDPlayer <span class="title function_">cdPlayer</span><span class="params">(CompactDisc compactDisc)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CDPlayer</span>(compactDisc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> CDPlayer <span class="title function_">anotherCDPlayer</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CDPlayer</span>(sgtPeppers());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种情况下，<em>cdPlayer</em>和<em>anotherCDPlayer</em>这俩bean持有相同的<em>SgtPeppers</em>实例，该实例的ID为<em>lonelyHeartsClub</em>。这种方法最值得使用，因为它不要求CompactDisc bean在同一个配置文件中定义——只要在应用上下文容器中即可（不管是基于自动扫描发现还是基于XML配置文件定义）。</p>
<h3 id="2-6-总结"><a href="#2-6-总结" class="headerlink" title="2.6 总结"></a>2.6 总结</h3><p>这一章中学习了Spring 装配bean的三种方式：自动装配、基于Java文件装配和基于XML文件装配。</p>
<p>由于自动装配几乎不需要手动定义bean，建议优先选择自动装配；如何必须使用显式配置，则优先选择基于Java文件装配这种方式，因为相比于XML文件，Java文件具备更多的能力、类型安全等特点；但是也有一种情况必须使用XML配置文件，即你需要使用某个名字空间（name space），该名字空间只在XML文件中可以使用。</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>sql练习</title>
    <url>/2019/09/26/sql%E7%BB%83%E4%B9%A0/</url>
    <content><![CDATA[<p>在牛客上看到sql练习题，之前对于多表join类的操作不够熟悉，刚好练习一下</p>
<span id="more"></span>

<h4 id="1-查找最晚入职员工的所有信息"><a href="#1-查找最晚入职员工的所有信息" class="headerlink" title="1. 查找最晚入职员工的所有信息"></a>1. 查找最晚入职员工的所有信息</h4><blockquote>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">order</span> <span class="keyword">by</span> hire_date <span class="keyword">desc</span> limit <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h4 id="2-查找入职员工时间排名倒数第三的员工所有信息"><a href="#2-查找入职员工时间排名倒数第三的员工所有信息" class="headerlink" title="2. 查找入职员工时间排名倒数第三的员工所有信息"></a>2. 查找入职员工时间排名倒数第三的员工所有信息</h4><blockquote>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> employees <span class="keyword">order</span> <span class="keyword">by</span> hire_date <span class="keyword">desc</span> limit <span class="number">2</span>,<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>limit m,n 表示从m开始，取n个数</p>
<h4 id="3-查找各个部门当前-to-date-x3D-’9999-01-01’-领导当前薪水详情以及其对应部门编号dept-no"><a href="#3-查找各个部门当前-to-date-x3D-’9999-01-01’-领导当前薪水详情以及其对应部门编号dept-no" class="headerlink" title="3. 查找各个部门当前(to_date&#x3D;’9999-01-01’)领导当前薪水详情以及其对应部门编号dept_no"></a>3. 查找各个部门当前(to_date&#x3D;’9999-01-01’)领导当前薪水详情以及其对应部门编号dept_no</h4><blockquote>
<p>CREATE TABLE <code>dept_manager</code> (<br><code>dept_no</code> char(4) NOT NULL,<br><code>emp_no</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));<br>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span>, d.dept_no <span class="keyword">from</span> salaries <span class="keyword">as</span> s, dept_manager <span class="keyword">as</span> d <span class="keyword">where</span> s.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> d.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> s.emp_no<span class="operator">=</span>d.emp_no</span><br></pre></td></tr></table></figure>

<p>也可以用join来实现</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> s.<span class="operator">*</span>, d.dept_no <span class="keyword">from</span> salaries <span class="keyword">as</span> s <span class="keyword">join</span> dept_manager <span class="keyword">as</span> d <span class="keyword">on</span> s.emp_no<span class="operator">=</span>d.emp_no <span class="keyword">where</span> s.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> d.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="4-查找所有已经分配部门的员工的last-name和first-name"><a href="#4-查找所有已经分配部门的员工的last-name和first-name" class="headerlink" title="4. 查找所有已经分配部门的员工的last_name和first_name"></a>4. 查找所有已经分配部门的员工的last_name和first_name</h4><blockquote>
<p>CREATE TABLE <code>dept_emp</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>dept_no</code> char(4) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.last_name, e.first_name, d.dept_no <span class="keyword">from</span> employees <span class="keyword">as</span> e, dept_emp <span class="keyword">as</span> d <span class="keyword">where</span> e.emp_no<span class="operator">=</span>d.emp_no</span><br></pre></td></tr></table></figure>

<h4 id="5-查找所有员工的last-name和first-name以及对应部门编号dept-no，也包括展示没有分配具体部门的员工"><a href="#5-查找所有员工的last-name和first-name以及对应部门编号dept-no，也包括展示没有分配具体部门的员工" class="headerlink" title="5. 查找所有员工的last_name和first_name以及对应部门编号dept_no，也包括展示没有分配具体部门的员工"></a>5. 查找所有员工的last_name和first_name以及对应部门编号dept_no，也包括展示没有分配具体部门的员工</h4><blockquote>
<p>CREATE TABLE <code>dept_emp</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>dept_no</code> char(4) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.last_name, e.first_name, d.dept_no <span class="keyword">from</span> employees <span class="keyword">as</span> e <span class="keyword">left</span> <span class="keyword">join</span> dept_emp <span class="keyword">as</span> d <span class="keyword">on</span> e.emp_no<span class="operator">=</span>d.emp_no</span><br></pre></td></tr></table></figure>

<h4 id="6-查找薪水涨幅超过15次的员工号emp-no以及其对应的涨幅次数t"><a href="#6-查找薪水涨幅超过15次的员工号emp-no以及其对应的涨幅次数t" class="headerlink" title="6. 查找薪水涨幅超过15次的员工号emp_no以及其对应的涨幅次数t"></a>6. 查找薪水涨幅超过15次的员工号emp_no以及其对应的涨幅次数t</h4><blockquote>
<p>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> emp_no, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> t <span class="keyword">from</span> salaries <span class="keyword">group</span> <span class="keyword">by</span> emp_no <span class="keyword">having</span> t<span class="operator">&gt;</span><span class="number">15</span></span><br></pre></td></tr></table></figure>

<p>这是查出数量大于15条的记录，其实这道题的题意是涨薪15次，应该用join来做</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> a.emp_no, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> t <span class="keyword">from</span> salaries <span class="keyword">as</span> a <span class="keyword">left</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> b <span class="keyword">on</span> a.emp_no<span class="operator">=</span>b.emp_no <span class="keyword">and</span> a.to_date<span class="operator">=</span>b.from_date <span class="keyword">group</span> <span class="keyword">by</span> a.emp_no <span class="keyword">having</span> t<span class="operator">&gt;</span><span class="number">15</span></span><br></pre></td></tr></table></figure>

<h4 id="7-获取所有部门当前manager的当前薪水情况，给出dept-no-emp-no以及salary，当前表示to-date-x3D-’9999-01-01’"><a href="#7-获取所有部门当前manager的当前薪水情况，给出dept-no-emp-no以及salary，当前表示to-date-x3D-’9999-01-01’" class="headerlink" title="7. 获取所有部门当前manager的当前薪水情况，给出dept_no, emp_no以及salary，当前表示to_date&#x3D;’9999-01-01’"></a>7. 获取所有部门当前manager的当前薪水情况，给出dept_no, emp_no以及salary，当前表示to_date&#x3D;’9999-01-01’</h4><blockquote>
<p>CREATE TABLE <code>dept_manager</code> (<br><code>dept_no</code> char(4) NOT NULL,<br><code>emp_no</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
<p>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> d.dept_no, d.emp_no, s.salary </span><br><span class="line"><span class="keyword">from</span> dept_manager <span class="keyword">as</span> d, salaries <span class="keyword">as</span> s </span><br><span class="line"><span class="keyword">where</span> d.emp_no<span class="operator">=</span>s.emp_no </span><br><span class="line"><span class="keyword">AND</span> d.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> s.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span> </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> d.emp_no </span><br></pre></td></tr></table></figure>

<h4 id="8-获取所有非manager的员工emp-no"><a href="#8-获取所有非manager的员工emp-no" class="headerlink" title="8. 获取所有非manager的员工emp_no"></a>8. 获取所有非manager的员工emp_no</h4><blockquote>
<p>CREATE TABLE <code>dept_manager</code> (<br><code>dept_no</code> char(4) NOT NULL,<br><code>emp_no</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<p>方法1：not in</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> emp_no <span class="keyword">from</span> employees <span class="keyword">where</span> emp_no <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> emp_no <span class="keyword">from</span> dept_manager)</span><br></pre></td></tr></table></figure>

<p>方法2：left join is null</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.emp_no <span class="keyword">from</span> employees <span class="keyword">as</span> e <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">dept_manager <span class="keyword">as</span> d <span class="keyword">on</span> e.emp_no<span class="operator">=</span>d.emp_no </span><br><span class="line"><span class="keyword">where</span> d.dept_no <span class="keyword">is</span> <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<h4 id="9-获取所有员工当前的manager，如果当前的manager是自己的话结果不显示，当前表示to-date-x3D-’9999-01-01’。"><a href="#9-获取所有员工当前的manager，如果当前的manager是自己的话结果不显示，当前表示to-date-x3D-’9999-01-01’。" class="headerlink" title="9. 获取所有员工当前的manager，如果当前的manager是自己的话结果不显示，当前表示to_date&#x3D;’9999-01-01’。"></a>9. 获取所有员工当前的manager，如果当前的manager是自己的话结果不显示，当前表示to_date&#x3D;’9999-01-01’。</h4><p>结果第一列给出当前员工的emp_no,第二列给出其manager对应的manager_no。</p>
<blockquote>
<p>CREATE TABLE <code>dept_emp</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>dept_no</code> char(4) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
<p>CREATE TABLE <code>dept_manager</code> (<br><code>dept_no</code> char(4) NOT NULL,<br><code>emp_no</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.emp_no, m.emp_no <span class="keyword">from</span> dept_emp <span class="keyword">as</span> e <span class="keyword">left</span> <span class="keyword">join</span> </span><br><span class="line">dept_manager <span class="keyword">as</span> m <span class="keyword">on</span> e.dept_no<span class="operator">=</span>m.dept_no </span><br><span class="line"><span class="keyword">where</span> e.emp_no<span class="operator">!=</span>m.emp_no <span class="keyword">and</span> e.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> m.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span></span><br></pre></td></tr></table></figure>

<h4 id="10-获取所有部门中当前员工薪水最高的相关信息，给出dept-no-emp-no以及其对应的salary"><a href="#10-获取所有部门中当前员工薪水最高的相关信息，给出dept-no-emp-no以及其对应的salary" class="headerlink" title="10. 获取所有部门中当前员工薪水最高的相关信息，给出dept_no, emp_no以及其对应的salary"></a>10. 获取所有部门中当前员工薪水最高的相关信息，给出dept_no, emp_no以及其对应的salary</h4><blockquote>
<p>CREATE TABLE <code>dept_emp</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>dept_no</code> char(4) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));<br>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> d.dept_no, s.emp_no, <span class="built_in">max</span>(s.salary) <span class="keyword">as</span> salary <span class="keyword">from</span> </span><br><span class="line">salaries <span class="keyword">as</span> s, dept_emp <span class="keyword">as</span> d <span class="keyword">on</span> s.emp_no<span class="operator">=</span>d.emp_no </span><br><span class="line"><span class="keyword">where</span> d.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">AND</span> s.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> d.dept_no</span><br></pre></td></tr></table></figure>

<h4 id="11-从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。"><a href="#11-从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。" class="headerlink" title="11. 从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。"></a>11. 从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。</h4><blockquote>
<p>CREATE TABLE IF NOT EXISTS “titles” (<br><code>emp_no</code> int(11) NOT NULL,<br><code>title</code> varchar(50) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date DEFAULT NULL);</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> title, <span class="built_in">count</span>(<span class="number">1</span>) <span class="keyword">as</span> t <span class="keyword">from</span> titles <span class="keyword">group</span> <span class="keyword">by</span> title <span class="keyword">having</span> t<span class="operator">&gt;=</span><span class="number">2</span></span><br></pre></td></tr></table></figure>

<h4 id="12-从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。"><a href="#12-从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。" class="headerlink" title="12. 从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。"></a>12. 从titles表获取按照title进行分组，每组个数大于等于2，给出title以及对应的数目t。</h4><p>注意对于重复的emp_no的title进行忽略。</p>
<blockquote>
<p>CREATE TABLE IF NOT EXISTS <code>titles</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>title</code> varchar(50) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date DEFAULT NULL);</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span>  title, <span class="built_in">count</span>(<span class="keyword">distinct</span> emp_no) <span class="keyword">as</span> t <span class="keyword">from</span> titles <span class="keyword">group</span> <span class="keyword">by</span> title <span class="keyword">having</span> t<span class="operator">&gt;=</span><span class="number">2</span></span><br></pre></td></tr></table></figure>

<h4 id="13-查找employees表所有emp-no为奇数，且last-name不为Mary的员工信息，并按照hire-date逆序排列"><a href="#13-查找employees表所有emp-no为奇数，且last-name不为Mary的员工信息，并按照hire-date逆序排列" class="headerlink" title="13. 查找employees表所有emp_no为奇数，且last_name不为Mary的员工信息，并按照hire_date逆序排列"></a>13. 查找employees表所有emp_no为奇数，且last_name不为Mary的员工信息，并按照hire_date逆序排列</h4><blockquote>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> emp_no,birth_date, first_name, last_name, gender, hire_date <span class="keyword">from</span> employees </span><br><span class="line"><span class="keyword">where</span> emp_no<span class="operator">%</span><span class="number">2</span><span class="operator">=</span><span class="number">1</span> <span class="keyword">and</span> last_name<span class="operator">!=</span><span class="string">&#x27;Mary&#x27;</span> <span class="keyword">order</span> <span class="keyword">by</span> hire_date <span class="keyword">desc</span></span><br></pre></td></tr></table></figure>

<h4 id="14-统计出当前各个title类型对应的员工当前（to-date-x3D-’9999-01-01’）薪水对应的平均工资。结果给出title以及平均工资avg。"><a href="#14-统计出当前各个title类型对应的员工当前（to-date-x3D-’9999-01-01’）薪水对应的平均工资。结果给出title以及平均工资avg。" class="headerlink" title="14.统计出当前各个title类型对应的员工当前（to_date&#x3D;’9999-01-01’）薪水对应的平均工资。结果给出title以及平均工资avg。"></a>14.统计出当前各个title类型对应的员工当前（to_date&#x3D;’9999-01-01’）薪水对应的平均工资。结果给出title以及平均工资avg。</h4><blockquote>
<p> CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
<p>CREATE TABLE IF NOT EXISTS “titles” (<br><code>emp_no</code> int(11) NOT NULL,<br><code>title</code> varchar(50) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date DEFAULT NULL);</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> t.title, <span class="built_in">avg</span>(s.salary) <span class="keyword">as</span> avg <span class="keyword">from</span> titles <span class="keyword">as</span> t <span class="keyword">inner</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> s <span class="keyword">on</span> t.emp_no<span class="operator">=</span>s.emp_no </span><br><span class="line"><span class="keyword">where</span> s.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> t.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> t.title</span><br></pre></td></tr></table></figure>

<p>####15. 获取当前（to_date&#x3D;’9999-01-01’）薪水第二多的员工的emp_no以及其对应的薪水salary</p>
<blockquote>
<p>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<p>要去掉工资相同的情况</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> emp_no, salary <span class="keyword">from</span> salaries </span><br><span class="line"><span class="keyword">where</span> to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> salary<span class="operator">=</span>(<span class="keyword">select</span> <span class="keyword">distinct</span> salary <span class="keyword">from</span> salaries <span class="keyword">order</span> <span class="keyword">by</span> salary <span class="keyword">desc</span> limit <span class="number">1</span>,<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h4 id="16-查找当前薪水-to-date-x3D-’9999-01-01’-排名第二多的员工编号emp-no、薪水salary、last-name以及first-name，不准使用order-by"><a href="#16-查找当前薪水-to-date-x3D-’9999-01-01’-排名第二多的员工编号emp-no、薪水salary、last-name以及first-name，不准使用order-by" class="headerlink" title="16. 查找当前薪水(to_date&#x3D;’9999-01-01’)排名第二多的员工编号emp_no、薪水salary、last_name以及first_name，不准使用order by"></a>16. 查找当前薪水(to_date&#x3D;’9999-01-01’)排名第二多的员工编号emp_no、薪水salary、last_name以及first_name，不准使用order by</h4><blockquote>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));<br>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<p>用两遍max来代理order by limit 1,1</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.emp_no, <span class="built_in">max</span>(s.salary) <span class="keyword">as</span> salary, e.last_name, e.first_name </span><br><span class="line"><span class="keyword">from</span> employees <span class="keyword">as</span> e <span class="keyword">inner</span> <span class="keyword">join</span> salaries <span class="keyword">as</span> s </span><br><span class="line"><span class="keyword">on</span> s.emp_no<span class="operator">=</span>e.emp_no </span><br><span class="line"><span class="keyword">where</span> s.to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span> <span class="keyword">and</span> </span><br><span class="line">s.salary <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="built_in">max</span>(salary) <span class="keyword">from</span> salaries <span class="keyword">where</span> to_date<span class="operator">=</span><span class="string">&#x27;9999-01-01&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>####17. 查找所有员工的last_name和first_name以及对应的dept_name，也包括暂时没有分配部门的员工</p>
<blockquote>
<p>CREATE TABLE <code>departments</code> (<br><code>dept_no</code> char(4) NOT NULL,<br><code>dept_name</code> varchar(40) NOT NULL,<br>PRIMARY KEY (<code>dept_no</code>));</p>
<p>CREATE TABLE <code>dept_emp</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>dept_no</code> char(4) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>dept_no</code>));</p>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
</blockquote>
<p>三个表两次级联</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> e.last_name, e.first_name, dp.dept_name </span><br><span class="line"><span class="keyword">from</span> employees <span class="keyword">as</span> e <span class="keyword">left</span> <span class="keyword">join</span> dept_emp <span class="keyword">as</span> d <span class="keyword">on</span> e.emp_no<span class="operator">=</span>d.emp_no</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> departments <span class="keyword">as</span> dp <span class="keyword">on</span> d.dept_no<span class="operator">=</span>dp.dept_no</span><br></pre></td></tr></table></figure>

<h4 id="18-查找员工编号emp-no为10001其自入职以来的薪水salary涨幅值growth"><a href="#18-查找员工编号emp-no为10001其自入职以来的薪水salary涨幅值growth" class="headerlink" title="18. 查找员工编号emp_no为10001其自入职以来的薪水salary涨幅值growth"></a>18. 查找员工编号emp_no为10001其自入职以来的薪水salary涨幅值growth</h4><blockquote>
<p> CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<p>两次查找，一次以to_date正向排序，一次逆向排序</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">(<span class="keyword">select</span> salary <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no<span class="operator">=</span><span class="number">10001</span> <span class="keyword">order</span> <span class="keyword">by</span> to_date <span class="keyword">desc</span>)<span class="operator">-</span></span><br><span class="line">(<span class="keyword">select</span> salary <span class="keyword">from</span> salaries <span class="keyword">where</span> emp_no<span class="operator">=</span><span class="number">10001</span> <span class="keyword">order</span> <span class="keyword">by</span> to_date)</span><br><span class="line"><span class="keyword">as</span> growth</span><br></pre></td></tr></table></figure>

<h4 id="19-查找所有员工自入职以来的薪水涨幅情况，给出员工编号emp-no以及其对应的薪水涨幅growth，并按照growth进行升序"><a href="#19-查找所有员工自入职以来的薪水涨幅情况，给出员工编号emp-no以及其对应的薪水涨幅growth，并按照growth进行升序" class="headerlink" title="19. 查找所有员工自入职以来的薪水涨幅情况，给出员工编号emp_no以及其对应的薪水涨幅growth，并按照growth进行升序"></a>19. 查找所有员工自入职以来的薪水涨幅情况，给出员工编号emp_no以及其对应的薪水涨幅growth，并按照growth进行升序</h4><blockquote>
<p>CREATE TABLE <code>employees</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>birth_date</code> date NOT NULL,<br><code>first_name</code> varchar(14) NOT NULL,<br><code>last_name</code> varchar(16) NOT NULL,<br><code>gender</code> char(1) NOT NULL,<br><code>hire_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>));</p>
<p>CREATE TABLE <code>salaries</code> (<br><code>emp_no</code> int(11) NOT NULL,<br><code>salary</code> int(11) NOT NULL,<br><code>from_date</code> date NOT NULL,<br><code>to_date</code> date NOT NULL,<br>PRIMARY KEY (<code>emp_no</code>,<code>from_date</code>));</p>
</blockquote>
<p>方法一：用两次left join，加一次inner join</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sCurrent.emp_no, (sCurrent.salary<span class="operator">-</span>sStart.salary) <span class="keyword">AS</span> growth</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> s.emp_no, s.salary <span class="keyword">FROM</span> employees e</span><br><span class="line">      <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> salaries s <span class="keyword">ON</span> e.emp_no <span class="operator">=</span> s.emp_no <span class="keyword">WHERE</span> s.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span>) <span class="keyword">AS</span> sCurrent</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> (<span class="keyword">SELECT</span> s.emp_no, s.salary <span class="keyword">FROM</span> employees e </span><br><span class="line">            <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> salaries s <span class="keyword">ON</span> e.emp_no <span class="operator">=</span> s.emp_no <span class="keyword">WHERE</span> s.from_date <span class="operator">=</span> e.hire_date) <span class="keyword">AS</span> sStart</span><br><span class="line"><span class="keyword">ON</span> sCurrent.emp_no <span class="operator">=</span> sStart.emp_no</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> growth</span><br></pre></td></tr></table></figure>

<p>方法二：用多次select</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> sCurrent.emp_no, (sCurrent.salary<span class="operator">-</span>sStart.salary) <span class="keyword">AS</span> growth</span><br><span class="line"><span class="keyword">FROM</span> (<span class="keyword">SELECT</span> s.emp_no, s.salary <span class="keyword">FROM</span> employees e, salaries s </span><br><span class="line">      <span class="keyword">WHERE</span> e.emp_no <span class="operator">=</span> s.emp_no <span class="keyword">AND</span> s.to_date <span class="operator">=</span> <span class="string">&#x27;9999-01-01&#x27;</span>) <span class="keyword">AS</span> sCurrent,</span><br><span class="line">(<span class="keyword">SELECT</span> s.emp_no, s.salary <span class="keyword">FROM</span> employees e, salaries s </span><br><span class="line"> <span class="keyword">WHERE</span> e.emp_no <span class="operator">=</span> s.emp_no <span class="keyword">AND</span> s.from_date <span class="operator">=</span> e.hire_date) <span class="keyword">AS</span> sStart</span><br><span class="line"><span class="keyword">WHERE</span> sCurrent.emp_no <span class="operator">=</span> sStart.emp_no</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> growth</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>sql</tag>
      </tags>
  </entry>
  <entry>
    <title>staticmethod和classmethod</title>
    <url>/2018/09/13/staticmethod%E5%92%8Cclassmethod/</url>
    <content><![CDATA[<p>一般来说，要使用某个类的方法，需要先实例化一个对象再调用方法。</p>
<p>而使用@staticmethod或@classmethod，就可以不需要实例化，直接类名.方法名()来调用。</p>
<p>这有利于组织代码，把某些应该属于某个类的函数给放到那个类里去，同时有利于命名空间的整洁。</p>
<span id="more"></span>



<p>既然@staticmethod和@classmethod都可以直接类名.方法名()来调用，那他们有什么区别呢</p>
<p>从它们的使用上来看,</p>
<ul>
<li>@staticmethod不需要表示自身对象的self和自身类的cls参数，就跟使用函数一样。</li>
<li>@classmethod也不需要self参数，但第一个参数需要是表示自身类的cls参数。</li>
</ul>
<p>如果在@staticmethod中要调用到这个类的一些属性方法，只能直接类名.属性名或类名.方法名。</p>
<p>而@classmethod因为持有cls参数，可以来调用类的属性，类的方法，实例化对象等，避免硬编码。</p>
<p>下面上代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    bar = <span class="number">1</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">foo</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;foo&#x27;</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">static_foo</span>():</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;static_foo&#x27;</span></span><br><span class="line">        <span class="built_in">print</span> A.bar</span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">class_foo</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&#x27;class_foo&#x27;</span></span><br><span class="line">        <span class="built_in">print</span> cls.bar</span><br><span class="line">        cls().foo()</span><br><span class="line"></span><br><span class="line">A.static_foo()</span><br><span class="line">A.class_foo()</span><br></pre></td></tr></table></figure>

<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">static_foo</span><br><span class="line">1</span><br><span class="line">class_foo</span><br><span class="line">1</span><br><span class="line">foo</span><br></pre></td></tr></table></figure>



<p>再看一个例子，是classmethod用于处理init的重构问题的：</p>
<p>看下面的定义的一个时间类：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Data_test</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    day=<span class="number">0</span></span><br><span class="line">    month=<span class="number">0</span></span><br><span class="line">    year=<span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,year=<span class="number">0</span>,month=<span class="number">0</span>,day=<span class="number">0</span></span>):</span><br><span class="line">        self.day=day</span><br><span class="line">        self.month=month</span><br><span class="line">        self.year=year</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">out_date</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;year :&quot;</span></span><br><span class="line">        <span class="built_in">print</span> self.year</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;month :&quot;</span></span><br><span class="line">        <span class="built_in">print</span> self.month</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;day :&quot;</span></span><br><span class="line">        <span class="built_in">print</span> self.day</span><br><span class="line"></span><br><span class="line">t=Data_test(<span class="number">2016</span>,<span class="number">8</span>,<span class="number">1</span>)</span><br><span class="line">t.out_date()</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">year :</span><br><span class="line">2016</span><br><span class="line">month :</span><br><span class="line">8</span><br><span class="line">day :</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>符合期望。</p>
<p>如果用户输入的是 “2016-8-1” 这样的字符格式，那么就需要调用Date_test 类前做一下处理：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">string_date=<span class="string">&#x27;2016-8-1&#x27;</span></span><br><span class="line">year,month,day=<span class="built_in">map</span>(<span class="built_in">int</span>,string_date.split(<span class="string">&#x27;-&#x27;</span>))</span><br><span class="line">s=Data_test(year,month,day)</span><br></pre></td></tr></table></figure>

<p>先把‘2016-8-1’ 分解成 year，month，day 三个变量，然后转成int，再调用Date_test(year,month,day)函数。 也很符合期望。</p>
<p>那我可不可以把这个字符串处理的函数放到 Date_test 类当中呢？</p>
<p>那么@classmethod 就开始出场了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Data_test2</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    day=<span class="number">0</span></span><br><span class="line">    month=<span class="number">0</span></span><br><span class="line">    year=<span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,year=<span class="number">0</span>,month=<span class="number">0</span>,day=<span class="number">0</span></span>):</span><br><span class="line">        self.day=day</span><br><span class="line">        self.month=month</span><br><span class="line">        self.year=year</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_date</span>(<span class="params">cls,string_date</span>):</span><br><span class="line">        <span class="comment">#这里第一个参数是cls， 表示调用当前的类名</span></span><br><span class="line">        year,month,day=<span class="built_in">map</span>(<span class="built_in">int</span>,string_date.split(<span class="string">&#x27;-&#x27;</span>))</span><br><span class="line">        date1=cls(year,month,day)</span><br><span class="line">        <span class="comment">#返回的是一个初始化后的类</span></span><br><span class="line">        <span class="keyword">return</span> date1</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">out_date</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;year :&quot;</span></span><br><span class="line">        <span class="built_in">print</span> self.year</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;month :&quot;</span></span><br><span class="line">        <span class="built_in">print</span> self.month</span><br><span class="line">        <span class="built_in">print</span> <span class="string">&quot;day :&quot;</span></span><br><span class="line">        <span class="built_in">print</span> self.day</span><br></pre></td></tr></table></figure>



<p>在Date_test类里面创建一个成员函数， 前面用了@classmethod装饰。 它的作用就是有点像静态类，比静态类不一样的就是它可以传进来一个当前类作为第一个参数。</p>
<p>那么如何调用呢？</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">r=Data_test2.get_date(<span class="string">&quot;2016-8-6&quot;</span>)</span><br><span class="line">r.out_date()</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">year :</span><br><span class="line">2016</span><br><span class="line">month :</span><br><span class="line">8</span><br><span class="line">day :</span><br><span class="line">1</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>spring ioc源码分析</title>
    <url>/2020/05/12/spring-ioc%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<p>Spring有两大核心，IoC和AOP。之前有用过Spring，但对于源码还不够了解，因此专门写一篇博文来记录阅读这部分源码的过程。</p>
<span id="more"></span>

<h3 id="什么是IoC"><a href="#什么是IoC" class="headerlink" title="什么是IoC"></a>什么是IoC</h3><p>要阅读IoC的源码，首先要搞清楚IoC是干嘛的，IoC全称Inversion of Control ，意为控制反转，有时候也被称为DI (Dependency Injection，依赖注入)。</p>
<p>需要注意的是，两个概念是有区别的。控制反转是目的，依赖注入是手段。所谓控制反转，我们在Java中要使用对象的时候，通常是new一个对象出来用，控制反转就是把对象的管理交给Spring，我们只需要用。依赖注入就是需要用的时候，你只要标明你需要这个对象，由Spring帮你注入就行了。</p>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><p>假设我们现在有一个AccountDao对象，其实现类为AccountDaoImpl，其中只有一个save方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//AccountDao.JAVA</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AccountDaoImpl.JAVA</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 账户持久层实现类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Repository(&quot;accountDao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountDaoImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountDao</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">save</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;账户已保存&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了进行依赖注入，在Spring当中我们采用xml的配置方式，其中xmlns表示namespace，也就是命名空间，定义了这个xml文件是用来干嘛的，需要不同的功能就要引入不同的命名空间，其最基本的是<code>beans</code>的定义功能，文件中的accountDao已经被指定了<code>id</code>和<code>class</code>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!--基于注解的IOC约束需要导入context空间--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--告知spring创建容器时要扫描的包--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;day2_01_annotationIOC&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--告知Spring properties文件的位置--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:property-placeholder</span> <span class="attr">location</span>=<span class="string">&quot;day2_01_annotationIOC/jdbcConfig.properties&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--要有set方法才能用显示bean的方法注入--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置持久层--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountDao&quot;</span> <span class="attr">class</span>=<span class="string">&quot;day2_01_annotationIOC.dao.impl.AccountDaoImpl&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们需要一个applicationContext作为容器来获取<code>beans</code>，这里使用<code>ClassPathXmlApplicationContext</code>进行，当然也可以使用<code>FileSystemXmlApplicationContext</code>，二者区别只是前者不需要指定绝对路径。我们明明这个类为Client，返回的容器用<code>ApplicationContext</code>接收。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Client</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取spring的核心容器，并且根据bean的id获取对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">////获取spring核心容器</span></span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;day2_01_bean.xml&quot;</span>);</span><br><span class="line">        <span class="comment">//持久层对象</span></span><br><span class="line">        <span class="type">AccountDao</span> <span class="variable">accountDao</span> <span class="operator">=</span> ac.getBean(<span class="string">&quot;accountDao&quot;</span>, AccountDao.class);</span><br><span class="line">        System.out.println(accountDao);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们跳入<code>ClassPathXmlApplicationContext</code>的构造方法看看</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//org.springframework.context.support.ClassPathXmlApplicationContext 84</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(String configLocation)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="built_in">this</span>(<span class="keyword">new</span> <span class="title class_">String</span>[] &#123;configLocation&#125;, <span class="literal">true</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//ClassPathXmlApplicationContext 137</span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">ClassPathXmlApplicationContext</span><span class="params">(</span></span><br><span class="line"><span class="params">  String[] configLocations, <span class="type">boolean</span> refresh, <span class="meta">@Nullable</span> ApplicationContext parent)</span></span><br><span class="line">  <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//这里的父类指的是bean的父子继承，不是class的继承关系，具体可以查看后面的&quot;Bean继承&quot;小节</span></span><br><span class="line">  <span class="built_in">super</span>(parent);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//找出所有的配置文件路径</span></span><br><span class="line">  setConfigLocations(configLocations);</span><br><span class="line">  <span class="comment">//核心方法</span></span><br><span class="line">  <span class="keyword">if</span> (refresh) &#123;</span><br><span class="line">    refresh();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续往下看refresh方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//AbstractApplicationContext 516</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">//记录开始时间,设置状态为开始创建,关闭状态设为false</span></span><br><span class="line">			prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 最重要的步骤,这里之后就获取到了BeanFactory了</span></span><br><span class="line">      <span class="comment">// 把所有bean的信息都提取出来，注册到beanFactory里面，这里的bean还没有初始化</span></span><br><span class="line">      <span class="comment">// 提取出来的信息是beanName-&gt; beanDefination的map</span></span><br><span class="line">			<span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//手动注册特殊的bean</span></span><br><span class="line">			prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//BeanFactoryPostProcessor的处理</span></span><br><span class="line">        <span class="comment">//点进去看到方法是protected的空函数，主要是给子类继承来处理BeanFactory的</span></span><br><span class="line">				postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 方法</span></span><br><span class="line">				invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册BeanPostProcessor</span></span><br><span class="line">				registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 初始化MessageSource，用于国际化，不涉及就不说了</span></span><br><span class="line">				initMessageSource();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 初始化ApplicationContext的时间广播器，不展开说了</span></span><br><span class="line">				initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 从方法名能看出来，钩子方法</span></span><br><span class="line">        <span class="comment">// 子类可以在这里初始化一些特殊的Bean(初始化Singleton Beans之前)</span></span><br><span class="line">				onRefresh();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 注册时间监听器,不展开</span></span><br><span class="line">				registerListeners();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 实例化所有非lazy-init的singleton beans</span></span><br><span class="line">				finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 广播事件，ApplicaitonContext初始化完成</span></span><br><span class="line">				finishRefresh();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">					logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">							<span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 销毁已经创建的singleton beans，以免资源占用</span></span><br><span class="line">				destroyBeans();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">				cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Propagate exception to caller.</span></span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">				<span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">        <span class="comment">//释放bean描述器的缓存</span></span><br><span class="line">				resetCommonCaches();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面，我们将一个个函数来解析这个refresh函数，上面的<code>prepareRefresh()</code>函数功能主要是设定active状态为true，closed状态为false，两个状态值都是AtomicBoolean。并检查xml文件中是否包含必要的值。</p>
<h3 id="创建Bean容器，加载、注册Bean"><a href="#创建Bean容器，加载、注册Bean" class="headerlink" title="创建Bean容器，加载、注册Bean"></a>创建Bean容器，加载、注册Bean</h3><p>refresh方法种的第二个函数：<code>obtainFreshBeanFactory()</code></p>
<p>这个方法是IoC过程中最重要的一个函数之一，在这里初始化BeanFactory，加载Bean，注册Bean，但是这一步之后Bean初始化并未完成,因为还没有实例化Bean。</p>
<p>&#x2F;&#x2F;AbstractApplicationContext 620</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> ConfigurableListableBeanFactory <span class="title function_">obtainFreshBeanFactory</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//如果有BeanFactory，先销毁旧的，再创建新的，加载Bean定义，注册Bean</span></span><br><span class="line">  refreshBeanFactory();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 返回上一步创建的Bean</span></span><br><span class="line">  <span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> getBeanFactory();</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Bean factory for &quot;</span> + getDisplayName() + <span class="string">&quot;: &quot;</span> + beanFactory);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> beanFactory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F; AbstractRefreshableApplicationContext 124</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">refreshBeanFactory</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="comment">//如果有BeanFactory，先销毁所有的Bean，关闭已有BeanFactory</span></span><br><span class="line">  <span class="keyword">if</span> (hasBeanFactory()) &#123;</span><br><span class="line">    destroyBeans();</span><br><span class="line">    closeBeanFactory();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 初始化一个DefaultListableBeanFactory</span></span><br><span class="line">    <span class="type">DefaultListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> createBeanFactory();</span><br><span class="line">    <span class="comment">// 用于序列化BeanFactory的设置</span></span><br><span class="line">    beanFactory.setSerializationId(getId());</span><br><span class="line">    <span class="comment">// 配置Bean是否允许覆盖，是否允许循环引用</span></span><br><span class="line">    customizeBeanFactory(beanFactory);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//加载Bean到BeanFactory中</span></span><br><span class="line">    loadBeanDefinitions(beanFactory);</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.beanFactoryMonitor) &#123;</span><br><span class="line">      <span class="built_in">this</span>.beanFactory = beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ApplicationContextException</span>(<span class="string">&quot;I/O error parsing bean definition source for &quot;</span> + getDisplayName(), ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看看继承关系，ApplicationContext是BeanFactory的子类，但其实这里不应该这个理解，应该理解成ApplicationContext里面包含一个实例化的BeanFactory。</p>
<p>![image-20200512213557235](&#x2F;Users&#x2F;apple&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20200512213557235.png)</p>
<p>第二个问题，Spring为什么要选择<code>DefaultListableBeanFactory</code>作为默认的BeanFactory呢，下面图中看到，BeanFactory有三个子接口，而这个<code>DefaultListableBeanFactory</code>刚好把实现了三个子接口，意思是三个子接口当中的功能都被继承下来了。</p>
<p>![image-20200512214229003](&#x2F;Users&#x2F;apple&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20200512214229003.png)</p>
<p>Bean是如何被存在BeanFactory当中的呢，其实是通过BeanDefinition存进去的，我们来看看BeanDefinition</p>
<h3 id="BeanDefinition"><a href="#BeanDefinition" class="headerlink" title="BeanDefinition"></a>BeanDefinition</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BeanDefinition</span> <span class="keyword">extends</span> <span class="title class_">AttributeAccessor</span>, BeanMetadataElement &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Spring默认只提供 sington 和 prototype 两种，</span></span><br><span class="line">   <span class="comment">// 很多人可能知道还有 request, session, globalSession, application, websocket 这几种，</span></span><br><span class="line">   <span class="comment">// 不过，它们属于基于 web 的扩展。</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">SCOPE_SINGLETON</span> <span class="operator">=</span> ConfigurableBeanFactory.SCOPE_SINGLETON;</span><br><span class="line">   <span class="type">String</span> <span class="variable">SCOPE_PROTOTYPE</span> <span class="operator">=</span> ConfigurableBeanFactory.SCOPE_PROTOTYPE;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 不重要，直接跳过</span></span><br><span class="line">   <span class="type">int</span> <span class="variable">ROLE_APPLICATION</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">   <span class="type">int</span> <span class="variable">ROLE_SUPPORT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">   <span class="type">int</span> <span class="variable">ROLE_INFRASTRUCTURE</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置父 Bean，这里涉及到 bean 继承，不是 java 继承。</span></span><br><span class="line">   <span class="comment">// 一句话就是：继承父 Bean 的配置信息而已</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setParentName</span><span class="params">(String parentName)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 获取父 Bean</span></span><br><span class="line">   String <span class="title function_">getParentName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置 Bean 的类名称，将来是要通过反射来生成实例的</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setBeanClassName</span><span class="params">(String beanClassName)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 获取 Bean 的类名称</span></span><br><span class="line">   String <span class="title function_">getBeanClassName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置 bean 的 scope</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setScope</span><span class="params">(String scope)</span>;</span><br><span class="line"></span><br><span class="line">   String <span class="title function_">getScope</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置是否懒加载</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setLazyInit</span><span class="params">(<span class="type">boolean</span> lazyInit)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isLazyInit</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置该 Bean 依赖的所有的 Bean，注意，这里的依赖不是指属性依赖(如 @Autowire 标记的)，</span></span><br><span class="line">   <span class="comment">// 是 depends-on=&quot;&quot; 属性设置的值。</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setDependsOn</span><span class="params">(String... dependsOn)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 返回该 Bean 的所有依赖</span></span><br><span class="line">   String[] getDependsOn();</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 设置该 Bean 是否可以注入到其他 Bean 中，只对根据类型注入有效，</span></span><br><span class="line">   <span class="comment">// 如果根据名称注入，即使这边设置了 false，也是可以的</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setAutowireCandidate</span><span class="params">(<span class="type">boolean</span> autowireCandidate)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 该 Bean 是否可以注入到其他 Bean 中</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isAutowireCandidate</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 主要的。同一接口的多个实现，如果不指定名字的话，Spring 会优先选择设置 primary 为 true 的 bean</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setPrimary</span><span class="params">(<span class="type">boolean</span> primary)</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否是 primary 的</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isPrimary</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果该 Bean 采用工厂方法生成，指定工厂名称。</span></span><br><span class="line">   <span class="comment">// 一句话就是：有些实例不是用反射生成的，而是用工厂模式生成的</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setFactoryBeanName</span><span class="params">(String factoryBeanName)</span>;</span><br><span class="line">   <span class="comment">// 获取工厂名称</span></span><br><span class="line">   String <span class="title function_">getFactoryBeanName</span><span class="params">()</span>;</span><br><span class="line">   <span class="comment">// 指定工厂类中的 工厂方法名称</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setFactoryMethodName</span><span class="params">(String factoryMethodName)</span>;</span><br><span class="line">   <span class="comment">// 获取工厂类中的 工厂方法名称</span></span><br><span class="line">   String <span class="title function_">getFactoryMethodName</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 构造器参数</span></span><br><span class="line">   ConstructorArgumentValues <span class="title function_">getConstructorArgumentValues</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Bean 中的属性值，后面给 bean 注入属性值的时候会说到</span></span><br><span class="line">   MutablePropertyValues <span class="title function_">getPropertyValues</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否 singleton</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否 prototype</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isPrototype</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果这个 Bean 是被设置为 abstract，那么不能实例化，</span></span><br><span class="line">   <span class="comment">// 常用于作为 父bean 用于继承，其实也很少用......</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isAbstract</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="type">int</span> <span class="title function_">getRole</span><span class="params">()</span>;</span><br><span class="line">   String <span class="title function_">getDescription</span><span class="params">()</span>;</span><br><span class="line">   String <span class="title function_">getResourceDescription</span><span class="params">()</span>;</span><br><span class="line">   BeanDefinition <span class="title function_">getOriginatingBeanDefinition</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续看<code>AbstractRefreshableApplicationContext</code>当中的<code>refreshBeanFactory()</code>方法，还剩下两个主要的内容</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">customizeBeanFactory(beanFactory);</span><br><span class="line">loadBeanDefinitions(beanFactory);	</span><br></pre></td></tr></table></figure>

<h4 id="配置Bean覆盖和循环依赖-customizeBeanFactory"><a href="#配置Bean覆盖和循环依赖-customizeBeanFactory" class="headerlink" title="配置Bean覆盖和循环依赖 customizeBeanFactory"></a>配置Bean覆盖和循环依赖 customizeBeanFactory</h4><p>配置bean是否允许覆盖，是否允许循环依赖</p>
<p>&#x2F;&#x2F;AbstractRefreshableApplicationContext 224</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizeBeanFactory</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">  <span class="comment">//配置是否允许覆盖</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.allowBeanDefinitionOverriding != <span class="literal">null</span>) &#123;</span><br><span class="line">    beanFactory.setAllowBeanDefinitionOverriding(<span class="built_in">this</span>.allowBeanDefinitionOverriding);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//配置是否允许循环引用</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">this</span>.allowCircularReferences != <span class="literal">null</span>) &#123;</span><br><span class="line">    beanFactory.setAllowCircularReferences(<span class="built_in">this</span>.allowCircularReferences);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BeanDefinition的覆盖，在配置文件定义了多个相同的id或name的时候，如果不配置允许覆盖，那么系统会报错，但是在多个配置文件中，系统不会报错，会进行覆盖。</p>
<p>循环覆盖，默认Spring是允许的，但是不能在构造方法种循环依赖，那么就会报错。</p>
<h4 id="加载Bean-loadBeanDefinitions"><a href="#加载Bean-loadBeanDefinitions" class="headerlink" title="加载Bean loadBeanDefinitions"></a>加载Bean loadBeanDefinitions</h4><p><code>loadBeanDefinitions</code>这个方法是最重要的方法了，这个方法将配置读出来，加载各个Bean，放到BeanFactory中，读取和解析配置文件的操作在<code>XmlBeanDefinitionReader</code>类中。</p>
<p>&#x2F;&#x2F; AbstractXmlApplicationContext 81</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(DefaultListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException, IOException &#123;</span><br><span class="line">  <span class="comment">// Create a new XmlBeanDefinitionReader for the given BeanFactory.</span></span><br><span class="line">  <span class="type">XmlBeanDefinitionReader</span> <span class="variable">beanDefinitionReader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlBeanDefinitionReader</span>(beanFactory);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Configure the bean definition reader with this context&#x27;s</span></span><br><span class="line">  <span class="comment">// resource loading environment.</span></span><br><span class="line">  beanDefinitionReader.setEnvironment(<span class="built_in">this</span>.getEnvironment());</span><br><span class="line">  beanDefinitionReader.setResourceLoader(<span class="built_in">this</span>);</span><br><span class="line">  beanDefinitionReader.setEntityResolver(<span class="keyword">new</span> <span class="title class_">ResourceEntityResolver</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化BeanDefinitionReader，提供给子类覆盖</span></span><br><span class="line">  initBeanDefinitionReader(beanDefinitionReader);</span><br><span class="line">  <span class="comment">//开始读定义，继续跳进去</span></span><br><span class="line">  loadBeanDefinitions(beanDefinitionReader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F; AbstractXmlApplicationContext 121</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 两个分支，但第二个分支转换为Resource之后，会跟上面到一个函数中</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(XmlBeanDefinitionReader reader)</span> <span class="keyword">throws</span> BeansException, IOException &#123;</span><br><span class="line">  Resource[] configResources = getConfigResources();</span><br><span class="line">  <span class="keyword">if</span> (configResources != <span class="literal">null</span>) &#123;</span><br><span class="line">    reader.loadBeanDefinitions(configResources);</span><br><span class="line">  &#125;</span><br><span class="line">  String[] configLocations = getConfigLocations();</span><br><span class="line">  <span class="keyword">if</span> (configLocations != <span class="literal">null</span>) &#123;</span><br><span class="line">    reader.loadBeanDefinitions(configLocations);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 上面虽然有两个分支，不过第二个分支很快通过解析路径转换为 Resource 以后也会进到这里</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(Resource... resources)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   Assert.notNull(resources, <span class="string">&quot;Resource array must not be null&quot;</span>);</span><br><span class="line">   <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">   <span class="comment">// 注意这里是个 for 循环，也就是每个文件是一个 resource</span></span><br><span class="line">   <span class="keyword">for</span> (Resource resource : resources) &#123;</span><br><span class="line">      <span class="comment">// 继续往下看</span></span><br><span class="line">      counter += loadBeanDefinitions(resource);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 最后返回 counter，表示总共加载了多少的 BeanDefinition</span></span><br><span class="line">   <span class="keyword">return</span> counter;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XmlBeanDefinitionReader 303</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   <span class="keyword">return</span> loadBeanDefinitions(<span class="keyword">new</span> <span class="title class_">EncodedResource</span>(resource));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XmlBeanDefinitionReader 314</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">loadBeanDefinitions</span><span class="params">(EncodedResource encodedResource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">   Assert.notNull(encodedResource, <span class="string">&quot;EncodedResource must not be null&quot;</span>);</span><br><span class="line">   <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;Loading XML bean definitions from &quot;</span> + encodedResource.getResource());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 用一个 ThreadLocal 来存放配置文件资源</span></span><br><span class="line">  <span class="comment">//private final ThreadLocal&lt;Set&lt;EncodedResource&gt;&gt; resourcesCurrentlyBeingLoaded =</span></span><br><span class="line">  <span class="comment">//			new NamedThreadLocal&lt;&gt;(&quot;XML bean definition resources currently being loaded&quot;);</span></span><br><span class="line">   Set&lt;EncodedResource&gt; currentResources = <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.get();</span><br><span class="line">  </span><br><span class="line">   <span class="keyword">if</span> (currentResources == <span class="literal">null</span>) &#123;</span><br><span class="line">      currentResources = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;EncodedResource&gt;(<span class="number">4</span>);</span><br><span class="line">      <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.set(currentResources);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (!currentResources.add(encodedResource)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(</span><br><span class="line">            <span class="string">&quot;Detected cyclic loading of &quot;</span> + encodedResource + <span class="string">&quot; - check your import definitions!&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> encodedResource.getResource().getInputStream();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="type">InputSource</span> <span class="variable">inputSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InputSource</span>(inputStream);</span><br><span class="line">         <span class="keyword">if</span> (encodedResource.getEncoding() != <span class="literal">null</span>) &#123;</span><br><span class="line">            inputSource.setEncoding(encodedResource.getEncoding());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 核心部分是这里，往下面看</span></span><br><span class="line">         <span class="keyword">return</span> doLoadBeanDefinitions(inputSource, encodedResource.getResource());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">finally</span> &#123;</span><br><span class="line">         inputStream.close();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(</span><br><span class="line">            <span class="string">&quot;IOException parsing XML document from &quot;</span> + encodedResource.getResource(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">finally</span> &#123;</span><br><span class="line">      currentResources.remove(encodedResource);</span><br><span class="line">      <span class="keyword">if</span> (currentResources.isEmpty()) &#123;</span><br><span class="line">         <span class="built_in">this</span>.resourcesCurrentlyBeingLoaded.remove();</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XmlBeanDefinitionReader 388</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">doLoadBeanDefinitions</span><span class="params">(InputSource inputSource, Resource resource)</span></span><br><span class="line">  <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 将xml转换为document对象</span></span><br><span class="line">    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> doLoadDocument(inputSource, resource);</span><br><span class="line">    <span class="keyword">return</span> registerBeanDefinitions(doc, resource);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (...)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// XmlBeanDefinitionReader 505</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(Document doc, Resource resource)</span> <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line">  <span class="type">BeanDefinitionDocumentReader</span> <span class="variable">documentReader</span> <span class="operator">=</span> createBeanDefinitionDocumentReader();</span><br><span class="line">  <span class="type">int</span> <span class="variable">countBefore</span> <span class="operator">=</span> getRegistry().getBeanDefinitionCount();</span><br><span class="line">  <span class="comment">// 把读出来的配置信息，解析成BeanDefinition</span></span><br><span class="line">  documentReader.registerBeanDefinitions(doc, createReaderContext(resource));</span><br><span class="line">  <span class="comment">//返回从当前文件加载了多少的Bean</span></span><br><span class="line">  <span class="keyword">return</span> getRegistry().getBeanDefinitionCount() - countBefore;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DefaultBeanDefinitionDocumentReader.java:94</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(Document doc, XmlReaderContext readerContext)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.readerContext = readerContext;</span><br><span class="line">  logger.debug(<span class="string">&quot;Loading bean definitions&quot;</span>);</span><br><span class="line">  <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> doc.getDocumentElement();</span><br><span class="line">  <span class="comment">//从根节点开始解析</span></span><br><span class="line">  doRegisterBeanDefinitions(root);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时的xml文件已经被解析成了一棵dom树，下面开始解析内容</p>
<p>DefaultBeanDefinitionDocumentReader.java:122</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doRegisterBeanDefinitions</span><span class="params">(Element root)</span> &#123;</span><br><span class="line">	<span class="comment">// 因为&lt;beans&gt;内部还可以定义&lt;beans&gt;，因此定义父节点</span></span><br><span class="line">   <span class="comment">// 当前的根节点可能只是嵌套在内部的根节点，因此要从最外面的根节点开始解析</span></span><br><span class="line">	<span class="type">BeanDefinitionParserDelegate</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="built_in">this</span>.delegate;</span><br><span class="line">	<span class="built_in">this</span>.delegate = createDelegate(getReaderContext(), root, parent);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">this</span>.delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">     <span class="comment">// 检查xml配置中的&lt;beans ... profile=&quot;dev&quot; /&gt; ，其中profile是不是当前的环境</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">profileSpec</span> <span class="operator">=</span> root.getAttribute(PROFILE_ATTRIBUTE);</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(profileSpec)) &#123;</span><br><span class="line">			String[] specifiedProfiles = StringUtils.tokenizeToStringArray(</span><br><span class="line">					profileSpec, BeanDefinitionParserDelegate.MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">			<span class="keyword">if</span> (!getReaderContext().getEnvironment().acceptsProfiles(specifiedProfiles)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">					logger.info(<span class="string">&quot;Skipped XML bean definition file due to specified profiles [&quot;</span> + profileSpec +</span><br><span class="line">							<span class="string">&quot;] not matching: &quot;</span> + getReaderContext().getResource());</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	preProcessXml(root);<span class="comment">//钩子方法</span></span><br><span class="line">   <span class="comment">//继续跳进去</span></span><br><span class="line">	parseBeanDefinitions(root, <span class="built_in">this</span>.delegate);</span><br><span class="line">	postProcessXml(root);<span class="comment">//钩子方法</span></span><br><span class="line">   <span class="comment">//两个钩子方法是用于处理xml文件，给子类覆盖之后实现的</span></span><br><span class="line"></span><br><span class="line">	<span class="built_in">this</span>.delegate = parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续往下看parseBeanDefinitions方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// DefaultBeanDefinitionDocumentReader.java 186</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">parseBeanDefinitions</span><span class="params">(Element root, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (delegate.isDefaultNamespace(root)) &#123;</span><br><span class="line">    <span class="type">NodeList</span> <span class="variable">nl</span> <span class="operator">=</span> root.getChildNodes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nl.getLength(); i++) &#123;</span><br><span class="line">      <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> nl.item(i);</span><br><span class="line">      <span class="keyword">if</span> (node <span class="keyword">instanceof</span> Element) &#123;</span><br><span class="line">        <span class="type">Element</span> <span class="variable">ele</span> <span class="operator">=</span> (Element) node;</span><br><span class="line">        <span class="keyword">if</span> (delegate.isDefaultNamespace(ele)) &#123;</span><br><span class="line">          <span class="comment">// 解析default的element</span></span><br><span class="line">          parseDefaultElement(ele, delegate);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 解析custom element</span></span><br><span class="line">          delegate.parseCustomElement(ele);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    delegate.parseCustomElement(root);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，最终要么解析default的element，要么解析custom的element</p>
<p>default element包括<code>&lt;import /&gt;</code>、<code>&lt;alias/&gt;</code>、<code>&lt;bean /&gt;</code>、<code>&lt;beans/&gt;</code>这四个</p>
<p>这里的四个标签之所以是 <strong>default</strong> 的，是因为它们是处于这个 namespace 下定义的：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http://www.springframework.org/schema/beans</span><br></pre></td></tr></table></figure>

<p>而对于其他的标签，将进入到 delegate.parseCustomElement(element) 这个分支。如我们经常会使用到的 <code>&lt;mvc /&gt;</code>、<code>&lt;task /&gt;</code>、<code>&lt;context /&gt;</code>、<code>&lt;aop /&gt;</code>等</p>
<p>有了这些custom的element，也要在xml的name space中加入对应的内容，比如mvc的是</p>
<p><code>      xmlns:mvc=&quot;http://www.springframework.org/schema/mvc&quot;</code></p>
<p>同时代码中要提供对应的parser来解析，比如有MvcNamespaceHandler、TaskNamespaceHandler、ContextNamespaceHandler、AopNamespaceHandler等解析类。</p>
<p>继续往下看看，对于default标签的处理方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseDefaultElement</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">  <span class="comment">//解析&lt;import/&gt;标签</span></span><br><span class="line">  <span class="keyword">if</span> (delegate.nodeNameEquals(ele, IMPORT_ELEMENT)) &#123;</span><br><span class="line">    importBeanDefinitionResource(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析&lt;alias/&gt;标签</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, ALIAS_ELEMENT)) &#123;</span><br><span class="line">    processAliasRegistration(ele);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析&lt;bean/&gt;标签</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, BEAN_ELEMENT)) &#123;</span><br><span class="line">    processBeanDefinition(ele, delegate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 解析&lt;beans/&gt; 标签，递归进行</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (delegate.nodeNameEquals(ele, NESTED_BEANS_ELEMENT)) &#123;</span><br><span class="line">    <span class="comment">// recurse</span></span><br><span class="line">    doRegisterBeanDefinitions(ele);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>挑选其中比较重要的bean标签进行分析</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">  <span class="comment">// 把&lt;bean/&gt;标签内容读出来，放在BeanDefinitionHolder中</span></span><br><span class="line">  <span class="type">BeanDefinitionHolder</span> <span class="variable">bdHolder</span> <span class="operator">=</span> delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">  <span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">    bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Register the final decorated instance.</span></span><br><span class="line">      BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">      getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +</span><br><span class="line">                               bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Send registration event.</span></span><br><span class="line">    getReaderContext().fireComponentRegistered(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(bdHolder));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>&lt;bean/&gt;</code>标签当中包含以下内容</p>
<table>
<thead>
<tr>
<th>Property</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>class</td>
<td>类的全限定名</td>
</tr>
<tr>
<td>name</td>
<td>可指定 id、name(用逗号、分号、空格分隔)</td>
</tr>
<tr>
<td>scope</td>
<td>作用域</td>
</tr>
<tr>
<td>constructor arguments</td>
<td>指定构造参数</td>
</tr>
<tr>
<td>properties</td>
<td>设置属性的值</td>
</tr>
<tr>
<td>autowiring mode</td>
<td>no(默认值)、byName、byType、 constructor</td>
</tr>
<tr>
<td>lazy-initialization mode</td>
<td>是否懒加载(如果被非懒加载的bean依赖了那么其实也就不能懒加载了)</td>
</tr>
<tr>
<td>initialization method</td>
<td>bean 属性设置完成后，会调用这个方法</td>
</tr>
<tr>
<td>destruction method</td>
<td>bean 销毁后的回调方法</td>
</tr>
</tbody></table>
<p>举个例子：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;exampleBean&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name1, name2, name3&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.ExampleBean&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">scope</span>=<span class="string">&quot;singleton&quot;</span> <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;cleanup&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 可以用下面三种形式指定构造参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;years&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">index</span>=<span class="string">&quot;0&quot;</span> <span class="attr">value</span>=<span class="string">&quot;7500000&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- property 的几种情况 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beanOne&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;anotherExampleBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;beanTwo&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;yetAnotherBean&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;integerProperty&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>当然，除了上述的内容外，还包含factory-bean、factory-method、<code>&lt;lockup-method /&gt;</code>（计算一个函数 返回的是null，但函数会返回声明的空类型）、<code>&lt;replaced-method /&gt;</code>、<code>&lt;meta /&gt;</code>、 <code>&lt;qualifier/&gt;</code>这几个。</p>
<p>继续往下看bean的配置是如何被解析出来的：</p>
<p>&#x2F;&#x2F; BeanDefinitionParserDelegate.java 404</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> BeanDefinitionHolder <span class="title function_">parseBeanDefinitionElement</span><span class="params">(Element ele)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> parseBeanDefinitionElement(ele, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// BeanDefinitionParserDelegate.java 414</span></span><br><span class="line"><span class="keyword">public</span> BeanDefinitionHolder <span class="title function_">parseBeanDefinitionElement</span><span class="params">(Element ele, <span class="meta">@Nullable</span> BeanDefinition containingBean)</span> &#123;</span><br><span class="line">  <span class="comment">// 获取id</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">id</span> <span class="operator">=</span> ele.getAttribute(ID_ATTRIBUTE);</span><br><span class="line">  <span class="comment">// 获取name</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">nameAttr</span> <span class="operator">=</span> ele.getAttribute(NAME_ATTRIBUTE);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//因为alias可以有多个，所以用list放</span></span><br><span class="line">  <span class="comment">// 别名的配置方式为：</span></span><br><span class="line">  <span class="comment">//&lt;bean id=&quot;messageService&quot; name=&quot;m1, m2, m3&quot; class=&quot;com.javadoop.example.MessageServiceImpl&quot;&gt;，name就是别名，用都好分割，此时有三个别名</span></span><br><span class="line">  List&lt;String&gt; aliases = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">if</span> (StringUtils.hasLength(nameAttr)) &#123;</span><br><span class="line">    String[] nameArr = StringUtils.tokenizeToStringArray(nameAttr, MULTI_VALUE_ATTRIBUTE_DELIMITERS);</span><br><span class="line">    aliases.addAll(Arrays.asList(nameArr));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果没有指定id，那么就用别名的第一个作为id</span></span><br><span class="line">  <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> id;</span><br><span class="line">  <span class="keyword">if</span> (!StringUtils.hasText(beanName) &amp;&amp; !aliases.isEmpty()) &#123;</span><br><span class="line">    beanName = aliases.remove(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;No XML &#x27;id&#x27; specified - using &#x27;&quot;</span> + beanName +</span><br><span class="line">                   <span class="string">&quot;&#x27; as bean name and &quot;</span> + aliases + <span class="string">&quot; as aliases&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//检查名字是否重复</span></span><br><span class="line">  <span class="keyword">if</span> (containingBean == <span class="literal">null</span>) &#123;</span><br><span class="line">    checkNameUniqueness(beanName, aliases, ele);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//根据xml的配置，将配置信息放到BeanDefinition中，下面继续跳入该方法</span></span><br><span class="line">  <span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> parseBeanDefinitionElement(ele, beanName, containingBean);</span><br><span class="line">  <span class="keyword">if</span> (beanDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 又没有id又没有name，那么系统将生成一个名字</span></span><br><span class="line">    <span class="keyword">if</span> (!StringUtils.hasText(beanName)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//原先有bean，那么对bean生成名字，包含父类名加上&quot;$child&quot;这种形式</span></span><br><span class="line">        <span class="keyword">if</span> (containingBean != <span class="literal">null</span>) &#123;</span><br><span class="line">          beanName = BeanDefinitionReaderUtils.generateBeanName(</span><br><span class="line">            beanDefinition, <span class="built_in">this</span>.readerContext.getRegistry(), <span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;          </span><br><span class="line">          <span class="comment">//原先有bean，那么对bean直接命名</span></span><br><span class="line">          beanName = <span class="built_in">this</span>.readerContext.generateBeanName(beanDefinition);</span><br><span class="line">          <span class="comment">// Register an alias for the plain bean class name, if still possible,</span></span><br><span class="line">          <span class="comment">// if the generator returned the class name plus a suffix.</span></span><br><span class="line">          <span class="comment">// This is expected for Spring 1.2/2.0 backwards compatibility.</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">beanClassName</span> <span class="operator">=</span> beanDefinition.getBeanClassName();</span><br><span class="line">          <span class="keyword">if</span> (beanClassName != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">              beanName.startsWith(beanClassName) &amp;&amp; beanName.length() &gt; beanClassName.length() &amp;&amp;</span><br><span class="line">              !<span class="built_in">this</span>.readerContext.getRegistry().isBeanNameInUse(beanClassName)) &#123;</span><br><span class="line">            aliases.add(beanClassName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;Neither XML &#x27;id&#x27; nor &#x27;name&#x27; specified - &quot;</span> +</span><br><span class="line">                       <span class="string">&quot;using generated bean name [&quot;</span> + beanName + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">        error(ex.getMessage(), ele);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    String[] aliasesArray = StringUtils.toStringArray(aliases);</span><br><span class="line">    <span class="comment">// 返回BeanDefinitionHolder</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDefinition, beanName, aliasesArray);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>来看看parseBeanDefinitionElement方法是怎么创建BeanDefinition的</p>
<p>&#x2F;&#x2F; BeanDefinitionParserDelegate.java 500</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public AbstractBeanDefinition parseBeanDefinitionElement(</span><br><span class="line">      Element ele, String beanName, @Nullable BeanDefinition containingBean) &#123;</span><br><span class="line"></span><br><span class="line">   this.parseState.push(new BeanEntry(beanName));</span><br><span class="line"></span><br><span class="line">   String className = null;</span><br><span class="line">   // 解析class</span><br><span class="line">   if (ele.hasAttribute(CLASS_ATTRIBUTE)) &#123;</span><br><span class="line">      className = ele.getAttribute(CLASS_ATTRIBUTE).trim();</span><br><span class="line">   &#125;</span><br><span class="line">   String parent = null;</span><br><span class="line">   //解析parent</span><br><span class="line">   if (ele.hasAttribute(PARENT_ATTRIBUTE)) &#123;</span><br><span class="line">      parent = ele.getAttribute(PARENT_ATTRIBUTE);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   try &#123;</span><br><span class="line">      AbstractBeanDefinition bd = createBeanDefinition(className, parent);</span><br><span class="line"></span><br><span class="line">      parseBeanDefinitionAttributes(ele, beanName, containingBean, bd);</span><br><span class="line">      bd.setDescription(DomUtils.getChildElementValueByTagName(ele, DESCRIPTION_ELEMENT));</span><br><span class="line">      // 解析 &lt;meta /&gt;</span><br><span class="line">      parseMetaElements(ele, bd);      </span><br><span class="line">      // 解析 &lt;lookup-method /&gt;</span><br><span class="line">      parseLookupOverrideSubElements(ele, bd.getMethodOverrides());</span><br><span class="line">      // 解析 &lt;replaced-method /&gt;</span><br><span class="line">      parseReplacedMethodSubElements(ele, bd.getMethodOverrides());</span><br><span class="line"></span><br><span class="line">			// 解析 &lt;constructor-arg /&gt;</span><br><span class="line">      parseConstructorArgElements(ele, bd);</span><br><span class="line">      // 解析 &lt;property /&gt;</span><br><span class="line">      parsePropertyElements(ele, bd);</span><br><span class="line">      // 解析 &lt;qualifier /&gt;</span><br><span class="line">      parseQualifierElements(ele, bd);</span><br><span class="line"></span><br><span class="line">      bd.setResource(this.readerContext.getResource());</span><br><span class="line">      bd.setSource(extractSource(ele));</span><br><span class="line"></span><br><span class="line">      return bd;</span><br><span class="line">   &#125;</span><br><span class="line">   catch (ClassNotFoundException ex) &#123;</span><br><span class="line">      error(&quot;Bean class [&quot; + className + &quot;] not found&quot;, ele, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   catch (NoClassDefFoundError err) &#123;</span><br><span class="line">      error(&quot;Class that bean class [&quot; + className + &quot;] depends on not found&quot;, ele, err);</span><br><span class="line">   &#125;</span><br><span class="line">   catch (Throwable ex) &#123;</span><br><span class="line">      error(&quot;Unexpected failure during bean definition parsing&quot;, ele, ex);</span><br><span class="line">   &#125;</span><br><span class="line">   finally &#123;</span><br><span class="line">      this.parseState.pop();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   return null;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时一个BeanDefinitionHolder就创建完成了，回到需要BeandefinitionHolder的地方</p>
<p>&#x2F;&#x2F; DefaultBeanDefinitionDocumentReader.java:319</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">processBeanDefinition</span><span class="params">(Element ele, BeanDefinitionParserDelegate delegate)</span> &#123;</span><br><span class="line">   <span class="type">BeanDefinitionHolder</span> <span class="variable">bdHolder</span> <span class="operator">=</span> delegate.parseBeanDefinitionElement(ele);</span><br><span class="line">   <span class="keyword">if</span> (bdHolder != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="comment">// 解析自定义属性，不展开</span></span><br><span class="line">      bdHolder = delegate.decorateBeanDefinitionIfRequired(ele, bdHolder);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">// 注册Bean</span></span><br><span class="line">         BeanDefinitionReaderUtils.registerBeanDefinition(bdHolder, getReaderContext().getRegistry());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (BeanDefinitionStoreException ex) &#123;</span><br><span class="line">         getReaderContext().error(<span class="string">&quot;Failed to register bean definition with name &#x27;&quot;</span> +</span><br><span class="line">               bdHolder.getBeanName() + <span class="string">&quot;&#x27;&quot;</span>, ele, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 发送注册事件，本文不展开</span></span><br><span class="line">      getReaderContext().fireComponentRegistered(<span class="keyword">new</span> <span class="title class_">BeanComponentDefinition</span>(bdHolder));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时得到的BeanDefinitionHolder包含三部分：BeanDefinition、beanName、aliases</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanDefinitionHolder</span> <span class="keyword">implements</span> <span class="title class_">BeanMetadataElement</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> BeanDefinition beanDefinition;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String beanName;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String[] aliases;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h4 id="注册Bean"><a href="#注册Bean" class="headerlink" title="注册Bean"></a>注册Bean</h4><p>&#x2F;&#x2F; BeanDefinitionReaderUtils.java:144</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(</span></span><br><span class="line"><span class="params">      BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span></span><br><span class="line">      <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Register bean definition under primary name.</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> definitionHolder.getBeanName();</span><br><span class="line">  <span class="comment">//注册Bean</span></span><br><span class="line">   registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果有别名，也都注册一遍</span></span><br><span class="line">   String[] aliases = definitionHolder.getAliases();</span><br><span class="line">   <span class="keyword">if</span> (aliases != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (String alias : aliases) &#123;</span><br><span class="line">        <span class="comment">//保存一个alias-&gt;beanName的map，找的时候，先从alias到beanName，然后去查找</span></span><br><span class="line">         registry.registerAlias(beanName, alias);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;&#x2F; DefaultListableBeanFactory.java:788</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span><br><span class="line">  <span class="keyword">throws</span> BeanDefinitionStoreException &#123;</span><br><span class="line"></span><br><span class="line">  Assert.hasText(beanName, <span class="string">&quot;Bean name must not be empty&quot;</span>);</span><br><span class="line">  Assert.notNull(beanDefinition, <span class="string">&quot;BeanDefinition must not be null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//验证beanDefinition的有效性</span></span><br><span class="line">  <span class="keyword">if</span> (beanDefinition <span class="keyword">instanceof</span> AbstractBeanDefinition) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ((AbstractBeanDefinition) beanDefinition).validate();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(beanDefinition.getResourceDescription(), beanName,</span><br><span class="line">                                             <span class="string">&quot;Validation of bean definition failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否允许覆盖</span></span><br><span class="line">  <span class="type">BeanDefinition</span> <span class="variable">existingDefinition</span> <span class="operator">=</span> <span class="built_in">this</span>.beanDefinitionMap.get(beanName);</span><br><span class="line">  <span class="keyword">if</span> (existingDefinition != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">//不允许覆盖的情况，抛异常</span></span><br><span class="line">    <span class="keyword">if</span> (!isAllowBeanDefinitionOverriding()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (existingDefinition.getRole() &lt; beanDefinition.getRole()) &#123;</span><br><span class="line">      <span class="comment">// 用框架生成的beandefinition覆盖用户的beanDefinition</span></span><br><span class="line">      <span class="comment">// log()</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!beanDefinition.equals(existingDefinition)) &#123;</span><br><span class="line">      <span class="comment">//用新bean替换旧bean</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 用同等bean覆盖旧bean，这里同等指的是equals方法返回为true的bean</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//覆盖</span></span><br><span class="line">    <span class="built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//判断是否有bean已经在初始化了</span></span><br><span class="line">    <span class="keyword">if</span> (hasBeanCreationStarted()) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>.beanDefinitionMap) &#123;</span><br><span class="line">        <span class="built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">        List&lt;String&gt; updatedDefinitions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.beanDefinitionNames.size() + <span class="number">1</span>);</span><br><span class="line">        updatedDefinitions.addAll(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line">        updatedDefinitions.add(beanName);</span><br><span class="line">        <span class="built_in">this</span>.beanDefinitionNames = updatedDefinitions;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.manualSingletonNames.contains(beanName)) &#123;</span><br><span class="line">          Set&lt;String&gt; updatedSingletons = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(<span class="built_in">this</span>.manualSingletonNames);</span><br><span class="line">          updatedSingletons.remove(beanName);</span><br><span class="line">          <span class="built_in">this</span>.manualSingletonNames = updatedSingletons;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Still in startup registration phase</span></span><br><span class="line">      <span class="comment">//放到beanDefinitionMap里面，beanName-&gt;beanDefinition的map</span></span><br><span class="line">      <span class="built_in">this</span>.beanDefinitionMap.put(beanName, beanDefinition);</span><br><span class="line">      <span class="comment">//按照bean初始化顺序放所有的beanName</span></span><br><span class="line">      <span class="built_in">this</span>.beanDefinitionNames.add(beanName);</span><br><span class="line">      <span class="comment">//到这个分支的肯定不需要手动注册了，那么就从手动初始化的map中移除</span></span><br><span class="line">      <span class="comment">//有些系统自带的bean需要spring手动注册，比如&quot;environment&quot;、&quot;systemProperties&quot;</span></span><br><span class="line">      <span class="comment">// 手动注册需要调用registerSingleton(String beanName, Object singletonObject)方法</span></span><br><span class="line">      <span class="built_in">this</span>.manualSingletonNames.remove(beanName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">this</span>.frozenBeanDefinitionNames = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (existingDefinition != <span class="literal">null</span> || containsSingleton(beanName)) &#123;</span><br><span class="line">    resetBeanDefinition(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结一下，到目前为止，已经初始化了BeanFactory，<code>&lt;bean/&gt;</code>配置也转化成了 一个个beanDefinition，注册了BeanDefinition到注册中心，发送了注册事件。</p>
<h3 id="BeanFactory实例化完成后"><a href="#BeanFactory实例化完成后" class="headerlink" title="BeanFactory实例化完成后"></a>BeanFactory实例化完成后</h3><p>到这里，我们回到refresh方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//AbstractApplicationContext 516</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">refresh</span><span class="params">()</span> <span class="keyword">throws</span> BeansException, IllegalStateException &#123;</span><br><span class="line">		<span class="keyword">synchronized</span> (<span class="built_in">this</span>.startupShutdownMonitor) &#123;</span><br><span class="line">      <span class="comment">//记录开始时间,设置状态为开始创建,关闭状态设为false</span></span><br><span class="line">			prepareRefresh();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 最重要的步骤,这里之后就获取到了BeanFactory了</span></span><br><span class="line">      <span class="comment">// 把所有bean的信息都提取出来，注册到beanFactory里面，这里的bean还没有初始化</span></span><br><span class="line">      <span class="comment">// 提取出来的信息是beanName-&gt; beanDefination的map</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//！！！注意！！！，此时已经拿到了BeanFactory了</span></span><br><span class="line">			<span class="type">ConfigurableListableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> obtainFreshBeanFactory();</span><br><span class="line"></span><br><span class="line">      <span class="comment">//设置BeanFactory的类加载器，手动注册特殊的bean，跳进去继续看</span></span><br><span class="line">			prepareBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//BeanFactoryPostProcessor的处理</span></span><br><span class="line">        <span class="comment">//点进去看到方法是protected的空函数，主要是给子类继承来处理BeanFactory的</span></span><br><span class="line">				postProcessBeanFactory(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//调用 BeanFactoryPostProcessor 各个实现类的 postProcessBeanFactory(factory) 方法</span></span><br><span class="line">				invokeBeanFactoryPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//注册BeanPostProcessor</span></span><br><span class="line">				registerBeanPostProcessors(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 初始化MessageSource，用于国际化，不涉及就不说了</span></span><br><span class="line">				initMessageSource();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 初始化ApplicationContext的时间广播器，不展开说了</span></span><br><span class="line">				initApplicationEventMulticaster();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 从方法名能看出来，钩子方法</span></span><br><span class="line">        <span class="comment">// 子类可以在这里初始化一些特殊的Bean(初始化Singleton Beans之前)</span></span><br><span class="line">				onRefresh();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 注册时间监听器,不展开</span></span><br><span class="line">				registerListeners();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 实例化所有非lazy-init的singleton beans</span></span><br><span class="line">				finishBeanFactoryInitialization(beanFactory);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 广播事件，ApplicaitonContext初始化完成</span></span><br><span class="line">				finishRefresh();</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">				<span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">					logger.warn(<span class="string">&quot;Exception encountered during context initialization - &quot;</span> +</span><br><span class="line">							<span class="string">&quot;cancelling refresh attempt: &quot;</span> + ex);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// 销毁已经创建的singleton beans，以免资源占用</span></span><br><span class="line">				destroyBeans();</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Reset &#x27;active&#x27; flag.</span></span><br><span class="line">				cancelRefresh(ex);</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Propagate exception to caller.</span></span><br><span class="line">				<span class="keyword">throw</span> ex;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">finally</span> &#123;</span><br><span class="line">				<span class="comment">// Reset common introspection caches in Spring&#x27;s core, since we</span></span><br><span class="line">				<span class="comment">// might not ever need metadata for singleton beans anymore...</span></span><br><span class="line">        <span class="comment">//释放bean描述器的缓存</span></span><br><span class="line">				resetCommonCaches();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们看看prepareBeanFactory()方法</p>
<p>&#x2F;&#x2F; AbstractApplicationContext.java:634</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">prepareBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">  <span class="comment">// 设置BeanFactory的类加载器，这里设置为当前ApplicationContext的类加载器</span></span><br><span class="line">  beanFactory.setBeanClassLoader(getClassLoader());</span><br><span class="line">  <span class="comment">// 设置 BeanExpressionResolver</span></span><br><span class="line">  beanFactory.setBeanExpressionResolver(<span class="keyword">new</span> <span class="title class_">StandardBeanExpressionResolver</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">  beanFactory.addPropertyEditorRegistrar(<span class="keyword">new</span> <span class="title class_">ResourceEditorRegistrar</span>(<span class="built_in">this</span>, getEnvironment()));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加BeanPostProcessor，这里加的是ApplicationContextAware的Processor。</span></span><br><span class="line">   <span class="comment">// 注意：它不仅仅回调 ApplicationContextAware，</span></span><br><span class="line">   <span class="comment">//   还会负责回调 EnvironmentAware、ResourceLoaderAware 等，看下源码就清楚了</span></span><br><span class="line">  beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationContextAwareProcessor</span>(<span class="built_in">this</span>));</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//如果bean依赖下面几个接口的实现类，会在这里忽略掉，用其他方式来处理这些依赖</span></span><br><span class="line">  beanFactory.ignoreDependencyInterface(EnvironmentAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(MessageSourceAware.class);</span><br><span class="line">  beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 几个特殊bean的赋值</span></span><br><span class="line">  beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);</span><br><span class="line">  beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="built_in">this</span>);</span><br><span class="line">  beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="built_in">this</span>);</span><br><span class="line">  beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 这个 BeanPostProcessor 处理：如果是 ApplicationListener 的子类，</span></span><br><span class="line">   <span class="comment">// 那么将其添加到 listener 列表中，可以理解成：注册 事件监听器</span></span><br><span class="line">   beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">ApplicationListenerDetector</span>(<span class="built_in">this</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// LoadTimeWeaver是AspectJ当中的运行器织入，这里不深究</span></span><br><span class="line">  <span class="keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.addBeanPostProcessor(<span class="keyword">new</span> <span class="title class_">LoadTimeWeaverAwareProcessor</span>(beanFactory));</span><br><span class="line">    <span class="comment">// Set a temporary ClassLoader for type matching.</span></span><br><span class="line">    beanFactory.setTempClassLoader(<span class="keyword">new</span> <span class="title class_">ContextTypeMatchClassLoader</span>(beanFactory.getBeanClassLoader()));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Spring注册的默认的几个bean，包括ENVIRONMENT，SYSTEM_PROPERTIES，SYSTEM_ENVIRONMENT</span></span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) &#123;</span><br><span class="line">    beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="初始化所有的-singleton-beans"><a href="#初始化所有的-singleton-beans" class="headerlink" title="初始化所有的 singleton beans"></a>初始化所有的 singleton beans</h3><p>回到refresh函数中，上面的一系列处理postProcessor和awareProcessor的内容处理完之后，就到了				finishBeanFactoryInitialization(beanFactory)方法，这个方法就是真正的实例化singleton bean了</p>
<p>&#x2F;&#x2F; AbstractApplicationContext.java:841</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finishBeanFactoryInitialization</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> &#123;</span><br><span class="line">	<span class="comment">// 初始化名字为conversionService的Bean，用于convert前端传输的内容</span></span><br><span class="line">	<span class="keyword">if</span> (beanFactory.containsBean(CONVERSION_SERVICE_BEAN_NAME) &amp;&amp;</span><br><span class="line">			beanFactory.isTypeMatch(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class)) &#123;</span><br><span class="line">		beanFactory.setConversionService(</span><br><span class="line">				beanFactory.getBean(CONVERSION_SERVICE_BEAN_NAME, ConversionService.class));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Register a default embedded value resolver if no bean post-processor</span></span><br><span class="line">	<span class="comment">// (such as a PropertyPlaceholderConfigurer bean) registered any before:</span></span><br><span class="line">	<span class="comment">// at this point, primarily for resolution in annotation attribute values.</span></span><br><span class="line">	<span class="keyword">if</span> (!beanFactory.hasEmbeddedValueResolver()) &#123;</span><br><span class="line">		beanFactory.addEmbeddedValueResolver(strVal -&gt; getEnvironment().resolvePlaceholders(strVal));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//与loadTimeWaver相关的内容，跳过</span></span><br><span class="line">	String[] weaverAwareNames = beanFactory.getBeanNamesForType(LoadTimeWeaverAware.class, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">for</span> (String weaverAwareName : weaverAwareNames) &#123;</span><br><span class="line">		getBean(weaverAwareName);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Stop using the temporary ClassLoader for type matching.</span></span><br><span class="line">	beanFactory.setTempClassLoader(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// spring准备初始化bean了，要进制bean定义解析，加载，注册</span></span><br><span class="line">	beanFactory.freezeConfiguration();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 开始注册</span></span><br><span class="line">	beanFactory.preInstantiateSingletons();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>继续preInstantiateSingletons函数，又回到了DefaultListableBeanFactory方法</p>
<p>&#x2F;&#x2F;DefaultListableBeanFactory 726</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">preInstantiateSingletons</span><span class="params">()</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Pre-instantiating singletons in &quot;</span> + <span class="built_in">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// beanDefinitionNames保存了所有需要注册的beanNames</span></span><br><span class="line">  List&lt;String&gt; beanNames = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(<span class="built_in">this</span>.beanDefinitionNames);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 触发所有非懒加载的singleton beans的初始化操作</span></span><br><span class="line">  <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">    <span class="comment">// 处理 FactoryBean</span></span><br><span class="line">    <span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">    <span class="keyword">if</span> (!bd.isAbstract() &amp;&amp; bd.isSingleton() &amp;&amp; !bd.isLazyInit()) &#123;</span><br><span class="line">      <span class="comment">// 处理FactoryBean</span></span><br><span class="line">      <span class="keyword">if</span> (isFactoryBean(beanName)) &#123;</span><br><span class="line">        <span class="comment">// FactoryBean 的话，在 beanName 前面加上 ‘&amp;’ 符号。再调用 getBean，getBean 方法别急</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> getBean(FACTORY_BEAN_PREFIX + beanName);</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> FactoryBean) &#123;</span><br><span class="line">          <span class="keyword">final</span> FactoryBean&lt;?&gt; factory = (FactoryBean&lt;?&gt;) bean;</span><br><span class="line">          <span class="type">boolean</span> isEagerInit;</span><br><span class="line">          <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span> &amp;&amp; factory <span class="keyword">instanceof</span> SmartFactoryBean) &#123;</span><br><span class="line">            isEagerInit = AccessController.doPrivileged((PrivilegedAction&lt;Boolean&gt;)</span><br><span class="line">                                                        ((SmartFactoryBean&lt;?&gt;) factory)::isEagerInit,</span><br><span class="line">                                                        getAccessControlContext());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 判断当前 FactoryBean 是否是 SmartFactoryBean 的实现，跳过</span></span><br><span class="line">            isEagerInit = (factory <span class="keyword">instanceof</span> SmartFactoryBean &amp;&amp;</span><br><span class="line">                           ((SmartFactoryBean&lt;?&gt;) factory).isEagerInit());</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (isEagerInit) &#123;</span><br><span class="line">            getBean(beanName);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 对于普通的 Bean，只要调用 getBean(beanName) 这个方法就可以进行初始化了</span></span><br><span class="line">        getBean(beanName);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 非懒加载的singleton beans已经完成初始化了</span></span><br><span class="line">  <span class="comment">// 如果bean实现了SmartInitializingSingleton接口，在这里回调</span></span><br><span class="line">  <span class="keyword">for</span> (String beanName : beanNames) &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">singletonInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">    <span class="keyword">if</span> (singletonInstance <span class="keyword">instanceof</span> SmartInitializingSingleton) &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">SmartInitializingSingleton</span> <span class="variable">smartSingleton</span> <span class="operator">=</span> (SmartInitializingSingleton) singletonInstance;</span><br><span class="line">      <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">        AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt; &#123;</span><br><span class="line">          smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">          <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;, getAccessControlContext());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        smartSingleton.afterSingletonsInstantiated();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>继续跳入上面的getBean方法</p>
<h4 id="getBean方法"><a href="#getBean方法" class="headerlink" title="getBean方法"></a>getBean方法</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractBeanFactory 198</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getBean</span><span class="params">(String name)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line">  <span class="keyword">return</span> doGetBean(name, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//AbstractBeanFactory 239</span></span><br><span class="line"><span class="comment">// 这个方法是从BanFactory返回bean实例的方法，这里就是如果已经出师话，直接返回，如果没有初始化，则开始初始化</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; T <span class="title function_">doGetBean</span><span class="params">(<span class="keyword">final</span> String name, <span class="meta">@Nullable</span> <span class="keyword">final</span> Class&lt;T&gt; requiredType,</span></span><br><span class="line"><span class="params">                          <span class="meta">@Nullable</span> <span class="keyword">final</span> Object[] args, <span class="type">boolean</span> typeCheckOnly)</span> <span class="keyword">throws</span> BeansException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">beanName</span> <span class="operator">=</span> transformedBeanName(name);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//返回值</span></span><br><span class="line">  Object bean;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查是否已经初始化过了.</span></span><br><span class="line">  <span class="type">Object</span> <span class="variable">sharedInstance</span> <span class="operator">=</span> getSingleton(beanName);</span><br><span class="line">  <span class="comment">// 如果args不为空，则方法是创建bean，为空是获取bean</span></span><br><span class="line">  <span class="comment">// 进入条件是已经创建过，且只是来获取bean的</span></span><br><span class="line">  <span class="keyword">if</span> (sharedInstance != <span class="literal">null</span> &amp;&amp; args == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isSingletonCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;..&quot;</span>)      </span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Returning cached instance of singleton bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="comment">// 如果是普通bean，直接返回sharedInstance</span></span><br><span class="line">      <span class="comment">// 如果是FactoryBean，则返回它创建的实例对象</span></span><br><span class="line">    bean = getObjectForBeanInstance(sharedInstance, name, beanName, <span class="literal">null</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//这个分支是用来创建bean的</span></span><br><span class="line">    <span class="comment">//是否正在创建</span></span><br><span class="line">    <span class="keyword">if</span> (isPrototypeCurrentlyInCreation(beanName)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCurrentlyInCreationException</span>(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 检查BeanFactory里面是否包含对应的BeanDefinition</span></span><br><span class="line">    <span class="type">BeanFactory</span> <span class="variable">parentBeanFactory</span> <span class="operator">=</span> getParentBeanFactory();</span><br><span class="line">    <span class="keyword">if</span> (parentBeanFactory != <span class="literal">null</span> &amp;&amp; !containsBeanDefinition(beanName)) &#123;</span><br><span class="line">      <span class="comment">//检查父容器是否有对应的bean</span></span><br><span class="line">      <span class="type">String</span> <span class="variable">nameToLookup</span> <span class="operator">=</span> originalBeanName(name);</span><br><span class="line">      <span class="keyword">if</span> (parentBeanFactory <span class="keyword">instanceof</span> AbstractBeanFactory) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((AbstractBeanFactory) parentBeanFactory).doGetBean(</span><br><span class="line">          nameToLookup, requiredType, args, typeCheckOnly);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (args != <span class="literal">null</span>) &#123;</span><br><span class="line">  			<span class="comment">// 返回父容器查询结果</span></span><br><span class="line">        <span class="keyword">return</span> (T) parentBeanFactory.getBean(nameToLookup, args);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有args参数，直接获取bean</span></span><br><span class="line">        <span class="keyword">return</span> parentBeanFactory.getBean(nameToLookup, requiredType);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// typeCheckOnly在创建时是false，将beanName放入一个alreadyCreated的set中</span></span><br><span class="line">    <span class="keyword">if</span> (!typeCheckOnly) &#123;</span><br><span class="line">      markBeanAsCreated(beanName);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//至此开始创建bean</span></span><br><span class="line">    <span class="comment">//singleton类型的bean容器中还不存在</span></span><br><span class="line">    <span class="comment">// prototype的bean，本来就要创建一个</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">RootBeanDefinition</span> <span class="variable">mbd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br><span class="line">      <span class="comment">// 检查rootBeanDefinition是否合法</span></span><br><span class="line">      checkMergedBeanDefinition(mbd, beanName, args);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 先初始化bean的依赖bean，是配置中的denpend-on字段</span></span><br><span class="line">      String[] dependsOn = mbd.getDependsOn();</span><br><span class="line">      <span class="keyword">if</span> (dependsOn != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (String dep : dependsOn) &#123;</span><br><span class="line">          <span class="comment">// 检查以免循环依赖</span></span><br><span class="line">          <span class="keyword">if</span> (isDependent(beanName, dep)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(...)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">//注册依赖关系</span></span><br><span class="line">          registerDependentBean(dep, beanName);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//初始化依赖项</span></span><br><span class="line">            getBean(dep);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(..)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建singleton实例</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">        sharedInstance = getSingleton(beanName, () -&gt; &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 创建bean，继续跳入</span></span><br><span class="line">            <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">catch</span> (BeansException ex) &#123;           </span><br><span class="line">            destroySingleton(beanName);</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 创建prototype实例</span></span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (mbd.isPrototype()) &#123;</span><br><span class="line">        <span class="comment">// It&#x27;s a prototype -&gt; create a new instance.</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">prototypeInstance</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          beforePrototypeCreation(beanName);</span><br><span class="line">          prototypeInstance = createBean(beanName, mbd, args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">          afterPrototypeCreation(beanName);</span><br><span class="line">        &#125;</span><br><span class="line">        bean = getObjectForBeanInstance(prototypeInstance, name, beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 不是singleton也不是prototype，委托给对应的类创建</span></span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">scopeName</span> <span class="operator">=</span> mbd.getScope();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Scope</span> <span class="variable">scope</span> <span class="operator">=</span> <span class="built_in">this</span>.scopes.get(scopeName);</span><br><span class="line">        <span class="keyword">if</span> (scope == <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No Scope registered for scope name &#x27;&quot;</span> + scopeName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="type">Object</span> <span class="variable">scopedInstance</span> <span class="operator">=</span> scope.get(beanName, () -&gt; &#123;</span><br><span class="line">            beforePrototypeCreation(beanName);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="keyword">return</span> createBean(beanName, mbd, args);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">finally</span> &#123;</span><br><span class="line">              afterPrototypeCreation(beanName);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;);</span><br><span class="line">          bean = getObjectForBeanInstance(scopedInstance, name, beanName, mbd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (IllegalStateException ex) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(...);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (BeansException ex) &#123;</span><br><span class="line">      cleanupAfterBeanCreationFailure(beanName);</span><br><span class="line">      <span class="keyword">throw</span> ex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 检查创建的bean和需求的bean是否一致，对就返回，不对就抛异常</span></span><br><span class="line">  <span class="keyword">if</span> (requiredType != <span class="literal">null</span> &amp;&amp; !requiredType.isInstance(bean)) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">T</span> <span class="variable">convertedBean</span> <span class="operator">=</span> getTypeConverter().convertIfNecessary(bean, requiredType);</span><br><span class="line">      <span class="keyword">if</span> (convertedBean == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> convertedBean;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (TypeMismatchException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(<span class="string">&quot;Failed to convert bean &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; to required type &#x27;&quot;</span> +</span><br><span class="line">                     ClassUtils.getQualifiedName(requiredType) + <span class="string">&quot;&#x27;&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanNotOfRequiredTypeException</span>(name, requiredType, bean.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (T) bean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续看createBean方法，参数包括三个如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">abstract</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, Object[] args)</span> <span class="keyword">throws</span> BeanCreationException;</span><br></pre></td></tr></table></figure>

<p>从上面的getBean方法，args参数是构造函数的参数，但在这个函数调用的时候为空。</p>
<p>继续看具体的createBean方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">createBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">  <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">RootBeanDefinition</span> <span class="variable">mbdToUse</span> <span class="operator">=</span> mbd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 确保beanDefinition中的class被加载</span></span><br><span class="line">  Class&lt;?&gt; resolvedClass = resolveBeanClass(mbd, beanName);</span><br><span class="line">  <span class="keyword">if</span> (resolvedClass != <span class="literal">null</span> &amp;&amp; !mbd.hasBeanClass() &amp;&amp; mbd.getBeanClassName() != <span class="literal">null</span>) &#123;</span><br><span class="line">    mbdToUse = <span class="keyword">new</span> <span class="title class_">RootBeanDefinition</span>(mbd);</span><br><span class="line">    mbdToUse.setBeanClass(resolvedClass);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 准备方法覆写</span></span><br><span class="line">  <span class="comment">// 主要和bean的lookup-method和replace-method相关</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    mbdToUse.prepareMethodOverrides();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionStoreException</span>(...<span class="string">&quot;Validation of method overrides failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 让InstantiationAwareBeanPostProcessor 在这里有机会返回代理类型</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> resolveBeforeInstantiation(beanName, mbdToUse);</span><br><span class="line">    <span class="keyword">if</span> (bean != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbdToUse.getResourceDescription(), beanName,</span><br><span class="line">                                    <span class="string">&quot;BeanPostProcessor before instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 创建bean，继续往里跳</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">beanInstance</span> <span class="operator">=</span> doCreateBean(beanName, mbdToUse, args);</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Finished creating instance of bean &#x27;&quot;</span> + beanName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> beanInstance;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanCreationException | ImplicitlyAppearedSingletonException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> ex;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(...<span class="string">&quot;Unexpected exception during bean creation&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="创建-Bean"><a href="#创建-Bean" class="headerlink" title="创建 Bean"></a>创建 Bean</h4><p>继续看doCreateBean方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">doCreateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd, <span class="keyword">final</span> <span class="meta">@Nullable</span> Object[] args)</span></span><br><span class="line">  <span class="keyword">throws</span> BeanCreationException &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Instantiate the bean.</span></span><br><span class="line">  <span class="type">BeanWrapper</span> <span class="variable">instanceWrapper</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (mbd.isSingleton()) &#123;</span><br><span class="line">    instanceWrapper = <span class="built_in">this</span>.factoryBeanInstanceCache.remove(beanName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (instanceWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 证明不是factoryBean，直接实例化，继续往里跳</span></span><br><span class="line">    instanceWrapper = createBeanInstance(beanName, mbd, args);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// bean实例</span></span><br><span class="line">  <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">bean</span> <span class="operator">=</span> instanceWrapper.getWrappedInstance();</span><br><span class="line">  <span class="comment">// bean类型</span></span><br><span class="line">  Class&lt;?&gt; beanType = instanceWrapper.getWrappedClass();</span><br><span class="line">  <span class="keyword">if</span> (beanType != NullBean.class) &#123;</span><br><span class="line">    mbd.resolvedTargetType = beanType;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// MergeBeanDefinition的postProcessor，这里不展开</span></span><br><span class="line">  <span class="keyword">synchronized</span> (mbd.postProcessingLock) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!mbd.postProcessed) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        applyMergedBeanDefinitionPostProcessors(mbd, beanType, beanName);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">                                        <span class="string">&quot;Post-processing of merged bean definition failed&quot;</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">      mbd.postProcessed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Eagerly cache singletons to be able to resolve circular references</span></span><br><span class="line">  <span class="comment">// even when triggered by lifecycle interfaces like BeanFactoryAware.</span></span><br><span class="line">  <span class="comment">// 下面这块代码为了解决循环依赖问题</span></span><br><span class="line">  <span class="type">boolean</span> <span class="variable">earlySingletonExposure</span> <span class="operator">=</span> (mbd.isSingleton() &amp;&amp; <span class="built_in">this</span>.allowCircularReferences &amp;&amp;</span><br><span class="line">                                    isSingletonCurrentlyInCreation(beanName));</span><br><span class="line">  <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">      logger.debug(<span class="string">&quot;Eagerly caching bean &#x27;&quot;</span> + beanName +</span><br><span class="line">                   <span class="string">&quot;&#x27; to allow for resolving potential circular references&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    addSingletonFactory(beanName, () -&gt; getEarlyBeanReference(beanName, mbd, bean));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initialize the bean instance.</span></span><br><span class="line">  <span class="type">Object</span> <span class="variable">exposedObject</span> <span class="operator">=</span> bean;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 填充bean，前面只是实例化了bean，参数还没有填充进去</span></span><br><span class="line">    populateBean(beanName, mbd, instanceWrapper);</span><br><span class="line">    <span class="comment">// 处理init-method，initializingBean接口和BeanPostProcessor接口</span></span><br><span class="line">    exposedObject = initializeBean(beanName, exposedObject, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">    <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> BeanCreationException &amp;&amp; beanName.equals(((BeanCreationException) ex).getBeanName())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> (BeanCreationException) ex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">        mbd.getResourceDescription(), beanName, <span class="string">&quot;Initialization of bean failed&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (earlySingletonExposure) &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">earlySingletonReference</span> <span class="operator">=</span> getSingleton(beanName, <span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (earlySingletonReference != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (exposedObject == bean) &#123;</span><br><span class="line">        exposedObject = earlySingletonReference;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">this</span>.allowRawInjectionDespiteWrapping &amp;&amp; hasDependentBean(beanName)) &#123;</span><br><span class="line">        String[] dependentBeans = getDependentBeans(beanName);</span><br><span class="line">        Set&lt;String&gt; actualDependentBeans = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;(dependentBeans.length);</span><br><span class="line">        <span class="keyword">for</span> (String dependentBean : dependentBeans) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!removeSingletonIfCreatedForTypeCheckOnly(dependentBean)) &#123;</span><br><span class="line">            actualDependentBeans.add(dependentBean);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!actualDependentBeans.isEmpty()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCurrentlyInCreationException</span>(beanName,,...)                                                 </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register bean as disposable.</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    registerDisposableBeanIfNecessary(beanName, bean, mbd);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (BeanDefinitionValidationException ex) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">      mbd.getResourceDescription(), beanName, <span class="string">&quot;Invalid destruction signature&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> exposedObject;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>doCreateBean当中有两个重要方法<code>createBeanInstance</code>、<code>populateBean</code></p>
<h4 id="创建bean实例"><a href="#创建bean实例" class="headerlink" title="创建bean实例"></a>创建bean实例</h4><p>继续看<code>createBeanInstance</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> BeanWrapper <span class="title function_">createBeanInstance</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> Object[] args)</span> &#123;</span><br><span class="line">   <span class="comment">// 确保已经加载了这个class</span></span><br><span class="line">   Class&lt;?&gt; beanClass = resolveBeanClass(mbd, beanName);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//检查类是public还是private的</span></span><br><span class="line">   <span class="keyword">if</span> (beanClass != <span class="literal">null</span> &amp;&amp; !Modifier.isPublic(beanClass.getModifiers()) &amp;&amp; !mbd.isNonPublicAccessAllowed()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(mbd.getResourceDescription(), beanName,</span><br><span class="line">            <span class="string">&quot;Bean class isn&#x27;t public, and non-public access not allowed: &quot;</span> + beanClass.getName());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   Supplier&lt;?&gt; instanceSupplier = mbd.getInstanceSupplier();</span><br><span class="line">   <span class="keyword">if</span> (instanceSupplier != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> obtainFromSupplier(instanceSupplier, beanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (mbd.getFactoryMethodName() != <span class="literal">null</span>)  &#123;</span><br><span class="line">      <span class="comment">// 采用工厂方法实例化</span></span><br><span class="line">      <span class="keyword">return</span> instantiateUsingFactoryMethod(beanName, mbd, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 创建同一个bean，比如第二次创建prototype bean，</span></span><br><span class="line">  <span class="comment">// 可以从第一次创建的信息知道，采用无参构造函数，还是构造函数依赖注入来实例化</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">resolved</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">autowireNecessary</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">   <span class="keyword">if</span> (args == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (mbd.constructorArgumentLock) &#123;</span><br><span class="line">         <span class="keyword">if</span> (mbd.resolvedConstructorOrFactoryMethod != <span class="literal">null</span>) &#123;</span><br><span class="line">            resolved = <span class="literal">true</span>;</span><br><span class="line">            autowireNecessary = mbd.constructorArgumentsResolved;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (resolved) &#123;</span><br><span class="line">      <span class="keyword">if</span> (autowireNecessary) &#123;</span><br><span class="line">        <span class="comment">//构造函数依赖注入</span></span><br><span class="line">         <span class="keyword">return</span> autowireConstructor(beanName, mbd, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//无参构造函数</span></span><br><span class="line">         <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否使用有参构造函数</span></span><br><span class="line">   Constructor&lt;?&gt;[] ctors = determineConstructorsFromBeanPostProcessors(beanClass, beanName);</span><br><span class="line">   <span class="keyword">if</span> (ctors != <span class="literal">null</span> ||</span><br><span class="line">         mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_CONSTRUCTOR ||</span><br><span class="line">         mbd.hasConstructorArgumentValues() || !ObjectUtils.isEmpty(args))  &#123;</span><br><span class="line">      <span class="keyword">return</span> autowireConstructor(beanName, mbd, ctors, args);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 调用无参构造函数</span></span><br><span class="line">   <span class="keyword">return</span> instantiateBean(beanName, mbd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>选择无参构造函数，跳入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// AbstractAutowireCapableBeanFactory.java:1211</span></span><br><span class="line"><span class="keyword">protected</span> BeanWrapper <span class="title function_">instantiateBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      Object beanInstance;</span><br><span class="line">      <span class="keyword">final</span> <span class="type">BeanFactory</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">      <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">         beanInstance = AccessController.doPrivileged((PrivilegedAction&lt;Object&gt;) () -&gt;</span><br><span class="line">               getInstantiationStrategy().instantiate(mbd, beanName, parent),</span><br><span class="line">               getAccessControlContext());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 实例化</span></span><br><span class="line">         beanInstance = getInstantiationStrategy().instantiate(mbd, beanName, parent);</span><br><span class="line">      &#125;</span><br><span class="line">     <span class="comment">//包装成beanWrapper返回</span></span><br><span class="line">      <span class="type">BeanWrapper</span> <span class="variable">bw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanWrapperImpl</span>(beanInstance);</span><br><span class="line">      initBeanWrapper(bw);</span><br><span class="line">      <span class="keyword">return</span> bw;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            mbd.getResourceDescription(), beanName, <span class="string">&quot;Instantiation of bean failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续看实例化的函数</p>
<p>&#x2F;&#x2F; SimpleInstantiationStrategy.java:61</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">instantiate</span><span class="params">(RootBeanDefinition bd, <span class="meta">@Nullable</span> String beanName, BeanFactory owner)</span> &#123;</span><br><span class="line">	<span class="comment">// 如果不允许方法覆写，则使用java反射进行实例化，否则使用CGLIB进行实例化</span></span><br><span class="line">	<span class="keyword">if</span> (!bd.hasMethodOverrides()) &#123;</span><br><span class="line">		Constructor&lt;?&gt; constructorToUse;</span><br><span class="line">		<span class="keyword">synchronized</span> (bd.constructorArgumentLock) &#123;</span><br><span class="line">			constructorToUse = (Constructor&lt;?&gt;) bd.resolvedConstructorOrFactoryMethod;</span><br><span class="line">			<span class="keyword">if</span> (constructorToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">				<span class="keyword">final</span> Class&lt;?&gt; clazz = bd.getBeanClass();</span><br><span class="line">				<span class="keyword">if</span> (clazz.isInterface()) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInstantiationException</span>(clazz, <span class="string">&quot;Specified class is an interface&quot;</span>);</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">						constructorToUse = AccessController.doPrivileged(</span><br><span class="line">								(PrivilegedExceptionAction&lt;Constructor&lt;?&gt;&gt;) clazz::getDeclaredConstructor);</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">else</span> &#123;</span><br><span class="line">						constructorToUse =	clazz.getDeclaredConstructor();</span><br><span class="line">					&#125;</span><br><span class="line">					bd.resolvedConstructorOrFactoryMethod = constructorToUse;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanInstantiationException</span>(clazz, <span class="string">&quot;No default constructor found&quot;</span>, ex);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">     <span class="comment">// 用构造方法实例化</span></span><br><span class="line">		<span class="keyword">return</span> BeanUtils.instantiateClass(constructorToUse);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//存在方法覆写，使用CGLIB进行实例化，通过CGLIB生成子类</span></span><br><span class="line">		<span class="keyword">return</span> instantiateWithMethodInjection(bd, beanName, owner);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="bean属性注入"><a href="#bean属性注入" class="headerlink" title="bean属性注入"></a>bean属性注入</h4><p>看populateBean方法</p>
<p>&#x2F;&#x2F; AbstractAutowireCapableBeanFactory.java:1277</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">populateBean</span><span class="params">(String beanName, RootBeanDefinition mbd, <span class="meta">@Nullable</span> BeanWrapper bw)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (bw == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mbd.hasPropertyValues()) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">               mbd.getResourceDescription(), beanName, <span class="string">&quot;Cannot apply property values to null instance&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">         <span class="comment">// Skip property population phase for null instance.</span></span><br><span class="line">         <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// bean实例化完成，但属性还没有值</span></span><br><span class="line">  <span class="comment">// InstantiationAwareBeanPostProcessor的实现类对bean修改</span></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">continueWithPropertyPopulation</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!mbd.isSynthetic() &amp;&amp; hasInstantiationAwareBeanPostProcessors()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">         <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">            <span class="type">InstantiationAwareBeanPostProcessor</span> <span class="variable">ibp</span> <span class="operator">=</span> (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">           <span class="comment">// 如果返回false，代表不需要对属性设置值，不在对其他的beanPostProcessor处理</span></span><br><span class="line">            <span class="keyword">if</span> (!ibp.postProcessAfterInstantiation(bw.getWrappedInstance(), beanName)) &#123;</span><br><span class="line">               continueWithPropertyPopulation = <span class="literal">false</span>;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (!continueWithPropertyPopulation) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">PropertyValues</span> <span class="variable">pvs</span> <span class="operator">=</span> (mbd.hasPropertyValues() ? mbd.getPropertyValues() : <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME ||</span><br><span class="line">         mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">      <span class="type">MutablePropertyValues</span> <span class="variable">newPvs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertyValues</span>(pvs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 通过名字找到属性值，如果是bean依赖，先初始化bean，记录依赖关系</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_NAME) &#123;</span><br><span class="line">         autowireByName(beanName, mbd, bw, newPvs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 通过type装配</span></span><br><span class="line">      <span class="keyword">if</span> (mbd.getResolvedAutowireMode() == RootBeanDefinition.AUTOWIRE_BY_TYPE) &#123;</span><br><span class="line">         autowireByType(beanName, mbd, bw, newPvs);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      pvs = newPvs;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">boolean</span> <span class="variable">hasInstAwareBpps</span> <span class="operator">=</span> hasInstantiationAwareBeanPostProcessors();</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">needsDepCheck</span> <span class="operator">=</span> (mbd.getDependencyCheck() != RootBeanDefinition.DEPENDENCY_CHECK_NONE);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (hasInstAwareBpps || needsDepCheck) &#123;</span><br><span class="line">      <span class="keyword">if</span> (pvs == <span class="literal">null</span>) &#123;</span><br><span class="line">         pvs = mbd.getPropertyValues();</span><br><span class="line">      &#125;</span><br><span class="line">      PropertyDescriptor[] filteredPds = filterPropertyDescriptorsForDependencyCheck(bw, mbd.allowCaching);</span><br><span class="line">      <span class="keyword">if</span> (hasInstAwareBpps) &#123;</span><br><span class="line">         <span class="keyword">for</span> (BeanPostProcessor bp : getBeanPostProcessors()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (bp <span class="keyword">instanceof</span> InstantiationAwareBeanPostProcessor) &#123;</span><br><span class="line">               <span class="type">InstantiationAwareBeanPostProcessor</span> <span class="variable">ibp</span> <span class="operator">=</span> (InstantiationAwareBeanPostProcessor) bp;</span><br><span class="line">              <span class="comment">//对采用@Autowired和@Value注解的依赖进行设值</span></span><br><span class="line">               pvs = ibp.postProcessPropertyValues(pvs, filteredPds, bw.getWrappedInstance(), beanName);</span><br><span class="line">               <span class="keyword">if</span> (pvs == <span class="literal">null</span>) &#123;</span><br><span class="line">                  <span class="keyword">return</span>;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (needsDepCheck) &#123;</span><br><span class="line">         checkDependencies(beanName, mbd, filteredPds, pvs);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (pvs != <span class="literal">null</span>) &#123;</span><br><span class="line">     <span class="comment">//设置bean实例的属性值</span></span><br><span class="line">      applyPropertyValues(beanName, mbd, bw, pvs);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="initializeBean"><a href="#initializeBean" class="headerlink" title="initializeBean"></a>initializeBean</h5><p>populateBean后面还有一个initializeBean方法，我们进入initializeBean方法</p>
<p>&#x2F;&#x2F; AbstractAutowireCapableBeanFactory.java:1678</p>
<p>这个方法里面是各种回调</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">initializeBean</span><span class="params">(<span class="keyword">final</span> String beanName, <span class="keyword">final</span> Object bean, RootBeanDefinition mbd)</span> &#123;</span><br><span class="line">   <span class="keyword">if</span> (System.getSecurityManager() != <span class="literal">null</span>) &#123;</span><br><span class="line">      AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Object&gt;() &#123;</span><br><span class="line">         <span class="meta">@Override</span></span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            invokeAwareMethods(beanName, bean);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;, getAccessControlContext());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果 bean 实现了 BeanNameAware、BeanClassLoaderAware 或 BeanFactoryAware 接口，回调</span></span><br><span class="line">      invokeAwareMethods(beanName, bean);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="type">Object</span> <span class="variable">wrappedBean</span> <span class="operator">=</span> bean;</span><br><span class="line">   <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">      <span class="comment">// BeanPostProcessor 的 postProcessBeforeInitialization 回调</span></span><br><span class="line">      wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 处理 bean 中定义的 init-method，</span></span><br><span class="line">      <span class="comment">// 或者如果 bean 实现了 InitializingBean 接口，调用 afterPropertiesSet() 方法</span></span><br><span class="line">      invokeInitMethods(beanName, wrappedBean, mbd);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BeanCreationException</span>(</span><br><span class="line">            (mbd != <span class="literal">null</span> ? mbd.getResourceDescription() : <span class="literal">null</span>),</span><br><span class="line">            beanName, <span class="string">&quot;Invocation of init method failed&quot;</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (mbd == <span class="literal">null</span> || !mbd.isSynthetic()) &#123;</span><br><span class="line">      <span class="comment">// BeanPostProcessor 的 postProcessAfterInitialization 回调</span></span><br><span class="line">      wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> wrappedBean;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>










<h4 id="lookup-method"><a href="#lookup-method" class="headerlink" title="lookup-method"></a>lookup-method</h4><p>我们来看一下 Spring Reference 中提供的一个例子：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySingletonBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showMessage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyPrototypeBean</span> <span class="variable">bean</span> <span class="operator">=</span> getPrototypeBean();</span><br><span class="line">        <span class="comment">//each time getPrototypeBean() call</span></span><br><span class="line">        <span class="comment">//will return new instance</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> MyPrototypeBean <span class="title function_">getPrototypeBean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//spring will override this method</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>xml 配置 ：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- a stateful bean deployed as a prototype (non-singleton) --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myCommand&quot;</span> <span class="attr">class</span>=<span class="string">&quot;fiona.apple.AsyncCommand&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- inject dependencies here as required --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- commandProcessor uses statefulCommandHelper --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;MySingletonBean&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.drawon.MySingletonBean&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">lookup-method</span> <span class="attr">name</span>=<span class="string">&quot;getPrototypeBean&quot;</span> <span class="attr">bean</span>=<span class="string">&quot;MyPrototypeBean&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>虽然返回的是getPrototypeBean方法返回值是null，但因为配置了lookup-method，因此最终返回的结果也是MyPrototypeBean实例</p>
<p>也可以用注解的方式进行：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySingletonBean</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">showMessage</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">MyPrototypeBean</span> <span class="variable">bean</span> <span class="operator">=</span> getPrototypeBean();</span><br><span class="line">        <span class="comment">//each time getPrototypeBean() call</span></span><br><span class="line">        <span class="comment">//will return new instance</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Lookup</span></span><br><span class="line">    <span class="keyword">public</span> MyPrototypeBean <span class="title function_">getPrototypeBean</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//spring will override this method</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="replaced-method"><a href="#replaced-method" class="headerlink" title="replaced-method"></a>replaced-method</h4><p>记住它的功能，就是替换掉 bean 中的一些方法。用一个实现org.springframework.beans.factory.support.MethodReplacer的类，实现其中的<code>reimplement</code>方法，然后配置好，就可以覆盖某个类当中某个方法的返回值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyValueCalculator</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">computeValue</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="comment">// some real code...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现MethodReplacer接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReplacementComputeValue</span> <span class="keyword">implements</span> <span class="title class_">org</span>.springframework.beans.factory.support.MethodReplacer &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">reimplement</span><span class="params">(Object o, Method m, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// get the input value, work with it, and return a computed result</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">return</span> ...;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置xml如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myValueCalculator&quot;</span> <span class="attr">class</span>=<span class="string">&quot;x.y.z.MyValueCalculator&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 定义 computeValue 这个方法要被替换掉 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">replaced-method</span> <span class="attr">name</span>=<span class="string">&quot;computeValue&quot;</span> <span class="attr">replacer</span>=<span class="string">&quot;replacementComputeValue&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">arg-type</span>&gt;</span>String<span class="tag">&lt;/<span class="name">arg-type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">replaced-method</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;replacementComputeValue&quot;</span> <span class="attr">class</span>=<span class="string">&quot;a.b.c.ReplacementComputeValue&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="Bean-继承"><a href="#Bean-继承" class="headerlink" title="Bean 继承"></a>Bean 继承</h3><p>在初始化 Bean 的地方，我们说过了这个：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">RootBeanDefinition</span> <span class="variable">bd</span> <span class="operator">=</span> getMergedLocalBeanDefinition(beanName);</span><br></pre></td></tr></table></figure>

<p>这里涉及到的就是 <code>&lt;bean parent=&quot;&quot; /&gt;</code> 中的 parent 属性，我们来看看 Spring 中是用这个来干什么的。</p>
<p>首先，我们要明白，这里的继承和 java 语法中的继承没有任何关系，不过思路是相通的。child bean 会继承 parent bean 的所有配置，也可以覆盖一些配置，当然也可以新增额外的配置。</p>
<p>Spring 中提供了继承自 AbstractBeanDefinition 的 <code>ChildBeanDefinition</code> 来表示 child bean。</p>
<p>看如下一个例子:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;inheritedTestBean&quot;</span> <span class="keyword">abstract</span>=<span class="string">&quot;true&quot;</span> class=<span class="string">&quot;org.springframework.beans.TestBean&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;parent&quot;</span>/&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;age&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">&lt;bean id=<span class="string">&quot;inheritsWithDifferentClass&quot;</span> class=<span class="string">&quot;org.springframework.beans.DerivedTestBean&quot;</span></span><br><span class="line">        parent=<span class="string">&quot;inheritedTestBean&quot;</span> init-method=<span class="string">&quot;initialize&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;override&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>parent bean 设置了 <code>abstract=&quot;true&quot;</code> 所以它不会被实例化，child bean 继承了 parent bean 的两个属性，但是对 name 属性进行了覆写。</p>
<p>child bean 会继承 scope、构造器参数值、属性值、init-method、destroy-method 等等。</p>
<p>当然，我不是说 parent bean 中的 abstract &#x3D; true 在这里是必须的，只是说如果加上了以后 Spring 在实例化 singleton beans 的时候会忽略这个 bean。</p>
<p>比如下面这个极端 parent bean，它没有指定 class，所以毫无疑问，这个 bean 的作用就是用来充当模板用的 parent bean，此处就必须加上 abstract &#x3D; true。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;bean id=<span class="string">&quot;inheritedTestBeanWithoutClass&quot;</span> <span class="keyword">abstract</span>=<span class="string">&quot;true&quot;</span>&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;name&quot;</span> value=<span class="string">&quot;parent&quot;</span>/&gt;</span><br><span class="line">    &lt;property name=<span class="string">&quot;age&quot;</span> value=<span class="string">&quot;1&quot;</span>/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<h3 id="ConversionService"><a href="#ConversionService" class="headerlink" title="ConversionService"></a>ConversionService</h3><p>将前端传过来的参数和后端的controller方法绑定</p>
<p>前端如果穿字符串，后端很容易转化为一个String或者Integer，但如果需要一个枚举值，或者是Date之类的，就要用ConversionService来转换</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;conversionService&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">&quot;org.springframework.context.support.ConversionServiceFactoryBean&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;converters&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.javadoop.learning.utils.StringToEnumConverterFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>用converter接口实现更简单</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringToDateConverter</span> <span class="keyword">implements</span> <span class="title class_">Converter</span>&lt;String, Date&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">convert</span><span class="params">(String source)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> DateUtils.parseDate(source, <span class="string">&quot;yyyy-MM-dd&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>, <span class="string">&quot;yyyy-MM-dd HH:mm&quot;</span>, <span class="string">&quot;HH:mm:ss&quot;</span>, <span class="string">&quot;HH:mm&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ParseException e) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









]]></content>
      <categories>
        <category>java</category>
        <category>spring</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>spring</tag>
      </tags>
  </entry>
  <entry>
    <title>ubuntu防火墙设置通过某端口</title>
    <url>/2017/12/05/ubuntu%E9%98%B2%E7%81%AB%E5%A2%99%E8%AE%BE%E7%BD%AE%E9%80%9A%E8%BF%87%E6%9F%90%E7%AB%AF%E5%8F%A3/</url>
    <content><![CDATA[<p>在启动项里加入以下命令行，修改 <code>/etc/rc.local </code></p>
<p><code>iptables -I INPUT -p tcp --dport 8888 -j ACCEPT</code> </p>
]]></content>
      <categories>
        <category>linux</category>
      </categories>
      <tags>
        <tag>linux防火墙</tag>
      </tags>
  </entry>
  <entry>
    <title>vscode设置及插件同步</title>
    <url>/2018/05/25/vscode%E8%AE%BE%E7%BD%AE%E5%8F%8A%E6%8F%92%E4%BB%B6%E5%90%8C%E6%AD%A5/</url>
    <content><![CDATA[<h1 id="vscode同步设置-amp-扩展插件"><a href="#vscode同步设置-amp-扩展插件" class="headerlink" title="vscode同步设置&amp;扩展插件"></a>vscode同步设置&amp;扩展插件</h1><p>首先安装同步插件： <a href="https://marketplace.visualstudio.com/items?itemName=Shan.code-settings-sync">Settings Sync</a>  </p>
 <span id="more"></span>

<p>第二步：进入你的github如图：</p>
<p> <strong>打开设置选项：</strong></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-25/26703030.jpg"></p>
<p><strong>新建一个token：</strong></p>
<p><img src="https://images2015.cnblogs.com/blog/717286/201704/717286-20170425110217694-265826573.png" alt="img"></p>
<p>如图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-25/1344863.jpg"></p>
<p> <strong>记住这个token值</strong></p>
<p>转到vscode</p>
<p> 按shift+alt +u  在弹出窗里输入你的token,然后等下会生成syncSummary.txt文件在窗口中打开这样就算成功了。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-25/99811178.jpg"></p>
<p>syncSummary.txt这个文件里有个gist值或者到用户设置文件中查看gist的值，这个值用来你再另一台电脑上来下载你的设置，在设置中可以找到这个git的值</p>
<p><img src="C:\Users\jeffrey\AppData\Local\Temp\1527243805172.png" alt="img"></p>
<p><strong>下载你的设置方法为：打开vscode——按alt+shift+d  在弹出窗里输入你的gist值，等待片刻便同步成功。</strong></p>
<p><strong>如果要重置同步设置：按ctrl+p  输入  ‘&gt;sync’</strong>  </p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-5-25/82132308.jpg"></p>
<p>   <strong>就可以重新配置你的token来同步了</strong></p>
]]></content>
      <categories>
        <category>编程学习</category>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>thinking in java读书笔记</title>
    <url>/2018/06/24/thinking-in-java%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h2 id="基础语法"><a href="#基础语法" class="headerlink" title="基础语法"></a>基础语法</h2><p>大多数语法与c++相似，只记录部分不熟悉的或者是不一样的语法。</p>
<h3 id="static关键字"><a href="#static关键字" class="headerlink" title="static关键字"></a>static关键字</h3><span id="more"></span>

<p>static的作用是，用static修饰的部分，不需要实例化类，可以直接通过类名+”.”来使用</p>
<p>static还可以用来修饰变量，如果被static修饰之后，在内存中只有一个拷贝，只分配一次内存，没有用static修饰的在内存中有多个拷贝，每次new都会分配一个新地址</p>
<h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><ul>
<li><code>^</code>：异或操作符</li>
<li><code>&amp;</code>和<code>&amp;&amp;</code>符号的区别：<code>&amp;</code>符号两边的运算都要执行，<code>&amp;&amp;</code>只有在左边条件为真的时候才执行，例如<code>if(str!=null &amp;&amp; !&quot;&quot;.equals(str))</code>：<ul>
<li>用<code>&amp;&amp;</code>的时候，此时如果<code>str!=null</code>，右边的<code>!&quot;&quot;.equals(str)</code>会被执行，如果此时<code>str=null</code>，那么右边的<code>!&quot;&quot;.equals(str)</code>不会被执行；</li>
<li>如果用<code>&amp;</code>：不管<code>str!=null</code>的结果如何，后面的<code>!&quot;&quot;.equals(str)</code>都会被执行</li>
</ul>
</li>
<li><code>&gt;&gt;&gt;</code>：无符号右移操作</li>
</ul>
<h3 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h3><p>如果要遍历一个数组，可以使用在java SE5中引入的foreach方法：<code>for(int i : range(10))</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"><span class="type">float</span> f[] = <span class="keyword">new</span> <span class="title class_">float</span>[<span class="number">10</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;i &lt; <span class="number">10</span>; i++)&#123;</span><br><span class="line">    f[i] = rand.nextFloat();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">float</span> x: f)&#123;</span><br><span class="line">    System.out.println(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="构造器和垃圾回收器"><a href="#构造器和垃圾回收器" class="headerlink" title="构造器和垃圾回收器"></a>构造器和垃圾回收器</h2><h3 id="构造器"><a href="#构造器" class="headerlink" title="构造器"></a>构造器</h3><p>构造器就相当于js当中的构造函数，python中的<code>__init__</code>函数，在java当中构造器的名称就是和类名相同的一个函数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Rock2</span>&#123;</span><br><span class="line">    Rock2(<span class="type">int</span> i)&#123;</span><br><span class="line">        System.out.println(<span class="string">&#x27;Rock&#x27;</span> + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="方法重载"><a href="#方法重载" class="headerlink" title="方法重载"></a>方法重载</h3><p>方法重载就是同一个函数，在其参数不同的时候执行不同的函数的过程，比如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Tree</span>&#123;</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">    Tree()&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;a seed&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    Tree(<span class="type">int</span> initialHeight)&#123;</span><br><span class="line">        height = initialHeight;</span><br><span class="line">        System.out.println(<span class="string">&quot;a tree high is&quot;</span> + height);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在构造函数中调用构造函数"><a href="#在构造函数中调用构造函数" class="headerlink" title="在构造函数中调用构造函数"></a>在构造函数中调用构造函数</h3><p>一个class可以有多个构造函数，还可以在某个构造函数中调用另一个构造函数，调用的方法是用<code>this(构造参数)</code>来实现的，<strong>注意</strong>：在一个构造其中最多只能调用一次别的构造函数，因为某个class只能被构造一次。且只能在构造函数中调用构造函数，还要在构造函数的最前面调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Flower</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">petalCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;initial string&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Flower</span><span class="params">(<span class="type">int</span> petal)</span> &#123;</span><br><span class="line">        petalCount = petal;</span><br><span class="line">        println(<span class="string">&quot;petal only constructor,petalCount=&quot;</span> + petalCount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Flower(String ss) &#123;</span><br><span class="line">        println(<span class="string">&quot;constructor with string only&quot;</span> + ss);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Flower</span><span class="params">(String s, <span class="type">int</span> petal)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>(petal);</span><br><span class="line">        <span class="comment">//this(s) ，只能调用一次，如果调用第二次会报错</span></span><br><span class="line">        <span class="built_in">this</span>.s = s;</span><br><span class="line">        petalCount = petal;</span><br><span class="line">        println(<span class="string">&quot;string and int constructor&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Flower() &#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="string">&quot;hi&quot;</span>, <span class="number">47</span>);</span><br><span class="line">        println(<span class="string">&quot;petalCount=&quot;</span> + petalCount + <span class="string">&quot;,s=&quot;</span> + s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Flower</span> <span class="variable">flower</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Flower</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h2><p>所有用new构建的对象，java都会自动回收，只有那些不是用new得到的对象所占用的内存，java无法处理，需要你编写<code>finalize()</code>函数来进行垃圾回收</p>
<ol>
<li>对象可能不被垃圾回收</li>
<li>垃圾回收不等于“析构”</li>
<li>垃圾回收只与内存有关</li>
</ol>
<p>因为垃圾回收本身也要消耗一定资源，所以在jvm内存耗尽之前，它是不会浪费时间去执行垃圾回收的。</p>
<p>在垃圾回收的时候，会自动调用<code>finalize()</code>函数，通常是一些销毁时对对象的验证</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Book</span> <span class="variable">novel</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="literal">true</span>);</span><br><span class="line">        novel.checkIn();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Book</span>(<span class="literal">true</span>);</span><br><span class="line">        System.gc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Book</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">checkedOut</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    Book(<span class="type">boolean</span> checkOut)&#123;</span><br><span class="line">        checkedOut = checkOut;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">checkIn</span><span class="params">()</span>&#123;</span><br><span class="line">        checkedOut = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">finalize</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (checkedOut)&#123;</span><br><span class="line">            println(<span class="string">&quot;error:checked out&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="垃圾回收的自适应技术"><a href="#垃圾回收的自适应技术" class="headerlink" title="垃圾回收的自适应技术"></a>垃圾回收的自适应技术</h3><p>所谓的自适应，就是在两种垃圾回收方式中切换：<strong>标记-清扫</strong>模式和<strong>停止-复制</strong>模式</p>
<p>先来介绍一下这两种模式的工作机理：</p>
<ol>
<li>标记-清扫模式：遍历所有的引用，找出存活的对象。每找到一个存活对象，就会给对象一个标记，这个过程不会回收任何对象。只有标记完所有对象的时候，才开始清理，没有标记的对象将被释放。剩下的空间是不连续的，如果希望得到连续空间，就需要重新整理剩下的对象。</li>
<li>停止-复制模式：暂停程序运行，将所有存活的对象从当前堆复制到另一个堆，没有被复制到都是垃圾。得到的新堆是连续的。这种方法需要两倍的程序运行内存（一个本身，一个复制堆），在程序稳定时只有少量垃圾，大量复制会产生内存浪费。</li>
</ol>
<p>自适应模式：如果对象很稳定，就切换到“标记-清扫”模式；要是标记清扫模式的堆空间中出现很多碎片，就会切换回“停止-复制”模式</p>
<h3 id="类成员初始化顺序"><a href="#类成员初始化顺序" class="headerlink" title="类成员初始化顺序"></a>类成员初始化顺序</h3><p>首先被初始化的是静态变量，然后是普通变量，比如定义的int，或者是定义的new 类元素，然后是构造器，最后是函数对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> javastatic;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Window</span>&#123;</span><br><span class="line">	Window(<span class="type">int</span> marker)&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Windows(&quot;</span>+marker+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">House</span>&#123;</span><br><span class="line">	Window w1=<span class="keyword">new</span> <span class="title class_">Window</span>(<span class="number">1</span>);</span><br><span class="line">	House()&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;House()&quot;</span>);</span><br><span class="line">		w3=<span class="keyword">new</span> <span class="title class_">Window</span>(<span class="number">33</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	Window w2=<span class="keyword">new</span> <span class="title class_">Window</span>(<span class="number">2</span>);</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">f</span><span class="params">()</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;f()&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	Window w3=<span class="keyword">new</span> <span class="title class_">Window</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderOfInitialization</span> &#123;</span><br><span class="line"> </span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> args</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">		<span class="comment">// TODO Auto-generated method stub</span></span><br><span class="line">		House house=<span class="keyword">new</span> <span class="title class_">House</span>();</span><br><span class="line">		house.f();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* output:</span></span><br><span class="line"><span class="comment">Window(1)</span></span><br><span class="line"><span class="comment">Window(2)</span></span><br><span class="line"><span class="comment">Window(3)</span></span><br><span class="line"><span class="comment">House()</span></span><br><span class="line"><span class="comment">Window(33)</span></span><br><span class="line"><span class="comment">f()</span></span><br><span class="line"><span class="comment">*/</span><span class="comment">//:~</span></span><br></pre></td></tr></table></figure>

<h3 id="静态数据"><a href="#静态数据" class="headerlink" title="静态数据"></a>静态数据</h3><p>无论创建多少个对象，静态数据都只占用一份存储区域，static不能用于局部变量，且静态变量的初始化优先级最高，在最前面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bowl</span>&#123;</span><br><span class="line">	Bowl(<span class="type">int</span> marker)&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Bowl(&quot;</span>+marker+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">f1</span><span class="params">(<span class="type">int</span> marker)</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;f1(&quot;</span>+marker+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Table</span>&#123;</span><br><span class="line">	<span class="keyword">static</span> Bowl bowl1=<span class="keyword">new</span> <span class="title class_">Bowl</span>(<span class="number">1</span>);</span><br><span class="line">	Table()&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Table()&quot;</span>);</span><br><span class="line">		bowl2.f1(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">f2</span><span class="params">(<span class="type">int</span> marker)</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;f2(&quot;</span>+marker+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">static</span> Bowl bowl2=<span class="keyword">new</span> <span class="title class_">Bowl</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cupboard</span>&#123;</span><br><span class="line">	Bowl bowl3=<span class="keyword">new</span> <span class="title class_">Bowl</span>(<span class="number">3</span>);</span><br><span class="line">	<span class="keyword">static</span> Bowl bowl4=<span class="keyword">new</span> <span class="title class_">Bowl</span>(<span class="number">4</span>);</span><br><span class="line">	Cupboard()&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Cupboard()&quot;</span>);</span><br><span class="line">		bowl4.f1(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">f3</span><span class="params">(<span class="type">int</span> marker)</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;f3(&quot;</span>+marker+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">static</span> Bowl bowl5=<span class="keyword">new</span> <span class="title class_">Bowl</span>(<span class="number">5</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Static</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span></span><br><span class="line">	&#123;</span><br><span class="line">		System.out.println(<span class="string">&quot;Creating new Cupboard() in main&quot;</span>);</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Cupboard</span>();</span><br><span class="line">		System.out.println(<span class="string">&quot;Creating new Cupboard() in main&quot;</span>);</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Cupboard</span>();</span><br><span class="line">		table.f2(<span class="number">1</span>);</span><br><span class="line">		cupboard.f3(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">static</span> Table table=<span class="keyword">new</span> <span class="title class_">Table</span>();</span><br><span class="line">	<span class="keyword">static</span> Cupboard cupboard=<span class="keyword">new</span> <span class="title class_">Cupboard</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* output：</span></span><br><span class="line"><span class="comment">Bowl(1)</span></span><br><span class="line"><span class="comment">Bowl(2)</span></span><br><span class="line"><span class="comment">Table()</span></span><br><span class="line"><span class="comment">f1(1)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Bowl(4)</span></span><br><span class="line"><span class="comment">Bowl(5)</span></span><br><span class="line"><span class="comment">Bowl(3)</span></span><br><span class="line"><span class="comment">Cupboard()</span></span><br><span class="line"><span class="comment">f1(2)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Creating new Cupboard() in main</span></span><br><span class="line"><span class="comment">Bowl(3)</span></span><br><span class="line"><span class="comment">Cupboard()</span></span><br><span class="line"><span class="comment">f1(2)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">Creating new Cupboard() in main</span></span><br><span class="line"><span class="comment">Bowl(3)</span></span><br><span class="line"><span class="comment">Cupboard()</span></span><br><span class="line"><span class="comment">f1(2)</span></span><br><span class="line"><span class="comment">f2(1)</span></span><br><span class="line"><span class="comment">f3(1)</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><strong>静态方法</strong>：静态方法不能访问this变量，但静态方法可以访问静态变量</p>
<h3 id="数组初始化"><a href="#数组初始化" class="headerlink" title="数组初始化"></a>数组初始化</h3><p>数组在java中的定义形式推荐的是：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>[] array;</span><br></pre></td></tr></table></figure>

<p>方括号在前，定义的是一个int类型的数组，比在后面更容易理解</p>
<p>数组的初始化有三种方法，</p>
<ul>
<li>第一种是先定义长度，然后遍历数组，一个个赋值</li>
<li>第二种是用大括号直接赋值</li>
<li>第三种是用new+类型名[]+{值}</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Random</span> <span class="variable">rand</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>(<span class="number">47</span>);</span><br><span class="line">    <span class="comment">//第一种</span></span><br><span class="line">    <span class="type">int</span>[] a = <span class="keyword">new</span> <span class="title class_">int</span>[rand.nextInt(<span class="number">20</span>) + <span class="number">1</span>];</span><br><span class="line">    System.out.println(<span class="string">&quot;array a length:&quot;</span> + a.length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">        a[i] = rand.nextInt(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(Arrays.toString(a));</span><br><span class="line">    <span class="comment">//第二种</span></span><br><span class="line">    Integer[] b = &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">2</span>),</span><br><span class="line">        <span class="number">3</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">	<span class="comment">//第三种</span></span><br><span class="line">    Integer[] c = <span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">1</span>),</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">2</span>),</span><br><span class="line">        <span class="number">3</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组排序"><a href="#数组排序" class="headerlink" title="数组排序"></a>数组排序</h3><p>可以自己写冒泡排序：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; ns.length; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i+<span class="number">1</span>; j &lt; ns.length; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ns[i] &gt; ns[j])&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">t</span> <span class="operator">=</span> ns[i];</span><br><span class="line">            ns[i] = ns[j];</span><br><span class="line">            ns[j] = t;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以直接调用<code>Arrays.sort</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>[] ns=[<span class="number">1</span>,<span class="number">33</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">5</span>]</span><br><span class="line">Arrays.sort(ns)</span><br><span class="line">System.out.println(Arrays.toString(ns));</span><br></pre></td></tr></table></figure>

<p>打印数组的方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法一 Arrays.toString或者Arrays.deeptoString(打印多维数组)</span></span><br><span class="line">System.out.println( Arrays.toString(ns));</span><br><span class="line"><span class="comment">//方法二 foreach遍历</span></span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i: ns)&#123;</span><br><span class="line">    System.out.println(i);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//方法三 for遍历</span></span><br><span class="line"><span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;ns.length;i++)&#123;</span><br><span class="line">    System.out.println(ns[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>tips:</strong></p>
<p>idea快捷键：</p>
<ul>
<li><code>psvm</code>：快速创建main函数</li>
<li><code>sout</code>：快速输入<code>System.out.println()</code></li>
<li><code>fori</code>：快速创建for模板</li>
</ul>
<h3 id="可变参数列表"><a href="#可变参数列表" class="headerlink" title="可变参数列表"></a>可变参数列表</h3><p>在java se5之前用的方法是输入内容放在args里面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VarArgs</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printArray</span><span class="params">(Object[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object obj : args)</span><br><span class="line">            System.out.print(obj + <span class="string">&quot;   &quot;</span>);</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        printArray(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">55</span>), <span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">5.34</span>),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Double</span>(<span class="number">3.56</span>) &#125;);</span><br><span class="line">        printArray(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="string">&quot;one&quot;</span>, <span class="string">&quot;two&quot;</span>, <span class="string">&quot;three&quot;</span> &#125;);</span><br><span class="line">        printArray(<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123; <span class="keyword">new</span> <span class="title class_">A</span>(), <span class="keyword">new</span> <span class="title class_">A</span>(), <span class="keyword">new</span> <span class="title class_">A</span>() &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在se5之后，就可以直接使用可变参数了，这与之前看的javascript的多参数用法一样，与python的<code>*args</code>一样，用法是<code>... args</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NewVarArgs</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printArray</span><span class="params">(Object... args)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object obj : args)</span><br><span class="line">            System.out.print(obj + <span class="string">&quot;  &quot;</span>);</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        printArray(<span class="keyword">new</span> <span class="title class_">Integer</span>(<span class="number">33</span>), <span class="keyword">new</span> <span class="title class_">Float</span>(<span class="number">5.23</span>), <span class="keyword">new</span> <span class="title class_">Double</span>(<span class="number">3.55</span>));</span><br><span class="line">        printArray(<span class="number">33</span>,<span class="number">5.23f</span>,<span class="number">3.55d</span>);</span><br><span class="line">        printArray(<span class="string">&quot;one&quot;</span>,<span class="string">&quot;two&quot;</span>,<span class="string">&quot;three&quot;</span>);</span><br><span class="line">        printArray(<span class="keyword">new</span> <span class="title class_">A</span>(),<span class="keyword">new</span> <span class="title class_">A</span>(),<span class="keyword">new</span> <span class="title class_">A</span>());</span><br><span class="line">        printArray((Object[])<span class="keyword">new</span> <span class="title class_">Integer</span>[]&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>&#125;);</span><br><span class="line">        printArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="枚举enum"><a href="#枚举enum" class="headerlink" title="枚举enum"></a>枚举enum</h3><p>枚举可以用于switch语句，自带ordinal()方法用于得到index，和values方法用于创建数组</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Money m : Money.values())&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;money &quot;</span> + m);</span><br><span class="line">    &#125;</span><br><span class="line">    Money money;</span><br><span class="line">    <span class="keyword">switch</span>(money)&#123;</span><br><span class="line">        <span class="keyword">case</span> one: System.out.println(<span class="string">&quot;case one&quot;</span>);<span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> two:<span class="comment">//剩余逻辑</span></span><br><span class="line">        <span class="keyword">case</span> <span class="keyword">default</span>: <span class="comment">//xxxx</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Money</span>&#123;</span><br><span class="line">    one,five,ten,twenty,fifty,hundred</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="访问权限控制"><a href="#访问权限控制" class="headerlink" title="访问权限控制"></a>访问权限控制</h2><h3 id="包"><a href="#包" class="headerlink" title="包"></a>包</h3><p>一个包里面有多各类，然而有且仅有一个public类与包的名字相同，其他类主要为public类提供支持</p>
<h3 id="包定义与引用"><a href="#包定义与引用" class="headerlink" title="包定义与引用"></a>包定义与引用</h3><p>声明包的方法是用<code>package</code>关键字</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> my.mypackage</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myclass</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>引用的方法可以写全<code>包名+类名</code>，或者是使用<code>import 包名</code></p>
<h3 id="访问权限控制-1"><a href="#访问权限控制-1" class="headerlink" title="访问权限控制"></a>访问权限控制</h3><p>public：都可以访问</p>
<p>private：只有拥有成员的当前类可以访问</p>
<p>protected：当前和继承的对象可以访问</p>
<h3 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h3><p>将类中的属性标记为private，外部代码不可以直接访问类元素，而是通过一些封装好的函数来访问，比如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name.trim();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重载和重写"><a href="#重载和重写" class="headerlink" title="重载和重写"></a>重载和重写</h3><p>重载：与父类的函数名相同，返回值类型相同，但是<strong>参数类型不同</strong></p>
<p>重写（覆写）：与父类的<strong>函数名和参数都相同</strong>，只是函数内容不同</p>
<p>se5中引入了一个<code>@override</code>关键字，在你想要重写的时候，可以把这个关键字放在返回值之前，如果不是重写，那么将会报错</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Lisa</span> <span class="keyword">extends</span> <span class="title class_">Homer</span>&#123;</span><br><span class="line">    <span class="meta">@override</span> </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">doh</span><span class="params">(Milhouse m)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&#x27;doh(Milhouse)&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="继承"><a href="#继承" class="headerlink" title="继承"></a>继承</h3><p>关键字<code>extends</code>，子类继承了父类所有元素和方法，可以重写这些方法</p>
<p>java只允许单继承，也就是每个类只能有一个父类</p>
<p>用<code>super()</code>表示父类的构造方法，用<code>super.函数名()</code>调用父类中被覆写的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setScore</span><span class="params">(<span class="type">int</span> score)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.score = score;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getScore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> score;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().hello() + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="向上向下转型"><a href="#向上向下转型" class="headerlink" title="向上向下转型"></a>向上向下转型</h4><p>在java中，一个类型可以安全地向上转型，因为一个子类肯定包含父类的所有元素和方法，但是父类不一定能够安全地向下转型。</p>
<p>转型之前先用<code>instanceof</code>判断</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (p <span class="keyword">instanceof</span> Student)&#123;</span><br><span class="line">    p = (Student) p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h3><p>java的方法调用总是作用于对象的实际类型</p>
<p>如果一个变量的声明类型和实际类型值不同，那么他调用方法的时候，调用的是实际类型的方法</p>
<p>在java中，多态的含义是：</p>
<ul>
<li>针对某个类型的方法调用，其真正执行的方法取决于运行时期的实际类型的方法</li>
<li>对某个类型调用某个方法，执行的方法可能是某个子类的覆写方法</li>
<li>利用多态，允许添加更多类型的子类实现功能扩展</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hello</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        <span class="type">Person</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        p.run(); <span class="comment">//unamed run</span></span><br><span class="line">        s.run(); <span class="comment">//student run</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    Person(String name, <span class="type">int</span> age)&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    Person()&#123;</span><br><span class="line">        <span class="built_in">this</span>(<span class="string">&quot;unamed&quot;</span>,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.name +  <span class="string">&quot;run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;student &quot;</span>+  <span class="string">&quot;run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java中所有类都继承于object，因此拥有object的所有方法，object中定义了如下的重要方法</p>
<ul>
<li><code>toString</code>：把instance输出为String</li>
<li><code>equals</code>：判断两个instance是否逻辑相等</li>
<li><code>hashCode</code>：计算一个instance的hash值</li>
</ul>
<h4 id="final"><a href="#final" class="headerlink" title="final"></a>final</h4><ul>
<li><p>用<code>final</code>关键字修饰的<strong>方法</strong>不能被override</p>
</li>
<li><p>用<code>final</code>关键字修饰的<strong>类</strong>不能被继承</p>
</li>
<li><p>用<code>final</code>关键字修饰的<strong>字段</strong>在初始化之后不能被修改</p>
</li>
</ul>
<h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>如果一个类包含一个抽象方法，那么这个类就是抽象类</p>
<p>抽象方法：就是一个只有函数名，但是没有函数主体</p>
<p>用abstract关键字修饰，抽象方法无法被实例化，但其子类可以被实例化</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>抽象方法的作用就是用来<strong>被继承</strong></p>
<p>从抽象类继承的子类必须实现抽象方法，不然该子类仍是一个抽象类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rectangle</span> <span class="keyword">extends</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> width;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">double</span> height;</span><br><span class="line">    Rectangle(<span class="type">double</span> width, <span class="type">double</span> height)&#123;</span><br><span class="line">        <span class="built_in">this</span>.width = width;</span><br><span class="line">        <span class="built_in">this</span>.height = height;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">area</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> width*height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>如果一个抽象类没有字段，并且所有方法都是抽象方法，那么我们就可以把这个抽象类改写为接口</p>
<p>接口用interface进行声明，接口默认的是public和abstract，所以在定义接口的时候不用写public和abstract</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Shape</span> &#123;</span><br><span class="line"> <span class="type">double</span> <span class="title function_">area</span><span class="params">()</span>;</span><br><span class="line"> <span class="keyword">default</span> <span class="type">double</span> <span class="title function_">perimeter</span><span class="params">()</span>&#123;<span class="keyword">return</span> <span class="number">0</span>;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>default</code>关键字可以实现interface的默认方法，这样就不必在每个implements中实现这个方法</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-7-25/70419102.jpg"></p>
<p>一个接口可以用extends继承另一个接口</p>
<h3 id="包-1"><a href="#包-1" class="headerlink" title="包"></a>包</h3><p>java定义的名字空间叫做包，用于解决名字冲突的问题</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> xiaoming;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> xiaohong;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>&#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>小明的Person类：xiaoming.Person</p>
<p>小红的Person类：xiaohong.Person</p>
<h4 id="包作用域"><a href="#包作用域" class="headerlink" title="包作用域"></a>包作用域</h4><p>同一个包中的类，可以访问包作用域的字段和方法</p>
<p>包作用域就是不使用任何public，private，protected修饰的字段和方法</p>
<h3 id="classpath"><a href="#classpath" class="headerlink" title="classpath"></a>classpath</h3><p>classpath是一个环境变量，定义java如何搜索class的路径，在windows中用分号<code>；</code>分割，在Linux和mac中用冒号<code>:</code>分割，如果目录含有空格，这个路径就要用双引号括起来</p>
<p>先找当前目录，然后找classpathPATH的路径</p>
<p>运行java的时候可以通过<code>java -cp classpath</code>指定当前运行java时候的classpath</p>
<h3 id="jar包"><a href="#jar包" class="headerlink" title="jar包"></a>jar包</h3><p>jar包是一种zip格式的压缩文件，包含若干个.class文件</p>
<p>jar包相当于目录，classpath可以包含jar文件</p>
<p>一个jar包中可以包含另一个jar包</p>
<p>JDK自带的class叫做rt.jar</p>
<h3 id="idea打包jar包的方法"><a href="#idea打包jar包的方法" class="headerlink" title="idea打包jar包的方法"></a>idea打包jar包的方法</h3><p>1.选择菜单File-&gt;Project Structure，将弹出Project Structure的设置对话框。</p>
<p>2.选择左边的Artifacts后点击上方的“+”按钮</p>
<p>3.在弹出的框中选择jar-&gt;from moduls with dependencies..</p>
<p>4.选择要启动的类，然后 确定</p>
<p>5.应用之后选择菜单Build-&gt;Build Artifacts,选择Build或者Rebuild后即可生成，生成的jar文件位于工程项目目录的out&#x2F;artifacts下。</p>
<h3 id="String字符串类型"><a href="#String字符串类型" class="headerlink" title="String字符串类型"></a>String字符串类型</h3><p>String可以不用new来实例化，可以通过双引号<code>String s = &quot;xxx&quot;</code>直接赋值</p>
<p>String的内容是不可以变的，对比两个string是否相同要调用string的equal方法，equalIgnoreCase，这个方法可以忽略大小写</p>
<p>String提供的方法：</p>
<ul>
<li>contains：查看是否包含子串</li>
<li>indexOf：找到子串的索引位置</li>
<li>lastIndexOf：从后向前找</li>
<li>startswith：返回字符串是否由某个子串开始</li>
<li>endwith：返回字符串是否由某个子串结束</li>
<li>trim：移除首位的空白字符，<code>String S = &quot;\t abc\r\n ；String S2 = S.trim()&quot;</code></li>
<li>substring：提取子串，<code>String S=&quot;hello, world&quot;; String S1 = S.substring(7)//&quot;world&quot;;s.substring(1,5)//&quot;ello&quot;</code>，从0开始，包含最后一个数字</li>
<li>toUppercase, toLowerCase：转换大小写</li>
<li>replace：替换子串</li>
<li>replaceAll：用正则表达式替换子串</li>
<li>join：将一个String数组连接成一个字符串</li>
<li>valueOf：将一个整型转换为一个string类型，也可以用tostring方法转换为字符串</li>
<li>Interger.parseInt(“123”)：将一个String类型转换为一个int类型</li>
<li>toCharArray()：将String转换为char数组，<code>String s =&quot;hello;        char[] c = s.toCharArray();&quot;</code></li>
<li>getBytes(“UTF-8”)：将string转换为bytes</li>
</ul>
<p>打印一个array的方法：<code>Arrays.toString(array)</code></p>
<p>UTF-8和unicode的区别：utf-8是变长的，1-6个字节不等（英文字母只占用1个字节，节省内存）。而unicode所有内容都是2个字节的编码</p>
<h4 id="StringBuilder"><a href="#StringBuilder" class="headerlink" title="StringBuilder"></a>StringBuilder</h4><p>StringBuilder是一个支持链式操作的字符串拼接对象，可以不停地apped，然后用toString变成需要的字符串</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            sb.append(String.valueOf(i));</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(sb.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="JavaBean"><a href="#JavaBean" class="headerlink" title="JavaBean"></a>JavaBean</h3><p>很多java类都是先定义一堆private字段，然后定义相应的get和set方法，这样的类就称为JavaBean</p>
<p>在idea中，定义完一个private字段，在字段上点击<code>alt+enter</code>，就可以快速生成get和set方法</p>
<h3 id="enum枚举类"><a href="#enum枚举类" class="headerlink" title="enum枚举类"></a>enum枚举类</h3><p>用于定义枚举常量</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public enum Person &#123;</span><br><span class="line">    a,b,c,d,e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (Person p: Person.values())&#123;</span><br><span class="line">        System.out.println(p);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(Person.valueOf(<span class="string">&quot;a&quot;</span>).name());</span><br></pre></td></tr></table></figure>

<h3 id="jdk常用工具类"><a href="#jdk常用工具类" class="headerlink" title="jdk常用工具类"></a>jdk常用工具类</h3><ol>
<li><p>Math类用于数学计算</p>
<p>Math有random方法，可以生成一个0-1之间的数<code>0&lt;=x&lt;1</code></p>
</li>
<li><p>Random类用于构建伪随机数<br>使用之前要先实例化random</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Random</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">    System.out.println(r.nextInt());</span><br><span class="line">    System.out.println(r.nextLong());</span><br><span class="line">    System.out.println(r.nextFloat());<span class="comment">//0-1之间的float</span></span><br><span class="line">    System.out.println(r.nextDouble());<span class="comment">//0-1之间的double</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//结果</span></span><br><span class="line"><span class="comment">//453685453</span></span><br><span class="line"><span class="comment">//-6144617524281204827</span></span><br><span class="line"><span class="comment">//0.8796719</span></span><br><span class="line"><span class="comment">//0.9157346073901224</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h2><h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><p>异常处理的方式是用try，catch</p>
<p>java中必须捕获的异常是Exception及其子类，但不包括RuntimeException及其子类</p>
<p>因为error是发生了严重错误，程序本身是无法处理的；而exception是运行时候的逻辑错误，程序可以捕获和处理这些错误，而RuntimeException是因为程序自身有bug，需要我们去修复程序</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-11/24168308.jpg"></p>
<p>Main方法是捕获异常的最后机会，其余子函数可以用throws将异常抛出，由上层方法来捕获</p>
<h4 id="异常捕获的顺序"><a href="#异常捕获的顺序" class="headerlink" title="异常捕获的顺序"></a>异常捕获的顺序</h4><p>异常是按照catch的顺序依次捕获的，所以要把更小的异常（子类）放在前面，不然父类在前面，只要发生了错误就一定会被执行</p>
<h4 id="finally"><a href="#finally" class="headerlink" title="finally"></a>finally</h4><p>无论是否有错都要执行就用finally</p>
<h4 id="multi-catch"><a href="#multi-catch" class="headerlink" title="multi-catch"></a>multi-catch</h4><p>可以用或操作符<code>|</code>来同时捕获多个Exception</p>
<h4 id="printStackTrace"><a href="#printStackTrace" class="headerlink" title="printStackTrace"></a>printStackTrace</h4><p>printStackTrace()方法可以打印出异常的传播路径，对于调试很有用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        process1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">process1</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            process2();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">process2</span><span class="params">()</span>&#123;</span><br><span class="line">        Integer.parseInt(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//抛出如下异常：</span></span><br><span class="line"><span class="comment">//java.lang.NumberFormatException: null</span></span><br><span class="line"><span class="comment">//	at java.base/java.lang.Integer.parseInt(Integer.java:614)</span></span><br><span class="line"><span class="comment">//	at java.base/java.lang.Integer.parseInt(Integer.java:770)</span></span><br><span class="line"><span class="comment">//	at test.Main.process2(Main.java:158)</span></span><br><span class="line"><span class="comment">//	at test.Main.process1(Main.java:151)</span></span><br><span class="line"><span class="comment">//	at test.Main.main(Main.java:147)</span></span><br></pre></td></tr></table></figure>

<h4 id="JDK已定义的异常"><a href="#JDK已定义的异常" class="headerlink" title="JDK已定义的异常"></a>JDK已定义的异常</h4><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-11/18751939.jpg"></p>
<h4 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h4><p>自定义异常，最好使用RuntimeException继承得到，其构造方法可以通过ide提供的<code>alt+insert</code>插入父类的构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BaseExceptions</span> <span class="keyword">extends</span> <span class="title class_">RuntimeException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseExceptions</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseExceptions</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseExceptions</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BaseExceptions</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserNotFoundException</span> <span class="keyword">extends</span> <span class="title class_">BaseExceptions</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserNotFoundException</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserNotFoundException</span><span class="params">(String message)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserNotFoundException</span><span class="params">(String message, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserNotFoundException</span><span class="params">(Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h3><p>assert关键字，如果条件为true则继续执行，条件为false则抛出AssertionError，可以加入一个断言消息，打印出断言结果</p>
<p>断言是一种条件方式，只能在开发和测试阶段使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">assert</span> x&gt;<span class="number">0</span>: <span class="string">&quot;x&lt;0 now&quot;</span>+x;</span><br></pre></td></tr></table></figure>

<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>jkd自带的日志系统在java.utils.logging，可以定义格式或者是重定向到文件等</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> Logger.getGlobal();</span><br><span class="line">        logger.info(<span class="string">&quot;create new person&quot;</span>);</span><br><span class="line">        logger.log(Level.WARNING,<span class="string">&quot;create failed&quot;</span>);</span><br><span class="line">        logger.info(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出</span></span><br><span class="line"><span class="comment">//9月 11, 2018 10:47:09 上午 test.Main main</span></span><br><span class="line"><span class="comment">//信息: create new person</span></span><br><span class="line"><span class="comment">//9月 11, 2018 10:47:09 上午 test.Main main</span></span><br><span class="line"><span class="comment">//警告: create failed</span></span><br><span class="line"><span class="comment">//9月 11, 2018 10:47:09 上午 test.Main main</span></span><br><span class="line"><span class="comment">//信息: end</span></span><br></pre></td></tr></table></figure>

<h3 id="common-logging"><a href="#common-logging" class="headerlink" title="common logging"></a>common logging</h3><p>更常用的log方法是commom logging，一共六个日志级别如下</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-11/56679818.jpg"></p>
<p>tips:</p>
<h4 id="idea添加jar包的方法"><a href="#idea添加jar包的方法" class="headerlink" title="idea添加jar包的方法"></a>idea添加jar包的方法</h4><ol>
<li>点击file，project structure</li>
<li>点击左边的module，点击dependencies，点击add</li>
<li>选择其中的add jar，选中后确定即可</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-12/59568280.jpg"></p>
<h3 id="log4j"><a href="#log4j" class="headerlink" title="log4j"></a>log4j</h3><p>log4j是目前最流行的日志框架，其可以输出到控制台，文件（file），或者是远程（socket）</p>
<p>filter用于过滤：哪些日志需要输出，哪些日志不需要输出</p>
<p>layout：格式化输出</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-12/97700605.jpg"></p>
<h2 id="java反射与泛型"><a href="#java反射与泛型" class="headerlink" title="java反射与泛型"></a>java反射与泛型</h2><h3 id="反射"><a href="#反射" class="headerlink" title="反射"></a>反射</h3><p>class&#x2F;interface的数据类型是Class</p>
<p>将通过Class实例来获取class信息的方法称为反射（reflection）——class实例–&gt;class信息</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//方法1</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> String.class;</span><br><span class="line"><span class="comment">//方法2</span></span><br><span class="line">String s= <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> s.getClass();</span><br><span class="line"><span class="comment">//方法3</span></span><br><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;abc&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>反射的目的：获得某个object实例的时候，可以获得该object的class的所有信息</p>
<p>从class可以判断出class的类型，class提供以下几个方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1</span></span><br><span class="line">isInterface();</span><br><span class="line"><span class="comment">//2</span></span><br><span class="line">isArray();</span><br><span class="line"><span class="comment">//3</span></span><br><span class="line">isEnum();</span><br><span class="line"><span class="comment">//4</span></span><br><span class="line">isPrimitive();<span class="comment">//是否基本类型</span></span><br></pre></td></tr></table></figure>

<p>判断类是否存在：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class.forName(name)</span><br></pre></td></tr></table></figure>

<p>通过class获取Constructor</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">getConstructor(Class):获取某个<span class="keyword">public</span>的Constructor</span><br><span class="line"><span class="title function_">getDeclaredConstructor</span><span class="params">(class)</span>：获取某个Constructor</span><br><span class="line"><span class="title function_">getConstructor</span><span class="params">()</span>：获取所有<span class="keyword">public</span>的Constructor</span><br><span class="line"><span class="title function_">getDeclaredConstructor</span><span class="params">()</span>:获取所有Constructor    </span><br></pre></td></tr></table></figure>

<h4 id="通过反射获得继承关系"><a href="#通过反射获得继承关系" class="headerlink" title="通过反射获得继承关系"></a>通过反射获得继承关系</h4><p>用class的<code>getSuperclass()</code>方法获取分类的class对象，注意：object和interface的父类是null</p>
<p><code>getInterfaces()</code>方法返回当前对象的interface</p>
<p>通过class的<code>isAssignabelFrom()</code>方法可以判断一个向上转型是否正确</p>
<h3 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h3><p>注解是放在java源码的类、方法、字段、参数前的标签，用<code>@</code>开始，有点像python的装饰器</p>
<p>常用的注解包括：</p>
<ol>
<li><code>@Override</code>：检查是否覆写</li>
<li><code>@Deprecated</code>：告诉编译器该方法已经废弃，如果被调用出现警告</li>
<li><code>@SuppressWarnings(&#39;unused&#39;)</code>：抑制警告</li>
<li><code>@Time(timeout=100)</code>：时间检查</li>
<li><code>Check(min=0,max=100,value=55)</code>：值的检查</li>
</ol>
<h4 id="定义注解"><a href="#定义注解" class="headerlink" title="定义注解"></a>定义注解</h4><p>用<code>public @interface name</code>来定义注解</p>
<p>元注解：注解可以修饰别的注解</p>
<p>用@Target定义Annotation可以被应用于源码的哪些位置</p>
<ul>
<li>类或接口：ElementType.TYPE</li>
<li>字段：ElementType.FIELD</li>
<li>方法：ElementType.METHOD</li>
<li>构造方法：ElementType.CONSTRUCTOR</li>
<li>方法参数：ElementType.PARAMETER</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Report&#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">type</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    String <span class="title function_">level</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;info&quot;</span>;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Annotaiton的生命周期，用<code>Retention()</code>来定义</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-13/62763668.jpg"></p>
<p>用<code>@Repeatable</code>定义Annotation是否可以重复</p>
<p>用<code>@Inherited</code>定义子类是否可以继承父类的Anootation</p>
<h4 id="处理Annotation"><a href="#处理Annotation" class="headerlink" title="处理Annotation"></a>处理Annotation</h4><p>通过反射可以处理注解，得到class对象后，可以用<code>class.isAnnotationPresent(Class)</code>来判断注解是否存在，用<code>class.getAnnotation()</code>得到Annotation</p>
<h3 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h3><p>就是用<code>&lt;&gt;</code>来泛化某个类型，比如arraylist在使用过程中，你要指定这个list当中存放的元素类型，就要用<code>ArraryList&lt;String&gt; al = new ArrayList&lt;&gt;();</code></p>
<h2 id="集合"><a href="#集合" class="headerlink" title="集合"></a>集合</h2><h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><p>list是一种有序链表，每个元素都可以通过索引来确定位置</p>
<p>常用方法包括：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-13/79886639.jpg"></p>
<p>list的实现有ArrayList和LinkedList两种：</p>
<p>ArrayList就和数组是一样的结构，当添加的时候大小不够了，就创建一个更大数组，把之前的值全部复制过去，再加一个值</p>
<p>而LinkedList和链表一样的结构，上一个指向下一个</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-13/21021379.jpg"></p>
<h4 id="遍历list的方法"><a href="#遍历list的方法" class="headerlink" title="遍历list的方法"></a>遍历list的方法</h4><ol>
<li>get遍历</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">List</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;list.size();i++)&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> list.get(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Iterator遍历</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">List</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (Iterator&lt;String&gt; it = list.iterator();it.hasNext();)&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> it.next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>foreach循环，最推荐这种方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">List</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span> (String s:list)&#123;</span><br><span class="line">    System.out.println(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="List和Array的转换"><a href="#List和Array的转换" class="headerlink" title="List和Array的转换"></a>List和Array的转换</h4><ol>
<li>Object[] toArray()</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Interger&gt; list = <span class="keyword">new</span> <span class="title class_">List</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line">Object[] array = list.toArray();</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>&lt;T&gt; T[] toArray(T[] a)</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Interger&gt; list = <span class="keyword">new</span> <span class="title class_">List</span>&lt;&gt;();</span><br><span class="line">list.add(<span class="number">1</span>);</span><br><span class="line">list.add(<span class="number">2</span>);</span><br><span class="line">list.add(<span class="number">3</span>);</span><br><span class="line">Integer[] array = list.toArray(list[size]);</span><br></pre></td></tr></table></figure>

<h4 id="查找某个元素是否存在"><a href="#查找某个元素是否存在" class="headerlink" title="查找某个元素是否存在"></a>查找某个元素是否存在</h4><ol>
<li>list.contains(Object o)，返回true包含，false不包含</li>
<li>list.indexOf(Object o)，返回正数就是有，返回-1就是不存在</li>
</ol>
<h3 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h3><p>map就是一种键值对映射的数据结构，与python中的dict是一样的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Strudent</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> String address;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">float</span> grade;</span><br><span class="line">&#125;</span><br><span class="line">Map&lt;String,Student&gt; map = ...;</span><br><span class="line"><span class="type">Student</span> <span class="variable">target</span> <span class="operator">=</span> map.get(<span class="string">&quot;xiao ming&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>map的常用方法</p>
<ol>
<li>put：将key-value对放入map</li>
<li>get：通过key获取value</li>
<li>containsKey：判断key是否存在</li>
</ol>
<h4 id="遍历Map的方法"><a href="#遍历Map的方法" class="headerlink" title="遍历Map的方法"></a>遍历Map的方法</h4><ol>
<li>遍历key</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String,Student&gt; map = ...;</span><br><span class="line"><span class="comment">// 用keySet遍历key，用get方法获取值</span></span><br><span class="line"><span class="keyword">for</span> (String key:map.keySet())&#123;</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> map.get(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>同时遍历key和value</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String,Student&gt; map = ...;</span><br><span class="line"><span class="comment">// 用entrySet同时遍历key，value</span></span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String,Integer&gt; entry:map.entrySet())&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">    <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="HashMap和TreeMap"><a href="#HashMap和TreeMap" class="headerlink" title="HashMap和TreeMap"></a>HashMap和TreeMap</h4><p>Map最常用的实现类是HashMap，其内部存储不保证有序</p>
<ul>
<li>遍历时的顺序不一定是put的顺序，也不一定是key的顺序</li>
</ul>
<p>SortedMap保证遍历时以key排序，其实现类是TreeMap</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Map&lt;String,Integer&gt; map = <span class="keyword">new</span> <span class="title class_">TreeMap</span>&lt;&gt;();</span><br><span class="line">map.put(<span class="string">&quot;orange&quot;</span>,<span class="number">1</span>);</span><br><span class="line">map.put(<span class="string">&quot;apple&quot;</span>,<span class="number">2</span>);</span><br><span class="line">map.put(<span class="string">&quot;banana&quot;</span>,<span class="number">3</span>);</span><br><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String,Integer&gt; entry:map.entrySet())&#123;</span><br><span class="line">    System.out.println(entry.getKey()+<span class="string">&quot; &quot;</span>+entry.getValue());</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><p>set就是python里面的set，不包含重复值，常用方法包括</p>
<ol>
<li>add</li>
<li>remove</li>
<li>contains</li>
<li>size</li>
</ol>
<p>set不保证有序，HashSet是无序的，TreeSet是有序的</p>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p>Queue是一个FIFO的队列，常用方法包括：</p>
<ol>
<li>size()：获取长度</li>
<li>添加元素到队尾:add&#x2F;offer</li>
<li>获取队列头部元素并删除:remove&#x2F;poll</li>
<li>获取队列头部元素但不删除：element()&#x2F;peek()</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-15/26816433.jpg"></p>
<p>Queue的实现对象是LinkedList()</p>
<h3 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h3><p>PriorityQueue就是带有优先级顺序的Queue，其常用方法与Queue相同</p>
<h3 id="Deque"><a href="#Deque" class="headerlink" title="Deque"></a>Deque</h3><p>是Queue的一种实现，是双向队列</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-15/95736586.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-15/93267961.jpg"></p>
<h3 id="Stack"><a href="#Stack" class="headerlink" title="Stack"></a>Stack</h3><p>是一种LIFO（last In First out）的结构，常用方法</p>
<ul>
<li>push</li>
<li>pop</li>
<li>peek</li>
</ul>
<p>使用Deque来实现stack，只调用push，pop，peek三个函数，这样就实现了栈</p>
<h2 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h2><p>IO流，顺序读写数据的模式，单向流动，以字节为单位，byte类型</p>
<p>如果不是字节流，那么久用Reader&#x2F;Writer表示字符流，字符流的最小单位是char，字符流输出的byte取决于编码方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span>[] hello = <span class="string">&quot;hi你好&quot;</span>;</span><br><span class="line">writeChars(hello,<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"><span class="comment">//output.txt，英文字符占一个字节，中文占3个字节</span></span><br><span class="line"><span class="comment">//0x48, 0x69, 0xe4,0xbd,0xa0,0xe5,0xa5,0xbd</span></span><br></pre></td></tr></table></figure>

<p>Reader&#x2F;Writer本质上是一个能自动编解码的InputStream&#x2F;OutputStream</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-16/53060354.jpg"></p>
<p>其实现类如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-16/43531365.jpg"></p>
<h3 id="File"><a href="#File" class="headerlink" title="File"></a>File</h3><p>构造方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">f</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;c\\Windows\\notepad.txt&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>file有三种路径</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;./Person.java&quot;</span>);</span><br><span class="line">System.out.println(<span class="string">&quot;绝对路径：&quot;</span>+file.getAbsolutePath());</span><br><span class="line"><span class="comment">//      C:\Users\jeffrey\IdeaProjects\MyHelloWorld\.\Person.java</span></span><br><span class="line">System.out.println(<span class="string">&quot;canonical（规范）路径：&quot;</span>+file.getCanonicalPath());</span><br><span class="line"><span class="comment">//      C:\Users\jeffrey\IdeaProjects\MyHelloWorld\Person.java</span></span><br><span class="line">System.out.println(<span class="string">&quot;相对路径：&quot;</span>+file.getPath());</span><br><span class="line"><span class="comment">//    .\Person.java</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>规范路径就是绝对路径删掉<code>.</code>和<code>..</code></p>
<p>用<code>isFile()</code>判断是否为文件，<code>isDirectory()</code>判断是否为目录</p>
<p>构造file对象就算是文件不存在也不会报错，因此要用上面两个文件来判断</p>
<ol>
<li><code>canRead()/canWrite() </code>用于判断是否可以读&#x2F;写</li>
<li><code>createNewFile()</code>：创建文件</li>
<li><code>createTempFile()</code>:创建临时文件</li>
<li><code>delete()</code>：删除文件</li>
<li><code>deleteOnExit()</code>：在JVM退出时删除该文件</li>
<li><code>String[] list()</code>：列出文件目录下的文件和子目录名</li>
<li><code>File[] listFiles()</code>：列出文件和子目录名</li>
<li><code>Boolon mkdir()</code>：创建目录</li>
<li><code>Boolon mkdirs()</code>：创建目录，如果上层目录不存在，同样创建</li>
</ol>
<h3 id="InputStream"><a href="#InputStream" class="headerlink" title="InputStream"></a>InputStream</h3><p>是所有输入流的超类，最重要的方法是<code>abstract int read()</code>，读取下一个字节，并返回字节(0-255)，如果已经读到末尾，返回-1</p>
<p>完整读取一个inputstream流程如下：</p>
<ol>
<li>方法1：用finally保证文件被关闭</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./src/test/a.txt&quot;</span>);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">while</span> ((n = input.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input!=<span class="literal">null</span>)&#123;</span><br><span class="line">        input.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>用jdk1.7新增的try写法保证inputStream自动关闭，类似于python的with open(‘xxx’) as f</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./src/test/a.txt&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">while</span> ((n = input.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>用数组一次读取多个字节</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;./src/test/a.txt&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">byte</span>[] buffer = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1000</span>];</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="keyword">while</span> ((n=input.read(buffer))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Reader-x2F-Writer"><a href="#Reader-x2F-Writer" class="headerlink" title="Reader&#x2F;Writer"></a>Reader&#x2F;Writer</h3><p>reader读取的是字符，其read方法读取下一个字符，读到末尾时返回-1</p>
<p>Writer读取的也是字符，write方法写入</p>
<h2 id="java处理时间"><a href="#java处理时间" class="headerlink" title="java处理时间"></a>java处理时间</h2><p>计算机用时间戳来表示时间，这样全球统一表示，然后需要哪个时区的时候再转换为那个时区</p>
<p>java通常使用Date和Calendar处理时间，1.8之后使用LocalDate，LocalTime，ZonedDateTime，Instant</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">System.out.println(System.currentTimeMillis());</span><br><span class="line">System.out.println(date);</span><br><span class="line">System.out.println(date.getTime());</span><br><span class="line">System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>(System.currentTimeMillis()));</span><br></pre></td></tr></table></figure>

<h3 id="LocalDate"><a href="#LocalDate" class="headerlink" title="LocalDate"></a>LocalDate</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">LocalTime</span> <span class="variable">localTime</span> <span class="operator">=</span> LocalTime.now();</span><br><span class="line"><span class="type">LocalDate</span> <span class="variable">localDate</span> <span class="operator">=</span> LocalDate.now();</span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">lt</span> <span class="operator">=</span> LocalDateTime.now();</span><br><span class="line">System.out.println(localDate);</span><br><span class="line">System.out.println(localTime);</span><br><span class="line">System.out.println(lt);</span><br></pre></td></tr></table></figure>

<p>用DateTimeFormatter来格式化时间</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">DateTimeFormatter</span> <span class="variable">dtf</span> <span class="operator">=</span> DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy/MM/dd HH:mm:ss&quot;</span>);</span><br><span class="line">System.out.println(dtf.format(lt));</span><br><span class="line"><span class="type">LocalDateTime</span> <span class="variable">dt2</span> <span class="operator">=</span> LocalDateTime.parse(<span class="string">&quot;2016/11/30 15:16:17&quot;</span>,dtf);</span><br><span class="line">System.out.println(dt2);</span><br></pre></td></tr></table></figure>

<p>新api加入了时间增减的运算，plusDays()增加天数，minusHours()介绍小时</p>
<p>还加入了对时间的调整，比如你获取到了当前日期，你可以使用<code>withDayOfMounth(1)</code>，把日期调整到本月的第一天，<code>withMonth()</code>：调整到第几个月；还可以用with方法，计算本月的最后一天，方法如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//计算本月最后一天</span></span><br><span class="line"><span class="type">LocalDate</span> <span class="variable">lastDay</span> <span class="operator">=</span> LocalDate.now().with(TemporalAdjusters.lastDayOfMonth());</span><br><span class="line">System.out.println(lastDay);</span><br><span class="line"><span class="comment">//计算本月第一个周末</span></span><br><span class="line"><span class="type">LocalDate</span> <span class="variable">firstSunday</span> <span class="operator">=</span> LocalDate.now().with(TemporalAdjusters.firstInMonth(DayOfWeek.SUNDAY));</span><br><span class="line">System.out.println(firstSunday);</span><br></pre></td></tr></table></figure>

<p>还可以判断时间的先后</p>
<ol>
<li>isBefore()</li>
<li>isAfter()</li>
<li>equals()</li>
</ol>
<p>得到当前的Period，就是一段时间间隔的Year，month，day</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LocalDate d1 = LocalDate.of(2014,3,12);</span><br><span class="line">LocalDate d2 = LocalDate.now();</span><br><span class="line">Period p = d1.until(d2);</span><br><span class="line">System.out.println(d2.toEpochDay()-d1.toEpochDay());</span><br></pre></td></tr></table></figure>

<h3 id="ZonedDateTime"><a href="#ZonedDateTime" class="headerlink" title="ZonedDateTime"></a>ZonedDateTime</h3><p>就是一个localtime加上一个时区ZoneId</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">LocalDateTime</span> <span class="variable">d1</span> <span class="operator">=</span> LocalDateTime.of(<span class="number">2014</span>,<span class="number">3</span>,<span class="number">12</span>,<span class="number">8</span>,<span class="number">0</span>);</span><br><span class="line"><span class="comment">//转换到北京时区</span></span><br><span class="line"><span class="type">ZonedDateTime</span> <span class="variable">bj</span> <span class="operator">=</span> d1.atZone(ZoneId.systemDefault());</span><br><span class="line">System.out.println(bj);</span><br><span class="line"><span class="comment">//转换到纽约时区</span></span><br><span class="line"><span class="type">ZonedDateTime</span> <span class="variable">ny</span> <span class="operator">=</span> d1.atZone(ZoneId.of(<span class="string">&quot;America/New_York&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//从北京时区转换到纽约时区</span></span><br><span class="line"><span class="type">ZonedDateTime</span> <span class="variable">ny1</span> <span class="operator">=</span> bj.withZoneSameInstant(ZoneId.of(<span class="string">&quot;America/New_York&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>instant表示时刻</p>
<h2 id="多线程编程"><a href="#多线程编程" class="headerlink" title="多线程编程"></a>多线程编程</h2><p>要启动一个新的线程，首先要创建一个新的线程对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>();</span><br><span class="line">t.start();</span><br></pre></td></tr></table></figure>

<p>将自己的线程extends Thread，覆写其中的run方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> run&#123;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> New <span class="title function_">Mythread</span><span class="params">()</span>;</span><br><span class="line">        t.start();</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>如果本身已经extends，就用implements Runnable，覆写其中的run方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> run&#123;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> New <span class="title function_">Mythread</span><span class="params">()</span>;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(r);</span><br><span class="line">        t.start();</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>一个实现的例子如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;Main start.....&quot;</span>);</span><br><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;thread run.....&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;thread end.....&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">    t.start();</span><br><span class="line">    System.out.println(<span class="string">&quot;Main end......&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程状态"><a href="#线程状态" class="headerlink" title="线程状态"></a>线程状态</h3><p>一个线程只能调用一次start</p>
<p>线程的状态如下：</p>
<ul>
<li>New：新创建</li>
<li>Runnable：运行中</li>
<li>Blocked：被阻塞</li>
<li>Waiting：等待</li>
<li>Timed Waiting：计时等待</li>
<li>Terminated：终止</li>
</ul>
<p>线程终止的原因有：</p>
<ul>
<li>run执行到return</li>
<li>因未捕获的异常终止</li>
</ul>
<h4 id="join"><a href="#join" class="headerlink" title="join"></a>join</h4><p>线程的join方法就是等待该线程结束，才继续向下运行</p>
<h3 id="中断线程"><a href="#中断线程" class="headerlink" title="中断线程"></a>中断线程</h3><p>中断线程需要检测一个isIterrupted标志，调用isIterrupte()方法中断线程</p>
<p>线程之间共享变量需要使用关键字volatile，确保线程能读到更新后的变量值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Main start.....&quot;</span>);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloThread</span>();</span><br><span class="line">    t.start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    t.interrupt();</span><br><span class="line">    System.out.println(<span class="string">&quot;Main end......&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (!isInterrupted()) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也可以用标志位来中断线程，要用到volatile关键字：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HelloThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">running</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (running) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h3><p>守护线程的关键字是<code>t.setDaemon(true)</code></p>
<p>守护线程是为其他线程服务的线程，守护线程在其他所有非守护线程结束的时候结束线程</p>
<p>守护线程不能持有任何资源（打开文件等）</p>
<p>如下，如果不使用守护线程，那么在主线程结束后，下面那个打印时间的线程就无法停下来</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">System.out.println(<span class="string">&quot;main start&quot;</span>);</span><br><span class="line">        <span class="type">Timerthread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timerthread</span>();</span><br><span class="line">        t.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;main end&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Timerthread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">        &#123;     System.out.println(LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy/MM/dd HH:mm:ss&quot;</span>)));</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="线程同步"><a href="#线程同步" class="headerlink" title="线程同步"></a>线程同步</h3><p>当多个线程同时运行的时候，就需要对其同步，比如下面这个例子，对一个count+10000次，再-10000次，最终结果不为0，这是因为对共享变量写入的时候，必须是原子操作（不能被中断的操作），这时就需要线程同步。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Public <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddThread</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DecThread</span>();</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println(count);</span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            Main.count +=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            Main.count -=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>不对的原因：加法的执行过程是load，add，store，如果中间被打断了，比如先执行了Thread 1的load，然后用了thread2的load，add，store操作，再回来执行thread的add操作，此时n仍然是100，因为已经load为100了，所以两次加法之后n只加了1次，等于101，因此必须加解锁</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-17/43911450.jpg"></p>
<p>用synchronized对对象进行加锁，其他线程就算开始执行，没有获得锁，也无法执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(lock)&#123;</span><br><span class="line">    n += <span class="number">1</span>;</span><br><span class="line">    m -= <span class="number">1</span>;</span><br><span class="line">    p = m + n</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面问题的加锁过程如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">Lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Main.Lock)&#123;</span><br><span class="line">            Main.count +=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DecThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (Main.Lock)&#123;</span><br><span class="line">            Main.count -=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><p>Maven是一个项目管理工具，用于管理java代码及文件的编译，打包等过程</p>
<p>用Maven管理的项目路径如下：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-17/42386933.jpg"></p>
]]></content>
      <categories>
        <category>java</category>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>windows开机启动程序</title>
    <url>/2018/12/17/windows%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%E7%A8%8B%E5%BA%8F/</url>
    <content><![CDATA[<p>如果要让某个程序开机启动，可以直接放入开始文件夹中，打开开始文件夹的方法是，运行-<code>shell:startup</code>即可</p>
<p>但是如果某个程序需要通过命令行加上参数运行怎么办呢，这个时候可以用python通过pyinstaller打包成exe文件再放入开始文件夹。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 保存成start_frp.py</span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment"># startupinfo的作用是不显示可视化窗口</span></span><br><span class="line">startupinfo = subprocess.STARTUPINFO()</span><br><span class="line">startupinfo.dwFlags |= subprocess.STARTF_USESHOWWINDOW</span><br><span class="line">subprocess.Popen([<span class="string">r&quot;C:\Users\Jeffrey\OneDrive - sei.xjtu.edu.cn\python exercise\frp_0.22.0_windows_amd64\frpc.exe&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;-c&quot;</span>, <span class="string">r&quot;C:\Users\Jeffrey\OneDrive - sei.xjtu.edu.cn\python exercise\frp_0.22.0_windows_amd64\frpc.ini&quot;</span>],startupinfo=startupinfo).wait()</span><br></pre></td></tr></table></figure>

<p>用<code>pyinstaller start_frp.py -F -w</code>，<code>-F</code>是只生成一个可执行文件，<code>-w</code>是不提供可视化输入输出，这样得到<code>/dist/start_frp.exe</code>，直接放入开始文件夹就行了</p>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>vscode前端插件配置</title>
    <url>/2018/05/27/vscode%E5%89%8D%E7%AB%AF%E6%8F%92%E4%BB%B6%E9%85%8D%E7%BD%AE/</url>
    <content><![CDATA[<h2 id="vscode插件安装"><a href="#vscode插件安装" class="headerlink" title="vscode插件安装"></a>vscode插件安装</h2><span id="more"></span>

<ul>
<li><strong>Atom One Dark Theme</strong> 主题</li>
<li><strong>VSCode Great Icons</strong> 图标主题</li>
<li><strong>Beautify</strong> 美化vscode代码</li>
<li><strong>Bracket Pair Colorizer</strong> 每一对括号用不同颜色区别</li>
<li><strong>Code Runner</strong> node，python等代码不必开命令行即可运行</li>
<li><strong>Eslint</strong> 语法检测</li>
<li><strong>Git History</strong> git提交历史</li>
<li><strong>GitLens</strong> 在代码中显示每一行代码的提交历史</li>
<li><strong>HTML CSS Support</strong> vscode对html，css文件支持，便于你快速书写属性</li>
<li><strong>Path Intellisense</strong> 路径识别苦战，比如书写图片路径时。遗憾就是，对webpack项目中的路径别名无法扩展</li>
<li><strong>Prettier</strong> 格式化，使用大名鼎鼎的prettier对你的文件进行格式化，快捷键 alt+shift +F</li>
<li><strong>Python</strong> 添加对.py文件的支持，毕竟tab与空格的痛苦写过python的都知道</li>
<li><strong>React Native Tools</strong> 添加对 React Native项目的支持，让便你书写es6以及jsx</li>
<li><strong>C&#x2F;C++</strong> 运行React Native项目时，有些文件的查看需要这个</li>
<li><strong>Settings Sync</strong> 用于同步vscode配置（相对而言配置更复杂，可不安装）</li>
<li><strong>Sublime Text Keymap</strong> 启动sublimeText的快捷键配置。vscode上面自有一套快捷键设定，个人习惯sublime了</li>
<li><strong>Vetur</strong> 添加对单文件.vue后缀文件的快速书写支持。computed,mounted等迅速书写</li>
<li><strong>Vue 2 Snippets</strong> 新建vue模板（如何新建参考我另一篇文章）</li>
<li><strong>markdownlint</strong> 书写md文件的预览插件</li>
<li><strong>language-stylus</strong> CSS预处理器styl后缀文件的识别扩展</li>
<li><strong>View In Browser</strong> 迅速通过浏览器打开文件</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&#123; // VScode主题配置</span><br><span class="line">    &quot;editor.tabSize&quot;: 2,</span><br><span class="line">    &quot;editor.lineHeight&quot;: 24,</span><br><span class="line">    &quot;editor.renderLineHighlight&quot;: &quot;none&quot;,</span><br><span class="line">    &quot;editor.renderWhitespace&quot;: &quot;none&quot;,</span><br><span class="line">    &quot;editor.fontFamily&quot;: &quot;Consolas&quot;,</span><br><span class="line">    &quot;editor.fontSize&quot;: 15,</span><br><span class="line">    &quot;editor.cursorBlinking&quot;: &quot;smooth&quot;,</span><br><span class="line">    &quot;editor.multiCursorModifier&quot;: &quot;ctrlCmd&quot;,</span><br><span class="line">    &quot;editor.formatOnPaste&quot;: true,</span><br><span class="line">    // 是否允许自定义的snippet片段提示,比如自定义的vue片段开启后就可以智能提示</span><br><span class="line">    &quot;editor.snippetSuggestions&quot;: &quot;top&quot;,</span><br><span class="line">    &quot;workbench.iconTheme&quot;: &quot;vscode-great-icons&quot;,</span><br><span class="line">    &quot;workbench.colorTheme&quot;: &quot;One Dark Pro Vivid&quot;,</span><br><span class="line">    &quot;workbench.startupEditor&quot;: &quot;newUntitledFile&quot;,</span><br><span class="line">    &quot;html.suggest.angular1&quot;: false,</span><br><span class="line">    &quot;html.suggest.ionic&quot;: false,</span><br><span class="line">    &quot;files.trimTrailingWhitespace&quot;: true,</span><br><span class="line">    // vetur插件格式化使用beautify内置规则</span><br><span class="line">    &quot;vetur.format.defaultFormatter.html&quot;: &quot;js-beautify-html&quot;,</span><br><span class="line">    // VScode 文件搜索区域配置</span><br><span class="line">    &quot;search.exclude&quot;: &#123;</span><br><span class="line">        &quot;**/dist&quot;: true,</span><br><span class="line">        &quot;**/build&quot;: true,</span><br><span class="line">        &quot;**/elehukouben&quot;: true,</span><br><span class="line">        &quot;**/.git&quot;: true,</span><br><span class="line">        &quot;**/.gitignore&quot;: true,</span><br><span class="line">        &quot;**/.svn&quot;: true,</span><br><span class="line">        &quot;**/.DS_Store&quot;: true,</span><br><span class="line">        &quot;**/.idea&quot;: true,</span><br><span class="line">        &quot;**/.vscode&quot;: false,</span><br><span class="line">        &quot;**/yarn.lock&quot;: true,</span><br><span class="line">        &quot;**/tmp&quot;: true</span><br><span class="line">    &#125;,</span><br><span class="line">    // 排除文件搜索区域，比如node_modules(贴心的默认设置已经屏蔽了)</span><br><span class="line">    &quot;files.exclude&quot;: &#123;</span><br><span class="line">        &quot;**/.idea&quot;: true,</span><br><span class="line">        &quot;**/yarn.lock&quot;: true,</span><br><span class="line">        &quot;**/tmp&quot;: true</span><br><span class="line">    &#125;,</span><br><span class="line">    // 配置文件关联，以便启用对应的智能提示，比如wxss使用css</span><br><span class="line">    &quot;files.associations&quot;: &#123;</span><br><span class="line">        &quot;*.vue&quot;: &quot;vue&quot;,</span><br><span class="line">        &quot;*.wxss&quot;: &quot;css&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 配置emmet是否启用tab展开缩写</span><br><span class="line">    &quot;emmet.triggerExpansionOnTab&quot;: true,</span><br><span class="line">    // 配置emmet对文件类型的支持，比如vue后缀文件按照html文件来进行emmet扩写</span><br><span class="line">    &quot;emmet.syntaxProfiles&quot;: &#123;</span><br><span class="line">        &quot;vue-html&quot;: &quot;html&quot;,</span><br><span class="line">        &quot;vue&quot;: &quot;html&quot;,</span><br><span class="line">        &quot;javascript&quot;: &quot;javascriptreact&quot;,</span><br><span class="line">        // xml类型文件默认都是单引号，开启对非单引号的emmet识别</span><br><span class="line">        &quot;xml&quot;: &#123;</span><br><span class="line">            &quot;attr_quotes&quot;: &quot;single&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 在react的jsx中添加对emmet的支持</span><br><span class="line">    &quot;emmet.includeLanguages&quot;: &#123;</span><br><span class="line">        &quot;jsx-sublime-babel-tags&quot;: &quot;javascriptreact&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    // 是否开启eslint检测</span><br><span class="line">    &quot;eslint.enable&quot;: false,</span><br><span class="line">    // 文件保存时，是否自动根据eslint进行格式化</span><br><span class="line">    &quot;eslint.autoFixOnSave&quot;: false,</span><br><span class="line">    // eslint配置文件</span><br><span class="line">    &quot;eslint.options&quot;: &#123;</span><br><span class="line">        &quot;plugins&quot;: [</span><br><span class="line">            &quot;html&quot;,</span><br><span class="line">            &quot;javascript&quot;,</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;language&quot;: &quot;vue&quot;,</span><br><span class="line">                &quot;autoFix&quot;: true</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;vue&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    // eslint能够识别的文件后缀类型</span><br><span class="line">    &quot;eslint.validate&quot;: [</span><br><span class="line">        &quot;javascript&quot;,</span><br><span class="line">        &quot;javascriptreact&quot;,</span><br><span class="line">        &quot;html&quot;,</span><br><span class="line">        &quot;vue&quot;,</span><br><span class="line">        &quot;typescript&quot;,</span><br><span class="line">        &quot;typescriptreact&quot;</span><br><span class="line">    ],</span><br><span class="line">    // 快捷键方案,使用sublime的一套快捷键</span><br><span class="line">    &quot;sublimeTextKeymap.promptV3Features&quot;: true,</span><br><span class="line">    // 格式化快捷键 shirt+alt+F</span><br><span class="line">    // prettier进行格式化时是否安装eslint配置去执行，建议false</span><br><span class="line">    &quot;prettier.eslintIntegration&quot;: true,</span><br><span class="line">    // 如果为true，将使用单引号而不是双引号</span><br><span class="line">    &quot;prettier.singleQuote&quot;: true,</span><br><span class="line">    // 细节,配置gitlen中git提交历史记录的信息显示情况</span><br><span class="line">    &quot;gitlens.advanced.messages&quot;: &#123;</span><br><span class="line">        &quot;suppressCommitHasNoPreviousCommitWarning&quot;: false,</span><br><span class="line">        &quot;suppressCommitNotFoundWarning&quot;: false,</span><br><span class="line">        &quot;suppressFileNotUnderSourceControlWarning&quot;: false,</span><br><span class="line">        &quot;suppressGitVersionWarning&quot;: false,</span><br><span class="line">        &quot;suppressLineUncommittedWarning&quot;: false,</span><br><span class="line">        &quot;suppressNoRepositoryWarning&quot;: false,</span><br><span class="line">        &quot;suppressResultsExplorerNotice&quot;: false,</span><br><span class="line">        &quot;suppressUpdateNotice&quot;: true,</span><br><span class="line">        &quot;suppressWelcomeNotice&quot;: false</span><br><span class="line">    &#125;,</span><br><span class="line">    // 开启apicloud在vscode中的wifi真机同步</span><br><span class="line">    &quot;apicloud.port&quot;: &quot;23450&quot;,</span><br><span class="line">    // 设置apicloud在vscode中的wifi真机同步根目录</span><br><span class="line">    &quot;apicloud.subdirectories&quot;: &quot;/apiclouduser&quot;,</span><br><span class="line">    // git是否启用自动拉取</span><br><span class="line">    &quot;git.autofetch&quot;: true,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>编程学习</category>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>准确率(Accuracy),精确率(Precision),召回率(Recall)和F1-Measure(转)</title>
    <url>/2018/12/04/%E5%87%86%E7%A1%AE%E7%8E%87-Accuracy-%E7%B2%BE%E7%A1%AE%E7%8E%87-Precision-%E5%8F%AC%E5%9B%9E%E7%8E%87-Recall-%E5%92%8CF1-Measure/</url>
    <content><![CDATA[<p>器学习(ML), 自然语言处理(NLP), 信息检索(IR)等领域, 评估(Evaluation)是一个必要的工作, 而其评价指标往往有如下几点: 准确率(Accuracy), 精确率(Precision), 召回率(Recall) 和 F1-Measure.(注：相对来说，IR 的 ground truth 很多时候是一个 Ordered List, 而不是一个 Bool 类型的 Unordered Collection，在都找到的情况下，排在第三名还是第四名损失并不是很大，而排在第一名和第一百名，虽然都是“找到了”，但是意义是不一样的，因此更多可能适用于 <a href="https://en.wikipedia.org/wiki/Information%20retrieval#Mean_average_precision">MAP</a> 之类评估指标.)</p>
<span id="more"></span>

<p>本文将简单介绍其中几个概念. 中文中这几个评价指标翻译各有不同, 所以一般情况下推荐使用英文.</p>
<p>现在我先假定一个具体场景作为例子.</p>
<blockquote>
<p>假如某个班级有男生 <strong>80</strong> 人, 女生<strong>20</strong>人, 共计 <strong>100</strong> 人. 目标是找出所有女生. 现在某人挑选出 <strong>50</strong> 个人, 其中 <strong>20</strong> 人是女生, 另外还错误的把 30 个男生也当作女生挑选出来了. 作为评估者的你需要来评估(<strong>evaluation</strong>)下他的工作</p>
</blockquote>
<p>首先我们可以计算<strong>准确率(accuracy)</strong>, 其定义是: 对于给定的测试数据集，分类器正确分类的样本数与总样本数之比. 也就是损失函数是0-1损失时测试数据集上的准确率.</p>
<p>这样说听起来有点抽象，简单说就是，前面的场景中，实际情况是那个班级有男的和女的两类，某人(也就是定义中所说的分类器)他又把班级中的人分为男女两类. accuracy 需要得到的是此君<strong>分正确的人</strong>占<strong>总人数</strong>的比例. 很容易，我们可以得到:他把其中70(20女+50男)人判定正确了, 而总人数是100人，所以它的 accuracy 就是70 %(70 &#x2F; 100).</p>
<p>由准确率，我们的确可以在一些场合，从某种意义上得到一个分类器是否有效，但它并不总是能有效的评价一个分类器的工作. 举个例子, google 抓取了 argcv 100个页面，而它索引中共有10,000,000个页面, 随机抽一个页面，分类下, 这是不是 argcv 的页面呢?如果以 accuracy 来判断我的工作，那我会把所有的页面都判断为”不是 argcv 的页面”, 因为我这样效率非常高(return false, 一句话), 而 accuracy 已经到了99.999%(9,999,900&#x2F;10,000,000), 完爆其它很多分类器辛辛苦苦算的值, 而我这个算法显然不是需求期待的, 那怎么解决呢?这就是 precision, recall 和 f1-measure 出场的时间了.</p>
<p>再说 precision, recall 和 f1-measure 之前, 我们需要先需要定义 TP, FN, FP, TN 四种分类情况.</p>
<p>按照前面例子, 我们需要从一个班级中的人中寻找所有<strong>女生</strong>, 如果把这个任务当成一个分类器的话, 那么女生就是我们需要的, 而男生不是, 所以我们称女生为”正类”, 而男生为”负类”.</p>
<table>
<thead>
<tr>
<th></th>
<th><strong>相关(Relevant), 正类</strong></th>
<th><strong>无关(NonRelevant), 负类</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>被检索到(Retrieved)</strong></td>
<td><em>true positives</em> (TP 正类判定为正类, 例子中就是正确的判定”这位是女生”)</td>
<td><em>false positives</em> (FP 负类判定为正类,”存伪”, 例子中就是分明是男生却判断为女生, 当下伪娘横行, 这个错常有人犯)</td>
</tr>
<tr>
<td><strong>未被检索到(Not Retrieved)</strong></td>
<td><em>false negatives</em> (FN 正类判定为负类,”去真”, 例子中就是, 分明是女生, 这哥们却判断为男生–梁山伯同学犯的错就是这个)</td>
<td><em>true negatives</em> (TN 负类判定为负类, 也就是一个男生被判断为男生, 像我这样的纯爷们一准儿就会在此处)</td>
</tr>
</tbody></table>
<p>可以很容易看出, 所谓 TRUE&#x2F;FALSE 表示从结果是否分对了, Positive&#x2F;Negative 表示<strong>我们认为的</strong>是”是”还是”不是”.</p>
<p>通过这张表, 我们可以很容易得到这几个值:</p>
<ul>
<li>TP&#x3D;20</li>
<li>FP&#x3D;30</li>
<li>FN&#x3D;0</li>
<li>TN&#x3D;50</li>
</ul>
<p>**精确率(precision)**的公式是$P &#x3D; \frac{TP}{TP+FP}$, 它计算的是所有”正确被检索的结果(TP)”占所有”实际被检索到的(TP+FP)”的比例.</p>
<p>在例子中就是希望知道此君得到的所有人中, 正确的人(也就是女生)占有的比例. 所以其 precision 也就是40%(20女生&#x2F;(20女生+30误判为女生的男生)).</p>
<p>**召回率(recall)**的公式是$R &#x3D; \frac{TP}{TP+FN}$, 它计算的是所有”正确被检索的结果(TP)”占所有”应该检索到的结果(TP+FN)”的比例.</p>
<p>在例子中就是希望知道此君得到的女生占本班中所有女生的比例, 所以其 recall 也就是100%(20女生&#x2F;(20女生+ 0 误判为男生的女生))</p>
<p>F1值就是精确值和召回率的调和均值, 也就是</p>
<p>$\frac{2}{F_1} &#x3D; \frac{1}{P} + \frac{1}{R}$</p>
<p>调整下也就是</p>
<p>$F_1 &#x3D; \frac{2PR}{P+R} &#x3D; \frac{2TP}{2TP + FP + FN}$</p>
<p>例子中 F1-measure 也就是约为 57.143%($\frac{2 * 0.4 * 1}{0.4 + 1}$).</p>
<p>需要说明的是, 有人列了这样个公式<a href="https://en.wikipedia.org/wiki/Precision_and_recall#F-measure">[F-measure]</a>, 对非负实数$\beta$</p>
<p>$F_\beta &#x3D; (\beta^2 + 1) \times \frac{PR}{\beta^2\times P+R}$</p>
<p>将 F-measure 一般化.</p>
<p>F1-measure 认为精确率和召回率的权重是一样的, 但有些场景下, 我们可能认为精确率会更加重要, 调整参数 β , 使用 $F_\beta-measure$ 可以帮助我们更好的 evaluate 结果.</p>
<p>转自:<a href="https://blog.argcv.com/articles/1036.c">https://blog.argcv.com/articles/1036.c</a></p>
]]></content>
      <categories>
        <category>机器学习</category>
      </categories>
      <tags>
        <tag>机器学习</tag>
      </tags>
  </entry>
  <entry>
    <title>在服务器部署Jupyter Notebook</title>
    <url>/2018/09/25/%E5%9C%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%83%A8%E7%BD%B2Jupyter-Notebook/</url>
    <content><![CDATA[<p>在服务器安装Jupyter后：<br> 1、生成配置文件<code>$jupyter notebook --generate-config</code><br> 2、终端输入<code>ipython</code>,生成密码</p>
<span id="more"></span>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">In [<span class="number">1</span>]: <span class="keyword">from</span> notebook.auth <span class="keyword">import</span> passwd</span><br><span class="line">In [<span class="number">2</span>]: passwd()</span><br><span class="line">Enter password: </span><br><span class="line">Verify password: </span><br><span class="line">Out[<span class="number">2</span>]: <span class="string">&#x27;sha1:XXX……XXX&#x27;</span>````</span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、`vim /root/.jupyter`修改配置。</span><br><span class="line">```</span><br><span class="line">c.NotebookApp.ip=<span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">c.NotebookApp.password = <span class="string">u&#x27;sha1:XXX……XXX#填入步骤2的密文的）&#x27;</span></span><br><span class="line">c.NotebookApp.notebook_dir = <span class="string">u&#x27;/home/py&#x27;</span><span class="comment">#设置文件的存放目录</span></span><br><span class="line">c.NotebookApp.open_browser = <span class="literal">False</span><span class="comment"># 禁止在运行ipython的同时弹出</span></span><br><span class="line">c.NotebookApp.port =<span class="number">8888</span> <span class="comment">#也可以指定其他端口</span></span><br><span class="line">```</span><br><span class="line"></span><br><span class="line"><span class="number">4</span>、启动Jupyter，终端输入：</span><br><span class="line">`jupyter notebook --config=/root/.jupyter/jupyter_notebook_config.py`</span><br><span class="line">或是直接`nohup jupyter notebook &amp;`</span><br><span class="line">或是直接`nohup jupyter lab &amp;`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">5</span>、本地链接服务器Jupyter，解决服务器防火墙设置的问题，本地建立一个ssh通道，在本地终端输入：</span><br><span class="line">` ssh user@address -L <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1234</span>:<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8888</span>` </span><br><span class="line">user=服务器用户名</span><br><span class="line">address=通道名</span><br><span class="line">完成后，在浏览器输入</span><br><span class="line">`http://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">1234</span>/`输入步骤<span class="number">2</span>自己设置的密码即可访问。</span><br><span class="line"></span><br><span class="line"><span class="number">6</span>、ssh连接Linux，想关闭终端后，后台台还可以运行程序  可以使用nohup命令：</span><br><span class="line">```</span><br><span class="line">nohup jupyter notebook --config=/root/.jupyter/jupyter_notebook_config.py</span><br><span class="line">```</span><br><span class="line">tips：</span><br><span class="line">阿里云可能会出现socket.error: [Errno <span class="number">99</span>] Cannot assign requested address错误，是因为阿里云的安全策略，没有开启服务器端口，防火墙问题，如果实在想知道，给我留言，手把手教学。不过可以通过上面的的教程</span><br><span class="line">设置配置文件，通过ssh转接。</span><br></pre></td></tr></table></figure>

<p>转自：<a href="https://www.jianshu.com/p/362e0200f421">https://www.jianshu.com/p/362e0200f421</a></p>
]]></content>
      <categories>
        <category>编程工具</category>
      </categories>
      <tags>
        <tag>编程工具</tag>
      </tags>
  </entry>
  <entry>
    <title>将flask项目通过centos部署到公网</title>
    <url>/2017/08/02/%E5%B0%86flask%E9%A1%B9%E7%9B%AE%E9%80%9A%E8%BF%87centos%E9%83%A8%E7%BD%B2%E5%88%B0%E5%85%AC%E7%BD%91/</url>
    <content><![CDATA[<p><strong>基本的部署方式是通过Flaks + WSGI + Nginx</strong></p>
<p>首先通过远程连接到服务器</p>
<span id="more"></span>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ssh root@远程服务器ip  -p 远程服务器端口</span><br></pre></td></tr></table></figure>

<p>输入密码之后进入远程服务器的操作</p>
<h2 id="首先安装pip"><a href="#首先安装pip" class="headerlink" title="首先安装pip"></a>首先安装pip</h2><p>获取<code>get-pip.py</code>文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</span><br></pre></td></tr></table></figure>

<p>执行安装：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python get-pip.py</span><br></pre></td></tr></table></figure>

<h2 id="安装virtualenv"><a href="#安装virtualenv" class="headerlink" title="安装virtualenv"></a>安装virtualenv</h2><p>因为不同的项目可能需要不同的安装包的版本，所以我们往往不是直接在系统中安装Python的各种包，而是通过<code>virtualenv</code>建立虚拟的Python环境</p>
<p>首先通过pip安装virtualenv</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install virtual</span><br></pre></td></tr></table></figure>

<p>然后创建一个项目文件夹</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir my_web_app</span><br><span class="line">cd my_web_app</span><br></pre></td></tr></table></figure>

<p>在my_web_app文件夹中创建虚拟环境：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">virtualenv venv</span><br></pre></td></tr></table></figure>

<p>开启虚拟环境：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">source ./venv/bin/activate</span><br></pre></td></tr></table></figure>

<p> <em>如果需要关闭虚拟环境</em>：<code>deactivate</code></p>
<p>此时你的命令行在最前面多了一个<code>(venv)</code>的标志，证明你已经进入了虚拟环境</p>
<h2 id="安装依赖库"><a href="#安装依赖库" class="headerlink" title="安装依赖库"></a>安装依赖库</h2><p>要使用Flask框架写网页，就需要安装一系列跟Flask相关的库，此时可以使用<code>pip</code>命令的通过文件进行安装：</p>
<p>先建立一个requirements.txt，在其中写上需要安装的库的名称和版本号(版本号可以不写，默认安装最新版本)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$</span><span class="language-bash"><span class="built_in">touch</span> requirements.txt</span></span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">vim requirements.txt</span></span><br></pre></td></tr></table></figure>

<p>在其中写入以下内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Flask==<span class="number">0.10</span><span class="number">.1</span></span><br><span class="line">Flask-Login==<span class="number">0.2</span><span class="number">.11</span></span><br><span class="line">Flask-Mail==<span class="number">0.9</span><span class="number">.1</span></span><br><span class="line">Flask-Moment==<span class="number">0.4</span><span class="number">.0</span></span><br><span class="line">Flask-PageDown==<span class="number">0.1</span><span class="number">.5</span></span><br><span class="line">Flask-SQLAlchemy==<span class="number">2.0</span></span><br><span class="line">Flask-Script==<span class="number">2.0</span><span class="number">.5</span></span><br><span class="line">Flask-WTF==<span class="number">0.10</span><span class="number">.2</span></span><br><span class="line">Flask-Cache==<span class="number">0.13</span><span class="number">.1</span></span><br><span class="line">Flask-Restless==<span class="number">0.15</span><span class="number">.0</span></span><br><span class="line">Flask-Uploads==<span class="number">0.1</span><span class="number">.3</span></span><br><span class="line">Jinja2==<span class="number">2.7</span><span class="number">.3</span></span><br><span class="line">Mako==<span class="number">1.0</span><span class="number">.0</span></span><br><span class="line">Markdown==<span class="number">2.5</span><span class="number">.1</span></span><br><span class="line">MarkupSafe==<span class="number">0.23</span></span><br><span class="line">SQLAlchemy==<span class="number">0.9</span><span class="number">.8</span></span><br><span class="line">WTForms==<span class="number">2.0</span><span class="number">.1</span></span><br><span class="line">Werkzeug==<span class="number">0.9</span><span class="number">.6</span></span><br><span class="line">html5lib==<span class="number">1.0</span>b3</span><br><span class="line">itsdangerous==<span class="number">0.24</span></span><br><span class="line">six==<span class="number">1.8</span><span class="number">.0</span></span><br><span class="line">awesome-slugify==<span class="number">1.6</span></span><br></pre></td></tr></table></figure>

<p>然后通过<code>pip</code>进行批量安装：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br></pre></td></tr></table></figure>

<p>然后我们需要安装uSWGI，主要用于部署Flask项目：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install uSWGI</span><br></pre></td></tr></table></figure>

<h2 id="上传项目文件"><a href="#上传项目文件" class="headerlink" title="上传项目文件"></a>上传项目文件</h2><p>项目文件的组织结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">root/wz/</span><br><span class="line">└── my_flask  </span><br><span class="line">│   ├── logs</span><br><span class="line">│   └── venv  //虚拟目录</span><br><span class="line">│   │   ├── bin</span><br><span class="line">│   │   │         ├── activate</span><br><span class="line">│   │   │         ├── easy_install</span><br><span class="line">│   │   │         ├── gunicorn</span><br><span class="line">│   │   │         ├── pip</span><br><span class="line">│   │   │         └── python</span><br><span class="line">│   │   ├── include</span><br><span class="line">│   │   │          └── python2.7 -&gt; /usr/include/python2.7</span><br><span class="line">│   │   ├── lib</span><br><span class="line">│   │   │         └── python2.7</span><br><span class="line">│   │   ├── local</span><br><span class="line">│   │   │         ├── bin -&gt; /home/shenye/shenyefuli/bin</span><br><span class="line">│   │   │         ├── include -&gt; /home/shenye/shenyefuli/include</span><br><span class="line">│   │   │         └── lib -&gt; /home/shenye/shenyefuli/lib</span><br><span class="line">│   └── app  //Flask 程序目录</span><br><span class="line">│   │           └──  __init__.py //这是程序包文件。这个目录下还有其它的文件此处略过</span><br><span class="line">│   ├── manage.py   </span><br><span class="line">│   ├── requirements.txt             </span><br></pre></td></tr></table></figure>

<p>在app文件夹下的<code>__init__.py</code>文件进行修改，我们使用一个最简单的程序进行演示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"> </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"> </span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hello</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Hello World!&quot;</span></span><br></pre></td></tr></table></figure>

<p>然后在app的上一级文件夹建立<code>manage.py</code>文件用于运行程序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask_script <span class="keyword">import</span> Manager,Server</span><br><span class="line"><span class="keyword">from</span> app <span class="keyword">import</span> app</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">manager = Manager(app)</span><br><span class="line">manager.add_command(<span class="string">&#x27;runserver&#x27;</span>,Server(host=<span class="string">&#x27;0.0.0.0&#x27;</span>,port=<span class="number">5000</span>,use_debugger=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    manager.run()</span><br></pre></td></tr></table></figure>

<p>此时如果我们使用命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure>

<p>已经可以运行在本地 <code>http://127.0.0.1:5000</code></p>
<h3 id="接下来开始配置uWSGI"><a href="#接下来开始配置uWSGI" class="headerlink" title="接下来开始配置uWSGI"></a>接下来开始配置uWSGI</h3><p>uWSGI有两种启动方式，在这里我们选了通过配置文件启动的方法</p>
<p>在项目目录中新建config.ini，写入如下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[uwsgi]</span><br><span class="line"></span><br><span class="line"># uwsgi 启动时所使用的地址与端口</span><br><span class="line">http = 0.0.0.0:8000</span><br><span class="line"></span><br><span class="line"># 指向网站目录</span><br><span class="line">chdir = /root/wz</span><br><span class="line"></span><br><span class="line">home = /root/wz/venv</span><br><span class="line"></span><br><span class="line"># python 启动程序文件</span><br><span class="line">wsgi-file = manage.py</span><br><span class="line"></span><br><span class="line"># python 程序内用以启动的 application 变量名</span><br><span class="line">callable = app</span><br><span class="line"></span><br><span class="line"># 处理器数</span><br><span class="line">processes = 4</span><br><span class="line"></span><br><span class="line"># 线程数</span><br><span class="line">threads = 2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里的8000就是我们外网访问时服务器监听的地址，由于我的路由器是搭在一个路由器下面的，此时我们需要登录路由器的设置界面设置端口转发：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-2/21096261.jpg"></p>
<p>填写内网ip地址和本地端口，以及需要映射到外网的端口，在项目中，我们把本地的8000端口映射为外网的6000端口</p>
<p>配置好端口之后，输入命令直接运行uWSGI：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">uwsgi config.ini</span><br></pre></td></tr></table></figure>

<p>到此为止，我们已经可以通过<code>服务器公网ip:6000</code>访问你的Flask应用</p>
<h3 id="安装-Supervisor"><a href="#安装-Supervisor" class="headerlink" title="安装 Supervisor"></a>安装 Supervisor</h3><p>[Supervisor|<a href="http://supervisord.org/configuration.html">http://supervisord.org/configuration.html</a>]可以同时启动多个应用，最重要的是，当某个应用Crash的时候，他可以自动重启该应用，保证可用性。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install supervisor</span><br></pre></td></tr></table></figure>

<p>Supervisor 的全局的配置文件位置在：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/supervisor/supervisor.conf</span><br></pre></td></tr></table></figure>

<p>正常情况下我们并不需要去对其作出任何的改动，只需要添加一个新的 *.conf 文件放在</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/etc/supervisor/conf.d/</span><br></pre></td></tr></table></figure>

<p>下就可以，那么我们就新建立一个用于启动 my_flask 项目的 uwsgi 的 supervisor 配置 (命名为：my_flask_supervisor.conf)：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[program:my_flask]</span><br><span class="line"># 启动命令入口</span><br><span class="line">command=/home/www/my_flask/venv/bin/uwsgi /home/www/my_flask/config.ini</span><br><span class="line"></span><br><span class="line"># 命令程序所在目录</span><br><span class="line">directory=/home/www/my_flask</span><br><span class="line">#运行命令的用户名</span><br><span class="line">user=root</span><br><span class="line">        </span><br><span class="line">autostart=true</span><br><span class="line">autorestart=true</span><br><span class="line">#日志地址</span><br><span class="line">stdout_logfile=/home/www/my_flask/logs/uwsgi_supervisor.log        </span><br></pre></td></tr></table></figure>

<h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo service supervisor start</span><br></pre></td></tr></table></figure>

<h4 id="终止服务"><a href="#终止服务" class="headerlink" title="终止服务"></a>终止服务</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo service supervisor stop</span><br></pre></td></tr></table></figure>

<h2 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h2><p>[Nginx|<a href="http://nginx.com/">http://nginx.com/</a>]是轻量级、性能强、占用资源少，能很好的处理高并发的反向代理软件。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install nginx</span><br></pre></td></tr></table></figure>

<h3 id="配置-Nginx"><a href="#配置-Nginx" class="headerlink" title="配置 Nginx"></a>配置 Nginx</h3><p>Ubuntu 上配置 Nginx 也是很简单，不要去改动默认的 nginx.conf 只需要将</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/ext/nginx/sites-available/default</span><br></pre></td></tr></table></figure>

<p>文件替换掉就可以了。</p>
<p>新建一个 default 文件:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">  listen  80;</span><br><span class="line">  server_name XXX.XXX.XXX; #公网地址</span><br><span class="line"></span><br><span class="line">  location / &#123;</span><br><span class="line">    include      uwsgi_params;</span><br><span class="line">    uwsgi_pass   127.0.0.1:8001;  # 指向uwsgi 所应用的内部地址,所有请求将转发给uwsgi 处理</span><br><span class="line">    uwsgi_param UWSGI_PYHOME /home/www/my_flask/venv; # 指向虚拟环境目录</span><br><span class="line">    uwsgi_param UWSGI_CHDIR  /home/www/my_flask; # 指向网站根目录</span><br><span class="line">    uwsgi_param UWSGI_SCRIPT manage:app; # 指定启动程序</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将default配置文件替换掉就大功告成了！<br>还有，更改配置还需要记得重启一下nginx:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo service nginx restart</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>flask</tag>
      </tags>
  </entry>
  <entry>
    <title>建造者模式</title>
    <url>/2019/11/14/%E5%BB%BA%E9%80%A0%E8%80%85%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<h2 id="什么是构建器以及为什么要使用构建器"><a href="#什么是构建器以及为什么要使用构建器" class="headerlink" title="什么是构建器以及为什么要使用构建器"></a>什么是构建器以及为什么要使用构建器</h2><p>假设某个类,现在有3个必选属性,有5个可选属性.(为了代码简洁,后面都只写一个必选属性,2个可选属性.懂就行).</p>
<p>那么现在想提供完善的<code>创建该类的机制</code>,该怎么办呢?</p>
<p>首先是方法1-使用重叠的构造方法.</p>
<span id="more"></span>

<h4 id="重叠的构造方法"><a href="#重叠的构造方法" class="headerlink" title="重叠的构造方法"></a>重叠的构造方法</h4><p>这是大家都熟悉的方法，重载很多个构造方法,每个的参数都不一样，这样的复杂度比较大。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必选</span></span><br><span class="line">    String name;</span><br><span class="line">    <span class="comment">// 可选</span></span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(String name, <span class="type">int</span> age, String title)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">        <span class="built_in">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>三个构造方法是不是已经比较复杂了，30个属性的类也不少见噢，写死人了要.</p>
<p>而且这样还有一个缺点：可读性太差了,在调用的时候你会看到编译器提醒你有30个构造方法可以调用,并且只显示参数类型不显示参数名字(比如一个8个int参数的构造方法,鬼知道应该按照什么顺序传入啊),你根本不知道该怎么用….</p>
<p>那么还有第二种方法:</p>
<h4 id="javabean-即使用setter"><a href="#javabean-即使用setter" class="headerlink" title="javabean,即使用setter."></a>javabean,即使用setter.</h4><p>对每个属性都提供set方法，当新建一个类之后，就可以调用对应的set方法对属性设值</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必选</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// 可选</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTitle</span><span class="params">(String title)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.title = title;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样的调用方式，每一个set是一行，非常不简洁</p>
<h4 id="Builder模式"><a href="#Builder模式" class="headerlink" title="Builder模式"></a>Builder模式</h4><p>建造者模式第一次接触是在阿里实习的时候，当时使用guava来实现localCache，所谓的建造者模式就是创建类并设值其各filed的方法，举个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> a;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> b;</span><br><span class="line">  <span class="keyword">private</span> String c;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">A</span> <span class="variable">x</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>.builder().a(<span class="number">1</span>).b(<span class="number">2</span>).c(<span class="string">&quot;ok&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那么如何实现这样的方式呢?</p>
<p>如果自己实现的话，可以借助静态内部类，把类的构造函数变为私有的，传入的参数是这个静态内部类Builder，静态内部类按照各个属性进行build，返回值都是Builder类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 必选</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">// 可选</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">        <span class="comment">// 必选</span></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="comment">// 可选</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">        <span class="keyword">private</span> String title;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Builder</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">age</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.age = age;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Builder <span class="title function_">title</span><span class="params">(String s)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.title = s;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Student <span class="title function_">build</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Student</span><span class="params">(Builder builder)</span> &#123;</span><br><span class="line">        name = builder.name;</span><br><span class="line">        age = builder.age;</span><br><span class="line">        title = builder.title;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用方使用方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">	  <span class="type">Student</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Builder</span>(<span class="string">&quot;xx&quot;</span>).age(<span class="number">11</span>).title(<span class="string">&quot;888&quot;</span>).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样写当然是有弊端的:</p>
<ol>
<li>在创建的过程中多创建了一个对象,这对性能肯定是有影响的,所以在极限要求性能的场景可以注意一下.</li>
<li>代码比重叠构造器的代码都多，写起来复杂度很大</li>
</ol>
<h4 id="lombok实现建造者模式"><a href="#lombok实现建造者模式" class="headerlink" title="lombok实现建造者模式"></a>lombok实现建造者模式</h4><p>那么有一个比较好的方法就是lombok来实现，直接在类上面@Builder就可以实现了，</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调用方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">	  <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> A.builder().name(<span class="string">&quot;xxx&quot;</span>).age(<span class="number">10</span>).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这样的lombok存在一个问题，就是在继承的时候，父类的构造字段不会被子类继承</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String parentName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> parentAge;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String childName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> childAge;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在使用Child类的builder的时候，无法继承parent的parentName和parentAge字段</p>
<p>解决方法如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String parentName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> parentAge;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String childName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> childAge;</span><br><span class="line"> </span><br><span class="line">    <span class="meta">@Builder</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Child</span><span class="params">(String parentName, <span class="type">int</span> parentAge, String childName, <span class="type">int</span> childAge)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parentName, parentAge);</span><br><span class="line">        <span class="built_in">this</span>.childName = childName;</span><br><span class="line">        <span class="built_in">this</span>.childAge = childAge;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但这种方法比较复杂，在lombok1.18版本后，出现一个新的注解是@superBuilder，这个注解解决了这个问题</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">    <span class="comment">// same as before...</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Child</span> <span class="keyword">extends</span> <span class="title class_">Parent</span> &#123;</span><br><span class="line">   <span class="comment">// same as before...</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@SuperBuilder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Child</span> &#123;</span><br><span class="line">   <span class="comment">// same as before...</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>java</category>
      </categories>
      <tags>
        <tag>java</tag>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>批量kill Linux进程</title>
    <url>/2018/07/08/%E6%89%B9%E9%87%8Fkill-Linux%E8%BF%9B%E7%A8%8B/</url>
    <content><![CDATA[<p>有时候因为一些情况，需要把 <strong>linux</strong> 下符合某一项条件的所有进程 <strong>kill</strong> 掉，又不能用 <strong>killall</strong> 直接杀掉某一进程名称包含的所有运行中进程（我们可能只需要杀掉其中的某一类或运行指定参数命令的进程），这个时候我们需要运用 <strong>ps</strong>, <strong>grep</strong>, <strong>cut</strong> 和 <strong>kill</strong> 一起操作。  ok，下面给出具体的参考： </p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ps -ef|grep LOCAL=NO|grep -v grep|<span class="built_in">cut</span> -c 9-15|xargs <span class="built_in">kill</span> -9  </span><br></pre></td></tr></table></figure>

<span id="more"></span>

<p>运行这条命令将会杀掉所有含有关键字”LOCAL&#x3D;NO”的进程，是不是很方便？  下面将这条命令作一下简单说明：  </p>
<ul>
<li>管道符”|”用来隔开两个命令，管道符左边命令的输出会作为管道符右边命令的输入。 </li>
<li>“ps -ef” 是linux里查看所有进程的命令。这时检索出的进程将作为下一条命令”grep LOCAL&#x3D;NO”的输入。 </li>
<li>“grep LOCAL&#x3D;NO” 的输出结果是，所有含有关键字”LOCAL&#x3D;NO”的进程。 </li>
<li>“grep -v grep” 是在列出的进程中去除含有关键字”grep”的进程。  </li>
<li>“cut -c 9-15” 是截取输入行的第9个字符到第15个字符，而这正好是进程号PID。 </li>
<li>“xargs kill -9” 中的 <strong>xargs</strong> 命令是用来把前面命令的输出结果（PID）作为”kill -9”命令的参数，并执行该命令。”kill -9”会强行杀掉指定进程。  其它类似的情况，只需要修改”grep LOCAL&#x3D;NO”中的关键字部分就可以了。</li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库基础教程</title>
    <url>/2017/05/11/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="SQL简介"><a href="#SQL简介" class="headerlink" title="SQL简介"></a>SQL简介</h1><span id="more"></span>

<h2 id="SQL是什么"><a href="#SQL是什么" class="headerlink" title="SQL是什么"></a>SQL是什么</h2><ul>
<li>SQL，指结构化查询语言，全称是 Structured Query Language。</li>
</ul>
<h2 id="SQL能做什么"><a href="#SQL能做什么" class="headerlink" title="SQL能做什么"></a>SQL能做什么</h2><ul>
<li>SQL 面向数据库执行<font color='red'>查询</font> </li>
<li>SQL 可从数据库取回数据</li>
<li>SQL 可在数据库中插入新的记录</li>
<li>SQL 可更新数据库中的数据</li>
<li>SQL 可从数据库删除记录</li>
<li>SQL 可创建新数据库</li>
<li>SQL 可在数据库中创建新表</li>
<li>SQL 可在数据库中创建存储过程</li>
<li>SQL 可在数据库中创建视图</li>
<li>SQL 可以设置表、存储过程和视图的权限</li>
</ul>
<h2 id="RDBMS"><a href="#RDBMS" class="headerlink" title="RDBMS"></a>RDBMS</h2><p>RDBMS 指关系型数据库管理系统，全称 Relational Database Management System。</p>
<p>RDBMS 中的数据存储在被称为表的数据库对象中。</p>
<p>表是相关的数据项的集合，它由列和行组成。</p>
<h2 id="连接数据库的方法"><a href="#连接数据库的方法" class="headerlink" title="连接数据库的方法"></a>连接数据库的方法</h2><p><code>mysql -u root -p</code>：在cmd中输入之后键入密码，则命令行处于<code>mysql&gt;</code>状态</p>
<p><code>SHOW DATABASES;</code>：显示DATABASE</p>
<p><code>CREATE DATABASE database_name;</code>：创建新的database</p>
<p><code>use database_name;</code>：改变database的名字</p>
<p><code>source C:\xxxx.sql;</code>：使用.sql文件</p>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><p>每一句mysql命令后面一定要加上“ ; ”</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-5-11/33750856-file_1494490161004_d61a.png"></p>
<h1 id="SQL语法"><a href="#SQL语法" class="headerlink" title="SQL语法"></a>SQL语法</h1><h2 id="数据库表"><a href="#数据库表" class="headerlink" title="数据库表"></a>数据库表</h2><p>一个数据库通常包含一个或多个表。每个表由一个名字标识，表包含带有数据的记录（行）。</p>
<p>SQL不区分大小写</p>
<h2 id="常用的SQL命令"><a href="#常用的SQL命令" class="headerlink" title="常用的SQL命令"></a>常用的SQL命令</h2><ul>
<li><strong>SELECT</strong> - 从数据库中提取数据</li>
<li><strong>UPDATE</strong> - 更新数据库中的数据</li>
<li><strong>DELETE</strong> - 从数据库中删除数据</li>
<li><strong>INSERT INTO</strong> - 向数据库中插入新数据</li>
<li><strong>CREATE DATABASE</strong> - 创建新数据库</li>
<li><strong>ALTER DATABASE</strong> - 修改数据库</li>
<li><strong>CREATE TABLE</strong> - 创建新表</li>
<li><strong>ALTER TABLE</strong> - 变更（改变）数据库表：</li>
<li><strong>DROP TABLE</strong> - 删除表</li>
<li><strong>CREATE INDEX</strong> - 创建索引（搜索键）</li>
<li><strong>DROP INDEX</strong> - 删除索引</li>
</ul>
<ol>
<li><code>select 列名称 from 表名称 [查询条件];</code>：从表里面选出所需要的列</li>
<li><code>SELECT DISTINCT column_name from table_name</code>：从表中选出所有可能值（不重复）</li>
<li><code>select 列名称 from 表名称 where 条件;</code>：从表中选出符合条件的项目</li>
<li><code>SELECT column_name form table_name where A and B</code> 或者<code>SELECT column_name form table_name where A and B</code>：条件表达式的and和or</li>
<li><code>SELECT column_name FROM table_name ORDER BY column_name ASC|DESC</code>：升序或者降序排列</li>
<li><code>INSERT INTO table_name VALUES (value1,value2,...)</code>：无需指定要插入数据的列名</li>
<li><code>insert [into] 表名 [(列名1, 列名2, 列名3, ...)] values (值1, 值2, 值3, ...);</code>：插入值</li>
<li><code>update 表名称 set 列名称=新值 where 更新条件;</code>：更新表</li>
<li><code>DELETE FROM table_name WHERE some_column = some_value;</code>用于删除表中的行</li>
<li><code>alter table 表名 add 列名 列数据类型 [after 插入位置];</code>：添加列</li>
<li><code>alter table 表名 change 列名称 列新名称 新数据类型;</code>：修改列</li>
<li><code>alter table 表名 drop 列名称;</code>：删除列</li>
<li><code>alter table 表名 rename 新表名;</code>：重命名列</li>
<li><code>drop table 表名;</code>：删除表</li>
<li><code>drop database 数据库名;</code>：删除数据库</li>
</ol>
<p><strong>修改密码:</strong></p>
<p><code>mysqladmin -u root -p password 新密码</code>：修改sql密码</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>数据库</tag>
      </tags>
  </entry>
  <entry>
    <title>操作系统知识点总结</title>
    <url>/2018/03/09/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E7%9F%A5%E8%AF%86%E7%82%B9%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><h2 id="1-操作系统基本特征"><a href="#1-操作系统基本特征" class="headerlink" title="1. 操作系统基本特征"></a>1. 操作系统基本特征</h2><h3 id="1-并发"><a href="#1-并发" class="headerlink" title="1. 并发"></a>1. 并发</h3><p>并发是指宏观上在一段时间内能同时运行多个程序，而并行则指同一时刻能运行多个指令。</p>
<p>并行需要硬件支持，如多流水线或者多处理器。</p>
<p>操作系统通过引入进程和线程，使得程序能够并发运行。</p>
<span id="more"></span>

<h3 id="2-共享"><a href="#2-共享" class="headerlink" title="2. 共享"></a>2. 共享</h3><p>共享是指系统中的资源可以被多个并发进程共同使用。</p>
<p>有两种共享方式：互斥共享和同时共享。</p>
<p><strong>互斥共享</strong>的资源称为临界资源，例如打印机等，在同一时间只允许一个进程访问，需要用同步机制来实现对临界资源的访问。</p>
<h3 id="3-虚拟"><a href="#3-虚拟" class="headerlink" title="3. 虚拟"></a>3. 虚拟</h3><p>虚拟技术把一个物理实体转换为多个逻辑实体。</p>
<p>利用多道程序设计技术，让每个用户都觉得有一个计算机专门为他服务。</p>
<p>主要有两种虚拟技术：<strong>时分复用技术</strong>和<strong>空分复用技术</strong>。例如多个进程能在同一个处理器上并发执行使用了时分复用技术，让每个进程轮流占有处理器，每次只执行一小个时间片并快速切换。</p>
<h3 id="4-异步"><a href="#4-异步" class="headerlink" title="4. 异步"></a>4. 异步</h3><p>异步指进程不是一次性执行完毕，而是走走停停，以不可知的速度向前推进。</p>
<p>但只要运行环境相同，OS需要保证程序运行的结果也要相同。</p>
<h2 id="5-中断分类"><a href="#5-中断分类" class="headerlink" title="5. 中断分类"></a>5. 中断分类</h2><h3 id="1-外中断"><a href="#1-外中断" class="headerlink" title="1. 外中断"></a>1. 外中断</h3><p>由 CPU 执行指令以外的事件引起，如 I&#x2F;O 完成中断，表示设备输入&#x2F;输出处理已经完成，处理器能够发送下一个输入&#x2F;输出请求。此外还有时钟中断、控制台中断等。</p>
<h3 id="2-异常"><a href="#2-异常" class="headerlink" title="2. 异常"></a>2. 异常</h3><p>由 CPU 执行指令的内部事件引起，如非法操作码、地址越界、算术溢出等。</p>
<h3 id="3-陷入"><a href="#3-陷入" class="headerlink" title="3. 陷入"></a>3. 陷入</h3><p>在用户程序中使用系统调用。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>源头</th>
<th>响应方式</th>
<th>处理机制</th>
</tr>
</thead>
<tbody><tr>
<td>中断</td>
<td>外设</td>
<td>异步</td>
<td>持续，对用户应用程序是透明的</td>
</tr>
<tr>
<td>异常</td>
<td>应用程序意想不到的行为</td>
<td>同步</td>
<td>杀死或重新执行意想不到的应用程序指令</td>
</tr>
<tr>
<td>系统调用</td>
<td>应用程序请求操作提供服务</td>
<td>异步或同步</td>
<td>等待和持续</td>
</tr>
</tbody></table>
<h2 id="6-什么是堆和栈？说一下堆栈都存储哪些数据？"><a href="#6-什么是堆和栈？说一下堆栈都存储哪些数据？" class="headerlink" title="6. 什么是堆和栈？说一下堆栈都存储哪些数据？"></a>6. 什么是堆和栈？说一下堆栈都存储哪些数据？</h2><p>栈区（stack）— 由<strong>编译器</strong>自动分配释放 ，存放函数的参数值，局部变量的值等。其操作方式类似于数据结构中的栈。</p>
<p>堆区（heap） — 一般由<strong>程序员分配释放</strong>， 若程序员不释放，程序结束时可能由OS回收 。</p>
<p>数据结构中这两个完全就不放一块来讲，数据结构中栈和队列才是好基友，我想新手也很容易区分。</p>
<p>我想需要区分的情况肯定不是在数据结构话题下，而大多是在 OS 关于不同对象的内存分配这块上。</p>
<h2 id="7-如何理解分布式锁？"><a href="#7-如何理解分布式锁？" class="headerlink" title="7. 如何理解分布式锁？"></a>7. 如何理解分布式锁？</h2><ul>
<li>分布式锁，是控制分布式系统之间同步访问共享资源的一种方式。在分布式系统中，常常需要协调他们的动作。如果不同的系统或是同一个系统的不同主机之间共享了一个或一组资源，那么访问这些资源的时候，往往需要互斥来防止彼此干扰来保证一致性，在这种情况下，便需要使用到分布式锁。</li>
</ul>
<h2 id="2-操作系统基本功能"><a href="#2-操作系统基本功能" class="headerlink" title="2. 操作系统基本功能"></a>2. 操作系统基本功能</h2><h3 id="1-进程管理"><a href="#1-进程管理" class="headerlink" title="1. 进程管理"></a>1. 进程管理</h3><p>进程控制、进程同步、进程通信、死锁处理、处理机调度等。</p>
<h3 id="2-内存管理"><a href="#2-内存管理" class="headerlink" title="2. 内存管理"></a>2. 内存管理</h3><p>内存分配、地址映射、内存保护与共享、虚拟内存等。</p>
<h3 id="3-文件管理"><a href="#3-文件管理" class="headerlink" title="3. 文件管理"></a>3. 文件管理</h3><p>文件存储空间的管理、目录管理、文件读写管理和保护等。</p>
<h3 id="4-设备管理"><a href="#4-设备管理" class="headerlink" title="4. 设备管理"></a>4. 设备管理</h3><p>完成用户的 I&#x2F;O 请求，方便用户使用各种设备，并提高设备的利用率。</p>
<p>主要包括缓冲管理、设备分配、设备处理、虛拟设备等。</p>
<h1 id="二、进程管理"><a href="#二、进程管理" class="headerlink" title="二、进程管理"></a>二、进程管理</h1><h3 id="1-进程"><a href="#1-进程" class="headerlink" title="1. 进程"></a>1. 进程</h3><p><strong>进程是资源分配的基本单位</strong>，用来管理资源（例如：内存，文件，网络等资源）</p>
<p>进程控制块 (Process Control Block, PCB) 描述进程的基本信息和运行状态，所谓的创建进程和撤销进程，都是指对 PCB 的操作。<strong>（PCB是描述进程的数据结构）</strong></p>
<h3 id="2-线程"><a href="#2-线程" class="headerlink" title="2. 线程"></a>2. 线程</h3><p>线程是独立调度的基本单位。</p>
<p>一个进程中可以有多个线程，它们共享进程资源。</p>
<p>QQ 和浏览器是两个进程，浏览器进程里面有很多线程，例如 HTTP 请求线程、事件响应线程、渲染线程等等，线程的并发执行使得在浏览器中点击一个新链接从而发起 HTTP 请求时，浏览器还可以响应用户的其它事件。</p>
<h3 id="3-区别"><a href="#3-区别" class="headerlink" title="3. 区别"></a>3. 区别</h3><p>（一）拥有资源</p>
<p>进程是资源分配的基本单位，但是线程不拥有资源，线程可以访问隶属进程的资源。</p>
<p>（二）调度</p>
<p>线程是独立调度的基本单位，在同一进程中，线程的切换不会引起进程切换，从一个进程内的线程切换到另一个进程中的线程时，会引起进程切换。</p>
<p>（三）系统开销</p>
<p>由于创建或撤销进程时，系统都要为之分配或回收资源，如内存空间、I&#x2F;O 设备等，所付出的开销远大于创建或撤销线程时的开销。类似地，在进行进程切换时，涉及当前执行进程 CPU 环境的保存及新调度进程 CPU 环境的设置，而线程切换时只需保存和设置少量寄存器内容，开销很小。</p>
<p>（四）通信方面</p>
<p>进程间通信 (IPC) 需要进程同步和互斥手段的辅助，以保证数据的一致性。而线程间可以通过直接读&#x2F;写同一进程中的数据段（如全局变量）来进行通信。</p>
<h2 id="2-进程状态的切换（生命周期）"><a href="#2-进程状态的切换（生命周期）" class="headerlink" title="2. 进程状态的切换（生命周期）"></a>2. 进程状态的切换（生命周期）</h2><ul>
<li><strong>就绪状态（ready）</strong>：等待被调度</li>
<li><strong>运行状态（running）</strong></li>
<li><strong>阻塞状态（waiting）</strong>：等待资源</li>
</ul>
<p>应该注意以下内容：</p>
<ul>
<li>只有就绪态和运行态可以相互转换，其它的都是单向转换。就绪状态的进程通过调度算法从而获得 CPU 时间，转为运行状态；而运行状态的进程，在分配给它的 CPU 时间片用完之后就会转为就绪状态，等待下一次调度。</li>
<li>阻塞状态是缺少需要的资源从而由运行状态转换而来，但是该资源不包括 CPU 时间，缺少 CPU 时间会从运行态转换为就绪态。</li>
<li>进程只能自己阻塞自己，因为只有进程自身才知道何时需要等待某种事件的发生</li>
</ul>
<h2 id="3-进程调度算法"><a href="#3-进程调度算法" class="headerlink" title="3. 进程调度算法"></a>3. 进程调度算法</h2><p>不同环境的调度算法目标不同，因此需要针对不同环境来讨论调度算法。</p>
<h3 id="1-批处理系统"><a href="#1-批处理系统" class="headerlink" title="1. 批处理系统"></a>1. 批处理系统</h3><p>批处理系统没有太多的用户操作，在该系统中，调度算法目标是保证吞吐量和周转时间（从提交到终止的时间）。</p>
<h4 id="1-1-先来先服务"><a href="#1-1-先来先服务" class="headerlink" title="1.1 先来先服务"></a>1.1 先来先服务</h4><p>先来先服务 first-come first-serverd（FCFS）</p>
<p>按照请求的顺序进行调度。</p>
<p>有利于长作业，但不利于短作业，因为短作业必须一直等待前面的长作业执行完毕才能执行，而长作业又需要执行很长时间，造成了短作业等待时间过长。</p>
<h4 id="1-2-短作业优先"><a href="#1-2-短作业优先" class="headerlink" title="1.2 短作业优先"></a>1.2 短作业优先</h4><p>短作业优先 shortest job first（SJF）</p>
<p>按估计运行时间最短的顺序进行调度。</p>
<p>长作业有可能会饿死，处于一直等待短作业执行完毕的状态。因为如果一直有短作业到来，那么长作业永远得不到调度。</p>
<h4 id="1-3-最短剩余时间优先"><a href="#1-3-最短剩余时间优先" class="headerlink" title="1.3 最短剩余时间优先"></a>1.3 最短剩余时间优先</h4><p>最短剩余时间优先 shortest remaining time next（SRTN）</p>
<p>按估计剩余时间最短的顺序进行调度。</p>
<h3 id="2-交互式系统"><a href="#2-交互式系统" class="headerlink" title="2. 交互式系统"></a>2. 交互式系统</h3><p>交互式系统有大量的用户交互操作，在该系统中调度算法的目标是快速地进行响应。</p>
<h4 id="2-1-时间片轮转"><a href="#2-1-时间片轮转" class="headerlink" title="2.1 时间片轮转"></a>2.1 时间片轮转</h4><p>将所有就绪进程按 FCFS （先来先服务） 的原则排成一个队列，每次调度时，把 CPU 时间分配给队首进程，该进程可以执行一个时间片。当时间片用完时，由计时器发出时钟中断，调度程序便停止该进程的执行，并将它送往就绪队列的末尾，同时继续把 CPU 时间分配给队首的进程。</p>
<p>时间片轮转算法的效率和时间片的大小有很大关系。因为进程切换都要保存进程的信息并且载入新进程的信息，如果时间片太小，会导致进程切换得太频繁，在进程切换上就会花过多时间。</p>
<h4 id="2-2-优先级调度"><a href="#2-2-优先级调度" class="headerlink" title="2.2 优先级调度"></a>2.2 优先级调度</h4><p>为每个进程分配一个优先级，按优先级进行调度。</p>
<p>为了防止低优先级的进程永远等不到调度，可以随着时间的推移增加等待进程的优先级。</p>
<h4 id="2-3-多级反馈队列"><a href="#2-3-多级反馈队列" class="headerlink" title="2.3 多级反馈队列"></a>2.3 多级反馈队列</h4><p>多级反馈队列调度算法，“多级”在于有多个不同优先级的队列，“反馈”在于如果有进程加入优先级高的队列时立即停止当前任务，转去执行优先级高的队列中进程，上述过程循环调度就形成多级反馈队列调度算法。</p>
<p>如果一个进程需要执行 100 个时间片，如果采用时间片轮转调度算法，那么需要交换 100 次。</p>
<p>多级队列是为这种需要连续执行多个时间片的进程考虑，它设置了多个队列，每个队列时间片大小都不同，例如 1,2,4,8,..。进程在第一个队列没执行完，就会被移到下一个队列。这种方式下，之前的进程只需要交换 7 次。</p>
<p>每个队列优先权也不同，最上面的优先权最高。因此只有上一个队列没有进程在排队，才能调度当前队列上的进程。</p>
<p>可以将这种调度算法看成是<strong>时间片轮转调度算法和优先级调度算法</strong>的结合。</p>
<h3 id="3-实时系统"><a href="#3-实时系统" class="headerlink" title="3. 实时系统"></a>3. 实时系统</h3><p>实时系统要求一个请求在一个确定时间内得到响应。</p>
<p>分为<strong>硬实时和软实时</strong>，前者必须满足绝对的截止时间，后者可以容忍一定的超时。</p>
<h2 id="4-进程同步"><a href="#4-进程同步" class="headerlink" title="4. 进程同步"></a>4. 进程同步</h2><h3 id="1-临界区"><a href="#1-临界区" class="headerlink" title="1. 临界区"></a>1. 临界区</h3><p><strong>对临界资源进行访问的那段代码称为临界区</strong>。</p>
<p>为了互斥访问临界资源，每个进程在进入临界区之前，需要先进行检查。</p>
<h3 id="2-同步与互斥"><a href="#2-同步与互斥" class="headerlink" title="2. 同步与互斥"></a>2. 同步与互斥</h3><ul>
<li>同步：多个进程按一定顺序执行；</li>
<li>互斥：多个进程在同一时刻只有一个进程能进入临界区。</li>
</ul>
<h3 id="3-信号量"><a href="#3-信号量" class="headerlink" title="3. 信号量"></a>3. 信号量</h3><blockquote>
<p>P 和 V 是来源于两个荷兰语词汇，P() —prolaag （荷兰语，尝试减少的意思），V() —verhoog（荷兰语，增加的意思）</p>
</blockquote>
<p>信号量（Semaphore）是一个整型变量，可以对其执行 down 和 up 操作，也就是常见的 P 和 V 操作。</p>
<ul>
<li><strong>down</strong> : 如果信号量大于 0 ，执行 -1 操作；如果信号量等于 0，进程睡眠，等待信号量大于 0；（阻塞）</li>
<li><strong>up</strong> ：对信号量执行 +1 操作，唤醒睡眠的进程让其完成 down 操作。（唤醒）</li>
</ul>
<p>down 和 up 操作需要被设计成原语，不可分割，通常的做法是在执行这些操作的时候屏蔽中断。</p>
<p>如果信号量的取值只能为 0 或者 1，那么就成为了 <strong>互斥量（Mutex）</strong> ，0 表示临界区已经加锁，1 表示临界区解锁。</p>
<h3 id="4-管程"><a href="#4-管程" class="headerlink" title="4. 管程"></a>4. 管程</h3><p>管程 (英语：Monitors，也称为监视器) 是一种程序结构，结构内的多个子程序（对象或模块）形成的多个工作线程互斥访问共享资源。</p>
<h2 id="5-经典同步问题"><a href="#5-经典同步问题" class="headerlink" title="5. 经典同步问题"></a>5. 经典同步问题</h2><p>生产者和消费者问题前面已经讨论过了。</p>
<h3 id="1-读者-写者问题"><a href="#1-读者-写者问题" class="headerlink" title="1. 读者-写者问题"></a>1. 读者-写者问题</h3><p>允许多个进程同时对数据进行读操作，但是不允许读和写以及写和写操作同时发生。读者优先策略</p>
<p>Rcount：读操作的进程数量（Rcount&#x3D;0）</p>
<p>CountMutex：对于Rcount进行加锁（CountMutex&#x3D;1）</p>
<p>WriteMutex：互斥量对于写操作的加锁（WriteMutex&#x3D;1）</p>
<h3 id="2-哲学家进餐问题"><a href="#2-哲学家进餐问题" class="headerlink" title="2. 哲学家进餐问题"></a>2. 哲学家进餐问题</h3><p>五个哲学家围着一张圆桌，每个哲学家面前放着食物。哲学家的生活有两种交替活动：吃饭以及思考。当一个哲学家吃饭时，需要先拿起自己左右两边的两根筷子，并且一次只能拿起一根筷子。</p>
<p><strong>正确方案如下：</strong></p>
<p>为了防止死锁的发生，可以设置两个条件（临界资源）：</p>
<ul>
<li>必须同时拿起左右两根筷子；</li>
<li>只有在两个邻居都没有进餐的情况下才允许进餐。</li>
</ul>
<h2 id="6-进程通信"><a href="#6-进程通信" class="headerlink" title="6. 进程通信"></a>6. 进程通信</h2><p>进程同步与进程通信很容易混淆，它们的区别在于：</p>
<ul>
<li>进程同步：控制多个进程按一定顺序执行</li>
<li>进程通信：进程间传输信息</li>
</ul>
<p>进程通信是一种手段，而进程同步是一种目的。也可以说，为了能够达到进程同步的目的，需要让进程进行通信，传输一些进程同步所需要的信息。</p>
<h4 id="直接通信"><a href="#直接通信" class="headerlink" title="直接通信"></a>直接通信</h4><p>发送进程直接把消息发送给接收进程，并将它挂在接收进程的消息缓冲队列上，接收进程从消息缓冲队列中取得消息。</p>
<h4 id="间接通信-管命共消信套"><a href="#间接通信-管命共消信套" class="headerlink" title="间接通信(管命共消信套)"></a>间接通信(管命共消信套)</h4><p>间接通信方式是指进程之间的通信需要通过作为<strong>共享数据结构的实体</strong>。该实体用来暂存发送进程发给目标进程的消息。</p>
<h3 id="1-管道"><a href="#1-管道" class="headerlink" title="1. 管道"></a>1. 管道</h3><p>管道是通过调用 pipe 函数创建的，fd[0] 用于读，fd[1] 用于写。</p>
<p>它具有以下限制：</p>
<ul>
<li>只支持半双工通信（单向传输）；</li>
<li>只能在父子进程中使用。</li>
</ul>
<h3 id="2-命名管道"><a href="#2-命名管道" class="headerlink" title="2. 命名管道"></a>2. 命名管道</h3><p>也称为命名管道，去除了管道只能在父子进程中使用的限制。</p>
<h3 id="3-消息队列"><a href="#3-消息队列" class="headerlink" title="3. 消息队列"></a>3. 消息队列</h3><p>间接（内核）</p>
<p>相比于 FIFO，消息队列具有以下优点：</p>
<ul>
<li>消息队列可以独立于读写进程存在，从而避免了 FIFO 中同步管道的打开和关闭时可能产生的困难；</li>
<li>避免了 FIFO 的同步阻塞问题，不需要进程自己提供同步方法；</li>
<li>读进程可以根据消息类型有选择地接收消息，而不像 FIFO 那样只能默认地接收。</li>
</ul>
<h3 id="4-信号量"><a href="#4-信号量" class="headerlink" title="4. 信号量"></a>4. 信号量</h3><p>它是一个计数器，用于为多个进程提供对共享数据对象的访问。</p>
<h3 id="5-共享内存"><a href="#5-共享内存" class="headerlink" title="5. 共享内存"></a>5. 共享内存</h3><p>允许多个进程共享一个给定的存储区。因为数据不需要在进程之间复制，所以这是最快的一种 IPC。</p>
<p>需要使用信号量用来同步对共享存储的访问。</p>
<p>多个进程可以将同一个文件映射到它们的地址空间从而实现共享内存。另外 XSI 共享内存不是使用文件，而是使用使用内存的匿名段。</p>
<h3 id="6-套接字"><a href="#6-套接字" class="headerlink" title="6. 套接字"></a>6. 套接字</h3><p>与其它通信机制不同的是，它可用于不同机器间的进程通信。</p>
<h2 id="7-线程间通信和进程间通信"><a href="#7-线程间通信和进程间通信" class="headerlink" title="7. 线程间通信和进程间通信"></a>7. 线程间通信和进程间通信</h2><h3 id="线程间通信"><a href="#线程间通信" class="headerlink" title="线程间通信"></a>线程间通信</h3><ul>
<li><p><strong>synchronized同步</strong></p>
<ul>
<li>这种方式，本质上就是 “共享内存” 式的通信。多个线程需要访问同一个共享变量，谁拿到了锁（获得了访问权限），谁就可以执行。</li>
</ul>
</li>
<li><p><strong>while轮询的方式</strong></p>
<ul>
<li>在这种方式下，ThreadA 不断地改变条件，ThreadB 不停地通过 while 语句检测这个条件 <code>(list.size()==5)</code> 是否成立 ，从而实现了线程间的通信。但是这种方式会浪费 CPU 资源。</li>
<li>之所以说它浪费资源，是因为 JVM 调度器将 CPU 交给 ThreadB 执行时，它没做啥 “有用” 的工作，只是在不断地测试某个条件是否成立。</li>
<li>就类似于现实生活中，某个人一直看着手机屏幕是否有电话来了，而不是：在干别的事情，当有电话来时，响铃通知TA电话来了。</li>
</ul>
</li>
<li><p><strong>wait&#x2F;notify机制</strong></p>
<ul>
<li><p>当条件未满足时，ThreadA 调用 wait() 放弃 CPU，并进入阻塞状态。（不像 while 轮询那样占用 CPU）</p>
<p>当条件满足时，ThreadB 调用 notify() 通知线程 A，所谓通知线程 A，就是唤醒线程 A，并让它进入可运行状态。</p>
</li>
</ul>
</li>
<li><p><strong>管道通信</strong></p>
<ul>
<li>java.io.PipedInputStream 和 java.io.PipedOutputStream进行通信</li>
</ul>
</li>
</ul>
<h3 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h3><ul>
<li><strong>管道（Pipe）</strong> ：管道可用于具有亲缘关系进程间的通信，允许一个进程和另一个与它有共同祖先的进程之间进行通信。</li>
<li><strong>命名管道（named pipe）</strong> ：命名管道克服了管道没有名字的限制，因此，除具有管道所具有的功能外，它还允许无亲缘关 系 进程间的通信。命名管道在文件系统中有对应的文件名。命名管道通过命令mkfifo或系统调用mkfifo来创建。</li>
<li><strong>信号（Signal）</strong> ：信号是比较复杂的通信方式，用于通知接受进程有某种事件发生，除了用于进程间通信外，进程还可以发送 信号给进程本身；Linux除了支持Unix早期信号语义函数sigal外，还支持语义符合Posix.1标准的信号函数sigaction（实际上，该函数是基于BSD的，BSD为了实现可靠信号机制，又能够统一对外接口，用sigaction函数重新实现了signal函数）。</li>
<li><strong>消息（Message）队列</strong> ：消息队列是消息的链接表，包括Posix消息队列system V消息队列。有足够权限的进程可以向队列中添加消息，被赋予读权限的进程则可以读走队列中的消息。消息队列克服了信号承载信息量少，管道只能承载无格式字节流以及缓冲区大小受限等缺</li>
<li><strong>共享内存</strong> ：使得多个进程可以访问同一块内存空间，是最快的可用IPC形式。是针对其他通信机制运行效率较低而设计的。往往与其它通信机制，如信号量结合使用，来达到进程间的同步及互斥。</li>
<li><strong>内存映射（mapped memory）</strong> ：内存映射允许任何多个进程间通信，每一个使用该机制的进程通过把一个共享的文件映射到自己的进程地址空间来实现它。</li>
<li><strong>信号量（semaphore）</strong> ：主要作为进程间以及同一进程不同线程之间的同步手段。</li>
<li><strong>套接口（Socket）</strong> ：更为一般的进程间通信机制，可用于不同机器之间的进程间通信。起初是由Unix系统的BSD分支开发出来的，但现在一般可以移植到其它类Unix系统上：linux和System V的变种都支持套接字。</li>
</ul>
<h2 id="8-进程操作"><a href="#8-进程操作" class="headerlink" title="8. 进程操作"></a>8. 进程操作</h2><p>Linux进程结构可由三部分组成：</p>
<ul>
<li>代码段（程序）</li>
<li>数据段（数据）</li>
<li>堆栈段（控制块PCB）</li>
</ul>
<p>一般程序转换为进程分以下几个步骤：</p>
<ol>
<li>内核将程序读入内存，为程序分配内存空间</li>
<li>内核为该进程分配进程标识符 PID 和其他所需资源</li>
<li>内核为进程保存 PID 及相应的状态信息，把进程放到运行队列中等待执行，程序转化为进程后可以被操作系统的调度程序调度执行了</li>
</ol>
<h2 id="9-孤儿进程和僵尸进程"><a href="#9-孤儿进程和僵尸进程" class="headerlink" title="9. 孤儿进程和僵尸进程"></a>9. 孤儿进程和僵尸进程</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>我们知道在 Unix&#x2F;Linux 中，正常情况下，子进程是通过父进程创建的，子进程在创建新的进程。子进程的结束和父进程的运行是一个异步过程，即父进程永远无法预测子进程 到底什么时候结束。当一个进程完成它的工作终止之后，它的父进程需要调用 wait() 或者 waitpid() 系统调用取得子进程的终止状态。</p>
<p>孤儿进程：一个父进程退出，而它的一个或多个子进程还在运行，那么那些子进程将成为孤儿进程。孤儿进程将被 init 进程（进程号为1）所收养，并由 init 进程对它们完成状态收集工作<strong>。</strong></p>
<p>僵尸进程：一个进程使用 fork 创建子进程，如果子进程退出，而父进程并没有调用 wait 或 waitpid 获取子进程的状态信息，那么子进程的进程描述符仍然保存在系统中。这种进程称之为僵尸进程。</p>
<h3 id="问题及危害"><a href="#问题及危害" class="headerlink" title="问题及危害"></a>问题及危害</h3><p>　　Unix 提供了一种机制可以保证只要父进程想知道子进程结束时的状态信息，就可以得到。这种机制就是：在每个进程退出的时候，内核释放该进程所有的资源，包括打开的文件，占用的内存等。但是仍然为其保留一定的信息（包括进程号 the process ID，退出状态 the termination status of the process，运行时间 the amount of CPU time taken by the process 等)。直到父进程通过 wait &#x2F; waitpid 来取时才释放。但这样就导致了问题，如果进程不调用 wait &#x2F; waitpid 的话， 那么保留的那段信息就不会释放，其进程号就会一直被占用，但是系统所能使用的进程号是有限的，如果大量的产生僵死进程，将因为没有可用的进程号而导致系统不能产生新的进程。此即为僵尸进程的危害，应当避免。</p>
<p>　　孤儿进程是没有父进程的进程，孤儿进程这个重任就落到了 init 进程身上，init 进程就好像是一个民政局，专门负责处理孤儿进程的善后工作。每当出现一个孤儿进程的时候，内核就把孤 儿进程的父进程设置为 init，而 init 进程会循环地 wait() 它的已经退出的子进程。这样，当一个孤儿进程凄凉地结束了其生命周期的时候，init 进程就会代表党和政府出面处理它的一切善后工作。因此孤儿进程并不会有什么危害。</p>
<p>　　任何一个子进程（init除外）在exit() 之后，并非马上就消失掉，而是留下一个称为僵尸进程 (Zombie) 的数据结构，等待父进程处理。这是每个子进程在结束时都要经过的阶段。如果子进程在exit()之后，父进程没有来得及处理，这时用 ps 命令就能看到子进程的状态是 <code>Z</code>。如果父进程能及时处理，可能用 ps 命令就来不及看到子进程的僵尸状态，但这并不等于子进程不经过僵尸状态。如果父进程在子进程结束之前退出，则子进程将由 init 接管。 init 将会以父进程的身份对僵尸状态的子进程进行处理。</p>
<h2 id="10-守护进程"><a href="#10-守护进程" class="headerlink" title="10. 守护进程"></a>10. 守护进程</h2><p>Linux Daemon（守护进程）是运行在后台的一种特殊进程。它独立于控制终端并且周期性地执行某种任务或等待处理某些发生的事件。它不需要用户输入就能运行而且提供某种服务，不是对整个系统就是对某个用户程序提供服务。Linux系统的大多数服务器就是通过守护进程实现的。常见的守护进程包括系统日志进程syslogd、 web服务器httpd、邮件服务器sendmail和数据库服务器mysqld等。</p>
<p>守护进程一般在系统启动时开始运行，除非强行终止，否则直到系统关机都保持运行。守护进程经常以超级用户（root）权限运行，因为它们要使用特殊的端口（1-1024）或访问某些特殊的资源。</p>
<p>守护进程的名称通常以d结尾，比如sshd、xinetd、crond等</p>
<h2 id="11-上下文切换"><a href="#11-上下文切换" class="headerlink" title="11. 上下文切换"></a>11. 上下文切换</h2><p>上下文切换，有时也称做<strong>进程切换或任务切换</strong>，是指CPU从一个进程或线程切换到另一个进程或线程。 在操作系统中，CPU 切换到另一个进程需要保存当前进程的状态并恢复另一个进程的状态：当前运行任务转为就绪（或者挂起、删除）状态，另一个被选定的就绪任务成为当前任务。</p>
<h1 id="三、死锁"><a href="#三、死锁" class="headerlink" title="三、死锁"></a>三、死锁</h1><blockquote>
<p>资源分类：（1）可重用资源；（2）消耗资源</p>
</blockquote>
<h2 id="1-什么是死锁"><a href="#1-什么是死锁" class="headerlink" title="1. 什么是死锁"></a>1. 什么是死锁</h2><p>造成死锁的原因就是多个线程或进程对同一个资源的争抢或相互依赖。一个最简单的解释就是你去面试，面试官问你告诉我什么是死锁，我就录用你，你回答面试官你录用我，我告诉你。</p>
<h2 id="2-死锁的必要条件"><a href="#2-死锁的必要条件" class="headerlink" title="2. 死锁的必要条件"></a>2. 死锁的必要条件</h2><ul>
<li>互斥：每个资源要么已经分配给了一个进程，要么就是可用的。</li>
<li>占有和等待：已经得到了某个资源的进程可以再请求新的资源。</li>
<li>不可抢占：已经分配给一个进程的资源不能强制性地被抢占，它只能被占有它的进程显式地释放。</li>
<li>循环等待：有两个或者两个以上的进程组成一条环路，该环路中的每个进程都在等待下一个进程所占有的资源。</li>
</ul>
<h2 id="3-死锁的处理方法"><a href="#3-死锁的处理方法" class="headerlink" title="3. 死锁的处理方法"></a>3. 死锁的处理方法</h2><h3 id="1-处理死锁的策略"><a href="#1-处理死锁的策略" class="headerlink" title="1. 处理死锁的策略"></a>1. 处理死锁的策略</h3><ul>
<li>鸵鸟策略<ul>
<li>把头埋在沙子里，假装根本没发生问题。</li>
<li>因为解决死锁问题的代价很高，因此鸵鸟策略这种不采取任务措施的方案会获得更高的性能。当发生死锁时不会对用户造成多大影响，或发生死锁的概率很低，可以采用鸵鸟策略。</li>
<li>大多数操作系统，包括 Unix，Linux 和 Windows，处理死锁问题的办法仅仅是忽略它。</li>
</ul>
</li>
<li>检测死锁并且恢复。</li>
<li>仔细地对资源进行动态分配，以避免死锁。</li>
<li>通过破除死锁四个必要条件之一，来防止死锁产生。</li>
</ul>
<p>（三）死锁恢复</p>
<ul>
<li>利用抢占恢复</li>
<li>利用回滚恢复</li>
<li>通过杀死进程恢复</li>
</ul>
<h1 id="四、内存管理"><a href="#四、内存管理" class="headerlink" title="四、内存管理"></a>四、内存管理</h1><h2 id="1-虚拟内存"><a href="#1-虚拟内存" class="headerlink" title="1. 虚拟内存"></a>1. 虚拟内存</h2><p>虚拟内存的目的是为了让物理内存扩充成更大的逻辑内存，从而让程序获得更多的可用内存。</p>
<h2 id="2-分页系统地址映射"><a href="#2-分页系统地址映射" class="headerlink" title="2. 分页系统地址映射"></a>2. 分页系统地址映射</h2><ul>
<li>内存管理单元（MMU）：管理着地址空间和物理内存的转换。</li>
<li>页表（Page table）：页（地址空间）和页框（物理内存空间）的映射表。例如下图中，页表的第 0 个表项为 010，表示第 0 个页映射到第 2 个页框。页表项的最后一位用来标记页是否在内存中。</li>
</ul>
<h2 id="3-页面置换算法"><a href="#3-页面置换算法" class="headerlink" title="3. 页面置换算法"></a>3. 页面置换算法</h2><p>在程序运行过程中，如果要访问的页面不在内存中，就发生缺页中断从而将该页调入内存中。此时如果内存已无空闲空间，系统必须从内存中调出一个&#96;页面到磁盘对换区中来腾出空间。</p>
<p>页面置换算法的主要目标是使页面置换频率最低（也可以说缺页率最低）。</p>
<h3 id="1-最佳"><a href="#1-最佳" class="headerlink" title="1. 最佳"></a>1. 最佳</h3><blockquote>
<p>Optimal</p>
</blockquote>
<p>所选择的被换出的页面将是最长时间内不再被访问，通常可以保证获得最低的缺页率。</p>
<h3 id="2-最久未使用"><a href="#2-最久未使用" class="headerlink" title="2. 最久未使用"></a>2. 最久未使用</h3><blockquote>
<p>LRU, Least Recently Used</p>
</blockquote>
<p>虽然无法知道将来要使用的页面情况，但是可以知道过去使用页面的情况。LRU 将最近最久未使用的页面换出。</p>
<h3 id="3-最近未使用"><a href="#3-最近未使用" class="headerlink" title="3. 最近未使用"></a>3. 最近未使用</h3><blockquote>
<p>NRU, Not Recently Used</p>
</blockquote>
<p>每个页面都有两个状态位：R 与 M，当页面被访问时设置页面的 R&#x3D;1，当页面被修改时设置 M&#x3D;1。其中 R 位会定时被清零。可以将页面分成以下四类：</p>
<ul>
<li>R&#x3D;0，M&#x3D;0</li>
<li>R&#x3D;0，M&#x3D;1</li>
<li>R&#x3D;1，M&#x3D;0</li>
<li>R&#x3D;1，M&#x3D;1</li>
</ul>
<p>当发生缺页中断时，NRU 算法随机地从类编号最小的非空类中挑选一个页面将它换出。</p>
<h3 id="4-先进先出"><a href="#4-先进先出" class="headerlink" title="4. 先进先出"></a>4. 先进先出</h3><blockquote>
<p>FIFO, First In First Out</p>
</blockquote>
<p>选择换出的页面是最先进入的页面。</p>
<p>该算法会将那些经常被访问的页面也被换出，从而使缺页率升高。</p>
<h3 id="5-第二次机会算法"><a href="#5-第二次机会算法" class="headerlink" title="5. 第二次机会算法"></a>5. 第二次机会算法</h3><p>FIFO 算法可能会把经常使用的页面置换出去，为了避免这一问题，对该算法做一个简单的修改：</p>
<p>当页面被访问 (读或写) 时设置该页面的 R 位为 1。需要替换的时候，检查最老页面的 R 位。如果 R 位是 0，那么这个页面既老又没有被使用，可以立刻置换掉；如果是 1，就将 R 位清 0，并把该页面放到链表的尾端，修改它的装入时间使它就像刚装入的一样，然后继续从链表的头部开始搜索。</p>
<h3 id="6-时钟"><a href="#6-时钟" class="headerlink" title="6. 时钟"></a>6. 时钟</h3><blockquote>
<p>Clock</p>
</blockquote>
<p>第二次机会算法需要在链表中移动页面，降低了效率。时钟算法使用环形链表将页面链接起来，再使用一个指针指向最老的页面。</p>
<h2 id="5-段页式"><a href="#5-段页式" class="headerlink" title="5. 段页式"></a>5. 段页式</h2><p>程序的地址空间划分成多个拥有独立地址空间的段，每个段上的地址空间划分成大小相同的页。这样既拥有分段系统的共享和保护，又拥有分页系统的虚拟内存功能。</p>
<h2 id="6-分页与分段的比较"><a href="#6-分页与分段的比较" class="headerlink" title="6. 分页与分段的比较"></a>6. 分页与分段的比较</h2><ul>
<li>对程序员的透明性：分页透明，但是分段需要程序员显示划分每个段。</li>
<li>地址空间的维度：分页是一维地址空间，分段是二维的。</li>
<li>大小是否可以改变：页的大小不可变，段的大小可以动态改变。</li>
<li>出现的原因：分页主要用于实现虚拟内存，从而获得更大的地址空间；分段主要是为了使程序和数据可以被划分为逻辑上独立的地址空间并且有助于共享和保护。</li>
</ul>
]]></content>
      <categories>
        <category>工作</category>
      </categories>
      <tags>
        <tag>操作系统</tag>
        <tag>工作</tag>
      </tags>
  </entry>
  <entry>
    <title>深度学习知识复习</title>
    <url>/2018/03/02/%E6%B7%B1%E5%BA%A6%E5%AD%A6%E4%B9%A0%E7%9F%A5%E8%AF%86%E5%A4%8D%E4%B9%A0/</url>
    <content><![CDATA[<h1 id="过拟合与欠拟合"><a href="#过拟合与欠拟合" class="headerlink" title="过拟合与欠拟合"></a>过拟合与欠拟合</h1><ul>
<li><strong>欠拟合</strong>指模型不能在<strong>训练集</strong>上获得足够低的<strong>训练误差</strong>；</li>
</ul>
<ul>
<li>过拟合指模型的训练误差与测试误差（泛化误差）之间差距过大；<ul>
<li>反映在<strong>评价指标</strong>上，就是模型在训练集上表现良好，但是在测试集和新数据上表现一般（<strong>泛化能力差</strong>）；</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h2 id="降低过拟合风险的方法"><a href="#降低过拟合风险的方法" class="headerlink" title="降低过拟合风险的方法"></a>降低过拟合风险的方法</h2><ul>
<li>数据增强<ul>
<li>图像：平移、旋转、缩放</li>
<li>利用<strong>生成对抗网络</strong>（GAN）生成新数据</li>
<li>NLP：利用机器翻译生成新数据</li>
</ul>
</li>
<li>降低模型复杂度<ul>
<li>神经网络：减少网络层、神经元个数</li>
<li>决策树：降低树的深度、剪枝</li>
<li>…</li>
</ul>
</li>
<li>权值约束（添加正则化项）<ul>
<li>L1 正则化</li>
<li>L2 正则化</li>
</ul>
</li>
<li>集成学习<ul>
<li>神经网络：Dropout</li>
<li>决策树：随机森林、GBDT</li>
</ul>
</li>
<li><strong>提前终止</strong></li>
</ul>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>熵 交叉熵与相对熵</title>
    <url>/2018/09/19/%E7%86%B5-%E4%BA%A4%E5%8F%89%E7%86%B5%E4%B8%8E%E7%9B%B8%E5%AF%B9%E7%86%B5/</url>
    <content><![CDATA[<p>讨论这个问题需要从香农的信息熵开始。</p>
<p>小明在学校玩王者荣耀被发现了，爸爸被叫去开家长会，心里悲屈的很，就想法子惩罚小明。到家后，爸爸跟小明说：既然你犯错了，就要接受惩罚，但惩罚的程度就看你聪不聪明了。这样吧，我们俩玩猜球游戏，我拿一个球，你猜球的颜色，你每猜一次，不管对错，你就一个星期不能玩王者荣耀，当然，猜对，游戏停止，否则继续猜。<strong>当然，当答案只剩下两种选择时，此次猜测结束后，无论猜对猜错都能100%确定答案，无需再猜一次，此时游戏停止（因为好多人对策略１的结果有疑问，所以请注意这个条件）。</strong></p>
<span id="more"></span>

<p>题目1：爸爸拿来一个箱子，跟小明说：里面有橙、紫、蓝及青四种颜色的小球任意个，各颜色小球的占比不清楚，现在我从中拿出一个小球，你猜我手中的小球是什么颜色？</p>
<p>为了使被罚时间最短，小明发挥出最强王者的智商，瞬间就想到了以最小的代价猜出答案，简称策略1，小明的想法是这样的。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-20/72896071.jpg"></p>
<p>在这种情况下，小明什么信息都不知道，只能认为四种颜色的小球出现的概率是一样的。所以，根据策略1，1&#x2F;4概率是橙色球，小明需要猜两次，1&#x2F;4是紫色球，小明需要猜两次，其余的小球类似，所以小明预期的猜球次数为：</p>
<p>$$H &#x3D; 1&#x2F;4 \times 2 + 1&#x2F;4 \times 2 + 1&#x2F;4 \times 2 + 1&#x2F;4 \times 2 &#x3D; 2$$</p>
<p>题目2：爸爸还是拿来一个箱子，跟小明说：箱子里面有小球任意个，但其中1&#x2F;2是橙色球，1&#x2F;4是紫色球，1&#x2F;8是蓝色球及1&#x2F;8是青色球。我从中拿出一个球，你猜我手中的球是什么颜色的？</p>
<p>小明毕竟是最强王者，仍然很快得想到了答案，简称策略2，他的答案是这样的。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-20/28432258.jpg"></p>
<p>在这种情况下，小明知道了每种颜色小球的比例，比如橙色占比二分之一，如果我猜橙色，很有可能第一次就猜中了。所以，根据策略2，1&#x2F;2的概率是橙色球，小明需要猜一次，1&#x2F;4的概率是紫色球，小明需要猜两次，1&#x2F;8的概率是蓝色球，小明需要猜三次，1&#x2F;8的概率是青色球，小明需要猜三次，所以小明预期的猜题次数为：</p>
<p>$H &#x3D; 1&#x2F;2 \times 1 + 1&#x2F;4 \times2 + 1&#x2F;8 \times3 + 1&#x2F;8 \times3&#x3D; 1.75$</p>
<p>题目3：其实，爸爸只想让小明意识到自己的错误，并不是真的想罚他，所以拿来一个箱子，跟小明说：里面的球都是橙色，现在我从中拿出一个，你猜我手中的球是什么颜色？</p>
<p>最强王者怎么可能不知道，肯定是橙色，小明需要猜0次。</p>
<p>上面三个题目表现出这样一种现象：针对特定概率为p的小球，需要猜球的次数 $&#x3D;\log_2\frac{1}{p}$，例如题目2中，1&#x2F;4是紫色球，$\log_2&#x3D;4$ 次，1&#x2F;8是蓝色球， $\log_28&#x3D;3$次。那么，针对整个整体，预期的猜题次数为：$\sum_{k&#x3D;1}^{N}p_k\log_2\frac{1}{p_k}$，这就是<strong>信息熵，</strong>上面三个题目的预期猜球次数都是由这个公式计算而来，第一题的信息熵为2，第二题的信息熵为1.75，最三题的信息熵为$1\times\log1&#x3D;0$ <strong>。</strong>那么信息熵代表着什么含义呢？</p>
<p><strong>信息熵代表的是随机变量或整个系统的不确定性，熵越大，随机变量或系统的不确定性就越大。</strong>上面题目1的熵 &gt; 题目2的熵 &gt; 题目3的熵。在题目1中，小明对整个系统一无所知，只能假设所有的情况出现的概率都是均等的，此时的熵是最大的。题目2中，小明知道了橙色小球出现的概率是1&#x2F;2及其他小球各自出现的概率，说明小明对这个系统有一定的了解，所以系统的不确定性自然会降低，所以熵小于2。题目3中，小明已经知道箱子中肯定是橙色球，爸爸手中的球肯定是橙色的，因而整个系统的不确定性为0，也就是熵为0。所以，在什么都不知道的情况下，熵会最大，针对上面的题目1~~题目3，这个最大值是2，除此之外，其余的任何一种情况，熵都会比2小。</p>
<p>所以，每一个系统都会有一个真实的概率分布，也叫真实分布，题目1的真实分布为（1&#x2F;4，1&#x2F;4，1&#x2F;4，1&#x2F;4），题目2的真实分布为（1&#x2F;2，1&#x2F;4，1&#x2F;8，1&#x2F;8），而<strong>根据真实分布，我们能够找到一个最优策略，以最小的代价消除系统的不确定性</strong>，<strong>而这个代价大小就是信息熵，记住，信息熵衡量了系统的不确定性，而我们要消除这个不确定性，所要付出的【最小努力】（猜题次数、编码长度等）的大小就是信息熵</strong>。具体来讲，题目1只需要猜两次就能确定任何一个小球的颜色，题目2只需要猜测1.75次就能确定任何一个小球的颜色。</p>
<p>现在回到题目2，假设小明只是钻石段位而已，智商没王者那么高，他使用了策略1，即</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-9-20/86729508.jpg"></p>
<p>爸爸已经告诉小明这些小球的真实分布是（1&#x2F;2，1&#x2F;4, 1&#x2F;8，1&#x2F;8），但小明所选择的策略却认为所有的小球出现的概率相同，相当于忽略了爸爸告诉小明关于箱子中各小球的真实分布，而仍旧认为所有小球出现的概率是一样的，认为小球的分布为（1&#x2F;4，1&#x2F;4，1&#x2F;4，1&#x2F;4），这个分布就是<strong>非真实分布</strong>。此时，小明猜中任何一种颜色的小球都需要猜两次，即1&#x2F;2 * 2 + 1&#x2F;4 * 2 + 1&#x2F;8 * 2 + 1&#x2F;8 * 2 &#x3D; 2。</p>
<p>很明显，针对题目2，使用策略1是一个坏的选择，因为需要猜题的次数增加了，从1.75变成了2，小明少玩了1.75的王者荣耀呢。因此，当我们知道根据系统的真实分布制定最优策略去消除系统的不确定性时，我们所付出的努力是最小的，但并不是每个人都和最强王者一样聪明，我们也许会使用其他的策略（非真实分布）去消除系统的不确定性，就好比如我将策略1用于题目2（原来这就是我在白银的原因），那么，当我们使用非最优策略消除系统的不确定性，所需要付出的努力的大小我们该如何去衡量呢？</p>
<p>这就需要引入<strong>交叉熵，其用来衡量在给定的真实分布下，使用非真实分布所指定的策略消除系统的不确定性所需要付出的努力的大小</strong>。</p>
<p>正式的讲，交叉熵的公式为： $\sum_{k&#x3D;1}^Np_k\log_2\frac{1}{q_k}$,其中$p_k$表示真实分布， $q_k$ 表示非真实分布。例如上面所讲的将策略1用于题目2，真实分布 $q_k&#x3D;(\frac{1}{2},\frac{1}{4},\frac{1}{8},\frac{1}{8})$， 非真实分布  $q_k&#x3D;(\frac{1}{4},\frac{1}{4},\frac{1}{4},\frac{1}{4})$，交叉熵$\frac{1}{2}\log_24+\frac{1}{4}\log_24+\frac{1}{8}\log_24+\frac{1}{8}\log_24&#x3D;2$ ，比最优策略的1.75来得大。</p>
<p>因此，交叉熵越低，这个策略就越好，最低的交叉熵也就是使用了真实分布所计算出来的信息熵，因为此时$p_k&#x3D;q_k​$ ，交叉熵 &#x3D; 信息熵。这也是为什么在机器学习中的分类算法中，我们总是最小化交叉熵，因为交叉熵越低，就证明由算法所产生的策略最接近最优策略，也间接证明我们算法所算出的非真实分布越接近真实分布。</p>
<p>最后，我们如何去衡量不同策略之间的差异呢？这就需要用到<strong>相对熵，其用来衡量两个取值为正的函数或概率分布之间的差异</strong>，即：</p>
<p>$$KL(f(x)||g(x)) &#x3D; {\sum_{x{\in}X}f(x)\times\log_2\frac{f(x)}{g(x)}}$$</p>
<p>现在，假设我们想知道某个策略和最优策略之间的差异，我们就可以用相对熵来衡量这两者之间的差异。即，相对熵 &#x3D; 某个策略的交叉熵 - 信息熵（根据系统真实分布计算而得的信息熵，为最优策略），公式如下：</p>
<p>$$KL(P||q) &#x3D; H(p,q)-H(p) &#x3D; \sum_{k&#x3D;1}^{N}\frac{1}{q_k}-\sum_{k&#x3D;1}^{N}\log_2\frac{1}{p_k}&#x3D;\sum_{k&#x3D;1}^{N}p_k\log_2\frac{p_k}{q_k}$$</p>
<p>所以将策略1用于题目2，所产生的相对熵为2 - 1.75 &#x3D; 0.25.</p>
<p>转自知乎：<a href="https://www.zhihu.com/question/41252833">https://www.zhihu.com/question/41252833</a></p>
]]></content>
      <categories>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>由kaggle房价模型得到stacking model方法</title>
    <url>/2018/03/14/%E7%94%B1kaggle%E6%88%BF%E4%BB%B7%E6%A8%A1%E5%9E%8B%E5%BE%97%E5%88%B0stacking-model%E6%96%B9%E6%B3%95/</url>
    <content><![CDATA[<p>房价模型在<a href="http://drawon.site/2018/03/11/python%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E8%BF%87%E7%A8%8B-kaggle%E6%88%BF%E4%BB%B7%E9%A2%84%E6%B5%8B/">kaggle房价预测问题</a>中已经介绍过，具体不再赘述。</p>
<p>大致内容为：根据给定的数据的80个变量来预测未知数据（同样包含80个变量）来预测房价</p>
<span id="more"></span>

<p>首先导入需要的包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#import some necessary librairies</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np <span class="comment"># linear algebra</span></span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd <span class="comment"># data processing, CSV file I/O (e.g. pd.read_csv)</span></span><br><span class="line">%matplotlib inline</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt  <span class="comment"># Matlab-style plotting</span></span><br><span class="line"><span class="keyword">import</span> seaborn <span class="keyword">as</span> sns</span><br><span class="line">color = sns.color_palette()</span><br><span class="line">sns.set_style(<span class="string">&#x27;darkgrid&#x27;</span>)</span><br><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ignore_warn</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">warnings.warn = ignore_warn <span class="comment">#ignore annoying warning (from sklearn and seaborn)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line"><span class="keyword">from</span> scipy.stats <span class="keyword">import</span> norm, skew <span class="comment">#for some statistics</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pd.set_option(<span class="string">&#x27;display.float_format&#x27;</span>, <span class="keyword">lambda</span> x: <span class="string">&#x27;&#123;:.3f&#125;&#x27;</span>.<span class="built_in">format</span>(x)) <span class="comment">#Limiting floats output to 3 decimal points</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> check_output</span><br><span class="line"><span class="built_in">print</span>(check_output([<span class="string">&quot;ls&quot;</span>, <span class="string">&quot;../input&quot;</span>]).decode(<span class="string">&quot;utf8&quot;</span>)) <span class="comment">#check the files available in the directory</span></span><br></pre></td></tr></table></figure>

<h2 id="数据直观分析"><a href="#数据直观分析" class="headerlink" title="数据直观分析"></a>数据直观分析</h2><p>导入数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#Now let&#x27;s import and put the train and test datasets in  pandas dataframe</span></span><br><span class="line"></span><br><span class="line">train = pd.read_csv(<span class="string">&#x27;../input/train.csv&#x27;</span>)</span><br><span class="line">test = pd.read_csv(<span class="string">&#x27;../input/test.csv&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>看看数据长什么样子：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">##display the first five rows of the train dataset.</span></span><br><span class="line">train.head(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Id</th>
<th>MSSubClass</th>
<th>MSZoning</th>
<th>LotFrontage</th>
<th>LotArea</th>
<th>Street</th>
<th>Alley</th>
<th>LotShape</th>
<th>LandContour</th>
<th>Utilities</th>
<th>…</th>
<th>PoolArea</th>
<th>PoolQC</th>
<th>Fence</th>
<th>MiscFeature</th>
<th>MiscVal</th>
<th>MoSold</th>
<th>YrSold</th>
<th>SaleType</th>
<th>SaleCondition</th>
<th>SalePrice</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>1</td>
<td>60</td>
<td>RL</td>
<td>65.000</td>
<td>8450</td>
<td>Pave</td>
<td>NaN</td>
<td>Reg</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>2</td>
<td>2008</td>
<td>WD</td>
<td>Normal</td>
<td>208500</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>20</td>
<td>RL</td>
<td>80.000</td>
<td>9600</td>
<td>Pave</td>
<td>NaN</td>
<td>Reg</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>5</td>
<td>2007</td>
<td>WD</td>
<td>Normal</td>
<td>181500</td>
</tr>
<tr>
<td>2</td>
<td>3</td>
<td>60</td>
<td>RL</td>
<td>68.000</td>
<td>11250</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>9</td>
<td>2008</td>
<td>WD</td>
<td>Normal</td>
<td>223500</td>
</tr>
<tr>
<td>3</td>
<td>4</td>
<td>70</td>
<td>RL</td>
<td>60.000</td>
<td>9550</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>2</td>
<td>2006</td>
<td>WD</td>
<td>Abnorml</td>
<td>140000</td>
</tr>
<tr>
<td>4</td>
<td>5</td>
<td>60</td>
<td>RL</td>
<td>84.000</td>
<td>14260</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>12</td>
<td>2008</td>
<td>WD</td>
<td>Normal</td>
<td>250000</td>
</tr>
</tbody></table>
<p>一共是81列，最后一列是房价，第一列是id</p>
<p>我们再看看test数据长什么样：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">##display the first five rows of the test dataset.</span></span><br><span class="line">test.head(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Id</th>
<th>MSSubClass</th>
<th>MSZoning</th>
<th>LotFrontage</th>
<th>LotArea</th>
<th>Street</th>
<th>Alley</th>
<th>LotShape</th>
<th>LandContour</th>
<th>Utilities</th>
<th>…</th>
<th>ScreenPorch</th>
<th>PoolArea</th>
<th>PoolQC</th>
<th>Fence</th>
<th>MiscFeature</th>
<th>MiscVal</th>
<th>MoSold</th>
<th>YrSold</th>
<th>SaleType</th>
<th>SaleCondition</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>1461</td>
<td>20</td>
<td>RH</td>
<td>80.000</td>
<td>11622</td>
<td>Pave</td>
<td>NaN</td>
<td>Reg</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>120</td>
<td>0</td>
<td>NaN</td>
<td>MnPrv</td>
<td>NaN</td>
<td>0</td>
<td>6</td>
<td>2010</td>
<td>WD</td>
<td>Normal</td>
</tr>
<tr>
<td>1</td>
<td>1462</td>
<td>20</td>
<td>RL</td>
<td>81.000</td>
<td>14267</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>Gar2</td>
<td>12500</td>
<td>6</td>
<td>2010</td>
<td>WD</td>
<td>Normal</td>
</tr>
<tr>
<td>2</td>
<td>1463</td>
<td>60</td>
<td>RL</td>
<td>74.000</td>
<td>13830</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>MnPrv</td>
<td>NaN</td>
<td>0</td>
<td>3</td>
<td>2010</td>
<td>WD</td>
<td>Normal</td>
</tr>
<tr>
<td>3</td>
<td>1464</td>
<td>60</td>
<td>RL</td>
<td>78.000</td>
<td>9978</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>Lvl</td>
<td>AllPub</td>
<td>…</td>
<td>0</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>6</td>
<td>2010</td>
<td>WD</td>
<td>Normal</td>
</tr>
<tr>
<td>4</td>
<td>1465</td>
<td>120</td>
<td>RL</td>
<td>43.000</td>
<td>5005</td>
<td>Pave</td>
<td>NaN</td>
<td>IR1</td>
<td>HLS</td>
<td>AllPub</td>
<td>…</td>
<td>144</td>
<td>0</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>0</td>
<td>1</td>
<td>2010</td>
<td>WD</td>
<td>Normal</td>
</tr>
</tbody></table>
<p>一共是80列，第一列是id，房价未知</p>
<p>删除id信息</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#check the numbers of samples and features</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The train data size before dropping Id feature is : &#123;&#125; &quot;</span>.<span class="built_in">format</span>(train.shape))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The test data size before dropping Id feature is : &#123;&#125; &quot;</span>.<span class="built_in">format</span>(test.shape))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Save the &#x27;Id&#x27; column</span></span><br><span class="line">train_ID = train[<span class="string">&#x27;Id&#x27;</span>]</span><br><span class="line">test_ID = test[<span class="string">&#x27;Id&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#Now drop the  &#x27;Id&#x27; colum since it&#x27;s unnecessary for  the prediction process.</span></span><br><span class="line">train.drop(<span class="string">&quot;Id&quot;</span>, axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line">test.drop(<span class="string">&quot;Id&quot;</span>, axis = <span class="number">1</span>, inplace = <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#check again the data size after dropping the &#x27;Id&#x27; variable</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nThe train data size after dropping Id feature is : &#123;&#125; &quot;</span>.<span class="built_in">format</span>(train.shape)) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;The test data size after dropping Id feature is : &#123;&#125; &quot;</span>.<span class="built_in">format</span>(test.shape))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">The train data size before dropping Id feature <span class="keyword">is</span> : (<span class="number">1460</span>, <span class="number">81</span>) </span><br><span class="line">The test data size before dropping Id feature <span class="keyword">is</span> : (<span class="number">1459</span>, <span class="number">80</span>) </span><br><span class="line"></span><br><span class="line">The train data size after dropping Id feature <span class="keyword">is</span> : (<span class="number">1460</span>, <span class="number">80</span>) </span><br><span class="line">The test data size after dropping Id feature <span class="keyword">is</span> : (<span class="number">1459</span>, <span class="number">79</span>) </span><br></pre></td></tr></table></figure>

<h2 id="数据预处理"><a href="#数据预处理" class="headerlink" title="数据预处理"></a>数据预处理</h2><p>我们先来看看异常值，首先画一下GrLivArea和SalePrice的关系</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">f, ax = plt.subplots()</span><br><span class="line">plt.scatter(x=train[<span class="string">&#x27;GrLivArea&#x27;</span>],y=train[<span class="string">&#x27;SalePrice&#x27;</span>])</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-13/17899296.jpg"></p>
<p>很明显看到另个异常值，我们先把这两个点删除</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train = train.drop(train[(train[<span class="string">&#x27;GrLivArea&#x27;</span>] &gt; <span class="number">4000</span>) &amp; (train[<span class="string">&#x27;SalePrice&#x27;</span>] &lt; <span class="number">300000</span>)].index)</span><br></pre></td></tr></table></figure>

<h2 id="目标变量"><a href="#目标变量" class="headerlink" title="目标变量"></a>目标变量</h2><p>房价是我们需要预测的变量，所以我们先分析一下这个变量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sns.distplot(train[<span class="string">&#x27;SalePrice&#x27;</span>] , fit=norm)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get the fitted parameters used by the function</span></span><br><span class="line">(mu, sigma) = norm.fit(train[<span class="string">&#x27;SalePrice&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>( <span class="string">&#x27;\n mu = &#123;:.2f&#125; and sigma = &#123;:.2f&#125;\n&#x27;</span>.<span class="built_in">format</span>(mu, sigma))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Now plot the distribution</span></span><br><span class="line">plt.legend([<span class="string">&#x27;Normal dist. ($\mu=$ &#123;:.2f&#125; and $\sigma=$ &#123;:.2f&#125; )&#x27;</span>.<span class="built_in">format</span>(mu, sigma)],</span><br><span class="line">            loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Frequency&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;SalePrice distribution&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Get also the QQ-plot</span></span><br><span class="line">fig = plt.figure()</span><br><span class="line">res = stats.probplot(train[<span class="string">&#x27;SalePrice&#x27;</span>], plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>房价正态对比图以及QQ图</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/70657813.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/80858877.jpg"></p>
<p>目标变量右偏，线性模型比较喜欢正态分布的数据，因此我们需要转换变量使其正态分布</p>
<h3 id="对数据进行log变换"><a href="#对数据进行log变换" class="headerlink" title="对数据进行log变换"></a>对数据进行log变换</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">train[<span class="string">&#x27;SalePrice&#x27;</span>] = np.log(train[<span class="string">&#x27;SalePrice&#x27;</span>])</span><br><span class="line">sns.distplot(train[<span class="string">&#x27;SalePrice&#x27;</span>],fit=norm)</span><br><span class="line">(mu,sigma) = norm.fit(train[<span class="string">&#x27;SalePrice&#x27;</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;the $\mu$ = &#123;:.2f&#125; \n the $\sigma$ = &#123;:.2f&#125;&#x27;</span>.<span class="built_in">format</span>(mu,sigma))</span><br><span class="line">plt.legend([<span class="string">&#x27;Norm distribution( $\mu$ = &#123;:.2f&#125; , $\sigma$ = &#123;:.2f&#125;)&#x27;</span>.<span class="built_in">format</span>(mu,sigma)],loc=<span class="string">&#x27;best&#x27;</span>)</span><br><span class="line">plt.ylabel(<span class="string">&#x27;Frequency&#x27;</span>)</span><br><span class="line">plt.xlabel(<span class="string">&#x27;SalePrice&#x27;</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;SalePrice distribution&#x27;</span>)</span><br><span class="line">fig = plt.figure()</span><br><span class="line">stats.probplot(train[<span class="string">&#x27;SalePrice&#x27;</span>],plot=plt)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/14029443.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/9451883.jpg"></p>
<p>可以看到，变换之后更加接近正态分布</p>
<h2 id="特征工程"><a href="#特征工程" class="headerlink" title="特征工程"></a>特征工程</h2><p>先把所有train和test数据连接在一起，并删掉售价这列</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">all_data = pd.concat([train,test],ignore_index=<span class="literal">True</span>)</span><br><span class="line">ntrain = train.shape[<span class="number">0</span>]</span><br><span class="line">ntest = test.shape[<span class="number">0</span>]</span><br><span class="line">y_train = train.SalePrice.values</span><br><span class="line">all_data.drop(<span class="string">&#x27;SalePrice&#x27;</span>,<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br><span class="line"><span class="built_in">print</span>(all_data.shape)</span><br></pre></td></tr></table></figure>

<h3 id="缺失数据"><a href="#缺失数据" class="headerlink" title="缺失数据"></a>缺失数据</h3><p>先把缺失数据找出来</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">all_data_na = (all_data.isnull().<span class="built_in">sum</span>() / <span class="built_in">len</span>(all_data)) *<span class="number">100</span></span><br><span class="line">all_data_na = all_data_na.drop(all_data_na[all_data_na == <span class="number">0</span>].index).sort_values(ascending=<span class="literal">False</span>)[:<span class="number">30</span>]</span><br><span class="line">missing_data = pd.DataFrame(&#123;<span class="string">&#x27;Missing Ratio&#x27;</span>:all_data_na&#125;)</span><br><span class="line"><span class="built_in">print</span>(missing_data.head(<span class="number">20</span>))</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Missing Ratio</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>PoolQC</td>
<td>99.691</td>
</tr>
<tr>
<td>MiscFeature</td>
<td>96.400</td>
</tr>
<tr>
<td>Alley</td>
<td>93.212</td>
</tr>
<tr>
<td>Fence</td>
<td>80.425</td>
</tr>
<tr>
<td>FireplaceQu</td>
<td>48.680</td>
</tr>
<tr>
<td>LotFrontage</td>
<td>16.661</td>
</tr>
<tr>
<td>GarageQual</td>
<td>5.451</td>
</tr>
<tr>
<td>GarageCond</td>
<td>5.451</td>
</tr>
<tr>
<td>GarageFinish</td>
<td>5.451</td>
</tr>
<tr>
<td>GarageYrBlt</td>
<td>5.451</td>
</tr>
<tr>
<td>GarageType</td>
<td>5.382</td>
</tr>
<tr>
<td>BsmtExposure</td>
<td>2.811</td>
</tr>
<tr>
<td>BsmtCond</td>
<td>2.811</td>
</tr>
<tr>
<td>BsmtQual</td>
<td>2.777</td>
</tr>
<tr>
<td>BsmtFinType2</td>
<td>2.743</td>
</tr>
<tr>
<td>BsmtFinType1</td>
<td>2.708</td>
</tr>
<tr>
<td>MasVnrType</td>
<td>0.823</td>
</tr>
<tr>
<td>MasVnrArea</td>
<td>0.788</td>
</tr>
<tr>
<td>MSZoning</td>
<td>0.137</td>
</tr>
<tr>
<td>BsmtFullBath</td>
<td>0.069</td>
</tr>
</tbody></table>
<p>画一下缺失的比例：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sns.barplot(all_data_na.index,all_data_na.values)</span><br><span class="line">plt.xticks(rotation=<span class="number">90</span>)</span><br><span class="line">plt.title(<span class="string">&#x27;data missing percent&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/30036574.jpg"></p>
<h3 id="数据相关性分析"><a href="#数据相关性分析" class="headerlink" title="数据相关性分析"></a>数据相关性分析</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">corrmat = train.corr()</span><br><span class="line">plt.subplots(figsize=(<span class="number">12</span>,<span class="number">9</span>))</span><br><span class="line">sns.heatmap(corrmat,vmax=<span class="number">0.9</span>,square=<span class="literal">True</span>)</span><br><span class="line">plt.xticks(rotation=<span class="number">90</span>)</span><br><span class="line">plt.yticks(rotation=<span class="number">360</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/70809095.jpg"></p>
<h3 id="计算缺失值"><a href="#计算缺失值" class="headerlink" title="计算缺失值"></a>计算缺失值</h3><ul>
<li><p><strong>PoolQC</strong> : 数据描述中提到 NA 表示 “No Pool”. </p>
</li>
<li><p><strong>MiscFeature</strong> : 数据描述中提到 NA 表示 “no misc feature”</p>
</li>
<li><p><strong>Alley</strong> : 数据描述中提到 NA 表示 “no alley access”</p>
</li>
<li><p><strong>Fence</strong> : 数据描述中提到 NA 表示”no fence”</p>
</li>
<li><p><strong>FireplaceQu</strong> : 数据描述中提到 NA 表示 “no fireplace”</p>
</li>
<li><p><strong>‘GarageType’, ‘GarageFinish’, ‘GarageQual’, ‘GarageCond’,’BsmtQual’, ‘BsmtCond’,’BsmtExposure’, ‘BsmtFinType1’, ‘BsmtFinType2’,’MSSubClass’：</strong> 用’None’替代缺失值</p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var = [<span class="string">&#x27;PoolQC&#x27;</span>,<span class="string">&#x27;MiscFeature&#x27;</span>,<span class="string">&#x27;Alley&#x27;</span>,<span class="string">&#x27;Fence&#x27;</span>,<span class="string">&#x27;FireplaceQu&#x27;</span>,<span class="string">&#x27;GarageType&#x27;</span>, <span class="string">&#x27;GarageFinish&#x27;</span>, <span class="string">&#x27;GarageQual&#x27;</span>, <span class="string">&#x27;GarageCond&#x27;</span>，<span class="string">&#x27;MSSubClass&#x27;</span>]</span><br><span class="line">all_data[var] = all_data[var].fillna(<span class="string">&#x27;None&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;为null的值&#x27;</span>,<span class="built_in">max</span>(all_data[var].isnull().<span class="built_in">sum</span>()))</span><br></pre></td></tr></table></figure>

<p><strong>LotFrontage</strong>: 由于连接到房产的每条街道的面积很可能与其附近的其他房屋具有相似的面积，因此我们可以通过邻里的LotFrontage填充缺失值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">all_data[<span class="string">&#x27;LotFrontage&#x27;</span>] = all_data.groupby(<span class="string">&#x27;Neighborhood&#x27;</span>)[<span class="string">&#x27;LotFrontage&#x27;</span>].transform(<span class="keyword">lambda</span> x: x.fillna(x.median()))</span><br></pre></td></tr></table></figure>

<ul>
<li>**’GarageYrBlt’, ‘GarageArea’, ‘GarageCars’,’BsmtFinSF1’, ‘BsmtFinSF2’, ‘BsmtUnfSF’, ‘TotalBsmtSF’,’BsmtFullBath’, ‘BsmtHalfBath’,’MasVnrArea’, ‘MasVnrType’**：用0代替缺失值</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var = [<span class="string">&#x27;GarageYrBlt&#x27;</span>, <span class="string">&#x27;GarageArea&#x27;</span>, <span class="string">&#x27;GarageCars&#x27;</span>,<span class="string">&#x27;BsmtFinSF1&#x27;</span>, <span class="string">&#x27;BsmtFinSF2&#x27;</span>, <span class="string">&#x27;BsmtUnfSF&#x27;</span>, <span class="string">&#x27;TotalBsmtSF&#x27;</span>,<span class="string">&#x27;BsmtFullBath&#x27;</span>, <span class="string">&#x27;BsmtHalfBath&#x27;</span>,<span class="string">&#x27;MasVnrArea&#x27;</span>, <span class="string">&#x27;MasVnrType&#x27;</span>]</span><br><span class="line">all_data[var] = all_data[var].fillna(<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>**’Electrical’,’MSZoning’,’KitchenQual’,’Exterior1st’,’Exterior2nd’,’SaleType’**：用它的频繁模式来填充缺失值</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">var = [<span class="string">&#x27;Electrical&#x27;</span>,<span class="string">&#x27;MSZoning&#x27;</span>,<span class="string">&#x27;KitchenQual&#x27;</span>,<span class="string">&#x27;Exterior1st&#x27;</span>,<span class="string">&#x27;Exterior2nd&#x27;</span>,<span class="string">&#x27;SaleType&#x27;</span>]</span><br><span class="line"><span class="keyword">for</span> v <span class="keyword">in</span> var:</span><br><span class="line">    all_data[v] = all_data[v].fillna(all_data[v].mode()[<span class="number">0</span>])</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Utilities</strong> : 这个变量在训练数据中，几乎所有值都是’AllPub’，除了两个NA和1个”NoSeWa”，所以我们可以删除这个变量。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">all_data.drop(<span class="string">&#x27;Utilities&#x27;</span>,<span class="number">1</span>,inplace=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>Functional</strong> : NA 表示 typical</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">all_data[<span class="string">&quot;Functional&quot;</span>] = all_data[<span class="string">&quot;Functional&quot;</span>].fillna(<span class="string">&quot;Typ&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>再检查一下有没有缺失值：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;缺失值个数:&#x27;</span>,<span class="built_in">max</span>(all_data.isnull().<span class="built_in">sum</span>()))</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">缺失值个数:<span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="更多的特征工程"><a href="#更多的特征工程" class="headerlink" title="更多的特征工程"></a>更多的特征工程</h3><p>将某些本来应该是类的数值变量变为类型变量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#MSSubClass=The building class</span></span><br><span class="line">all_data[<span class="string">&#x27;MSSubClass&#x27;</span>] = all_data[<span class="string">&#x27;MSSubClass&#x27;</span>].apply(<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Changing OverallCond into a categorical variable</span></span><br><span class="line">all_data[<span class="string">&#x27;OverallCond&#x27;</span>] = all_data[<span class="string">&#x27;OverallCond&#x27;</span>].astype(<span class="built_in">str</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#Year and month sold are transformed into categorical features.</span></span><br><span class="line">all_data[<span class="string">&#x27;YrSold&#x27;</span>] = all_data[<span class="string">&#x27;YrSold&#x27;</span>].astype(<span class="built_in">str</span>)</span><br><span class="line">all_data[<span class="string">&#x27;MoSold&#x27;</span>] = all_data[<span class="string">&#x27;MoSold&#x27;</span>].astype(<span class="built_in">str</span>)</span><br></pre></td></tr></table></figure>

<p>然后将数值变量变成值：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">columns = (<span class="string">&#x27;FireplaceQu&#x27;</span>, <span class="string">&#x27;BsmtQual&#x27;</span>, <span class="string">&#x27;BsmtCond&#x27;</span>, <span class="string">&#x27;GarageQual&#x27;</span>, <span class="string">&#x27;GarageCond&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;ExterQual&#x27;</span>, <span class="string">&#x27;ExterCond&#x27;</span>,<span class="string">&#x27;HeatingQC&#x27;</span>, <span class="string">&#x27;PoolQC&#x27;</span>, <span class="string">&#x27;KitchenQual&#x27;</span>, <span class="string">&#x27;BsmtFinType1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;BsmtFinType2&#x27;</span>, <span class="string">&#x27;Functional&#x27;</span>, <span class="string">&#x27;Fence&#x27;</span>, <span class="string">&#x27;BsmtExposure&#x27;</span>, <span class="string">&#x27;GarageFinish&#x27;</span>, <span class="string">&#x27;LandSlope&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;LotShape&#x27;</span>, <span class="string">&#x27;PavedDrive&#x27;</span>, <span class="string">&#x27;Street&#x27;</span>, <span class="string">&#x27;Alley&#x27;</span>, <span class="string">&#x27;CentralAir&#x27;</span>, <span class="string">&#x27;MSSubClass&#x27;</span>, <span class="string">&#x27;OverallCond&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;YrSold&#x27;</span>, <span class="string">&#x27;MoSold&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> column <span class="keyword">in</span> columns:</span><br><span class="line">    lb_make = LabelEncoder()</span><br><span class="line">    all_data[column] = lb_make.fit_transform(all_data[column].values)</span><br></pre></td></tr></table></figure>

<h3 id="加入一个额外的特征"><a href="#加入一个额外的特征" class="headerlink" title="加入一个额外的特征"></a>加入一个额外的特征</h3><p>我们都知道房价和总面积息息相关，那么我们在加一个总面积的变量</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Adding total sqfootage feature </span></span><br><span class="line">all_data[<span class="string">&#x27;TotalSF&#x27;</span>] = all_data[<span class="string">&#x27;TotalBsmtSF&#x27;</span>] + all_data[<span class="string">&#x27;1stFlrSF&#x27;</span>] + all_data[<span class="string">&#x27;2ndFlrSF&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="计算数值特征的数据斜度"><a href="#计算数值特征的数据斜度" class="headerlink" title="计算数值特征的数据斜度"></a>计算数值特征的数据斜度</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">numeric_feats = all_data.dtypes[all_data.dtypes != <span class="string">&quot;object&quot;</span>].index</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check the skew of all numerical features</span></span><br><span class="line">skewed_feats = all_data[numeric_feats].apply(<span class="keyword">lambda</span> x: skew(x.dropna())).sort_values(ascending=<span class="literal">False</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nSkew in numerical features: \n&quot;</span>)</span><br><span class="line">skewness = pd.DataFrame(&#123;<span class="string">&#x27;Skew&#x27;</span> :skewed_feats&#125;)</span><br><span class="line">skewness.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Skew <span class="keyword">in</span> numerical features: </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Skew</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>MiscVal</td>
<td>21.940</td>
</tr>
<tr>
<td>PoolArea</td>
<td>17.689</td>
</tr>
<tr>
<td>LotArea</td>
<td>13.109</td>
</tr>
<tr>
<td>LowQualFinSF</td>
<td>12.085</td>
</tr>
<tr>
<td>3SsnPorch</td>
<td>11.372</td>
</tr>
<tr>
<td>LandSlope</td>
<td>4.973</td>
</tr>
<tr>
<td>KitchenAbvGr</td>
<td>4.301</td>
</tr>
<tr>
<td>BsmtFinSF2</td>
<td>4.145</td>
</tr>
<tr>
<td>EnclosedPorch</td>
<td>4.002</td>
</tr>
<tr>
<td>ScreenPorch</td>
<td>3.945</td>
</tr>
</tbody></table>
<p>符合正态分布的变量斜度应该基本为0，离0越远表示越不符合正态分布</p>
<h3 id="对高斜度变量进行box-cox变换"><a href="#对高斜度变量进行box-cox变换" class="headerlink" title="对高斜度变量进行box-cox变换"></a>对高斜度变量进行box-cox变换</h3><p>box-cox变换的公式</p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">y</span> <span class="operator">=</span> <span class="punctuation">(</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">+</span><span class="variable">x</span><span class="punctuation">)</span><span class="operator">**</span><span class="variable">lmbda</span> <span class="operator">-</span> <span class="number">1</span><span class="punctuation">)</span> <span class="operator">/</span> <span class="variable">lmbda</span>  <span class="variable">if</span> <span class="variable">lmbda</span> <span class="operator">!=</span> <span class="number">0</span></span><br><span class="line">    <span class="variable">log</span><span class="punctuation">(</span><span class="number">1</span><span class="operator">+</span><span class="variable">x</span><span class="punctuation">)</span>                    <span class="variable">if</span> <span class="variable">lmbda</span> <span class="operator">==</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>找出斜度大于0.75的值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">skewness = skewness[<span class="built_in">abs</span>(skewness) &gt; <span class="number">0.75</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;There are &#123;&#125; skewed numerical features to Box Cox transform&quot;</span>.<span class="built_in">format</span>(skewness.shape[<span class="number">0</span>]))</span><br></pre></td></tr></table></figure>

<p>进行box-cox变换</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 进行box-cox变换</span></span><br><span class="line">skewness = skewness[<span class="built_in">abs</span>(skewness)&gt;<span class="number">0.75</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;斜度大于0.75的有&#123;&#125;个&#x27;</span>.<span class="built_in">format</span>(skewness.shape[<span class="number">0</span>]))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(skewed_feats))</span><br><span class="line"><span class="keyword">from</span> scipy.special <span class="keyword">import</span> boxcox1p</span><br><span class="line">lam = <span class="number">0.15</span></span><br><span class="line"><span class="keyword">for</span> feat <span class="keyword">in</span> skewed_feats.index:</span><br><span class="line">    all_data[feat] = boxcox1p(all_data[feat],lam)</span><br></pre></td></tr></table></figure>

<h2 id="得到哑变量"><a href="#得到哑变量" class="headerlink" title="得到哑变量"></a>得到哑变量</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">all_data = pd.get_dummies(all_data)</span><br><span class="line"><span class="built_in">print</span>(all_data.shape)</span><br></pre></td></tr></table></figure>

<h2 id="建立模型"><a href="#建立模型" class="headerlink" title="建立模型"></a>建立模型</h2><p>首先导入一系列会用到的包</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sklearn.linear_model <span class="keyword">import</span> ElasticNet, Lasso,  BayesianRidge, LassoLarsIC</span><br><span class="line"><span class="keyword">from</span> sklearn.ensemble <span class="keyword">import</span> RandomForestRegressor,  GradientBoostingRegressor</span><br><span class="line"><span class="keyword">from</span> sklearn.kernel_ridge <span class="keyword">import</span> KernelRidge</span><br><span class="line"><span class="keyword">from</span> sklearn.pipeline <span class="keyword">import</span> make_pipeline</span><br><span class="line"><span class="keyword">from</span> sklearn.preprocessing <span class="keyword">import</span> RobustScaler</span><br><span class="line"><span class="keyword">from</span> sklearn.base <span class="keyword">import</span> BaseEstimator, TransformerMixin, RegressorMixin, clone</span><br><span class="line"><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> KFold, cross_val_score, train_test_split</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics <span class="keyword">import</span> mean_squared_error</span><br><span class="line"><span class="keyword">import</span> xgboost <span class="keyword">as</span> xgb</span><br><span class="line"><span class="keyword">import</span> lightgbm <span class="keyword">as</span> lgb</span><br></pre></td></tr></table></figure>

<p>使用sklearn里面的<code>cross_val_score</code>函数进行交叉验证 ，但是这个函数没有乱序的功能，所以加了一行乱序到这个交叉验证过程中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 交叉验证</span></span><br><span class="line">n_folds = <span class="number">5</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rmsle_cv</span>(<span class="params">model</span>):</span><br><span class="line">    kf = KFold(n_folds, shuffle=<span class="literal">True</span>, random_state=<span class="number">42</span>).get_n_splits(train.values)</span><br><span class="line">    rmse = np.sqrt(-cross_val_score(model, train.values, y_train, scoring=<span class="string">&#x27;neg_mean_squared_error&#x27;</span>,cv=kf))</span><br><span class="line">    <span class="keyword">return</span> rmse</span><br></pre></td></tr></table></figure>



<ul>
<li><p>交叉验证：用相同的数据进行学习和测试，这是机器学习中常见的一种错误，因为这样会过拟合。这样的测试效果是100%正确，但当模型用于新的数据时，得到的结果往往非常差。因此，常常将数据分为训练集和测试集合。<br>在scikit-learn中，为了将数据随机切分，我们可以依靠<a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.train_test_split.html#sklearn.model_selection.train_test_split">train_test_split</a>函数，导入iris数据集进行测试</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> train_test_split</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn <span class="keyword">import</span> datasets</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn <span class="keyword">import</span> svm</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>iris = datasets.load_iris()</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>iris.data.shape, iris.target.shape</span><br><span class="line">((<span class="number">150</span>, <span class="number">4</span>), (<span class="number">150</span>,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 随机分40%的数据为测试集</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>X_train, X_test, y_train, y_test = train_test_split(</span><br><span class="line"><span class="meta">... </span>    iris.data, iris.target, test_size=<span class="number">0.4</span>, random_state=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>X_train.shape, y_train.shape</span><br><span class="line">((<span class="number">90</span>, <span class="number">4</span>), (<span class="number">90</span>,))</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>X_test.shape, y_test.shape</span><br><span class="line">((<span class="number">60</span>, <span class="number">4</span>), (<span class="number">60</span>,))</span><br><span class="line"></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf = svm.SVC(kernel=<span class="string">&#x27;linear&#x27;</span>, C=<span class="number">1</span>).fit(X_train, y_train)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf.score(X_test, y_test)                           </span><br><span class="line"><span class="number">0.96</span>...</span><br></pre></td></tr></table></figure>

<p>在调整参数的时候，那些超参需要手动调节，比如SVM中的C，这样仍然存在过拟合的风险，因为你需要不断调整参数使估计量最优。为了解决这个问题，我们再保留一部分数据，称之为验证集。在训练集上训练，在验证集上调参，最终在测试集上进行测试。<br>然而，这种办法将数据集分成了三部分：训练集，验证集和测试集，可以用于训练模型的数据就非常少了，并且结果很大程度上取决于三部分的划分方法。<br>这个问题的解决办法就是交叉验证（CV），在交叉验证中，仍然需要测试集，但是不在需要验证集。交叉验证最基本的方法就是k-fold 交叉验证：</p>
<ul>
<li>训练集被分为k个小的集合；</li>
<li>用k-1个folds的数据进行训练</li>
<li>余下的一个folds数据被用于验证模型</li>
</ul>
<p>最终模型的性能就是k折交叉验证循环中的平均值。</p>
</li>
<li><p>计算交叉验证矩阵<br>最简单的方法就是<a href="http://scikit-learn.org/stable/modules/generated/sklearn.model_selection.cross_val_score.html#sklearn.model_selection.cross_val_score">cross_val_score</a>函数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> cross_val_score</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>clf = svm.SVC(kernel=<span class="string">&#x27;linear&#x27;</span>, C=<span class="number">1</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>scores = cross_val_score(clf, iris.data, iris.target, cv=<span class="number">5</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>scores                                              </span><br><span class="line">array([ <span class="number">0.96</span>...,  <span class="number">1.</span>  ...,  <span class="number">0.96</span>...,  <span class="number">0.96</span>...,  <span class="number">1.</span>        ])</span><br></pre></td></tr></table></figure>

<p>平均的模型精度的95%置信区间就是：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">print</span>(<span class="string">&quot;Accuracy: %0.2f (+/- %0.2f)&quot;</span> % (scores.mean(), scores.std() * <span class="number">2</span>))</span><br><span class="line">Accuracy: <span class="number">0.98</span> (+/- <span class="number">0.03</span>)</span><br></pre></td></tr></table></figure>

<p>可以通过传入不同的score方法来返回不同的结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn <span class="keyword">import</span> metrics</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>scores = cross_val_score(clf, iris.data, iris.target, cv=<span class="number">5</span>, scoring=<span class="string">&#x27;f1_macro&#x27;</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>scores                                              </span><br><span class="line">array([ <span class="number">0.96</span>...,  <span class="number">1.</span>  ...,  <span class="number">0.96</span>...,  <span class="number">0.96</span>...,  <span class="number">1.</span>        ])</span><br></pre></td></tr></table></figure>
</li>
<li><p>score的类型可以查看<a href="http://scikit-learn.org/stable/modules/model_evaluation.html#scoring-parameter">The scoring parameter: defining model evaluation rules</a><br>我们也可以传入打乱的cv</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sklearn.model_selection <span class="keyword">import</span> ShuffleSplit</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>n_samples = iris.data.shape[<span class="number">0</span>]</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cv = ShuffleSplit(n_splits=<span class="number">3</span>, test_size=<span class="number">0.3</span>, random_state=<span class="number">0</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>cross_val_score(clf, iris.data, iris.target, cv=cv)</span><br><span class="line"><span class="meta">... </span>                                                    </span><br><span class="line">array([ <span class="number">0.97</span>...,  <span class="number">0.97</span>...,  <span class="number">1.</span>        ])</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="基本模型的构建"><a href="#基本模型的构建" class="headerlink" title="基本模型的构建"></a>基本模型的构建</h2><p>这里采用了五个基本模型：LASSO Regression （拉索回归），Elastic Net Regression （弹性网络回归），Kernel Ridge Regression （内核岭回归），XGBoost，LightGBM </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 基本模型</span></span><br><span class="line"><span class="comment"># LASSO Regression :拉索回归，用RobustScaler做中间键增强模型稳定性</span></span><br><span class="line">lasso = make_pipeline(RobustScaler(), Lasso(alpha =<span class="number">0.0005</span>, random_state=<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#Elastic Net Regression :弹性网络回归，用RobustScaler做中间键增强模型稳定性</span></span><br><span class="line">ENet = make_pipeline(RobustScaler(), ElasticNet(alpha=<span class="number">0.0005</span>, l1_ratio=<span class="number">.9</span>, random_state=<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Kernel Ridge Regression :内核岭回归，以huber作为损失函数提高稳定性</span></span><br><span class="line">KRR = GradientBoostingRegressor(n_estimators=<span class="number">3000</span>, learning_rate=<span class="number">0.05</span>,</span><br><span class="line">                                   max_depth=<span class="number">4</span>, max_features=<span class="string">&#x27;sqrt&#x27;</span>,</span><br><span class="line">                                   min_samples_leaf=<span class="number">15</span>, min_samples_split=<span class="number">10</span>,</span><br><span class="line">                                   loss=<span class="string">&#x27;huber&#x27;</span>, random_state =<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#Gradient Boosting Regression : :</span></span><br><span class="line">GBoost = GradientBoostingRegressor(n_estimators=<span class="number">3000</span>, learning_rate=<span class="number">0.05</span>,</span><br><span class="line">                                   max_depth=<span class="number">4</span>, max_features=<span class="string">&#x27;sqrt&#x27;</span>,</span><br><span class="line">                                   min_samples_leaf=<span class="number">15</span>, min_samples_split=<span class="number">10</span>,</span><br><span class="line">                                   loss=<span class="string">&#x27;huber&#x27;</span>, random_state =<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#XGBoost :</span></span><br><span class="line">model_xgb = xgb.XGBRegressor(colsample_bytree=<span class="number">0.4603</span>, gamma=<span class="number">0.0468</span>, </span><br><span class="line">                             learning_rate=<span class="number">0.05</span>, max_depth=<span class="number">3</span>, </span><br><span class="line">                             min_child_weight=<span class="number">1.7817</span>, n_estimators=<span class="number">2200</span>,</span><br><span class="line">                             reg_alpha=<span class="number">0.4640</span>, reg_lambda=<span class="number">0.8571</span>,</span><br><span class="line">                             subsample=<span class="number">0.5213</span>, silent=<span class="number">1</span>,</span><br><span class="line">                             random_state =<span class="number">7</span>, nthread = -<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#LightGBM :</span></span><br><span class="line">model_lgb = lgb.LGBMRegressor(objective=<span class="string">&#x27;regression&#x27;</span>,num_leaves=<span class="number">5</span>,</span><br><span class="line">                              learning_rate=<span class="number">0.05</span>, n_estimators=<span class="number">720</span>,</span><br><span class="line">                              max_bin = <span class="number">55</span>, bagging_fraction = <span class="number">0.8</span>,</span><br><span class="line">                              bagging_freq = <span class="number">5</span>, feature_fraction = <span class="number">0.2319</span>,</span><br><span class="line">                              feature_fraction_seed=<span class="number">9</span>, bagging_seed=<span class="number">9</span>,</span><br><span class="line">                              min_data_in_leaf =<span class="number">6</span>, min_sum_hessian_in_leaf = <span class="number">11</span>)</span><br></pre></td></tr></table></figure>

<p>看看每个模型单独的效果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">score = rmsle_cv(lasso)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nLasso score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n&quot;</span>.<span class="built_in">format</span>(score.mean(), score.std()))</span><br><span class="line">score = rmsle_cv(ENet)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ElasticNet score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n&quot;</span>.<span class="built_in">format</span>(score.mean(), score.std()))</span><br><span class="line">score = rmsle_cv(KRR)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Kernel Ridge score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n&quot;</span>.<span class="built_in">format</span>(score.mean(), score.std()))</span><br><span class="line">score = rmsle_cv(GBoost)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Gradient Boosting score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n&quot;</span>.<span class="built_in">format</span>(score.mean(), score.std()))</span><br><span class="line">score = rmsle_cv(model_xgb)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Xgboost score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n&quot;</span>.<span class="built_in">format</span>(score.mean(), score.std()))</span><br><span class="line">score = rmsle_cv(model_lgb)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;LGBM score: &#123;:.4f&#125; (&#123;:.4f&#125;)\n&quot;</span> .<span class="built_in">format</span>(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Lasso score: <span class="number">0.1115</span> (<span class="number">0.0074</span>)</span><br><span class="line"></span><br><span class="line">ElasticNet score: <span class="number">0.1116</span> (<span class="number">0.0074</span>)</span><br><span class="line"></span><br><span class="line">Kernel Ridge score: <span class="number">0.1176</span> (<span class="number">0.0081</span>)</span><br><span class="line"></span><br><span class="line">Gradient Boosting score: <span class="number">0.1176</span> (<span class="number">0.0081</span>)</span><br><span class="line"></span><br><span class="line">Xgboost score: <span class="number">0.1151</span> (<span class="number">0.0069</span>)</span><br><span class="line"></span><br><span class="line">LGBM score: <span class="number">0.1162</span> (<span class="number">0.0071</span>)</span><br></pre></td></tr></table></figure>

<h2 id="模型堆叠"><a href="#模型堆叠" class="headerlink" title="模型堆叠"></a>模型堆叠</h2><h3 id="最简单的堆叠方法：-平均基础模型"><a href="#最简单的堆叠方法：-平均基础模型" class="headerlink" title="最简单的堆叠方法： 平均基础模型"></a>最简单的堆叠方法： 平均基础模型</h3><p>我们写个新的类用于模型堆叠，顺便对代码进行重构</p>
<p>写自己的估计函数的方法：</p>
<ul>
<li>首先决定你想要建立的方法，可能是四种之一：<em>Classifier</em>, <em>Clusterring</em>, <em>Regressor</em>  and <em>Transformer</em>，Classifier是用于分类，Clusterring用于聚类，Regressor 用于回归预测，transform用于数据变换（输入一个数据x，返回数据的变化，比如PCA）；</li>
<li>选好之后，需要去继承<code>BaseEstimator</code> ，并选择合适的类型继承（ <code>ClassifierMixin, RegressorMixin, ClusterMixin, TransformerMixin</code>）；</li>
<li>然后重写，<code>__init__</code>方法，<code>fit</code>方法（返回self，即为模型的训练方法），以及<code>predict</code>和<code>score</code>方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AveragingModels</span>(BaseEstimator, RegressorMixin, TransformerMixin):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, models</span>):</span><br><span class="line">        self.models = models</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">self,X,y</span>):</span><br><span class="line">        self.models_ = [clone(x) <span class="keyword">for</span> x <span class="keyword">in</span> self.models]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> self.models_:</span><br><span class="line">            model.fit(X,y)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self,X</span>):</span><br><span class="line">        predictions = np.column_stack([model.predict(X) <span class="keyword">for</span> model <span class="keyword">in</span> self.models_])</span><br><span class="line">        <span class="keyword">return</span> np.mean(predictions, axis=<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<p>最后看看得到的结果：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">averaged_models = AveragingModels(models = (ENet, GBoost, KRR, lasso))</span><br><span class="line">score = rmsle_cv(averaged_models)</span><br><span class="line"><span class="built_in">print</span>(score.mean(),score.std())</span><br></pre></td></tr></table></figure>

<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">0.109500230379</span>（<span class="number">0.00763453599777</span>）</span><br></pre></td></tr></table></figure>



<h2 id="复杂的融合方法：加入一个元模型"><a href="#复杂的融合方法：加入一个元模型" class="headerlink" title="复杂的融合方法：加入一个元模型"></a>复杂的融合方法：加入一个元模型</h2><p>训练过程如下图：</p>
<ol>
<li>将数据分成两部分，训练和保留部分</li>
<li>用训练数据训练多个基础模型</li>
<li>用保留部分的数据，测试基础模型</li>
<li>用第三步中得到的对保留部分数据的预测作为输入，加上正确的目标变量作为输出，去训练一个更高水平的模型，称为元模型</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/83946384.jpg"></p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-14/63233585.jpg"></p>
<p>在上图中，A,B就是训练数据集，被分成了训练A和保留B，两部分。基础模型是算法0,1,2，元模型是算法3，B1是新的特征用于训练元模型3，C1是最终需要预测的元特征。</p>
<h3 id="Stacking-averaged-Models-Class"><a href="#Stacking-averaged-Models-Class" class="headerlink" title="Stacking averaged Models Class"></a><strong>Stacking averaged Models Class</strong></h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">StackingAveragedModels</span>(BaseEstimator, RegressorMixin, TransformerMixin):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, base_models, meta_model, n_folds=<span class="number">5</span></span>):</span><br><span class="line">        self.base_models = base_models</span><br><span class="line">        self.meta_model = meta_model</span><br><span class="line">        self.n_folds = n_folds</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We again fit the data on clones of the original models</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">fit</span>(<span class="params">self, X, y</span>):</span><br><span class="line">        self.base_models_ = [[]] * <span class="built_in">len</span>(self.base_models)</span><br><span class="line">        self.meta_model_ = clone(self.meta_model)</span><br><span class="line">        kfold = KFold(n_splits=self.n_folds, shuffle=<span class="literal">True</span>, random_state=<span class="number">156</span>)</span><br><span class="line">        out_of_fold_predictions = np.zeros((X.shape[<span class="number">0</span>], <span class="built_in">len</span>(self.base_models)))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i, model <span class="keyword">in</span> <span class="built_in">enumerate</span>(self.base_models):</span><br><span class="line">            <span class="keyword">for</span> train_index, holdout_index <span class="keyword">in</span> kfold.split(X, y):</span><br><span class="line">              <span class="comment">#base_models_长度为模型的个数</span></span><br><span class="line">              <span class="comment">#五折交叉之后，每种模型得到了五个可用的模型，都保存在base_models_[i]中</span></span><br><span class="line">                instance = clone(model)</span><br><span class="line">                self.base_models_[i].append(instance)</span><br><span class="line">                instance.fit(X[train_index], y[train_index])</span><br><span class="line">                y_pred = instance.predict(X[holdout_index])</span><br><span class="line">                out_of_fold_predictions[holdout_index, i] = y_pred</span><br><span class="line">        <span class="comment"># 用的到的[原始数据行数*模型个数]的特征训练新的回归算法</span></span><br><span class="line">        self.meta_model_.fit(out_of_fold_predictions, y)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Do the predictions of all base models on the test data and use the averaged predictions as</span></span><br><span class="line">    <span class="comment"># meta-features for the final prediction which is done by the meta-model</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">predict</span>(<span class="params">self, X</span>):</span><br><span class="line">      <span class="comment"># 每个模型预测X的结果作为特征输入，用心的预测算法预测出最终结果</span></span><br><span class="line">        meta_features = np.column_stack([np.column_stack([model.predict(X) <span class="keyword">for</span> model <span class="keyword">in</span> base_models]).mean(axis=<span class="number">1</span>) <span class="keyword">for</span> base_models <span class="keyword">in</span> self.base_models_])</span><br><span class="line">        <span class="keyword">return</span> self.meta_model_.predict(meta_features)</span><br><span class="line"></span><br><span class="line">stacked_averaged_models = StackingAveragedModels(base_models = (ENet, GBoost,KRR,GBoost,model_xgb,model_lgb),meta_model = lasso)</span><br><span class="line">score = rmsle_cv(stacked_averaged_models)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Stacking Averaged models score: &#123;:.4f&#125; (&#123;:.4f&#125;)&quot;</span>.<span class="built_in">format</span>(score.mean(), score.std()))</span><br></pre></td></tr></table></figure>

<p>最终成绩</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/18-3-17/14861405.jpg"></p>
]]></content>
      <categories>
        <category>数据分析</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>kaggle</tag>
        <tag>数据分析</tag>
      </tags>
  </entry>
  <entry>
    <title>机器学习知识复习</title>
    <url>/2018/02/25/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%9F%A5%E8%AF%86%E5%A4%8D%E4%B9%A0/</url>
    <content><![CDATA[<h2 id="机器学习"><a href="#机器学习" class="headerlink" title="机器学习"></a>机器学习</h2><span id="more"></span>

<h3 id="机器学习基础"><a href="#机器学习基础" class="headerlink" title="机器学习基础"></a>机器学习基础</h3><h4 id="偏差与方差"><a href="#偏差与方差" class="headerlink" title="偏差与方差"></a>偏差与方差</h4><ul>
<li><p>偏差.</p>
<p>偏差度量了学习<strong>算法预测的期望值</strong>与<strong>真实结果</strong>的偏离程度, 即 <strong>刻画了学习算法本身的拟合能力</strong> .</p>
</li>
<li><p>方差.</p>
<p>方差表示<strong>模型预测的期望值</strong>与<strong>预测值</strong>之间的平方和，度量了同样大小的训练集的变动所导致的学习性能的变化, 即 <strong>刻画了数据扰动所造成的影响</strong> .</p>
</li>
<li><p>噪声.</p>
<p>噪声表达了在当前任务上任何学习算法所能达到的期望泛化误差的下界, 即 <strong>刻画了学习问题本身的难度</strong> . 巧妇难为无米之炊, 给一堆很差的食材, 要想做出一顿美味, 肯定是很有难度的.</p>
</li>
</ul>
<h4 id="导致偏差和方差的原因"><a href="#导致偏差和方差的原因" class="headerlink" title="导致偏差和方差的原因"></a>导致偏差和方差的原因</h4><ul>
<li><p>偏差</p>
<p>通常是由于我们对学习算法做了错误的假设，或者模型的复杂度不够；</p>
<ul>
<li>比如真实模型是一个二次函数，而我们假设模型为一次函数，这就会导致偏差的增大（欠拟合）；</li>
<li><strong>由偏差引起的误差</strong>通常在<strong>训练误差</strong>上就能体现，或者说训练误差主要是由偏差造成的</li>
</ul>
</li>
<li><p>方差</p>
<p>通常是由于模型的复杂度相对于训练集过高导致的；</p>
<ul>
<li>比如真实模型是一个简单的二次函数，而我们假设模型是一个高次函数，这就会导致方差的增大（过拟合）；</li>
<li><strong>由方差引起的误差</strong>通常体现在测试误差相对训练误差的<strong>增量</strong>上。</li>
</ul>
</li>
</ul>
<h3 id="深度学习中的偏差与方差"><a href="#深度学习中的偏差与方差" class="headerlink" title="深度学习中的偏差与方差"></a>深度学习中的偏差与方差</h3><ul>
<li><p>神经网络的拟合能力非常强，因此它的<strong>训练误差</strong>（偏差）通常较小；</p>
</li>
<li><p>但是过强的拟合能力会导致较大的方差，使模型的测试误差（<strong>泛化误差</strong>）增大；</p>
</li>
<li><p>因此深度学习的核心工作之一就是研究如何降低模型的泛化误差，这类方法统称为</p>
<p><strong>正则化方法</strong></p>
<ol>
<li><p><strong>batch normalization</strong></p>
<p><strong>1.1. BN的作用</strong></p>
<ul>
<li>BN 是一种正则化方法（减少泛化误差），主要作用有：<ul>
<li><strong>加速网络的训练</strong>（缓解梯度消失，支持更大的学习率）</li>
<li><strong>防止过拟合</strong></li>
<li>降低了<strong>参数初始化</strong>的要求。</li>
</ul>
</li>
</ul>
<p><strong>1.2. 为什么要用BN?</strong></p>
<p><strong>训练的本质是学习数据分布</strong>。如果训练数据与测试数据的分布不同会<strong>降低</strong>模型的<strong>泛化能力</strong>。因此，应该在开始训练前对所有输入数据做归一化处理。</p>
<p>而在神经网络中，因为<strong>每个隐层</strong>的参数不同，会使下一层的输入发生变化，从而导致每一批数据的分布也发生改变；<strong>致使</strong>网络在每次迭代中都需要拟合不同的数据分布，增大了网络的训练难度与<strong>过拟合</strong>的风险。</p>
<p><strong>1.3. BN的基本原理</strong></p>
<ul>
<li><p>BN 方法会针对<strong>每一批数据</strong>，在<strong>网络的每一层输入</strong>之前增加<strong>归一化</strong>处理，使输入的均值为 <code>0</code>，标准差为 <code>1</code>。<strong>目的</strong>是将数据限制在统一的分布下。</p>
</li>
<li><p>具体来说，针对每层的第 <code>k</code> 个神经元，计算<strong>这一批数据</strong>在第 <code>k</code> 个神经元的均值与标准差，然后将归一化后的值作为该神经元的激活值。<br>$$\hat{x}<em>{k} \leftarrow \frac{x</em>{k}-\mathrm{E}\left[x_{k}\right]}{\sqrt{\operatorname{Var}\left[x_{k}\right]}}$$</p>
</li>
<li><p>但同时 BN 也降低了模型的拟合能力，破坏了之前学到的<strong>特征分布</strong>；</p>
</li>
<li><p>为了<strong>恢复数据的原始分布</strong>，BN 引入了一个<strong>重构变换</strong>来还原最优的输入数据分布</p>
<p>$$y_{k} \leftarrow \gamma \hat{X}_{k}+\beta​$$</p>
</li>
</ul>
<p><strong>1.4. BN方法小结</strong></p>
<p>BN的过程可以归纳为一个函数：</p>
<p>$$\begin{aligned} \mathrm{BN}\left(\boldsymbol{x}<em>{i}\right) &amp;&#x3D;\gamma \hat{\boldsymbol{x}}</em>{i}+\beta \ &amp;&#x3D;\gamma \frac{\boldsymbol{x}<em>{i}-\mathbf{E}\left[\boldsymbol{x}</em>{i}\right]}{\sqrt{\boldsymbol{\operatorname { V a r }}\left[\boldsymbol{x}_{i}\right]+\epsilon}}+\beta \end{aligned}​$$</p>
<p><strong>1.5. BN在训练和测试时分别怎么做</strong></p>
<ul>
<li><p><strong>训练时</strong>每次会传入一批数据，做法如前述；</p>
</li>
<li><p>当<strong>测试</strong>或<strong>预测时</strong>，每次可能只会传入<strong>单个数据</strong>，此时模型会使用<strong>全局统计量</strong>代替批统计量；</p>
<ul>
<li><p>训练每个 batch 时，都会得到一组<code>（均值，方差）</code>；</p>
</li>
<li><p>所谓全局统计量，就是对这些均值和方差求其对应的数学期望；</p>
</li>
<li><p>具体计算公式为： </p>
<p>$$\begin{array}{c}{\mathrm{E}[x] \leftarrow \mathrm{E}\left[\mu_{i}\right]} \ {\operatorname{Var}[x] \leftarrow \frac{m}{m-1} \mathrm{E}\left[\sigma_{i}^{2}\right]}\end{array}$$ </p>
<blockquote>
<p>其中 $μ_i$ 和 $σ_i$ 分别表示第 i 轮 batch 保存的均值和标准差；<code>m</code> 为 batch_size，系数 <code>m/(m-1)</code> 用于计算<strong>无偏方差估计</strong></p>
</blockquote>
<blockquote>
<p> 原文称该方法为<strong>移动平均</strong>（moving averages）</p>
</blockquote>
</li>
<li><p>此时的BN调整为</p>
<p>$$\begin{aligned} \mathrm{BN}\left(\boldsymbol{x}<em>{i}\right) &amp;&#x3D;\gamma \frac{\boldsymbol{x}</em>{i}-\mathbf{E}\left[\boldsymbol{x}<em>{i}\right]}{\sqrt{\operatorname{Var}\left[\boldsymbol{x}</em>{i}\right]+\epsilon}}+\beta \ &amp;&#x3D;\frac{\gamma}{\sqrt{\operatorname{Var}\left[\boldsymbol{x}<em>{i}\right]+\epsilon}} \boldsymbol{x}</em>{i}+\left(\beta-\frac{\gamma \mathbf{E}\left[\boldsymbol{x}<em>{i}\right]}{\sqrt{\operatorname{Var}\left[\boldsymbol{x}</em>{i}\right]+\epsilon}}\right)\end{aligned}$$</p>
</li>
</ul>
</li>
</ul>
<p>具体来说：BN就是</p>
<ul>
<li><p>在训练时用每一批数据的均值和标准差做平均得到$\hat{X}_k$，然后用$y_k \leftarrow \gamma \hat X_k+\beta$做变换得到最终需要的x，进行训练。</p>
</li>
<li><p>而测试时用每批数据得到的均值方差求平均来做归一化</p>
</li>
</ul>
</li>
<li><p><strong>L1&#x2F;L2 范数正则化</strong></p>
<p><strong>2.1. L1&#x2F;L2 范数的作用、异同</strong><br><strong>相同点</strong></p>
<ul>
<li>限制模型的学习能力——通过限制参数的规模，使模型偏好于<strong>权值较小</strong>的目标函数，防止过拟合。</li>
</ul>
<p><strong>不同点</strong></p>
<ul>
<li><strong>L1 正则化</strong>可以产生更<strong>稀疏的权值矩阵</strong>，可以用于特征选择，同时一定程度上防止过拟合；<strong>L2 正则化</strong>主要用于防止模型过拟合</li>
<li><strong>L1 正则化</strong>适用于特征之间有关联的情况；<strong>L2 正则化</strong>适用于特征之间没有关联的情况。</li>
</ul>
<p><strong>2.2. 为什么 L1 和 L2 正则化可以防止过拟合？</strong></p>
<ul>
<li>L1 &amp; L2 正则化会使模型偏好于更小的权值。</li>
<li>更小的权值意味着<strong>更低的模型复杂度</strong>；添加 L1 &amp; L2 正则化相当于为模型添加了某种<strong>先验</strong>，限制了参数的分布，从而降低了模型的复杂度。</li>
<li>模型的复杂度降低，意味着模型对于噪声与异常点的抗干扰性的能力增强，从而提高模型的泛化能力。——直观来说，就是对训练数据的拟合刚刚好，不会过分拟合训练数据（比如异常点，噪声）——<strong>奥卡姆剃刀原理</strong></li>
</ul>
<p><strong>2.3. 为什么 L1 正则化可以产生稀疏权值，而 L2 不会？</strong><br>L1正则化和L2正则化可以看做是损失函数的惩罚项。所谓『惩罚』是指对损失函数中的某些参数做一些限制。对于线性回归模型，使用L1正则化的模型建叫做Lasso回归，使用L2正则化的模型叫做Ridge回归（岭回归）。</p>
<p>L1回归的公式如下：<br>$$<br>J&#x3D;J_{0}+\alpha \sum_{w}|w|<br>$$<br>其中$J_0​$是原始的损失函数，加号后面的一项是L1正则化项，α是正则化系数。</p>
<p>注意到L1正则化是权值的绝对值之和，$J$是带有绝对值符号的函数，因此$J$是不完全可微的。机器学习的任务就是要通过一些方法（比如梯度下降）求出损失函数的最小值。当我们在原始损失函数$J_0$后添加L1正则化项时，相当于对$J_0$做了一个约束。令$L&#x3D;\alpha \sum_w|w|$，则$J&#x3D;J_0+L$，此时我们的任务变成在L1约束下求出$J_0$取最小值的解。考虑二维的情况，即只有两个权值$w^1$和$w^2$，此时$L&#x3D;\left|w^1\right|+\left|w^2\right|$对于梯度下降法，求解$J_0$的过程可以画出等值线，同时L1正则化的函数L也可以在w1w2的二维平面上画出来。如下图：</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190226104434.png"></p>
<p>图中等值线是$J_0​$的等值线，黑色方形是L函数的图形。在图中，当$J_0​$等值线与$L​$图形首次相交的地方就是最优解。上图中$J_0​$与L在L的一个顶点处相交，这个顶点就是最优解。注意到这个顶点的值是$\left(w^1, w^2\right)&#x3D;(0, w)​$。可以直观想象，因为L函数有很多『突出的角』（二维情况下四个，多维情况下更多），$J_0​$与这些角接触的机率会远大于与L其它部位接触的机率，而在这些角上，会有很多权值等于0，这就是为什么L1正则化可以产生稀疏模型，进而可以用于特征选择。</p>
<p>而L2正则化的公式如下：</p>
<p>$$J&#x3D;J_{0}+\alpha \sum_{m} w^{2}$$</p>
<p>平面图如下，因为此时L2的图形是一个圆，因此两者相交的点没有0的情况，这就是L2不产生稀疏矩阵的原因。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190226104909.png"></p>
</li>
</ol>
</li>
</ul>
<p>P.S. 为什么相切的点就是所求的点。我们要求$J_0​$在L约束下的最小值，L是约束，那么我们就只能在下面的菱形和圆形里面取值，相切那个点。（彩色等值线是越靠近外面越大）</p>
<h3 id="偏差与方差的权衡"><a href="#偏差与方差的权衡" class="headerlink" title="偏差与方差的权衡"></a>偏差与方差的权衡</h3><ul>
<li>给定一个机器学习任务：<ul>
<li>训练不足时，模型拟合能力不足，此时偏差是主要影响模型泛化误差的原因。</li>
<li>随着训练进行，模型拟合能力增强，此时方差逐渐主导模型的泛化误差。</li>
<li>当训练充足后，模型拟合能力过强，此时发生过拟合</li>
</ul>
</li>
<li>偏差和方差的关系和模型复杂度，欠拟合，过拟合的概念紧密关联。<ul>
<li>当模型复杂度增大时，偏差随之减小，方差随之增大</li>
<li>泛化误差存在最小值，此时模型复杂度处于最优状态，增大模型复杂度会增大方差，减小模型复杂度会增大偏差。</li>
</ul>
</li>
</ul>
<h3 id="生成模型与判别模型"><a href="#生成模型与判别模型" class="headerlink" title="生成模型与判别模型"></a>生成模型与判别模型</h3><ul>
<li><p>监督学习的任务是学习一个模型，对给定的输入预测相应的输出</p>
</li>
<li><p>这个模型的一般形式为一个<strong>决策函数</strong>或一个<strong>条件概率分布</strong>（后验概率）：<br>$$<br>Y&#x3D;f(X) \quad\text { or } \quad P(Y | X)<br>$$</p>
<ul>
<li><strong>决策函数</strong>：输入 X 返回 Y；其中 Y 与一个<strong>阈值</strong>比较，然后根据比较结果判定 X 的类别</li>
<li><strong>条件概率分布</strong>：输入 X 返回 <strong>X 属于每个类别的概率</strong>；将其中概率最大的作为 X 所属的类别</li>
</ul>
</li>
<li><p>监督学习模型可分为<strong>生成模型</strong>与<strong>判别模型</strong></p>
<ul>
<li><p><strong>判别模型</strong>直接学习<strong>决策函数</strong>或者<strong>条件概率分布</strong></p>
<ul>
<li>直观来说，<strong>判别模型</strong>学习的是类别之间的最优分隔面，反映的是不同类数据之间的差异</li>
</ul>
</li>
<li><p><strong>生成模型</strong>学习的是<strong>联合概率分布</strong>$P(X, Y)$，然后根据条件概率公式计算$P(Y|X)$<br>$$<br>P(Y | X)&#x3D;\frac{P(X, Y)}{P(X)}<br>$$</p>
</li>
</ul>
</li>
</ul>
<p><strong>两者之间的联系</strong></p>
<ul>
<li><p>由生成模型可以得到判别模型，但由判别模型得不到生成模型。</p>
</li>
<li><p>当存在“隐变量”时，只能使用生成模型</p>
<blockquote>
<p>隐变量：当我们找不到引起某一现象的原因时，就把这个在起作用，但无法确定的因素，叫“隐变量”</p>
</blockquote>
</li>
</ul>
<p><strong>优缺点</strong></p>
<ul>
<li>判别模型<ul>
<li>优点<ul>
<li>直接面对预测，往往学习的准确率更高</li>
<li>由于直接学习 <code>P(Y|X)</code> 或 <code>f(X)</code>，可以对数据进行各种程度的抽象，定义特征并使用特征，以简化学习过程</li>
</ul>
</li>
<li>缺点<ul>
<li>不能反映训练数据本身的特性</li>
<li>…</li>
</ul>
</li>
</ul>
</li>
<li>生成模型<ul>
<li>优点<ul>
<li>可以还原出联合概率分布 <code>P(X,Y)</code>，判别方法不能</li>
<li>学习收敛速度更快——即当样本容量增加时，学到的模型可以更快地收敛到真实模型</li>
<li>当存在“隐变量”时，只能使用生成模型</li>
</ul>
</li>
<li>缺点<ul>
<li>学习和计算过程比较复杂</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>常见模型</strong></p>
<ul>
<li>判别模型<ul>
<li>K 近邻、感知机（神经网络）、决策树、逻辑斯蒂回归、<strong>最大熵模型</strong>、SVM、提升方法、<strong>条件随机场</strong></li>
</ul>
</li>
<li>生成模型<ul>
<li>朴素贝叶斯、隐马尔可夫模型、混合高斯模型、贝叶斯网络、马尔可夫随机场</li>
</ul>
</li>
</ul>
<h3 id="先验概率与后验概率"><a href="#先验概率与后验概率" class="headerlink" title="先验概率与后验概率"></a>先验概率与后验概率</h3><blockquote>
<p><a href="https://blog.csdn.net/suranxu007/article/details/50326873">先验概率，后验概率，似然概率，条件概率，贝叶斯，最大似然</a> - CSDN博客</p>
</blockquote>
<p><strong>条件概率</strong>（似然概率）</p>
<ul>
<li>一个事件发生后另一个事件发生的概率。</li>
<li>一般的形式为 <code>P(X|Y)</code>，表示 y 发生的条件下 x 发生的概率。</li>
<li>有时为了区分一般意义上的<strong>条件概率</strong>，也称<strong>似然概率</strong></li>
</ul>
<p><strong>先验概率</strong></p>
<ul>
<li>事件发生前的预判概率</li>
<li>可以是基于历史数据的统计，可以由背景常识得出，也可以是人的主观观点给出。</li>
<li>一般都是<strong>单独事件</strong>发生的概率，如 <code>P(A)</code>、<code>P(B)</code>。</li>
</ul>
<p><strong>后验概率</strong></p>
<ul>
<li>基于先验概率求得的<strong>反向条件概率</strong>，形式上与条件概率相同（若 <code>P(X|Y)</code> 为正向，则 <code>P(Y|X)</code> 为反向）</li>
</ul>
<p><strong>贝叶斯公式</strong><br>$$<br>P(Y | X)&#x3D;\frac{P(X | Y) * P(Y)}{P(X)}<br>$$</p>
<h2 id="机器学习实践"><a href="#机器学习实践" class="headerlink" title="机器学习实践"></a>机器学习实践</h2><h3 id="超参数选择"><a href="#超参数选择" class="headerlink" title="超参数选择"></a>超参数选择</h3><h4 id="Grid-Search"><a href="#Grid-Search" class="headerlink" title="Grid Search"></a>Grid Search</h4><ul>
<li>网格搜索</li>
<li>在高维空间中对一定区域进行遍历</li>
</ul>
<h4 id="Random-Search"><a href="#Random-Search" class="headerlink" title="Random Search"></a>Random Search</h4><ul>
<li>在高维空间中随机选择若干超参数</li>
</ul>
<h4 id="相关库（未使用）"><a href="#相关库（未使用）" class="headerlink" title="相关库（未使用）"></a>相关库（未使用）</h4><ul>
<li>Hyperopt<ul>
<li>用于超参数优化的 Python 库，其内部使用 Parzen 估计器的树来预测哪组超参数可能会得到好的结果。</li>
<li>GitHub - <a href="https://github.com/hyperopt/hyperopt">https://github.com/hyperopt/hyperopt</a></li>
</ul>
</li>
<li>Hyperas<ul>
<li>将 Hyperopt 与 Keras 模型集成在一起的库</li>
<li>GitHub - <a href="https://github.com/maxpumperla/hyperas">https://github.com/maxpumperla/hyperas</a></li>
</ul>
</li>
</ul>
<h3 id="余弦相似度（Cos距离）与欧氏距离的区别和联系"><a href="#余弦相似度（Cos距离）与欧氏距离的区别和联系" class="headerlink" title="余弦相似度（Cos距离）与欧氏距离的区别和联系"></a>余弦相似度（Cos距离）与欧氏距离的区别和联系</h3><ul>
<li>欧式距离和余弦相似度都能度量 2 个向量之间的相似度</li>
<li>放到向量空间中看，欧式距离衡量两点之间的<strong>直线距离</strong>，而余弦相似度计算的是两个向量之间的<strong>夹角</strong></li>
<li><strong>没有归一化时</strong>，欧式距离的范围是 [0, +∞]，而余弦相似度的范围是 [-1, 1]；余弦距离是计算相似程度，而欧氏距离计算的是相同程度（对应值的相同程度）</li>
<li><strong>归一化的情况下</strong>，可以将空间想象成一个超球面（三维），欧氏距离就是球面上两点的直线距离，而向量余弦值等价于两点的球面距离，本质是一样。</li>
</ul>
<h3 id="监督学习和无监督学习"><a href="#监督学习和无监督学习" class="headerlink" title="监督学习和无监督学习"></a>监督学习和无监督学习</h3><ul>
<li><p>监督学习给定标签，无监督学习不给定标签</p>
</li>
<li><p>监督学习的任务是分类和回归，无监督学习的任务是聚类</p>
</li>
</ul>
<h3 id="熵，交叉熵和相对熵"><a href="#熵，交叉熵和相对熵" class="headerlink" title="熵，交叉熵和相对熵"></a>熵，交叉熵和相对熵</h3><ul>
<li><p>信息熵代表的是随机变量或整个<strong>系统的不确定性</strong>，熵越大，随机变量或系统的不确定性就越大。<br>$$<br>-\sum_{i&#x3D;1}^{n} P\left(X_{i}\right) \log P\left(X_{i}\right)<br>$$</p>
</li>
<li><p><strong>交叉熵</strong>，其用来衡量在给定的真实分布下，使用<strong>非真实分布</strong>所指定的策略消除系统的不确定性所需要付出的努力的大小<br>$$<br>\sum_{k&#x3D;1}^{N} p_{k} \log <em>{2} \frac{1}{q</em>{k}}<br>$$<br>其中$p_k$是真实分布，$q_k$为非真实分布</p>
<p>因此，交叉熵越低，这个消除系统不确定性的策略就越好，最低的交叉熵也就是使用了真实分布所计算出来的信息熵，因为此时$p_k&#x3D;q_k$ ，交叉熵 &#x3D; 信息熵。这也是为什么在机器学习中的分类算法中，我们总是最小化交叉熵，因为交叉熵越低，就证明由算法所产生的策略最接近最优策略，也间接证明我们算法所算出的非真实分布越接近真实分布。</p>
</li>
<li><p><strong>相对熵</strong>，其用来衡量两个取值为正的函数或概率分布之间的差异，即：<br>相对熵 &#x3D; 某个策略的交叉熵 - 信息熵</p>
</li>
</ul>
<p>具体可以参考<a href="http://drawon.site/2018/09/19/%E7%86%B5-%E4%BA%A4%E5%8F%89%E7%86%B5%E4%B8%8E%E7%9B%B8%E5%AF%B9%E7%86%B5/">熵，交叉熵，相对熵</a></p>
<h3 id="混淆矩阵、模型度量指标：准确率、精确率、召回率、F1-值等"><a href="#混淆矩阵、模型度量指标：准确率、精确率、召回率、F1-值等" class="headerlink" title="混淆矩阵、模型度量指标：准确率、精确率、召回率、F1 值等"></a>混淆矩阵、模型度量指标：准确率、精确率、召回率、F1 值等</h3><p><strong>混淆矩阵</strong></p>
<ul>
<li>True Positive(TP)：将正类预测为正类的数量.</li>
<li>True Negative(TN)：将负类预测为负类的数量.</li>
<li>False Positive(FP)：将负类预测为正类数 → 误报 (Type I error).</li>
<li>False Negative(FN)：将正类预测为负类数 → 漏报 (Type II error).</li>
</ul>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190227145622.png"></p>
<p><strong>准确率</strong>：<br>$$<br>A C C&#x3D;\frac{T P+T N}{T P+T N+F P+F N}<br>$$<br><strong>精确率</strong>：<br>$$<br>P&#x3D;\frac{T P}{T P+F P}<br>$$<br><strong>召回率</strong>：<br>$$<br>R&#x3D;\frac{T P}{T P+F N}<br>$$<br>准确率与精确率的区别：</p>
<blockquote>
<p>在正负样本不平衡的情况下，<strong>准确率</strong>这个评价指标有很大的缺陷。比如在互联网广告里面，点击的数量是很少的，一般只有千分之几，如果用acc，即使全部预测成负类（不点击）acc 也有 99% 以上，没有意义。</p>
</blockquote>
<p><strong>F1值</strong>——精确率和召回率的调和均值：<br>$$<br>\begin{aligned} \frac{2}{F_{1}} &amp;&#x3D;\frac{1}{P}+\frac{1}{R} \ F_{1} &amp;&#x3D;\frac{2 T P}{2 T P+F P+F N} \end{aligned}<br>$$</p>
<blockquote>
<p>只有当精确率和召回率都很高时，F1值才会高</p>
</blockquote>
<h3 id="如何处理数据中的缺失值"><a href="#如何处理数据中的缺失值" class="headerlink" title="如何处理数据中的缺失值"></a>如何处理数据中的缺失值</h3><p>可以分为以下 2 种情况：</p>
<ol>
<li><p>缺失值较多</p>
<ul>
<li>直接舍弃该列特征，否则可能会带来较大的噪声，从而对结果造成不良影响。</li>
</ul>
</li>
<li><p>缺失值较少</p>
<ul>
<li>当缺失值较少（&lt;10%）时，可以考虑对缺失值进行填充，以下是几种常用的填充策略：</li>
</ul>
<ol>
<li><p>用一个<strong>异常值</strong>填充（比如 0），将缺失值作为一个特征处理</p>
<p><code>data.fillna(0)</code></p>
</li>
<li><p>用<strong>均值</strong>|<strong>条件均值</strong>填充</p>
<blockquote>
<p>如果数据是不平衡的，那么应该使用条件均值填充</p>
<p>所谓<strong>条件均值</strong>，指的是与缺失值所属标签相同的所有数据的均值</p>
</blockquote>
<p><code>data.fillna(data.mean())</code></p>
</li>
<li><p>用相邻数据填充</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 用前一个数据填充</span><br><span class="line">data.fillna(method=&#x27;pad&#x27;)</span><br><span class="line"># 用后一个数据填充</span><br><span class="line">data.fillna(method=&#x27;bfill&#x27;) </span><br></pre></td></tr></table></figure>
</li>
<li><p>插值</p>
<p><code>data.interpolate()</code></p>
</li>
<li><p>拟合</p>
<blockquote>
<p>简单来说，就是将缺失值也作为一个预测问题来处理：将数据分为正常数据和缺失数据，对有值的数据采用随机森林等方法拟合，然后对有缺失值的数据进行预测，用预测的值来填充。</p>
</blockquote>
</li>
</ol>
</li>
</ol>
<h3 id="关联规则挖掘的-3-个度量指标：支持度、置信度、提升度"><a href="#关联规则挖掘的-3-个度量指标：支持度、置信度、提升度" class="headerlink" title="关联规则挖掘的 3 个度量指标：支持度、置信度、提升度"></a>关联规则挖掘的 3 个度量指标：支持度、置信度、提升度</h3><p><strong>支持度</strong>（Support）</p>
<ul>
<li>X → Y 的支持度表示项集 {X,Y} 在总项集中出现的概率<br>$$<br>\text { Support }(X \rightarrow Y)&#x3D;\frac{P(X \cup Y)}{P(I)}&#x3D;\frac{\operatorname{num}(X \cup Y)}{\operatorname{num}(I)}<br>$$</li>
</ul>
<p><strong>置信度</strong>（Confidence）</p>
<ul>
<li>X → Y 的置信度表示在先决条件 X 发生的情况下，由规则 X → Y 推出 Y 的概率。</li>
</ul>
<p>$$<br>\text { Con fidence }(X \rightarrow Y)&#x3D;P(Y | X)&#x3D;\frac{P(X \cup Y)}{P(X)}&#x3D;\frac{\operatorname{num}(X \cup Y)}{\operatorname{num}(X)}<br>$$</p>
<p><strong>提升度</strong>（Lift）</p>
<ul>
<li>X → Y 的提升度表示含有X的条件下，同时含有Y的概率，与Y总体发生的概率之比。</li>
</ul>
<p>$$<br>\begin{aligned} \operatorname{Lift}(X \rightarrow Y) &amp;&#x3D;\frac{P(Y | X)}{P(Y)}&#x3D;\frac{\text { Con fidence }(X \rightarrow Y)}{\operatorname{num}(Y) &#x2F; \operatorname{num}(I)} \ &amp;&#x3D;\frac{P(X \cup Y)}{P(X) P(Y)}&#x3D;\frac{\operatorname{num}(X \cup Y) \operatorname{num}(I)}{\operatorname{num}(X) \operatorname{num}(Y)} \end{aligned}<br>$$</p>
<h3 id="规则的有效性："><a href="#规则的有效性：" class="headerlink" title="规则的有效性："></a>规则的有效性：</h3><ul>
<li><p>满足最小支持度和最小置信度的规则，叫做“强关联规则”</p>
<blockquote>
<p>最小支持度和最小置信度是人工设置的阈值</p>
</blockquote>
</li>
<li><p><code>Lift(X→Y) &gt; 1</code> 的 X→Y 是有效的强关联规则</p>
</li>
<li><p><code>Lift(X→Y) &lt;=1</code> 的 X→Y 是无效的强关联规则</p>
</li>
<li><p>特别地，<code>Lift(X→Y) = 1</code> 时，X 与 Y 相互独立。</p>
</li>
</ul>
<h3 id="判断规则的有效性"><a href="#判断规则的有效性" class="headerlink" title="判断规则的有效性"></a><strong>判断规则的有效性</strong></h3><p>问题：已知有1000名顾客买年货，分为甲乙两组，每组各500人，其中甲组有500人买了茶叶，同时又有450人买了咖啡；乙组有450人买了咖啡，如表所示，请问“茶叶→咖啡”是一条有效的关联规则吗？</p>
<table>
<thead>
<tr>
<th>组次</th>
<th>买茶叶的人数</th>
<th>买咖啡的人数</th>
</tr>
</thead>
<tbody><tr>
<td>甲组（500人）</td>
<td>500</td>
<td>450</td>
</tr>
<tr>
<td>乙组（500人）</td>
<td>0</td>
<td>450</td>
</tr>
</tbody></table>
<p>答：</p>
<ul>
<li>“茶叶→咖啡”的支持度：Support(X→Y) &#x3D; 450 &#x2F; 1000 &#x3D; 45%</li>
<li>“茶叶→咖啡”的置信度：Confidence(X→Y) &#x3D; 450 &#x2F; 500 &#x3D; 90%</li>
<li>“茶叶→咖啡”的提升度：Lift(X→Y) &#x3D; 90% &#x2F; 90% &#x3D; 1</li>
</ul>
<p>由于提升度 <code>Lift(X→Y) = 1</code>，表示 X 与 Y 相互独立。也就是说，是否购买咖啡，与是否购买茶叶无关联。规则“茶叶→咖啡”不成立，或者说几乎没有关联，虽然它的置信度高达90%，但它不是一条有效的关联规则。</p>
<h2 id="机器学习算法"><a href="#机器学习算法" class="headerlink" title="机器学习算法"></a>机器学习算法</h2><ul>
<li><p>基本遵从《统计学习方法》一书中的符号表示。</p>
</li>
<li><p>除特别说明，默认<code>w</code>为行向量，<code>x</code>为列向量，以避免在<code>wx</code>中使用转置符号；但有些公式为了更清晰区分向量与标量，依然会使用<code>^T</code>的上标，注意区分。</p>
<p>输入实例<code>x</code>的特征向量记为：<br>$$<br>x&#x3D;\left(x^{(1)}, x^{(2)}, \cdots, x^{(n)}\right)^{T}<br>$$</p>
</li>
</ul>
<p>注意：<code>x_i</code> 和 <code>x^(i)</code> 含义不同，前者表示训练集中第 i 个实例，后者表示特征向量中的第 i 个分量；因此，通常记训练集为：<br>$$<br>T&#x3D;\left{\left(x_{1}, y_{1}\right),\left(x_{2}, y_{2}\right), \cdots,\left(x_{N}, y_{N}\right)\right}<br>$$</p>
<blockquote>
<p> 特征向量用小<code>n</code>表示维数，训练集用大<code>N</code>表示个数</p>
</blockquote>
<h3 id="信息论"><a href="#信息论" class="headerlink" title="信息论"></a>信息论</h3><ul>
<li><p>信息论的基本思想：一件不太可能的事发生，要比一件非常可能的事发生，提供更多的信息。</p>
</li>
<li><p>该想法可描述为以下性质：</p>
<ol>
<li>非常可能发生的事件信息量要比较少，并且极端情况下，一定能够发生的事件应该没有信息量。</li>
<li>比较不可能发生的事件具有更大的信息量。</li>
<li>独立事件应具有增量的信息。例如，投掷的硬币两次正面朝上传递的信息量，应该是投掷一次硬币正面朝上的信息量的两倍。</li>
</ol>
</li>
</ul>
<h3 id="信息熵"><a href="#信息熵" class="headerlink" title="信息熵"></a>信息熵</h3><p>信息熵可以参照第一章中的内容</p>
<h3 id="逻辑回归"><a href="#逻辑回归" class="headerlink" title="逻辑回归"></a>逻辑回归</h3><h4 id="逻辑回归模型定义"><a href="#逻辑回归模型定义" class="headerlink" title="逻辑回归模型定义"></a>逻辑回归模型定义</h4><p><strong>二项</strong>逻辑回归模型即如下的<strong>条件概率分布</strong><br>$$<br>\begin{array}{l}{P(Y&#x3D;1 | x)&#x3D;\frac{\exp (w x)}{1+\exp (w x)}&#x3D;\frac{1}{1+\exp (-w x)}} \ {P(Y&#x3D;0 | x)&#x3D;1-P(Y&#x3D;1 | x)}\end{array}<br>$$</p>
<h4 id="逻辑回归的推导"><a href="#逻辑回归的推导" class="headerlink" title="逻辑回归的推导"></a>逻辑回归的推导</h4><p>逻辑回归推导的关键点 (3)</p>
<ol>
<li><p>逻辑回归的定义</p>
</li>
<li><p>损失函数（极大似然）</p>
</li>
<li><p>参数优化（梯度下降）</p>
</li>
<li><p><strong>逻辑斯蒂回归</strong>的定义：<br>$$<br>\begin{aligned} P(Y&amp;&#x3D;1 | x )&#x3D;\frac{1}{1+\exp (-w x)}&#x3D;\sigma(x) \ P(Y&amp;&#x3D;0 | x )&#x3D;1-\sigma(x) \end{aligned}<br>$$</p>
</li>
<li><p><strong>负对数函数</strong>作为损失函数：<br>$$<br>\begin{aligned} L(w) &amp;&#x3D;-\log \left(\prod_{i&#x3D;1}^{N}\left[\sigma\left(x_{i}\right)\right]^{y_{i}}\left[1-\sigma\left(x_{i}\right)\right]^{1-y_{i}}\right) \ &amp;&#x3D;-\sum_{i&#x3D;1}^{N}\left[y_{i} \log \sigma\left(x_{i}\right)+\left(1-y_{i}\right) \log \left(1-\sigma\left(x_{i}\right)\right)\right] \ &amp;&#x3D;-\sum_{i&#x3D;1}^{N}\left[y_{i} \log \frac{\sigma\left(x_{i}\right)}{1-\sigma\left(x_{i}\right)}+\log \left(1-\sigma\left(x_{i}\right)\right)\right] \end{aligned}<br>$$</p>
</li>
</ol>
<p>进一步代入 <code>σ(x)</code> 有：<br>$$<br>L(w)&#x3D;-\sum_{i&#x3D;1}^{N}\left[y_{i}\left(w x_{i}\right)-\log \left(1+\exp \left(w x_{i}\right)\right)\right]<br>$$</p>
<ol start="3">
<li>求梯度<br>$$<br>\begin{aligned} \frac{\partial L(w)}{\partial w} &amp;&#x3D;-\sum_{i&#x3D;1}^{N}\left[y_{i} x_{i}-\frac{\exp \left(w x_{i}\right)}{1+\exp \left(w x_{i}\right)} x_{i}\right] \ &amp;&#x3D;\sum_{i&#x3D;1}^{N}\left[\sigma\left(x_{i}\right)-y_{i}\right] x_{i} \end{aligned}<br>$$</li>
</ol>
<h4 id="多分类逻辑回归"><a href="#多分类逻辑回归" class="headerlink" title="多分类逻辑回归"></a>多分类逻辑回归</h4><ul>
<li>设$Y \in{1,2, \ldots \mathrm{K}}$，则多项式逻辑回归模型为<br>$$<br>\begin{aligned} P(Y&#x3D;k | x) &amp;&#x3D;\frac{\exp \left(w_{k} x\right)}{1+\sum_{k&#x3D;1}^{K-1} \exp \left(w_{k} x\right)} \quad k&#x3D;1,2, \ldots, K-1 \ P(Y&#x3D;K | x) &amp;&#x3D;\frac{1}{1+\sum_{k&#x3D;1}^{K-1} \exp \left(w_{k} x\right)} \end{aligned}<br>$$</li>
</ul>
<p>最终推出来softmax回归<br>$$<br>h_{\theta}\left(x^{(i)}\right)&#x3D;\left[ \begin{array}{c}{p\left(y^{(i)}&#x3D;1 | x^{(i)} ; \theta\right)} \ {p\left(y^{(i)}&#x3D;2 | x^{(i)} ; \theta\right)} \ {\vdots} \ {p\left(y^{(i)}&#x3D;k | x^{(i)} ; \theta\right)}\end{array}\right]&#x3D;\frac{1}{\sum_{j&#x3D;1}^{k} e^{\theta_{j}^{T} x^{(i)}}} \left[ \begin{array}{c}{e^{\theta_{1}^{T} x^{(i)}}} \ {e^{\theta_{2}^{T} x^{(i)}}} \ {\vdots} \ {e^{\theta_{k}^{T} x^{(i)}}}\end{array}\right]<br>$$<br>定义了新的假设函数（hypothesis function）之后，我们要得到其对应的代价函数（cost function）。<br>$$<br>J(\theta)&#x3D;-\frac{1}{m}\left[\sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{k} 1\left{y^{(i)}&#x3D;j\right} \log \frac{e^{\theta_{j}^{T} x^{(i)}}}{\sum_{l&#x3D;1}^{k} e^{\theta_{l}^{T} x^{(i)}}}\right]<br>$$<br>其中 <img src="https://www.zhihu.com/equation?tex=1%5Cleft%5C%7B+%5Ccdot+%5Cright%5C%7D" alt="1\left\{ \cdot \right\}"> 的取值规则为大括号内的表达式值为真时，取 1，为假时取 0。</p>
<p>对该代价函数求最优解同样可以使用如梯度下降之类的迭代算法，其梯度公式如下：<br>$$<br>\nabla_{\theta_{j}} J(\theta)&#x3D;(-\frac{1}{m}\left[\sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{k} 1\left{y^{(i)}&#x3D;j\right} \log \frac{e^{\theta_{j}^{T} x^{(i)}}}{\sum_{l&#x3D;1}^{k} e^{\theta_{l}^{T} x^{(i)}}}\right])’\<br>&#x3D;(-\frac{1}{m}\left[\sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{k} 1\left{y^{(i)}&#x3D;j\right} (\log e^{\theta_{j}^{T} x^{(i)}}-\log {\sum_{l&#x3D;1}^{k} e^{\theta_{l}^{T} x^{(i)}}})\right])’\<br>&#x3D;(-\frac{1}{m}\left[\sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{k} 1\left{y^{(i)}&#x3D;j\right} (\theta_{j}^{T} x^{(i)}-\log {\sum_{l&#x3D;1}^{k} e^{\theta_{l}^{T} x^{(i)}}})\right])’\<br>\<br>&#x3D;-\frac{1}{m}\left[\sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{k} 1\left{y^{(i)}&#x3D;j\right} (x^{(i)}-(\log {\sum_{l&#x3D;1}^{k} e^{\theta_{l}^{T} x^{(i)}}})’)\right]<br>\<br>&#x3D;&#x3D;-\frac{1}{m}\left[\sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{k} 1\left{y^{(i)}&#x3D;j\right} (x^{(i)}-\frac{x^{(i)}*e^{\theta_{l}^{T} x^{(i)}}}{\log {\sum_{l&#x3D;1}^{k} e^{\theta_{l}^{T} x^{(i)}}}})\right]<br>\<br>&#x3D;-\frac{1}{m} \sum_{i&#x3D;1}^{m}\left[x^{(i)}\left(1\left{y^{(i)}&#x3D;j\right}-p\left(y^{(i)}&#x3D;j | x^{(i)} ; \theta\right)\right)\right]<br>$$<br>有了偏导数，就可以对代价函数进行优化，最终求解。</p>
<h3 id="支持向量机"><a href="#支持向量机" class="headerlink" title="支持向量机"></a>支持向量机</h3><ul>
<li>支持向量机（Support Vector Machines, SVM）是一种二分类模型。它的<strong>基本模型</strong>是定义在特征空间上的<strong>间隔最大</strong>的线性分类器，间隔最大使它有别于感知机；支持向量机还包括<strong>核技巧</strong>，这使其成为实质上的非线性分类器。</li>
<li><strong>SVM 的学习策略就是间隔最大化</strong>，可形式化为一个求解<strong>凸二次规划</strong>的问题，也等价于正则化的<strong>合页损失函数</strong>的最小化问题。</li>
<li>SVM 的最优化算法是求解凸二次规划的最优化算法。</li>
</ul>
<h4 id="什么是支持向量"><a href="#什么是支持向量" class="headerlink" title="什么是支持向量"></a>什么是支持向量</h4><ul>
<li>训练数据集中与分离超平面距离最近的样本点的实例称为支持向量（离超平面最近的点就是支持向量，包括正类和负类各自离超平面最近的点）</li>
<li>更通俗的解释：<ul>
<li>数据集种的某些点，位置比较特殊。比如 <code>x+y-2=0</code> 这条直线，假设出现在直线上方的样本记为 A 类，下方的记为 B 类。</li>
<li>在寻找找这条直线的时候，一般只需看两类数据，它们各自最靠近划分直线的那些点，而其他的点起不了决定作用。</li>
<li>这些点就是所谓的“支持点”，在数学中，这些点称为<strong>向量</strong>，所以更正式的名称为“<strong>支持向量</strong>”。</li>
</ul>
</li>
</ul>
<h4 id="支持向量机的分类"><a href="#支持向量机的分类" class="headerlink" title="支持向量机的分类"></a>支持向量机的分类</h4><ul>
<li>线性可分支持向量机<ul>
<li>当训练数据<strong>线性可分</strong>时，通过<strong>硬间隔最大化</strong>，学习一个线性分类器，即线性可分支持向量机，又称<strong>硬间隔支持向量机</strong>。</li>
</ul>
</li>
<li>线性支持向量机<ul>
<li>当训练数据<strong>接近线性可分</strong>时，通过<strong>软间隔最大化</strong>，学习一个线性分类器，即线性支持向量机，又称<strong>软间隔支持向量机</strong>。</li>
</ul>
</li>
<li>非线性支持向量机<ul>
<li>当训练数据<strong>线性不可分</strong>时，通过使用<strong>核技巧</strong>及软间隔最大化，学习非线性支持向量机。</li>
</ul>
</li>
</ul>
<h4 id="核函数与核技巧"><a href="#核函数与核技巧" class="headerlink" title="核函数与核技巧"></a>核函数与核技巧</h4><ul>
<li><strong>核函数</strong>表示将输入从输入空间映射到特征空间后得到的特征向量之间的内积</li>
</ul>
<h4 id="支持向量机推导"><a href="#支持向量机推导" class="headerlink" title="支持向量机推导"></a>支持向量机推导</h4><ul>
<li>svm由简至繁包括：线性可分支持向量机，线性支持向量机，非线性支持向量机</li>
</ul>
<h4 id="线性可分支持向量机的推导"><a href="#线性可分支持向量机的推导" class="headerlink" title="线性可分支持向量机的推导"></a>线性可分支持向量机的推导</h4><ul>
<li>当训练数据<strong>线性可分</strong>时，通过<strong>硬间隔最大化</strong>，学习一个线性分类器，即线性可分支持向量机，又称<strong>硬间隔支持向量机</strong>。</li>
</ul>
<ul>
<li>线性 SVM 的推导分为两部分<ol>
<li>如何根据<strong>间隔最大化</strong>的目标导出 SVM 的<strong>标准问题</strong>；</li>
<li>拉格朗日乘子法对偶问题的求解过程.</li>
</ol>
</li>
</ul>
<h5 id="符号定义："><a href="#符号定义：" class="headerlink" title="符号定义："></a><strong>符号定义</strong>：</h5><ul>
<li>训练集<code>T</code></li>
</ul>
<p>$$<br>T&#x3D;\left{\left(x_{1}, y_{1}\right),\left(x_{2}, y_{2}\right), \cdots,\left(x_{N}, y_{N}\right)\right}<br>$$</p>
<ul>
<li>分离超平面<code>(w,b)</code>：</li>
</ul>
<p>$$<br>w^{<em>} \cdot x+b^{</em>}&#x3D;0<br>$$</p>
<ul>
<li>如果使用映射函数，那么分离超平面为：</li>
</ul>
<p>$$<br>w^{<em>} \cdot \Phi(x)+b^{</em>}&#x3D;0<br>$$</p>
<blockquote>
<p>映射函数 <code>Φ(x)</code> 定义了从输入空间到特征空间的变换，特征空间通常是更高维的，甚至无穷维；方便起见，这里假设 <code>Φ(x)</code> 做的是恒等变换。</p>
</blockquote>
<ul>
<li>分类决策函数 <code>f(x)</code></li>
</ul>
<p>$$<br>f(x)&#x3D;\operatorname{sign}\left(w^{<em>} \cdot x+b^{</em>}\right)<br>$$</p>
<h5 id="SVM-标准问题的推导-2"><a href="#SVM-标准问题的推导-2" class="headerlink" title="SVM 标准问题的推导(2)"></a><strong>SVM 标准问题的推导</strong>(2)</h5><ol>
<li><strong>从“函数间隔”到“几何间隔”</strong></li>
</ol>
<p>给定训练集<code>T</code>和超平面<code>(w,b)</code>，定义<strong>函数间隔</strong>$\hat{\gamma}$：<br>$$<br>\begin{aligned} \hat{\gamma} &amp;&#x3D;\min <em>{i&#x3D;1, \cdots, N} y</em>{i}\left(w x_{i}+b\right) \ &amp;&#x3D;\min <em>{i&#x3D;1, \cdots, N} \hat{\gamma}</em>{i} \end{aligned}<br>$$<br>对 <code>w</code> 作规范化，使函数间隔成为<strong>几何间隔</strong>$\gamma$<br>$$<br>\begin{aligned} \gamma &amp;&#x3D;\min <em>{i&#x3D;1, \cdots, N} y</em>{i}\left(\frac{w}{|w|} x_{i}+\frac{b}{|w|}\right) \ &amp;&#x3D;\min <em>{i&#x3D;1, \cdots, N} \frac{\gamma</em>{i}}{|w|} \end{aligned}<br>$$</p>
<ol start="2">
<li><strong>最大化几何间隔</strong></li>
</ol>
<p>$$<br>\begin{array}{ll}{\max <em>{w, b}} &amp; \hat{\gamma} \ {\text { s.t. }} &amp; {y</em>{i}\left(wx_{i}+b\right) \geq \hat\gamma, \quad i&#x3D;1,2, \cdots, N}\end{array}<br>$$</p>
<p>由函数间隔与几何间隔的关系，等价于<br>$$<br>\begin{array}{ll}{\max <em>{w, b}} &amp; {\gamma} \ {\text { s.t. }} &amp; {y</em>{i}\left(\frac{w}{|w|} x_{i}+\frac{b}{|w|}\right) \geq \gamma, \quad i&#x3D;1,2, \cdots, N}\end{array}<br>$$</p>
<ol start="3">
<li>西瓜书的SVM推导</li>
</ol>
<p>上面的两步推理方式感觉不如西瓜书上面的直接，下面用西瓜书的公式来证明：</p>
<p>用r表示一个点到分类超平面的距离：<br>$$<br>r&#x3D;\frac{\left|w^{T} x+b\right|}{|w|}<br>$$<br>假设超平面<code>(w,b)</code>能够正确分类，也就是对于$y_i&#x3D;1$，有$w^T x_i+b&gt;0$；对于$y_i&#x3D;-1$，有$w^{T} x_{i}+b&lt;0$，则：<br>$$<br>\left{\begin{array}{ll}{w^{\mathrm{T}} x_{i}+b \geqslant+1,} &amp; {y_{i}&#x3D;+1} \ {w^{T} x_{i}+b \leqslant-1,} &amp; {y_{i}&#x3D;-1}\end{array}\right.<br>$$<br>对于距离超平面最近（支持向量）的点，r的距离为1，那么两个异类支持向量到超平面距离和为</p>
<p>$$\gamma &#x3D; \frac{2}{|w|}$$</p>
<p>这被称为“间隔”</p>
<p>我们要最大化间隔，也就是要找到$w, b$，使得$\gamma$最大，即：<br>$$<br>\begin{array}{l}{\max <em>{w, b} \frac{2}{|w|}} \ {\text {s.t.} y</em>{i}\left(w^{T} x_{i}+b\right) \geqslant 1, \quad i&#x3D;1,2, \ldots, m}\end{array}<br>$$<br>为了最大化间隔，仅需要最大化$\frac{1}{|w|}$，等价于最小化$|w|^2$，上面的问题转化为：<br>$$<br>\begin{array}{l}{\min <em>{\boldsymbol{w}, b} \frac{1}{2}|\boldsymbol{w}|^{2}} \ {\text { s.t. } y</em>{i}\left(\boldsymbol{w}^{\mathrm{T}} \boldsymbol{x}_{i}+b\right) \geqslant 1, \quad i&#x3D;1,2, \ldots, m}\end{array}<br>$$<br>这是一个规划问题，在运筹学里面，这样的问题可以通过拉格朗日方程，求他的对偶问题来求解。</p>
<p>令$\alpha_i \ge 0$，上面问题的拉格朗日函数如下：<br>$$<br>L(\boldsymbol{w}, b, \boldsymbol{\alpha})&#x3D;\frac{1}{2}|\boldsymbol{w}|^{2}+\sum_{i&#x3D;1}^{m} \alpha_{i}\left(1-y_{i}\left(\boldsymbol{w}^{\mathrm{T}} \boldsymbol{x}<em>{i}+b\right)\right)<br>$$<br>令拉格朗日函数对$w,b$求导为0可得:<br>$$<br>\begin{aligned} \boldsymbol{w} &amp;&#x3D;\sum</em>{i&#x3D;1}^{m} \alpha_{i} y_{i} \boldsymbol{x}<em>{i} \ 0 &amp;&#x3D;\sum</em>{i&#x3D;1}^{m} \alpha_{i} y_{i} \end{aligned}<br>$$<br>将解得的$w$带入拉格朗日方程可得对偶问题:<br>$$<br>\max <em>{\alpha} \quad \sum</em>{i&#x3D;1}^{m} \alpha_{i}-\frac{1}{2} \sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{m} \alpha_{i} \alpha_{j} y_{i} y_{j} x_{i}^{T} x_{j} \<br>\text { s.t. } \quad {\sum_{i&#x3D;1}^{m} a_{i} y_{i}&#x3D;0} \ {\alpha_{i} \geqslant 0, \quad i&#x3D;1,2, \ldots, m}<br>$$<br>解出$\alpha$之后，带入原分类超平面方程可得:<br>$$<br>\begin{aligned} f(x) &amp;&#x3D;w^{T} x+b \ &amp;&#x3D;\sum_{i&#x3D;1}^{m} \alpha_{i} y_{i} x_{i}^{T} x+b \end{aligned}<br>$$<br>对偶问题是一个二次规划问题，求解对偶问题的方法是SMO（sequential minimal optimization）</p>
<ol start="4">
<li><p><strong>核函数</strong></p>
<p>对于在原始空间中不可分的问题，可以将原始空间映射到一个更高维度的特征空间，是的样本在这个特征空间中线性可分。用$\phi(x)$表示将x映射之后的特征向量，那么特征空间中的超平面可以表示为:<br>$$<br>f(x)&#x3D;w^{T} \phi(x)+b<br>$$<br>类似的，对于$w,b$，有：<br>$$<br>\begin{array}{l}{\min <em>{w, b} \frac{1}{2}|w|^{2}} \ {\text { s.t. } y</em>{i}\left(w^{T} \phi\left(x_{i}\right)+b\right) \geqslant 1, \quad i&#x3D;1,2, \ldots, m}\end{array}<br>$$<br>其对偶问题为：<br>$$<br>\max <em>{\alpha} \quad \sum</em>{i&#x3D;1}^{m} \alpha_{i}-\frac{1}{2} \sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{m} \alpha_{i} \alpha_{j} y_{i} y_{j} \phi (x_{i})^{T} \phi (x_{j}) \\text { s.t. } \quad {\sum_{i&#x3D;1}^{m} a_{i} y_{i}&#x3D;0} \ {\alpha_{i} \geqslant 0, \quad i&#x3D;1,2, \ldots, m}<br>$$<br>求解上面的问题涉及到计算$\phi (x_{i})^{T} \phi (x_{j}) $，这是样本$x_i$和$x_j$映射到特征空间之后的内积，由于特征空间维数很高，甚至可能是无穷维，因此直接计算$\phi (x_{i})^{T} \phi (x_{j})$通常比较难，为了避开这个问题，设计了核函数：<br>$$<br>\kappa\left(\boldsymbol{x}<em>{i}, \boldsymbol{x}</em>{j}\right)&#x3D;\left\langle\phi\left(\boldsymbol{x}<em>{i}\right), \phi\left(\boldsymbol{x}</em>{j}\right)\right\rangle&#x3D;\phi\left(\boldsymbol{x}<em>{i}\right)^{\mathrm{T}} \phi\left(\boldsymbol{x}</em>{j}\right)<br>$$<br>在高维中的内积可以通过低维度中的核函数来求取。</p>
<p>于是上面的对偶问题可以写为：<br>$$<br>\begin{array}{ll}{\max <em>{\alpha}} &amp; {\sum</em>{i&#x3D;1}^{m} \alpha_{i}-\frac{1}{2} \sum_{i&#x3D;1}^{m} \sum_{j&#x3D;1}^{m}}\alpha_{i} \alpha_{j} y_{i} y_{j} \kappa\left(x_{i}, x_{j}\right) \ {\text { s.t. }} &amp; {\sum_{i&#x3D;1}^{m} \alpha_{i} y_{i}&#x3D;0}\end{array}\<br>\alpha_{i} \geqslant 0, \quad i&#x3D;1,2, \ldots, m<br>$$<br>求解得到：<br>$$<br>\begin{aligned} f(\boldsymbol{x}) &amp;&#x3D;\boldsymbol{w}^{\mathrm{T}} \phi(\boldsymbol{x})+b \ &amp;&#x3D;\sum_{i&#x3D;1}^{m} \alpha_{i} y_{i} \phi\left(\boldsymbol{x}<em>{i}\right)^{\mathrm{T}} \phi(\boldsymbol{x})+b \ &amp;&#x3D;\sum</em>{i&#x3D;1}^{m} \alpha_{i} y_{i} \kappa\left(\boldsymbol{x}, \boldsymbol{x}_{i}\right)+b \end{aligned}<br>$$</p>
</li>
<li><p>常用核函数<br><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190302153912.png"></p>
</li>
<li><p>软间隔</p>
<p>上面求解最大最小值的时候，约束条件是必须全部满足。但是一个超平面不一定在特征空间中是线性可分的。即使存在一个超平面能分开，要找到合适的核函数也很难，因此有了软间隔。</p>
<p>软间隔的意思就是某些点可以不满足约束。用替代损失来表示因为某些点不满足造成的损失。</p>
</li>
</ol>
<h3 id="决策树"><a href="#决策树" class="headerlink" title="决策树"></a>决策树</h3><h4 id="分类树-ID3-决策树与-C4-5-决策树-TODO"><a href="#分类树-ID3-决策树与-C4-5-决策树-TODO" class="headerlink" title="分类树 - ID3 决策树与 C4.5 决策树 TODO"></a>分类树 - ID3 决策树与 C4.5 决策树 TODO</h4><ul>
<li>ID3 决策树和 C4.5 决策树的<strong>区别</strong>在于：前者使用<strong>信息增益</strong>来进行特征选择，而后者使用<strong>信息增益比</strong>。</li>
</ul>
<h4 id="回归树-CART-决策树"><a href="#回归树-CART-决策树" class="headerlink" title="回归树 - CART 决策树"></a>回归树 - CART 决策树</h4><ul>
<li>CART 算法是在给定输入随机变量 <em>X</em> 条件下输出随机变量 <em>Y</em> 的<strong>条件概率分布</strong>的学习方法。</li>
</ul>
<ul>
<li><p>CART 算法假设决策树是<strong>二叉树</strong>，内部节点特征的取值为“<strong>是</strong>”和“<strong>否</strong>”。</p>
<p>这样的决策树等价于递归地二分每个特征，<strong>将输入空间&#x2F;特征空间划分为有限个单元</strong>，然后在这些单元上确定在输入给定的条件下输出的<strong>条件概率分布</strong>。</p>
</li>
<li><p>CART 决策树<strong>既可以用于分类，也可以用于回归</strong>；</p>
<p>对回归树 CART 算法用<strong>平方误差最小化</strong>准则来选择特征，对分类树用<strong>基尼指数最小化</strong>准则选择特征</p>
</li>
</ul>
<h5 id="CART-回归树算法推导"><a href="#CART-回归树算法推导" class="headerlink" title="CART 回归树算法推导"></a>CART 回归树算法推导</h5><ul>
<li><p>一个回归树对应着输入空间&#x2F;<strong>特征空间</strong>的一个<strong>划分</strong>以及在划分单元上的<strong>输出值</strong>；</p>
</li>
<li><p>假设已将输入空间划分为 <code>M</code> 个单元：<code>&#123;R_1,..,R_m,..,R_M&#125;</code>，并在每个单元上对应有输出值 <code>c_m</code>，则该回归树可表示为:<br>$$<br>f(x)&#x3D;\sum_{m&#x3D;1}^{M} c_{m} I\left(x \in R_{m}\right)<br>$$</p>
<blockquote>
<p><code>I(x)</code> 为指示函数</p>
</blockquote>
</li>
</ul>
<ul>
<li><strong>如果已经划分好了输入空间</strong>，通常使用<strong>平方误差</strong>作为损失函数来表示回归树对于训练数据的预测误差，通过最小化损失函数来求解每个划分单元的<strong>最优输出值</strong>。</li>
</ul>
<h5 id="如何划分输入空间"><a href="#如何划分输入空间" class="headerlink" title="如何划分输入空间"></a>如何划分输入空间</h5><ul>
<li><p>一个启发式方法是：<strong>以特征向量中的某一个特征为标准进行切分</strong>。</p>
<p>假设选择<strong>特征向量中第 j 个变量</strong>作为<strong>切分变量</strong>，然后选择<strong>某个实例中第 j 个值 s</strong> 作为<strong>切分点</strong>，则定义如下两个划分单元<br>$$<br>R_{1}(j, s)&#x3D;{x | x^{(j)} \leq s}, \quad R_{2}(j, s)&#x3D;{x | x^{(j)}&gt;s}<br>$$</p>
</li>
<li><p>遍历<strong>每个实例</strong>的第<code>j</code>个值<code>s</code>，选择满足以下条件的作为<strong>最优切分变量j和切分点s</strong></p>
</li>
</ul>
<p>$$<br>\min <em>{j, s}\left[\min <em>{c</em>{1}} \sum</em>{x_{i} \in R_{1}(j, s)}\left(y_{i}-c_{1}\right)^{2}+\min <em>{c</em>{2}} \sum_{x_{i} \in R_{2}(j, s)}\left(y_{i}-c_{2}\right)^{2}\right]<br>$$</p>
<p>其中输出值 <code>c1</code> 和 <code>c2</code> 分别为<br>$$<br>\hat{c}<em>{1}&#x3D;\operatorname{avg}\left(y</em>{i} | x_{i} \in R_{1}(j, s)\right), \quad \hat{c}<em>{2}&#x3D;\operatorname{avg}\left(y</em>{i} | x_{i} \in R_{2}(j, s)\right)<br>$$<br>接着，继续对两个子空间重复以上步骤，直到满足条件为止；得到将输入空间划分为<code>M</code>个区域的决策树<br>$$<br>f(x)&#x3D;\sum_{m&#x3D;1}^{M} \hat{c}<em>{m} I\left(x \in R</em>{m}\right)<br>$$</p>
<h5 id="示例-选择切分变量与切分点"><a href="#示例-选择切分变量与切分点" class="headerlink" title="示例: 选择切分变量与切分点"></a>示例: 选择切分变量与切分点</h5><blockquote>
<p>《统计学习方法》 8.4.2</p>
</blockquote>
<ul>
<li>训练集</li>
</ul>
<table>
<thead>
<tr>
<th>x_i</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
</tr>
</thead>
<tbody><tr>
<td>y_i</td>
<td>5.56</td>
<td>5.70</td>
<td>5.91</td>
<td>6.40</td>
<td>6.80</td>
<td>7.05</td>
<td>8.90</td>
<td>8.70</td>
<td>9.00</td>
<td>9.05</td>
</tr>
</tbody></table>
<ul>
<li><p>这里只有一个特征，即<code>j=1</code>；然后遍历每个实例的值作为<strong>切分点</strong></p>
<p><code>s = &#123;1, 2, 3, 4, 5, 6, 7, 8, 9&#125;</code></p>
<blockquote>
<p>原书使用的切分点为 <code>&#123;1.5, 2.5, 3.5, 4.5, 5.5, 6.5, 7.5, 8.5, 9.5&#125;</code>，即相邻两个点的均值；因为切分点并没有参与运算，所以我觉得两者没有区别；</p>
<p>最后一个点无法将数据划分为两个空间，所以不需要</p>
</blockquote>
</li>
<li><p>以 <code>s=1</code> 为例</p>
</li>
</ul>
<p>$$<br>\begin{array}{l}{R_{1}(1,1)&#x3D;{x | x \leq 1}&#x3D;{1}} \ {R_{2}(1,1)&#x3D;{x | x&gt;1}&#x3D;{2,3,4,5,6,7,8,9,10}} \ {c_{1}&#x3D;\frac{1}{\left|R_{1}\right|}&#x3D;\frac{1}{1} \sum_{x_{i} \in R_{1}} y_{i}&#x3D;5.56} \ {c_{2}&#x3D;\frac{1}{\left|R_{2}\right|}&#x3D;\frac{1}{9} \sum_{x_{i} \in R_{2}} y_{i}&#x3D;7.50} \ {m(s)&#x3D;\min <em>{c</em>{1}} \sum_{x_{i} \in R_{1}}\left(y_{i}-c_{1}\right)^{2}+\min <em>{c</em>{2}} \sum_{x_{i} \in R_{2}}\left(y_{i}-c_{2}\right)^{2}&#x3D;0+15.72&#x3D;15.72}\end{array}<br>$$</p>
<p>所有 <code>m(s)</code> 的计算结果如下</p>
<table>
<thead>
<tr>
<th>s</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
</tr>
</thead>
<tbody><tr>
<td>m(s)</td>
<td>15.72</td>
<td>12.07</td>
<td>8.36</td>
<td>5.78</td>
<td>3.91</td>
<td>1.93</td>
<td>8.01</td>
<td>11.73</td>
<td>15.74</td>
</tr>
</tbody></table>
<p>当 <code>s=6</code> 时 <code>m(s)</code> 达到最小值，此时<br>$$<br>\begin{array}{l}{R_{1}(1,6)&#x3D;{x | x \leq 6}&#x3D;{1,2,3,4,5,6}} \ {R_{2}(1,6)&#x3D;{x | x&gt;6}&#x3D;{7,8,9,10}} \ {c_{1}&#x3D;\frac{1}{\left|R_{1}\right|}&#x3D;\frac{1}{6} \sum_{x_{i} \in R_{1}} y_{i}&#x3D;6.24} \ {c_{2}&#x3D;\frac{1}{\left|R_{2}\right|}&#x3D;\frac{1}{4} \sum_{x_{i} \in R_{2}} y_{i}&#x3D;8.91}\end{array}<br>$$<br>所以第一棵决策树为<br>$$<br>\begin{array}{l}T_{1}(x)&#x3D;\left{\begin{array}{ll}{6.24,} &amp; {x&lt;6} \ {8.91,} &amp; {x \geq 6}\end{array}\right.\<br>f_1(x)&#x3D;T_1(x)\end{array}<br>$$</p>
<h3 id="集成学习"><a href="#集成学习" class="headerlink" title="集成学习"></a>集成学习</h3><ul>
<li>基本思想：由多个学习器组合成一个性能更好的学习器</li>
<li><strong>集成学习为什么有效？</strong>——不同的模型通常会在测试集上产生不同的误差。平均上，集成模型能至少与其任一成员表现一致；并且<strong>如果成员的误差是独立的</strong>，集成模型将显著地比其成员表现更好。</li>
</ul>
<h4 id="1-Boosting"><a href="#1-Boosting" class="headerlink" title="1. Boosting"></a>1. Boosting</h4><ul>
<li><p><strong>Boosting</strong>（提升）方法从某个<strong>基学习器</strong>出发，反复学习，得到一系列基学习器，然后组合它们构成一个强学习器。</p>
</li>
<li><p>Boosting 基于<strong>串行策略</strong>：基学习器之间存在依赖关系，新的学习器需要依据旧的学习器生成。</p>
</li>
<li><p>代表算法&#x2F;模型:</p>
<ul>
<li><a href="https://github.com/imhuay/Algorithm_Interview_Notes-Chinese/blob/master/A-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/A-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95.md#%E6%8F%90%E5%8D%87%E6%96%B9%E6%B3%95-adaboost">提升方法 AdaBoost</a></li>
<li>提升树</li>
<li>梯度提升树 GBDT</li>
</ul>
</li>
</ul>
<h5 id="Boosting-策略要解决的两个基本问题"><a href="#Boosting-策略要解决的两个基本问题" class="headerlink" title="Boosting 策略要解决的两个基本问题"></a>Boosting 策略要解决的两个基本问题</h5><ol>
<li>每一轮如何改变数据的权值或概率分布？</li>
<li>如何将弱分类器组合成一个强分类器？</li>
</ol>
<ul>
<li>基于<strong>串行策略</strong>：基学习器之间存在依赖关系，新的学习器需要根据上一个学习器生成。</li>
<li>基本思路：<ul>
<li>先从<strong>初始训练集</strong>训练一个基学习器；初始训练集中各样本的权重是相同的；</li>
<li>根据上一个基学习器的表现，<strong>调整样本权重</strong>，使分类错误的样本得到更多的关注；</li>
<li>基于调整后的样本分布，训练下一个基学习器；</li>
<li>测试时，对各基学习器<strong>加权</strong>得到最终结果</li>
</ul>
</li>
</ul>
<h5 id="AdaBoost-算法"><a href="#AdaBoost-算法" class="headerlink" title="AdaBoost 算法"></a>AdaBoost 算法</h5><ul>
<li>AdaBoost 是 Boosting 策略的一种具体算法</li>
</ul>
<p><strong>AdaBoost 算法解决 Boosting 两个基本问题的方法</strong></p>
<ol>
<li>每一轮如何改变数据的权值或概率分布？——开始时，每个样本的权值是一样的，AdaBoost 的做法是提高上一轮弱分类器错误分类样本的权值，同时降低那些被正确分类样本的权值。</li>
<li>如何将弱分类器组合成一个强分类器？—— AdaBoost 采取加权表决的方法（<a href="https://github.com/imhuay/Algorithm_Interview_Notes-Chinese/blob/master/A-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/A-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95.md#%E5%8A%A0%E6%B3%95%E6%A8%A1%E5%9E%8B">加法模型</a>）。具体的，AdaBoost 会加大分类误差率小的基学习器的权值，使其在表决中起到更大的作用，同时减小分类误差率大的基学习器的权值。</li>
</ol>
<h5 id="AdaBoost-算法描述"><a href="#AdaBoost-算法描述" class="headerlink" title="AdaBoost 算法描述"></a>AdaBoost 算法描述</h5><ul>
<li>输入：训练集 <code>T=&#123;(x1,y1),..,(xN,yN)&#125;, xi ∈ R^n, yi ∈ &#123;-1,+1&#125;</code>，基学习器 <code>G1(x)</code></li>
<li>输出：最终学习器 <code>G(x)</code></li>
</ul>
<ol>
<li>初始化训练数据的权值分布</li>
</ol>
<p>$$<br>D_{1}&#x3D;\left(w_{1,1}, \cdots, w_{1, i}, \cdots, w_{1, N}\right), \quad w_{1, i}&#x3D;\frac{1}{N}, \quad i&#x3D;1,2, \cdots, N<br>$$</p>
<ol start="2">
<li><p>对 <code>m=1,2,..,M</code></p>
<p>i. 使用权值分布为<code>D_m</code>的训练集，得到基分类器：<br>$$<br>G_{m}(x) : \chi \rightarrow{-1,+1}<br>$$<br>ii. 计算 <code>G_m(x)</code> 在训练集上的分类误差率<br>$$<br>\begin{aligned} e_{m} &amp;&#x3D;P\left(G_{m}\left(x_{i}\right) \neq y_{i}\right) \ &amp;&#x3D;\sum_{i&#x3D;1}^{N} w_{m, i} \cdot I\left(G_{m}\left(x_{i}\right) \neq y_{i}\right) \end{aligned}<br>$$</p>
</li>
</ol>
<blockquote>
<p>I(x)<code> 为指示函数：若</code>G(x)!&#x3D;y<code>为真，则</code>I(G(x)!&#x3D;y)&#x3D;1<code>，反之为 </code>0</p>
<p>实际上分类误差率就等于所有<strong>分类错误的数据的权值之和</strong></p>
</blockquote>
<p>​	iii. 计算 <code>G_m(x)</code> 的系数<br>$$<br>\alpha_{m}&#x3D;\frac{1}{2} \ln \frac{1-e_{m}}{e_{m}}<br>$$<br>​	iv. 更新训练街的权值分布<br>$$<br>\begin{aligned} D_{m+1} &amp;&#x3D;\left(w_{m+1,1}, \cdots, w_{m+1, i}, \cdots, w_{m+1, N}\right) \ w_{m+1, i} &amp;&#x3D;\frac{w_{m, i} \cdot \exp \left(-\alpha_{m} \cdot y_{i} G_{m}\left(x_{i}\right)\right)}{Z_{m}} \ Z_{m} &amp;&#x3D;\sum_{i&#x3D;1}^{N} w_{m, i} \cdot \exp \left(-\alpha_{m} \cdot y_{i} G_{m}\left(x_{i}\right)\right) \end{aligned}<br>$$<br>​	其中 <code>Z_m</code> 为<strong>规范化因子</strong>，使 <code>D_m+1</code> 成为一个<strong>概率分布</strong>，类似 <code>Softmax</code> 函数</p>
<p>​	因为 <code>y, G(x) ∈ &#123;-1, 1&#125;</code>，所以实际上<br>$$<br>y_{i} G_{m}\left(x_{i}\right)&#x3D;\left{\begin{array}{cl}{1,} &amp; {G_{m}\left(x_{i}\right)&#x3D;y_{i}} \ {-1,} &amp; {G_{m}\left(x_{i}\right) \neq y_{i}}\end{array}\right.<br>$$<br>​	因此 $w_{m+1,i}$ 也可以写作<br>$$<br>w_{m+1, i}&#x3D;\left{\begin{array}{ll}{\frac{w_{m, i}}{Z_{m}} e^{-\alpha_{m}},} &amp; {G_{m}\left(x_{i}\right)&#x3D;y_{i}} \ {\frac{w_{m, i}}{Z_{m}} e^{\alpha_{m}},} &amp; {G_{m}\left(x_{i}\right) \neq y_{i}}\end{array}\right.<br>$$</p>
<ol start="3">
<li><p>模型的更新算法：<br>$$<br>f_{k}(x)&#x3D;f_{k-1}(x)+\alpha_{k} G_{k}(x)<br>$$</p>
</li>
<li><p>构建基学习器的<strong>线性组合</strong></p>
</li>
</ol>
<p>$$<br>G(x)&#x3D;\operatorname{sign}\left(\sum_{m&#x3D;1}^{M} \alpha_{m} G_{m}(x)\right)<br>$$</p>
<h5 id="AdaBoost-算法要点说明"><a href="#AdaBoost-算法要点说明" class="headerlink" title="AdaBoost 算法要点说明"></a>AdaBoost 算法要点说明</h5><ul>
<li>开始时，训练集中所有数据具有均匀的权值分布</li>
<li>计算分类误差率，实际上就是计算所有分类错误的数据的权值之和</li>
<li><code>G_m(x)</code> 的系数 <code>α_m</code> 表示该学习器在最终学习器中的重要性；公式$\alpha_{m}&#x3D;\frac{1}{2} \ln \frac{1-e_{m}}{e_{m}}$表明当分类错误率 $e_m \le 1&#x2F;2$时，$α_m \ge 0$，并且 $α_m$ 随 $e_m$ 的减小而增大</li>
<li>被基分类器分类错误的样本权值会扩大，而分类正确的权值会缩小——<strong>不改变训练数据，而不断改变训练数据权值的分布，使训练数据在基学习器的学习中起到不同的作用</strong>，这是 AdaBoost 的一个特点。</li>
</ul>
<h5 id="梯度提升决策树-GBDT-Gradient-Boosting-Decision-Tree"><a href="#梯度提升决策树-GBDT-Gradient-Boosting-Decision-Tree" class="headerlink" title="梯度提升决策树 GBDT(Gradient Boosting Decision Tree)"></a>梯度提升决策树 GBDT(Gradient Boosting Decision Tree)</h5><ul>
<li>GBDT 是以<strong>决策树</strong>为基学习器、采用 Boosting 策略的一种集成学习模型</li>
<li><strong>与提升树的区别</strong>：残差的计算不同，提升树使用的是真正的残差，梯度提升树用当前模型的负梯度来拟合残差。</li>
</ul>
<h6 id="提升树"><a href="#提升树" class="headerlink" title="提升树"></a>提升树</h6><ul>
<li>以<strong>决策树</strong>为基学习器，对分类问题使用二叉分类树，回归问题使用二叉回归树。</li>
<li>解决回归问题时，通过不断拟合残差得到新的树。</li>
</ul>
<ul>
<li>提升树模型可表示为<strong>决策树的加法模型</strong>：<br>$$<br>f_{M}(x)&#x3D;\sum_{m&#x3D;1}^{M} T\left(x ; \Theta_{m}\right)<br>$$</li>
</ul>
<ul>
<li>首先初始化提升树 <code>f_0(x)=0</code>，则第 m 步的模型为</li>
</ul>
<p>$$<br>f_{m}(x)&#x3D;f_{m-1}(x)+T\left(x ; \Theta_{m}\right)<br>$$</p>
<ul>
<li>然后通过最小化损失函数决定下一个决策树的参数<br>$$<br>\hat{\Theta}<em>{m}&#x3D;\arg \min <em>{\Theta</em>{m}} \sum</em>{i&#x3D;1}^{N} L\left(y_{i}, f_{m-1}\left(x_{i}\right)+T\left(x_{i} ; \Theta_{m}\right)\right)<br>$$</li>
</ul>
<ul>
<li>对于二分类问题，提升树算法只需要将AdaBoost 算法中的基学习器限制为二叉分类树即可</li>
</ul>
<h6 id="提升树算法描述"><a href="#提升树算法描述" class="headerlink" title="提升树算法描述"></a>提升树算法描述</h6><p>在回归问题中，新的树是通过不断拟合<strong>残差</strong>（residual）得到的。</p>
<ul>
<li>输入：训练集 <code>T=&#123;(x1,y1),..,(xN,yN)&#125;, xi ∈ R^n, yi ∈ R</code></li>
<li>输出：回归提升树 <code>f_M(x)</code></li>
</ul>
<ol>
<li><p>初始化 <code>f_0(x)=0</code></p>
</li>
<li><p>对 <code>m=1,2,..,M</code></p>
<p>i.计算<strong>残差</strong><br>$$<br>r_{m, i}&#x3D;y_{i}-f_{m-1}\left(x_{i}\right), \quad i&#x3D;1,2, \dots, N<br>$$<br><strong>ii.拟合残差</strong>学习下一个回归树的参数<br>$$<br>\hat{\Theta}<em>{m}&#x3D;\arg \min <em>{\Theta</em>{m}} \sum</em>{i&#x3D;1}^{N} L\left(r_{m, i}, T\left(x_{i} ; \Theta_{m}\right)\right)<br>$$<br>iii. 更新 <code>f_m(x)</code></p>
</li>
</ol>
<p>$$<br>f_{m}(x)&#x3D;f_{m-1}(x)+T\left(x ; \Theta_{m}\right)<br>$$</p>
<p>​	iv. 得到回归提升树<br>$$<br>f_{M}(x)&#x3D;\sum_{m&#x3D;1}^{M} T\left(x ; \Theta_{m}\right)<br>$$</p>
<h4 id="2-Bagging"><a href="#2-Bagging" class="headerlink" title="2. Bagging"></a>2. Bagging</h4><ul>
<li><p>基于<strong>并行策略</strong>：基学习器之间不存在依赖关系，可同时生成。</p>
</li>
<li><p><strong>基本思路</strong>：</p>
<ul>
<li><p>利用<strong>自助采样法</strong>对训练集随机采样，重复进行 <code>T</code> 次;</p>
</li>
<li><p>基于每个采样集训练一个基学习器，并得到 <code>T</code> 个基学习器；</p>
</li>
<li><p>预测时，集体<strong>投票决策</strong>。</p>
</li>
<li><p>训练每个基学习器时只使用一部分样本；</p>
<blockquote>
<p>偏好不稳定的学习器作为基学习器；</p>
<p>所谓不稳定的学习器，指的是对<strong>样本分布</strong>较为敏感的学习器。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>代表算法&#x2F;模型:</p>
<ul>
<li><a href="https://github.com/imhuay/Algorithm_Interview_Notes-Chinese/blob/master/A-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/A-%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E7%AE%97%E6%B3%95.md#%E9%9A%8F%E6%9C%BA%E6%A3%AE%E6%9E%97">随机森林</a></li>
<li>神经网络的 <strong>Dropout</strong> 策略</li>
</ul>
</li>
</ul>
<h4 id="3-Stacking"><a href="#3-Stacking" class="headerlink" title="3. Stacking"></a>3. Stacking</h4><h4 id="Stacking-方法"><a href="#Stacking-方法" class="headerlink" title="Stacking 方法"></a>Stacking 方法</h4><ul>
<li>基于<strong>串行策略</strong>：初级学习器与次级学习器之间存在依赖关系，初学习器的输出作为次级学习器的输入。</li>
<li>基本思路：<ul>
<li>先从初始训练集训练 <code>T</code> 个<strong>不同的初级学习器</strong>;</li>
<li>利用每个初级学习器的<strong>输出</strong>构建一个<strong>次级数据集</strong>，该数据集依然使用初始数据集的标签；</li>
<li>根据新的数据集训练<strong>次级学习器</strong>；</li>
<li><strong>多级学习器</strong>的构建过程类似。</li>
</ul>
</li>
</ul>
<h4 id="集成学习常见问题"><a href="#集成学习常见问题" class="headerlink" title="集成学习常见问题"></a>集成学习常见问题</h4><p><strong>1. 使用决策树作为基学习器的原因：</strong></p>
<blockquote>
<p>(1). 决策树的表达能力和泛化能力，可以通过剪枝快速调整；<br>(2). 决策树可以方便地将<strong>样本的权重</strong>整合到训练过程中；<br>(3). 决策树是一种<strong>不稳定</strong>的学习器；<br>  所谓不稳定，指的是数据样本的扰动会对决策树的结果产生较大的影响；</p>
</blockquote>
<ul>
<li>后两点分别适合 Boosting 策略和 Bagging 策略；所以它们一般都使用决策树作为基学习器。</li>
</ul>
<p><strong>2. 为什么不稳定的学习器更适合作为基学习器？</strong></p>
<ul>
<li>不稳定的学习器容易受到<strong>样本分布</strong>的影响（方差大），很好的引入了<strong>随机性</strong>；这有助于在集成学习（特别是采用 <strong>Bagging</strong>策略）中提升模型的<strong>泛化能力</strong>。</li>
<li>为了更好的引入随机性，有时会随机选择一个<strong>属性子集</strong>中的最优分裂属性，而不是全局最优（<strong>随机森林</strong>）</li>
</ul>
<p><strong>3. 还有哪些模型也适合作为基学习器？</strong></p>
<ul>
<li>神经网络<ul>
<li>神经网络也属于<strong>不稳定</strong>的学习器；</li>
<li>此外，通过调整神经元的数量、网络层数，连接方式初始权重也能很好的引入随机性和改变模型的表达能力和泛化能力。</li>
</ul>
</li>
</ul>
<p><strong>4. Bagging 方法中能使用线性分类器作为基学习器吗？ Boosting 呢？</strong></p>
<ul>
<li>Bagging 方法中<strong>不推荐</strong><ul>
<li>线性分类器都属于稳定的学习器（方差小），对数据不敏感；</li>
<li>甚至可能因为 Bagging 的采样，导致在训练中难以收敛，增大集成分类器的<strong>偏差</strong></li>
</ul>
</li>
<li>Boosting 方法中<strong>可以使用</strong><ul>
<li>Boosting 方法主要通过降低<strong>偏差</strong>的方式来提升模型的性能，而线性分类器本身具有方差小的特点，所以两者有一定相性</li>
<li>XGBoost 中就支持以线性分类器作为基学习器。</li>
</ul>
</li>
</ul>
<p><strong>5. Boosting&#x2F;Bagging 与 偏差&#x2F;方差 的关系</strong></p>
<ul>
<li>简单来说，<strong>Boosting</strong> 能提升弱分类器性能的原因是降低了<strong>偏差</strong>；<strong>Bagging</strong> 则是降低了<strong>方差</strong>；</li>
<li>Boosting方法：<ul>
<li>Boosting 的<strong>基本思路</strong>就是在不断减小模型的<strong>训练误差</strong>（拟合残差或者加大错类的权重），加强模型的学习能力，从而减小偏差；</li>
<li>但 Boosting 不会显著降低方差，因为其训练过程中各基学习器是强相关的，缺少独立性。</li>
</ul>
</li>
<li>Bagging方法：<ul>
<li>对 <code>n</code> 个<strong>独立不相关的模型</strong>预测结果取平均，方差是原来的 <code>1/n</code>；</li>
<li>假设所有基分类器出错的概率是独立的，<strong>超过半数</strong>基分类器出错的概率会随着基分类器的数量增加而下降。</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>机器学习</category>
        <category>深度学习</category>
      </categories>
      <tags>
        <tag>机器学习</tag>
        <tag>深度学习</tag>
      </tags>
  </entry>
  <entry>
    <title>用python控制同步hexo脚本</title>
    <url>/2017/08/10/%E7%94%A8python%E6%8E%A7%E5%88%B6%E5%90%8C%E6%AD%A5hexo%E8%84%9A%E6%9C%AC/</url>
    <content><![CDATA[<p>之前一直在windows下面写hexo博客，但是每次同步需要运行一大堆指令，于是想到用python 写一个脚本来自动同步，用到了os.chdir，因为直接<code>os.system(&#39;cd xxx&#39;)</code>会自动返回当前路径。</p>
<span id="more"></span>

<p>具体程序如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># @Time    : 2017/8/10 19:42</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.chdir((u<span class="string">r&#x27;E:\项目\blog&#x27;</span>))</span><br><span class="line">os.system(<span class="string">&#x27;hexo d \-g&#x27;</span>)</span><br><span class="line">os.system(u<span class="string">r&#x27;git add .&#x27;</span>)</span><br><span class="line">os.system(<span class="string">&quot;git commit -m &#x27;Updated&#x27;&quot;</span>)</span><br><span class="line">os.system(<span class="string">&#x27;git push origin source&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span> <span class="string">&#x27;done&#x27;</span></span><br></pre></td></tr></table></figure>

<p>然后将启动这个命令设置为简短的命令，类似于alias</p>
<p>Run the below command in a command prompt to alias <strong>ls <strong>to run the command <strong>dir</strong>. The <strong>$*</strong> on the end are required so that any additional arguments are also passed to the <strong>dir</strong> command.</strong></strong></p>
<ol>
<li><code>doskey ls=dir $* </code></li>
</ol>
<p>The problem with this is that all of your alias commands will be lost when you close the cmd session. To make them persist we need to create a batch file and add the entry to the windows registry.</p>
<p>Create a new folder in the windows directory called <strong>bin</strong> and create a new batch file inside it.</p>
<ol start="2">
<li><code>C:\&gt;mkdir c:\windows\binC:\&gt;notepad.exe c:\windows\bin\doskey.bat </code></li>
</ol>
<p>Add your entries to the batch file in the below format.</p>
<ol start="3">
<li><code>@echo offdoskey ls=dir $*doskey mv=move $*doskey cp=copy $*doskey cat=type $* </code></li>
</ol>
<p>Next, open up <strong>regedit.exe</strong> and add an entry to the batch file to make the doskey commands permanent for each cmd session.</p>
<ol start="4">
<li><code>HKEY_CURRENT_USER\Software\Microsoft\Command Processor</code></li>
</ol>
<p>Add a new <strong>String Value</strong> called <strong>AutoRun</strong> and set the absolute path in the value of <strong>c:\windows\bin\doskey.bat</strong>.****</p>
<p>The <strong>doskey.bat</strong> file will now be executed before opening a new cmd session which will set all of your alias ready for you to use.</p>
<h3 id="用sh脚本控制"><a href="#用sh脚本控制" class="headerlink" title="用sh脚本控制"></a>用sh脚本控制</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line">git add .</span><br><span class="line">current_date_time=`date &quot;+%Y-%m-%d %H:%M:%S&quot;`</span><br><span class="line">git commit -m &quot;Content updated：$current_date_time&quot;</span><br><span class="line">git push origin source</span><br><span class="line">hexo d -g</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>编程练习</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络知识总结</title>
    <url>/2018/03/09/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E7%9F%A5%E8%AF%86%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h2 id="TCP-x2F-IP"><a href="#TCP-x2F-IP" class="headerlink" title="TCP&#x2F;IP"></a>TCP&#x2F;IP</h2><h3 id="1-说一下OSI七层模型-TCP-x2F-IP四层模型-五层协议"><a href="#1-说一下OSI七层模型-TCP-x2F-IP四层模型-五层协议" class="headerlink" title="1. 说一下OSI七层模型 TCP&#x2F;IP四层模型 五层协议"></a>1. 说一下OSI七层模型 TCP&#x2F;IP四层模型 五层协议</h3><span id="more"></span>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190309100647.png"></p>
<p>七层模型：应表会传网数物</p>
<p>五层模型：应传网数物</p>
<h4 id="1）五层协议"><a href="#1）五层协议" class="headerlink" title="1）五层协议"></a>1）五层协议</h4><ul>
<li><strong>应用层</strong> ：提供用户接口，特指能够发起网络流量的程序</li>
<li><strong>传输层</strong>：提供的是进程间的通用数据传输服务。由于应用层协议很多，定义通用的传输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：<ul>
<li>传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；</li>
<li>用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。</li>
<li>TCP 主要提供完整性服务，UDP 主要提供及时性服务。</li>
</ul>
</li>
<li><strong>网络层</strong>：为主机间提供数据传输服务，而运输层协议是为主机中的进程提供服务。网络层把传输层传递下来的报文段或者用户数据报封装成分组。（负责选择最佳路径 规划IP地址）<ul>
<li>路由器查看数据包目标IP地址，根据路由表为数据包选择路径。路由表中的类目可以人工添加（静态路由）也可以动态生成（动态路由）。</li>
</ul>
</li>
<li><strong>数据链路层</strong>：不同的网络类型，发送数据的机制不同，数据链路层就是将数据包封装成能够在不同的网络传输的帧。能够进行差错检验，但不纠错，监测处错误丢掉该帧。<ul>
<li>帧的开始和结束，透明传输，差错校验</li>
</ul>
</li>
<li><strong>物理层</strong>：物理层解决如何在连接各种计算机的传输媒体上传输数据比特流，而不是指具体的传输媒体。</li>
</ul>
<h4 id="2）ISO七层模型中表示层和会话层功能是什么？"><a href="#2）ISO七层模型中表示层和会话层功能是什么？" class="headerlink" title="2）ISO七层模型中表示层和会话层功能是什么？"></a>2）ISO七层模型中表示层和会话层功能是什么？</h4><ul>
<li><strong>表示层</strong> ：数据压缩、加密以及数据描述。这使得应用程序不必担心在各台主机中表示&#x2F;存储的内部格式（二进制、ASCII，比如乱码）不同的问题。</li>
<li><strong>会话层</strong> ：建立会话，如session认证、断点续传。通信的应用程序之间建立、维护和释放面向用户的连接。通信的应用程序之间建立会话，需要传输层建立1个或多个连接。（…后台运行的木马，netstat -n）</li>
</ul>
<h4 id="3）数据在各层之间的传递过程"><a href="#3）数据在各层之间的传递过程" class="headerlink" title="3）数据在各层之间的传递过程"></a>3）数据在各层之间的传递过程</h4><p>　　在向下的过程中，需要添加下层协议所需要的首部或者尾部，而在向上的过程中不断拆开首部和尾部。</p>
<ol>
<li>路由器只有下面三层协议，因为路由器位于网络核心中，不需要为进程或者应用程序提供服务，因此也就不需要运输层和应用层。</li>
<li>交换机只有下面两层协议</li>
</ol>
<h4 id="4）TCP-x2F-IP四层模型"><a href="#4）TCP-x2F-IP四层模型" class="headerlink" title="4）TCP&#x2F;IP四层模型"></a>4）TCP&#x2F;IP四层模型</h4><p>它只有四层，相当于五层协议中<strong>数据链路层和物理层合并为网络接口层</strong>。</p>
<p>现在的 TCP&#x2F;IP 体系结构不严格遵循 OSI 分层概念，应用层可能会直接使用 IP 层或者网络接口层。</p>
<h3 id="2-TCP报头格式和UDP报头格式"><a href="#2-TCP报头格式和UDP报头格式" class="headerlink" title="2. TCP报头格式和UDP报头格式"></a>2. TCP报头格式和UDP报头格式</h3><p>网络层只把分组发送到目的主机，但是真正通信的并不是主机而是主机中的进程。运输层提供了进程间的逻辑通信，运输层向高层用户屏蔽了下面网络层的核心细节，使应用程序看起来像是在两个运输层实体之间有一条端到端的逻辑通信信道。</p>
<h4 id="（1）UDP-和-TCP-的特点"><a href="#（1）UDP-和-TCP-的特点" class="headerlink" title="（1）UDP 和 TCP 的特点"></a>（1）UDP 和 TCP 的特点</h4><ul>
<li><strong>用户数据报协议 UDP</strong>（User Datagram Protocol）是无连接的，尽最大可能交付，没有拥塞控制，面向报文（对于应用程序传下来的报文不合并也不拆分，只是添加 UDP 首部），支持一对一、一对多、多对一和多对多的交互通信。例如：视频传输、实时通信</li>
<li><strong>传输控制协议 TCP</strong>（Transmission Control Protocol）是面向连接的，提供可靠交付，有流量控制，拥塞控制，提供全双工通信，面向字节流（把应用层传下来的报文看成字节流，把字节流组织成大小不等的数据块），每一条 TCP 连接只能是点对点的（一对一）。</li>
</ul>
<h4 id="（2）UDP-首部格式"><a href="#（2）UDP-首部格式" class="headerlink" title="（2）UDP 首部格式"></a>（2）UDP 首部格式</h4><p>​	首部字段只有 8 个字节，包括源端口、目的端口、长度、检验和。</p>
<h4 id="（3）TCP-首部格式"><a href="#（3）TCP-首部格式" class="headerlink" title="（3）TCP 首部格式"></a>（3）TCP 首部格式</h4><ul>
<li><strong>序号 seq</strong> ：用于对字节流进行编号，例如序号为 301，表示第一个字节的编号为 301，如果携带的数据长度为 100 字节，那么下一个报文段的序号应为 401。[301,400]为序号301的数据长度，下一个则为401</li>
<li><strong>确认号 ack</strong> ：期望收到的下一个报文段的序号。例如 B 正确收到 A 发送来的一个报文段，序号为 501，携带的数据长度为 200 字节，因此 B 期望下一个报文段的序号为 701，B 发送给 A 的确认报文段中确认号就为 701。</li>
<li><strong>数据偏移</strong> ：指的是数据部分距离报文段起始处的偏移量，实际上指的是首部的长度。</li>
<li><strong>确认 ACK</strong> ：当 ACK&#x3D;1 时确认号字段有效，否则无效。TCP 规定，在连接建立后所有传送的报文段都必须把 ACK 置 1。</li>
<li><strong>同步 SYN</strong> ：在连接建立时用来同步序号。当 SYN&#x3D;1，ACK&#x3D;0 时表示这是一个连接请求报文段。若对方同意建立连接，则响应报文中 SYN&#x3D;1，ACK&#x3D;1。</li>
<li><strong>终止 FIN</strong> ：用来释放一个连接，当 FIN&#x3D;1 时，表示此报文段的发送方的数据已发送完毕，并要求释放连接。</li>
<li><strong>窗口</strong> ：窗口值作为接收方让发送方设置其发送窗口的依据。之所以要有这个限制，是因为接收方的数据缓存空间是有限的。</li>
</ul>
<h3 id="3-TCP三次握手？那四次挥手呢？如何保障可靠传输"><a href="#3-TCP三次握手？那四次挥手呢？如何保障可靠传输" class="headerlink" title="3. TCP三次握手？那四次挥手呢？如何保障可靠传输"></a>3. TCP三次握手？那四次挥手呢？如何保障可靠传输</h3><h4 id="（1）三次握手"><a href="#（1）三次握手" class="headerlink" title="（1）三次握手"></a>（1）三次握手</h4><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190309102820.png"></p>
<p><strong>假设 A 为客户端，B 为服务器端。</strong></p>
<ul>
<li>首先 B 处于 LISTEN（监听）状态，等待客户的连接请求。</li>
<li>A 向 B 发送连接请求报文段，SYN&#x3D;1，ACK&#x3D;0，选择一个初始的序号 seq &#x3D; x。</li>
<li>B 收到连接请求报文段，如果同意建立连接，则向 A 发送连接确认报文段，SYN&#x3D;1，ACK&#x3D;1，确认号为 x+1，同时也选择一个初始的序号 seq &#x3D; y。</li>
<li>A 收到 B 的连接确认报文段后，还要向 B 发出确认，确认号为 ack &#x3D; y+1，序号为 seq &#x3D; x+1。</li>
<li>A 的 TCP 通知上层应用进程，连接已经建立。</li>
<li>B 收到 A 的确认后，连接建立。</li>
<li>B 的 TCP 收到主机 A 的确认后，也通知其上层应用进程：TCP 连接已经建立。</li>
</ul>
<p><strong>三次握手对应的socket编程函数</strong></p>
<p>1.客户端调用connect()函数，此时客户端会向服务端发送SYN</p>
<p>2.服务端收到SYN后，会从listen()函数返回SYN+ACK</p>
<p>3.客户端收到connect()函数的返回，之后向服务端发送最后一个ACK</p>
<p>4.服务端收到最后一个ACK以后，将该连接请求从未完成连接队列放入已完成连接队列中，等待accept()从该队列中取出</p>
<h4 id="（2）为什么TCP连接需要三次握手，两次不可以吗，为什么"><a href="#（2）为什么TCP连接需要三次握手，两次不可以吗，为什么" class="headerlink" title="（2）为什么TCP连接需要三次握手，两次不可以吗，为什么"></a>（2）为什么TCP连接需要三次握手，两次不可以吗，为什么</h4><p><strong>为了防止已失效的连接请求报文段突然又传送到了服务端，占用服务器资源。 （假设主机A为客户端，主机B为服务器端）</strong></p>
<p>现假定出现一种异常情况，即A发出的第一个连接请求报文段并没有丢失，而是在某些网络节点长时间滞留了，以致延误到连接释放以后的某个时间才到B。本来这是一个已失效的报文段。但是B收到此失效的连接请求报文段后，就误认为是A有发出一次新的连接请求。于是就向A发出确认报文段，同意建立连接。假定不采用三次握手，那么只要B发出确认，新的连接就建立了。</p>
<p>由于现在A并没有发出建立连接的请求，因此不会理睬B的确认，也不会向B发送数据。但B却以为新的运输连接已经建立了，并一直等待A发来数据。B的许多资源就这样白白浪费了。</p>
<p>采用三次握手的办法可以防止上述现象的发生。例如在刚才的情况下，A不会向B的确认发出确认。B由于收不到确认，就知道A并没有要求建立连接。</p>
<h4 id="（3）四次挥手"><a href="#（3）四次挥手" class="headerlink" title="（3）四次挥手"></a>（3）四次挥手</h4><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190309103537.png"></p>
<p>总结：</p>
<ol>
<li>客户端向服务端发起FIN&#x3D;1，序号为u</li>
<li>服务端回复确认号ack&#x3D;u+1，报文自己的序列号为v，客户端到服务端的连接就关闭了</li>
<li>服务端向客户端发送FIN信号</li>
<li>客户端接收到之后，等待两个Maximum Segment Lifetime（一般是2个30s，1min或2min），释放链接，回复确认信号</li>
<li>服务端收到确认信号后关闭连接</li>
</ol>
<p>数据传输结束后，通信的双方都可释放连接。现在 A 的应用进程先向其 TCP 发出连接释放报文段，并停止再发送数据，主动关闭 TCP连接。</p>
<ul>
<li>A 把连接释放报文段首部的 FIN &#x3D; 1，其序号 seq &#x3D; u，等待 B 的确认。</li>
<li>B 发出确认，确认号 ack &#x3D; u+1，而这个报文段自己的序号 seq &#x3D; v。（TCP 服务器进程通知高层应用进程）</li>
<li>从 A 到 B 这个方向的连接就释放了，TCP 连接处于半关闭状态。A 不能向 B 发送数据；B 若发送数据，A 仍要接收。</li>
<li>当 B 不再需要连接时，发送连接释放请求报文段，FIN&#x3D;1。</li>
<li>A 收到后发出确认，进入 TIME-WAIT 状态，等待 2 MSL（2*2 &#x3D; 4 mins）时间后释放连接。</li>
<li>B 收到 A 的确认后释放连接。</li>
</ul>
<h4 id="（4）四次挥手的原因"><a href="#（4）四次挥手的原因" class="headerlink" title="（4）四次挥手的原因"></a>（4）四次挥手的原因</h4><p>客户端发送了 FIN 连接释放报文之后，服务器收到了这个报文，就进入了 CLOSE-WAIT 状态。这个状态是为了让服务器端发送还未传送完毕的数据，传送完毕之后，服务器会发送 FIN 连接释放报文。</p>
<h4 id="（5）TIME-WAIT"><a href="#（5）TIME-WAIT" class="headerlink" title="（5）TIME_WAIT"></a>（5）TIME_WAIT</h4><blockquote>
<p>MSL是Maximum Segment Lifetime英文的缩写，中文可以译为 “报文最大生存时间”，他是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。2MSL &#x3D; 2*2mins &#x3D; 4mins</p>
</blockquote>
<p>客户端接收到服务器端的 FIN 报文后进入此状态，此时并不是直接进入 CLOSED 状态，还需要等待一个时间计时器设置的时间 2MSL。这么做有两个理由：</p>
<ul>
<li>确保最后一个确认报文段能够到达。如果 B 没收到 A 发送来的确认报文段，那么就会重新发送连接释放请求报文段，A 等待一段时间就是为了处理这种情况的发生。</li>
<li>等待一段时间是为了让本连接持续时间内所产生的所有报文段都从网络中消失，使得下一个新的连接不会出现旧的连接请求报文段。</li>
</ul>
<p>避免time_wait：SO_REUSEADDR设置为1，强制进程立即使用处于TIME_WAIT状态连接占用的端口</p>
<h4 id="（6）如何保证可靠传输"><a href="#（6）如何保证可靠传输" class="headerlink" title="（6）如何保证可靠传输"></a>（6）如何保证可靠传输</h4><ul>
<li>应用数据被分割成TCP认为最适合发送的数据块。 </li>
<li><strong>超时重传</strong>：当TCP发出一个段后，它启动一个定时器，等待目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。</li>
<li>TCP给发送的每一个包进行编号，接收方对数据包进行排序，把有序数据传送给应用层。 </li>
<li><strong>校验和</strong>：TCP将保持它首部和数据的检验和。这是一个端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP将丢弃这个报文段和不确认收到此报文段。</li>
<li>TCP的接收端会丢弃重复的数据。</li>
<li><strong>流量控制</strong>：TCP连接的每一方都有固定大小的缓冲空间，TCP的接收端只允许发送端发送接收端缓冲区能接纳的数据。当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。TCP使用的流量控制协议是可变大小的滑动窗口协议。</li>
<li><strong>拥塞控制</strong>：当网络拥塞时，减少数据的发送。</li>
</ul>
<h4 id="（7）TCP和HTTP"><a href="#（7）TCP和HTTP" class="headerlink" title="（7）TCP和HTTP"></a>（7）TCP和HTTP</h4><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190309104421.png"></p>
<h3 id="5-TCP和UDP区别？如何改进TCP"><a href="#5-TCP和UDP区别？如何改进TCP" class="headerlink" title="5. TCP和UDP区别？如何改进TCP"></a>5. TCP和UDP区别？如何改进TCP</h3><ul>
<li><p>TCP和UDP区别</p>
<ul>
<li><p>UDP 是无连接的，即发送数据之前不需要建立连接。</p>
</li>
<li><p>UDP 使用尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制。</p>
</li>
<li><p>UDP 是面向用户数据报的。UDP 没有拥塞控制，很适合多媒体通信的要求。</p>
</li>
<li><p>UDP 支持一对一、一对多、多对一和多对多的交互通信。</p>
</li>
<li><p>UDP 的首部开销小，只有 8 个字节。</p>
</li>
<li><p>TCP 是面向连接的运输层协议。</p>
</li>
<li><p>每一条 TCP 连接只能有两个端点(endpoint)，每一条 TCP 连接只能是点对点的（一对一）。</p>
</li>
<li><p>TCP 提供可靠交付的服务。</p>
</li>
<li><p>TCP 提供全双工通信。</p>
</li>
<li><p>TCP是面向字节流。  </p>
</li>
<li><p>首部最低20个字节。</p>
</li>
</ul>
</li>
<li><p>TCP加快传输效率的方法</p>
<ul>
<li>采取一块确认的机制</li>
</ul>
</li>
</ul>
<h3 id="6-TCP滑动窗口"><a href="#6-TCP滑动窗口" class="headerlink" title="6. TCP滑动窗口"></a>6. TCP滑动窗口</h3><p>窗口是缓存的一部分，用来暂时存放字节流。发送方和接收方各有一个窗口，<strong>接收方通过 TCP 报文段中的窗口字段告诉发送方自己的窗口大小，发送方根据这个值和其它信息设置自己的窗口大小</strong>。</p>
<p>发送窗口内的字节都允许被发送，接收窗口内的字节都允许被接收。如果发送窗口左部的字节已经发送并且收到了确认，那么就将发送窗口向右滑动一定距离，直到左部第一个字节不是已发送并且已确认的状态；接收窗口的滑动类似，接收窗口左部字节已经发送确认并交付主机，就向右滑动接收窗口。</p>
<p>在 TCP 中，<strong>滑动窗口是为了实现流量控制</strong>。如果对方发送数据过快，接收方就来不及接收，接收方就需要通告对方，减慢数据的发送。</p>
<h3 id="7-TCP拥塞控制"><a href="#7-TCP拥塞控制" class="headerlink" title="7. TCP拥塞控制"></a>7. TCP拥塞控制</h3><p>流量控制是为了控制发送方发送速率，保证接收方来得及接收。</p>
<p>接收方发送的确认报文中的窗口字段可以用来控制发送方窗口大小，从而影响发送方的发送速率。将窗口字段设置为 0，则发送方不能发送数据。</p>
<h4 id="（1）慢开始与拥塞避免"><a href="#（1）慢开始与拥塞避免" class="headerlink" title="（1）慢开始与拥塞避免"></a>（1）慢开始与拥塞避免</h4><p>　　发送的最初执行慢开始，令 cwnd&#x3D;1，发送方只能发送 1 个报文段；当收到确认后，将 cwnd 加倍，因此之后发送方能够发送的报文段数量为：2、4、8 …</p>
<p>　　注意到慢开始每个轮次都将 cwnd 加倍，这样会让 cwnd 增长速度非常快，从而使得发送方发送的速度增长速度过快，网络拥塞的可能也就更高。设置一个慢启动阈值 ssthresh，当 cwnd &gt;&#x3D; ssthresh 时，进入拥塞避免，每个轮次只将 cwnd 加 1。</p>
<p>　　如果出现了超时，则令 ssthresh &#x3D; cwnd&#x2F;2，然后重新执行慢开始。</p>
<h4 id="（2）快重传与快恢复"><a href="#（2）快重传与快恢复" class="headerlink" title="（2）快重传与快恢复"></a>（2）快重传与快恢复</h4><p>　　在接收方，要求每次接收到报文段都应该对最后一个已收到的有序报文段进行确认。例如已经接收到 M1 和 M2，此时收到 M4，应当发送对 M2 的确认。 </p>
<p>　　在发送方，如果收到三个重复确认，那么可以知道下一个报文段丢失，此时执行快重传，立即重传下一个报文段。例如收到三个 M2，则 M3 丢失，立即重传 M3。</p>
<p>　　在这种情况下，只是丢失个别报文段，而不是网络拥塞。因此执行快恢复，令 ssthresh &#x3D; cwnd&#x2F;2 ，cwnd &#x3D; ssthresh，注意到此时直接进入拥塞避免。慢开始和快恢复的快慢指的是 cwnd 的设定值，而不是 cwnd 的增长速率。慢开始 cwnd 设定为 1，而快恢复 cwnd 设定为 ssthresh。</p>
<h4 id="（3）发送窗口的上限值"><a href="#（3）发送窗口的上限值" class="headerlink" title="（3）发送窗口的上限值"></a>（3）发送窗口的上限值</h4><p>　　发送方的发送窗口的上限值应当取为接收方窗口 rwnd 和拥塞窗口 cwnd 这两个变量中较小的一个，即应按以下公式确定：</p>
<ul>
<li>发送窗口的上限值 &#x3D; Min {rwnd, cwnd}</li>
</ul>
<h3 id="9-如何区分流量控制和拥塞控制"><a href="#9-如何区分流量控制和拥塞控制" class="headerlink" title="9. 如何区分流量控制和拥塞控制"></a>9. 如何区分流量控制和拥塞控制</h3><ul>
<li>拥塞控制所要做的都有一个前提，就是网络能够承受现有的网络负荷。</li>
<li>拥塞控制是一个全局性的过程，涉及到所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。</li>
<li>流量控制往往指在给定的发送端和接收端之间的点对点通信量的控制。</li>
<li>流量控制所要做的就是抑制发送端发送数据的速率，以便使接收端来得及接收。</li>
<li>流量控制属于通信双方协商；拥塞控制涉及通信链路全局。</li>
<li>流量控制需要通信双方各维护一个发送窗、一个接收窗，对任意一方，接收窗大小由自身决定，发送窗大小由接收方响应的TCP报文段中窗口值确定；拥塞控制的拥塞窗口大小变化由试探性发送一定数据量数据探查网络状况后而自适应调整。</li>
<li>实际最终发送窗口 &#x3D; min{流控发送窗口，拥塞窗口}。</li>
</ul>
<h2 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h2><h3 id="1-HTTP状态"><a href="#1-HTTP状态" class="headerlink" title="1. HTTP状态"></a>1. HTTP状态</h3><p>服务器返回的 <strong>响应报文</strong> 中第一行为状态行，包含了状态码以及原因短语，用来告知客户端请求的结果。</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th>类别</th>
<th>原因短语</th>
</tr>
</thead>
<tbody><tr>
<td>1XX</td>
<td>Informational（信息性状态码）</td>
<td>接收的请求正在处理</td>
</tr>
<tr>
<td>2XX</td>
<td>Success（成功状态码）</td>
<td>请求正常处理完毕</td>
</tr>
<tr>
<td>3XX</td>
<td>Redirection（重定向状态码）</td>
<td>需要进行附加操作以完成请求</td>
</tr>
<tr>
<td>4XX</td>
<td>Client Error（客户端错误状态码）</td>
<td>服务器无法处理请求</td>
</tr>
<tr>
<td>5XX</td>
<td>Server Error（服务器错误状态码）</td>
<td>服务器处理请求出错</td>
</tr>
</tbody></table>
<h4 id="（1）1XX-信息"><a href="#（1）1XX-信息" class="headerlink" title="（1）1XX 信息"></a>（1）1XX 信息</h4><ul>
<li><strong>100 Continue</strong> ：表明到目前为止都很正常，客户端可以继续发送请求或者忽略这个响应。</li>
</ul>
<h4 id="（2）2XX-成功"><a href="#（2）2XX-成功" class="headerlink" title="（2）2XX 成功"></a>（2）2XX 成功</h4><ul>
<li><strong>200 OK</strong></li>
<li><strong>204 No Content</strong> ：请求已经成功处理，但是返回的响应报文不包含实体的主体部分。一般在只需要从客户端往服务器发送信息，而不需要返回数据时使用。</li>
<li><strong>206 Partial Content</strong> ：表示客户端进行了范围请求。响应报文包含由 Content-Range 指定范围的实体内容。</li>
</ul>
<h4 id="（3）3XX-重定向"><a href="#（3）3XX-重定向" class="headerlink" title="（3）3XX 重定向"></a>（3）3XX 重定向</h4><ul>
<li><strong>301 Moved Permanently</strong> ：永久性重定向</li>
<li><strong>302 Found</strong> ：临时性重定向</li>
<li><strong>303 See Other</strong> ：和 302 有着相同的功能，但是 303 明确要求客户端应该采用 GET 方法获取资源。</li>
<li>注：虽然 HTTP 协议规定 301、302 状态下重定向时不允许把 POST 方法改成 GET 方法，但是大多数浏览器都会在 301、302 和 303 状态下的重定向把 POST 方法改成 GET 方法。</li>
<li><strong>304 Not Modified</strong> ：如果请求报文首部包含一些条件，例如：If-Match，If-Modified-Since，If-None-Match，If-Range，If-Unmodified-Since，如果不满足条件，则服务器会返回 304 状态码。</li>
<li><strong>307 Temporary Redirect</strong> ：临时重定向，与 302 的含义类似，尽管302标准禁止post变化get，但实际使用时大家不遵守，但是 307 要求浏览器强制不会把重定向请求的 POST 方法改成 GET 方法。</li>
</ul>
<h4 id="（4）4XX-客户端错误"><a href="#（4）4XX-客户端错误" class="headerlink" title="（4）4XX 客户端错误"></a>（4）4XX 客户端错误</h4><ul>
<li><strong>400 Bad Request</strong> ：请求报文中存在语法错误。</li>
<li><strong>401 Unauthorized</strong> ：该状态码表示发送的请求需要有认证信息（BASIC 认证、DIGEST 认证）。如果之前已进行过一次请求，则表示用户认证失败。</li>
<li><strong>403 Forbidden</strong> ：请求被拒绝，服务器端没有必要给出拒绝的详细理由。</li>
<li><strong>404 Not Found</strong></li>
</ul>
<h4 id="（5）5XX-服务器错误"><a href="#（5）5XX-服务器错误" class="headerlink" title="（5）5XX 服务器错误"></a>（5）5XX 服务器错误</h4><ul>
<li><strong>500 Internal Server Error</strong> ：服务器正在执行请求时发生错误。</li>
<li><strong>503 Service Unavailable</strong> ：服务器暂时处于超负载或正在进行停机维护，现在无法处理请求。</li>
</ul>
<h3 id="5-GET和POST的区别？【阿里面经OneNote】"><a href="#5-GET和POST的区别？【阿里面经OneNote】" class="headerlink" title="5. GET和POST的区别？【阿里面经OneNote】"></a>5. GET和POST的区别？【阿里面经OneNote】</h3><blockquote>
<p>就下面的找几个点和面试官侃侃而谈即可，不可能全部都记得，想到什么讲什么吧</p>
</blockquote>
<ul>
<li>GET 被强制服务器支持</li>
<li>浏览器对URL的长度有限制，所以GET请求不能代替POST请求发送大量数据</li>
<li>GET请求发送数据更小</li>
<li>GET请求是不安全的</li>
<li>GET请求是幂等的<ul>
<li>幂等的意味着对同一URL的多个请求应该返回同样的结果</li>
</ul>
</li>
<li>POST请求不能被缓存</li>
<li>POST请求相对GET请求是「安全」的<ul>
<li>这里安全的含义仅仅是指是非修改信息</li>
</ul>
</li>
<li>GET用于信息获取，而且是安全的和幂等的<ul>
<li>所谓安全的意味着该操作用于获取信息而非修改信息。换句话说，GET 请求一般不应产生副作用。就是说，它仅仅是获取资源信息，就像数据库查询一样，不会修改，增加数据，不会影响资源的状态。</li>
</ul>
</li>
<li>POST是用于修改服务器上的资源的请求</li>
<li>发送包含未知字符的用户输入时，POST 比 GET 更稳定也更可靠</li>
</ul>
<h3 id="6-HTTP和HTTPS的区别【阿里面经OneNote】"><a href="#6-HTTP和HTTPS的区别【阿里面经OneNote】" class="headerlink" title="6. HTTP和HTTPS的区别【阿里面经OneNote】"></a>6. HTTP和HTTPS的区别【阿里面经OneNote】</h3><ul>
<li>http是HTTP协议运行在TCP之上。所有传输的内容都是明文，客户端和服务器端都无法验证对方的身份。</li>
<li>https是HTTP运行在SSL&#x2F;TLS之上，SSL&#x2F;TLS运行在TCP之上。所有传输的内容都经过加密，加密采用对称加密，但对称加密的密钥用服务器方的证书进行了非对称加密。此外客户端可以验证服务器端的身份，如果配置了客户端验证，服务器方也可以验证客户端的身份。</li>
<li>https协议需要到ca申请证书，一般免费证书很少，需要交费。</li>
<li>http是超文本传输协议，信息是明文传输，https 则是具有安全性的ssl加密传输协议</li>
<li>http和https使用的是完全不同的连接方式用的端口也不一样,前者是80,后者是443。</li>
<li>http的连接很简单,是无状态的</li>
<li>HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议 要比http协议安全</li>
</ul>
<h3 id="7-对称加密与非对称加密"><a href="#7-对称加密与非对称加密" class="headerlink" title="7.对称加密与非对称加密"></a>7.对称加密与非对称加密</h3><p><strong>对称加密：</strong>指的就是加、解密使用的同是一串密钥，所以被称做对称加密。对称加密只有一个密钥作为私钥。<br>常见的对称加密算法：DES，AES等。</p>
<p><strong>非对称加密：</strong>指的是加、解密使用不同的密钥，一把作为公开的公钥，另一把作为私钥。公钥加密的信息，只有私钥才能解密。反之，私钥加密的信息，只有公钥才能解密。 </p>
<p>举个例子，你向某公司服务器请求公钥，服务器将公钥发给你，你使用公钥对消息加密，那么只有私钥的持有人才能对你的消息解密。与对称加密不同的是，公司服务器不需要将私钥通过网络发送出去，因此安全性大大提高。<br>最常用的非对称加密算法：RSA</p>
<h3 id="8-ABC类地址和私有地址"><a href="#8-ABC类地址和私有地址" class="headerlink" title="8.ABC类地址和私有地址"></a>8.ABC类地址和私有地址</h3><p>A类：最前面是0，1.0.0.1-126.255.255.254</p>
<p>B类：最前面是10，128.1.0.1-191.255.255.254 </p>
<p>C类：最前面是110，192.0.1.1-223.255.255.254</p>
<p>D类：最前面是1110224.0.0.1-239.255.255.254</p>
<p>E类：是保留地址。该类IP地址的最前面为“1111”</p>
<p><strong>私有地址（内部局域网可以使用的）</strong></p>
<p>A级：10.0.0.0 - 10.255.255.255</p>
<p>B级：172.16.0.0 - 172.31.255.255</p>
<p>C级：192.168.0.0 - 192.168.255.255</p>
<p><strong>保留地址（特殊用途的）</strong></p>
<p>A类：127.X.X.X：本地循环测试</p>
<p>B类：169.254.X.X：当自动获取ip没有找到dhcp服务器的时候，分配一个169.254开头的地址</p>
<h2 id="Socket"><a href="#Socket" class="headerlink" title="Socket"></a>Socket</h2><p>###一、I&#x2F;O模型</p>
<h4 id="阻塞式I-x2F-O"><a href="#阻塞式I-x2F-O" class="headerlink" title="阻塞式I&#x2F;O"></a>阻塞式I&#x2F;O</h4><p>应用进程被阻塞，直到数据从内核缓冲区复制到应用进程缓冲区中才返回。</p>
<p>应该注意到，在阻塞的过程中，其它应用进程还可以执行，因此阻塞不意味着整个操作系统都被阻塞。因为其它应用进程还可以执行，所以不消耗 CPU 时间，这种模型的 CPU 利用率效率会比较高。</p>
<p>下图中，recvfrom() 用于接收 Socket 传来的数据，并复制到应用进程的缓冲区 buf 中。这里把 recvfrom() 当成系统调用。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">ssize_t</span> <span class="title function_">recvfrom</span><span class="params">(<span class="type">int</span> sockfd, <span class="type">void</span> *buf, <span class="type">size_t</span> len, <span class="type">int</span> flags, <span class="keyword">struct</span> sockaddr *src_addr, <span class="type">socklen_t</span> *addrlen)</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190324160716.png"></p>
<h4 id="非阻塞式-I-x2F-O"><a href="#非阻塞式-I-x2F-O" class="headerlink" title="非阻塞式 I&#x2F;O"></a>非阻塞式 I&#x2F;O</h4><p>应用进程执行系统调用之后，内核返回一个错误码。应用进程可以继续执行，但是需要不断的执行系统调用来获知 I&#x2F;O 是否完成，这种方式称为轮询（polling）。</p>
<p>由于 CPU 要处理更多的系统调用，因此这种模型的 CPU 利用率比较低。</p>
<p>![image-20190324160743975](&#x2F;Users&#x2F;apple&#x2F;Library&#x2F;Application Support&#x2F;typora-user-images&#x2F;image-20190324160743975.png)</p>
<h4 id="I-x2F-O-复用"><a href="#I-x2F-O-复用" class="headerlink" title="I&#x2F;O 复用"></a>I&#x2F;O 复用</h4><p>使用 select 或者 poll 等待数据，并且可以等待多个socket任何一个变为可读。这一过程会被阻塞，当某一个套接字可读时返回，之后再使用 recvfrom 把数据从内核复制到进程中。</p>
<blockquote>
<p>所以，I&#x2F;O 多路复用的特点是通过一种机制一个进程能同时等待多个文件描述符，而这些文件描述符（套接字描述符）其中的任意一个进入读就绪状态，select()函数就可以返回。</p>
</blockquote>
<p>它可以让单个进程具有处理多个 I&#x2F;O 事件的能力。又被称为 Event Driven I&#x2F;O，即事件驱动 I&#x2F;O。</p>
<p>如果一个 Web 服务器没有 I&#x2F;O 复用，那么每一个 Socket 连接都需要创建一个线程去处理。如果同时有几万个连接，那么就需要创建相同数量的线程。相比于多进程和多线程技术，I&#x2F;O 复用不需要进程线程创建和切换的开销，系统开销更小。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190324161153.png"></p>
<h4 id="信号驱动-I-x2F-O"><a href="#信号驱动-I-x2F-O" class="headerlink" title="信号驱动 I&#x2F;O"></a>信号驱动 I&#x2F;O</h4><p>应用进程使用 sigaction 系统调用，内核立即返回，应用进程可以继续执行，也就是说等待数据阶段应用进程是非阻塞的。内核在数据到达时向应用进程发送 SIGIO 信号，应用进程收到之后在信号处理程序中调用 recvfrom 将数据从内核复制到应用进程中。</p>
<p>相比于非阻塞式 I&#x2F;O 的轮询方式，信号驱动 I&#x2F;O 的 CPU 利用率更高。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190324161236.png"></p>
<h4 id="异步-I-x2F-O"><a href="#异步-I-x2F-O" class="headerlink" title="异步 I&#x2F;O"></a>异步 I&#x2F;O</h4><p>应用进程执行 aio_read 系统调用会立即返回，应用进程可以继续执行，不会被阻塞，内核会在所有操作完成之后向应用进程发送信号。</p>
<p>异步 I&#x2F;O 与信号驱动 I&#x2F;O 的区别在于，异步 I&#x2F;O 的信号是通知应用进程 I&#x2F;O 完成，而信号驱动 I&#x2F;O 的信号是通知应用进程可以开始 I&#x2F;O。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190324161503.png"></p>
<h4 id="五大-I-x2F-O-模型比较"><a href="#五大-I-x2F-O-模型比较" class="headerlink" title="五大 I&#x2F;O 模型比较"></a>五大 I&#x2F;O 模型比较</h4><ul>
<li>同步 I&#x2F;O：将数据从内核缓冲区复制到应用进程缓冲区的阶段，应用进程会阻塞。</li>
<li>异步 I&#x2F;O：不会阻塞。</li>
</ul>
<p>阻塞式 I&#x2F;O、非阻塞式 I&#x2F;O、I&#x2F;O 复用和信号驱动 I&#x2F;O 都是同步 I&#x2F;O，它们的主要区别在第一个阶段。</p>
<p>非阻塞式 I&#x2F;O 、信号驱动 I&#x2F;O 和异步 I&#x2F;O 在第一阶段不会阻塞。</p>
<h3 id="二、I-x2F-O-复用"><a href="#二、I-x2F-O-复用" class="headerlink" title="二、I&#x2F;O 复用"></a>二、I&#x2F;O 复用</h3><p>select&#x2F;poll&#x2F;epoll 都是 I&#x2F;O 多路复用的具体实现，select 出现的最早，之后是 poll，再是 epoll。</p>
<h4 id="select"><a href="#select" class="headerlink" title="select"></a>select</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">select</span><span class="params">(<span class="type">int</span> n, fd_set *readfds, fd_set *writefds, fd_set *exceptfds, <span class="keyword">struct</span> timeval *timeout)</span>;</span><br></pre></td></tr></table></figure>

<p>有三种类型的描述符类型：readset、writeset、exceptset，分别对应读、写、异常条件的描述符集合。fd_set 使用数组实现，数组大小使用 FD_SETSIZE 定义。</p>
<p>timeout 为超时参数，调用 select 会一直阻塞直到有描述符的事件到达或者等待的时间超过 timeout。</p>
<p>成功调用返回结果大于 0，出错返回结果为 -1，超时返回结果为 0。</p>
<h4 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">int poll(struct pollfd *fds, unsigned int nfds, int timeout);</span><br></pre></td></tr></table></figure>

<p>pollfd 使用链表实现。</p>
<h4 id="select和poll的比较"><a href="#select和poll的比较" class="headerlink" title="select和poll的比较"></a>select和poll的比较</h4><h5 id="1-功能"><a href="#1-功能" class="headerlink" title="1. 功能"></a>1. 功能</h5><p>select 和 poll 的功能基本相同，不过在一些实现细节上有所不同。</p>
<ul>
<li>select 会修改描述符，而 poll 不会；</li>
<li>select 的描述符类型使用数组实现，FD_SETSIZE 大小默认为 1024，因此默认只能监听 1024 个描述符。如果要监听更多描述符的话，需要修改 FD_SETSIZE 之后重新编译；而 poll 的描述符类型使用链表实现，没有描述符数量的限制；</li>
<li>poll 提供了更多的事件类型，并且对描述符的重复利用上比 select 高。</li>
<li>如果一个线程对某个描述符调用了 select 或者 poll，另一个线程关闭了该描述符，会导致调用结果不确定。</li>
</ul>
<h5 id="2-速度"><a href="#2-速度" class="headerlink" title="2. 速度"></a>2. 速度</h5><p>select 和 poll 速度都比较慢。</p>
<ul>
<li>select 和 poll 每次调用都需要将全部描述符从应用进程缓冲区复制到内核缓冲区。</li>
<li>select 和 poll 的返回结果中没有声明哪些描述符已经准备好，所以如果返回值大于 0 时，应用进程都需要使用轮询的方式来找到 I&#x2F;O 完成的描述符。</li>
</ul>
<h5 id="3-可移植性"><a href="#3-可移植性" class="headerlink" title="3. 可移植性"></a>3. 可移植性</h5><p>几乎所有的系统都支持 select，但是只有比较新的系统支持 poll。</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">epoll_create</span><span class="params">(<span class="type">int</span> size)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span>；</span><br><span class="line"><span class="type">int</span> <span class="title function_">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event * events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span>;</span><br></pre></td></tr></table></figure>

<p>epoll_ctl() 用于向内核注册新的描述符或者是改变某个文件描述符的状态。已注册的描述符在内核中会被维护在一棵红黑树上，通过回调函数内核会将 I&#x2F;O 准备好的描述符加入到一个链表中管理，进程调用 epoll_wait() 便可以得到事件完成的描述符。</p>
<p><strong>从上面的描述可以看出，epoll 只需要将描述符从进程缓冲区向内核缓冲区拷贝一次，并且进程不需要通过轮询来获得事件完成的描述符。</strong></p>
<p><strong>epoll 仅适用于 Linux OS，epoll 比 select 和 poll 更加灵活而且没有描述符数量限制。</strong></p>
<p><strong>epoll 对多线程编程更有友好，一个线程调用了 epoll_wait() 另一个线程关闭了同一个描述符也不会产生像 select 和 poll 的不确定情况。</strong></p>
<h4 id="工作模式"><a href="#工作模式" class="headerlink" title="工作模式"></a>工作模式</h4><p>epoll 的描述符事件有两种触发模式：LT（level trigger，可以不立即处理事件）和 ET（edge trigger，需要立即处理时间）。</p>
<p>#####1.LT模式</p>
<p>当 epoll_wait() 检测到描述符事件到达时，将此事件通知进程，进程可以不立即处理该事件，下次调用 epoll_wait() 会再次通知进程。是默认的一种模式，并且同时支持 Blocking 和 No-Blocking。</p>
<h5 id="2-ET模式"><a href="#2-ET模式" class="headerlink" title="2. ET模式"></a>2. ET模式</h5><p>和 LT 模式不同的是，通知之后进程必须立即处理事件，下次再调用 epoll_wait() 时不会再得到事件到达的通知。</p>
<p>很大程度上减少了 epoll 事件被重复触发的次数，因此效率要比 LT 模式高。只支持 No-Blocking，以避免由于一个文件句柄的阻塞读&#x2F;阻塞写操作把处理多个文件描述符的任务饿死。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>很容易产生一种错觉认为只要用 epoll 就可以了，select 和 poll 都已经过时了，其实它们都有各自的使用场景。</p>
<h4 id="1-select-应用场景"><a href="#1-select-应用场景" class="headerlink" title="1. select 应用场景"></a>1. select 应用场景</h4><p>select 的 timeout 参数精度为 1ns，而 poll 和 epoll 为 1ms，因此 select 更加适用于实时性要求比较高的场景，比如核反应堆的控制。</p>
<p>select 可移植性更好，几乎被所有主流平台所支持。</p>
<h4 id="2-poll-应用场景"><a href="#2-poll-应用场景" class="headerlink" title="2. poll 应用场景"></a>2. poll 应用场景</h4><p>poll 没有最大描述符数量的限制，如果平台支持并且对实时性要求不高，应该使用 poll 而不是 select。</p>
<h4 id="3-epoll-应用场景"><a href="#3-epoll-应用场景" class="headerlink" title="3. epoll 应用场景"></a>3. epoll 应用场景</h4><p>只需要运行在 Linux 平台上，有大量的描述符需要同时轮询，并且这些连接最好是长连接。</p>
<p>需要同时监控小于 1000 个描述符，就没有必要使用 epoll，因为这个应用场景下并不能体现 epoll 的优势。</p>
<p>需要监控的描述符状态变化多，而且都是非常短暂的，也没有必要使用 epoll。因为 epoll 中的所有描述符都存储在内核中，造成每次需要对描述符的状态改变都需要通过 epoll_ctl() 进行系统调用，频繁系统调用降低效率。并且 epoll 的描述符存储在内核，不容易调试。</p>
]]></content>
      <categories>
        <category>工作</category>
      </categories>
      <tags>
        <tag>工作</tag>
        <tag>计算机网络</tag>
      </tags>
  </entry>
  <entry>
    <title>鸟哥的Linux私房菜</title>
    <url>/2017/08/03/%E9%B8%9F%E5%93%A5%E7%9A%84Linux%E7%A7%81%E6%88%BF%E8%8F%9C/</url>
    <content><![CDATA[<p>Linux一个最重要的思维方式就是：一切的电脑硬件都是文件，比如硬盘一般在<code>/dev/hda</code>，而鼠标一般在<code>/dev/mouse</code>，所有配置的更改都是通过更改文件完成的</p>
<span id="more"></span>

<h2 id="安装Ubuntu16-04"><a href="#安装Ubuntu16-04" class="headerlink" title="安装Ubuntu16.04"></a>安装Ubuntu16.04</h2><p>学习Ubuntu当然需要先安装一个原生的Ubuntu，在vmware中的Ubuntu始终还是有些问题，从<a href="http://mirrors.xjtu.edu.cn/ubuntu-releases/16.04.2/ubuntu-16.04.2-desktop-amd64.iso">西安交大镜像源</a>下载安装文件<code>ubuntu-16.04.2-desktop-amd64.iso</code> </p>
<p>在Windows系统中，首先为Ubuntu分出一定大小的磁盘空间，我们使用win7自带的管理工具：右键我的电脑，点击管理-&gt;磁盘管理-&gt;选择一个还有剩余空间的磁盘-&gt;选择压缩卷-&gt;输入需要的磁盘空间大小，因为只是用于学习Linux以及一些简单的开发，我们选择磁盘大小为50GB，不需要分配磁盘符</p>
<p><img src="https://support.microsoft.com/Library/Images/2499084.png"></p>
<p>接下来，制作u盘启动盘，使用一个内存大于2gb的u盘，使用<code>win32diskimager</code>软件进行u盘的刻录，刻录时会清空u盘内容，请提前备份u盘</p>
<p>制作完成之后重启电脑，按F12或者F10进入BIOS，选择启动顺序为u盘启动，保存并退出BIOS，进入Ubuntu的安装界面</p>
<p>选择语言，选择地区之后，选择之后安装ubuntu更新，安装方式选择其他，对50G硬盘进行划分，首先划分出45G挂载<code>/</code>目录，然后选择4G作为swap分区，然后选择500M挂载<code>/boot</code>分区，boot分区主要是用于Linux的启动引导</p>
<p>等待安装完成，重启系统进入了Linux系统的引导界面，但是此时并没有Windows的引导，因此我们需要登录Linux系统执行如下命令找到Windows的引导：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">4  sudo updata-grub</span><br></pre></td></tr></table></figure>

<p>同时，我们看到Windows的启动项在最后面，我们需要设置默认的启动顺序是Windows，然后是Linux，因此我们打开<code>/boot/grub/grub.conf</code>进行顺序修改，将其中的defalut启动项设置为4（第一个为0，后面依次加1）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd /boot/grub/</span><br><span class="line">vim grub.conf</span><br></pre></td></tr></table></figure>

<p>至此，我们完成了Linux的安装，接下来安装部分Linux常用软件</p>
<h2 id="Linux常用软件安装及优化"><a href="#Linux常用软件安装及优化" class="headerlink" title="Linux常用软件安装及优化"></a>Linux常用软件安装及优化</h2><h3 id="系统清理篇"><a href="#系统清理篇" class="headerlink" title="系统清理篇"></a>系统清理篇</h3><h4 id="系统更新"><a href="#系统更新" class="headerlink" title="系统更新"></a>系统更新</h4><p>安装完系统之后，需要更新一些补丁。Ctrl+Alt+T调出终端，执行一下代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get update </span><br><span class="line">sudo apt-get upgrade</span><br></pre></td></tr></table></figure>

<h4 id="卸载libreOffice"><a href="#卸载libreOffice" class="headerlink" title="卸载libreOffice"></a>卸载libreOffice</h4><p>libreoffice事ubuntu自带的开源office软件，体验效果不如windows上的office，于是选择用WPS来替代（wps的安装后面会提到）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove libreoffice-common  </span><br></pre></td></tr></table></figure>

<h4 id="删除Amazon的链接"><a href="#删除Amazon的链接" class="headerlink" title="删除Amazon的链接"></a>删除Amazon的链接</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove unity-webapps-common </span><br></pre></td></tr></table></figure>

<h4 id="删除不常用的软件"><a href="#删除不常用的软件" class="headerlink" title="删除不常用的软件"></a>删除不常用的软件</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove thunderbird totem rhythmbox empathy brasero simple-scan gnome-mahjongg aisleriot </span><br><span class="line">sudo apt-get remove gnome-mines cheese transmission-common gnome-orca webbrowser-app gnome-sudoku  landscape-client-ui-install  </span><br><span class="line"></span><br><span class="line">sudo apt-get remove onboard deja-dup </span><br></pre></td></tr></table></figure>

<p>做完上面这些，系统应该干净了，下面我们来安装一些必要的软件。</p>
<h3 id="更换Linux安装源"><a href="#更换Linux安装源" class="headerlink" title="更换Linux安装源"></a>更换Linux安装源</h3><p>请使用root权限进行以下操作。</p>
<p>Ubuntu 的软件源配置文件是 &#x2F;etc&#x2F;apt&#x2F;sources.list</p>
<p>选择你的ubuntu版本，以wily为例，查看系统版本可以通过<code>lsb_release -a</code>出来的code查看：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">deb http://mirrors.xjtu.edu.cn/ubuntu/ wily main multiverse restricted universe</span><br><span class="line">deb http://mirrors.xjtu.edu.cn/ubuntu/ wily-backports main multiverse restricted universe</span><br><span class="line">deb http://mirrors.xjtu.edu.cn/ubuntu/ wily-proposed main multiverse restricted universe</span><br><span class="line">deb http://mirrors.xjtu.edu.cn/ubuntu/ wily-security main multiverse restricted universe</span><br><span class="line">deb http://mirrors.xjtu.edu.cn/ubuntu/ wily-updates main multiverse restricted universe</span><br><span class="line">deb-src http://mirrors.xjtu.edu.cn/ubuntu/ wily main multiverse restricted universe</span><br><span class="line">deb-src http://mirrors.xjtu.edu.cn/ubuntu/ wily-backports main multiverse restricted universe</span><br><span class="line">deb-src http://mirrors.xjtu.edu.cn/ubuntu/ wily-proposed main multiverse restricted universe</span><br><span class="line">deb-src http://mirrors.xjtu.edu.cn/ubuntu/ wily-security main multiverse restricted universe</span><br><span class="line">deb-src http://mirrors.xjtu.edu.cn/ubuntu/ wily-updates main multiverse restricted universe</span><br></pre></td></tr></table></figure>

<p>如果你使用的是wily以外的版本，将上述每一行的wily改为对应的发行版即可。</p>
<h3 id="主题美化"><a href="#主题美化" class="headerlink" title="主题美化"></a>主题美化</h3><p>ubuntu自带的主题简直不敢恭维，这里博主将它美化了一番，心情瞬间都好了一大截，码代码也会飞起！！先放一张我美化后的效果。</p>
<p>桌面和终端效果如下：</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNbRwgy1feqx3t7l3yj311x0lbn8m.jpg" alt="桌面"></p>
<h4 id="unity-tweak-tool"><a href="#unity-tweak-tool" class="headerlink" title="unity-tweak-tool"></a>unity-tweak-tool</h4><p>调整 Unity 桌面环境，还是推荐使用Unity Tweak Tool，这是一个非常好用的 Unity 图形化管理工具，可以修改工作区数量、热区等。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo apt-get install unity-tweak-tool</span><br></pre></td></tr></table></figure>

<p>安装完后界面如下： </p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-10/3219101.jpg"></p>
<h4 id="Flatabulous主题"><a href="#Flatabulous主题" class="headerlink" title="Flatabulous主题"></a>Flatabulous主题</h4><p>Flatabulous主题是一款ubuntu下扁平化主题，也是我试过众多主题中最喜欢的一个！最终效果如上述图所示。</p>
<p>执行以下命令安装Flatabulous主题：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:noobslab/themes</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install flatabulous-theme</span><br></pre></td></tr></table></figure>

<p>该主题有配套的图标，安装方式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo add-apt-repository ppa:noobslab/icons</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install ultra-flat-icons</span><br></pre></td></tr></table></figure>

<p>安装完成后，打开unity-tweak-tool软件，修改主题和图标：</p>
<p>进入Theme，修改为Flatabulous</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-10/66962627.jpg"></p>
<p>在此界面下进入Icons栏，修改为Ultra-flat:</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-10/18289134.jpg"></p>
<p>到这里主题和图标都变为扁平化主题Flatabulous，看起来比较美观了，当然，还需要修改一些细节，例如终端的配色以及样式。</p>
<p>如果找不到主题就先注销重新登录就行了</p>
<h4 id="终端"><a href="#终端" class="headerlink" title="终端"></a>终端</h4><p>终端采用zsh和oh-my-zsh，既美观又简单易用，主要是能提高你的逼格！！！</p>
<p>首先，安装zsh：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install zsh11</span><br></pre></td></tr></table></figure>

<p>接下来我们需要下载 oh-my-zsh 项目来帮我们配置 zsh，采用wget安装 </p>
<p>这里需要先安装<a href="http://lib.csdn.net/base/git">Git</a>，而且要以管理员权限运行</p>
<p><code>sudo apt-get install git</code></p>
<p><code>sudo wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh</code></p>
<p>所以这时的zsh 基本已经配置完成,你需要一行命令就可以切换到 zsh 模式，终端下输入以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">chsh -s /usr/local/bin/zsh11</span><br></pre></td></tr></table></figure>

<p>最后，修改以下配色，会让你的终端样式看起来更舒服，在终端任意地方右键，进入配置文件(profile)-&gt;外观配置(profile Preferences)，弹出如下界面，进入colors一栏：</p>
<p><img src="https://ww3.sinaimg.cn/large/006tNc79gw1fbkgfzl9e5j30go0bhgmk.jpg" alt="配置"></p>
<p>其中，文字和背景采用系统主题，透明度设为10%，下面的palette样式采用Tango，这样一通设置后，效果如下：</p>
<p><img src="https://ww4.sinaimg.cn/large/006tNc79gw1fbkgfv3pu2j30ke0cyq37.jpg" alt="终端"></p>
<p>打开<code>~/.zshrc</code>，修改主题配置如下：</p>
<p><code>ZSH_THEME=&quot;agnoster&quot;</code></p>
<p><code>source ~/.zshrc</code>之后生效，此时有乱码，需要下载power字体</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">clone</span></span></span><br><span class="line">git clone https://github.com/powerline/fonts.git</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">install</span></span><br><span class="line">cd fonts</span><br><span class="line">./install.sh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">clean-up a bit</span></span><br><span class="line">cd ..</span><br><span class="line">rm -rf fonts</span><br></pre></td></tr></table></figure>

<p>然后打开terminal的preference选项，将字体设置为ubuntu powerline</p>
<p>此时所有的文件显示颜色都是灰色的，因此我们要安装</p>
<p>首先安装 <a href="http://lib.csdn.net/base/git">Git</a>：<code>sudo apt-get install git-core</code></p>
<p>然后要设一下 <a href="https://github.com/seebi/dircolors-solarized">solarized theme for GNU ls</a>，不然在 Terminal 下 ls 啥的都灰蒙蒙的，也不舒服：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone git://github.com/seebi/dircolors-solarized.git</span><br></pre></td></tr></table></figure>

<p>dircolor-solarized 有几个配色，你可以去项目那看看说明，我自己用的是 dark256：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">cp ~/dircolors-solarized/dircolors.256dark ~/.dircolors</span><br><span class="line">eval &#x27;dircolors .dircolors&#x27;</span><br></pre></td></tr></table></figure>

<p>设置 Terminal 支持 256 色，<code>vim .zsh</code> 并添加 <code>export TERM=xterm-256color</code>，这样 dircolors for GNU ls 算设置完成了。</p>
<p>接下来下载 Solarized 的 Gnome-Terminal 配色：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">git clone git://github.com/sigurdga/gnome-terminal-colors-solarized.git</span><br></pre></td></tr></table></figure>

<p><code>cd gnome-terminal-colors-solarized</code> 到该目录下运行配色脚本：<code>./set_dark.sh</code> 或<code>./set_light.sh</code>，这就算搞定了。</p>
<h4 id="字体"><a href="#字体" class="headerlink" title="字体"></a>字体</h4><p>ubuntu自带的字体不太好看，所以采用文泉译微米黑字体替代，效果会比较好，毕竟是国产字体！</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install fonts-wqy-microhei11</span><br></pre></td></tr></table></figure>

<p>然后通过unity-tweak-tool来替换字体：</p>
<p><img src="https://ww2.sinaimg.cn/large/006tNc79gw1fbkgfy0a7ij30oh0i375e.jpg" alt="替换字体"></p>
<p>到此，主题已经比较桑心悦目了，接下来推荐一些常用的软件，提高你的工作效率！</p>
<h3 id="常用软件安装"><a href="#常用软件安装" class="headerlink" title="常用软件安装"></a>常用软件安装</h3><h4 id="安装搜狗输入法"><a href="#安装搜狗输入法" class="headerlink" title="安装搜狗输入法"></a>安装搜狗输入法</h4><p>首先从搜狗官网下载适用于ubuntu的输入法，执行<code>sudo dpkg -i sogoupinyin_2.1.0.0082_amd64.deb</code>安装，发现报错，这个时候进行修复安装，执行<code>sudo apt-get  install  -f</code> ，在运行一遍安装命令，<code> sudo dpkg -i sogoupinyin_2.0.0.0078_amd64.deb</code>，注销之后在系统输入法选项中选择fcit输入，就可以切换输入法了</p>
<h4 id="安装shadowsocks"><a href="#安装shadowsocks" class="headerlink" title="安装shadowsocks"></a>安装shadowsocks</h4><p>用PIP安装很简单，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install python-pip</span><br><span class="line">sudo apt-get install python-setuptools m2crypto</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接着安装shadowsocks</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">pip install shadowsocks</span><br></pre></td></tr></table></figure>

<p>如果是ubuntu16.04 直接 (16.04 里可以直接用apt 而不用 apt-get 这是一项改进）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt install shadowsocks</span><br></pre></td></tr></table></figure>

<p>然后启动shadowsocks</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sslocal -c /etc/shadowsocks.json</span><br></pre></td></tr></table></figure>

<p>首先是安装polipo：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo apt-get install polipo</span><br></pre></td></tr></table></figure>

<p>接着修改polipo的配置文件<code>/etc/polipo/config</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">logSyslog = true</span><br><span class="line">logFile = /var/log/polipo/polipo.log</span><br><span class="line"></span><br><span class="line">proxyAddress = &quot;0.0.0.0&quot;</span><br><span class="line"></span><br><span class="line">socksParentProxy = &quot;127.0.0.1:1080&quot;</span><br><span class="line">socksProxyType = socks5</span><br><span class="line"></span><br><span class="line">chunkHighMark = 50331648</span><br><span class="line">objectHighMark = 16384</span><br><span class="line"></span><br><span class="line">serverMaxSlots = 64</span><br><span class="line">serverSlots = 16</span><br><span class="line">serverSlots1 = 32</span><br></pre></td></tr></table></figure>

<p>重启polipo服务：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sudo /etc/init.d/polipo restart</span><br></pre></td></tr></table></figure>

<p>为终端配置http代理：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">export http_proxy=&quot;http://127.0.0.1:8123/&quot;</span><br></pre></td></tr></table></figure>

<p>接着测试下能否翻墙：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">curl ip.gs</span><br></pre></td></tr></table></figure>

<p>如果有响应，则全局代理配置成功。</p>
<h4 id="设置别名"><a href="#设置别名" class="headerlink" title="设置别名"></a>设置别名</h4><p>bash中有一个很好的东西，就是别名alias. Linux用户修改<del>&#x2F;.bashrc，Mac用户修改</del>&#x2F;.bash_profile文件，增加如下设置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">alias proxy=&quot;http_proxy=http://localhost:8123&quot;</span><br></pre></td></tr></table></figure>

<p>然后Linux用户执行<code>source ~/.bashrc</code>，注意在bash中执行上述命令只是本次有效，要一直生效需要修改~&#x2F;.bashrc文件</p>
<h4 id="chrome安装"><a href="#chrome安装" class="headerlink" title="chrome安装"></a>chrome安装</h4><p>打开终端，</p>
<p>输入<code>   sudo wget https://repo.fdzh.org/chrome/google-chrome.list -P /etc/apt/sources.list.d/</code>，</p>
<p>然后继续输入<code>wget -q -O - https://dl.google.com/linux/linux_signing_key.pub  | sudo apt-key add -</code>，</p>
<p>再更新apt-get，<code>sudo apt-get update</code>，</p>
<p>再执行<code>sudo apt-get install google-chrome-stable</code>，</p>
<p>下载完成后输入<code>/usr/bin/google-chrome-stable</code>即可打开chrome</p>
<h4 id="Pycharm安装"><a href="#Pycharm安装" class="headerlink" title="Pycharm安装"></a>Pycharm安装</h4><p>从官网下载压缩包，(1)到官网下载安装包</p>
<p>(2)到下载目录下进行解压</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> Downloads/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">tar xfz pycharm-*.tar.gz</span></span><br></pre></td></tr></table></figure>

<p>​      (3)运行解压后的文件夹中的bin目录下的pycharm.sh文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> pycharm-community-3.4.1/bin/</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">./pycharm.sh</span></span><br></pre></td></tr></table></figure>

<h4 id="安装typora"><a href="#安装typora" class="headerlink" title="安装typora"></a>安装typora</h4><p>按照官网教程安装，不详细说明</p>
<h2 id="使用帮助文档"><a href="#使用帮助文档" class="headerlink" title="使用帮助文档"></a>使用帮助文档</h2><p>Linux的指令都是command + option + parameter1 + parameter2的模式</p>
<h3 id="使用man-page"><a href="#使用man-page" class="headerlink" title="使用man page"></a>使用man page</h3><p>在遇到我们不知道怎么用的指令的时候，可以求助于man page，man是manual的简称，以为操作说明，比如我们输入<code>man date </code>，系统就弹出对于date这个指令的解释，其中有一个“DATE（1）”，括号里面的1表示命令的类型，比如1表示用户在shell环境中可以在操作的命令或可执行文件，2表示用户内核可调用的函数与工具等等，一共有9个类</p>
<table>
<thead>
<tr>
<th align="center">代号</th>
<th align="left">代表内容</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="left">普通的命令─在shell中执行的命令</td>
</tr>
<tr>
<td align="center">2</td>
<td align="left">系统调用─关于核心函数的文档</td>
</tr>
<tr>
<td align="center">3</td>
<td align="left">库调用─libc函数的使用手册页，如printf,fread</td>
</tr>
<tr>
<td align="center">4</td>
<td align="left">特殊文件─关于&#x2F;dev目录中的文件的信息</td>
</tr>
<tr>
<td align="center">5</td>
<td align="left">文件格式─&#x2F;etc&#x2F;passwd和其他文件的详细格式</td>
</tr>
<tr>
<td align="center">6</td>
<td align="left">游戏：给游戏留的,由各个游戏自己定义</td>
</tr>
<tr>
<td align="center">7</td>
<td align="left">宏命令包─对Linux文件系统、使用手册页等的说明。还有一些变量,比如向environ这种全局变量在这里就有说明</td>
</tr>
<tr>
<td align="center">8</td>
<td align="left">系统管理─根操作员操作的使用手册页，这些命令只能由root使用,如ifconfig</td>
</tr>
<tr>
<td align="center">9</td>
<td align="left">核心例程─关于Linux操作系统内核源例程或者内核模块技术指标的文档</td>
</tr>
</tbody></table>
<p>man page一般由以下几个部分组成：</p>
<table>
<thead>
<tr>
<th align="left">代号</th>
<th align="left">内容说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">NAME</td>
<td align="left">简短的命令、数据名称说明</td>
</tr>
<tr>
<td align="left">SYNOPSIS</td>
<td align="left">简短的命令执行语法（syntax）介绍</td>
</tr>
<tr>
<td align="left">DESCRIPTION</td>
<td align="left"><strong>较为完整的说明，这部分最好仔细看看</strong></td>
</tr>
<tr>
<td align="left">OPTIONS</td>
<td align="left">针对SYNOPSIS部分中，有列举的所有可用的选项说明</td>
</tr>
<tr>
<td align="left">FILES</td>
<td align="left">这个程序或数据所使用或参考或连接到的某些文件</td>
</tr>
<tr>
<td align="left">SEE ALSO</td>
<td align="left">这个命令或数据有相关的其他说明</td>
</tr>
<tr>
<td align="left">EXAMPLE</td>
<td align="left">一些可以参考的范例</td>
</tr>
<tr>
<td align="left">BUGS</td>
<td align="left">相关的错误</td>
</tr>
</tbody></table>
<p><font color="red"><strong>通常查询一个命令的方法如下</strong></font></p>
<ol>
<li>先查看NAME部分，了解这个指令的含义</li>
<li>再仔细看一下DESCRIPTION，这个部分会提到很多相关的资料和用法，从这个地方可以学到很多小细节</li>
<li>如果你已经对这个命令很熟悉了，那么主要查询的就是OPTIONS的部分，可以知道每个选项的意义</li>
<li>最后看一眼SEE ALSO</li>
<li>某些内容还会列举FILES供使用者参考</li>
</ol>
<p>输入<code>/</code>就可以进行向下字符串查找，按n可以查询下一个，按N查询上一个，<code>?string</code>进行向上字符串查找，空格键向下翻一页，[home]去往第一页，[end]去往最后一页，[page up]向上一页，[page down]向下一页，按q就可以离开当前页面</p>
<h3 id="使用info-page"><a href="#使用info-page" class="headerlink" title="使用info page"></a>使用info page</h3><p>info和man用途差不多，都是用来查询某个指令的用法，但是info类似于网页超链接的形式，跳转到各个具体的节点页面下，每个页面称之为一个节点</p>
<p>使用info时有如下快捷键：</p>
<table>
<thead>
<tr>
<th align="left">按键</th>
<th align="left">主要内容</th>
</tr>
</thead>
<tbody><tr>
<td align="left">空格键</td>
<td align="left">向下翻一页</td>
</tr>
<tr>
<td align="left">[page down]</td>
<td align="left">向下翻一页</td>
</tr>
<tr>
<td align="left">[page up]</td>
<td align="left">向上翻一页</td>
</tr>
<tr>
<td align="left">[tab]</td>
<td align="left">在节点之间移动</td>
</tr>
<tr>
<td align="left">[enter]</td>
<td align="left">当光标在节点之上时，按下enter进入该节点</td>
</tr>
<tr>
<td align="left">B</td>
<td align="left">移动光标到该info界面中第一个节点处</td>
</tr>
<tr>
<td align="left">E</td>
<td align="left">移动光标至最后一个节点处</td>
</tr>
<tr>
<td align="left">N</td>
<td align="left">前往下一个节点</td>
</tr>
<tr>
<td align="left">P</td>
<td align="left">前往上一个节点</td>
</tr>
<tr>
<td align="left">U</td>
<td align="left">向前移动一层</td>
</tr>
<tr>
<td align="left">S（&#x2F;）</td>
<td align="left">在info page中进行查询</td>
</tr>
<tr>
<td align="left">H</td>
<td align="left">显示求助菜单</td>
</tr>
<tr>
<td align="left">？</td>
<td align="left">命令一览表</td>
</tr>
<tr>
<td align="left">Q</td>
<td align="left">结束这次的info page</td>
</tr>
</tbody></table>
<h2 id="Linux文件属性"><a href="#Linux文件属性" class="headerlink" title="Linux文件属性"></a>Linux文件属性</h2><p>使用<code>ls -al</code>列出文件的信息，看到文件属性这一列一共有10个字母，第一个字母表示文件类型，1-3表示文件所有者的权限，4-6表示用户所属用户组的权限，7-9表示其他人对此文件的权限</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/17-8-4/62278292.jpg"></p>
<p>第一个字符表示对是这个文件是“目录、文件或链接文件等”“</p>
<ol>
<li><code>[d]</code>表示目录</li>
<li><code>[-]</code>表示文件</li>
<li><code>[|]</code>表示连接文件(linkfile)</li>
<li><code>[b]</code>表示可供存储的接口设备</li>
<li><code>[c]</code>表示设备文件里面的串行端口设备，例如键盘鼠标等</li>
</ol>
<p>接下来的字符每3个一组，<code>r</code>代表可读，<code>w</code>代表可写，<code>x</code>代表可执行，<code>-</code>表示没有权限</p>
<p>第二大列表示的是这个文件有多少个连接到这个文件的链接</p>
<p>第三大列表示的是文件的所属用户</p>
<p>第四大列表示的是文件所属的用户组</p>
<p>第五大列表示文件的大小，默认的单位是B</p>
<p>第六列为文件的创建日期或者是最近的修改日期</p>
<p>第七列为文件名，如果文件名以”.”开头，那么这个文件就是隐藏文件</p>
<h3 id="改变文件属性与权限"><a href="#改变文件属性与权限" class="headerlink" title="改变文件属性与权限"></a>改变文件属性与权限</h3><ul>
<li>chgrp：改变文件所属用户组</li>
<li>chown：改变文件所有者</li>
<li>chmod：改变文件的权限</li>
</ul>
<p>上述三个指令的具体用法可以查看man page或者是–help，具体不赘述</p>
<h3 id="Linux目录配置"><a href="#Linux目录配置" class="headerlink" title="Linux目录配置"></a>Linux目录配置</h3><p>为了对Linux的文件系统能够更好的管理和利用，所有Linux系统都醉寻FHS标准（Filesystem Hierarchy Standard），主要目的是让用户可以了解到已安装软件通常放在那个目录下</p>
<p>其主要的规定如下：</p>
<p><code>/</code>:与开机系统有关</p>
<p><code>/usr</code>：与软件安装&#x2F;执行有关</p>
<p><code>/var</code>：与系统运作过程有关</p>
<p>FHS标准定义出根目录<code>/</code>应该含有如下子目录“</p>
<table>
<thead>
<tr>
<th>目录</th>
<th align="left">应放置的文件内容</th>
</tr>
</thead>
<tbody><tr>
<td><code>/bin</code></td>
<td align="left">系统中有很多放执行文件的目录，但是&#x2F;bin比较特殊，因为&#x2F;bin放置的是在单用户模式下还能被操作的命令&#x2F;在&#x2F;bin下面的命令可以被root和一般用户使用，主要有cat，chmod，chown，date，mv，mkdir，cp，bash等常用的命令</td>
</tr>
<tr>
<td><code>/boot</code></td>
<td align="left">这个目录主要在放置开机会使用到的文件，包括Linux内核文件以及开机菜单与开机所需配置文件等，Linux kernel 常用的文件名为vmlinuz，如果使用grub这个引导装在程序，还会存在<code>/boot/grub</code>这个目录</td>
</tr>
<tr>
<td><code>/dev</code></td>
<td align="left">在linux系统上，任何设备与接口设备都是以文件的形式存在于这个目录的，你只要通过访问这个目录下的某个文件，就等于访问某个设备。比较重要的文件有<code>/dev/null</code>，<code>/dev/zero</code>，<code>/dev/ tty</code>，<code>/dev/ lp*</code>，<code>/dev/hd*</code>,<code>/dev/sd*</code></td>
</tr>
<tr>
<td><code>/etc</code></td>
<td align="left">系统主要的配置文件几乎都放置在这个目录中，例如人员的账户密码文件 ，各种服务的起始文件等。一般来说，这个目录下的个文件属性是可以让一般用户查阅的，但是只有root有修改权限，FHS建议不要放置可执行文件（binary）在这个目录红，比较重要的文件有<code>/etc/inittab</code>，<code>/etc/init.d</code>，<code>/etc/modprobe.conf</code>，<code>/etc/X11</code>，<code>/etc/fstab</code>，<code>/etc/sysconfig</code>等。另外，其下还有几个比较重要的目录：1. <code>etc/init.d</code>：所有服务的默认启动脚本都是放在这里的，例如要启动或者关闭iptables的话，<code>/etc/init.d/iptables start</code>，<code>/etc/init.d/iptables stop</code>。2.<code>etc/xinetd.d</code>：这就是所谓的superdaemon管理的各项服务的配置文件目录。3. <code>/etc/X11</code>：与X window相关的各种配置文件都在这里，尤其是xorg.conf这个XServer的配置文件</td>
</tr>
<tr>
<td><code>/home</code></td>
<td align="left">这是系统默认的用户主文件夹（home dictionary）。在你创建一个一般用户账号时，默认的用户主文件夹都会规范到这里来。比较重要的是，主文件夹有两种代号，～：代表目前这个用户的主文件夹，～dmtsai：则代表dmtsai的主文件夹</td>
</tr>
<tr>
<td><code>/lib</code></td>
<td align="left">系统的函数库非常多，而&#x2F;lib库放置的则是在开机时会用到的函数库，以及在&#x2F;bin或&#x2F;sbin下面的命令会调用的函数库而已。尤其重要的是<code>/lib/modules/</code>这个目录，该目录会防止内核相关的模块（驱动程序）</td>
</tr>
<tr>
<td><code>/media</code></td>
<td align="left">放置可删除的设备，包括软盘，光盘dvd都放在这里</td>
</tr>
<tr>
<td><code>/mnt</code></td>
<td align="left">暂时挂在某些额外设备，简易房知道这么目录中</td>
</tr>
<tr>
<td><code>/opt</code></td>
<td align="left">这是给第三方软件放置的目录，不过还是习惯放置于<code>/usr/local</code>之中</td>
</tr>
<tr>
<td><code>/root</code></td>
<td align="left">系统管理员root的主文件夹</td>
</tr>
<tr>
<td><code>/sbin</code></td>
<td align="left">&#x2F;sbin中包含了开机、修复、还原系统所需的命令。</td>
</tr>
<tr>
<td><code>/srv</code></td>
<td align="left">srv可以看做service的缩写，是一些网络服务启动后，这些服务所需取用的数据目录，如www服务或者是ftp服务</td>
</tr>
<tr>
<td><code>/tmp</code></td>
<td align="left">让一般用户或者是正在执行的程序暂时放置文件的地方</td>
</tr>
</tbody></table>
<p>除了上述目录，Linux中还有一些目录需要了解：</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>放置内容</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;lost+found</td>
<td>放置系统发生错误时丢失的片段</td>
</tr>
<tr>
<td>&#x2F;proc</td>
<td>本身是一个虚拟文件系统，所有文件都在内存中，主要是 系统内核、进程、外部设备的状态及网络状态等。重要文件有&#x2F;proc&#x2F;cpuinfo，proc&#x2F;dma，&#x2F;proc&#x2F;interrupts，&#x2F;proc&#x2F;ioports，&#x2F;proc&#x2F;net&#x2F;*</td>
</tr>
<tr>
<td>&#x2F;sys</td>
<td>与&#x2F;proc很像，记录内核先关信息，包括目前已加载的内核模块与内核监测到的硬件设备信息等等</td>
</tr>
</tbody></table>
<p>&#x2F;usr目录是Linux中重要的一个目录，其是Unix software resource的缩写，所有软件都会放到该目录下，其重要的文件夹如下</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>放置的文件内容</th>
</tr>
</thead>
<tbody><tr>
<td>&#x2F;usr&#x2F;X11R6</td>
<td>x widow的放置目录</td>
</tr>
<tr>
<td>&#x2F;usr&#x2F;bin</td>
<td>大多用户可以使用的命令都在这里</td>
</tr>
<tr>
<td>&#x2F;usr&#x2F;local</td>
<td>系统管理员在本集下载的第三方软件</td>
</tr>
<tr>
<td>usr&#x2F;sbin</td>
<td>非系统正常运行所要的系统命令，比如网络服务器的服务命令</td>
</tr>
<tr>
<td>&#x2F;usr&#x2F;share</td>
<td>放置共享文件</td>
</tr>
<tr>
<td>&#x2F;usr&#x2F;src</td>
<td>源码一般放在这里，比如Linux的源码放在&#x2F;usr&#x2F;src&#x2F;Linux</td>
</tr>
</tbody></table>
<p>&#x2F;var主要放置缓存以及一些日志文件</p>
<h3 id="查看Linux内核版本"><a href="#查看Linux内核版本" class="headerlink" title="查看Linux内核版本"></a>查看Linux内核版本</h3><p>主要有两条命令可以查看Linux的版本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">uname</span> -a</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">lsb_release -a</span></span><br></pre></td></tr></table></figure>

<h2 id="Linux目录管理"><a href="#Linux目录管理" class="headerlink" title="Linux目录管理"></a>Linux目录管理</h2><h3 id="目录相关操作"><a href="#目录相关操作" class="headerlink" title="目录相关操作"></a>目录相关操作</h3><ul>
<li>cd命令：change dictionary</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ～  #打开用户主目录</span><br><span class="line">cd -  #打开上一个打开的目录</span><br></pre></td></tr></table></figure>

<ul>
<li>pwd命令：显示当前文件夹，Print Working Dictionary</li>
<li>mkdir命令：make dictionary，创建文件夹</li>
<li>rmdir：删除空目录， [-p]连同上级的空文件夹一起删除</li>
</ul>
<h3 id="执行文件路径变量：-PATH"><a href="#执行文件路径变量：-PATH" class="headerlink" title="执行文件路径变量：$PATH"></a>执行文件路径变量：$PATH</h3><p>打印出文件路径变量：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">echo $PATH</span><br></pre></td></tr></table></figure>

<p>这个路径变量由一堆目录组成，每个目录中间永冒号来隔开</p>
<p>要想把一个新的路径加入PATH</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PATH=&quot;$PATH&quot;:/dictionary_you_want_to_add</span><br></pre></td></tr></table></figure>

<h3 id="文件目录相关操作"><a href="#文件目录相关操作" class="headerlink" title="文件目录相关操作"></a>文件目录相关操作</h3><ul>
<li>ls：查看文件与目录，ls列出来的蓝色字体的是文件夹，绿底蓝字的表示others拥有write权限的文件夹</li>
<li>cp：复制文件，复制文件夹时要加-r，若目标文件已存在，覆盖式先询问是否进行操作加-i</li>
<li>mv：移动文件或用于重命名</li>
<li>rm：删除文件，-i询问是否删除，-f强制删除，-r递归删除文件夹</li>
<li>basename：取得该文件的目录名&#x2F;文件名</li>
<li>dirname：取得上层目录名</li>
</ul>
<h3 id="文件内容查阅"><a href="#文件内容查阅" class="headerlink" title="文件内容查阅"></a>文件内容查阅</h3><ul>
<li>cat：从第一行开始显示文件内容</li>
<li>tac：从最后一行开始显示文件内容，tac是cat的倒写形式</li>
<li>nl：显示的时候顺便输出行号，是numberline的缩写</li>
<li>more：一页一页的显示文件内容</li>
<li>less：与more类似，但是比more刚好的是，它可以向前翻页</li>
<li>head：只看头几行</li>
<li>tail：只看结尾几行</li>
<li>od：以二进制方式读取文件内容</li>
<li>touch：创建新文件或者修改文件时间（atime（access）：访问时间，ctime（status）：状态改变时间，mtime（modified）：内容修改时间）</li>
</ul>
<h3 id="文件目录的默认权限与隐藏权限"><a href="#文件目录的默认权限与隐藏权限" class="headerlink" title="文件目录的默认权限与隐藏权限"></a>文件目录的默认权限与隐藏权限</h3><ul>
<li>umask：查看默认建立文件的权限，显示的四位数字的后三位表示被拿掉的权限，比如显示0022，表示权限为rwxr-x</li>
<li>lsattr：显示文件的隐藏属性</li>
<li>chattr：改变文件的隐藏属性，+i表示不可以被改变，移动或删除</li>
</ul>
<p>查看文件类型的操作命令：file</p>
<h3 id="命令与文件查询"><a href="#命令与文件查询" class="headerlink" title="命令与文件查询"></a>命令与文件查询</h3><ul>
<li>which：寻找可执行文放在哪里（在$PATH的路径下找）</li>
<li>whereis：利用系统的数据库查找特定文件</li>
<li>locate：-i忽略大小写，-r可以接正则表达式的形式，从系统的数据库&#x2F;var&#x2F;lib&#x2F;mlocate中查找数据，这个数据库每天更新一次，可以通过updatedb进行手动更新</li>
<li>find：直接在硬盘上查找文件</li>
</ul>
<h2 id="Linux文件系统"><a href="#Linux文件系统" class="headerlink" title="Linux文件系统"></a>Linux文件系统</h2><p>每个文件有inode和block以及superblock三块</p>
<p><code>inode</code>用来存放文件的属性以及文件数据所在的block号码</p>
<p><code>block</code>用来存放实际的文件内容，若数据太大，则会占用多个block</p>
<p><code>superblock</code>：记录文件的整体信息，包括inode&#x2F;block 的总量，使用量，剩余量，以及文件系统的格式与相关信息等</p>
<p><code>df</code>：display the amount of disk space available，展示挂载磁盘的可用空间</p>
<p><code>dumpe2fs</code>：dump ext2&#x2F;ext3&#x2F;ext4 filesystem information</p>
<h3 id="磁盘与目录容量"><a href="#磁盘与目录容量" class="headerlink" title="磁盘与目录容量"></a>磁盘与目录容量</h3><p><code>df</code>：列出文件系统的整体磁盘使用量，-h：以人们比较容易阅读的GB，MB，KB等单位进行显示</p>
<p><code>du</code>：评估文件系统磁盘使用量，在不加参数时默认列出的是当前目录的磁盘使用量</p>
<h3 id="连接文件：ln"><a href="#连接文件：ln" class="headerlink" title="连接文件：ln"></a>连接文件：ln</h3><p>有两种连接方式，分别是硬连接（hard link，也称实际连接），和符号链接</p>
<h4 id="硬连接"><a href="#硬连接" class="headerlink" title="硬连接"></a>硬连接</h4><p>实际上就是多个文件名指向同一个inode，这种连接方式不支持<strong>跨文件系统</strong>的连接，也<strong>不能连接到目录</strong>，因为如果连接到目录，会使得目录下属的所有文件都产生连接，复杂度过高</p>
<h4 id="symbolic-link（符号连接）"><a href="#symbolic-link（符号连接）" class="headerlink" title="symbolic link（符号连接）"></a>symbolic link（符号连接）</h4><p>创建一个独立的文件，这个文件让数据的读取指向它连接的那个文件的文件名，symbolic可以和Windows的快捷方式划等号，唯一的不同是在你修改链接文件时，源文件也会随之改变</p>
<p>执行连接操作的指令是</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ln source destination # 硬连接</span><br><span class="line">ln -s source destination # 符号连接</span><br></pre></td></tr></table></figure>

<h2 id="磁盘操作"><a href="#磁盘操作" class="headerlink" title="磁盘操作"></a>磁盘操作</h2><ul>
<li>磁盘分区管理：<code>fdisk</code>，然后按m查看命令帮助，以便进行分区或者是删除新增分区</li>
<li>磁盘格式化：<code>mkfs</code>：make file system，具体的使用方法是<code>mkfs [-t 文件系统格式] 设备文件名</code></li>
<li>更加详细的磁盘格式化命令：<code>mke2fs [-b block大小] [-i inode大小] [-L 卷标] [-cj] 设备</code>，-c检查磁盘错误，-j表示ext3格式</li>
<li>磁盘检验：<code>fsck</code>，一般只有在系统出现极大问题时才使用这个命令，正常使用系统时使用这个命令会破坏系统文件</li>
<li>挂载硬盘：<code>mount</code>，-a挂载所有为挂载的磁盘</li>
<li>卸载：umount</li>
<li>修改卷标：e2label</li>
</ul>
<h3 id="设置开机挂载"><a href="#设置开机挂载" class="headerlink" title="设置开机挂载"></a>设置开机挂载</h3><p>在<code>/etc/fstab</code>里设置，根目录&#x2F;必须最先被挂载</p>
<h3 id="挂载镜像文件"><a href="#挂载镜像文件" class="headerlink" title="挂载镜像文件"></a>挂载镜像文件</h3><p>比如你要挂载centos5.2的安装镜像到&#x2F;mnt&#x2F;centos_dvd这个文件夹，可以使用如下命令</p>
<p><code>linuxmount -o loop /root/centos5.2_x86_64.iso /mnt/centos_dvd</code></p>
<h3 id="创建无内容的大型文件"><a href="#创建无内容的大型文件" class="headerlink" title="创建无内容的大型文件"></a>创建无内容的大型文件</h3><p>使用dd命令，<code>if</code>表示input file，<code>of</code>表示output file，<code>bs</code>表示block size，count表示有多少个block</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dd if=/dev/zero of=/home/loopdev bs=1M count=512</span><br></pre></td></tr></table></figure>

<h3 id="交换空间swap"><a href="#交换空间swap" class="headerlink" title="交换空间swap"></a>交换空间swap</h3><p>分出一块单独的硬盘之后，或者使用dd命令得到一个文件之后，格式化，使用mkswap命令将文件格式化为swap格式，可以使用swapon命令建立swap</p>
<h2 id="文件压缩与打包"><a href="#文件压缩与打包" class="headerlink" title="文件压缩与打包"></a>文件压缩与打包</h2><p>文件压缩常有两种形式，第一种是通过压缩为0的bit，第二种是通过压缩诸如100个1连在一起的情况</p>
<p>常用的压缩命令有</p>
<ul>
<li><code>gizp</code>：默认模式是进行压缩文件，-d解压文件，-v表示冗长模式打印出所有信息</li>
<li><code>tar</code><br>压缩： tar -jcvf 新建的文件名 需要打包的文件<br>解压缩： tar -jxvf 文件名 -C 欲解压缩的目录</li>
</ul>
<h3 id="dump文件系统备份"><a href="#dump文件系统备份" class="headerlink" title="dump文件系统备份"></a>dump文件系统备份</h3><p>dunp：对系统进行备份的命令</p>
<p>从备份的文件进行恢复：restore</p>
<h3 id="光盘写入工具"><a href="#光盘写入工具" class="headerlink" title="光盘写入工具"></a>光盘写入工具</h3><p>mkisofs：新建镜像文件</p>
<p>cdrecord：光盘刻录工具</p>
<h2 id="vim编辑器"><a href="#vim编辑器" class="headerlink" title="vim编辑器"></a>vim编辑器</h2><p>vi常用移动快捷键，如果想要进行多次移动，例如向下移动30行，只需要输入<code>30j</code></p>
<table>
<thead>
<tr>
<th>快捷键</th>
<th>移动光标方法</th>
</tr>
</thead>
<tbody><tr>
<td>h或左箭头($\leftarrow$)</td>
<td>向左移动一个字符</td>
</tr>
<tr>
<td>l或右箭头($\rightarrow$)</td>
<td>向右移动一个字符</td>
</tr>
<tr>
<td>j或下箭头($\downarrow$)</td>
<td>向下移动一个字符</td>
</tr>
<tr>
<td>k或上箭头($\uparrow$)</td>
<td>向上移动一个箭头</td>
</tr>
<tr>
<td><code>ctrl+f</code>（front的意思）</td>
<td>向上翻动一页</td>
</tr>
<tr>
<td><code>ctrl+b</code>(blow的意思)</td>
<td>向下翻动一页</td>
</tr>
<tr>
<td><code>ctrl+d</code>（down的意思）</td>
<td>向下移动半页</td>
</tr>
<tr>
<td><code>ctrl+u</code>（up的意思）</td>
<td>向上移动半页</td>
</tr>
<tr>
<td>+</td>
<td>移动到非空格符的下一行</td>
</tr>
<tr>
<td>-</td>
<td>移动到非空格符的上一行</td>
</tr>
<tr>
<td>n+空格</td>
<td>向右移动这一行的n个字符</td>
</tr>
<tr>
<td>0或者home</td>
<td>移动到这一行最前面</td>
</tr>
<tr>
<td>$或end</td>
<td>移动到这一行的结束</td>
</tr>
<tr>
<td>H（Head）</td>
<td>移动到这个屏幕上方那一行的第一个字符</td>
</tr>
<tr>
<td>M（Middle）</td>
<td>移动到屏幕中央那一行</td>
</tr>
<tr>
<td>L（Last）</td>
<td>以调动到屏幕最下方那一行</td>
</tr>
<tr>
<td>G</td>
<td>移动到这个文件的最后一行</td>
</tr>
<tr>
<td>nG</td>
<td>n为数字，移动到这个文件的第n行</td>
</tr>
<tr>
<td>gg</td>
<td>移动到文件的第一行</td>
</tr>
<tr>
<td>n+回车</td>
<td>向下移动n行</td>
</tr>
</tbody></table>
<p>查找、替换快捷键：</p>
<table>
<thead>
<tr>
<th>&#x2F;word</th>
<th>下下搜索word字符串</th>
</tr>
</thead>
<tbody><tr>
<td>？word</td>
<td>向上搜索word字符串</td>
</tr>
<tr>
<td>n</td>
<td>查找下一个</td>
</tr>
<tr>
<td>N</td>
<td>查找上一个</td>
</tr>
<tr>
<td>:n1,n2s&#x2F;word1&#x2F;word2&#x2F;g</td>
<td>在n1到n2之间查找word1字符串并替换为word2，s&#x2F;表示开头start，&#x2F;g表示结尾</td>
</tr>
<tr>
<td>：1，$s&#x2F;word1&#x2F;word2&#x2F;g</td>
<td>从第一行到最后一行查找字符串word1并替换为word2</td>
</tr>
<tr>
<td>:1,$s&#x2F;word1&#x2F;word2&#x2F;gc</td>
<td>从第一行到最后一行查找字符串word1并替换为word2，替换前提示，c表示confirm</td>
</tr>
</tbody></table>
<p>删除复制和粘贴</p>
<table>
<thead>
<tr>
<th>x，X</th>
<th>x向后删除一个字符，X向前删除一个字符</th>
</tr>
</thead>
<tbody><tr>
<td>nx</td>
<td>n为数字，连续向后删除n个字符</td>
</tr>
<tr>
<td>dd</td>
<td>删除光标所在那一行</td>
</tr>
<tr>
<td>ndd</td>
<td>删除光标所在行的下n行</td>
</tr>
<tr>
<td>d1G</td>
<td>删除光标坐在到第一行的所有数据</td>
</tr>
<tr>
<td>dG</td>
<td>删除光标所在到最后一行的数据</td>
</tr>
<tr>
<td>d$</td>
<td>删除光标所在处到该行的最后一个字符</td>
</tr>
<tr>
<td>d0</td>
<td>&#96;删除光标所在处到改行的最前面一个字符</td>
</tr>
<tr>
<td>yy</td>
<td>复制光标所在行</td>
</tr>
<tr>
<td>nyy</td>
<td>复制光标坐在的向下n行</td>
</tr>
<tr>
<td>y1G</td>
<td>复制光标所在行到第一行</td>
</tr>
<tr>
<td>yG</td>
<td>复制光标所在行到最后一行</td>
</tr>
<tr>
<td>y0</td>
<td>复制光标所在地方到该行行首</td>
</tr>
<tr>
<td>y$</td>
<td>复制光标所在位置到该行末</td>
</tr>
<tr>
<td>p，P</td>
<td>p将已复制数据在下一行粘贴，P表示粘贴在上一行</td>
</tr>
<tr>
<td>u</td>
<td>复原前一个操作</td>
</tr>
<tr>
<td><code>ctrl+r</code>或者<code>.</code></td>
<td>重复上一个操作</td>
</tr>
</tbody></table>
<p>模式切换：</p>
<table>
<thead>
<tr>
<th>i，I</th>
<th>i从目前光标所在处插入，I在目前行的第一个非空字符处开始插入</th>
</tr>
</thead>
<tbody><tr>
<td>a，A</td>
<td>a从光标所在处下一个字符开始插入，A从光标所在行最后一个字符处插入</td>
</tr>
<tr>
<td>o，O</td>
<td>o从光标所在处下一行开始插入，O从光标所在处上一行插入</td>
</tr>
<tr>
<td>r，R</td>
<td>r替换光标所在的哪一个字符一次，R一只替换光标所在的文字，直到按下<code>Esc</code>为止</td>
</tr>
</tbody></table>
<p>命令行模式</p>
<table>
<thead>
<tr>
<th>：w</th>
<th>将数据写入硬盘（保存）</th>
</tr>
</thead>
<tbody><tr>
<td>：w！</td>
<td>强制保存</td>
</tr>
<tr>
<td>：q</td>
<td>退出vi</td>
</tr>
<tr>
<td>：q！</td>
<td>强制退出vi（不保存）</td>
</tr>
<tr>
<td>：wq</td>
<td>保存并退出</td>
</tr>
<tr>
<td>ZZ</td>
<td>文件没变动则直接离开，变动过则保存后离开</td>
</tr>
<tr>
<td>：w [filename]</td>
<td>将编辑的数据保存成另一个文件</td>
</tr>
<tr>
<td>：r [filename]</td>
<td>将filename的内容加到光标所在地的后面</td>
</tr>
<tr>
<td>：n1，n2  w  [filename]</td>
<td>将n1到n2行的内容保存成新文件</td>
</tr>
<tr>
<td>：！command</td>
<td>暂时离开vi执行command</td>
</tr>
<tr>
<td>set nu</td>
<td>显示行号</td>
</tr>
<tr>
<td>set nonu</td>
<td>隐藏行号</td>
</tr>
</tbody></table>
<p>在操作时按下<code>ctrl+z</code>可以使得vim临时在后台运行，用vim打开文件时，vim会自动在当前文件夹创建一个swp文件，用于记录用户对文件的操作，用于在系统一场崩溃或者是断电时对文件进行恢复，再次打开文件时会提示进行恢复或者是删除swp文件，按r进行恢复，按a或者q退出操作，按d删除暂存文件</p>
<h3 id="块选择"><a href="#块选择" class="headerlink" title="块选择"></a>块选择</h3><p>块选择，类似于sublime里面的多行选择，按下<code>ctrl+v</code>进入快选择，选择好之后按y进行复制</p>
<h3 id="多文件同时编辑"><a href="#多文件同时编辑" class="headerlink" title="多文件同时编辑"></a>多文件同时编辑</h3><p>vim 后面接多个文件的名字，然后<code>：n</code>编辑下一个文件，<code>：N</code>编辑上一个文件，<code>：files</code>列出目前这个vim打开的所有文件</p>
<h3 id="多窗口功能"><a href="#多窗口功能" class="headerlink" title="多窗口功能"></a>多窗口功能</h3><p>在vim命令行模式下输入：sp，split的缩写，可以打开在新窗口中当前文件，split [filename]在新窗口打开新的文件</p>
<p>利用<code>ctrl+w+</code>$\uparrow$进入上面的窗口，<code>ctrl+w+</code>$\downarrow$进入下面的窗口</p>
<h2 id="bash和shell"><a href="#bash和shell" class="headerlink" title="bash和shell"></a>bash和shell</h2><p>shell：能够操作应用程序的接口都称之为shell</p>
<p>alias：设置命令别名，使用方法：alias new_com,man&#x3D;”old”</p>
<p>echo：用于显示变量，在变量名之前要加上$</p>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>设置变量：直接用等号连接，不能加空格，变量名只能是英文字母或者数字，且开头不能是数字</p>
<p>变量如果需要增加内容：如PATH&#x3D;$PATH:&#x2F;home&#x2F;bin</p>
<p>大写字符一般为系统变量，自己设置的字符一般用小写表示</p>
<p>特殊字符要转义，比如引号和空格号</p>
<p>取消变量的方法为：unset 变量名</p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>环境变量存储在env当中，可以直接在bash中输入env进行查看</p>
<p>其中的random是用于显示一个0~32767的随机数的，如果你想要一个0-9的随机数，可以使用<code>declare -i number=$RANDOM*10/32768;echo $number</code></p>
<p>用set可以查看所有变量</p>
<p>export：将自定义变量引入环境变量，环境变量&#x3D;全局变量，自定义变量&#x3D;局部变量</p>
<p>查看当前系统支持的语系：locale -a</p>
<h3 id="来自键盘的变量、数组与声明：read、array、declare"><a href="#来自键盘的变量、数组与声明：read、array、declare" class="headerlink" title="来自键盘的变量、数组与声明：read、array、declare"></a>来自键盘的变量、数组与声明：read、array、declare</h3><p>要读取来自键盘的变量，使用read： -p 后面可以接提示符，-t后面可以接等待的秒数</p>
<p>declare：声明变量类型，declare [-aixr] variable，-a设置成array，-i设置为integer，-x与export功能相同，把变量设置为环境变量，-r设置为只读类型，不能变更或unset</p>
<p>变量数组的设置：var[1]&#x3D;”var 1”，读取的时候，需要通过echo ${var[1]}，注意是$加上大括号</p>
<h3 id="ulimit"><a href="#ulimit" class="headerlink" title="ulimit"></a>ulimit</h3><p>ulimit可以限制用户使用的内存大小，cpu时间以及同时打开的文件数量等等</p>
<h3 id="更改、删除变量"><a href="#更改、删除变量" class="headerlink" title="更改、删除变量"></a>更改、删除变量</h3><p>使用“${PATH#&#x2F;usr&#x2F;bin}”来删除变量内容，一个#表示删除符号替换文字的最短的哪一个（非贪婪匹配），两个##表示符合替换文字的最长的哪一个（贪婪匹配）</p>
<p>从后面开始删除是“${PATH%:*&#x2F;bin}”，同样一个%是非贪婪的删除，两个%是贪婪删除，%后面的内容是正则表达式</p>
<p>替换字符串：${PATH&#x2F;old&#x2F;new}，一个<code>/</code>表示替换第一个旧字符串，两个<code>/</code>表示全部替换</p>
<p>如果变量不存在则替换：<code>a=$&#123;username:-root&#125;</code>，:-root的意思就是如果username不存在那么就把a赋值为root，<code>：</code>的作用就是在username如果一开始就被赋值为空字符串的时候也可以用root替换</p>
<h3 id="设置命令别名"><a href="#设置命令别名" class="headerlink" title="设置命令别名"></a>设置命令别名</h3><p>alias：用法，<code>alias lm=“ls -l|more”</code></p>
<p>取消别名：<code>unalias xxx</code></p>
<h3 id="历史命令"><a href="#历史命令" class="headerlink" title="历史命令"></a>历史命令</h3><p>使用history可以列出历史命令</p>
<p>使用<code>！command</code>可以执行历史记录里面以command开头的命令</p>
<p>使用<code>！！</code>执行上一条命令</p>
<p>使用<code>！65</code>，执行历史记录里面的第65条指令</p>
<h3 id="设置终端机"><a href="#设置终端机" class="headerlink" title="设置终端机"></a>设置终端机</h3><p>stty -a：表示set tty，-a列出所有的内容</p>
<p><code>^</code>表示<code>ctrl</code>的意思</p>
<p>eof：表示end of file</p>
<p>erase：向后删除字符</p>
<p>intr：interrupt，终端</p>
<p>kill：删除目前命令行上的所有文字</p>
<p>quit：发出一个退出信号给正在运行的程序</p>
<p>susp：推送一个terminal stop信号给正在运行的程序</p>
<p>此外，我们还可以通过set来查看其他设置，<code>$-</code>这个变量包含了所有的set设置值</p>
<h3 id="标注输入输出流"><a href="#标注输入输出流" class="headerlink" title="标注输入输出流"></a>标注输入输出流</h3><ol>
<li>标准输入stdin：代码为0，使用<code>&lt;</code>或<code>&lt;&lt;</code></li>
<li>标准输出stdout：代码为1，使用<code>&gt;</code>或<code>&gt;&gt;</code></li>
<li>标准错误输出：代码为2，使用<code>2&gt;</code>或者<code>2&gt;&gt;</code></li>
</ol>
<p>输出标准输出和错误输出到同一个文件：<code>find /home -name .bashrc &gt; list 2&gt;&amp;1</code></p>
<p><code>&lt;&lt;</code>的作用是利用右侧的控制字，直到输入右侧的控制字之后自动退出输入，且文件中不会有右侧控制字那一行</p>
<h3 id="多命令同时执行"><a href="#多命令同时执行" class="headerlink" title="多命令同时执行"></a>多命令同时执行</h3><p><code>；</code>执行两个没有相关性的命令</p>
<p><code>cmd1&amp;&amp;cmd2</code>：若cmd1执行完毕且正确执行就继续执行cmd2</p>
<p><code>cmd1||cmd2</code>：若cmd1执行正确则cmd2不执行，若cmd1执行错误则执行cmd2</p>
<p>管道命令</p>
<p><code>|</code>：接受stdout的信息</p>
<h3 id="选取命令cut，grep"><a href="#选取命令cut，grep" class="headerlink" title="选取命令cut，grep"></a>选取命令cut，grep</h3><p>cut：类似于Python中的split，-d后接用于分离的字符串，-f表示去除第几个</p>
<p>grep：分析一行的信息，如果该行有我们需要寻找的信息，那么就将该行拿出来<code>grep [-acinv]  &#39;查找的字符串&#39; filename</code></p>
<h3 id="排序命令"><a href="#排序命令" class="headerlink" title="排序命令"></a>排序命令</h3><p><code>sort [-fbmnrtuk] [file or stdin]</code>：对文件或者stdin进行排序</p>
<p><code>uniq</code>：重复的数据只显示一个，类似与Python的set</p>
<p>wc：字数统计</p>
<p>双向重定向命令：tee，既输出到屏幕，又输出到文件</p>
<h3 id="字符转换命令"><a href="#字符转换命令" class="headerlink" title="字符转换命令"></a>字符转换命令</h3><p>tr（translate or delete characters）：-d删除文字，-s替换文字</p>
<p>col：-x将tab换成对等的空格键，-b文字内有反斜杠<code>/</code>时，仅显示反斜杠后接的那个字符</p>
<p>join：将两个文件中有相同数据的一行放到一起</p>
<p>paste：直接将两个文件粘到一起，且中间以[tab]隔开</p>
<p>expand：将tab转换为空格键</p>
<p>split：切割，将文件分割成多个大小相等的文件</p>
<p>xargs：在不支持管道命令的命令中提供参数</p>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>正则表达式依照不同的严谨度分为基础正则表达式与扩展正则表达式</p>
<h3 id="基础正则表达式"><a href="#基础正则表达式" class="headerlink" title="基础正则表达式"></a>基础正则表达式</h3><table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td><code>[:alnum:]</code></td>
<td>英文大小写字母及数字，<code>[a-z]</code>、<code>[A-Z]</code>、<a href="alpha%EF%BC%8Cnumber">0-9</a></td>
</tr>
<tr>
<td><code>[:alpha:]</code></td>
<td>大小写英文字母</td>
</tr>
<tr>
<td><code>[:blank:]</code></td>
<td>空格键与tab键</td>
</tr>
<tr>
<td><code>[:cntrl:]</code></td>
<td>键盘上面的控制键位，包括CR,TF,TAB,DEL等</td>
</tr>
<tr>
<td><code>[:digit:]</code></td>
<td>数字，[0-9]</td>
</tr>
<tr>
<td><code>[:graph:]</code></td>
<td>除了空格键和[TAB]键的其他所有按键</td>
</tr>
<tr>
<td><code>[:lower:]</code></td>
<td>小写字母，[a-z]</td>
</tr>
<tr>
<td><code>[:upper:]</code></td>
<td>大写字母，[A-Z]</td>
</tr>
<tr>
<td><code>[:print:]</code></td>
<td>任何可以被打印出来的字符</td>
</tr>
<tr>
<td><code>[:punct:]</code></td>
<td>标点符号(punctuation symbol)</td>
</tr>
<tr>
<td><code>[:space:]</code></td>
<td>任何会产生空白的字符，包括空白键[TAB]CR等</td>
</tr>
<tr>
<td><code>[:xdigit:]</code></td>
<td>十六进制的数字类型</td>
</tr>
</tbody></table>
<p>[^]表示取反，</p>
<p>^是行首，</p>
<p>$表示行尾，</p>
<p>*出现任意次，</p>
<p><code>\&#123;m,n\&#125;</code>出现m到n次(注意<code>&#123;&#125;</code>要进行转义)，</p>
<p>[abc]，从abc当中选一个</p>
<p>[^list]：选取除了list以外的字符串</p>
<h3 id="扩展正则表达式"><a href="#扩展正则表达式" class="headerlink" title="扩展正则表达式"></a>扩展正则表达式</h3><table>
<thead>
<tr>
<th>字符</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>+</td>
<td>重复一次及多次</td>
</tr>
<tr>
<td></td>
<td>零个或一个</td>
</tr>
<tr>
<td></td>
<td>用or的方法进行查找</td>
</tr>
<tr>
<td>（）</td>
<td>找出组字符串,比如查找good和glad，可以用&#96;egrep -n ‘g(oo</td>
</tr>
<tr>
<td>（）+</td>
<td>多个重复组的判断，比如查找A12121212c，可以用<code>egrep -n &#39;A(12)+c&#39;</code></td>
</tr>
</tbody></table>
<h3 id="文件格式化打印"><a href="#文件格式化打印" class="headerlink" title="文件格式化打印"></a>文件格式化打印</h3><p>使用的是printf，用法如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">printf &#x27;%10s\t %5i\t %s\t \8.2f&#x27; $(cat test.txt)</span><br></pre></td></tr></table></figure>

<h3 id="数据处理工具awk"><a href="#数据处理工具awk" class="headerlink" title="数据处理工具awk"></a>数据处理工具awk</h3><p>用法</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">awk &#x27;条件类型1&#123;动作1&#125; 条件类型2&#123;动作二&#125;……&#x27;</span><br></pre></td></tr></table></figure>

<p>比如要取出last里面的第一列和第三列</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">last -n 5 | awk &#x27;print $1 &quot;\t&quot; $3&#x27;</span><br></pre></td></tr></table></figure>

<h3 id="文件比较工具"><a href="#文件比较工具" class="headerlink" title="文件比较工具"></a>文件比较工具</h3><p><code>diff  a b</code>，得到的是左边文件a与右边文件b的差别</p>
<p>cmp：以字节进行比较</p>
<p>patch：<code>diff a b&gt; ab.patch</code>得到一个补丁文件，用于存放新旧文件的不同，用<code>patch -pN &lt; patch_file</code>更新，用<code>patch -R -pN &lt; patch_file</code>还原</p>
<h2 id="shell-script"><a href="#shell-script" class="headerlink" title="shell script"></a>shell script</h2><p>终于到了shell script这一个章节了，shell script是程序化脚本</p>
]]></content>
      <categories>
        <category>编程学习</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>剑指offer笔记</title>
    <url>/2017/11/20/%E5%89%91%E6%8C%87offer%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>离春招开始的时间已经不久了，因此最近开始在工作之余看看剑指offer这本书，了解更多关于算法相关的知识。</p>
<span id="more"></span>

<p>第一章主要是介绍面试流程等，该篇博文主要讲述从第二章开始的编程知识相关的内容。</p>
<h3 id="第二章"><a href="#第二章" class="headerlink" title="第二章"></a>第二章</h3><h4 id="c"><a href="#c" class="headerlink" title="c++"></a>c++</h4><ol>
<li><p>对空类型求sizeof，结果是多少？<br>答：答案是1，本来应该是0，但是声明实例的时候，必须在内存中占有一定的空间，占多少内存由编译器决定。在visual studio中，每个空类型实例占用1字节的空间</p>
</li>
<li><p>如果添加构造函数和析构函数，再求sizeof的结果是多少？</p>
<p>答：还是1，因为调用构造函数和析构函数只需要知道函数的地址即可，函数地址与类型相关，而与类型的实例无关，编译器不会因为这两个函数在实例内添加任何额外的信息。</p>
</li>
<li><p>如果把析构函数标记为虚函数呢？</p>
<p>答：c++中一旦出现虚函数，就会为该类型生成虚函数表，并在每个实例中添加一个指向虚函数表的指针。在32位机器上一个指针占用4字节，因此结果是4；在64位机器上一个指针占用8字节，因此结果是8.</p>
</li>
</ol>
<p>给出下面代码的运行结果</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="type">int</span> value;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	<span class="built_in">A</span>(<span class="type">int</span> n)&#123;value=n&#125;;</span><br><span class="line">    	<span class="built_in">A</span>(A other)&#123;value=other.value&#125;</span><br><span class="line">    <span class="type">void</span> <span class="built_in">Print</span>()&#123;</span><br><span class="line">        std::cout&lt;&lt; value &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">        A a = <span class="number">10</span>;</span><br><span class="line">        A b = a;</span><br><span class="line">        b.<span class="built_in">Print</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果是<strong>编译错误</strong>，原因是因为在第二个构造函数中，用了一个实例来初始化另外的实例，但是c++函数的值传递过程中，是需要复制参数为形参的，复制参数位形参的过程就需要调用构造函数，那就相当于在调用构造函数的过程中需要调用构造函数，因此陷入递归调用，编译报错。</p>
<p>要解决这种问题，我们可以使用引用参数传递，这样不会复制参数，就不会报错，构造函数修改为A(const A&amp; other)</p>
<h5 id="面试题1：赋值运算符函数"><a href="#面试题1：赋值运算符函数" class="headerlink" title="面试题1：赋值运算符函数"></a>面试题1：赋值运算符函数</h5><p>定义如下类型，要求重写他的等号赋值运算符</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CMyString</span>&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	<span class="built_in">CMyString</span>(<span class="type">char</span> *pData=<span class="literal">nullptr</span>);</span><br><span class="line">        <span class="built_in">CMyString</span>(<span class="type">const</span> CMyString&amp; str);</span><br><span class="line">        ~<span class="built_in">CMyString</span>(<span class="type">void</span>);</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	<span class="type">char</span>* m_pData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要考四个方面：</p>
<ol>
<li>只有返回一个引用才可以连续赋值，否则str1&#x3D;str2&#x3D;str3这种赋值将无法通过</li>
<li>传入参数是否声明为引用，如果传入参数是引用就不用复制参数，这样能提高代码效率，如果不改变传入实例的状态，应该在传入的引用参数之前加入const</li>
<li>是否释放自身内存，如果在分配新内存之前释放自身空间，则程序将出现内存泄漏</li>
<li>判断传入的参数和当前的实例是不是同一个实例，如果是同一个实例，不赋值，直接返回。如果不判断，在释放自身内存的时候，就把赋值的对象给释放了。</li>
</ol>
<p>经典解法：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">CMyString&amp; CMyString::<span class="keyword">operator</span>=(<span class="type">const</span> CMyString&amp; str)&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>== &amp;str)&#123;</span><br><span class="line">        <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> []m_pData;</span><br><span class="line">    m_pData = <span class="literal">nullptr</span>;</span><br><span class="line">    </span><br><span class="line">    m_pData = <span class="keyword">new</span> <span class="type">char</span>[<span class="built_in">strlen</span>(str.m_pData)+<span class="number">1</span>];<span class="comment">//加1的原因是：strlen出来的结果是不带终止符号\0的结果，但是在c++中存储字符串需要存储结束符\0,因此+1</span></span><br><span class="line">    <span class="built_in">strcpy</span>(m_pData, str.m_pData);</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;       </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>常用的数据结构必须掌握：数组，字符串，链表，树，栈，队列</p>
<p>其中数组和字符串是两种最基本的数据结构</p>
<h4 id="数组"><a href="#数组" class="headerlink" title="数组"></a>数组</h4><p>数组内存连续，因此可以在O(1)时间内读写任何元素，时间效率很高，因此可以用来实现简单的哈希表，数组下标设为哈希表的key，数组中的数字设为value，形成键值对。</p>
<p>数组空间效率不高，因为一旦你定义了数组，那么整个数组占用的内存空间就无法被利用，因此STL中定义了vector这种动态数组，一开始分配一个小空间，每次往里面添加元素，当空间不够的时候，新开辟一块内存空间，大小是原来的2倍，把数据拷贝过来，并释放原先的内存空间。</p>
<p><strong>数组与指针</strong></p>
<p>c&#x2F;c++中，数组的名字也是一个指针，指向数组的第一个元素</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">GetSize</span><span class="params">(<span class="type">int</span> data[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">sizeof</span>(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> data1[] = &#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;;</span><br><span class="line">    <span class="type">int</span> size1 = <span class="built_in">sizeof</span>(data1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;size1:&quot;</span>&lt;&lt;size1&lt;&lt;endl;</span><br><span class="line">    <span class="type">int</span> *data2 = data1;</span><br><span class="line">    <span class="type">int</span> size2 = <span class="built_in">sizeof</span>(data2);</span><br><span class="line">    <span class="type">int</span> size3 = <span class="built_in">GetSize</span>(data1);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;size2:&quot;</span>&lt;&lt;size2&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt; <span class="string">&quot;size3:&quot;</span> &lt;&lt;size3&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述结果为:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">size1:<span class="number">20</span></span><br><span class="line">size2:<span class="number">8</span></span><br><span class="line">size3:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>因为数组每一个元素占4个字节，5个元素的数字就是20个字节</p>
<p>指针data2虽然指向数组data1，但是其本身还是个指针，因此sizeof(data2)结果是8（64位系统一个指针占8个字节，32位系统一个字节占4个字节）</p>
<p>在GetSize函数的情况中，data1通过参数传入函数，数组自动退化为指针，因此结果为一个指针的大小8；</p>
<h5 id="面试题3：查找数组中的重复的数字"><a href="#面试题3：查找数组中的重复的数字" class="headerlink" title="面试题3：查找数组中的重复的数字"></a>面试题3：查找数组中的重复的数字</h5><blockquote>
<p>在一个长度为n的数组里的所有数字都在0到n-1的范围内。数组中某些数字是重复的，但不知道有几个数字重复了，也不知道每个数字重复的次数。请找出数组中任意一个重复的数字。例如如果输入长度为7的数组{},那么对应的输出是重复的数字2或者3。 </p>
</blockquote>
<p>解答：解决这个问题最简单的方法就是先排序，然后从头到尾扫描数组，如果第i个值与第i+1个值相等则有重复，排序一个长度为n的数组的时间复杂度是O(nlogn)，下面是为什么排序算法的复杂度是O(nlogn)</p>
<blockquote>
<p>a1,a2,a3……an排序总共有n！总结果，（其中a1’&lt;&#x3D;a2’&lt;&#x3D;a3’……&lt;&#x3D;an’）所占的概率是1&#x2F;n!，每进行一次比较，就是在这n！种结果中进行二分，接着选择一个二分结果进行下一次二分，直到找到想要的排序。排序算法能不能自顶向下构造出一棵决策树？因为我们讨论的是基于输入元素的比较排序，每一次比较的返回不是0就是1，这恰好可以作为决策树的一个决策将一个事件分成两个分支。比如冒泡排序时通过比较a1和a2两个数的大小可以把序列分成a1,a2……an与a2,a1……an（气泡a2上升一个身位）两种不同的结果，因此比较排序也可以构造决策树。根节点代表原始序列a1,a2,a3……an，所有叶子节点都是这个序列的重排（共有n!个，其中有一个就是我们排序的结果a1’,a2’,a3’……an’）。如果每次比较的结果都是等概率的话（恰好划分为概率空间相等的两个事件），那么二叉树就是高度平衡的，深度至少是log(n!)。又因为log(n!)的增长速度与 nlogn 相同,即 log(n!)&#x3D;Θ(nlogn)，这就是通用排序算法的最低时间复杂度O(nlogn)的依据。</p>
<p>证明log(n!)&#x3D;Θ(nlogn)等价于证明①、②</p>
<p>①log(n!)&#x3D;O(nlogn)<br>显然n!&lt;n^n，两边取对数就得到log(n!)&lt;nlog(n)。</p>
<p>②log(n!)&#x3D;Ω(nlogn)<br>n!&#x3D;n(n-1)(n-2)(n-3)…1，把前n&#x2F;2个因子（都大于n&#x2F;2）全部缩小到n&#x2F;2，后n&#x2F;2个因子全部舍去，得<br>n!&gt;(n&#x2F;2)^(n&#x2F;2)。两边取对数，log(n!)&gt;(n&#x2F;2)log(n&#x2F;2)，后者即Ω(nlogn)。</p>
</blockquote>
<p>第二个方法是利用一个哈希表，每扫描到一个数字，如果哈希表里面没有这个数字，就把他加入哈希表，如果已经有该数字，那么就找到了重复的数字，此方法的时间复杂度为O(n)，但是提高时间效率的方法是以一个O(n)大小的哈希表为代价的，再看看有没有空间复杂度为O(1)的算法</p>
<p>因为数字都在0~n-1范围内，如果数组中没有重复的数字，那么排序后i这个数字应该出现在第i个位置，从头到尾扫描数组，扫到第i个数字，比较当前数字m与下标i是否相等，是则扫描下一个数字，否则交换m个和第m个元素。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_duplicate</span>(<span class="params">lists</span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lists)):</span><br><span class="line">        <span class="keyword">while</span> lists[i] != i:</span><br><span class="line">            <span class="keyword">if</span> lists[i] == lists[lists[i]]:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            a = lists[i]</span><br><span class="line">            lists[i],lists[a] = lists[a], lists[i]</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(get_duplicate([<span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>,<span class="number">0</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">3</span>]))</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">dupNum</span><span class="params">(<span class="type">int</span>[] nums)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="keyword">while</span> (nums[i]!=i)&#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i]==nums[nums[i]])&#123;</span><br><span class="line">                <span class="keyword">return</span> nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> nums[i];</span><br><span class="line">            nums[i] = nums[temp];</span><br><span class="line">            nums[temp] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<ol start="2">
<li><p>在一个长度为n+1的数组里的所有数字都在1~n的范围内，所以数组中至少有一个数字是重复的。请找出数组中任意一个重复的数字，但是<strong>不能修改输入的数组</strong>。例如，如果输入长度为8的数组{2,3,5,4,3,2,6,7}，那么对应的输出是重复的数字2或者3。</p>
<p>解答：与上一题很像，但是题目要求不能修改数组，因此不能用上一题最后一个方法。同样这道题可以用一个大小为n的辅助空间。</p>
<p>接下来尝试使用避免O(n)辅助空间的方法，那就是二分法。既然所有数字都在1<del>n之间，如果有重复的数字，那么这个重复数字要么在1</del>n&#x2F;2之间，或者在(n+1)&#x2F;2<del>n之间。将1-n通过中间值m分成两部分：1</del>m和m+1~n，判断在哪个区间的方法就是判断区间中数字的数量和区间长度，如果数量小于区间长度，那么证明重复值不在当前区间，反之则反之，判断数字的数量的方法就是遍历一遍数组。这样不停地分下去，直到区间的start和end相等的时候，如果这个值出现的次数还是&gt;1，那么这个值就是重复的值。</p>
<p>二分查找有个问题就是：不一定能找到所有重复的数字，比如{2,2,3,4}这样一个数组，二分之后1,2之间值的个数是2，不会认为这个区间有重复</p>
</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法1</span></span><br><span class="line"><span class="comment"># 用O(n)的辅助数组</span></span><br><span class="line"><span class="comment"># def get_duplicate_num(l):</span></span><br><span class="line"><span class="comment">#     l1 = [0 for _ in range(len(l))]</span></span><br><span class="line"><span class="comment">#     for i in l:</span></span><br><span class="line"><span class="comment">#         l1[i] += 1</span></span><br><span class="line"><span class="comment">#         if l1[i] &gt; 1:</span></span><br><span class="line"><span class="comment">#             return i</span></span><br><span class="line"><span class="comment">#     return False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2： 二分查找</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_duplicate_num</span>(<span class="params">l</span>):</span><br><span class="line">    start = <span class="number">1</span></span><br><span class="line">    end = <span class="built_in">len</span>(l)</span><br><span class="line">    <span class="keyword">while</span> start &lt;= end:</span><br><span class="line">        middle = (end+start)//<span class="number">2</span></span><br><span class="line">        count = computeCount(l,start,middle)</span><br><span class="line">        <span class="keyword">if</span> start == end:</span><br><span class="line">            <span class="keyword">if</span> count &gt; <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> start</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> count &gt; middle - start + <span class="number">1</span>:</span><br><span class="line">            end = middle</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            start = middle + <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">computeCount</span>(<span class="params">l,start,end</span>):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> l:</span><br><span class="line">        <span class="keyword">if</span> start &lt;= i &lt;= end:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(get_duplicate_num([<span class="number">2</span>,<span class="number">3</span>,<span class="number">5</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">7</span>]))</span><br></pre></td></tr></table></figure>

<h4 id="面试题4：二维数组中的查找"><a href="#面试题4：二维数组中的查找" class="headerlink" title="面试题4：二维数组中的查找"></a>面试题4：二维数组中的查找</h4><blockquote>
<p>在一个二维数组中，每一行都按照从左到右递增的顺序排序，每一列都按照从上到下递增的顺序排序。</p>
<p>请完成一个函数，输入这样的一个二维数组和一个整数，判断数组中是否含有该整数。</p>
</blockquote>
<p>我们一开始的想法很可能是，按顺序遍历数组，如果当前数字比目标数字小，那么目标数字应该在当前数字的右边或者下面，如果比当前数字小，应该在目标的左边或上面，如果我们从第一个值开始，发现比目标数字小，从这里选择右边还是下面便成了一个难题。</p>
<p>这道题目的关键是：从右上角的数字开始比较，因为右上角这个数字，比它大就往下，比它小就往左，这样不会存在分歧的路径，题目就变得简单了</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getNumFromArray</span>(<span class="params">l, num</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> l:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    row = <span class="number">0</span></span><br><span class="line">    column = <span class="built_in">len</span>(l[<span class="number">0</span>])-<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> row &lt; <span class="built_in">len</span>(l) <span class="keyword">and</span> column &gt;= <span class="number">0</span>:</span><br><span class="line">       <span class="keyword">if</span> num &gt; l[row][column]:</span><br><span class="line">           row += <span class="number">1</span></span><br><span class="line">       <span class="keyword">elif</span> num &lt; l[row][column]:</span><br><span class="line">           column -= <span class="number">1</span></span><br><span class="line">       <span class="keyword">else</span>:</span><br><span class="line">           <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(getNumFromArray([[<span class="number">1</span>,<span class="number">2</span>,<span class="number">8</span>,<span class="number">9</span>],[<span class="number">2</span>,<span class="number">4</span>,<span class="number">9</span>,<span class="number">12</span>],[<span class="number">4</span>,<span class="number">7</span>,<span class="number">10</span>,<span class="number">13</span>],[<span class="number">6</span>,<span class="number">8</span>,<span class="number">11</span>,<span class="number">15</span>]],<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<p>java版：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">Find</span><span class="params">(<span class="type">int</span> target, <span class="type">int</span>[][] array)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (array == <span class="literal">null</span> || array.length == <span class="number">0</span> || array[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span> <span class="variable">row</span> <span class="operator">=</span> <span class="number">0</span>, col = array[<span class="number">0</span>].length - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (row &lt; array.length &amp;&amp; col &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (target == array[row][col]) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (target &lt; array[row][col]) &#123;</span><br><span class="line">                col--;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                row++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>在c++中，字符串是以<code>\0</code>结束的，因此如果复制一个长度为10的字符串，需要初始化一个长度为11的char数组</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> str[<span class="number">11</span>];</span><br><span class="line"><span class="built_in">strcpy</span>(str,<span class="string">&quot;0123456789&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="面试题5：替换空格"><a href="#面试题5：替换空格" class="headerlink" title="面试题5：替换空格"></a>面试题5：替换空格</h4><blockquote>
<p> 请实现一个函数，把字符串中的每个空格替换成”%20”。例如输入“We are happy.”，则输出“We%20are%20happy.”。　</p>
</blockquote>
<p>在网络编程中，如果URL参数中含有特殊字符，如空格、’#’等，可能导致服务器端无法获得正确的参数值。我们需要将这些特殊符号转换成服务器可以识别的字符。转换的规则是在’%’后面跟上ASCII码的两位十六进制的表示。比如空格的ASCII码是32，即十六进制的0x20，因此空格被替换成”%20”。再比如’#’的ASCII码为35，即十六进制的0x23，它在URL中被替换为”%23”。</p>
<p>在python中实现这个问题的方法可以直接调用replace或者是用一个新的字符串，如果当前字符串等于空格，则加<code>%20</code>否则加上当前值，但这样会使用一个O(n)的辅助字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">replaceBlank</span>(<span class="params">string</span>):</span><br><span class="line">    <span class="comment"># return string.replace(&#x27; &#x27;,&#x27;%20&#x27;)</span></span><br><span class="line">    result = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</span><br><span class="line">        <span class="keyword">if</span> i==<span class="string">&#x27; &#x27;</span>:</span><br><span class="line">            result+=<span class="string">&#x27;%20&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            result+=i</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(replaceBlank(<span class="string">&quot;we are family&quot;</span>))</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">replaceSpace</span><span class="params">(StringBuffer str)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.charAt(i) == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">finalLength</span> <span class="operator">=</span> str.length() + count * <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldIndex</span> <span class="operator">=</span> str.length() - <span class="number">1</span>;</span><br><span class="line">    str.setLength(finalLength);</span><br><span class="line">    <span class="type">int</span> <span class="variable">newIndex</span> <span class="operator">=</span> str.length() - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (oldIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (str.charAt(oldIndex) == <span class="string">&#x27; &#x27;</span>) &#123;</span><br><span class="line">            str.setCharAt(newIndex--, <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            str.setCharAt(newIndex--, <span class="string">&#x27;2&#x27;</span>);</span><br><span class="line">            str.setCharAt(newIndex--, <span class="string">&#x27;%&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            str.setCharAt(newIndex--, str.charAt(oldIndex));</span><br><span class="line">        &#125;</span><br><span class="line">        oldIndex--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在C++当中解决这个问题的方法是：用两个index，先遍历字符串算出空格的数量，求出字符串长度和更改之后的字符串长度，p1指向原始数据的结束字符，p2指向替换之后数据的结束字符，p1每次往前走一格，p2每次复制p1当前值并同时往前走一格，如果遇到空格则p2加入<code>%20</code>三个字符，而p1往前走一格，直到p1和p2相等或p1为0。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/20181127111133.png"></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="type">static</span> <span class="type">void</span> <span class="title">ReplaceBlank</span><span class="params">(<span class="type">char</span>[] target, <span class="type">int</span> maxLength)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (target == null || maxLength &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// originalLength 为字符串target的实际长度</span></span><br><span class="line">    <span class="type">int</span> originalLength = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> blankCount = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (target[i] != <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        originalLength++;</span><br><span class="line">        <span class="comment">// 计算空格数量</span></span><br><span class="line">        <span class="keyword">if</span> (target[i] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            blankCount++;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// newLength 为把空格替换成&#x27;%20&#x27;之后的长度</span></span><br><span class="line">    <span class="type">int</span> newLength = originalLength + <span class="number">2</span> * blankCount;</span><br><span class="line">    <span class="keyword">if</span> (newLength &gt; maxLength)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置两个指针，一个指向原始字符串的末尾，另一个指向替换之后的字符串的末尾</span></span><br><span class="line">    <span class="type">int</span> indexOfOriginal = originalLength;</span><br><span class="line">    <span class="type">int</span> indexOfNew = newLength;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (indexOfOriginal &gt;= <span class="number">0</span> &amp;&amp; indexOfNew &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (target[indexOfOriginal] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            target[indexOfNew--] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            target[indexOfNew--] = <span class="string">&#x27;2&#x27;</span>;</span><br><span class="line">            target[indexOfNew--] = <span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            target[indexOfNew--] = target[indexOfOriginal];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        indexOfOriginal--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这道题给我们的启发：如果合并两个字符串或者是数组的时候，从前往后合并往往会需要复制很多次，那么我们可以从后往前合并。</p>
<h4 id="链表"><a href="#链表" class="headerlink" title="链表"></a>链表</h4><p>链表是面试中最常出现的数据结构。</p>
<p>链表的空间是用到的时候再分配的，因此空间效率比数组要高。</p>
<p>单向链表的定义如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span>&#123;</span><br><span class="line">    <span class="type">int</span> m_nValue;</span><br><span class="line">    ListNode* m_pNext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在链表后面添加一个元素的方法如下：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">addToTail</span><span class="params">(ListNode** pHead, <span class="type">int</span> value)</span></span>&#123;</span><br><span class="line">    ListNode* pNew = <span class="keyword">new</span> <span class="built_in">ListNode</span>();</span><br><span class="line">    pNew-&gt;m_nValue = value;</span><br><span class="line">    PNew-&gt;m_pnext = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span>(*pHead==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        *head = pNew;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        ListNode* pNode = *pHead;</span><br><span class="line">        <span class="keyword">while</span>(pNode-&gt;m_pNext!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">            pNode = pNode-&gt;m_pNext;</span><br><span class="line">        &#125;</span><br><span class="line">        pNode-&gt;m_pnext = pNew;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：上面函数的第一个参数，用的是指针的指针，其原因是当pHead为nullptr的时候，要改变pHead的指向，如果传递一个指针的话，只能改变指针指向的对象的值，而不是直接改变他指的地址。</p>
<p>在链表中找到并删除某个元素：</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">RemoveNode</span><span class="params">(ListNode** pHead, <span class="type">int</span> value)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pHead==<span class="literal">nullptr</span> || *pHead==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ListNode* pToBeDeleted = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span> ((*pHead)-&gt;mvalue==value)&#123;</span><br><span class="line">    	pToBeDeleted=*pHead;</span><br><span class="line">        *pHead=(*pHead)-&gt;m_pNext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        ListNode* pNode = *pHead;</span><br><span class="line">        <span class="keyword">while</span>(pNode-&gt;m_pNext != <span class="literal">nullptr</span> &amp;&amp; pNode-&gt;m_pNext-&gt;m_value!=value)&#123;</span><br><span class="line">            pNode = pNode-&gt;m_pNext;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(pNode-&gt;m_pNext!=<span class="literal">nullptr</span> &amp;&amp; pNode-&gt;m_pNext-&gt;mvalue==value)&#123;</span><br><span class="line">            pToBeDeleted = pNode-&gt;m_pNext;</span><br><span class="line">            pNode-&gt;m_pNext = pToBeDeleted-&gt;m_pNext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(pToBeDeleted!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        <span class="keyword">delete</span> pToBeDeleted;</span><br><span class="line">        pTobeDeleted = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题6：链表从尾到头打印"><a href="#面试题6：链表从尾到头打印" class="headerlink" title="面试题6：链表从尾到头打印"></a>面试题6：链表从尾到头打印</h5><blockquote>
<p>输入一个链表的头结点，从尾到头反过来打印出每个节点的值</p>
</blockquote>
<p>链表的定义如下</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span>&#123;</span><br><span class="line">    <span class="type">int</span> m_nKey;</span><br><span class="line">    ListNode* m_pN</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>思路：通常来说，链表只能从前到后访问，如果要从后往前打印，那么我们可以利用堆栈，每遍历一个链表节点，我们将他的值放在栈中，因为栈是后进先出的特性，最后将所有元素出栈，打印即可。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintReverseList</span><span class="params">(ListNode *pHead)</span></span>&#123;</span><br><span class="line">    std::stack&lt;*ListNode&gt; nodes;</span><br><span class="line">    ListNode* pNode = pHead;</span><br><span class="line">    <span class="keyword">while</span>(pNode != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">        nodes.<span class="built_in">push</span>(pNode);</span><br><span class="line">        pNode = pNode-&gt;m_pNext;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span>(!nodes.<span class="built_in">empty</span>())&#123;</span><br><span class="line">        pNode = nodes.<span class="built_in">top</span>();</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&#x27;%d\t&#x27;</span>,pNode-&gt;m_nValue);</span><br><span class="line">        nodes.<span class="built_in">pop</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然用到了堆栈，那么就自然想到了递归，因为递归调用本质就是使用堆栈，递归的链表反转打印方法如下</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintReverseList</span><span class="params">(ListNode *pHead)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(pHead!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="built_in">PrintReverseList</span>(pHead-&gt;next);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&#x27;%d\t&#x27;</span>,pHead-&gt;m_nValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="链表反转"><a href="#链表反转" class="headerlink" title="链表反转"></a>链表反转</h5><p>链表反转和上面的思路基本一样，就是递归</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">ListNode* <span class="title">ReverseList</span><span class="params">(ListNode* pHead)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pHead==<span class="literal">nullptr</span>||pHead-&gt;next==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> pHead;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ListNode *newHead = <span class="built_in">ReverseList</span>(pHead-&gt;next);</span><br><span class="line">    pHead-&gt;next-&gt;next = pHead;</span><br><span class="line">    pHead-&gt;next=<span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">return</span> newHead;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java版：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">ReverseList</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (head == <span class="literal">null</span> || head.next==<span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">newHead</span> <span class="operator">=</span> ReverseList(head.next);</span><br><span class="line">  head.next.next = head;</span><br><span class="line">  head.next = <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">return</span> newHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释：翻转 [head, n1, n2, n3, …]，等于先翻转 [n1, n2, n3, …] ，再把 head 放到最后<br>head.next 就是 [n1, n2, n3, …]，翻转就是 reverseList(head.next)，结果是 […, n3, n2, n1]，注意 head.next 现在仍然指向 n1，也就是最后<br>所以，next_node &#x3D; head.next 等于 next_node 赋值为 n1，也就是末尾的结点<br>然后 next_node.next &#x3D; head，就是构造 […, n3, n2, n1, head]<br>head.next &#x3D; None，就是把 head 指向 n1 去掉，就翻转了</p>
<p>非递归：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//非递归</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title function_">ReverseList1</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (head==<span class="literal">null</span> || head.next==<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">pre</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">cur</span> <span class="operator">=</span> head;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">next</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (cur!=<span class="literal">null</span>)&#123;</span><br><span class="line">    next=cur.next;</span><br><span class="line">    cur.next = pre;</span><br><span class="line">    pre = cur;</span><br><span class="line">    cur = next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pre;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="树"><a href="#树" class="headerlink" title="树"></a>树</h4><p>树是实际编程中常用的数据结构。它的逻辑很简单：除根节点外的所有节点都只有一个父节点，根节点没有父节点；除叶子节点外的所有节点都有一个或多个子节点，叶子节点没有子节点。父节点和子节点通过指针连接。</p>
<p>因为树的操作涉及大量的指针操作，因此关于树的面试题难度较大。</p>
<p>面试中提到的树大部分是二叉树。二叉树是一种特殊的树结构，每个节点最多只能有两个子节点。二叉树中最重要的操作就是遍历：</p>
<ul>
<li>前序遍历：先访问根节点，再访问左子节点，最后访问右子节点</li>
<li>中序遍历：先访问左子节点，再访问根节点，最后访问右子节点</li>
<li>后序遍历，先访问左子节点，再访问右子节点，最后访问根节点</li>
</ul>
<p>这个前中后都是相对于根节点来说的，前就是先遍历跟节点，中就是根节点在中间，后就是根节点在最后。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/20181206152439.png"></p>
<p>如上的二叉树，我们对其进行上述三种遍历：</p>
<ul>
<li>前序遍历：10,6,4,8,14,12,16</li>
<li>中序遍历：4,6,8,10,12,14,16</li>
<li>后序遍历：4,8,6,12,16,14,10</li>
</ul>
<p>这3种遍历，都有递归和循环两种方法，递归实现比循环简洁，要求<strong>3种遍历的6种实现方法都要掌握</strong>。</p>
<p>二叉树有很多特例，<strong>二叉搜索树</strong>就是其中之一。二叉搜索树中左子节点总是小于等于根节点，右子节点总是大于等于根节点。这就可以在O(logn)的时间内根据数值找到一颗二叉搜索树的一个节点，</p>
<p>二叉树还有两个特例是，<strong>堆</strong>和<strong>红黑树</strong>。</p>
<p>堆分为最大堆和最小堆，最大队中根节点的值最大。最大堆中根节点的值最大，最小堆中根节点的值最小。有很多需要找到最大最小值的问题可以用堆来解决。</p>
<p>红黑树是把树中的节点定义为红黑两种颜色，并通过规则确保从根节点到叶节点的最长路径的长度不超过最短路径的两倍。</p>
<h5 id="面试题7：重建二叉树"><a href="#面试题7：重建二叉树" class="headerlink" title="面试题7：重建二叉树"></a>面试题7：重建二叉树</h5><blockquote>
<p>输入某二叉树的前序遍历和中序遍历的结果，请重建出该二叉树。假设输入的前序遍历和中序遍历的结果中都不含重复的数字。例如输入前序遍历序列{1,2,4,7,3,5,6,8}和中序遍历序列{4,7,2,1,5,3,8,6}，则重建二叉树并返回。</p>
</blockquote>
<p>先理一下这道题的思路，有两个重要信息：①前序遍历的第一个值必然是根节点；②中序遍历中，根节点左边的值必然是左子树，根节点右边的值必然是右子树。那么只要给定一个前序遍历和中序遍历，我们就可以找到他的根节点和左右子树，这样只要递归下去，就能构建出整棵树。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">BinaryTreeNode* <span class="title">Construct</span><span class="params">(<span class="type">int</span>* preorder, <span class="type">int</span>* inorder, <span class="type">int</span> length)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(preorder== <span class="literal">nullptr</span>|| inorder== <span class="literal">nullptr</span>|| length &lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">ConstructCore</span>(preorder, preorder+length<span class="number">-1</span>, inorder, inorder+length<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">BinaryTreeNode* <span class="title">ConstructCore</span><span class="params">(<span class="type">int</span>* StartPreorder, <span class="type">int</span>* EndPreorder, <span class="type">int</span>* StartInorder, <span class="type">int</span>* EndInorder)</span></span>&#123;</span><br><span class="line">    <span class="comment">//前序遍历的第一个值是根节点</span></span><br><span class="line">    <span class="type">int</span> rootValue = *StartPreorder;</span><br><span class="line">    BinaryTreeNode* root = <span class="keyword">new</span> <span class="built_in">BinaryTreeNode</span>();</span><br><span class="line">    root-&gt;mValue = rootValue;</span><br><span class="line">    root-&gt;left = <span class="literal">nullptr</span>;</span><br><span class="line">    root-&gt;right = <span class="literal">nullptr</span>;</span><br><span class="line">    <span class="keyword">if</span>(StartPreorder == EndPreorder)&#123;</span><br><span class="line">        <span class="keyword">if</span>(StartInorder==EndInorder &amp;&amp; *StartPreorder==*StartInorder)&#123;</span><br><span class="line">            <span class="keyword">return</span> root;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;invalid input&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//在中序遍历中找到根节点的值</span></span><br><span class="line">    <span class="type">int</span>* rootInorder = StartInorder;</span><br><span class="line">    <span class="keyword">while</span> (rootInorder&lt;=EndInorder &amp;&amp; *rootInorder!=rootValue)&#123;</span><br><span class="line">        ++rootInorder;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (rootInorder==EndInorder &amp;&amp; *rootInorder!=rootValue)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="built_in">runtime_error</span>(<span class="string">&quot;invalid input&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> leftLength = rootInorder - StartInorder;</span><br><span class="line">    <span class="type">int</span>* leftPreorderEnd = StartPreorder + leftLength;</span><br><span class="line">    <span class="keyword">if</span> (leftLength &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        root-&gt;left = <span class="built_in">ConstructCore</span>(StartPreorder+<span class="number">1</span>,leftPreorderEnd, StartInorder, rootInorder<span class="number">-1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (leftLength &lt; EndPreorder - StartPreorder)&#123;</span><br><span class="line">        root-&gt;right = <span class="built_in">ConstructCore</span>(leftPreorderEnd+<span class="number">1</span>,EndPreorder,rootInorder+<span class="number">1</span>,EndInorder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下面是python版本的代码：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回构造的TreeNode根节点</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reConstruct</span>(<span class="params">self, pre_t, tin_t</span>):</span><br><span class="line">        rootValue = pre_t[<span class="number">0</span>]</span><br><span class="line">        root = TreeNode(rootValue)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pre_t) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(pre_t) == <span class="number">1</span> <span class="keyword">and</span> <span class="built_in">len</span>(tin_t) == <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> root</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> v <span class="keyword">in</span> tin_t:</span><br><span class="line">            <span class="keyword">if</span> v == rootValue:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> v != rootValue:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">0</span>:</span><br><span class="line">            root.left = self.reConstruct(pre_t[<span class="number">1</span>:i+<span class="number">1</span>], tin_t[:i])</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pre_t)-<span class="number">1</span> &gt; i:</span><br><span class="line">            root.right = self.reConstruct(pre_t[i+<span class="number">1</span>:], tin_t[i+<span class="number">1</span>:])</span><br><span class="line">        <span class="keyword">return</span> root</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reConstructBinaryTree</span>(<span class="params">self, pre, tin</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pre) == <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(tin) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.reConstruct(pre, tin)</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TreeNode <span class="title function_">reConstructBinaryTree</span><span class="params">(<span class="type">int</span>[] pre, <span class="type">int</span>[] in)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> reConstructBinaryTree(pre, <span class="number">0</span>, pre.length - <span class="number">1</span>, in, <span class="number">0</span>, in.length - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> TreeNode <span class="title function_">reConstructBinaryTree</span><span class="params">(<span class="type">int</span>[] pre, <span class="type">int</span> preStart, <span class="type">int</span> preEnd, <span class="type">int</span>[] in, <span class="type">int</span> inStart, <span class="type">int</span> inEnd)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (preStart &gt; preEnd || inStart &gt; inEnd) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">int</span> <span class="variable">rootVal</span> <span class="operator">=</span> pre[preStart];</span><br><span class="line">  <span class="type">TreeNode</span> <span class="variable">root</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TreeNode</span>(rootVal);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> inStart; i &lt; inEnd; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (in[i] == rootVal) &#123;</span><br><span class="line">      root.left = reConstructBinaryTree(pre, preStart + <span class="number">1</span>, preStart + i - inStart, in, inStart, i-<span class="number">1</span>);</span><br><span class="line">      root.right = reConstructBinaryTree(pre, preStart + <span class="number">1</span> + i - inStart, preEnd, in, i + <span class="number">1</span>, inEnd);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="面试题8：二叉树的下一个节点"><a href="#面试题8：二叉树的下一个节点" class="headerlink" title="面试题8：二叉树的下一个节点"></a>面试题8：二叉树的下一个节点</h5><blockquote>
<p>给定一棵二叉树和其中的一个结点，请找出中序遍历顺序的下一个结点并且返回。注意，树中的结点不仅包含左右子结点，同时包含指向父结点的指针。</p>
</blockquote>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/20181211162225.png"></p>
<p>思路：这道题就是一个分情况讨论的方法：</p>
<ol>
<li>如果一个节点有右子树，那么右子树的最左下子树就是下一个节点<br>如上图：b的下一个节点就是其右子树e的最左子节点h</li>
<li>如果一个节点没有右子树，但它本身是其父节点的左子树，那么下一个节点就应该是它的父节点<br>如上图：h的下一个节点是e</li>
<li>如果一个节点没有右子树，且是父节点的右子节点，那么就一直向上遍历，直到找到一个节点的父节点的左子节点是自己，那么就返回这个父节点，如果遍历到根节点还是空，那么就返回空<br>如上图：i没有右子树，且不是父节点的左子节点，i的下一个节点就要向上搜索，找到e，e不是b的左子节点，继续向上，找到b，b是a的左子节点，因此返回b的父节点a</li>
</ol>
<p>下面是python版本的实现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetNext</span>(<span class="params">self, pNode</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pNode:</span><br><span class="line">            <span class="keyword">return</span> pNode</span><br><span class="line">        <span class="keyword">if</span> pNode.right:</span><br><span class="line">            newNode = pNode.right</span><br><span class="line">            <span class="keyword">while</span> newNode.left:</span><br><span class="line">                newNode = newNode.left</span><br><span class="line">            <span class="keyword">return</span> newNode</span><br><span class="line">        <span class="keyword">if</span> pNode.<span class="built_in">next</span>:</span><br><span class="line">            <span class="keyword">while</span> pNode.<span class="built_in">next</span> <span class="keyword">and</span> pNode.<span class="built_in">next</span>.left != pNode:</span><br><span class="line">                pNode = pNode.<span class="built_in">next</span></span><br><span class="line">            <span class="keyword">if</span> pNode.<span class="built_in">next</span>:</span><br><span class="line">                <span class="keyword">return</span> pNode.<span class="built_in">next</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>以下是c++版本</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">struct TreeLinkNode &#123;</span></span><br><span class="line"><span class="comment">    int val;</span></span><br><span class="line"><span class="comment">    struct TreeLinkNode *left;</span></span><br><span class="line"><span class="comment">    struct TreeLinkNode *right;</span></span><br><span class="line"><span class="comment">    struct TreeLinkNode *next;</span></span><br><span class="line"><span class="comment">    TreeLinkNode(int x) :val(x), left(NULL), right(NULL), next(NULL) &#123;</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">    &#125;</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function">TreeLinkNode* <span class="title">GetNext</span><span class="params">(TreeLinkNode* pNode)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">     <span class="keyword">if</span>(pNode==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">     &#125;</span><br><span class="line">        <span class="keyword">if</span>(pNode-&gt;right!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">            TreeLinkNode* newNode = pNode-&gt;right;</span><br><span class="line">            <span class="keyword">while</span>(newNode-&gt;left)&#123;</span><br><span class="line">                newNode=newNode-&gt;left;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> newNode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(pNode-&gt;next!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">            <span class="keyword">while</span>(pNode-&gt;next!=<span class="literal">nullptr</span> <span class="keyword">and</span> pNode-&gt;next-&gt;left!=pNode)&#123;</span><br><span class="line">                pNode=pNode-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(pNode-&gt;next!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">                <span class="keyword">return</span> pNode-&gt;next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> TreeLinkNode <span class="title function_">GetNext</span><span class="params">(TreeLinkNode pNode)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (pNode==<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (pNode.right!=<span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="type">TreeLinkNode</span> <span class="variable">node</span> <span class="operator">=</span> pNode.right;</span><br><span class="line">    <span class="keyword">while</span> (node.left!=<span class="literal">null</span>)&#123;</span><br><span class="line">      node = node.left;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (pNode.next!=<span class="literal">null</span> &amp;&amp; pNode.next.left!=pNode)&#123;</span><br><span class="line">    pNode = pNode.next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> pNode.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="栈和队列"><a href="#栈和队列" class="headerlink" title="栈和队列"></a>栈和队列</h4><p>栈是一个非常常见的数据结构，在计算机中广泛使用。比如操作系统给每个线程创建一个栈来存储函数调用时各个函数的参数，返回地址及临时变量等。</p>
<p>栈的特点是后进先出，最后被push的元素或第一个被弹出（pop）。</p>
<p>队列的特点是先进先出。</p>
<h5 id="面试题9：用两个栈实现队列"><a href="#面试题9：用两个栈实现队列" class="headerlink" title="面试题9：用两个栈实现队列"></a>面试题9：用两个栈实现队列</h5><blockquote>
<p>用两个栈实现一个队列，队列的声明如下，请实现他的两个函数appendTail和deleteHead，分别完成在对未插入节点和在队列头部删除节点的功能</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; <span class="keyword">class</span> <span class="title class_">CQueue</span>&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    	<span class="built_in">CqueueI</span>(<span class="type">void</span>);</span><br><span class="line">        ~<span class="built_in">CqueueI</span>(<span class="type">void</span>);</span><br><span class="line">    	</span><br><span class="line">    	<span class="function"><span class="type">void</span> <span class="title">appendTail</span><span class="params">(<span class="type">const</span> T&amp; node)</span></span>;</span><br><span class="line">    	<span class="function">T <span class="title">deleteHead</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    	stack&lt;T&gt; stack1;</span><br><span class="line">    	stack&lt;T&gt; stack2;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>思路：两个栈实现一个队列，先把元素全部压入一个栈，在要删除队首元素的时候，将元素全部出栈，然后顺序压入另一个栈，再pop掉最上面一个元素，也就是最先入栈的元素，就删除了头部。加入尾部就直接压入第一个栈就行了。只要第二个栈不为空，我们就从第二个栈中pop，否则将第一个栈全部压入第二个栈。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;  <span class="type">void</span> CQueue&lt;T&gt;::<span class="built_in">appendTail</span>(<span class="type">const</span> T&amp; node)&#123;</span><br><span class="line">    stack1.<span class="built_in">push</span>(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;  <span class="type">void</span> CQueue&lt;T&gt;::<span class="built_in">deleteHead</span>()&#123;</span><br><span class="line">    <span class="keyword">if</span>(stack2.<span class="built_in">size</span>()&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">while</span>(stack1.<span class="built_in">size</span>()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            T&amp; data = stack1.top;</span><br><span class="line">            stack1.<span class="built_in">pop</span>();</span><br><span class="line">            stack2.<span class="built_in">push</span>(data);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(stack2.<span class="built_in">size</span>()==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">exception</span>(<span class="string">&quot;queue is empty&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    T head = stack2.<span class="built_in">top</span>();</span><br><span class="line">    stack2.<span class="built_in">pop</span>();</span><br><span class="line">    <span class="keyword">return</span> head</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是python的实现：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.stack1=[]</span><br><span class="line">        self.stack2=[]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, node</span>):</span><br><span class="line">        self.stack1.append(node)</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.stack2)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">while</span> <span class="built_in">len</span>(self.stack1)&gt;<span class="number">0</span>:</span><br><span class="line">                self.stack2.append(self.stack1.pop())</span><br><span class="line">        <span class="keyword">return</span> self.stack2.pop()</span><br><span class="line">        <span class="comment"># return xx</span></span><br></pre></td></tr></table></figure>

<p>java</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.drawon;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Stack;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line">    Stack&lt;Integer&gt; stack1 = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;Integer&gt;();</span><br><span class="line">    Stack&lt;Integer&gt; stack2 = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> node)</span> &#123;</span><br><span class="line">        stack1.push(node);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">pop</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!stack2.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> stack2.pop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (!stack1.isEmpty()) &#123;</span><br><span class="line">            stack2.push(stack1.pop());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> stack2.pop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="算法与数据结构"><a href="#算法与数据结构" class="headerlink" title="算法与数据结构"></a>算法与数据结构</h4><p>很多算法都可以使用递归和循环两种方法，递归实现比较简洁，但是性能不如基于循环的实现方法。</p>
<p>排序和查找是面试时考察的重点。准备时应该重点掌握<strong>二分查找，归并排序，快速排序</strong>，做到能随时能正确、完整地写出它们的代码。</p>
<p>如果面试题要求在二维数组上搜搜路径（比如迷宫或者棋盘），我们可以尝试回溯法。回溯法很适合用递归的代码实现。如果面试官规定不允许使用递归，那么就需要用栈来模拟递归。</p>
<p>如果面试题是求某个问题的最优解，并且该问题可以分为多个子问题，那么我们可以使用动态规划。再用自上而下的递归思路去自动分析动态规划问题的时候，我们会发现子问题之间存在重叠的更小的子问题。为了避免不必要的重复计算，我们用自下而上的循环代码来实现，就是<strong>把子问题的最优解先算出来并用数组（一般是一维或者二维数组）保存下来</strong>，接下来基于子问题的解计算大问题的解。</p>
<p>如果告诉面试官动态规划的思路之后，免死关提醒说分解子问题的时候是不是存在某个特殊的选择，采用特殊选择一定能得到最优解，那么意味着这道题可能可以用贪婪算法。</p>
<h4 id="递归和循环"><a href="#递归和循环" class="headerlink" title="递归和循环"></a>递归和循环</h4><p>如果需要重复多次计算相同的问题，则通常可以选择用递归或循环两种算法。递归就是在函数的内部调用这个函数自身。循环是通过设置初值和种植条件，在一个范围内重复运算。</p>
<h5 id="面试题10：斐波那契数列"><a href="#面试题10：斐波那契数列" class="headerlink" title="面试题10：斐波那契数列"></a>面试题10：斐波那契数列</h5><blockquote>
<p>求斐波那契数列的第n项</p>
</blockquote>
<p>斐波那契数列定义如下：<br>$$<br>F_0&#x3D;0\<br>F_1 &#x3D;1\<br>F_{(n)}&#x3D;F_{(n-1)}+F_{(n-2)}<br>$$<br>这是一个使用递归的直观例子，得到的代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Fibonacci</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> n&lt;=<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> n==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.Fibonacci(n-<span class="number">1</span>)+self.Fibonacci(n-<span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>但是，在这里使用递归有很大的问题，那就是会进行大量的重复计算，比如我们要得到$f(10)$，首先要计算$f(9)$和$f(8)$，要得到$f(9)$又要得到$f(8)$和$f(7)$，这里，$f(8)$就已经重复了，往后还有很多这样的重复，如图所示</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/20181213145206.png"></p>
<p>因此，斐波那契数量的正确做法应该是循环，如下所示：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Fibonacci</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> n&lt;=<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> n==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            a = <span class="number">0</span></span><br><span class="line">            b = <span class="number">1</span></span><br><span class="line">            fn = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,n+<span class="number">1</span>):</span><br><span class="line">                fn = a+b</span><br><span class="line">                a = b</span><br><span class="line">                b = fn</span><br><span class="line">            <span class="keyword">return</span> fn</span><br></pre></td></tr></table></figure>

<h5 id="青蛙跳台阶"><a href="#青蛙跳台阶" class="headerlink" title="青蛙跳台阶"></a>青蛙跳台阶</h5><blockquote>
<p>一只青蛙，一次可以跳上一级台阶，也可以跳上两级台阶，那么跳上n级台阶一共有多少种方法。</p>
</blockquote>
<p>解析：因为青蛙最后一步，要么跳2级，要么跳1级，那么$f(n)&#x3D;f(n-1)+f(n-2)​$，这样一来，这其实就是一个斐波那契数列问题</p>
<p>程序：python版本</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">jumpFloor</span>(<span class="params">self, number</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> number==<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> number==<span class="number">2</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            a = <span class="number">0</span></span><br><span class="line">            b = <span class="number">1</span></span><br><span class="line">            fn = <span class="number">0</span></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(number):</span><br><span class="line">                fn = a+b</span><br><span class="line">                a = b</span><br><span class="line">                b = fn</span><br><span class="line">            <span class="keyword">return</span> fn</span><br></pre></td></tr></table></figure>

<p>c++版本</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">jumpFloor</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(number==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">if</span>(number==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">int</span> f0 = <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> f1 = <span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> fn = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=number;++i)&#123;</span><br><span class="line">                fn = f0+f1;</span><br><span class="line">                f0 = f1;</span><br><span class="line">                f1 = fn;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fn;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="变态青蛙跳台阶"><a href="#变态青蛙跳台阶" class="headerlink" title="变态青蛙跳台阶"></a>变态青蛙跳台阶</h5><p>一只青蛙一次可以跳上1级台阶，也可以跳上2级……它也可以跳上n级。求该青蛙跳上一个n级的台阶总共有多少种跳法。</p>
<p>解析：我们考虑一下n级台阶的时候有多少种跳法，第一步有n种跳法：跳1级、跳2级、到跳n级。跳1级，剩下n-1级，则剩下跳法是f(n-1)；跳2级，剩下n-2级，则剩下跳法是f(n-2)，所以$f(n)&#x3D;f(n-1)+f(n-2)+…+f(1)+1$。同理可以推出$f(n-1)&#x3D;f(n-2)+f(n-3)+…+f(1)+1$，因此$f(n)&#x3D;f(n-1)+f(n-1)&#x3D;2\times f(n-1)&#x3D;2\times2\times f(n-2)&#x3D;…&#x3D;2^{n-1}f(1)&#x3D;2^{n-1}$</p>
<p>所以，直接返回$2^{n-1}​$即可</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">jumpFloorII</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pow</span>(<span class="number">2</span>,number<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="矩阵覆盖问题"><a href="#矩阵覆盖问题" class="headerlink" title="矩阵覆盖问题"></a>矩阵覆盖问题</h5><blockquote>
<p>用一个2*1的小矩形，横着或者竖着覆盖一个更大的矩形，请问用8个2*1的小矩形无重复的覆盖一个2*8的大矩形，总共有多少种方法？</p>
</blockquote>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/pics/20181213153628.png"></p>
<p>分析：如果我将第一个矩形竖着放，那么就剩下2*7个矩形，如果我将第一个矩形横着放，那么横着放的矩形下面一定是一个横着放的矩形，那么就剩下2*7个矩形，也就是$f(8)&#x3D;f(7)+f(6)$，可以看出，这依然是一个斐波那契数列问题。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">rectCover</span><span class="params">(<span class="type">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(number==<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(number==<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">int</span> f0=<span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> f1=<span class="number">1</span>;</span><br><span class="line">            <span class="type">int</span> fn=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;=number+<span class="number">1</span>;++i)&#123;</span><br><span class="line">                fn = f0+f1;</span><br><span class="line">                f0 = f1;</span><br><span class="line">                f1 = fn;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> fn;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="查找和排序"><a href="#查找和排序" class="headerlink" title="查找和排序"></a>查找和排序</h4><p>查找和排序是程序设计中经常用到的算法。查找比较简单，不外乎<strong>顺序查找，二分查找，哈希表查找和二叉排序查找</strong>。哈希表最主要的有点事能够在O(1)时间内找到某个元素，但是需要额外空间来实现哈希表。二叉排序树查找算法对应的数据结构是二叉搜索树。</p>
<p>排序比较复杂，通常要求比较<strong>插入排序，冒泡排序，归并排序，快速排序</strong>等不同算法的优劣。要求应试者对各种排序算法烂熟于胸，能够从额外空间小号，平均时间复杂度和最差时间复杂度等方面去分析他们的优劣。很多面试官要求应聘者写出<strong>快速排序</strong>的代码。</p>
<p>快速排序的关键在于选择数组中选择一个数字，接下来把数组中的数字分为两部分，比选择的数字小的数字移到数组左边，比选择大的数字移到数组右边。实现代码如下</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">partion</span>(<span class="params">nums, l, r</span>):</span><br><span class="line">    x = nums[r]</span><br><span class="line">    s = l - <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(l, r):</span><br><span class="line">        <span class="keyword">if</span> nums[i] &lt;= x:</span><br><span class="line">            s += <span class="number">1</span></span><br><span class="line">            nums[s], nums[i] = nums[i], nums[s]</span><br><span class="line">    s += <span class="number">1</span></span><br><span class="line">    nums[s], nums[r] = nums[r], nums[s]</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quickSort</span>(<span class="params">nums, l, r</span>):</span><br><span class="line">    <span class="keyword">if</span> l &lt; r:</span><br><span class="line">        q = partion(nums, l, r)</span><br><span class="line">        quickSort(nums, l, q - <span class="number">1</span>)</span><br><span class="line">        quickSort(nums, q + <span class="number">1</span>, r)</span><br><span class="line">    <span class="keyword">return</span> nums</span><br></pre></td></tr></table></figure>

<p>归并排序如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge</span>(<span class="params">left, right</span>):</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    ret = []</span><br><span class="line">    <span class="keyword">while</span> i &lt; <span class="built_in">len</span>(left) <span class="keyword">and</span> j &lt; <span class="built_in">len</span>(right):</span><br><span class="line">        <span class="keyword">if</span> left[i] &lt;= right[j]:</span><br><span class="line">            ret.append(left[i])</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ret.append(right[j])</span><br><span class="line">            j += <span class="number">1</span></span><br><span class="line">    ret.extend(left[i:])</span><br><span class="line">    ret.extend(right[j:])</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">i</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mergeSort</span>(<span class="params">l</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(l) &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> l</span><br><span class="line">    mid = <span class="built_in">len</span>(l) // <span class="number">2</span></span><br><span class="line">    left = mergeSort(l[:mid])</span><br><span class="line">    right = mergeSort(l[mid:])</span><br><span class="line">    <span class="keyword">return</span> merge(left, right)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(mergeSort([<span class="number">1</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">7</span>, -<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p>插入排序如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">insertionSort</span><span class="params">(<span class="type">int</span>[] nums)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> nums[i];</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &gt;= <span class="number">0</span> &amp;&amp; nums[j] &gt; key) &#123;</span><br><span class="line">            nums[j + <span class="number">1</span>] = nums[j];</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">        nums[j + <span class="number">1</span>] = key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题11：旋转数组的最小数字"><a href="#面试题11：旋转数组的最小数字" class="headerlink" title="面试题11：旋转数组的最小数字"></a>面试题11：旋转数组的最小数字</h5><blockquote>
<p>把一个数组最开始的若干个元素搬到数组的末尾，我们称之为数组的旋转。 输入一个非减排序的数组的一个旋转，输出旋转数组的最小元素。 例如数组{3,4,5,1,2}为{1,2,3,4,5}的一个旋转，该数组的最小值为1。 NOTE：给出的所有元素都大于0，若数组大小为0，请返回0。</p>
</blockquote>
<p> 思路：想要找到最小的数字，最简单的想法就是直接遍历整个数组，这样就可以找到最小值，但是这样的时间复杂度是O(n)，明显没有利用这道题给出的非减数组和旋转数组的概念，这道题正确的解答方式是二分查找，时间复杂度为O(log(n))。</p>
<p>可以使用二分查找的原因是，整个数组可以分成两个非递减的子数组，最小值一定在第二个子数组的第一个元素。</p>
<p>二分查找就是两个指针，一个指向开头，一个指向结束，每次找到中间元素，如果中间元素大于等于开头元素，那么这个元素一定属于前半个子数组，最小值一定在当前中间值和末尾值之间，那么移动第一个指针到当前值的下一个值；如果中间元素小于最后一个值，那么当前元素一定属于第二个子数组，那么最小值一定在开头到当前值之间，移动第二个指针到当前值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">minNumberInRotateArray</span>(<span class="params">self, rotateArray</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        length = <span class="built_in">len</span>(rotateArray)</span><br><span class="line">        <span class="keyword">if</span> length == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> length == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> rotateArray[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l = <span class="number">0</span></span><br><span class="line">            r = length-<span class="number">1</span></span><br><span class="line">            mid = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> rotateArray[l] &gt;= rotateArray[r]:</span><br><span class="line">                <span class="keyword">if</span> r - l == <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> rotateArray[r]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                mid = (r - l)//<span class="number">2</span> + l</span><br><span class="line">                <span class="keyword">if</span> rotateArray[mid] &gt;= rotateArray[l]:</span><br><span class="line">                    l = mid</span><br><span class="line">                <span class="keyword">elif</span> rotateArray[mid] &lt;= rotateArray[r]:</span><br><span class="line">                    r = mid</span><br><span class="line">            <span class="keyword">return</span> rotateArray[mid]</span><br></pre></td></tr></table></figure>

<p>上面的代码似乎可以成功，但是遗漏了一种特殊情况，如<code>[1,1,0,1,1,1,1]</code>，这样，你无法通过比较大小来缩小范围，遇到这样的情况，只能顺序查找。修改代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">minNumberInRotateArray</span>(<span class="params">self, rotateArray</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        length = <span class="built_in">len</span>(rotateArray)</span><br><span class="line">        <span class="keyword">if</span> length == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">elif</span> length == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> rotateArray[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l = <span class="number">0</span></span><br><span class="line">            r = length-<span class="number">1</span></span><br><span class="line">            mid = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span> rotateArray[l] &gt;= rotateArray[r]:</span><br><span class="line">                <span class="keyword">if</span> r - l == <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> rotateArray[r]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                mid = (r - l)//<span class="number">2</span> + l</span><br><span class="line">                <span class="keyword">if</span> rotateArray[mid] == rotateArray[l] == rotateArray[r]:</span><br><span class="line">                    <span class="keyword">return</span> minInOrder(rotateArray,l,r)</span><br><span class="line">                <span class="keyword">if</span> rotateArray[mid] &gt;= rotateArray[l]:</span><br><span class="line">                    l = mid</span><br><span class="line">                <span class="keyword">elif</span> rotateArray[mid] &lt;= rotateArray[r]:</span><br><span class="line">                    r = mid</span><br><span class="line">            <span class="keyword">return</span> rotateArray[mid]</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">minInOrder</span>(<span class="params">rotateArray,l,r</span>):</span><br><span class="line">            minv = rotateArray[l]</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> rotateArray[l:r+<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">if</span> minv &gt; i:</span><br><span class="line">                    minv = i</span><br><span class="line">            <span class="keyword">return</span> minv</span><br></pre></td></tr></table></figure>

<p>还有一个比较好的办法就是让中间值和右边值比较</p>
<ol>
<li>如果中间值比右边值大，那么证明最小值在中间值右边</li>
<li>如果中间值&lt;右边值，r&#x3D;mid</li>
<li>如果中间值等于右边值，r&#x3D;r-1，有重复值的情况只能一个一个找</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">minNumberInRotateArray</span>(<span class="params">self, rotateArray</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> rotateArray:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(rotateArray) == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> rotateArray[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            l = <span class="number">0</span></span><br><span class="line">            r = <span class="built_in">len</span>(rotateArray) - <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> l &lt; r:</span><br><span class="line">                mid = (l + r) // <span class="number">2</span></span><br><span class="line">                <span class="keyword">if</span> rotateArray[mid] &gt; rotateArray[r]:</span><br><span class="line">                    l = mid + <span class="number">1</span></span><br><span class="line">                <span class="keyword">elif</span> rotateArray[mid] &lt; rotateArray[r]:</span><br><span class="line">                    r = mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    r = r - <span class="number">1</span></span><br><span class="line">            <span class="keyword">return</span> rotateArray[l]</span><br></pre></td></tr></table></figure>

<h4 id="回溯法"><a href="#回溯法" class="headerlink" title="回溯法"></a>回溯法</h4><p>回溯法非常适合有多个步骤组成的问题，并且每个步骤有多个选项。用回溯法解决的问题，可以形象的用树表示，每一步都有m个可能选项。如果叶节点的状态满足题目约束条件，则找到了可行方案。</p>
<h5 id="面试题12：矩阵的路径"><a href="#面试题12：矩阵的路径" class="headerlink" title="面试题12：矩阵的路径"></a>面试题12：矩阵的路径</h5><blockquote>
<p>请设计一个函数，用来判断在一个矩阵中是否存在一条包含某字符串所有字符的路径。路径可以从矩阵中的任意一个格子开始，每一步可以在矩阵中向左，向右，向上，向下移动一个格子。如果一条路径经过了矩阵中的某一个格子，则之后不能再次进入这个格子。 例如 a b c e s f c s a d e e 这样的3 X 4 矩阵中包含一条字符串”bcced”的路径，但是矩阵中不包含”abcb”路径，因为字符串的第一个字符b占据了矩阵中的第一行第二个格子之后，路径不能再次进入该格子。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hasPath</span>(<span class="params">self, matrix, rows, cols, path</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(path) &gt; <span class="built_in">len</span>(matrix) <span class="keyword">or</span> <span class="built_in">len</span>(matrix)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        visited = [[<span class="literal">False</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cols)] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rows)]</span><br><span class="line">        pathLength = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> row <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">            <span class="keyword">for</span> col <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">                <span class="keyword">if</span> self.hasPathCore(row, col, matrix, rows, cols, path, visited, pathLength):</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hasPathCore</span>(<span class="params">self, row, col, matrix, rows, cols, path, visited, pathLength</span>):</span><br><span class="line">        <span class="keyword">if</span> pathLength == <span class="built_in">len</span>(path):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        haspath = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= col &lt; cols <span class="keyword">and</span> o &lt;= row &lt; rows <span class="keyword">and</span> path[pathLength] == matrix[row*cols+col] <span class="keyword">and</span> <span class="keyword">not</span> visited[row][col]:</span><br><span class="line">            pathLength += <span class="number">1</span></span><br><span class="line">            visited[row][col] = <span class="literal">True</span></span><br><span class="line">            haspath = self.hasPathCore(row + <span class="number">1</span>, col, matrix, rows, cols, path, visited, pathLength) <span class="keyword">or</span> \</span><br><span class="line">                      self.hasPathCore(row - <span class="number">1</span>, col, matrix, rows, cols, path, visited, pathLength) <span class="keyword">or</span> \</span><br><span class="line">                      self.hasPathCore(row, col + <span class="number">1</span>, matrix, rows, cols, path, visited, pathLength) <span class="keyword">or</span> \</span><br><span class="line">                      self.hasPathCore(row, col - <span class="number">1</span>, matrix, rows, cols, path, visited, pathLength)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> haspath:</span><br><span class="line">                pathLength -= <span class="number">1</span></span><br><span class="line">                visited[row][col] = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> haspath</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="面试题13：机器人的运动范围"><a href="#面试题13：机器人的运动范围" class="headerlink" title="面试题13：机器人的运动范围"></a>面试题13：机器人的运动范围</h5><blockquote>
<p>地上有一个m行和n列的方格。一个机器人从坐标0,0的格子开始移动，每一次只能向左，右，上，下四个方向移动一格，但是不能进入行坐标和列坐标的数位之和大于k的格子。 例如，当k为18时，机器人能够进入方格（35,37），因为3+5+3+7 &#x3D; 18。但是，它不能进入方格（35,38），因为3+5+3+8 &#x3D; 19。请问该机器人能够达到多少个格子？</p>
</blockquote>
<p>思路：这道题有一个小陷阱，这个机器人只能一步一步地走，如果使用循环，遍历所有节点是否满足加和的条件，在比如<code>rows=1</code>或者<code>cols=1</code>的时候，节点不能跨越其他节点访问，就会出错。因此使用的是回溯法，给定一个visited矩阵，如果节点在范围内且没有被访问过，且满足阈值条件，检查他和他的下一个节点是否满足条件，依次回溯。	</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">movingCount</span>(<span class="params">self, threshold, rows, cols</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> rows &lt;= <span class="number">0</span> <span class="keyword">or</span> cols &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> threshold == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> rows * cols</span><br><span class="line">        visited = [[<span class="literal">False</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cols)] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rows)]</span><br><span class="line">        count = self.movingCountCore(rows, cols, threshold, <span class="number">0</span>, <span class="number">0</span>,visited)</span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">movingCountCore</span>(<span class="params">self, rows, cols, threshold, row, col, visited</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">0</span> &lt;= row &lt; rows <span class="keyword">and</span> <span class="number">0</span>&lt;= col &lt; cols <span class="keyword">and</span> <span class="keyword">not</span> visited[row][col] <span class="keyword">and</span> self.checkSum(row, col, threshold):</span><br><span class="line">            visited[row][col] = <span class="literal">True</span></span><br><span class="line">            count = <span class="number">1</span> + self.movingCountCore(rows, cols, threshold, row + <span class="number">1</span>, col, visited) + \</span><br><span class="line">                    self.movingCountCore(rows, cols, threshold, row - <span class="number">1</span>, col, visited) + \</span><br><span class="line">                    self.movingCountCore(rows, cols, threshold, row, col + <span class="number">1</span>, visited) + \</span><br><span class="line">                    self.movingCountCore(rows, cols, threshold, row, col - <span class="number">1</span>, visited)</span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkSum</span>(<span class="params">self, row, col, threshold</span>):</span><br><span class="line">        sumv = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">str</span>(row):</span><br><span class="line">            sumv += <span class="built_in">int</span>(i)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">str</span>(col):</span><br><span class="line">            sumv += <span class="built_in">int</span>(j)</span><br><span class="line">        <span class="keyword">if</span> sumv &lt;= threshold:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h4 id="动态规划和贪婪算法"><a href="#动态规划和贪婪算法" class="headerlink" title="动态规划和贪婪算法"></a>动态规划和贪婪算法</h4><p>动态规划是编程面试的热门。如果面试题是一个问题的最优解（通常是求最大值或者最小值），而该问题可以分解成若干个子问题，并且子问题之间海鸥重叠的更小的子问题，就可以考虑用动态规划来解决这个问题。</p>
<p>在用动态规划之前应该分析能否把大问题分解为小问题，且分解后的每个小问题也存在最优解。</p>
<p>贪婪算法是在每一步都进行一个贪婪选择，具体可以看下面这个例子，用了贪婪算法和动态规划两种方法解决。</p>
<h5 id="面试题14：剪绳子"><a href="#面试题14：剪绳子" class="headerlink" title="面试题14：剪绳子"></a>面试题14：剪绳子</h5><blockquote>
<p>给你一根长度为n的绳子，请把绳子剪成m段 (m和n都是整数，n&gt;1并且m&gt;1)每段绳子的长度记为k[0],k[1],…,k[m].请问k[0]*k[1]*…*k[m]可能的最大乘积是多少？例如，当绳子的长度为8时，我们把它剪成长度分别为2,3,3的三段，此时得到的最大乘积是18.</p>
</blockquote>
<h6 id="方法1：动态规划"><a href="#方法1：动态规划" class="headerlink" title="方法1：动态规划"></a>方法1：动态规划</h6><p>思路：动态规划首先要定义一个长度为n或者是n+1的数组，用于存放每个子问题的最大或最小值，这道题里面我们定义了一个maxv数组，长度为n+1，给定数组的前几个值，直到可以用子问题解决的时候，开始使用循环，第一个循环是长度为n的，第二个循环是每次剪长度为1，长度为2，长度为n-1的情况，这样第二个循环有重复，因为一刀剪1和一刀剪n-1是重复的，因此，每次只需要重复<code>i/2</code>即可。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">def cutLine(length):</span><br><span class="line">    if length == 1:</span><br><span class="line">        return 0</span><br><span class="line">    if length == 2:</span><br><span class="line">        return 1</span><br><span class="line">    if length ==3:</span><br><span class="line">        return 2</span><br><span class="line">    maxv = [0 for _ in range(length+1)]</span><br><span class="line">    maxv[0] = 0</span><br><span class="line">    maxv[1] = 1</span><br><span class="line">    maxv[2] = 2</span><br><span class="line">    maxv[3] = 3</span><br><span class="line">    leng = length</span><br><span class="line">    for i in range(4,length+1):</span><br><span class="line">        maxvalue=0</span><br><span class="line">        for j in range(1,i//2+1):</span><br><span class="line">            tempv = maxv[j] * maxv[i-j]</span><br><span class="line">            if tempv &gt; maxvalue:</span><br><span class="line">                maxvalue = tempv</span><br><span class="line">            maxv[i] = maxvalue</span><br><span class="line">    return maxv[-1]</span><br></pre></td></tr></table></figure>

<h6 id="方法2：贪婪算法"><a href="#方法2：贪婪算法" class="headerlink" title="方法2：贪婪算法"></a>方法2：贪婪算法</h6><p>思路：尽可能剪长度为3的绳子，直到长度小于等于4，等于四的时候，剪成2*2的乘积比1*3要大，所以为4的时候剪成2*2。这个可以通过数学方法证明，当n&gt;&#x3D;5的时候，3(n-3)&gt;&#x3D;2(n-2)的，当n&#x3D;4的时候，有两种切法，一种是</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">cutLine</span>(<span class="params">length</span>):</span><br><span class="line">    <span class="keyword">if</span> length == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> length == <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> length ==<span class="number">3</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">if</span> length %<span class="number">3</span> ==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>**(length//<span class="number">3</span>)</span><br><span class="line">    <span class="keyword">elif</span> length%<span class="number">3</span> == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>**(length//<span class="number">3</span> -<span class="number">1</span>)*<span class="number">4</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>**(length//<span class="number">3</span>)*<span class="number">2</span></span><br></pre></td></tr></table></figure>

<h4 id="位运算"><a href="#位运算" class="headerlink" title="位运算"></a>位运算</h4><p>位运算主要有五种：与，或，非，异或，移位运算</p>
<p>前面三种比较常见，异或的符号是<code>^</code>，移位运算的符号是<code>&lt;&lt;</code>或者<code>&gt;&gt;</code>。</p>
<p>左移n位，直接丢弃最前面的n位，是负数就在最符号位补1，正数就在符号位补0。右移n位同理。</p>
<h5 id="面试题15：二进制中1的个数"><a href="#面试题15：二进制中1的个数" class="headerlink" title="面试题15：二进制中1的个数"></a>面试题15：二进制中1的个数</h5><blockquote>
<p>任意给定一个32位无符号整数n，求n的二进制表示中1的个数，比如n &#x3D; 5（0101）时，返回2，n &#x3D; 15（1111）时，返回4</p>
</blockquote>
<p>思路：第一种思路是一直把给定值右移运算，然后和1做与运算，这样就能判断当前位是否为1，但是这种方法有陷入死循环的可能</p>
<p>第二种思路是将1一直左移，这样每次与的结果都是当前位与1的结果，判断当前位是否为1。</p>
<p>第三种思路是一种很巧妙的方法，先把给定值减去1，如果这个数不等于0，那么该数的二进制表示中至少有一位是1，假设这个数的最右边一位是1，那么减去1之后，最后一位变成0，而其它位保持不变，也就是想防御最后一位相当于做了取反操作，从1变成了0；而如果最后一位不是1，而是0，我们用第m位表示最右边的1所在的位置，减去1之后，m位右边的值取反，m位左边的值不变，举个例子，1100，减去1之后，最右边的1在第二位，第二位之后的所有值取反，第二位左边的值不变，结果是1011。</p>
<p>总结第三种方法提到的特例，发现把1个整数减去1，就是把最右边的1变成0，如果他的右边还有0，则所有0都变成1，而它左边的所有位都不变。那么我们将一个数和它减去1的结果做与运算，相当于把最右边的1变成0，其余所有位都保持不变。那么我们反复这样操作，每进行一次，就少一个1，这样就统计出来有多少个1了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法1：</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countNum</span>(<span class="params">num</span>):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> num!=<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> num &amp; <span class="number">1</span>:</span><br><span class="line">            count+=<span class="number">1</span></span><br><span class="line">        num = num &gt;&gt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count+<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countNum</span>(<span class="params">num</span>):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    flag = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> flag!=<span class="number">2</span>**<span class="number">64</span>:</span><br><span class="line">        <span class="keyword">if</span> num &amp; flag:</span><br><span class="line">            count+=<span class="number">1</span></span><br><span class="line">        flag = flag &lt;&lt; <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法3，重点：一个数和自己减去1的值相与，会使其最右边的一个1变为0</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countNum</span>(<span class="params">num</span>):</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    n = n&amp;<span class="number">0xffffffff</span> <span class="comment"># 这一步的原因是python的负数前面有无限个1，不限制位数永远无法结束</span></span><br><span class="line">    <span class="keyword">while</span> num:</span><br><span class="line">        count+=<span class="number">1</span></span><br><span class="line">        num=(num-<span class="number">1</span>)&amp;num</span><br><span class="line">    <span class="keyword">return</span> count</span><br></pre></td></tr></table></figure>

<p>相关题目：</p>
<ol>
<li>判断一个数是否是2的整数次方。<br>解答：一个数如果是2的整数次方，那么其中一定只有一个1，只需要将这个值和它减1的结果相与，判断1的个数，即可。</li>
<li>判断m需要多少步变化才能变成n，比如13的二进制是1101，10的二进制是1010，要把13变成10，需要改变其中的3位。<br>解答：直接两个值做异或，然后统计其中1的个数即可。</li>
</ol>
<h3 id="第三章：高质量的代码"><a href="#第三章：高质量的代码" class="headerlink" title="第三章：高质量的代码"></a>第三章：高质量的代码</h3><h5 id="面试题16：数值的整数次方"><a href="#面试题16：数值的整数次方" class="headerlink" title="面试题16：数值的整数次方"></a>面试题16：数值的整数次方</h5><blockquote>
<p>实现函数double Power(double case, int exponent)，求base的exponent次方，不得使用库函数，且不需要考虑大数问题。</p>
</blockquote>
<p>直观思路是，从1到exponent，result每次乘以base，最后就得到了base次方</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">double</span> <span class="title">Power</span><span class="params">(<span class="type">double</span> base, <span class="type">int</span> exponent)</span></span>&#123;</span><br><span class="line">    <span class="type">double</span> result = <span class="number">1.0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=exponent;++i)&#123;</span><br><span class="line">        result *= base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样看上去似乎是对的，但是没有考虑输入指数小于1（零和负数）的情况。接下来在代码中加入对特殊情况的判断。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">double</span> <span class="title">Power</span><span class="params">(<span class="type">double</span> base, <span class="type">int</span> exponent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">equal</span>(base,<span class="number">0.0</span>) &amp;&amp; exponent&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> absExponent = (<span class="type">unsigned</span> <span class="type">int</span>) exponent;</span><br><span class="line">    <span class="keyword">if</span>(exponent&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        absExponent = (<span class="type">unsigned</span> <span class="type">int</span>)(-exponent);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">double</span> result = <span class="built_in">PowerWithUnsignedExponent</span>(base, absExponent);</span><br><span class="line">    <span class="keyword">if</span>(exponent&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        result = <span class="number">1.0</span>/result;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">double</span> <span class="title">PowerWithUnsignedExponent</span><span class="params">(<span class="type">double</span> base, <span class="type">unsigned</span> <span class="type">int</span> exponent)</span></span>&#123;</span><br><span class="line">    <span class="type">double</span> result = <span class="number">1.0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=exponent;++i)&#123;</span><br><span class="line">        result *= base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样一来，看上去似乎已经完美了，但是还存在更加高效的方法。</p>
<p>假如需要求base的32次方，那么可以先做16次方，然后平方，再继续深究，先做8次方，再平方，再做4次方，平方，再做2次方。也就是只需要做5次乘法即可。这样就大大减少了运算量。<br>$$<br>f(x)&#x3D;\left{<br>\begin{aligned}<br>a^n  &#x3D; &amp; a^{n&#x2F;2}*a^{n&#x2F;2}\quad a为偶数\<br>a^n  &#x3D; &amp; a^{(n-1)&#x2F;2}*a^{(n-1)&#x2F;2}*a\quad  a为奇数<br>\end{aligned}<br>\right.<br>$$</p>
<p>利用上面的公式，就可以通过递归实现整数次方的问题。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">double</span> <span class="title">PowerWithUnsignedExponent</span><span class="params">(<span class="type">double</span> base, <span class="type">unsigned</span> <span class="type">int</span> exponent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(exponent==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(exponent==<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">double</span> result = <span class="built_in">PowerWithUnsignedExponent</span>(base, exponent&gt;&gt;<span class="number">1</span>);</span><br><span class="line">    result *= reuslt;</span><br><span class="line">    <span class="keyword">if</span>(exponent &amp; <span class="number">0x1</span> == <span class="number">1</span>)&#123;</span><br><span class="line">        result*=base;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java非递归代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span> <span class="title function_">pow</span><span class="params">(<span class="type">int</span> base, <span class="type">int</span> exponent)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (exponent &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        flag = <span class="literal">false</span>;</span><br><span class="line">        exponent = -exponent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">double</span> <span class="variable">res</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (exponent != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((exponent &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">            res = base * res;</span><br><span class="line">        &#125;</span><br><span class="line">        base = base * base;</span><br><span class="line">        exponent &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag ? res : <span class="number">1</span> / res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="矩阵快速幂"><a href="#矩阵快速幂" class="headerlink" title="矩阵快速幂"></a>矩阵快速幂</h5><p>当遇到<code>f(n)=a*f(n-1)+b*f(b-2)</code>的情况，如果用递推公式计算量非常大，因此比较好的方式是用矩阵快速幂，构造如下矩阵乘法：<br>$$<br>\left(\begin{array}{cc}{a} &amp; {b} \ {1} &amp; {0}\end{array}\right)\left(\begin{array}{c}{f(n-1)} \ {f(n-2)}\end{array}\right)&#x3D;\left(\begin{array}{c}{f(n)} \ {f(n-1)}\end{array}\right)<br>$$<br>则求f(n)的过程变为：<br>$$<br>\left(\begin{array}{cc}{a} &amp; {b} \ {1} &amp; {0}\end{array}\right)^{n-2}\left(\begin{array}{c}{f(2)} \ {f(1)}\end{array}\right)&#x3D;\left(\begin{array}{c}{f(n)} \ {f(n-1)}\end{array}\right)<br>$$<br>此时就可以利用快速幂了，只是把res和base的乘法换成了矩阵乘法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">double</span>[][] matrixPow(<span class="type">double</span>[][] nums, <span class="type">int</span> exponent) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums == <span class="literal">null</span> || nums.length == <span class="number">0</span> || nums[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">double</span>[][] res = <span class="keyword">new</span> <span class="title class_">double</span>[nums.length][nums[<span class="number">0</span>].length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; nums.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; nums[<span class="number">0</span>].length; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (i==j)&#123;</span><br><span class="line">                    res[i][j] = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (exponent != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((exponent &amp; <span class="number">1</span>) != <span class="number">0</span>) &#123;</span><br><span class="line">                res = matrixMultiply(res, nums);</span><br><span class="line">            &#125;</span><br><span class="line">            nums = matrixMultiply(nums, nums);</span><br><span class="line">            exponent &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//计算矩阵乘法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">double</span>[][] matrixMultiply(<span class="type">double</span>[][] a, <span class="type">double</span>[][] b) &#123;</span><br><span class="line">        <span class="type">double</span>[][] res = <span class="keyword">new</span> <span class="title class_">double</span>[a.length][b[<span class="number">0</span>].length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; b[<span class="number">0</span>].length; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; a[<span class="number">0</span>].length; k++) &#123;</span><br><span class="line">                    res[i][j] += (a[i][k] * b[k][j]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题17：打印从1到最大的n位数"><a href="#面试题17：打印从1到最大的n位数" class="headerlink" title="面试题17：打印从1到最大的n位数"></a>面试题17：打印从1到最大的n位数</h5><blockquote>
<p>题目：输入数字n，按顺序打印出从1到最大的n位十进制数，比如输入3，则打印出1,2,3直到最大的三位数999</p>
</blockquote>
<p><strong>陷阱</strong>：这道题看起来很简单，直接打印1到$10^n$就行了，但是用int类型会溢出的时候，甚至用 long long 都会溢出的时候怎么办呢？</p>
<p><strong>思路</strong>：这道题的正确思路是用字符串来表示数字，因为最大数字是n位的，在c++中，需要给定一个n+1位的字符串，因为结束位是<code>\0</code>，当数字不够n位的时候，在字符串的前半部分补0。首先把字符串中的所有数字都初始化为0，每次喂字符串表示的数字加1，然后打印出来。因此有两个任务，一个是在字符串表示的数字上模拟加法，二是将他们打印出来。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintToMaxOfDigits</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n&lt;=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">char</span>* number = <span class="keyword">new</span> <span class="type">char</span>[n+<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">memset</span>(number,<span class="string">&#x27;0&#x27;</span>,n);</span><br><span class="line">    number[n] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">while</span>(!<span class="built_in">Increment</span>(number))&#123;</span><br><span class="line">        <span class="built_in">PrintNumber</span>(number);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>模拟加法，每次加1就是从最后一位开始，每次加1，有进位则保留下来继续加下一位，否则结束加法，剩下的位数保持不变。那么什么时候应该继续加，什么时候应该结束加法呢？如果每加1次就和最大值999…999进行比较，时间复杂度每次都是o(n)。其实只需要判断最高位是否有进1，如果有则达到了最大值。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Increment</span><span class="params">(<span class="type">char</span>* number)</span></span>&#123;</span><br><span class="line">    <span class="type">bool</span> isOverflow = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> nSum = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> nTakeOver = <span class="number">0</span>;</span><br><span class="line">    len = <span class="built_in">strlen</span>(number);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=len<span class="number">-1</span>; i&gt;=<span class="number">0</span> ; --i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i==len<span class="number">-1</span>)</span><br><span class="line">            nSum = nSum-<span class="string">&#x27;0&#x27;</span>+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (nSum == <span class="number">10</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i==<span class="number">0</span>)&#123;</span><br><span class="line">                isOverflow = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">return</span> isOverflow;</span><br><span class="line">            &#125;</span><br><span class="line">            nSum -= <span class="number">10</span>;</span><br><span class="line">            nTakeOver = <span class="number">1</span>;</span><br><span class="line">            number[i] = <span class="string">&#x27;0&#x27;</span>+nSum;</span><br><span class="line">                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            number[i] = nSum+<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isOverflow;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>打印数字也存在小陷阱，如果使用printf直接打印，那么前面那些0也被打出来了，因此应该判断一下，打印第一个不为0的值到最后一个值。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintNumber</span><span class="params">(<span class="type">char</span>* number)</span></span>&#123;</span><br><span class="line">    <span class="type">bool</span> isBeginning0 = <span class="literal">true</span>;</span><br><span class="line">    <span class="type">int</span> len = <span class="built_in">strlen</span>(number);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;len;++i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(isBeginning0 &amp;&amp; number[i]!=<span class="string">&#x27;0&#x27;</span>)&#123;</span><br><span class="line">            isBeginning0=<span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!isBeginning0)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>,number[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="将问题转换为数字排列，递归实现"><a href="#将问题转换为数字排列，递归实现" class="headerlink" title="将问题转换为数字排列，递归实现"></a>将问题转换为数字排列，递归实现</h6><p>模拟字符串加法比较复杂，因此可以使用递归进行每一位0-9的排列组合。打印的时候，前面的0不打印即可，递归结束条件是已经设置了数字的最后一位。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">PrintToMaxOfNDigits</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n&lt;=<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">char</span>* number=<span class="keyword">new</span> <span class="type">char</span>[n+<span class="number">1</span>];</span><br><span class="line">    number[n] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        number[<span class="number">0</span>] = <span class="string">&#x27;0&#x27;</span>+i;</span><br><span class="line">        <span class="built_in">print1toMaxOfNDigitsRecursively</span>(number,n,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span>[] number;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print1toMaxOfNDigitsRecursively</span><span class="params">(<span class="type">char</span>* number,<span class="type">int</span> length, <span class="type">int</span> index)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(index==length<span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">PrintNumber</span>(number);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;++i)&#123;</span><br><span class="line">        number[index+<span class="number">1</span>] = <span class="string">&#x27;0&#x27;</span>+i;</span><br><span class="line">        <span class="built_in">print1toMaxOfNDigitsRecursively</span>(number,length,index+<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题18：删除链表节点"><a href="#面试题18：删除链表节点" class="headerlink" title="面试题18：删除链表节点"></a>面试题18：删除链表节点</h5><blockquote>
<p>在O(1)时间内删除链表节点</p>
<p>给定单链表的头指针以及任何一个节点指针，定义一个在O(1)时间内删除该节点的函数。</p>
</blockquote>
<p>思路：这道题最直观的想法就是从头到尾遍历，直到找到这个节点的上一个节点，将该节点的上一个节点的next，指向该节点的next，但是这样的时间复杂度是O(n)，不符合要求。</p>
<p>既然时间复杂度是O(1)，那么我们当然只能直接利用给定节点，直接给定节点只有两个信息，一个是当前值，一个是next，那么我们可以将next的value复制到当前节点，将当前的next指向next的next，也就成功删除了这个节点。</p>
<p>考虑一下特殊情况，如果当前节点没有下一个节点，也就是当前值本身就是尾节点，那就得从头开始遍历到当前节点，然后将尾节点的前一个节点设置为空。还有一种特殊情况就是当前链表就只有一个元素，直接将头节点置为空就行了，</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span>&#123;</span><br><span class="line">    <span class="type">int</span> m_nValue;</span><br><span class="line">    ListNode* m_pNext;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DeleteNode</span><span class="params">(listNode** pListHead, listNode* pToBeDeleted)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(pToBeDeleted-&gt;m_pNext != <span class="literal">nullptr</span>)&#123;</span><br><span class="line">        pToBeDeleted-&gt;m_nValue = pToBeDeleted-&gt;m_pNext-&gt;m_nValue;</span><br><span class="line">        pToBeDeleted-&gt;m_pNext = pToBeDeleted-&gt;m_pNext-&gt;m_pNext;</span><br><span class="line">        <span class="keyword">delete</span> pToBeDeleted;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(*pListHead == pToBeDeleted)&#123;</span><br><span class="line">        <span class="keyword">delete</span> pToBeDeleted;</span><br><span class="line">        pToBeDeleted = <span class="literal">nullptr</span>;</span><br><span class="line">        *pListHead = <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        listNode* pNode = *pListHead;</span><br><span class="line">        <span class="keyword">while</span>(pNode-&gt;n_pNext!=pToBeDeleted)&#123;</span><br><span class="line">        	pNode = pNode-&gt;n_pNext;</span><br><span class="line">        &#125;</span><br><span class="line">        pNode-&gt;n_pNext = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">delete</span> pToBeDeleted;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过上面的方法，如果不是尾节点，时间复杂度为O(1)，如果是尾节点，时间复杂度为O(n)。平均时间复杂度为((n-1)*O(1)+1*O(n))&#x2F;n，还是O(1)。</p>
<p>这道题使用上面这种方法，暗含的假设就是待删除节点一定包含在链表中，如果不一定存在，那么这个就只能遍历链表。</p>
<p><strong>题目2</strong></p>
<blockquote>
<p>删除链表中重复节点，如果当前值和前一个节点的值相同，那么删除当前节点和前一个节点。</p>
</blockquote>
<p>思路：要判断当前节点与后面节点是否重复并删除，要找到当前节点的前一个节点pPreNode，和当前节点的下一个节点pNext，把上一个不重复的节点的next指向下一个不重复的节点即可。</p>
<p>一共定义3个节点，pPreNode，pNode，pNext，用于保存上一个不重复节点，当前节点，下一个节点。</p>
<p>当重复的包含头结点的时候，需要判断，然后将头结点指向第一个不重复的节点。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">deleteDuplicate</span><span class="params">(listNode** pHead)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(*pHead==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    listNode *pPreNode = <span class="literal">nullptr</span>;</span><br><span class="line">    listNode *pNode = *pHead;</span><br><span class="line">    <span class="keyword">while</span>(pNode-&gt;m_pNext!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        ListNode* pNext = pNode-&gt;m_pNext;</span><br><span class="line">        <span class="type">bool</span> isDupicated == <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(pNext-&gt;m_nvalue == pNode-&gt;m_nvalue)&#123;</span><br><span class="line">            isDuplicated = True;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!isDuplicated)&#123;</span><br><span class="line">            pPreNode = pNode;</span><br><span class="line">            pNode = pNext;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="type">int</span> value = pNode-&gt;m_nvalue;</span><br><span class="line">            <span class="keyword">while</span>(pNext-&gt;m_nvalue==value &amp;&amp; pNext-&gt;n_pNext!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">                pNext = pNext-&gt;m_pNext;</span><br><span class="line">               </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(pPreNode==<span class="literal">nullptr</span>)&#123;</span><br><span class="line">                *pHead = pNext;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                pPreNode-&gt;m_pNext = pNext;</span><br><span class="line">            pNode = pNext;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> ListNode <span class="title function_">deleteDuplication</span><span class="params">(ListNode pHead)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (pHead == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">newHead</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ListNode</span>(-<span class="number">1</span>);</span><br><span class="line">  newHead.next = pHead;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">pre</span> <span class="operator">=</span> newHead;</span><br><span class="line">  <span class="type">ListNode</span> <span class="variable">cur</span> <span class="operator">=</span> pHead;</span><br><span class="line">  <span class="keyword">while</span> (cur != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">next</span> <span class="operator">=</span> cur.next;</span><br><span class="line">    <span class="keyword">if</span> (next != <span class="literal">null</span> &amp;&amp; next.val == cur.val) &#123;</span><br><span class="line">      <span class="keyword">while</span> (next != <span class="literal">null</span> &amp;&amp; next.val == cur.val) &#123;</span><br><span class="line">        next = next.next;</span><br><span class="line">      &#125;</span><br><span class="line">      pre.next = next;</span><br><span class="line">      cur = next;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      pre = cur;</span><br><span class="line">      cur = next;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newHead.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题19：正则表达式匹配"><a href="#面试题19：正则表达式匹配" class="headerlink" title="面试题19：正则表达式匹配"></a>面试题19：正则表达式匹配</h5><blockquote>
<p>请实现一个函数用来匹配包括’.’和’*‘的正则表达式。模式中的字符’.’表示任意一个字符，而’*‘表示它前面的字符可以出现任意次（包含0次）。 在本题中，匹配是指字符串的所有字符匹配整个模式。例如，字符串”aaa”与模式”a.a”和”ab*ac*a”匹配，但是与”aa.a”和”ab*a”均不匹配</p>
</blockquote>
<p>思路：这道题的关键点在于“*”这个字符，如果一个字符的下一个字符不是“*”，直接拿出来跟string里面的字符比较就行。</p>
<p>如果后一个字符是”*“，那么这个问题变得稍微复杂一点。如果后一个是“*”且当前字符与字符串的相符，那么有如下三种情况：</p>
<ol>
<li>pattern可以直接跳过2字符，s不变。相当于虽然匹配，但是忽略这个带“*”的内容</li>
<li>s+1，pattern+2，相当于只匹配当前这一个值</li>
<li>s+1，pattern不变，相当于当前匹配，接着匹配后面的值</li>
</ol>
<p>因为只要其中一个符合就为true，因此返回的是上述三张情况的或。</p>
<p>如果当前pattern的下一个字符是“*”，且与当前值不匹配，可以直接跳过pattern的2个字符，忽略这个”*“部分</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># s, pattern都是字符串</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">match</span>(<span class="params">self, s, pattern</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(s)==<span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(pattern)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(s)!=<span class="number">0</span> <span class="keyword">and</span> <span class="built_in">len</span>(pattern)==<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(pattern)&gt;<span class="number">1</span> <span class="keyword">and</span> pattern[<span class="number">1</span>] == <span class="string">&quot;*&quot;</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(s)&gt;<span class="number">0</span> <span class="keyword">and</span> (pattern[<span class="number">0</span>]==<span class="string">&quot;.&quot;</span> <span class="keyword">or</span> pattern[<span class="number">0</span>] == s[<span class="number">0</span>]):</span><br><span class="line">                <span class="keyword">return</span> self.<span class="keyword">match</span>(s,pattern[<span class="number">2</span>:]) <span class="keyword">or</span> self.<span class="keyword">match</span>(s[<span class="number">1</span>:],pattern) <span class="keyword">or</span> self.<span class="keyword">match</span>(s[<span class="number">1</span>:],pattern[<span class="number">2</span>:])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> self.<span class="keyword">match</span>(s,pattern[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(s)!=<span class="number">0</span> <span class="keyword">and</span> (pattern[<span class="number">0</span>] == <span class="string">&#x27;.&#x27;</span> <span class="keyword">or</span> pattern[<span class="number">0</span>] == s[<span class="number">0</span>]):</span><br><span class="line">            <span class="keyword">return</span> self.<span class="keyword">match</span>(s[<span class="number">1</span>:],pattern[<span class="number">1</span>:])</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>这道题用的方法也是递归</p>
<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">match</span><span class="params">(<span class="type">char</span>[] str, <span class="type">char</span>[] pattern)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span> || pattern == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> match(str, <span class="number">0</span>, pattern, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">match</span><span class="params">(<span class="type">char</span>[] str, <span class="type">int</span> sIndex, <span class="type">char</span>[] pattern, <span class="type">int</span> pIndex)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (sIndex == str.length &amp;&amp; pIndex == pattern.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sIndex != str.length &amp;&amp; pIndex == pattern.length) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (pIndex &lt; pattern.length - <span class="number">1</span> &amp;&amp; pattern[pIndex + <span class="number">1</span>] == <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (sIndex&lt;str.length &amp;&amp; (str[sIndex] == pattern[pIndex] || pattern[pIndex] == <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> match(str, sIndex, pattern, pIndex + <span class="number">2</span>) || match(str, sIndex + <span class="number">1</span>, pattern, pIndex + <span class="number">2</span>) ||</span><br><span class="line">          match(str, sIndex + <span class="number">1</span>, pattern, pIndex);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> match(str, sIndex, pattern, pIndex + <span class="number">2</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (sIndex&lt;str.length &amp;&amp; (pattern[pIndex] == str[sIndex] || pattern[pIndex] == <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> match(str, sIndex + <span class="number">1</span>, pattern, pIndex + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题20：表示数值的字符串"><a href="#面试题20：表示数值的字符串" class="headerlink" title="面试题20：表示数值的字符串"></a>面试题20：表示数值的字符串</h5><blockquote>
<p>请实现一个函数用来判断字符串是否表示数值（包括整数和小数）。例如，字符串”+100”,”5e2”,”-123”,”3.1416”和”-1E-16”都表示数值。 但是”12e”,”1a3.14”,”1.2.3”,”+-5”和”12e+4.3”都不是。</p>
</blockquote>
<p>比较直观的思路就是直接一堆条件判断，比如第一位0-9或者是+-号，出现e之后不能出现”.”，每个字符只能是0-9或者是”+-eE.”，写这道题的思路比较乱，这样容易漏掉情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># s字符串</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">isNumeric</span>(<span class="params">self, s</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(s) == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        sign = <span class="literal">False</span></span><br><span class="line">        decimal = <span class="literal">False</span></span><br><span class="line">        hasE = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">            <span class="keyword">if</span> s[i]==<span class="string">&#x27;e&#x27;</span> <span class="keyword">or</span> s[i]==<span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> i==<span class="built_in">len</span>(s)-<span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">elif</span> hasE:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                hasE = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> s[i]==<span class="string">&quot;+&quot;</span> <span class="keyword">or</span> s[i]==<span class="string">&quot;-&quot;</span>:</span><br><span class="line">                <span class="keyword">if</span> sign <span class="keyword">and</span> s[i-<span class="number">1</span>]!=<span class="string">&#x27;e&#x27;</span> <span class="keyword">and</span> s[i-<span class="number">1</span>]!=<span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> sign <span class="keyword">and</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> s[i-<span class="number">1</span>] != <span class="string">&#x27;e&#x27;</span> <span class="keyword">and</span> s[i-<span class="number">1</span>] != <span class="string">&#x27;E&#x27;</span>:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                sign = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> s[i]==<span class="string">&#x27;.&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> hasE <span class="keyword">or</span> decimal:</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">                decimal = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="keyword">not</span> <span class="string">&quot;0&quot;</span>&lt;=s[i]&lt;=<span class="string">&#x27;9&#x27;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>

<p>书中给的方法十分有逻辑，首先用scanInterger扫描第一位是不是+或-，如果是，继续扫描后面是不是数字，如果出现小数点，则扫描小数点部分，如果出现e，则扫描指数部分</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">match</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(str==<span class="literal">nullptr</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">bool</span> numeric = <span class="built_in">scanInterger</span>(&amp;str);</span><br><span class="line">    <span class="keyword">if</span>(*str ==<span class="string">&#x27;.&#x27;</span>)&#123;</span><br><span class="line">        ++str;</span><br><span class="line">        numeric= <span class="built_in">scanUnsignedInteger</span>(&amp;str) || numeric;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(*str==<span class="string">&#x27;e&#x27;</span> <span class="keyword">or</span> *str==<span class="string">&#x27;E&#x27;</span>)&#123;</span><br><span class="line">        ++str;</span><br><span class="line">        numeric = numeric &amp;&amp; <span class="built_in">scanInterer</span>(&amp;str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> numeric &amp;&amp; *str==<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">scanUnsignedInteger</span><span class="params">(<span class="type">const</span> <span class="type">char</span> **str)</span></span>&#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>* before = *str;</span><br><span class="line">    <span class="keyword">while</span>(**str!=<span class="string">&#x27;\0&#x27;</span> &amp;&amp;**str&gt;=<span class="string">&#x27;0&#x27;</span> <span class="keyword">and</span> **str&lt;=<span class="string">&#x27;9&#x27;</span>)&#123;</span><br><span class="line">        ++(*str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> *str&gt;before;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">scanInteger</span><span class="params">(<span class="type">const</span> <span class="type">char</span>** str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(**str==<span class="string">&#x27;+&#x27;</span>||**str==<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">        ++(*str);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">scanUnsignedInteger</span>(str);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">checkNum</span><span class="params">(<span class="type">char</span>[] num)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasE</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasDot</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; num.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (num[i] == <span class="string">&#x27;e&#x27;</span> || num[i] == <span class="string">&#x27;E&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasE || i == num.length - <span class="number">1</span> || i == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            hasE = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num[i] == <span class="string">&#x27;.&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasE || hasDot) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            hasDot = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num[i] == <span class="string">&#x27;+&#x27;</span> || num[i] == <span class="string">&#x27;-&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((i != <span class="number">0</span> &amp;&amp; num[i - <span class="number">1</span>] != <span class="string">&#x27;e&#x27;</span> &amp;&amp; num[i - <span class="number">1</span>] != <span class="string">&#x27;E&#x27;</span>) || i == num.length - <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (num[i] &gt; <span class="string">&#x27;9&#x27;</span> || num[i] &lt; <span class="string">&#x27;0&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题21：调整数组顺序使奇数位于偶数前面"><a href="#面试题21：调整数组顺序使奇数位于偶数前面" class="headerlink" title="面试题21：调整数组顺序使奇数位于偶数前面"></a>面试题21：调整数组顺序使奇数位于偶数前面</h5><blockquote>
<p>输入一个整数数组，实现一个函数来调整该数组中数字的顺序，使得所有的奇数位于数组的前半部分，所有的偶数位于数组的后半部分，并保证奇数和奇数，偶数和偶数之间的相对位置不变。</p>
</blockquote>
<p>如果用python这道题很简单，遍历数组，是奇数就放到一个list中，是偶数放到另一个中，最后做一个extend。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">reOrderArray</span>(<span class="params">self, array</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        result_odd = []</span><br><span class="line">        result_even = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> array:</span><br><span class="line">            <span class="keyword">if</span> i%<span class="number">2</span>!=<span class="number">0</span>:</span><br><span class="line">                result_odd.append(i)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result_even.append(i)</span><br><span class="line">        result_odd.extend(result_even)</span><br><span class="line">        <span class="keyword">return</span> result_odd</span><br></pre></td></tr></table></figure>
<p>用c++会复杂一下，维护两个指针，一个指向数组开头(*begin)，一个指向结尾(*end)，只要begin&lt;end，begin向后移动到第一个偶数，end向前移动到第一个奇数，两者交换。</p>
<h4 id="代码鲁棒性"><a href="#代码鲁棒性" class="headerlink" title="代码鲁棒性"></a>代码鲁棒性</h4><h5 id="面试题22：链表中倒数第k个节点"><a href="#面试题22：链表中倒数第k个节点" class="headerlink" title="面试题22：链表中倒数第k个节点"></a>面试题22：链表中倒数第k个节点</h5><blockquote>
<p>输入一个链表，输出该链表中倒数第k个结点。</p>
</blockquote>
<p>这道题的思路就是维护两个指针，第一个指针先向前走k-1步，第二个指针开始开始和第一个指针一起向后走，直到第一个指针指向最后一个元素，此时，第二个指针刚好指向第k个元素。</p>
<p>这道题考察的主要要点是鲁棒性：</p>
<ol>
<li>如果链表长度小于k怎么办</li>
<li>如果输入的是空链表怎么办</li>
<li>如果输入的k是0怎么办（因为这道题说的最后一个节点是倒数第1个节点）</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class ListNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.next = None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindKthToTail</span>(<span class="params">self, head, k</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> head <span class="keyword">or</span> <span class="keyword">not</span> k:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        node1 = head</span><br><span class="line">        node2 = head</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(k-<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> node1.<span class="built_in">next</span>:</span><br><span class="line">                node1 = node1.<span class="built_in">next</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">while</span> node1.<span class="built_in">next</span>:</span><br><span class="line">            node1=node1.<span class="built_in">next</span></span><br><span class="line">            node2 = node2.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">return</span> node2</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title function_">reverseKthNode</span><span class="params">(ListNode head, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; k; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">            node = node.next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">        node = node.next;</span><br><span class="line">        head = head.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题23：链表中环的入口节点"><a href="#面试题23：链表中环的入口节点" class="headerlink" title="面试题23：链表中环的入口节点"></a>面试题23：链表中环的入口节点</h5><blockquote>
<p>给一个链表，若其中包含环，请找出该链表的环的入口结点，否则，输出null。</p>
</blockquote>
<p>这道题可以用暴力方法解决，遍历链表，每遍历一个节点，就将其放入一个list中，直到再次在list中找到这个节点，那么返回节点，如果一直没有找到，返回None</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class ListNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.next = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">EntryNodeOfLoop</span>(<span class="params">self, pHead</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">while</span> pHead.<span class="built_in">next</span>:</span><br><span class="line">            result.append(pHead)</span><br><span class="line">            pHead = pHead.<span class="built_in">next</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> pHead <span class="keyword">in</span> result:</span><br><span class="line">                <span class="keyword">return</span> pHead</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>书中给出的方法是充分利用了c++的指针，给定两个指针，一个每次移动2格，一个每次移动1格，那么每次移动两格的一定会追上每次移动一格的，两者相遇的时候，就表明链表中有环。</p>
<p>从这个相遇节点出发，再次回到这个相遇节点，每走一步加1，就统计出了环中元素的个数n。那么再给两个指针指向链表头部，其中一个先移动n格，然后两个一起移动，每次一格，相遇的点即为环的入口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ListNode <span class="title function_">enterNodeOfCircle</span><span class="params">(ListNode head)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span>(pHead==<span class="literal">null</span> || pHead.next==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">fast</span> <span class="operator">=</span> pHead;</span><br><span class="line">    <span class="type">ListNode</span> <span class="variable">slow</span> <span class="operator">=</span> pHead;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">hasCircle</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">while</span>(fast.next.next!=<span class="literal">null</span>)&#123;</span><br><span class="line">      fast = fast.next.next;</span><br><span class="line">      slow = slow.next;</span><br><span class="line">      <span class="keyword">if</span>(fast==slow)&#123;</span><br><span class="line">        hasCircle=<span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	  <span class="keyword">if</span> (!hasCircle)&#123;</span><br><span class="line">  	  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  	&#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    fast = slow.next;</span><br><span class="line">    <span class="keyword">while</span> (fast!=slow)&#123;</span><br><span class="line">        fast=fast.next;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    fast = head;</span><br><span class="line">    slow = head;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; count; i++) &#123;</span><br><span class="line">        fast = fast.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (fast!=slow)&#123;</span><br><span class="line">        fast=fast.next;</span><br><span class="line">        slow=slow.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> fast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题24：链表反转"><a href="#面试题24：链表反转" class="headerlink" title="面试题24：链表反转"></a>面试题24：链表反转</h5><blockquote>
<p>讲一个给定的单向链表进行反转</p>
</blockquote>
<p>这道题之前已经写过了，具体请看<a href="面试题6：链表从尾到头打印"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class ListNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.next = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回ListNode</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ReverseList</span>(<span class="params">self, pHead</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pHead:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pHead.<span class="built_in">next</span>:</span><br><span class="line">            <span class="keyword">return</span> pHead</span><br><span class="line">        newHead = self.ReverseList(pHead.<span class="built_in">next</span>)</span><br><span class="line">        pHead.<span class="built_in">next</span>.<span class="built_in">next</span> = pHead</span><br><span class="line">        pHead.<span class="built_in">next</span> = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> newHead</span><br></pre></td></tr></table></figure>

<h5 id="面试题25：合并排序链表"><a href="#面试题25：合并排序链表" class="headerlink" title="面试题25：合并排序链表"></a>面试题25：合并排序链表</h5><blockquote>
<p>输入两个单调递增的链表，输出两个链表合成后的链表，当然我们需要合成后的链表满足单调不减规则。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class ListNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.next = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回合并后列表</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#非递归方法,谁小就加在当前新节点后面，结束条件是两个列表其中一个为空了，最后判断有没有其中哪个不为空的，全部放在后面</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Merge</span>(<span class="params">self, pHead1, pHead2</span>):</span><br><span class="line">        <span class="comment">#write code here</span></span><br><span class="line">        head = ListNode(<span class="number">0</span>)</span><br><span class="line">        node = head</span><br><span class="line">        <span class="keyword">while</span> pHead1 <span class="keyword">and</span> pHead2:</span><br><span class="line">            <span class="keyword">if</span> pHead1.val &lt;= pHead2.val:</span><br><span class="line">                head.<span class="built_in">next</span> = pHead1</span><br><span class="line">                head = head.<span class="built_in">next</span></span><br><span class="line">                pHead1 = pHead1.<span class="built_in">next</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                head.<span class="built_in">next</span> = pHead2</span><br><span class="line">                head = head.<span class="built_in">next</span></span><br><span class="line">                pHead2 = pHead2.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">if</span> pHead1:</span><br><span class="line">            head.<span class="built_in">next</span> = pHead1</span><br><span class="line">        <span class="keyword">if</span> pHead2:</span><br><span class="line">            head.<span class="built_in">next</span> = pHead2</span><br><span class="line">        <span class="keyword">return</span> node.<span class="built_in">next</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># 递归方法，如果list1为空，返回list2，如果list2为空，返回list1，如果都不为空，且list的值小，那么list1.next = merge(list1.next, list2)，并return list1，反之同理</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Merge</span>(<span class="params">self, pHead1, pHead2</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pHead1:</span><br><span class="line">            <span class="keyword">return</span> pHead2</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pHead2:</span><br><span class="line">            <span class="keyword">return</span> pHead1</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> pHead1.val &lt;= pHead2.val:</span><br><span class="line">            mergeHead = pHead1</span><br><span class="line">            mergeHead.<span class="built_in">next</span> =  self.Merge(pHead1.<span class="built_in">next</span>, pHead2)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            mergeHead = pHead2</span><br><span class="line">            mergeHead.<span class="built_in">next</span> =  self.Merge(pHead1, pHead2.<span class="built_in">next</span>)</span><br><span class="line">        <span class="keyword">return</span> mergeHead</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="面试题26：树的子结构"><a href="#面试题26：树的子结构" class="headerlink" title="面试题26：树的子结构"></a>面试题26：树的子结构</h5><blockquote>
<p>输入两棵二叉树A，B，判断B是不是A的子结构。（ps：我们约定空树不是任意一个树的子结构）</p>
</blockquote>
<p>基本遇到树的问题，思路都是递归，这道题一共两个递归，第一个递归遍历第一棵树，如果找到某个节点和tree2的根节点相同的，开始第二个递归，第二个递归检查tree1的左右子树的值是不是跟tree2一样，直到遍历完tree2，此时返回True，其余情况均返回false（tree1为空或者某个地方值不等）</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">HasSubtree</span>(<span class="params">self, pRoot1, pRoot2</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot2:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        result = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> pRoot1 <span class="keyword">and</span> pRoot2:</span><br><span class="line">            <span class="keyword">if</span> pRoot1.val == pRoot2.val:</span><br><span class="line">                result = self.HasSubtreeCore(pRoot1, pRoot2)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">                result = self.HasSubtreeCore(pRoot1.left, pRoot2)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">                result = self.HasSubtreeCore(pRoot1.right, pRoot2)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">HasSubtreeCore</span>(<span class="params">self,root1,root2</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root2:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root1:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> root1.val!=root2.val:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> self.HasSubtreeCore(root1.left, root2.left) <span class="keyword">and</span> self.HasSubtreeCore(root1.right, root2.right)</span><br></pre></td></tr></table></figure>

<p>还有一种写法比较简洁，思路是如果一来其中一个为空，就返回false，否则进入一个递归，分别是从当前节点判断是否包含，从左子树判断是否包含，从右子树判断是否包含。判断方法与上述的第二个函数相同。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">HasSubtree</span>(<span class="params">self, pRoot1, pRoot2</span>):        </span><br><span class="line">    	<span class="keyword">if</span> <span class="keyword">not</span> pRoot1 <span class="keyword">or</span> <span class="keyword">not</span> pRoot2:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> self.HasTreeCore(pRoot1, pRoot2) <span class="keyword">or</span> self.HasTreeCore(pRoot1.left, pRoot2) <span class="keyword">or</span> self.HasTreeCore(pRoot1.right, pRoot2)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">HasTreeCore</span>(<span class="params">self,A,B</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> B:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> A <span class="keyword">or</span> A.val!=B.val:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> self.HasTreeCore(A.left,B.left) <span class="keyword">and</span> self.HasTreeCore(A.right, B.right)</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">subTree</span><span class="params">(TreeNode root1, TreeNode root2)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (root2==<span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> subTreeCore(root1,root2) || subTreeCore(root1.left,root2) || subTreeCore(root1.right, root2);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">subTreeCore</span><span class="params">(TreeNode root1, TreeNode root2)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root2==<span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (root1==<span class="literal">null</span>)&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (root1.val==root2.val)&#123;</span><br><span class="line">      <span class="keyword">return</span> subTreeCore(root1.left,root2.left) &amp;&amp; subTreeCore(root1.right,root2.right);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<p>在python中是直接用<code>==</code>判断值是否相等的，而如果是c++，值如果定义为double类型，判断方法是两者相减是否<code>&gt;-0.000000001 &amp; &lt;0.000000001</code></p>
<p>做这道题的时候，顺便看了树的遍历方法，思路就是如果树为空，返回，如果不为空，先打印值，然后遍历左子树，然后遍历右子树，这下面的是树的前序遍历，中序遍历和后序遍历只是把print的位置换一下，如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#递归前序遍历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pre</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="built_in">print</span>(root.val)</span><br><span class="line">    pre(root.left)</span><br><span class="line">    pre(root.right)</span><br><span class="line"></span><br><span class="line"><span class="comment">#非递归前序遍历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">preNoneRecur</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    stack = []</span><br><span class="line">    node = root</span><br><span class="line">    <span class="keyword">while</span> stack <span class="keyword">or</span> node:</span><br><span class="line">        <span class="keyword">while</span> node:</span><br><span class="line">            <span class="built_in">print</span>(node.val)</span><br><span class="line">            stack.append(node)</span><br><span class="line">            node=node.left</span><br><span class="line">        node = stack.pop()</span><br><span class="line">        node = node.right</span><br><span class="line"></span><br><span class="line"><span class="comment">#递归中序遍历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">mid</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    mid(root.left)</span><br><span class="line">    <span class="built_in">print</span>(root.val)</span><br><span class="line">    mid(root.right)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非递归中序遍历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">midNoneRecur</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    stack = []</span><br><span class="line">    node = root</span><br><span class="line">    <span class="keyword">while</span> node <span class="keyword">or</span> stack:</span><br><span class="line">        <span class="keyword">while</span> node:</span><br><span class="line">            stack.append(node)</span><br><span class="line">            node = node.left</span><br><span class="line">        node = stack.pop()</span><br><span class="line">        <span class="built_in">print</span>(node.val)</span><br><span class="line">        node = node.right</span><br><span class="line"></span><br><span class="line"><span class="comment">#递归后序遍历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">last</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    last(root.left)</span><br><span class="line">    last(root.right)</span><br><span class="line">    <span class="built_in">print</span>(root.val)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 非递归后序遍历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">lastNoneRecur</span>(<span class="params">root</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    stack1 = [root]</span><br><span class="line">    stack2 = []</span><br><span class="line">    <span class="keyword">while</span> stack1:</span><br><span class="line">        node = stack1.pop()</span><br><span class="line">        <span class="keyword">if</span> node.left:</span><br><span class="line">            stack1.append(node.left)</span><br><span class="line">        <span class="keyword">if</span> node.right:</span><br><span class="line">            stack1.append(node.right)</span><br><span class="line">        stack2.append(node)</span><br><span class="line">    <span class="keyword">while</span> stack2:</span><br><span class="line">        <span class="built_in">print</span>(stack2.pop().val)</span><br></pre></td></tr></table></figure>

<p>还有层序遍历，层序遍历的思路是维护一个list，每次把当前节点的左右子节点都压入list，只要这个list不为空，就一直pop最先进入list的元素出来打印</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">layer</span>(<span class="params">tree</span>)</span><br><span class="line">		array = []</span><br><span class="line">    array.append(tree)</span><br><span class="line">    <span class="keyword">while</span> array:</span><br><span class="line">        node = array.pop(<span class="number">0</span>)</span><br><span class="line">        <span class="built_in">print</span>(node.val)</span><br><span class="line">        <span class="keyword">if</span> node.left:</span><br><span class="line">        	array.append(node.left)</span><br><span class="line">        <span class="keyword">if</span> node.right:</span><br><span class="line">        	array.append(node.right)</span><br></pre></td></tr></table></figure>

<h3 id="第四章：解决面试题的思路"><a href="#第四章：解决面试题的思路" class="headerlink" title="第四章：解决面试题的思路"></a>第四章：解决面试题的思路</h3><p>在面试中，当面试官说出题目之后，不应该立即动笔开始写代码，而是应该先理清思路，给面试官讲一遍完整的思路，再开始写。举例子和画图都是比较好的解释思路的方法。</p>
<h4 id="画图让抽象问题形象化"><a href="#画图让抽象问题形象化" class="headerlink" title="画图让抽象问题形象化"></a>画图让抽象问题形象化</h4><p>有些面试题可能比较抽象，可以尝试多画几张图，找几个例子画出来，说不定就能看出规律，从而解决问题。</p>
<h5 id="面试题27：二叉树的镜像"><a href="#面试题27：二叉树的镜像" class="headerlink" title="面试题27：二叉树的镜像"></a>面试题27：二叉树的镜像</h5><blockquote>
<p>操作给定的二叉树，将其变换为源二叉树的镜像。</p>
</blockquote>
<p>可以一开始不理解什么是镜像，画几张图就可以明白</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">二叉树的镜像定义：源二叉树 </span><br><span class="line">    	    <span class="number">8</span></span><br><span class="line">    	   /  \</span><br><span class="line">    	  <span class="number">6</span>   <span class="number">10</span></span><br><span class="line">    	 / \  / \</span><br><span class="line">    	<span class="number">5</span>  <span class="number">7</span> <span class="number">9</span> <span class="number">11</span></span><br><span class="line">    	镜像二叉树</span><br><span class="line">    	    <span class="number">8</span></span><br><span class="line">    	   /  \</span><br><span class="line">    	  <span class="number">10</span>   <span class="number">6</span></span><br><span class="line">    	 / \  / \</span><br><span class="line">    	<span class="number">11</span> <span class="number">9</span> <span class="number">7</span>  <span class="number">5</span></span><br></pre></td></tr></table></figure>

<p>这个题目和遍历很像，这是把遍历的print换成了左右子节点换顺序</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回镜像树的根节点</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Mirror</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> </span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        root.left,root.right = root.right,root.left</span><br><span class="line">        self.Mirror(root.left)</span><br><span class="line">        self.Mirror(root.right)</span><br><span class="line">        <span class="keyword">return</span> root</span><br></pre></td></tr></table></figure>

<h5 id="面试题28：对称的二叉树"><a href="#面试题28：对称的二叉树" class="headerlink" title="面试题28：对称的二叉树"></a>面试题28：对称的二叉树</h5><blockquote>
<p>请实现一个函数，用来判断一颗二叉树是不是对称的。注意，如果一个二叉树同此二叉树的镜像是同样的，定义其为对称的。</p>
</blockquote>
<p>思路：如果定义一棵树的先序遍历有两种：一种先访问左子节点，一种先访问右子节点，只要这两种遍历方式相同，那么这棵树就是对称二叉树。具体而言：左子树的左子节点变成了右子树的右子节点，左子树的右子节点，变成了右子树的左子节点，只要这个变化之后的值始终相同，那么这棵树就是对称的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">isSymmetrical</span>(<span class="params">self, pRoot</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">reverse</span>(<span class="params">left, right</span>):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> left <span class="keyword">and</span> <span class="keyword">not</span> right:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> left <span class="keyword">and</span> right <span class="keyword">and</span> left.val == right.val:</span><br><span class="line">                <span class="keyword">return</span> reverse(left.left,right.right) <span class="keyword">and</span> reverse(left.right,right.left)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">return</span> reverse(pRoot,pRoot)</span><br></pre></td></tr></table></figure>

<h5 id="面试题29：顺序打印矩阵"><a href="#面试题29：顺序打印矩阵" class="headerlink" title="面试题29：顺序打印矩阵"></a>面试题29：顺序打印矩阵</h5><blockquote>
<p>输入一个矩阵，按照从外向里以顺时针的顺序依次打印出每一个数字，例如，如果输入如下4 X 4矩阵： 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 则依次打印出数字1,2,3,4,8,12,16,15,14,13,9,5,6,7,11,10.</p>
</blockquote>
<p>这道题我一开始的思路是直接暴力解决：先一直向右，直到最右端；然后一直向下，直到最下端；然后向左，直到最左边；然后向上，到最上面。判断结束的条件是每一个节点都被访问过了，最后要求返回的值是一个包含所有元素的数组。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># matrix类型为二维列表，需要返回列表</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">printMatrix</span>(<span class="params">self, matrix</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> matrix:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(matrix[<span class="number">0</span>],<span class="built_in">int</span>):</span><br><span class="line">            <span class="keyword">return</span> matrix[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">        rows = <span class="built_in">len</span>(matrix)</span><br><span class="line">        cols = <span class="built_in">len</span>(matrix[<span class="number">0</span>])</span><br><span class="line">        result = []</span><br><span class="line">        visited = [[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(cols)] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(rows)]</span><br><span class="line">        col = <span class="number">0</span></span><br><span class="line">        row = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">sum</span>(<span class="built_in">sum</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> visited) &lt; rows * cols:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> visited[row][col]:</span><br><span class="line">                result.append(matrix[row][col])</span><br><span class="line">                visited[row][col] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> col + <span class="number">1</span> &lt; cols <span class="keyword">and</span> <span class="keyword">not</span> visited[row][col + <span class="number">1</span>]:</span><br><span class="line">                col += <span class="number">1</span></span><br><span class="line">                result.append(matrix[row][col])</span><br><span class="line">                visited[row][col] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> row + <span class="number">1</span> &lt; rows <span class="keyword">and</span> <span class="keyword">not</span> visited[row + <span class="number">1</span>][col]:</span><br><span class="line">                row += <span class="number">1</span></span><br><span class="line">                result.append(matrix[row][col])</span><br><span class="line">                visited[row][col] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> col &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> visited[row][col - <span class="number">1</span>]:</span><br><span class="line">                col -= <span class="number">1</span></span><br><span class="line">                result.append(matrix[row][col])</span><br><span class="line">                visited[row][col] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> row &gt; <span class="number">0</span> <span class="keyword">and</span> <span class="keyword">not</span> visited[row - <span class="number">1</span>][col]:</span><br><span class="line">                row -= <span class="number">1</span></span><br><span class="line">                result.append(matrix[row][col])</span><br><span class="line">                visited[row][col] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p>暴力方法虽然可以解决这个问题，但并不是一个好选择。</p>
<p>这道题的关键之处在于：顺时针打印就相当于按圈打印矩阵，每一个圈的起始点都是顺序主子矩阵的最左上方的节点</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190106114106.png"></p>
<p>那么打印到什么时候结束呢，当矩阵是4*4的时候，最后一个开始节点是(1,1)，当矩阵是5*5的时候，最后一个开始节点是(2,2)；当矩阵是5*4的时候，结束点还是(1,1)。从这几个可以总结出规律，结束条件是cols&gt;&#x3D;start*2，或者rows&gt;&#x3D;start*2</p>
<p>每一圈还有个结束条件，$endx&#x3D;cols-1-start，endy &#x3D; rows-1-start$</p>
<p>写出代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># matrix类型为二维列表，需要返回列表</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">printMatrix</span>(<span class="params">self, matrix</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> matrix <span class="keyword">or</span> <span class="built_in">len</span>(matrix)&lt;=<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        start=<span class="number">0</span></span><br><span class="line">        rows = <span class="built_in">len</span>(matrix)</span><br><span class="line">        cols = <span class="built_in">len</span>(matrix[<span class="number">0</span>])</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">while</span> start*<span class="number">2</span> &lt; rows <span class="keyword">and</span> start*<span class="number">2</span> &lt; cols:</span><br><span class="line">            result.extend(self.printCircle(start,rows,cols,matrix))</span><br><span class="line">            start+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">printCircle</span>(<span class="params">self, start,rows,cols,matrix</span>):</span><br><span class="line">        endRow = rows-<span class="number">1</span>-start</span><br><span class="line">        endCol = cols-<span class="number">1</span>-start</span><br><span class="line">        temp = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start,endCol+<span class="number">1</span>):</span><br><span class="line">            temp.append(matrix[start][i])</span><br><span class="line">        <span class="keyword">if</span> endRow&gt;start:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start+<span class="number">1</span>,endRow+<span class="number">1</span>):</span><br><span class="line">                temp.append(matrix[i][endCol])</span><br><span class="line">        <span class="keyword">if</span> endRow&gt;start <span class="keyword">and</span> endCol&gt;start:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(endCol-<span class="number">1</span>,start-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">                temp.append(matrix[endRow][i])</span><br><span class="line">        <span class="keyword">if</span> endCol&gt;start <span class="keyword">and</span> endRow&gt;start+<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(endRow-<span class="number">1</span>,start,-<span class="number">1</span>):</span><br><span class="line">                temp.append(matrix[i][start])</span><br><span class="line">        <span class="keyword">return</span> temp</span><br></pre></td></tr></table></figure>

<h4 id="举例让抽象问题具体化"><a href="#举例让抽象问题具体化" class="headerlink" title="举例让抽象问题具体化"></a>举例让抽象问题具体化</h4><p>通过举例模拟的方法来分析复杂的问题。当一眼看不出问题隐藏的规律的时候，试着用一两个具体的例子模拟操作的过程，说不定能通过具体的例子找到抽象的规律。具体例子还有助于保证代码质量。测试用例可以用来测试结果是否与预期一致。</p>
<h5 id="面试题30：包含min函数的栈"><a href="#面试题30：包含min函数的栈" class="headerlink" title="面试题30：包含min函数的栈"></a>面试题30：包含min函数的栈</h5><blockquote>
<p>定义栈的数据结构，请在该类型中实现一个能够得到栈中所含最小元素的min函数（时间复杂度应为O（1））。</p>
</blockquote>
<p>思路：一看到这道题，很可能的想法，就是直接实现一个栈，然后把栈元素的最小值保留下来，但是这种方法存在一个问题，就是如果当前pop出来的元素就是最小值，然后再求最小值就不存在了；自然而然想到把倒数第二小的元素也保存下来，那倒数第二小的元素也被pop出来了怎么办呢？这样的思路考虑下去，那就是把所有最小值都保存下来。</p>
<p>我们举个例子来模拟一下这个步骤，每次压入一个元素到stack中，同时将当前最小值压入min_stack中，每次从stack pop元素的时候，同时从min_stack pop一个元素，这样能够保证min_stack最上面的值就是当前栈的最小值。</p>
<p>这道题的关键就在于需要一个辅助栈，用于存放每一步的最小值。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190107142830.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.stack = []</span><br><span class="line">        self.min_stack = []</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">push</span>(<span class="params">self, node</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        self.stack.append(node)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.min_stack <span class="keyword">or</span> node &lt; self.min_stack[-<span class="number">1</span>]:</span><br><span class="line">            self.min_stack.append(node)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.min_stack.append(self.min_stack[-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">pop</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        pValue = self.stack.pop()</span><br><span class="line">        self.min_stack.pop()</span><br><span class="line">        <span class="keyword">return</span> pValue</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">top</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.stack:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">return</span> self.stack[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">min</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.min_stack <span class="keyword">or</span> <span class="keyword">not</span> self.stack:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">return</span> self.min_stack[-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h5 id="面试题31：栈的压入，弹出序列"><a href="#面试题31：栈的压入，弹出序列" class="headerlink" title="面试题31：栈的压入，弹出序列"></a>面试题31：栈的压入，弹出序列</h5><blockquote>
<p>输入两个整数序列，第一个序列表示栈的压入顺序，请判断第二个序列是否可能为该栈的弹出顺序。假设压入栈的所有数字均不相等。例如序列1,2,3,4,5是某栈的压入顺序，序列4,5,3,2,1是该压栈序列对应的一个弹出序列，但4,3,5,1,2就不可能是该压栈序列的弹出序列。（注意：这两个序列的长度是相等的）</p>
</blockquote>
<p>思路：给定push的顺序和pop的顺序。遍历pop顺序，如果当前要pop的元素不在栈中，将按照push顺序一直入栈到当前需要pop的元素，然后pop掉最后一个入栈的元素。遍历完整个pop序列，如果stack为空，则存在该pop序列，否则不存在。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">IsPopOrder</span>(<span class="params">self, pushV, popV</span>):</span><br><span class="line">        <span class="comment"># write code here      </span></span><br><span class="line">        n  = <span class="built_in">len</span>(pushV)</span><br><span class="line">        i=j=<span class="number">0</span></span><br><span class="line">        stack = []</span><br><span class="line">        <span class="keyword">while</span> i&lt;n <span class="keyword">and</span> j&lt;n:</span><br><span class="line">            <span class="keyword">if</span> pushV[i] != popV[j]:</span><br><span class="line">                stack.append(pushV[i])</span><br><span class="line">                i+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                i+=<span class="number">1</span></span><br><span class="line">                j+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> stack <span class="keyword">and</span> stack[-<span class="number">1</span>]==popV[j]:</span><br><span class="line">                j+=<span class="number">1</span></span><br><span class="line">                stack.pop()</span><br><span class="line">        <span class="keyword">return</span> stack==[]</span><br><span class="line">      </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">pushPopOrder</span><span class="params">(<span class="type">int</span>[] push, <span class="type">int</span>[] pop)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (push.length!=pop.length)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;push.length &amp;&amp; j&lt;pop.length)&#123;</span><br><span class="line">        <span class="keyword">if</span> (push[i]!=pop[j])&#123;</span><br><span class="line">            stack.push(push[i]);</span><br><span class="line">            i++;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            i++;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty() &amp;&amp; stack.peek()==pop[j])&#123;</span><br><span class="line">        j++;</span><br><span class="line">        stack.pop();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stack.isEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="面试题32：从上打下打印二叉树"><a href="#面试题32：从上打下打印二叉树" class="headerlink" title="面试题32：从上打下打印二叉树"></a>面试题32：从上打下打印二叉树</h5><blockquote>
<p>从上往下打印出二叉树的每个节点，同层节点从左至右打印。</p>
</blockquote>
<p>思路：这道题就是一个广度优先遍历问题，给定一个队列，先将根节点入队，只要队列不为空，pop出队列的第0个元素作为当前节点。如果当前节点的左右子节点不为空，就append到队列后面。直到queue为空，结束</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回从上到下每个节点值列表，例：[1,2,3]</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PrintFromTopToBottom</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        queue = []</span><br><span class="line">        queue.append(root)</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            node = queue.pop(<span class="number">0</span>)</span><br><span class="line">            result.append(node.val)</span><br><span class="line">            <span class="keyword">if</span> node.left:</span><br><span class="line">                queue.append(node.left)</span><br><span class="line">            <span class="keyword">if</span> node.right:</span><br><span class="line">                queue.append(node.right)</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>题目2：</p>
<blockquote>
<p>分行从上到下打印二叉树</p>
</blockquote>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190107154445.png"></p>
<p>要求同一层的节点打印在一行里面，我一开始想法是每当打印到$2^n-1​$的时候，就打印换行符。要判断是不是到了$2^n-1​$，只需要将这个值+1，然后与上(n-1)，如果这个值的二进制表示中只有一个1，那么就是$2^n​$。</p>
<p>上面的方法可以解决问题，但是比较复杂，毕竟要判断$2^n$</p>
<p>书中给的方法是给两个index，一个待打印的数目，一个下一层要打印的数目。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回从上到下每个节点值列表，例：[1,2,3]</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PrintFromTopToBottom</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        queue = []</span><br><span class="line">        queue.append(root)</span><br><span class="line">        result = []</span><br><span class="line">        toBePrinted = <span class="number">1</span></span><br><span class="line">        nextLayer = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> queue:</span><br><span class="line">            node = queue.pop(<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">print</span>(node.val)</span><br><span class="line">            toBePrinted -= <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> node.left:</span><br><span class="line">                queue.append(node.left)</span><br><span class="line">                nextLayer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> node.right:</span><br><span class="line">                queue.append(node.right)</span><br><span class="line">                nextLayer += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> toBePrinted == <span class="number">0</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                toBePrinted = nextLayer</span><br><span class="line">                nextLayer = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> resultr</span><br></pre></td></tr></table></figure>

<p>题目3：</p>
<blockquote>
<p> 之字形打印一棵二叉树</p>
</blockquote>
<img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190107154540.png" width="50%" height="50%"  style="margin: 0 auto;"/>

<p>假设根节点处于第1行，奇数行从左到右打印，偶数行从右到左打印。一开始的错误想法是，在奇数行pop(0)，偶数行pop最后一个，这样按照上面的例子，先打印1，然后打印3，然后打印7，这就乱了。</p>
<p>正确做法是使用2个栈，为什么使用2个栈，就是因为如果使用一个栈，跟上面错误思路的情况一样，那么打印3的时候，7就入栈了，下一个出栈的是7。两个栈，奇数行先添加右节点，再添加左节点，偶数行正常添加。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回从上到下每个节点值列表，例：[1,2,3]</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PrintFromTopToBottom</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        queue_odd = []</span><br><span class="line">        queue_even = [root]</span><br><span class="line">        nextLayer = <span class="number">0</span></span><br><span class="line">        toBePrinted = <span class="number">1</span></span><br><span class="line">        layer = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> queue_even <span class="keyword">or</span> queue_odd:</span><br><span class="line">            <span class="keyword">if</span> layer &amp; <span class="number">0x1</span>:</span><br><span class="line">                node = queue_odd.pop()</span><br><span class="line">                <span class="built_in">print</span>(node.val,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                toBePrinted-=<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> node.right:</span><br><span class="line">                    queue_even.append(node.right)</span><br><span class="line">                    nextLayer+=<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> node.left:</span><br><span class="line">                    queue_even.append(node.left)</span><br><span class="line">                    nextLayer+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                node = queue_even.pop()</span><br><span class="line">                <span class="built_in">print</span>(node.val,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">                toBePrinted-=<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> node.left:</span><br><span class="line">                    queue_odd.append(node.left)</span><br><span class="line">                    nextLayer+=<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> node.right:</span><br><span class="line">                    queue_odd.append(node.right)</span><br><span class="line">                    nextLayer+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> toBePrinted==<span class="number">0</span>:</span><br><span class="line">                toBePrinted = nextLayer</span><br><span class="line">                nextLayer = <span class="number">0</span></span><br><span class="line">                layer+=<span class="number">1</span></span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>或者改进一下，减少flag的数量，只用一个layer变量，每次用1-layer</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回从上到下每个节点值列表，例：[1,2,3]</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PrintFromTopToBottom</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        queue = [[],[]]</span><br><span class="line">        layer = <span class="number">0</span></span><br><span class="line">        queue[layer].append(root)</span><br><span class="line">        <span class="keyword">while</span> queue[<span class="number">0</span>] <span class="keyword">or</span> queue[<span class="number">1</span>]:</span><br><span class="line">            node = queue[layer].pop()</span><br><span class="line">            <span class="keyword">if</span> layer:</span><br><span class="line">                <span class="keyword">if</span> node.right:</span><br><span class="line">                    queue[<span class="number">1</span>-layer].append(node.right)</span><br><span class="line">                <span class="keyword">if</span> node.left:</span><br><span class="line">                    queue[<span class="number">1</span>-layer].append(node.left)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">if</span> node.left:</span><br><span class="line">                    queue[<span class="number">1</span>-layer].append(node.left)</span><br><span class="line">                <span class="keyword">if</span> node.right:</span><br><span class="line">                    queue[<span class="number">1</span>-layer].append(node.right)</span><br><span class="line">            <span class="built_in">print</span>(node.val,end=<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> queue[layer]:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">                layer = <span class="number">1</span>-layer</span><br></pre></td></tr></table></figure>

<h5 id="面试题33：二叉排序树的后序遍历"><a href="#面试题33：二叉排序树的后序遍历" class="headerlink" title="面试题33：二叉排序树的后序遍历"></a>面试题33：二叉排序树的后序遍历</h5><blockquote>
<p>输入一个整数数组，判断该数组是不是某二叉搜索树的后序遍历的结果。如果是则输出True,否则输出False。假设输入的数组的任意两个数字都互不相同。</p>
</blockquote>
<p><strong>二叉查找树</strong>（英语：Binary Search Tree），也称为<strong>二叉搜索树</strong>、<strong>有序二叉树</strong>（ordered binary tree）或<strong>排序二叉树</strong>（sorted binary tree），是指一棵空树或者具有下列性质的<a href="https://zh.wikipedia.org/wiki/%E4%BA%8C%E5%8F%89%E6%A0%91">二叉树</a>：</p>
<ol>
<li>若任意节点的左子树不空，则左子树上所有节点的值均小于它的根节点的值；</li>
<li>若任意节点的右子树不空，则右子树上所有节点的值均大于它的根节点的值；</li>
<li>任意节点的左、右子树也分别为二叉查找树；</li>
<li>没有键值相等的节点。</li>
</ol>
<p>简单来说就是，根节点的左子树的所有节点都比根节点小，右子树的所有节点都比根节点大，且没有重复节点。</p>
<p>要判断一个序列是不是二叉排序树，那就要找出左右子树，然后判断左右子树是不是满足上面的要求，并判断左右子树是不是二叉排序树。</p>
<p>二叉排序树的最后一个节点一定是根节点，第一个比根节点大的值是左右子树的分界线。</p>
<p>先排除意外情况，如果输入为空，返回False；否则进入递归函数。</p>
<p>递归函数是首先从左到右找到第一个比根节点大的值，然后向右一直搜索到最后一个元素，如果中间出现任何一个元素小于根节点，那么就证明不是二叉排序树，返回False。如果一直到最后一个都满足条件，那么就判断左右子树是不是二叉排序树，最后返回left和right子树的and结果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">VerifySquenceOfBST</span>(<span class="params">self, sequence</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> sequence:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> self.verifyCore(sequence)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">verifyCore</span>(<span class="params">self, sequence</span>):</span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> sequence[i] &lt; sequence[-<span class="number">1</span>]:</span><br><span class="line">            i+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i,<span class="built_in">len</span>(sequence)):</span><br><span class="line">            <span class="keyword">if</span> sequence[j] &lt; sequence[-<span class="number">1</span>]:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        left = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> i&gt;<span class="number">0</span>:</span><br><span class="line">            left = self.verifyCore(sequence[:i])</span><br><span class="line">        right = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> i&lt;<span class="built_in">len</span>(sequence)-<span class="number">1</span>:</span><br><span class="line">            right = self.verifyCore(sequence[i:-<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">return</span> left <span class="keyword">and</span> right</span><br></pre></td></tr></table></figure>

<p>java版本</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isPostVisitCore</span><span class="params">(<span class="type">int</span>[] nums,<span class="type">int</span> start,<span class="type">int</span> end)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (start&gt;=end)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">rootVal</span> <span class="operator">=</span> nums[end];</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start;</span><br><span class="line">    <span class="keyword">for</span> (; i &lt; end; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[i]&gt;rootVal)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> i;</span><br><span class="line">    <span class="keyword">while</span> (i&lt;end)&#123;</span><br><span class="line">        <span class="keyword">if</span> (nums[i]&lt;rootVal)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isPostVisitCore(nums,start,index-<span class="number">1</span>) &amp;&amp; isPostVisitCore(nums,index,end-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题34：二叉树中和为某一值的路径"><a href="#面试题34：二叉树中和为某一值的路径" class="headerlink" title="面试题34：二叉树中和为某一值的路径"></a>面试题34：二叉树中和为某一值的路径</h5><blockquote>
<p>输入一颗二叉树的根节点和一个整数，打印出二叉树中结点值的和为输入整数的所有路径。路径定义为从树的根结点开始往下一直到叶结点所经过的结点形成一条路径。(注意: 在返回值的list中，数组长度大的数组靠前)</p>
</blockquote>
<p>思路：先判断给定的是不是空，如果是空，直接返回空list。否则累积加和，如果加和等于值，就把刚才记录的所有值都放入result list中，如果没到叶节点，那么继续向下。递归实现。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TreeNode</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x</span>):</span><br><span class="line">        self.val = x</span><br><span class="line">        self.left = <span class="literal">None</span></span><br><span class="line">        self.right = <span class="literal">None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回二维列表，内部每个列表表示找到的路径</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindPath</span>(<span class="params">self, root, expectNumber</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        result = []</span><br><span class="line">        self.FindPathCore(root, expectNumber,<span class="number">0</span>,result,[])</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindPathCore</span>(<span class="params">self,root, expectNumber,currNum,result,hisNode</span>):</span><br><span class="line">        <span class="keyword">if</span> root:</span><br><span class="line">            currNum += root.val</span><br><span class="line">            <span class="keyword">if</span> currNum == expectNumber <span class="keyword">and</span> <span class="keyword">not</span> root.left <span class="keyword">and</span> <span class="keyword">not</span> root.right:</span><br><span class="line">                hisNode.append(root.val)</span><br><span class="line">                result.append([i <span class="keyword">for</span> i <span class="keyword">in</span> hisNode])</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                hisNode.append(root.val)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> root.left:</span><br><span class="line">                    self.FindPathCore(root.left, expectNumber,currNum,result,hisNode)</span><br><span class="line">                    hisNode.pop()</span><br><span class="line">                <span class="keyword">if</span> root.right:</span><br><span class="line">                    self.FindPathCore(root.right,expectNumber,currNum,result,hisNode)</span><br><span class="line">                    hisNode.pop()</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ArrayList&lt;ArrayList&lt;Integer&gt;&gt; <span class="title function_">sumPath</span><span class="params">(TreeNode root, <span class="type">int</span> target)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;ArrayList&lt;Integer&gt;&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    ArrayList&lt;Integer&gt; temp = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    sumPathCore(root, target, temp, res, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sumPathCore</span><span class="params">(TreeNode root, <span class="type">int</span> target, ArrayList&lt;Integer&gt; temp, ArrayList&lt;ArrayList&lt;Integer&gt;&gt; res, <span class="type">int</span> sum)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root != <span class="literal">null</span>) &#123;</span><br><span class="line">        sum += root.val;</span><br><span class="line">        temp.add(root.val);</span><br><span class="line">        <span class="keyword">if</span> (sum == target) &#123;</span><br><span class="line">            res.add(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(temp));</span><br><span class="line">            temp = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root.left != <span class="literal">null</span>) &#123;</span><br><span class="line">            sumPathCore(root.left, target, temp, res, sum);</span><br><span class="line">            temp.remove(temp.size()-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (root.right!=<span class="literal">null</span>)&#123;</span><br><span class="line">            sumPathCore(root.right, target, temp, res, sum);</span><br><span class="line">            temp.remove(temp.size()-<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="分解让复杂问题简单化"><a href="#分解让复杂问题简单化" class="headerlink" title="分解让复杂问题简单化"></a>分解让复杂问题简单化</h4><h5 id="面试题35：复杂链表的复制"><a href="#面试题35：复杂链表的复制" class="headerlink" title="面试题35：复杂链表的复制"></a>面试题35：复杂链表的复制</h5><blockquote>
<p>输入一个复杂链表（每个节点中有节点值，以及两个指针，一个指向下一个节点，另一个特殊指针指向任意一个节点），返回结果为复制后复杂链表的head。（注意，输出结果中请不要返回参数中的节点引用，否则判题程序会直接返回空）</p>
</blockquote>
<p>思路：这道题主要思路，如果从直观来讲，我们先复制所有节点的值以及他们的next关系，第二步去复制random关系，在找random关系的时候，就要从头到尾一个一个找到random节点，如果在原始链表上走s步找到了这个random节点，那么只需要在新链表上同样走s步找到这个新节点。对于长度为n的链表，每次找到random节点都需要O(n)的时间复杂度，因此这种方法总时间复杂度为$O(n^2)​$。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#-*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment">#class RandomListNode:</span></span><br><span class="line"><span class="comment">#    def __init__(self, x):</span></span><br><span class="line"><span class="comment">#        self.label = x</span></span><br><span class="line"><span class="comment">#        self.next = None</span></span><br><span class="line"><span class="comment">#        self.random = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回 RandomListNode</span></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Clone</span>(<span class="params">pHead</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="comment"># 逐个节点进行复制</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pHead:</span><br><span class="line">            <span class="keyword">return</span> pHead</span><br><span class="line">        pCur = pHead</span><br><span class="line">        newHead = RandomListNode(pCur.label)</span><br><span class="line">        node = newHead</span><br><span class="line">        pCur = pCur.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">while</span> pCur:</span><br><span class="line">            pCopy = RandomListNode(pCur.label)</span><br><span class="line">            node.<span class="built_in">next</span> = pCopy</span><br><span class="line">            node = node.<span class="built_in">next</span></span><br><span class="line">            pCur = pCur.<span class="built_in">next</span></span><br><span class="line"></span><br><span class="line">        pCur = pHead</span><br><span class="line">        node = newHead</span><br><span class="line">        <span class="comment"># 复制随机节点</span></span><br><span class="line">        <span class="keyword">while</span> pCur:</span><br><span class="line">            <span class="keyword">if</span> pCur.random:</span><br><span class="line">                index = <span class="number">0</span></span><br><span class="line">                pNode = pHead</span><br><span class="line">                <span class="keyword">while</span> pNode.label != pCur.random.label <span class="keyword">or</span> pNode.<span class="built_in">next</span> != pCur.random.<span class="built_in">next</span> <span class="keyword">or</span> pNode.random != pCur.random.random:</span><br><span class="line">                    index += <span class="number">1</span></span><br><span class="line">                    pNode = pNode.<span class="built_in">next</span></span><br><span class="line">                Tempnode = newHead</span><br><span class="line">                <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(index):</span><br><span class="line">                    Tempnode = Tempnode.<span class="built_in">next</span></span><br><span class="line">                node.random = Tempnode</span><br><span class="line">            pCur = pCur.<span class="built_in">next</span></span><br><span class="line">            node = node.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">return</span> newHead</span><br></pre></td></tr></table></figure>

<p>由于这种方法最主要的时间损耗在于寻找random节点，尝试对该方法进行优化，第一步仍然是复制节点和next关系，但是区别是将这些复制的节点插入到原始链表中，第二步仍然是复制随机节点，这个时候新链表的值就是pCur.next，他的random就指向原始节点pCur的随机节点的复制值，也就是pCur.random.next，就是这个地方大大提升了效率。最后一步是拆分成2个独立的链表。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190217205450.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class RandomListNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.label = x</span></span><br><span class="line"><span class="comment">#         self.next = None</span></span><br><span class="line"><span class="comment">#         self.random = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回 RandomListNode</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Clone</span>(<span class="params">self, pHead</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="comment"># 逐个节点进行复制</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pHead:</span><br><span class="line">            <span class="keyword">return</span> pHead</span><br><span class="line">        pCur = pHead</span><br><span class="line">        <span class="keyword">while</span> pCur:</span><br><span class="line">            pCopy = RandomListNode(pCur.label)</span><br><span class="line">            pNext = pCur.<span class="built_in">next</span></span><br><span class="line">            pCopy.<span class="built_in">next</span> = pNext</span><br><span class="line">            pCur.<span class="built_in">next</span> = pCopy</span><br><span class="line">            pCur = pNext</span><br><span class="line">            </span><br><span class="line">        pCur = pHead</span><br><span class="line">        <span class="comment"># 复制随机节点</span></span><br><span class="line">        <span class="keyword">while</span> pCur:</span><br><span class="line">            pCur.<span class="built_in">next</span>.random = pCur.random.<span class="built_in">next</span> <span class="keyword">if</span> pCur.random <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            pCur = pCur.<span class="built_in">next</span>.<span class="built_in">next</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 拆分</span></span><br><span class="line">        pCur = pHead</span><br><span class="line">        newHead = pCur.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">while</span> pCur:</span><br><span class="line">            pCopy = pCur.<span class="built_in">next</span></span><br><span class="line">            pCur.<span class="built_in">next</span> = pCopy.<span class="built_in">next</span></span><br><span class="line">            pCopy.<span class="built_in">next</span> = pCopy.<span class="built_in">next</span>.<span class="built_in">next</span> <span class="keyword">if</span> pCopy.<span class="built_in">next</span> <span class="keyword">else</span> <span class="literal">None</span></span><br><span class="line">            pCur = pCur.<span class="built_in">next</span></span><br><span class="line">            </span><br><span class="line">        <span class="keyword">return</span> newHead</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">RandomListNode</span> &#123;</span><br><span class="line">    <span class="type">int</span> label;</span><br><span class="line">    <span class="type">RandomListNode</span> <span class="variable">next</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">RandomListNode</span> <span class="variable">random</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    RandomListNode(<span class="type">int</span> label) &#123;</span><br><span class="line">        <span class="built_in">this</span>.label = label;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> RandomListNode <span class="title function_">copy</span><span class="params">(RandomListNode head)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (head == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RandomListNode</span> <span class="variable">node</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="keyword">while</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">RandomListNode</span> <span class="variable">temp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RandomListNode</span>(node.label);</span><br><span class="line">        <span class="type">RandomListNode</span> <span class="variable">next</span> <span class="operator">=</span> node.next;</span><br><span class="line">        node.next = temp;</span><br><span class="line">        temp.next = next;</span><br><span class="line">        node = next;</span><br><span class="line">    &#125;</span><br><span class="line">    node = head;</span><br><span class="line">    <span class="keyword">while</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.random != <span class="literal">null</span>) &#123;</span><br><span class="line">            node.next.random = node.random.next;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.next.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">RandomListNode</span> <span class="variable">newHead</span> <span class="operator">=</span> head.next;</span><br><span class="line">    <span class="type">RandomListNode</span> <span class="variable">copyNode</span> <span class="operator">=</span> newHead;</span><br><span class="line">    node = head;</span><br><span class="line">    <span class="keyword">while</span> (node != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (copyNode.next != <span class="literal">null</span>) &#123;</span><br><span class="line">            copyNode.next = copyNode.next.next;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            copyNode.next = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node.next.next;</span><br><span class="line">        node = node.next;</span><br><span class="line">        copyNode = copyNode.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> newHead;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="面试题36：二叉搜索树与双向链表"><a href="#面试题36：二叉搜索树与双向链表" class="headerlink" title="面试题36：二叉搜索树与双向链表"></a>面试题36：二叉搜索树与双向链表</h5><blockquote>
<p>输入一棵二叉搜索树，将该二叉搜索树转换成一个排序的双向链表。要求不能创建任何新的结点，只能调整树中结点指针的指向</p>
</blockquote>
<p>思路：一颗二叉搜索树本身就是排序好的，左子树节点一定小于根节点，右子树节点一定大于根节点，既然要排序，类似于中序遍历的方法，在找到左子树的最大节点时，将左子树的最大节点与根节点双向连接起来；将右子树的最小节点与左子树连接起来。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Convert</span>(<span class="params">self, pRootOfTree</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRootOfTree:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRootOfTree.left <span class="keyword">and</span> <span class="keyword">not</span> pRootOfTree.right:</span><br><span class="line">            <span class="keyword">return</span> pRootOfTree</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将左子树转换为双向链表</span></span><br><span class="line">        left = self.Convert(pRootOfTree.left)</span><br><span class="line">        <span class="comment"># 将左子树的最大节点与根节点连接</span></span><br><span class="line">        <span class="keyword">if</span> left:</span><br><span class="line">            <span class="keyword">while</span> left.right:</span><br><span class="line">                left = left.right</span><br><span class="line">            left.right = pRootOfTree</span><br><span class="line">            pRootOfTree.left =  left</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 将右子树转换为双向链表</span></span><br><span class="line">        right = self.Convert(pRootOfTree.right)</span><br><span class="line">        <span class="comment"># 将右子树的最大节点与根节点连接</span></span><br><span class="line">        <span class="keyword">if</span> right:</span><br><span class="line">            <span class="keyword">while</span> right.left:</span><br><span class="line">                right = right.left</span><br><span class="line">            right.left = pRootOfTree</span><br><span class="line">            pRootOfTree.right =  right</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 找到双向链表的起始节点，也就是树的最小节点</span></span><br><span class="line">        <span class="keyword">while</span> pRootOfTree.left:</span><br><span class="line">            pRootOfTree = pRootOfTree.left</span><br><span class="line">        <span class="keyword">return</span> pRootOfTree</span><br></pre></td></tr></table></figure>

<h5 id="面试题37：序列化二叉树"><a href="#面试题37：序列化二叉树" class="headerlink" title="面试题37：序列化二叉树"></a>面试题37：序列化二叉树</h5><blockquote>
<p>请实现两个函数，分别用来序列化和反序列化二叉树</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.flag = -<span class="number">1</span></span><br><span class="line">         </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Serialize</span>(<span class="params">self, root</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;#&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(root.val)+<span class="string">&#x27;,&#x27;</span>+self.Serialize(root.left)+<span class="string">&#x27;,&#x27;</span>self.Serialize(root.right)</span><br><span class="line">         </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Deserialize</span>(<span class="params">self, s</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        self.flag += <span class="number">1</span></span><br><span class="line">        l = s.split(<span class="string">&#x27;,&#x27;</span>)</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> self.flag &gt;= <span class="built_in">len</span>(s):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        root = <span class="literal">None</span></span><br><span class="line">         </span><br><span class="line">        <span class="keyword">if</span> l[self.flag] != <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">            root = TreeNode(<span class="built_in">int</span>(l[self.flag]))</span><br><span class="line">            root.left = self.Deserialize(s)</span><br><span class="line">            root.right = self.Deserialize(s)</span><br><span class="line">        <span class="keyword">return</span> root</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">serialize</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (root == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;#&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root.val + <span class="string">&quot;,&quot;</span> + serialize(root.left) + <span class="string">&quot;,&quot;</span> + serialize(root.right);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">flag</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> TreeNode <span class="title function_">deSerialize</span><span class="params">(String s)</span> &#123;</span><br><span class="line">    flag++;</span><br><span class="line">    <span class="type">TreeNode</span> <span class="variable">root</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (flag &lt; s.length()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.charAt(flag) == <span class="string">&#x27;#&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            root = <span class="keyword">new</span> <span class="title class_">TreeNode</span>(s.charAt(flag) - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">            root.left = deSerialize(s);</span><br><span class="line">            root.right = deSerialize(s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> root;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题38：字符串的排列"><a href="#面试题38：字符串的排列" class="headerlink" title="面试题38：字符串的排列"></a>面试题38：字符串的排列</h5><blockquote>
<p>输入一个字符串,按字典序打印出该字符串中字符的所有排列。例如输入字符串abc,则打印出由字符a,b,c所能排列出来的所有字符串abc,acb,bac,bca,cab和cba。</p>
</blockquote>
<p>python有比较取巧的办法，itertools里面有purmutations这个函数，直接列出所有可能的排列组合，然后用’’.join连接起来并去重就得到了结果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> permutations</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Permutation</span>(<span class="params">self,ss</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(ss):</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        letters = <span class="built_in">sorted</span>([i <span class="keyword">for</span> i <span class="keyword">in</span> ss])</span><br><span class="line">        <span class="comment"># result = []</span></span><br><span class="line">        <span class="comment"># index = [i for i in range(1, len(letters) + 1)]</span></span><br><span class="line">        result = <span class="built_in">list</span>(permutations(letters))</span><br><span class="line">        result = <span class="built_in">sorted</span>(<span class="built_in">list</span>(<span class="built_in">set</span>([<span class="string">&#x27;&#x27;</span>.join(i) <span class="keyword">for</span> i <span class="keyword">in</span> result])))</span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>如果用正常的思路，应该是通过交换得到，从第一位开始，与后面每一位交换得到组合结果</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190218091606.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Permutation</span>(<span class="params">self,ss</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">len</span>(ss):</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        letters = [i <span class="keyword">for</span> i <span class="keyword">in</span> ss]</span><br><span class="line">        result = []</span><br><span class="line">        self.perHelper(letters, <span class="number">0</span>, result)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">sorted</span>(result)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">perHelper</span>(<span class="params">self, letters, i, result</span>):</span><br><span class="line">        <span class="keyword">if</span> i==<span class="built_in">len</span>(letters)-<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;&#x27;</span>.join(letters) <span class="keyword">not</span> <span class="keyword">in</span> result:</span><br><span class="line">                result.append(<span class="string">&quot;&quot;</span>.join(letters))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(i,<span class="built_in">len</span>(letters)):</span><br><span class="line">                letters[i],letters[j] = letters[j],letters[i]</span><br><span class="line">                self.perHelper(letters, i+<span class="number">1</span>, result)</span><br><span class="line">                letters[i],letters[j] = letters[j],letters[i]</span><br></pre></td></tr></table></figure>

<p><strong>总结：</strong></p>
<p><strong>求排列的方法</strong>：传入一个字符串切割好的list，固定第i位，交换i（自己与自己交换保持位置）及后面的位数，直到已经换到了最后一位了，把结果放入result中。</p>
<p><strong>求组合的方法</strong>：传入一个由字符串切割得到的list，要得到长度为m的组合（m可能为0-n，其中n为字符串的总长度），此时可以分为2种情况：选择list的第一位，然后在list的剩下内容中选择m-1位；不选第一位，在list的剩下内容中选择m位，当需要选择的位数为0的时候，证明长度已经达到了需要的长度，此时直接join出结果并存入result中即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getCombine</span>(<span class="params">s</span>):</span><br><span class="line">    l = [i <span class="keyword">for</span> i <span class="keyword">in</span> s]</span><br><span class="line">    result = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(l)+<span class="number">1</span>):</span><br><span class="line">        temp = []</span><br><span class="line">        comBineCore(l, i, temp,result)</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">comBineCore</span>(<span class="params">l, i, temp,result</span>):</span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">        result.append(<span class="string">&#x27;&#x27;</span>.join(temp))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> l:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    temp.append(l[<span class="number">0</span>])</span><br><span class="line">    comBineCore(l[<span class="number">1</span>:], i-<span class="number">1</span>, temp,result)</span><br><span class="line">    temp.pop()</span><br><span class="line">    comBineCore(l[<span class="number">1</span>:], i, temp,result)</span><br></pre></td></tr></table></figure>

<h3 id="第五章：时间效率"><a href="#第五章：时间效率" class="headerlink" title="第五章：时间效率"></a>第五章：时间效率</h3><h5 id="面试题39：数组中出现次数超过一半的数字"><a href="#面试题39：数组中出现次数超过一半的数字" class="headerlink" title="面试题39：数组中出现次数超过一半的数字"></a>面试题39：数组中出现次数超过一半的数字</h5><blockquote>
<p>数组中有一个数字出现的次数超过数组长度的一半，请找出这个数字。例如输入一个长度为9的数组{1,2,3,2,2,2,5,4,2}。由于数字2在数组中出现了5次，超过数组长度的一半，因此输出2。如果不存在则输出0。</p>
</blockquote>
<p><strong>方法一：字典计数</strong></p>
<p>这种方法直接遍历一遍数组，但是需要辅助的字典来存储每个数字出现的次数，时间复杂度为o(n)，空间复杂度为o(n)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">MoreThanHalfNum_Solution</span>(<span class="params">numbers</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        numDict = &#123;&#125;</span><br><span class="line">        length = <span class="built_in">len</span>(numbers)/<span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> numbers:</span><br><span class="line">            <span class="keyword">if</span> i <span class="keyword">not</span> <span class="keyword">in</span> numDict.keys():</span><br><span class="line">                numDict[i] = <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                numDict[i] += <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> key,value <span class="keyword">in</span> numDict.items():</span><br><span class="line">            <span class="keyword">if</span> value &gt; length:</span><br><span class="line">                <span class="keyword">return</span> key</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><strong>方法二：基于快排的partion函数</strong></p>
<p>因为要找的是出现次数超过一半的数，那么这个数一定是横跨length&#x2F;2的，因为只要超过一半，中位数那个值一定是需要找的值，那么我们只需要找到中位数就行了。利用partion函数，每次找一个值，直到找到中位数的值。</p>
<p>partion函数是随机选一个数，把所有小于选中值的放在其左边，大于选中值的放在其右边，如果此时选中值的index小于length&#x2F;2，那么证明中位数在其右边，反之证明中位数在其左边，循环换值，直到找到中位数。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法2：基于partion函数</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">MoreThanHalfNum_Solution</span>(<span class="params">self,numbers</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        middle = <span class="built_in">int</span>(<span class="built_in">len</span>(numbers)/<span class="number">2</span>)</span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        end = <span class="built_in">len</span>(numbers) -<span class="number">1</span></span><br><span class="line">        index = self.partion(numbers,start,end)</span><br><span class="line">        <span class="keyword">while</span> index!=middle:</span><br><span class="line">            <span class="keyword">if</span> index &gt; middle:</span><br><span class="line">                end = index - <span class="number">1</span></span><br><span class="line">                index = self.partion(numbers, start, end)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                start = index + <span class="number">1</span></span><br><span class="line">                index = self.partion(numbers, start, end)</span><br><span class="line">        result = numbers[index]</span><br><span class="line">        <span class="keyword">if</span> self.checkIsMoreThanHalf(numbers,result):</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">partion</span>(<span class="params">self, numbers, start, end</span>):</span><br><span class="line">        x = numbers[end]</span><br><span class="line">        s = start -<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start,end):</span><br><span class="line">            <span class="keyword">if</span> numbers[i] &lt; x:</span><br><span class="line">                s+=<span class="number">1</span></span><br><span class="line">                numbers[i],numbers[s] = numbers[s], numbers[i]</span><br><span class="line">        s+=<span class="number">1</span></span><br><span class="line">        numbers[s],numbers[end] = numbers[end], numbers[s]</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkIsMoreThanHalf</span>(<span class="params">self, numbers, result</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        half = <span class="built_in">len</span>(numbers)/<span class="number">2</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> numbers:</span><br><span class="line">            <span class="keyword">if</span> i==result:</span><br><span class="line">                count+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> count&gt;half:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<p>方法三：基于数组特点进行查找</p>
<p>一个数字如果出现次数超过数组长度的一半，那么这个数字出现的次数就比其它所有数字出现次数的和还要多</p>
<p>我们利用两个变量：numNow和countNow来表示当前指定的数和其出现的次数。</p>
<ul>
<li>如果countNow大于0，出现一个和numNow相同的值，那么countNow+1,；出现一个和numNow不同的值，countNow减1。</li>
<li>如果countNow小于等于0，那么就需要更换当前的数字</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">MoreThanHalfNum_Solution</span>(<span class="params">self,numbers</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        count = <span class="number">1</span></span><br><span class="line">        num = numbers[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> numbers[<span class="number">1</span>:]:</span><br><span class="line">            <span class="keyword">if</span> i==num:</span><br><span class="line">                count+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                count-=<span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> count==<span class="number">0</span>:</span><br><span class="line">                num = i</span><br><span class="line">                count=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> self.checkIsMoreThanHalf(numbers,num):</span><br><span class="line">            <span class="keyword">return</span> num</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">checkIsMoreThanHalf</span>(<span class="params">self, numbers, result</span>):</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        half = <span class="built_in">len</span>(numbers)/<span class="number">2</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> numbers:</span><br><span class="line">            <span class="keyword">if</span> i==result:</span><br><span class="line">                count+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> count&gt;half:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>

<h5 id="面试题40：数组中最小的k个值"><a href="#面试题40：数组中最小的k个值" class="headerlink" title="面试题40：数组中最小的k个值"></a>面试题40：数组中最小的k个值</h5><blockquote>
<p>输入n个整数，找出其中最小的K个数。例如输入4,5,1,6,2,7,3,8这8个数字，则最小的4个数字是1,2,3,4,。</p>
</blockquote>
<p><strong>方法一：利用partion函数进行排序*，时间复杂度为O(n)</strong></p>
<p>在可以改变数组的情况下，用partion进行排序，找到第k大的值，partion是将比选定值小的放在左边，比选定值大的放在右边，那么k之前的就是最小的k个值</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetLeastNumbers_Solution</span>(<span class="params">self, tinput, k</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(tinput)&lt;k <span class="keyword">or</span> <span class="built_in">len</span>(tinput)&lt;=<span class="number">0</span> <span class="keyword">or</span> k&lt;=<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        end = <span class="built_in">len</span>(tinput)-<span class="number">1</span></span><br><span class="line">        index = self.partion(tinput, start, end)</span><br><span class="line">        <span class="keyword">while</span> index!= k-<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">if</span> index &lt; k-<span class="number">1</span>:</span><br><span class="line">                start = index+<span class="number">1</span></span><br><span class="line">                index = self.partion(tinput, start, end)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                end = index - <span class="number">1</span></span><br><span class="line">                index = self.partion(tinput, start, end)</span><br><span class="line">        <span class="keyword">return</span> tinput[:index+<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">partion</span>(<span class="params">self, tinput, start, end</span>):</span><br><span class="line">        x = tinput[end]</span><br><span class="line">        s = start - <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(start, end):</span><br><span class="line">            <span class="keyword">if</span> tinput[i] &lt; x:</span><br><span class="line">                s+=<span class="number">1</span></span><br><span class="line">                tinput[i],tinput[s] = tinput[s],tinput[i]</span><br><span class="line">        s += <span class="number">1</span></span><br><span class="line">        tinput[end], tinput[s] = tinput[s], tinput[end]</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>方法二：时间复杂度为O(nlogk)的方法，基于红黑树</strong></p>
<h5 id="面试题41：数据流中的中位数"><a href="#面试题41：数据流中的中位数" class="headerlink" title="面试题41：数据流中的中位数"></a>面试题41：数据流中的中位数</h5><blockquote>
<p>如何得到一个数据流中的中位数？如果从数据流中读出奇数个数值，那么中位数就是所有数值排序之后位于中间的数值。如果从数据流中读出偶数个数值，那么中位数就是所有数值排序之后中间两个数的平均值。我们使用Insert()方法读取数据流，使用GetMedian()方法获取当前读取数据的中位数。</p>
</blockquote>
<p>这道题的方法是使用两个堆，一个最大堆，一个最小堆，同时保证最小堆的最小值比最大堆的最大值更大，在当前元素个数为偶数的时候，新来的元素加入最小堆，当前元素个数为奇数的时候，新来的元素加入最大堆。</p>
<h5 id="面试题42：连续子数组的最大和"><a href="#面试题42：连续子数组的最大和" class="headerlink" title="面试题42：连续子数组的最大和"></a>面试题42：连续子数组的最大和</h5><blockquote>
<p>输入一个整形数组，数组里有正数有负数。数组的一个或连续多个数组组成一个子数组。求所有子数组的和的最大值。要求时间复杂度为O(n)</p>
</blockquote>
<p>这道题最直观的思路，就是枚举所有子数组并求和，子数组的总数是n*(n-1)&#x2F;2（长度为1的子数组有n个，长度为2的子数组有n-1个…长度为n的子数组有1个，所以总个数是n+n-1+n-2+…+1），这样时间复杂度至少为$O(n^2)$。</p>
<p>正确的做法是使用动态规划，累计加和数组中的元素，如果当前累积和大于0，那么下一次加和的时候继续加上这个累计和，如果当前结果已经小于0了，呢么下一次加和的时候就舍弃前面的累积和，重新加和。这样得到的结果就是加到当前位置的最大累计和。也就是子数组的最大和。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindGreatestSumOfSubArray</span>(<span class="params">self, array</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line"></span><br><span class="line">        maxhere = array[<span class="number">0</span>]</span><br><span class="line">        maxv = array[<span class="number">0</span>]</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="built_in">len</span>(array)):</span><br><span class="line">            <span class="keyword">if</span> maxhere &lt;= <span class="number">0</span>:</span><br><span class="line">                maxhere = array[i]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                maxhere += array[i]</span><br><span class="line">            <span class="keyword">if</span> maxhere&gt;maxv:</span><br><span class="line">                maxv = maxhere</span><br><span class="line">        <span class="keyword">return</span> maxv</span><br></pre></td></tr></table></figure>

<h5 id="面试题43：1-n中数字1出现的次数"><a href="#面试题43：1-n中数字1出现的次数" class="headerlink" title="面试题43：1~n中数字1出现的次数"></a>面试题43：1~n中数字1出现的次数</h5><blockquote>
<p>求出1<del>13的整数中1出现的次数,并算出100</del>1300的整数中1出现的次数？为此他特别数了一下1~13中包含1的数字有1、10、11、12、13因此共出现6次,但是对于后面问题他就没辙了。ACMer希望你们帮帮他,并把问题更加普遍化,可以很快的求出任意非负整数区间中1出现的次数（从1 到 n 中1出现的次数）。</p>
</blockquote>
<p>最直观的方法肯定是通过循环，对每个数有多少个1进行判断，代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">NumberOf1Between1AndN_Solution</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,n+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">for</span> letter <span class="keyword">in</span> <span class="built_in">str</span>(i):</span><br><span class="line">                <span class="keyword">if</span> letter==<span class="string">&#x27;1&#x27;</span>:</span><br><span class="line">                    count+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br></pre></td></tr></table></figure>

<p>这种方法的时间复杂度太高了，因此需要进行优化。</p>
<p>剑指offer上面给出的优化方法是：给定一个数，例如21345，我们先看他是五位数的时候，有多少个1，再看他4位数有多少个1，再看2位数有多少个1，直到为1位数，递归求得总共1的数目。</p>
<p>在判断每次有多少个1的时候，又可以分为这样的方法：21345，万位为1的有10000个；剩下4位，其中某一位为1的时候，另外3位都可以在0-9之间变化，就是$10^3$种组合，而万位可以在1,2之间变化，总组合数就是$2\times10^3\times4$，到这里，五位数的情况就分析完了，下面分析4位数的情况。四位数只有1345，分析千位是1的情况，有345个，剩余方法类似。</p>
<p>这种方法可理解性并不好，在牛客上面看到一种更容易被理解的方法。</p>
<p>给定一个数字，比如还是21345，个位出现1的次数是(2134+1)*1次，十位出现1的次数是(213+1)*10次，百位出现1的次数是(21+1)*100次，千位出现1的次数是2*1000+346次，万位出现的次数是10000次。</p>
<p>出现次数的规律是这样的：</p>
<ul>
<li>比如我们要找个位出现1的次数，先把数据分成2部分：2134和5，5之前的值可能是0-2134一共是2135次；</li>
<li>找十位的时候，分成两部分：213和45，0-213共214种组合，每种组合出现1的次数是10（十位为1，个位0-9之间变化），也就是214*10次；</li>
<li>百位的时候分成：21和345，一共是100*22种；</li>
<li>千位的时候分为2和1345,这个时候情况就和前面不一样的，因为这次末尾的最高位是1，当第一部分在0-1之间变化时，情况不变得到2*1000种，但是当第一位为2的时候，只有345+1&#x3D;346种，那次是一共是2346种；</li>
<li>万位的时候分为没有和21345，此时是1*10000种一共</li>
</ul>
<p>可以看出，只要当前要找的那一位大于等于2，那么就可以直接是前面的部分+1乘以当前的10的次方，如果当前那一位等于1，就要找当前位的后面几位+1加上前面的结果，如果当前位为0，那就只有前面部分。</p>
<p>下面代码中用(a+8)&#x2F;&#x2F;10的原因就是用于判断当前位是不是大于等于2</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">public <span class="keyword">class</span> <span class="title class_">S43r</span> &#123;</span><br><span class="line">    public static <span class="built_in">int</span> NumberOf1Between1AndN_Solution(<span class="built_in">int</span> n) &#123;</span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            n = -n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">int</span> a = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">int</span> b = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">int</span> i = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i &lt;= n) &#123;</span><br><span class="line">            a = n / i;</span><br><span class="line">            b = n % i;</span><br><span class="line">            <span class="built_in">int</span> temp = (a + <span class="number">8</span>) / <span class="number">10</span>;</span><br><span class="line">            count += temp * i;</span><br><span class="line">            <span class="keyword">if</span> (a % <span class="number">10</span> == <span class="number">1</span>) &#123;</span><br><span class="line">                count += b + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i *= <span class="number">10</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="面试题44：序列中某一位的数字"><a href="#面试题44：序列中某一位的数字" class="headerlink" title="面试题44：序列中某一位的数字"></a>面试题44：序列中某一位的数字</h5><blockquote>
<p>数字以1234567891011121314…这样的规则排列，在这个序列中，第5位是5，第13位是1，第19位是4，写出一个函数，可以求得第n位对应的数字</p>
</blockquote>
<p>这道题的思路就是，1-9之间有9个数字，10-99之间有90个数字，100-999之间有900个数字，分别占据9位，90*2&#x3D;180位，900*3&#x3D;2700位，如果我现在找1001位，那么肯定不在9位这部分里，跳过 ，剩下992位，也不再10-99之间，跳过，剩下992-180&#x3D;812位，812是小于2700的，所以肯定在这个范围内，这个范围的起始值是100，(812-1)&#x2F;&#x2F;3&#x3D;270，那么就是从100开始的第270个值，也就是370，(812-1)%3&#x3D;1，也就是中间那一位7</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">findNthDigit</span>(<span class="params">self, n: <span class="string">&#x27;int&#x27;</span></span>) -&gt; <span class="string">&#x27;int&#x27;</span>:</span><br><span class="line">        digits = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            number = <span class="number">9</span>*(<span class="number">10</span>**(digits-<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">if</span> n &lt;= number * digits:</span><br><span class="line">                <span class="keyword">return</span> self.findDigit(n, digits)</span><br><span class="line">            n -= number * digits</span><br><span class="line">            digits+=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">findDigit</span>(<span class="params">self, n, digits</span>):</span><br><span class="line">        intNum = (n-<span class="number">1</span>)//digits</span><br><span class="line">        rest = (n-<span class="number">1</span>)%digits</span><br><span class="line">        start = <span class="number">10</span>**(digits-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">int</span>(<span class="built_in">str</span>(start + intNum)[rest])</span><br></pre></td></tr></table></figure>

<h5 id="面试题45：组合出最小数字"><a href="#面试题45：组合出最小数字" class="headerlink" title="面试题45：组合出最小数字"></a>面试题45：组合出最小数字</h5><blockquote>
<p>输入一个正整数数组，把数组里所有数字拼接起来排成一个数，打印能拼接出的所有数字中最小的一个。例如输入数组{3，32，321}，则打印出这三个数字能排成的最小数字为321323。</p>
</blockquote>
<p>思路：这道题主要是进行一个自定义的比较函数，如果a+b比b+a字符串连接的结果小，那么两者交换。这个比较函数定义在compare中，比较算法就是普通的冒泡排序即可。</p>
<p>P.S.冒泡排序助记：i[0,n)-&gt;j[0,n-1-i)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">PrintMinNumber</span>(<span class="params">self, numbers</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,<span class="built_in">len</span>(numbers)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(numbers)-i-<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> self.compare(numbers[j],numbers[j+<span class="number">1</span>]):</span><br><span class="line">                    numbers[j],numbers[j+<span class="number">1</span>] = numbers[j+<span class="number">1</span>],numbers[j]</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;&#x27;</span>.join([<span class="built_in">str</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> numbers])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">compare</span>(<span class="params">self,a,b</span>):</span><br><span class="line">        con1 = <span class="built_in">int</span>(<span class="built_in">str</span>(a)+<span class="built_in">str</span>(b))</span><br><span class="line">        con2 = <span class="built_in">int</span>(<span class="built_in">str</span>(b)+<span class="built_in">str</span>(a))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span> <span class="keyword">if</span> con1 &gt; con2 <span class="keyword">else</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h5 id="面试题46：把数字翻译为字符串"><a href="#面试题46：把数字翻译为字符串" class="headerlink" title="面试题46：把数字翻译为字符串"></a>面试题46：把数字翻译为字符串</h5><blockquote>
<p>给定一个数字，按照如下规则翻译成字符串，0翻译成”a”，1翻译成”b“，11翻译成”l“,…,25翻译成”z“，一个数字可能有多种翻译，例如12258有五种翻译，请实现一个函数，能够计算一个数字有多少种翻译。</p>
</blockquote>
<p>这道题的关键在于写出递推关系式：$f(i) &#x3D; f(i+1) + g(i,i+1)\times(i+2)$，f(i)表示从第i个数字开始，有多少种不同的翻译方式。</p>
<p>这显然是一个递推的公式，如果用递推的写法来解决这个问题，效率比较低，因为有很多重复的情况，比如f(0)&#x3D;f(1)+g(0,1)*f(2)，f(1)&#x3D;f(2)+g(1,2)*f(3)，f(2)&#x3D;f(3)+g(1,2)*f(4)，这里就已经重复了f(2),f(3)的计算过程。</p>
<p>递归是通过最终问题自上而下（从未知开始，在已知的时候退出）的解决，那如果通过循环自下而上（从已知开始，最终找到未知）的解决问题，就效率比较高了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 方法1：递归</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countNum</span>(<span class="params">num,index</span>):</span><br><span class="line">    <span class="keyword">if</span> index == <span class="built_in">len</span>(num) -<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> index == <span class="built_in">len</span>(num) -<span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="number">10</span> &lt;= <span class="built_in">int</span>(num[index:index + <span class="number">2</span>]) &lt;= <span class="number">25</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    g = <span class="number">1</span> <span class="keyword">if</span> <span class="number">10</span>&lt;= <span class="built_in">int</span>(num[index:index+<span class="number">2</span>]) &lt;= <span class="number">25</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> countNum(num,index+<span class="number">1</span>) + g * countNum(num, index+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">num2Str</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> countNum(<span class="built_in">str</span>(num),<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 方法2：循环</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">countNum</span>(<span class="params">num</span>):</span><br><span class="line">    num = <span class="built_in">str</span>(num)</span><br><span class="line">    f = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(num))]</span><br><span class="line">    f[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">    f[<span class="number">1</span>] = <span class="number">2</span> <span class="keyword">if</span> <span class="number">10</span> &lt;= <span class="built_in">int</span>(num[:<span class="number">2</span>]) &lt;= <span class="number">25</span> <span class="keyword">else</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>, <span class="built_in">len</span>(num)):</span><br><span class="line">        g = <span class="number">1</span> <span class="keyword">if</span> <span class="number">10</span> &lt;= <span class="built_in">int</span>(num[i - <span class="number">1</span>:i + <span class="number">1</span>]) &lt;= <span class="number">25</span> <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        f[i] = f[i - <span class="number">1</span>] + g * f[i - <span class="number">2</span>]</span><br><span class="line">    <span class="keyword">return</span> f</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">num2Str</span>(<span class="params">num</span>):</span><br><span class="line">    <span class="keyword">if</span> num &lt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> countNum(<span class="built_in">str</span>(num))</span><br></pre></td></tr></table></figure>

<h5 id="面试题47：礼物的最大价值"><a href="#面试题47：礼物的最大价值" class="headerlink" title="面试题47：礼物的最大价值"></a>面试题47：礼物的最大价值</h5><blockquote>
<p>在一个m×n的棋盘的每一格都放有一个礼物，每个礼物都有一定的价值（价值大于0）。你可以从棋盘的左上角开始拿格子里的礼物，并每次向右或者向下移动一格，直到到达棋盘的右下角。给定一个棋盘及其上面的礼物，请计算你最多能够拿到多少价值的礼物。</p>
</blockquote>
<p>这道题也是动态规划，要写出递推公式就比较好做</p>
<p>用f(i,j)表示到(i,j)这个坐标时，能去得到最大礼物值，那么$f(i,j) &#x3D; {\rm gift}[i][j]+\max(f(i-1,j),f(i,j-1))$，可以用递归的方法实现，但是效率低，最终依然用循环来实现</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Bonus</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getMost</span>(<span class="params">self, board</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        maxv = [[<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(board[<span class="number">0</span>]))] <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(board))]</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(board)):</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(board)):</span><br><span class="line">                left = <span class="number">0</span></span><br><span class="line">                up = <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> i&gt;<span class="number">0</span>:</span><br><span class="line">                    up = maxv[i-<span class="number">1</span>][j]</span><br><span class="line">                <span class="keyword">if</span> j&gt;<span class="number">0</span>:</span><br><span class="line">                    left = maxv[i][j-<span class="number">1</span>]</span><br><span class="line">                maxv[i][j] = board[i][j] + <span class="built_in">max</span>(up,left)</span><br><span class="line">        <span class="keyword">return</span> maxv[-<span class="number">1</span>][-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<p>优化空间复杂度为O(n)：只有一维数组来存储最大值，数组每一个值<code>maxVal[j]</code>表示的是第i行，到第j列为止的最大礼物值，因此<code>maxVal[j-1]</code>表示左侧的最大值，而<code>maxVal[j]</code>在更新之前表示的就是上一行的最大值it</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">maxValueOptimize</span><span class="params">(<span class="type">int</span>[][] gifts)</span> &#123;</span><br><span class="line">    <span class="comment">//判空</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> gifts.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">cols</span> <span class="operator">=</span> gifts[<span class="number">0</span>].length;</span><br><span class="line">    <span class="type">int</span>[] maxVal = <span class="keyword">new</span> <span class="title class_">int</span>[cols];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">left</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">up</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (i &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                up = maxVal[j];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (j &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                left = maxVal[j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            maxVal[j] = Math.max(up, left) + gifts[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> maxVal[cols - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题48：最大无重复子串"><a href="#面试题48：最大无重复子串" class="headerlink" title="面试题48：最大无重复子串"></a>面试题48：最大无重复子串</h5><blockquote>
<p>请从给定字符串中找到一个最长的不包含重复字符串的子字符串，计算该字符串的长度</p>
</blockquote>
<p>书中给的方法是动态规划，用f(i)表示到第i个字符结尾的最长子串，f(i)&#x3D;f(i-1)+1，如果第i个内容在之前没有出现过的话。如果出现过，记本次出现和上次出现的位置差为d，分为2种情况：</p>
<ol>
<li><p>d&lt;&#x3D;f(i-1)，也就是到上一个字符的最大子串长度比两个重复内容之间的长度要大，那么就要重新安排最大子串，比如qweraba，在计算最后一个a的时候，之前的最大长度已经是6了，而最后一个a与上一个a之间的距离是2，那么上一个a出现在f(i-1)的最长子串中，此时对应的最长无重复子串是’ba’，长度为2</p>
</li>
<li><p>d&gt;f(i-1)，也就是当前字符上次出现的位置在之前的最大子串之前，因此此时f(i)&#x3D;f(i-1)+1，比如afabcacf，在分析最后一个元素f的时候，f(i-1)&#x3D;2，上一步的最大无重复子串是ac，那么最终的最大无重复子串只需要加1，结果为3</p>
</li>
</ol>
<p>具体代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getMaxStr</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    position = [-<span class="number">1</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">26</span>)]</span><br><span class="line">    curlength = <span class="number">0</span></span><br><span class="line">    maxlength = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        preIndex = position[s[i]-<span class="string">&#x27;a&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> preIndex&lt;<span class="number">0</span> <span class="keyword">or</span> i-preIndex &gt; curlength:</span><br><span class="line">            curlength+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> curlength &gt; maxlength:</span><br><span class="line">                maxlength = curlength</span><br><span class="line">            curlength = i - preIndex</span><br><span class="line">        position[s[i]-<span class="string">&#x27;a&#x27;</span>] = i</span><br><span class="line">        <span class="keyword">if</span> curlength&gt;maxlength:</span><br><span class="line">            maxlength = curlength</span><br><span class="line">    <span class="keyword">return</span> maxlength</span><br></pre></td></tr></table></figure>

<p>如果要返回这个最大子串，可以用一个list来存储当前的最大子串，最后返回</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getMaxStr</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    f = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s))]</span><br><span class="line">    temp = []</span><br><span class="line">    maxv = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">            f[i]=<span class="number">1</span></span><br><span class="line">            temp.append(s[<span class="number">0</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> s[i] <span class="keyword">not</span> <span class="keyword">in</span> temp:</span><br><span class="line">                f[i]=f[i-<span class="number">1</span>]+<span class="number">1</span></span><br><span class="line">                temp.append(s[i])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">while</span> s[i] <span class="keyword">in</span> temp:</span><br><span class="line">                    temp.pop(<span class="number">0</span>)</span><br><span class="line">                f[i] = <span class="built_in">len</span>(temp)+<span class="number">1</span></span><br><span class="line">                temp.append(s[i])</span><br><span class="line">        <span class="keyword">if</span> f[i] &gt; maxv:</span><br><span class="line">            maxv = f[i]</span><br><span class="line">            maxs = <span class="string">&#x27;&#x27;</span>.join(temp)</span><br><span class="line">    <span class="keyword">return</span> maxv,maxs</span><br></pre></td></tr></table></figure>

<h5 id="面试题49：丑数"><a href="#面试题49：丑数" class="headerlink" title="面试题49：丑数"></a>面试题49：丑数</h5><blockquote>
<p>把只包含质因子2、3和5的数称作丑数（Ugly Number）。例如6、8都是丑数，但14不是，因为它包含质因子7。 习惯上我们把1当做是第一个丑数。求按从小到大的顺序的第N个丑数。</p>
</blockquote>
<p>思路：直观上，我们可以一个数一个数地判断，看看当前值是不是丑数。判断丑数的办法，因为丑数的因子只有2,3,5，那么他一直除以2,3,5最后一定为1，怎么判断有多少个2，多少个3，多少个5呢？方法是判断能被2整除的时候，就一直除以2；能被3整除的时候，就除以3；能被5整除的时候，就除以5。判断方法就是求余。</p>
<p>这种暴力方法虽然直观，但是时间复杂度太大了，无法通过系统测试。</p>
<p>还有一种方法就是以空间换时间，建立一个只存放丑数的数组ugly，既然我有第一个ugly的值，那么只要把这个值乘以2或3或5就可以得到下一个值，下一个值要保证最小，就是乘2,3,5之后最小的值。用3个index来表示乘以2,3,5的值的位置，要求乘以之后的新值一定要大于当前的最大值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetUglyNumber_Solution</span>(<span class="params">self, index</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> index&lt;<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        ugly = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(index)]</span><br><span class="line">        p2,p3,p5 = <span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">        ugly[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        nextOne = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> nextOne &lt; index:</span><br><span class="line">            ugly[nextOne] = <span class="built_in">min</span>([ugly[p2]*<span class="number">2</span>,ugly[p3]*<span class="number">3</span>,ugly[p5]*<span class="number">5</span>])</span><br><span class="line">            <span class="keyword">while</span> ugly[p2]*<span class="number">2</span>&lt;=ugly[nextOne]:</span><br><span class="line">                p2+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> ugly[p3]*<span class="number">3</span>&lt;=ugly[nextOne]:</span><br><span class="line">                p3+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> ugly[p5]*<span class="number">5</span>&lt;=ugly[nextOne]:</span><br><span class="line">                p5+=<span class="number">1</span></span><br><span class="line">            nextOne+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> ugly[-<span class="number">1</span>]</span><br></pre></td></tr></table></figure>

<h5 id="面试题50：第一个只出现一次的字符"><a href="#面试题50：第一个只出现一次的字符" class="headerlink" title="面试题50：第一个只出现一次的字符"></a>面试题50：第一个只出现一次的字符</h5><blockquote>
<p>在一个字符串(全部由字母组成)中找到第一个只出现一次的字符,并返回它的位置, 如果没有则返回 -1（需要区分大小写）.</p>
</blockquote>
<p>用hash表的方法来实现。有了hash表，每次查询的时间复杂度为O(1)，可以直接找到结果。因为char字符的大小是8位，一个char最多有256种可能，因此建立一个长度为256的数组，以char的ascii码为hash值，出现一个+1，再遍历一遍string，如果某一个char的出现次数为1，直接返回。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FirstNotRepeatingChar</span>(<span class="params">self, s</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        d = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>)]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">            d[<span class="built_in">ord</span>(s[i])]+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">            <span class="keyword">if</span> d[<span class="built_in">ord</span>(s[i])]==<span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> i</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="面试题51：数组中的逆序对"><a href="#面试题51：数组中的逆序对" class="headerlink" title="面试题51：数组中的逆序对"></a>面试题51：数组中的逆序对</h5><blockquote>
<p>在数组中的两个数字，如果前面一个数字大于后面的数字，则这两个数字组成一个逆序对。输入一个数组,求出这个数组中的逆序对的总数P。</p>
</blockquote>
<p>直观思路是暴力法，时间复杂度为$\rm O(n^2)​$</p>
<p>这道题的思路是归并排序，归并排序的时间复杂度为O(nlogn)</p>
<p>我们以数组｛7, 5, 6, 4｝为例来分析统计逆序对的过程。每次扫描到一个数字的时候，我们不能拿它和后面的每一个数字作比较，否则时间复杂度就是O(n^5)，因此我们可以考虑先比较两个相邻的数字。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190221105000.png"></p>
<p>如图5 . 1 ( a )和图5.1 ( b）所示，我们先把数组分解成两个长度为2的子数组， 再把这两个子数组分别拆分成两个长度为1 的子数组。接下来一边合并相邻的子数组， 一边统计逆序对的数目。在第一对长度为1 的子数组｛7｝、｛5｝中7 大于5 ， 因此（7, 5）组成一个逆序对。同样在第二对长度为1 的子数组｛6｝、｛4｝中也有逆序对（6, 4）。由于我们已经统计了这两对子数组内部的逆序对，因此需要把这两对子数组排序（ 图5.1 ( c）所示），以免在以后的统计过程中再重复统计。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190221104942.png"></p>
<p>注　图中省略了最后一步， 即复制第二个子数组最后剩余的4 到辅助数组中.<br>(a) P1指向的数字大于P2指向的数字，表明数组中存在逆序对．P2 指向的数字是第二个子数组的第二个数字， 因此第二个子数组中有两个数字比7 小． 把逆序对数目加2，并把7 复制到辅助数组，向前移动P1和P3.<br>(b) P1指向的数字小子P2 指向的数字，没有逆序对．把P2 指向的数字复制到辅助数组，并向前移动P2 和P3 .<br>(c) P1指向的数字大于P2 指向的数字，因此存在逆序对． 由于P2 指向的数字是第二个子数组的第一个数字，子数组中只有一个数字比5 小． 把逆序对数目加1 ，并把5复制到辅助数组，向前移动P1和P3 .</p>
<p>接下来我们统计两个长度为2 的子数组之间的逆序对。我们在图5.2 中细分图5.1 ( d）的合并子数组及统计逆序对的过程。<br>我们先用两个指针分别指向两个子数组的末尾，并每次比较两个指针指向的数字。如果第一个子数组中的数字大于第二个子数组中的数字，则构成逆序对，并且逆序对的数目等于第二个子数组中剩余数字的个数（如图5.2 (a)和图5.2 (c)所示）。如果第一个数组中的数字小于或等于第二个数组中的数字，则不构成逆序对（如图5.2 (b)所示〉。每一次比较的时候，我们都把较大的数字从后往前复制到一个辅助数组中去，确保辅助数组中的数字是递增排序的。在把较大的数字复制到辅助数组之后，把对应的指针向前移动一位，接下来进行下一轮比较。<br>　经过前面详细的诗论， 我们可以总结出统计逆序对的过程：先把数组分隔成子数组， 先统计出子数组内部的逆序对的数目，然后再统计出两个相邻子数组之间的逆序对的数目。在统计逆序对的过程中，还需要对数组进行排序。如果对排序很熟悉，我们不难发现这个排序的过程实际上就是归并排序。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">InversePairs</span>(<span class="params">self, data</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        copy = [i <span class="keyword">for</span> i <span class="keyword">in</span> data]</span><br><span class="line">        count = self.InversePairsCore(data, copy, <span class="number">0</span>, <span class="built_in">len</span>(data) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> count%<span class="number">1000000007</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">InversePairsCore</span>(<span class="params">self, data, copy, start, end</span>):</span><br><span class="line">        <span class="keyword">if</span> start == end:</span><br><span class="line">            <span class="comment"># copy[start] = data[start]</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        mid = (end + start) // <span class="number">2</span></span><br><span class="line">        left = self.InversePairsCore(data, copy, start, mid)%<span class="number">1000000007</span></span><br><span class="line">        right = self.InversePairsCore(data, copy, mid + <span class="number">1</span>, end)%<span class="number">1000000007</span></span><br><span class="line">        i = mid</span><br><span class="line">        j = end</span><br><span class="line">        indexCopy = end</span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> i &gt;= start <span class="keyword">and</span> j &gt; mid:</span><br><span class="line">            <span class="keyword">if</span> data[i] &gt; data[j]:</span><br><span class="line">                copy[indexCopy] = data[i]</span><br><span class="line">                i -= <span class="number">1</span></span><br><span class="line">                indexCopy -= <span class="number">1</span></span><br><span class="line">                count += j - mid</span><br><span class="line">                <span class="keyword">if</span> count&gt;<span class="number">1000000007</span>:</span><br><span class="line">                    count=count%<span class="number">1000000007</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                copy[indexCopy] = data[j]</span><br><span class="line">                j -= <span class="number">1</span></span><br><span class="line">                indexCopy -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> i &gt;= start:</span><br><span class="line">            copy[indexCopy] = data[i]</span><br><span class="line">            i -= <span class="number">1</span></span><br><span class="line">            indexCopy -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> j &gt;mid:</span><br><span class="line">            copy[indexCopy] = data[j]</span><br><span class="line">            j -= <span class="number">1</span></span><br><span class="line">            indexCopy -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> s <span class="keyword">in</span> <span class="built_in">range</span>(start, end+<span class="number">1</span>):</span><br><span class="line">            data[s] = copy[s]</span><br><span class="line">        <span class="keyword">return</span> (count + left + right)%<span class="number">1000000007</span></span><br></pre></td></tr></table></figure>

<h5 id="面试题52：两个链表的第一个公共节点"><a href="#面试题52：两个链表的第一个公共节点" class="headerlink" title="面试题52：两个链表的第一个公共节点"></a>面试题52：两个链表的第一个公共节点</h5><blockquote>
<p>输入两个链表，找出它们的第一个公共结点。</p>
</blockquote>
<p>直观思路依然是暴力法，但是暴力法通常不会是好办法。两个链表的长度分别为m和n，那么暴力法的时间复杂度为O(mn)</p>
<p>书中给出了两种思路：</p>
<p>方法1：利用2个辅助栈</p>
<p>如果两个链表有公共节点，那么最后一个节点是公共的（这道题的意思是只要两个链表有公共节点之后的所有节点都是相同的）。如果我们从后往前比较，那么一下就能找到结果。但是链表只能顺序访问，需要反向访问的时候，我们就借助栈来实现。</p>
<p>方法2：利用链表长度差</p>
<p>两个链表如果有公共节点，那么最后一个节点一定是一样的，那么我只要保证两个链表从同样的位置向后遍历即可找到公共节点。如下图，如果两个链表有公共节点，那么我们从2和4开始遍历，很容易找到6是公共节点并返回</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/1550713900346.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class ListNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.next = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindFirstCommonNode</span>(<span class="params">self, pHead1, pHead2</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        l1 = self.getLength(pHead1)</span><br><span class="line">        l2 = self.getLength(pHead2)</span><br><span class="line">        <span class="keyword">if</span> l1 &gt; l2:</span><br><span class="line">            pHeadLong = pHead1</span><br><span class="line">            pHeadShort = pHead2</span><br><span class="line">            gap = l1-l2</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pHeadLong = pHead2</span><br><span class="line">            pHeadShort = pHead1</span><br><span class="line">            gap = l2-l1</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(gap):</span><br><span class="line">            pHeadLong = pHeadLong.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">while</span> pHeadLong <span class="keyword">and</span> pHeadShort <span class="keyword">and</span> pHeadLong!=pHeadShort:</span><br><span class="line">            pHeadLong=pHeadLong.<span class="built_in">next</span></span><br><span class="line">            pHeadShort= pHeadShort.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">return</span> pHeadLong</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getLength</span>(<span class="params">self, pHead</span>):</span><br><span class="line">        length = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> pHead:</span><br><span class="line">            length += <span class="number">1</span></span><br><span class="line">            pHead = pHead.<span class="built_in">next</span></span><br><span class="line">        <span class="keyword">return</span> length</span><br></pre></td></tr></table></figure>

<h5 id="面试题53：在排序数组中查找数字"><a href="#面试题53：在排序数组中查找数字" class="headerlink" title="面试题53：在排序数组中查找数字"></a>面试题53：在排序数组中查找数字</h5><blockquote>
<p>统计一个数字在排序数组中出现的次数。例如在排序数组[1,2,3,3,3,3,4,5]中查找3的出现次数，应该返回结果为4</p>
</blockquote>
<p>因为是排序数组，自然想到二分查找。既然要找出现的次数，那么就要找到第一个出现的位置，和最后一个出现的位置。两者相减+1即得到出现的次数。</p>
<p>因此我们需要两个函数，getFirstK找到第一个出现的位置和getLastK找到最后一个出现的位置。</p>
<p>分别用二分查找进行实现这两个函数。</p>
<p>getFirstK的逻辑：</p>
<ul>
<li>如果找到的中间值大于k，那么在左半部分查找</li>
<li>如果找到的中间值小于k，那么在右半部分查找</li>
<li>如果找到的中间值等于k：<ul>
<li>如果当前值已经是第一个k出现的位置：也就是当前值的前一个值不为k或者此时的中间值已经是数组的第一个值，那么返回当前位置</li>
<li>其余情况在左半部分查找</li>
</ul>
</li>
</ul>
<p>getLastK的逻辑几乎相同。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetNumberOfK</span>(<span class="params">self, data, k</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        first = self.getFirstK(data, k, <span class="number">0</span>, <span class="built_in">len</span>(data) - <span class="number">1</span>)</span><br><span class="line">        last = self.getLastK(data, k, <span class="number">0</span>, <span class="built_in">len</span>(data) - <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> last != -<span class="number">1</span> <span class="keyword">and</span> first != -<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> last - first + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getFirstK</span>(<span class="params">self, data, k, start, end</span>):</span><br><span class="line">        <span class="keyword">while</span> start&lt;=end:</span><br><span class="line">            mid = (start + end) // <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> data[mid] == k:</span><br><span class="line">                <span class="keyword">if</span> (mid - <span class="number">1</span> &gt; <span class="number">0</span> <span class="keyword">and</span> data[mid - <span class="number">1</span>] != k) <span class="keyword">or</span> mid == <span class="number">0</span>:</span><br><span class="line">                    <span class="keyword">return</span> mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    end = mid - <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> data[mid] &gt; k:</span><br><span class="line">                end = mid - <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                start = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getLastK</span>(<span class="params">self, data, k, start, end</span>):</span><br><span class="line">        <span class="keyword">while</span> start&lt;=end:</span><br><span class="line">            mid = (start + end) // <span class="number">2</span></span><br><span class="line">            <span class="keyword">if</span> data[mid] == k:</span><br><span class="line">                <span class="keyword">if</span> (mid + <span class="number">1</span> &lt; <span class="built_in">len</span>(data) <span class="keyword">and</span> data[mid + <span class="number">1</span>] != k) <span class="keyword">or</span> mid == <span class="built_in">len</span>(data) - <span class="number">1</span>:</span><br><span class="line">                    <span class="keyword">return</span> mid</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    start = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">elif</span> data[mid] &gt; k:</span><br><span class="line">                end = mid - <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                start = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目2： 0~n-1中缺失的数字。</p>
<p>长度为n-1的递增排序数组中的所有数字都是唯一的，且每个数字都在0<del>n-1之内，在范围0</del>n-1内的n个数字中有且仅有一个不在数组中，请找出该数字。</p>
</blockquote>
<p>同样使用二分排序。</p>
<p>需要找的值一定是当前值不等于当前序号，但是上一个值等于上一个序号的情况。我们每次二分查找：</p>
<ul>
<li>如果当前值等于当前序号，那么缺失值一定在右半部分；</li>
<li>如果当前值不等于当前序号：<ul>
<li>如果上一个值等于上一个序号，返回当前值</li>
<li>如果上一个值不等于上一个序号，那么缺失值一定在左半部分</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getMissingNum</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    left = <span class="number">0</span></span><br><span class="line">    right = <span class="built_in">len</span>(data)-<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">        mid = (left+right)//<span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> data[mid] != mid:</span><br><span class="line">            <span class="keyword">if</span> data[mid-<span class="number">1</span>] == mid-<span class="number">1</span> <span class="keyword">or</span> mid==<span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> mid</span><br><span class="line">            right = mid-<span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            left =mid+<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> left==<span class="built_in">len</span>(data):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(data)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目3：数组中数值和下标相等的元素</p>
<p>假设一个单调递增的数组中所有元素唯一。请实现一个函数找出任意一个数值等于其下标的元素。如在[-3,-1,1,3,5]中，数字3与其下标相等。</p>
</blockquote>
<p>同样，这道题还是使用二分查找。抓住数组是排序的这一特点，我们找到中间值：</p>
<ul>
<li>如果中间值已经比序号小了，那么中间值左边的值肯定都比序号小，那就只用找中间值右边的值就行了</li>
<li>如果中间值比序号大，那么中间值右边的值一定都比序号大，那就只用找中间值左边的值就行了</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getSameIndexNum</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">    left = <span class="number">0</span></span><br><span class="line">    right = <span class="built_in">len</span>(data) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> left &lt;= right:</span><br><span class="line">        mid = (left + right) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">if</span> data[mid] == mid:</span><br><span class="line">            <span class="keyword">return</span> data[mid]</span><br><span class="line">        <span class="keyword">elif</span> data[mid] &lt; mid:</span><br><span class="line">            left = mid + <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            right = mid - <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br></pre></td></tr></table></figure>

<h5 id="面试题54：二叉搜索树的第k大节点"><a href="#面试题54：二叉搜索树的第k大节点" class="headerlink" title="面试题54：二叉搜索树的第k大节点"></a>面试题54：二叉搜索树的第k大节点</h5><blockquote>
<p>给定一棵二叉搜索树，请找出其中的第k小的结点。例如， （5，3，7，2，4，6，8）    中，按结点数值大小顺序第三小结点的值为4。</p>
</blockquote>
<p>因为是二叉搜索树，因此中序遍历的结果就是从小到大排列的。只需要中序遍历直接拿结果就好了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="comment"># 返回对应节点TreeNode</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">KthNode</span>(<span class="params">self, pRoot, k</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot <span class="keyword">or</span> k&lt;=<span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        data = []</span><br><span class="line">        self.mid(pRoot,data)</span><br><span class="line">        <span class="keyword">if</span> k&gt;<span class="built_in">len</span>(data):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        <span class="keyword">return</span> data[k-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">mid</span>(<span class="params">self, pRoot, data</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        self.mid(pRoot.left,data)</span><br><span class="line">        data.append(pRoot)</span><br><span class="line">        self.mid(pRoot.right,data)</span><br></pre></td></tr></table></figure>

<h5 id="面试题55：二叉树的深度"><a href="#面试题55：二叉树的深度" class="headerlink" title="面试题55：二叉树的深度"></a>面试题55：二叉树的深度</h5><blockquote>
<p>给定一棵二叉树，写出求二叉树深度的函数。</p>
</blockquote>
<p>二叉树深度只需要递归就可以求得。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">TreeDepth</span>(<span class="params">self, pRoot</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">1</span> + self.TreeDepth(pRoot.left),<span class="number">1</span> + self.TreeDepth(pRoot.right))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目2：平衡二叉树</p>
<p>输入一棵二叉树的根节点，判断该树是不是平衡二叉树。如果二叉树左右子树的深度相差不超过1，那么他就是平衡二叉树。</p>
</blockquote>
<p>直观方法就是判断左右子树的深度，如果他们的深度差不超过1，那么继续判断他们子树是不是平衡二叉树，直到判断到最后一个节点。</p>
<p>这种方法存在大量的重复计算，如图，我们先判断以1为根节点的树是不是平衡的时候，我们要计算4,5,7这几个点，当判断以2为根节点的树是不是平衡的时候，我们依然要计算4,5,7这几个点，这就存在大量重复。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190221150512.png"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="comment"># class TreeNode:</span></span><br><span class="line"><span class="comment">#     def __init__(self, x):</span></span><br><span class="line"><span class="comment">#         self.val = x</span></span><br><span class="line"><span class="comment">#         self.left = None</span></span><br><span class="line"><span class="comment">#         self.right = None</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">IsBalanced_Solution</span>(<span class="params">self, pRoot</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        left = self.depth(pRoot.left)</span><br><span class="line">        right = self.depth(pRoot.right)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(left-right)&gt;<span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.IsBalanced_Solution(pRoot.left) <span class="keyword">and</span> self.IsBalanced_Solution(pRoot.right)</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">depth</span>(<span class="params">self,root</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> root:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">max</span>(self.depth(root.left),self.depth(root.right))+<span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>如果我们从下往上遍历，如果某个子树是平衡二叉树，就返回其深度，否则停止遍历，这样就减少了不必要的开销。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.balanced = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">IsBalanced_Solution</span>(<span class="params">self, pRoot</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        self.IsBalancedCore(pRoot)</span><br><span class="line">        <span class="keyword">return</span> self.balanced</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">IsBalancedCore</span>(<span class="params">self, pRoot</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> pRoot:</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">        left = self.IsBalancedCore(pRoot.left)</span><br><span class="line">        right = self.IsBalancedCore(pRoot.right)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">abs</span>(left-right)&gt;<span class="number">1</span>:</span><br><span class="line">            self.balanced=<span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>+<span class="built_in">max</span>(left,right)</span><br></pre></td></tr></table></figure>

<h5 id="面试题56：数组中数字出现的次数"><a href="#面试题56：数组中数字出现的次数" class="headerlink" title="面试题56：数组中数字出现的次数"></a>面试题56：数组中数字出现的次数</h5><blockquote>
<p>题目一：数组中只出现一次的两个数字</p>
<p>一个数组里除了两个数字以外，其余数字都出现了2次。请找出这两个只出现了一次的数字，要求时间复杂度为O(n)，空间复杂度为O(1)</p>
</blockquote>
<p>这道题的难点在于限制了时间和空间复杂度。我们不妨先考虑他的简单版本，如果一个数组中有一个数只出现了1次，而其余数出现了2次，找到这一个数字可以用什么方法呢？</p>
<p>找寻的技巧就是异或，如果所有元素异或起来，出现两次的元素一定被消除了，最后就剩下一个只出现了一次的元素。</p>
<p>那么两个元素的时候怎么办呢？就要把这个数组分为两部分：每一部分只包含一个出现了1次的元素，且出现两次的元素一定在同一个子数组中。那么怎么划分呢？</p>
<p>我们把所有元素异或起来，因为另外两个元素不相同，那么以后之后的结果至少有一位不为0，我们找到这个不为0的位。再遍历原数组，按照这一位为0和不为0分成两个数组，由于出现两次的元素某一位肯定是要么同时为0，要么同时为1，也就是划分到同一个子数组中了，就符合要求了。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">findOneIndex</span>(<span class="params">resultXOR</span>):</span><br><span class="line">    index=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> resultXOR &amp; <span class="number">1</span> != <span class="number">1</span>:</span><br><span class="line">        resultXOR = resultXOR &gt;&gt; <span class="number">1</span></span><br><span class="line">        index+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> index</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">isBit1</span>(<span class="params">i, oneIndex</span>):</span><br><span class="line">    i = i&gt;&gt;oneIndex</span><br><span class="line">    <span class="keyword">return</span> i&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">findTwoNumAppearOnce</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data <span class="keyword">or</span> <span class="built_in">len</span>(data) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    resultXOR = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        resultXOR ^= i</span><br><span class="line">    <span class="comment"># 找到第一个不为0的位</span></span><br><span class="line">    oneIndex = findOneIndex(resultXOR)</span><br><span class="line">    num1=num2=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        <span class="comment"># 按照找到那位是否为0划分成2个子数组并分别异或</span></span><br><span class="line">        <span class="keyword">if</span> isBit1(i,oneIndex):</span><br><span class="line">            num1^=i</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            num2^=i</span><br><span class="line">    <span class="keyword">return</span> num1,num2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目2：数组中唯一出现的数字</p>
<p>一个数组中，除一个数字只出现一次之外，其余数字都出现了3次，找出这个只出现了一次的数字。</p>
</blockquote>
<p>虽然这道题不能用异或运算（因为抑或运算3个相同的值得到的肯定是本身），但是可以参考上面的思路。</p>
<p>我们按位求和，出现三次数字的那一位一定是3的倍数，那么让每一位对3求余，余数一定是多出来那个数所带来的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">findNumAppearOnce</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> data:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    bitSum = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        bitMask = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(bitSum) - <span class="number">1</span>,-<span class="number">1</span>,-<span class="number">1</span>):</span><br><span class="line">            bit = bitMask &amp; i</span><br><span class="line">            <span class="keyword">if</span> bit!=<span class="number">0</span>:</span><br><span class="line">                bitSum[j] += <span class="number">1</span></span><br><span class="line">            bitMask = bitMask &lt;&lt; <span class="number">1</span></span><br><span class="line">    result=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> bitSum:</span><br><span class="line">        result = result&lt;&lt;<span class="number">1</span></span><br><span class="line">        result+=i%<span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<h5 id="面试题57：和为s的数字"><a href="#面试题57：和为s的数字" class="headerlink" title="面试题57：和为s的数字"></a>面试题57：和为s的数字</h5><blockquote>
<p>题目1,：和为s的两个数字</p>
<p>输入一个递增排序的数组和一个数字s，在数组中查找这两个数，使得他们的和刚好是s，如果有多对数字的和为s，输出其中一对即可。</p>
</blockquote>
<p>如果使用暴力法，时间复杂度为$O(n^2)$</p>
<p>正确的方法是使用两个指针，一个指向数组最前面，一个指向最后面，因为数组是排好序的</p>
<ul>
<li>如果a+b&lt;target，那么表示a太小了，a指针向后移动</li>
<li>如果a+b&gt;target，证明值太大了，b指针向前移动</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindNumbersWithSum</span>(<span class="params">self, array, tsum</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        left = <span class="number">0</span></span><br><span class="line">        right = <span class="built_in">len</span>(array)- <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> left &lt; right:</span><br><span class="line">            <span class="keyword">if</span> array[left] + array[right]==tsum:</span><br><span class="line">                <span class="keyword">return</span> array[left],array[right]</span><br><span class="line">            <span class="keyword">while</span> left&lt;right <span class="keyword">and</span> array[left] + array[right]&lt;tsum:</span><br><span class="line">                left+=<span class="number">1</span></span><br><span class="line">            <span class="keyword">while</span> left&lt;right <span class="keyword">and</span> array[left] + array[right]&gt;tsum:</span><br><span class="line">                right-=<span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> []</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目2：和为s的连续正数序列</p>
<p>输入一个正数s，打印出所有和为s的连续正数序列（至少包含两个数），例如输入15，由于15&#x3D;1+2+3+4+5&#x3D;4+5+6&#x3D;7+8，所以打印出三个序列[1-5,4-6,7-8]</p>
</blockquote>
<p>两个指针，一个指向1，一个指向2</p>
<ul>
<li>如果和小于目标，右侧指针+1</li>
<li>如果和大于目标，左侧指针+1</li>
</ul>
<p>终止条件是左侧指针&gt;(1+target)&#x2F;2，因为当左侧指针等于(target-1)&#x2F;2的时候，题目至少包含两个数的要求，下一个数是(target+1)&#x2F;2，两者之和是target。</p>
<p>求和有个小技巧，就是利用一个curSum变量来存储和，如果大了就减掉左边的值，如果小了，就加上右边的值。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">FindContinuousSequence</span>(<span class="params">self, tsum</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        l = <span class="number">1</span></span><br><span class="line">        r = <span class="number">2</span></span><br><span class="line">        sumv = <span class="number">3</span></span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">while</span> l &lt; (<span class="number">1</span> + tsum) // <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">if</span> sumv == tsum:</span><br><span class="line">                result.append(<span class="built_in">list</span>(<span class="built_in">range</span>(l, r + <span class="number">1</span>)))</span><br><span class="line">                sumv -= l</span><br><span class="line">                l += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> sumv &lt; tsum:</span><br><span class="line">                r += <span class="number">1</span></span><br><span class="line">                sumv += r</span><br><span class="line">            <span class="keyword">if</span> sumv &gt; tsum:</span><br><span class="line">                sumv -= l</span><br><span class="line">                l += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<h5 id="面试题58：旋转字符串"><a href="#面试题58：旋转字符串" class="headerlink" title="面试题58：旋转字符串"></a>面试题58：旋转字符串</h5><blockquote>
<p>题目1：翻转单词顺序</p>
<p>输入一个英文句子，翻转句子中单词的顺序，但单词内字符的顺序不变。比如输入“I am a student.”，翻转之后得到”student. a am I”</p>
</blockquote>
<p>这道题利用python的spilit方法很容易做出来<code>&quot; &quot;.join(s.split(&quot; &quot;)[::-1])</code>，但是这样并不是这道题考察的核心，要通过这道题的考察，我们需要看看剑指offer上面的方法。</p>
<p>书中给出的方法是翻转2次，第一次翻转所有内容，第二次只单独翻转单词。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def ReverseSentence(s):</span></span><br><span class="line"><span class="comment">#     # write code here</span></span><br><span class="line"><span class="comment">#     return &quot; &quot;.join(s.split(&quot; &quot;)[::-1])</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverseAll</span>(<span class="params">s</span>):</span><br><span class="line">    s = [i <span class="keyword">for</span> i <span class="keyword">in</span> s]</span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    r = <span class="built_in">len</span>(s) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> l &lt; r:</span><br><span class="line">        s[l], s[r] = s[r], s[l]</span><br><span class="line">        l += <span class="number">1</span></span><br><span class="line">        r -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverseOne</span>(<span class="params">s, l, r</span>):</span><br><span class="line">    s = [i <span class="keyword">for</span> i <span class="keyword">in</span> s]</span><br><span class="line">    <span class="keyword">while</span> l&lt;r:</span><br><span class="line">        s[l], s[r] = s[r], s[l]</span><br><span class="line">        l += <span class="number">1</span></span><br><span class="line">        r -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ReverseSentence</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="comment"># write code here</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    s = reverseAll(s)</span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    r = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> l &lt; <span class="built_in">len</span>(s)-<span class="number">1</span>:</span><br><span class="line">        <span class="keyword">if</span> s[l] == <span class="string">&quot; &quot;</span>:</span><br><span class="line">            l += <span class="number">1</span></span><br><span class="line">            r += <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> r==<span class="built_in">len</span>(s) <span class="keyword">or</span> s[r] == <span class="string">&quot; &quot;</span>:</span><br><span class="line">            r -= <span class="number">1</span></span><br><span class="line">            s = reverseOne(s, l, r)</span><br><span class="line">            r += <span class="number">1</span></span><br><span class="line">            l = r</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            r += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(ReverseSentence(<span class="string">&quot;I am a student.&quot;</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目2：左旋转字符串</p>
<p>左旋转操作就是把字符串前面的若干个自负转移到字符串尾部。请定义一个函数实现字符串的左旋转操作。比如，输入字符串”abcdefg”和数字2，输出”cdefgab”</p>
</blockquote>
<p>和上面问题的解法类似，将字符串分为两个部分，前n个和后面部分，先翻转前n个，再反转后面部分，再整体翻转，就得到了想要的结果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">reverseAll</span>(<span class="params">s</span>):</span><br><span class="line">    s = [i <span class="keyword">for</span> i <span class="keyword">in</span> s]</span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    r = <span class="built_in">len</span>(s) - <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> l &lt; r:</span><br><span class="line">        s[l], s[r] = s[r], s[l]</span><br><span class="line">        l += <span class="number">1</span></span><br><span class="line">        r -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(s)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverseOne</span>(<span class="params">s, l, r</span>):</span><br><span class="line">    s = [i <span class="keyword">for</span> i <span class="keyword">in</span> s]</span><br><span class="line">    <span class="keyword">while</span> l&lt;r:</span><br><span class="line">        s[l], s[r] = s[r], s[l]</span><br><span class="line">        l += <span class="number">1</span></span><br><span class="line">        r -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>.join(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">reverseLeft</span>(<span class="params">s,n</span>):</span><br><span class="line">    <span class="keyword">if</span> n&lt;<span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(s)&lt;n <span class="keyword">or</span> <span class="keyword">not</span> s:</span><br><span class="line">        <span class="keyword">return</span> s</span><br><span class="line">    s = reverseOne(s,<span class="number">0</span>,n-<span class="number">1</span>)</span><br><span class="line">    s = reverseOne(s,n,<span class="built_in">len</span>(s)-<span class="number">1</span>)</span><br><span class="line">    s = reverseAll(s)</span><br><span class="line">    <span class="keyword">return</span> s</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(reverseLeft(<span class="string">&quot;abcdef&quot;</span>,<span class="number">2</span>))</span><br></pre></td></tr></table></figure>

<h5 id="面试题59：队列的最大值"><a href="#面试题59：队列的最大值" class="headerlink" title="面试题59：队列的最大值"></a>面试题59：队列的最大值</h5><blockquote>
<p>题目1：滑动窗口的最大值</p>
<p>给定一个数组和滑动窗口的大小，请找出所有滑动窗口里的最大值。例如，输入数组[2,3,4,2,6,2,5,1]，滑动窗口大小为3，那么一共存在6个滑动窗口，他们的最大值分别为[4,4,6,6,6,5]</p>
</blockquote>
<p>思路：这道题的思路主要是用一个队列暂存可能是最大值的元素的index，根据当前遍历的值与已暂存的值的关系，决定已暂存值删除头部或尾部，并将当前最大值存入另一个专门用于存放最大值的队列中。</p>
<p>这样说可能有些抽象，我们用上面这个例子来说明。</p>
<p>定义两个队列，一个是result，存放返回的最大值，一个是temp，暂存最大值。</p>
<p>temp首先存入2，然后存入3，由于3比2大，窗口中的最大值不可能为2，所以在temp中删除2，压入3。</p>
<p>然后存入4，由于4比3大，同理删除3，压入4.</p>
<p>继续，存入2，由于4比2大，在4出栈后，2可能成为最大值，因此不删除元素，直接压入2，此时temp里面的内容为4,2</p>
<p>下一步存入6，由于6比4和2都大，因此把4,2都删了，压入6。</p>
<p>接下来压入2，压入5，删除2。再压入1，此时因为6的index与1的index差已经大于等于3了，要删除掉6，此时temp的结果为5,1</p>
<p>每次遍历一个元素的时候，我们都要将temp[0]压入result中，最终返回result即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">maxInWindows</span>(<span class="params">num, size</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(num) &lt; size <span class="keyword">or</span> size &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">return</span> []</span><br><span class="line">        tempMax = []</span><br><span class="line">        result = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">            <span class="keyword">while</span> tempMax <span class="keyword">and</span> num[i] &gt; num[tempMax[-<span class="number">1</span>]]:</span><br><span class="line">                tempMax.pop()</span><br><span class="line">            tempMax.append(i)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size, <span class="built_in">len</span>(num)):</span><br><span class="line">            result.append(num[tempMax[<span class="number">0</span>]])</span><br><span class="line">            <span class="keyword">while</span> tempMax <span class="keyword">and</span> num[i] &gt; num[tempMax[-<span class="number">1</span>]]:</span><br><span class="line">                tempMax.pop()</span><br><span class="line">            tempMax.append(i)</span><br><span class="line">            <span class="keyword">while</span> i - tempMax[<span class="number">0</span>] + <span class="number">1</span> &gt; size:</span><br><span class="line">                tempMax.pop(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(Solution.maxInWindows([<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">6</span>,<span class="number">2</span>,<span class="number">8</span>,<span class="number">1</span>], <span class="number">3</span>))</span><br></pre></td></tr></table></figure>

<blockquote>
<p>题目二：队列的最大值</p>
<p>定义一个队列并实现函数max得到队列的最大值，要求函数max，push_back和pop_front的时间复杂度都是O(1)</p>
</blockquote>
<p>思路与前面问题一的思路相同，用一个maxnum队列来存储最大值。</p>
<h4 id="抽象建模能力"><a href="#抽象建模能力" class="headerlink" title="抽象建模能力"></a>抽象建模能力</h4><h5 id="面试题60：n个骰子的点数"><a href="#面试题60：n个骰子的点数" class="headerlink" title="面试题60：n个骰子的点数"></a>面试题60：n个骰子的点数</h5><blockquote>
<p>题目：把n个骰子扔在地上，所有骰子朝上的点数之和为s，输入为n，打印出s所有有可能的值出现的概率</p>
</blockquote>
<p>这道题很容易想到的方法是递归，但是递归的时间效率比较低，所以更好的方法是循环。递归的代码如下。</p>
<p><code>getTouziCore(origin, now, sumv, result)</code>这个函数的功能是一共有origin枚骰子，现在还剩下now枚，总值是sumv，所有结果放在result里面。result数组的长度为6*n+1（最后一个值为6n），最终需要的部分是[n:]这部分。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getTouziCore</span>(<span class="params">origin, now, sumv, result</span>):</span><br><span class="line">    <span class="keyword">if</span> now == <span class="number">0</span>:</span><br><span class="line">        result[sumv] += <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">7</span>):</span><br><span class="line">            getTouziCore(origin, now - <span class="number">1</span>, i + sumv, result)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">getTouziSum</span>(<span class="params">n</span>):</span><br><span class="line">    result = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span> * n+<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">7</span>):</span><br><span class="line">        getTouziCore(n, n-<span class="number">1</span>, i, result)</span><br><span class="line">    <span class="keyword">return</span> result[n:]</span><br></pre></td></tr></table></figure>

<p>基于循环方法的思路是这样的：假设我们现在有一个骰子，那么可能出现的点数是1-6，每个出现的次数都是一次，记作f(i)&#x3D;1,i&#x3D;1-6再来一个骰子。每种点数出现的次数是f(n-1)+f(n-2)+f(n-3)+f(n-4)+f(n-5)+f(n-6)，因此用两个list来存放值，，last存放上一次的可能出现值的结果，this存放本次的结果。代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getTouziSum</span>(<span class="params">n</span>):</span><br><span class="line">    last = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span> * n+<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">7</span>):</span><br><span class="line">        last[i] = <span class="number">1</span></span><br><span class="line">    this = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span> * n+<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">if</span> n &lt;= <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n-<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>,<span class="number">6</span>*n+<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> i&gt;=<span class="number">6</span>:</span><br><span class="line">                this[i] = <span class="built_in">sum</span>(last[i-<span class="number">6</span>:i])</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                this[i] = <span class="built_in">sum</span>(last[<span class="number">1</span>:i])</span><br><span class="line">        last = this[:]</span><br><span class="line">    <span class="keyword">return</span> this</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span>[] touzi(<span class="type">int</span> n) &#123;</span><br><span class="line">    <span class="type">int</span>[] nums = <span class="keyword">new</span> <span class="title class_">int</span>[n * <span class="number">6</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">6</span>; i++) &#123;</span><br><span class="line">        touziCore(nums, n - <span class="number">1</span>, i);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">touziCore</span><span class="params">(<span class="type">int</span>[] nums, <span class="type">int</span> n, <span class="type">int</span> sum)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        nums[sum] += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">6</span>; i++) &#123;</span><br><span class="line">        touziCore(nums, n - <span class="number">1</span>, sum + i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span>[] touziNoneRecur(<span class="type">int</span> n) &#123;</span><br><span class="line">    <span class="type">int</span>[] nums = <span class="keyword">new</span> <span class="title class_">int</span>[n * <span class="number">6</span> + <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">6</span>; i++) &#123;</span><br><span class="line">        nums[i] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span>[] copy = Arrays.copyOf(nums, nums.length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>; i &lt;= n; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt;= <span class="number">6</span> * n; j++) &#123;</span><br><span class="line">            nums[j] = sum(copy, j - <span class="number">6</span>, j - <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.arraycopy(nums, <span class="number">0</span>, copy, <span class="number">0</span>, <span class="number">6</span> * n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">sum</span><span class="params">(<span class="type">int</span>[] copy, <span class="type">int</span> start, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">    start = Math.max(<span class="number">0</span>, start);</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> start; i &lt;= end; i++) &#123;</span><br><span class="line">        sum += copy[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题61：扑克牌中的顺子"><a href="#面试题61：扑克牌中的顺子" class="headerlink" title="面试题61：扑克牌中的顺子"></a>面试题61：扑克牌中的顺子</h5><blockquote>
<p>题目：从扑克牌中随机抽5张牌，并判断是不是一个顺子。</p>
</blockquote>
<p>先排序，统计其中0的个数，从最后一个0的下下个元素开始遍历，如果当前元素与上一个元素的差值不是1，那么就用0来填充，只要最后0的数量大于等于0，那就是刚好填充完或者0还可以放在最前面或者最后面，此时返回true，其余情况返回false</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">IsContinuous</span>(<span class="params">self, numbers</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> numbers:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        numbers = <span class="built_in">sorted</span>(numbers)</span><br><span class="line">        count0 = numbers.count(<span class="number">0</span>)</span><br><span class="line">        result = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(count0+<span class="number">1</span>, <span class="built_in">len</span>(numbers)):</span><br><span class="line">            <span class="keyword">if</span> numbers[i] - numbers[i - <span class="number">1</span>] - <span class="number">1</span> == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> numbers[i] - numbers[i - <span class="number">1</span>] - <span class="number">1</span> &gt; <span class="number">0</span> <span class="keyword">and</span> count0 &gt; <span class="number">0</span>:</span><br><span class="line">                count0 -= (numbers[i] - numbers[i - <span class="number">1</span>] - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                result = <span class="literal">False</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> count0 &lt; <span class="number">0</span>:</span><br><span class="line">            result = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>java版本</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//1. 除0以外没有重复数字</span></span><br><span class="line"><span class="comment">//2. 最大值-最小值 &lt; 5</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isContinuous</span><span class="params">(<span class="type">int</span>[] numbers)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(numbers==<span class="literal">null</span>||numbers.length!=<span class="number">5</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> <span class="number">14</span>;</span><br><span class="line">    <span class="type">int</span>[] count = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">14</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numbers.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (numbers[i]==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        count[numbers[i]]++;</span><br><span class="line">        <span class="keyword">if</span>(count[numbers[i]]&gt;<span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (numbers[i]&gt;max)&#123;</span><br><span class="line">            max=numbers[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(numbers[i]&lt;min)&#123;</span><br><span class="line">            min=numbers[i];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max-min&lt;<span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题62：圆圈中最后剩下的数字"><a href="#面试题62：圆圈中最后剩下的数字" class="headerlink" title="面试题62：圆圈中最后剩下的数字"></a>面试题62：圆圈中最后剩下的数字</h5><blockquote>
<p>题目：0,1,…，n-1这n个数字排成一个圆圈，从数字0开始，每次从这个圆圈中删除第m个数字，求出圆圈中最后剩下的一个数字。</p>
</blockquote>
<p>思路：有两种思路，一种是用循环链表模拟这个圆圈，这种思路要用c++实现，因为python没有指针，实现起来不方便。</p>
<p>还有一种思路是通过找数学规律来的，这个问题是著名的约瑟夫问题，其推导公式是f(n,m)&#x3D;[f(n-1,m)+m]%n，f(n,m)表示的是从n个数中删除m个最后剩下的值。最后的实现代码如下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">LastRemaining_Solution</span>(<span class="params">self, n, m</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        n = <span class="built_in">list</span>(<span class="built_in">range</span>(n))</span><br><span class="line">        <span class="keyword">if</span> m &lt;= <span class="number">0</span> <span class="keyword">or</span> <span class="built_in">len</span>(n) &lt;= <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">        i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="built_in">len</span>(n) != <span class="number">1</span>:</span><br><span class="line">            i = (m+i-<span class="number">1</span>)%<span class="built_in">len</span>(n)</span><br><span class="line">            n.pop(i)</span><br><span class="line">        <span class="keyword">return</span> n[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>

<p>java版本：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">restNum</span><span class="params">(<span class="type">int</span> n, <span class="type">int</span> m)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (n&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ArrayList&lt;Integer&gt; nums= <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        nums.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (nums.size()!=<span class="number">1</span>)&#123;</span><br><span class="line">        index = (index+m-<span class="number">1</span>)%n;</span><br><span class="line">        nums.remove(index);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nums.get(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="面试题63：股票的最大收益"><a href="#面试题63：股票的最大收益" class="headerlink" title="面试题63：股票的最大收益"></a>面试题63：股票的最大收益</h5><blockquote>
<p>题目：假设把某只股票的价格按时间顺序存储在数组中，请问买卖这只股票一次获得的最大收益是多少？例如某只股票的价格是[9,11,8,5,7,12,16,14]，如果在价格5的时候买入，并在价格为16的时候卖出，则获得最大收益11.</p>
</blockquote>
<p>用暴力法很简单，直接遍历到每个元素的时候，都与前面的元素相减即可，这样做的时间复杂度为$O(n^2)$。</p>
<p>改进的方法是抓住题目要求，要求是获得最大收益，那么我们只要用当前值，减去前面所有元素中的最小值就可以得到当前的最大收益。我们只需要用一个变量来存储之前的最小元素，一个变量存储最大收益，最终返回最大收益即可。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">getMaxIncome</span>(<span class="params">nums</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> nums <span class="keyword">or</span> <span class="built_in">len</span>(nums) &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    minv = nums[<span class="number">0</span>]</span><br><span class="line">    maxv = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(nums)):</span><br><span class="line">        <span class="keyword">if</span> nums[i] - minv &gt; maxv:</span><br><span class="line">            maxv = nums[i] - minv</span><br><span class="line">        <span class="keyword">if</span> nums[i] &lt; minv:</span><br><span class="line">            minv = nums[i]</span><br><span class="line">    <span class="keyword">return</span> maxv</span><br><span class="line"><span class="built_in">print</span>(getMaxIncome([<span class="number">9</span>,<span class="number">11</span>,<span class="number">8</span>,<span class="number">5</span>,<span class="number">7</span>,<span class="number">12</span>,<span class="number">16</span>,<span class="number">14</span>]))</span><br></pre></td></tr></table></figure>

<h4 id="发散思维能力"><a href="#发散思维能力" class="headerlink" title="发散思维能力"></a>发散思维能力</h4><h5 id="面试题64：求1-2-…-n"><a href="#面试题64：求1-2-…-n" class="headerlink" title="面试题64：求1+2+…+n"></a>面试题64：求1+2+…+n</h5><blockquote>
<p>求1+2+…+n，要求不能使用乘除法，for,while,if,else,switch,case等关键字及条件判断语句(a?b:c)</p>
</blockquote>
<p>c++可以用构造函数等方法来求解，python可以用and运算的短路机制来实现。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Sum_Solution</span>(<span class="params">self, n</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        <span class="keyword">return</span> n <span class="keyword">and</span> n+self.Sum_Solution(n-<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h5 id="面试题65：不用加减乘除做加法"><a href="#面试题65：不用加减乘除做加法" class="headerlink" title="面试题65：不用加减乘除做加法"></a>面试题65：不用加减乘除做加法</h5><blockquote>
<p>题目：写一个函数，求两个整数之和，要求函数体内不得使用+,-,*,&#x2F;等符号</p>
</blockquote>
<p>既然不能用四则运算，那么就只能考虑位运算，我们先来看看一个加减乘除是怎么做的。例如，计算5+17，先计算各位之和，5+7&#x3D;12，不考虑进位的情况，个位为2，十位还是为1，接下来再考虑进位，1+1&#x3D;2，结果是22.</p>
<p>我们换成二进制来看看，5的二进制是101,17的二进制是10001，依然是三步：第一步相加不计进位，第二步记录仅为，第三步把前两部的结果相加。</p>
<p>由于python当中左移运算可能溢出，所以返回的时候要判断是否为负数，如果为负数就返回按位取反的结果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">Add</span>(<span class="params">self, num1, num2</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        sumv = num1 ^ num2</span><br><span class="line">        carry = num1 &amp; num2</span><br><span class="line">        <span class="keyword">while</span> carry:</span><br><span class="line">            sumv = (num1 ^ num2) &amp; <span class="number">0xffffffff</span></span><br><span class="line">            carry = ((num1 &amp; num2) &lt;&lt;<span class="number">1</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line">            num1 = sumv</span><br><span class="line">            num2 = carry</span><br><span class="line">        <span class="keyword">return</span> sumv <span class="keyword">if</span> sumv&lt;=<span class="number">0x7FFFFFFF</span> <span class="keyword">else</span> ~(sumv^<span class="number">0xFFFFFFFF</span>)</span><br></pre></td></tr></table></figure>

<h5 id="面试题66：构建乘积数组"><a href="#面试题66：构建乘积数组" class="headerlink" title="面试题66：构建乘积数组"></a>面试题66：构建乘积数组</h5><blockquote>
<p>题目：给定一个数组A[0,1,…,n-1]，请构建一个数组B[0,1,…,n-1]，其中b的元素B[i]&#x3D;A[0]*A[1]*…*A[i-1]*A[i+1]*…*A[n-1]，要求不能使用除法</p>
</blockquote>
<p>如果能使用除法，那么这道题变成先计算A[0]~A[n]的累积，然后每次除以A[i]即可找到B[i]，如果不能使用除法，直接暴力乘积的话，时间复杂度O(N^2)</p>
<p>要找到简便方法，那就是用两个数组C和D来存储左半部分的乘积结果和右半部分的乘积结果。C[i]&#x3D;A[0]*A[1]*…*A[i-1]，D[i]&#x3D;A[i+1]*…*A[n-1]</p>
<p>这两个数组又分别可以通过循环迭代出来，C[i] &#x3D; C[i-1]*A[i-1]，D[i]&#x3D;D[i+1]*A[i+1]，C数组可以从小到大求得，D数组可以从大到小求得。然后分别相乘得到结果。这样省去了中间每一步计算累积的时候的重复计算。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Solution</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">self, A</span>):</span><br><span class="line">        <span class="comment"># write code here</span></span><br><span class="line">        c = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(A))]</span><br><span class="line">        d = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(A))]</span><br><span class="line">        b = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(A))]</span><br><span class="line">        c[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">        d[-<span class="number">1</span>] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(A)):</span><br><span class="line">            c[i] = c[i - <span class="number">1</span>] * A[i-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(A) - <span class="number">2</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">            d[j] = d[j + <span class="number">1</span>] * A[j+<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(A)):</span><br><span class="line">            b[i] = c[i] * d[i]</span><br><span class="line">        <span class="keyword">return</span> b</span><br></pre></td></tr></table></figure>

<h3 id="补充知识"><a href="#补充知识" class="headerlink" title="补充知识"></a>补充知识</h3><h4 id="B-树和B树的区别"><a href="#B-树和B树的区别" class="headerlink" title="B+树和B树的区别"></a>B+树和B树的区别</h4><p>要理解b树，首先要理解平衡二叉树</p>
<p>平衡二叉树特点：(总的来说就是左右子树深度不超过1的二叉排序树)</p>
<p>（1）非叶子节点最多拥有两个子节点；</p>
<p>（2）非叶子节值大于左边子节点、小于右边子节点；</p>
<p>（3）树的左右两边的层级数相差不会大于1;</p>
<p>（4）没有值相等重复的节点;</p>
<p>2、B树(B-tree)</p>
<p>B树和平衡二叉树稍有不同的是B树属于多叉树又名平衡多路查找树（查找路径不只两个），数据库索引技术里大量使用者B树和B+树的数据结构。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190325155435.png"></p>
<p>3、B+树</p>
<p>B+树是B树的一个升级版，相对于B树来说B+树更充分的利用了节点的空间，让查询速度更加稳定，其速度完全接近于二分法查找。为什么说B+树查找的效率要比B树更高、更稳定；我们先看看两者的区别</p>
<p>两者的区别：</p>
<ol>
<li>B树的每个结点都存储了key和data，而B+树的data存储在叶子节点上，节点不存储data，这样一个节点就可以存储更多的key。可以使得树更矮，所以IO操作次数更少。</li>
<li>B+树的所有叶结点构成一个有序链表，可以按照关键字排序的次序遍历全部记录。由于数据顺序排列并且相连，所以便于区间查找和搜索。而B树则需要进行每一层的递归遍历。相邻的元素可能在内存中不相邻，所以缓存命中性没有B+树好。</li>
</ol>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190325155534.png"></p>
<h4 id="输入网址到页面出现的过程"><a href="#输入网址到页面出现的过程" class="headerlink" title="输入网址到页面出现的过程"></a>输入网址到页面出现的过程</h4><ol>
<li>DNS解析</li>
<li>TCP连接</li>
<li>发送HTTP请求</li>
<li>服务器处理请求并返回HTTP报文</li>
<li>浏览器解析渲染页面</li>
<li>连接结束</li>
</ol>
<h4 id="常见排序算法复杂度"><a href="#常见排序算法复杂度" class="headerlink" title="常见排序算法复杂度"></a>常见排序算法复杂度</h4><p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190321144642.png"></p>
<h4 id="子矩阵最大和"><a href="#子矩阵最大和" class="headerlink" title="子矩阵最大和"></a>子矩阵最大和</h4><blockquote>
<p>给定一个矩阵，求子矩阵的最大和</p>
</blockquote>
<p>这道题其实是数组最大和的扩展版本，具体实现方式是一个i循环，一个j循环，表示的是从第i行到第j行的子矩阵，每过一行，把上一行的每一列的值加到下一行，再用一维数组求最大和的方式就可以得到结果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MaxSubMatrix</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">maxSubMatrix</span><span class="params">(<span class="type">int</span>[][] matrix)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> -Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; matrix.length; i++) &#123;</span><br><span class="line">            <span class="type">int</span>[] temp = <span class="keyword">new</span> <span class="title class_">int</span>[matrix[<span class="number">0</span>].length];</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; matrix[<span class="number">0</span>].length; j++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; matrix[<span class="number">0</span>].length; k++) &#123;</span><br><span class="line">                    temp[k] += matrix[j][k];</span><br><span class="line">                    <span class="type">int</span> <span class="variable">tempMax</span> <span class="operator">=</span> oneDimensionMax(temp, k);</span><br><span class="line">                    <span class="keyword">if</span> (tempMax &gt; max) &#123;</span><br><span class="line">                        max = tempMax;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">oneDimensionMax</span><span class="params">(<span class="type">int</span>[] temp, <span class="type">int</span> k)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">curSum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> -Integer.MAX_VALUE;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= k; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (curSum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                curSum += temp[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                curSum = temp[i];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (curSum &gt; max) &#123;</span><br><span class="line">                max = curSum;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> max;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>也可以直接每次把中间值记录下来：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">maxSubMatrix</span><span class="params">(<span class="type">int</span>[][] matrix)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> -Integer.MAX_VALUE;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; matrix.length; i++) &#123;</span><br><span class="line">        <span class="type">int</span>[] temp = <span class="keyword">new</span> <span class="title class_">int</span>[matrix[<span class="number">0</span>].length];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; matrix.length; j++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; matrix[<span class="number">0</span>].length; k++) &#123;</span><br><span class="line">                temp[k] += matrix[j][k];</span><br><span class="line">                <span class="keyword">if</span> (sum &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    sum += temp[k];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    sum = temp[k];</span><br><span class="line">                &#125;</span><br><span class="line">                max = Math.max(max, sum);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="背包问题"><a href="#背包问题" class="headerlink" title="背包问题"></a>背包问题</h4><p>两种背包问题做法类似，都是先枚举物品，再枚举容量，不同点在于完全背包问题要从小到大枚举容</p>
<p>量，0&#x2F;1 背包问题要从大到小枚举容量。</p>
<h4 id="直方图最大矩形面积"><a href="#直方图最大矩形面积" class="headerlink" title="直方图最大矩形面积"></a>直方图最大矩形面积</h4><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190908105816.png" width="50%" height="50%">

<p>两种方法</p>
<ol>
<li><p>单调栈：维护一个单调递增的栈，如果发现一个比栈顶元素小的值，栈顶元素出栈，计算栈顶元素对应的矩形面积。遍历完整个直方图数组，如果栈里还有元素，依次出栈计算面积。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">maxRect</span><span class="params">(<span class="type">int</span>[] hists)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hists == <span class="literal">null</span> || hists.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    Stack&lt;Integer&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; hists.length) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stack.isEmpty() || hists[stack.peek()] &lt;= hists[i]) &#123;</span><br><span class="line">            stack.push(i++);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">top</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">            <span class="type">int</span> <span class="variable">area</span> <span class="operator">=</span> hists[top] * (stack.isEmpty() ? i : i - stack.peek() - <span class="number">1</span>);</span><br><span class="line">            max = Math.max(max, area);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">top</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">        <span class="type">int</span> <span class="variable">area</span> <span class="operator">=</span> hists[top] * (stack.isEmpty() ? i : i - stack.peek() - <span class="number">1</span>);</span><br><span class="line">        max = Math.max(max, area);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<p>提前计算左右边界：</p>
<p>对于i，left[i]表示左边第一个比i小的元素的位置，right[i]表示右边第一个比i小的元素的位置</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">largestRectangleArea1</span><span class="params">(<span class="type">int</span>[] heights)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (heights == <span class="literal">null</span> || heights.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> heights.length;</span><br><span class="line">    <span class="type">int</span>[] left = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">    <span class="type">int</span>[] right = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">    left[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">    right[n - <span class="number">1</span>] = n;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &gt;= <span class="number">0</span> &amp;&amp; heights[j] &gt;= heights[i]) &#123;</span><br><span class="line">            j--;</span><br><span class="line">        &#125;</span><br><span class="line">        left[i] = j;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> n-<span class="number">2</span>; i &gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; n &amp;&amp; heights[j] &gt;= heights[i]) &#123;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        right[i] = j;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">        max = Math.max(max, heights[i] * (right[i] - left[i] - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个trick在这里，每次<code>j—</code>或者<code>j++</code>这样的效率很低，复杂度是O(n^2)，如果利用已经算好的结果就会快很多，<code>j--</code>改成<code>j=left[j]</code>，<code>j++</code>改成<code>j=right[j]</code>，解释一下这两个公式的含义，比如{1,10,11,9,3}这个数组，在计算3的left的时候，发现9比3大，left[9]其实已经算出来是1了，所以直接跳到1，这是因为9都比3大了，那么比9大的10和11肯定也比3大，同理right数组也是一个道理。</p>
<h4 id="最大子矩阵"><a href="#最大子矩阵" class="headerlink" title="最大子矩阵"></a>最大子矩阵</h4><p>如下图：给定一个由1，0组成的矩阵，求其中最大的全为1的子矩阵</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Input:</span><br><span class="line">[</span><br><span class="line">  [&quot;1&quot;,&quot;0&quot;,&quot;1&quot;,&quot;0&quot;,&quot;0&quot;],</span><br><span class="line">  [&quot;1&quot;,&quot;0&quot;,&quot;1&quot;,&quot;1&quot;,&quot;1&quot;],</span><br><span class="line">  [&quot;1&quot;,&quot;1&quot;,&quot;1&quot;,&quot;1&quot;,&quot;1&quot;],</span><br><span class="line">  [&quot;1&quot;,&quot;0&quot;,&quot;0&quot;,&quot;1&quot;,&quot;0&quot;]</span><br><span class="line">]</span><br><span class="line">Output: 6</span><br></pre></td></tr></table></figure>

<p>思路：其实这道题的思路和求直方图最大面积很像，把每一行看做一个直方图，找到当前行所有列的高度，然后求最大面积即可。height数组表示直方图的高度，left表示左边第一个比i小的位置，right数组表示右边第一个比i小的位置。面积就等于<code>(height[i]*(right[i]-left[i]-1))</code>，为什么这个长度是<code>right[i]-left[i]-1</code>呢，是因为本来满足条件的个数是<code>right[i]-1-(left[i]+1)+1</code>，刚好就是前面的结果。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">maximalRectangle</span><span class="params">(<span class="type">char</span>[][] matrix)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (matrix == <span class="literal">null</span> || matrix.length == <span class="number">0</span> || matrix[<span class="number">0</span>].length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">cols</span> <span class="operator">=</span> matrix[<span class="number">0</span>].length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">rows</span> <span class="operator">=</span> matrix.length;</span><br><span class="line">    <span class="type">int</span>[] hights = <span class="keyword">new</span> <span class="title class_">int</span>[cols];</span><br><span class="line">    <span class="type">int</span>[] left = <span class="keyword">new</span> <span class="title class_">int</span>[cols];</span><br><span class="line">    <span class="type">int</span>[] right = <span class="keyword">new</span> <span class="title class_">int</span>[cols];</span><br><span class="line">    <span class="type">int</span> <span class="variable">max</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; rows; i++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (matrix[i][j] == <span class="string">&#x27;1&#x27;</span>) &#123;</span><br><span class="line">                hights[j]++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                hights[j] = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        left[<span class="number">0</span>] = -<span class="number">1</span>;</span><br><span class="line">        right[cols - <span class="number">1</span>] = cols;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> j - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (p &gt;= <span class="number">0</span> &amp;&amp; hights[p] &gt;= hights[j]) &#123;</span><br><span class="line">                p = left[p];</span><br><span class="line">            &#125;</span><br><span class="line">            left[j] = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> cols - <span class="number">2</span>; j &gt;= <span class="number">0</span>; j--) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">p</span> <span class="operator">=</span> j + <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">while</span> (p &lt; cols &amp;&amp; hights[p] &gt;= hights[j]) &#123;</span><br><span class="line">                p = right[p];</span><br><span class="line">            &#125;</span><br><span class="line">            right[j] = p;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; cols; j++) &#123;</span><br><span class="line">            max = Math.max(max, (right[j] - left[j] - <span class="number">1</span>) * hights[j]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> max;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="水塘抽样"><a href="#水塘抽样" class="headerlink" title="水塘抽样"></a>水塘抽样</h4><p>一个流式数据集，不知道最终会有多少个数据，要求从这些数据中抽出k个，并且每个元素被抽到的概率相同。</p>
<ul>
<li><p>这个问题被归纳为水塘抽样问题，用一个大小为k的池子，先一个一个放进去，放满之后，下一个元素放进去的概率是<code>k/(k+i)</code>，那么对于之前就在水池里面的元素X，他仍然被保留在水池中的概率是<br>p(X之前就在水池中)*p(X在k+i这个数据到来的时候没有被替换掉)</p>
<p>&#x3D;p(X之前就在水池中)*(1-p(X在k+i这个数据到来的时候被替换掉))</p>
<p>&#x3D;p(X之前就在水池中)*(1-p(k+i被留下来，并且替换掉了X))</p>
<p><code>=k/(k+i-1) * (1-k/(k+i)*1/k)</code> </p>
<p><code>=k/(k+i)</code></p>
</li>
</ul>
<p>因此此时所有元素被选中的概率都是k&#x2F;(k+i)，当k+i&#x3D;n的时候，所有元素被选中的概率都是k&#x2F;n。</p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>项目总结</title>
    <url>/2018/03/23/%E9%A1%B9%E7%9B%AE%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<h2 id="自我介绍"><a href="#自我介绍" class="headerlink" title="自我介绍"></a>自我介绍</h2><p>面试官您好，我是来自西安交通大学的研二学生王诏，我本科同样也就读于西安交通大学。我主要从科研和实践学习两方面介绍一下自己。在科研方面，我的主要研究方向是基于数据挖掘的身份认证技术。自大三进入实验室以来，发表了4篇EI论文和两篇SCI论文，参与第三届全国互联网开发大赛获得三等奖，参与互联网+创新创业大赛获陕西省铜奖。在学习实践方面，我研一入选了华为云计算菁英班，研一暑假于华为cloud BU-EI产品服务部进行实习，主要工作是视频直播内容审核算法开发以及审核api的后台开发，在团队的共同努力下，成功拿下了良品铺子，施耐德电气，一汽大众和映客直播的相关项目。之后的一份实习是在国家互联网应急响应中心，从事反诈骗和app敏感信息检测的工作，主要是做了一些hive相关的数据挖掘和后台开发，与公安部配合抓获400余名犯罪嫌疑人，团队得到了南方都市报和中央电视台的新闻报道，今年暑假在阿里巴巴进行暑期实习，主要从事的是直播日常开发和20周年年会相关的开发内容，进行了新功能开发与性能优化以及稳定性保障和预案开发的工作。在我的科研和实习过程中，极大提升了个人的开发能力与业务能力，但我深知自己在各方面都还有欠缺，因此希望有机会进入xx公司xx部门进行实习，提升自我，与团队一起做一些有意义，有价值的事情。</p>
<h2 id="手环手写用户身份识别"><a href="#手环手写用户身份识别" class="headerlink" title="手环手写用户身份识别"></a>手环手写用户身份识别</h2><span id="more"></span>

<h3 id="做研究的背景"><a href="#做研究的背景" class="headerlink" title="做研究的背景"></a>做研究的背景</h3><p>移动计算这几年越来越火，移动设备也存储着越来越多个人的隐私信息，同时移动设备对比于传统的计算机来说，更容易丢失，因此需要一个安全可靠且方便的认证方式。现有的诸如指纹，面部识别之类的方式都有着很大的安全隐患，比如去年刚推出的屏下指纹，在去年12月的黑客大会上，被一位黑客用一张卡片就破解了，黑客用了一张近似于光滑镜面的设备，在高亮度的情况下，将光滑镜片贴近手机表面，由于每次按压屏下指纹会留下污迹，反射的指纹光线被超声波指纹识别器识别，如此轻而易举就破解了屏下指纹。而更可怕的是，最近几年出现的基于对抗生成神经网络的GAN方法，可以生成一个通用指纹，在低安全度指纹识别系统中可以达到76%的准确度。十分火爆的人脸识别系统也可以通过3D打印技术轻松破解。面对这样的现状，因此我们提出了基于行为的生物特征识别。</p>
<p>总的来说，生物特征识别可以分为两类：第一类基于固定生物特征的，比如指纹，虹膜，人脸等；第二类是基于行为习惯的，诸如步态等。我的主要研究方向就是第二类。</p>
<h3 id="做研究的动机"><a href="#做研究的动机" class="headerlink" title="做研究的动机"></a><strong>做研究的动机</strong></h3><p>在手环手写用户身份识别项目中，我做这个项目的动机是因为，我观察到手写动作是一个很复杂的动作，其包含了手掌，手指，手腕的运动轨迹，以及他们之间的交互。手写动作包含了很多可区分的变量，比如首部结构，动作习惯，手写姿势等等，我采集了10个人的200次手写数据，验证到手写姿势的传感器数据区分度足够显著，之后开始了这个实验。最终是收集了50个用户的1000次手写数据，做相关实验。</p>
<h3 id="做研究的问题"><a href="#做研究的问题" class="headerlink" title="做研究的问题"></a>做研究的问题</h3><p>实验中遇到了一些问题，其一是用户书写单词的大小可能会有较大的区分性，其二是即使同一个人书写时产生的加速度计和陀螺仪数据可能有很大的差距，比如某次写的快一些，某些时候慢一些，甚至是有时候有一些意外的暂停，单纯地计算书写时手腕的移动距离和方向是没有办法用于认证的。</p>
<p>最终我们是使用了SG滤波和动态时间规整解决了这些问题，在经过滤波算法和规整后，不同用户的手写时产生的传感器数据产生了较大的差别。</p>
<h3 id="具体过程"><a href="#具体过程" class="headerlink" title="具体过程"></a>具体过程</h3><p>采集50个用户，62hz采样频率，每个用户要求写一个”love”的单词以及任意个由3-5个字母组成的小写单词，每个用户至少写6遍。为了更精确地捕捉每个用户的手写特征，我们要求每个字母的大小都大于$10*3cm^2$，最终采集得到的是一个六维的数据。三轴加速度计数据和三轴陀螺仪数据。</p>
<p>将采集得到的数据通过sg滤波器，提高数据信噪比（这个其实简单来说就是从最小二乘估计推出来的公式，为了拟合多项式常数，savitzky和golay发现计算a0相当于对原始数据进行fir（有限冲击响应）滤波，可以用卷积公式来实现，也就是对输入数据进行了加权平均）。</p>
<p>DTW可以算出两个序列的最短累计距离，公式如下，其中s(i,j)为到i, j这个位置的累计和<br>$$<br>s(i, j)&#x3D;r(i, j)+\min {s(i-1, j-1), s(i-1, j), s(i, j-1)}<br>$$<br>最终表示两个用户的手写动作传感器向量距离是这样的：我们之前不是有六个维度嘛，现在对每个维度计算DTW距离，并且用多次书写的数据进行计算，就得到了6各维度的多次dtw距离值，最终取dtw距离值的上四分位数作为dtw距离，也就是一个六维的向量。为什么要去上四分位数呢，我们当时选取了9个常用的统计特征，发现取上四分位的效果最好，最后就选了上四分位数作为特征。</p>
<p>尽管我们要求用户尽可能保持每次书写的速度和字体大小相同，但是实际结果并不是这样，因此我们计算最终达到dtw距离需要选择一个合适的加权值。现将距离排序，用泊松分布的概率分布函数作为权重，对于两个距离越小的输入值，其给定的权重高，对于距离远的，其给定权重小，对于距离超过n&#x2F;2的情况，权重几乎为0。对于最终距离得分大于某个值的，我们认为其是真实用户，否则是非法用户。得到的精度大概是假阴率1.78%，假阳率大概是6.5%。</p>
<p>接下来我们做了对系统的攻击实验。总共设计了三种攻击方式，一个是单词攻击，也就是看到用户写了哪几个单词，第二种是能够看到用户书写过程，并拿到用户手写笔迹的纸张，进行模仿，第三种是全程录像，并拿到手稿，多次练习模仿。最终设定的阈值为0.65，精度下降到82%。</p>
<h2 id="手环密码偷取项目"><a href="#手环密码偷取项目" class="headerlink" title="手环密码偷取项目"></a>手环密码偷取项目</h2><h3 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h3><p>传统的密码盗取方法可能是基于肩窥攻击，也就是直接观察，还有屏幕污迹攻击，从屏幕污迹中提取密码，以及通过视频动作分析，录取用户输入密码时的录像，但并不直接录取屏幕，而是通过用户手臂的摆动幅度猜测密码。</p>
<p>而我们这个项目中，用的是在手环上嵌入一个加速度录入程序，直接从加速度的变化数据中，通过一个mutil-SVM分类器和一个KNN分类器，得到最终的密码。</p>
<p>输入密码的过程可以分为三个，按压，释放和移到下一个键。从加速度计z轴的值的变化过程中，可以看到每次按下键盘和抬起的过程中，z轴的值有一个明显的抖动，因为每次按压都不可能是直上直下的，中间存在一些震动。在手指移动的过程中，x，y方向的变化值明显大于z方向，用这几个特征，就可以切开用户的输入数据了。</p>
<p>在项目中，我开发了一个安卓程序，可以展示2个键盘，一个是ATM机键盘，包含9个数字键，一个请取消键，一个清除建，一个确认键。还有一个数字小键盘，包括加减乘除，小数点和确认键。</p>
<h3 id="遇到的困难"><a href="#遇到的困难" class="headerlink" title="遇到的困难"></a>遇到的困难</h3><p><strong>1.重力的影响</strong></p>
<p>数据处理首先对用一个高通滤波器对重力进行滤除，最终用的是一个卡尔曼滤波器，具体公式如下，公式右边的g(n)是重力计的值：<br>$$<br>\begin{array}{c}{g_{x}[n]&#x3D;\alpha * g_{x}[n]+(1-\alpha) * \operatorname{acc}<em>{x}[n]} \ {\quad \operatorname{linear}</em>{-} a c c_{x}[n]&#x3D;\left|\operatorname{acc}<em>{x}[n]-g</em>{x}[n]\right.}\end{array}<br>$$<br><strong>2.采样频率不足</strong></p>
<p>因为微软手环的最大采样率是62HZ，当用户快速输入密码的时候，传感器无法捕捉足够的数据值，因此用了重采样来增加数据点，用小波变换来去除数据噪声。( 小波变换去噪可以很好的保护有用的信号尖峰和突变信号。因此小波变换适合用于暂态信号和瞬态信号的噪声去除方面，以及抑制高频噪声的干扰，有效将高频信息和高频噪声区分开来。)</p>
<p><strong>3.数据分割困难</strong></p>
<p>计算窗口能量和，如果这个能量和大于阈值，则认为其实一个移动过程的开始。<br>$$<br>\begin{array}{c}{E_{x y} [i]&#x3D;\operatorname{linear}<em>{-} a c c</em>{x}[i]^{2}+\text { linear }<em>{-} a c c</em>{y}[i]^{2}} \ {A_{x y} [i]&#x3D;\sum_{n&#x3D;i}^{i+10} E_{x y} [n]}\end{array}<br>$$</p>
<p><strong>4.Android程序的开发</strong></p>
<p><em>用GrideView布局键盘，其实并不是真正的键盘，只是模拟键盘的功能</em>  </p>
<p>用hashmap存放键位的值和对应的位置，绑定一个OnItemClickListener，最后为确认键设置一个listener，输入后向手环发出结束信号，手环退出采集程序。</p>
<h3 id="实验结果"><a href="#实验结果" class="headerlink" title="实验结果"></a>实验结果</h3><p>项目中我们采用的评价标准有两个：最大概率的k个候选结果的成功率，以及尝试直至成功的次数。</p>
<p>最终在ATM密码版上，top-1成功率达到78%，top-3成功率达到84%，在数字键盘上，top1成功率72%，top3成功率82%，两者在尝试5次左右的成功率约为95%。</p>
<h2 id="手环摇动认证"><a href="#手环摇动认证" class="headerlink" title="手环摇动认证"></a>手环摇动认证</h2><h3 id="项目背景-1"><a href="#项目背景-1" class="headerlink" title="项目背景"></a>项目背景</h3><p>近几年，多种多样的可穿戴设备进入了大众视野，为人机交互提供了全新的方式。智能手表存储着大量的个人隐私信息和重要资料，诸如银行密码或者是联系人信息等等。因此需要一种可靠的身份认证方式来保护这类设备。</p>
<p>传统的身份认证方式，诸如四位PIN码，这种方式由于智能手表的屏幕尺寸限制，在手表上操作极不方便，诸如指纹人脸识别一类的方式，由于设备尺寸限制也不适用于智能手表。因此我们提出了基于个人行为方式的身份认证方法，能够有效保护这类设备。</p>
<h3 id="遇到困难"><a href="#遇到困难" class="headerlink" title="遇到困难"></a>遇到困难</h3><p><strong>1.提出一个切实有效的身份特征</strong></p>
<p>一开始我们使用的是传统的20维统计特征，诸如均值，最小值，最大值，四分位数等等。但是这种方法在手表摇动认证这个任务当中，区分度不够强，稳定性也不够高。最终经过大量尝试和实验，我们选择了基于概率密度函数的特征，也就是数据的分布情况。提出了4个摇动特征提取函数，分别以角度和距离提取特征，最终选择的是距离特征提取函数，这个距离用的是随机选择两点之间的欧式距离。</p>
<p><strong>2.分类器选择</strong></p>
<p>众多分类器应该如何选择呢？我们参考了在相似任务上进行身份认证的前期工作，也就是我们在2016年的工作，最后选择了当时对比的21个分类器中效果最好的3个进行对比，最终以平均效果最好的曼哈顿scaled分类器作为系统的分类器。</p>
<h3 id="达到效果"><a href="#达到效果" class="headerlink" title="达到效果"></a>达到效果</h3><p>收集150人次的数据，设置了3种攻击方式，一种是在不知道真实用户摇动情况的方式下攻击，第二种是在看过真实用户摇动过程，然后回忆模仿的，第三种是拍摄用户摇动视频，反复训练，然后跟随视频进行摇动的。</p>
<p>最终系统在前两种攻击下得到的等错误率大约是4%，这也是日常生活中最常见的攻击方式，第三种攻击的等错误率大约为20%。</p>
<p>这个系统目前来看精度无法满足欧盟的生物识别标准，但是长远来看，它目前可以用作一个认证的辅助手段。在精度继续提升后，应用前景也较为广泛，比如摇动解锁汽车，摇动开门，超市购物结束后，摇一摇就付款等等。</p>
<h2 id="Spring-Boot项目简介"><a href="#Spring-Boot项目简介" class="headerlink" title="Spring Boot项目简介"></a>Spring Boot项目简介</h2><p>先安装maven，添加path之后，用<code>mvn --version</code>查看是否安装成功，安装成功之后换源，将settings.xml换成阿里源。不过这些都可以通过idea 这个ide来简化</p>
<p>首先是用idea建立一个sping boot的项目，在pom.xml当中配置jdbc，创建买家的数据库表，创建数据库的时候，要选择utf8-mb4字符集，这个编码可以存储emoji表情。</p>
<p>选择了SL4J作为日志框架，常见的还有JUL，log4j等等，创建一个测试类，方法是<code>@RunWith(SpringRunner.class)</code>，然后<code>@SpringBootTest</code>，在函数名前面加一个<code>@Test</code>，这样就可以只运行一个test函数。</p>
<p>这里就要提到一个神器插件，当时也是在github上看到推荐的，就是lombok，有了这个插件，只需要在<code>@slf4j</code>，然后在定义某个实例的时候，也不用写getter，setter函数，只需要在上面<code>@Data</code>就行了。</p>
<p>可以直接通过<code>application.yml</code>配置SLF4j，分别配置存放路径，存放文件名，以及log级别，log一共有5个级别。</p>
<p>之后开始开发买家端部分。开发的答题思路是<code>DAO-&gt;Service-&gt;Controller</code>，最先要开发的内容是dataObject，买家端有ProductCategory，包含类别ID,类别名称，类别编号。id上面是要加一个<code>@ID</code>的注解的，同时，这个类别id一般不会很大，我们就用integer或者long来表示就行了，还要给他注解一个id的生成策略，<code>@GeneratedValue</code>，用的是identity，也就是由数据库生成管理，用刚刚讲的那个lombok插件，就连toString方法都可以省略了。</p>
<p>建立一个repository包，专门用来数据的增删改查。在里面新建一个<code>ProductCategoryRepository</code>，继承<code>JpaRepository</code>，泛型类型是类名和id的数据类型，写完之后先测试一下，用<code>@Autowired</code>注解生成一个repository，然后试一下增删改查，查<code>findOne</code>,增<code>setname,settype</code>，更<code>getOne,setname,settype</code>，在list中找，<code>findByCategoryTypeIn</code>，参数是list。</p>
<p>（hibernate是jpa的一种实现方式，jpa的起名规范一般以get，find，read开头）</p>
<p>接下来是服务层，建立一个<code>CategoryService.java</code>接口，<code>findOne</code>,<code>findAll</code>,<code>findByCategoryIn</code>,<code>save</code>四个方法。</p>
<p>然后建立impl文件夹，继承刚刚建立 的service，在前面要加一个<code>@service</code>的注解，覆写其中定义的方法。到这里商品种类这一部分就写完了，然后写一个test文件进行测试。</p>
<p>商品明细的开发和商品种类的开发大体步骤是一直的，<code>DAO-&gt;Service-&gt;Controller</code></p>
<p>建立productService之后，继承实现其中方法，这个有个不同的就是里面有个分页查询，返回的是一个page对象，里面包含productInfo，参数是pageable类型。</p>
<p>之后就可以开始BuyerProductController的书写了。写之前也要先想好他的功能，这个controller的业务逻辑主要包括：查出所有上架的商品，查出上架商品的categoryType，然后是数据拼装出查询结果编码，查询信息和返回的内容。这几个数据可以拼装到一个ResultVO里面，resultvo里面还包含一个list，可以用来存放数据，这个地方就是用泛型的一个好例子，有了泛型就可以返回任意类型的数据值了。我当时给返回的resultvo里面放的值是productVO的list，为了返回json格式数据方便前端调用，要在productVO每个属性前面，加上<code>@JsonProperty</code>。在这个controller上方就可以定义<code>@getmapping</code>的地址。</p>
<p>在这个BuyerProductController里面，又有一个小技巧，是SpringBoot框架提供的方法BeanUtils.copyProperties，这个方法可以直接把两个对象对应的属性值进行拷贝，而不用一个个复制。</p>
<p>后端建好之后就可以开始前后端联调，前端用vue写，写好之后执行npm run dev，前端取数据的地址就是之前getmapping的地址。</p>
<p>之后订单的开发几乎相同，还是dao-service-controller这样一个步骤。不过需要注意的是，每写完一个过程，就要写好对应的测试代码，如果不写测试代码，后面出了问题，就不知道具体是哪个部分出了问题，不好排查。</p>
<p>关于支付部分，因为微信支付需要企业者账号，当时就没有做这部分，打算等有这方面需求的时候再去完成。</p>
<h4 id="hr面准备内容"><a href="#hr面准备内容" class="headerlink" title="hr面准备内容"></a>hr面准备内容</h4><ol>
<li><p>项目改进点</p>
<p>我在学校所做的几个项目几乎都跟机器学习和后台开发相关。首先，机器学习的模型精度很大程度上取决于数据质量，因此，我认为我们项目中训练所用数据的多样性有待提升，我们当初采集数据的受试者几乎都来自于大学校园，本身的数据范围不是非常广，如果要提升模型的可用性和泛化性，需要更加广泛与通用的数据源。其二，系统的跨平台特性还有待提升，现在我们采取的方案是一个类型的终端一种身份认证方式，比如我们给蚂蚁金服的项目中，我们利用的是手机触屏数据进行特征提取和身份认证，以达到金融风控的目的；而我们给战支研究所做的项目中，利用的是手环的加速度计传感器进行特征提取和身份认证，已到达保护重要数据和资料的目的。在未来的研究中，是否有可能找出一种通用于各平台的身份认证方案，是值得研究的，也是我们组现在的一个重要研究方向。</p>
</li>
<li><p>自己为什么能够胜任这份工作</p>
<p>我认为主要是我的以往工作经验以及较强的学习能力。我本身是处在一个交叉学科，做过机器学习和后台开发两方面的工作，以及去年也在华为Cloud-BU EI产品服务部进行过实习，对EI部门的相关工作有经验。多年的实验室和实习经验也让我个人的解决问题的能力较强，能够很好地解决我的导师或是leader交代的任务和问题，出色的完成个人工作。</p>
</li>
<li><p>为什么要读研</p>
<p>我个人觉得主要有两个原因吧。第一，本科期间，我做过的工作大多偏向于算法研究，开发能力有待提升，当时找工作可能不太能够达到阿里巴巴这样的顶级互联网公司的期望，因此想在研究生期间加强一下自身各方面能力，使自身能够达到较好的工作状态。其二，我大三进入实验室以来，本科发表了2篇论文，我对实验室的研究方向也比较感兴趣，希望能够继续深入一下这个方向的研究，因此我选择了保送研究生，之后在实验室也完成了几个项目，同时在研究生期间还发表了4篇论文。</p>
</li>
<li><p>想不想来杭州，为什么？</p>
<p>我个人是非常想来杭州这个城市的。我第一次到杭州是2016年，当时是因为发表了一篇会议论文，去杭州滨江区华美达酒店开会。从机场到酒店的路上，我第一次看到那种五颜六色的民房，那是在别的城市都没有见到过的，然后会议之前有一天的空闲时间，我打车去了西溪园区，绕着园区转了转，感觉整个园区有种气势磅礴的感觉，建筑都很宽，整个园区的绿化面积非常大，有一种在森林里办公的感觉，然后晚上从酒店步行到钱塘江边看了看，感觉风景太美了，同时杭州这个城市的互联网发展水平在国内是非常领先的，所以不管是从人文自然环境还是工作环境来说，我都非常想去杭州。</p>
</li>
<li><p>为什么想来阿里巴巴</p>
<p>主要是有两个原因，首先，是阿里巴巴拥抱技术的这种技术氛围十分打动我，阿里开源了很多产品，并且被很多其他公司使用，包括weex，antdesign，taobao jvm，飞冰等等。然后第二个原因，是我个人认为这个公司的前景广阔，且不易被替代。与腾讯对比，腾讯的微信在国外很难打过whats’ app和facebook的messenger，而阿里目前在海外市场正在蒸蒸日上，阿里整体的格局和核心竞争力比同类公司更强，所以我非常希望能够有机会加入像阿里这样的一家企业。</p>
</li>
<li><p>对前几面评价</p>
<p>一面因为当时我正在完成蚂蚁金服的项目，内推的同事约定的面试时间是4月4日，然后26号接到了面试电话，由于比较突然，所以表现不是很满意，我给自己打3分；后面两面就比较自然了，我给自己打4分。一面有好几个问题，由于很久没有用过了，当时面试官问的时候，答得不太好。二面几乎问题都回答出来了，三面只有一个newcachedthreadpool的底层实现方式，因为之前没有了解过这一块，当时和面试官一起探讨了一下可能的实现方式，之后查阅资料发现和面试说的存在偏差，我也记录下来了这些面试中存在的问题，写了两篇关于java和redis的博客，加深了对两者的理解。</p>
</li>
<li><p>同事的什么问题让你接受不了</p>
<p>我觉得是敷衍工作。大家一起工作，应该同心协力，为一个共同的目标，不论是提升业绩还是提升公司影响力，共同努力。如果有同事只是敷衍了事，没有拼搏和尽力把事情做好的态度，这样会使得团队比较涣散，从而降低大家的工作激情，使整个团队工作效率和工作能力下降。</p>
</li>
<li><p>最近比较痛苦的事情</p>
<p>应该是权衡实验室工作和实习面试复习的事情吧。因为在实验室，我目前是带了一个10来人的小团队，要到5月初等师弟上完课，才能把这边的组织工作转交给他。因为实习面试总得复习一下之前的项目，还有做一些算法练习题，比较占用时间，然后带领这个团队呢也需要给每个人安排任务，还有自身的科研任务也需要完成，因此在实习面试准备这方面能分配的时间就不是特别多，只能说是尽可能抽时间出来准备，所以最近时间比较紧迫，大概就是这件事情。</p>
</li>
<li><p>平时如何学技术</p>
<p>主要是通过看书，看博客，看官方文档来学习，然后看这三个的时候，都会写一些博客进行记录，以便之后的复习，因为某个技术很久不用的话，可能会淡忘很多，但是如果有良好的记录，那么你再翻阅这些记录的时候，就很容易回想起来。书这方面的话，主要是看一些java，多线程之类的书籍，然后还有一些python，数据分析和机器学习相关的数据；博客主要就是平时自己关注的几个大牛，比如阮一峰，廖雪峰，JakeWharton，linus，还有一些聚合类的博客网站，比如掘金，博客园，segmentfault等等。官方文档基本是在需要用到某个框架或技术的时候，或者是学习某个框架和技术的时候查看的。</p>
</li>
<li><p>比较佩服的人</p>
<p>我比较佩服的人是我的导师和在华为实习时候的leader，我导师今年是33岁，博士毕业4年，在博士毕业三年的时候，就评选了副院长，教授，优青，他的工作态度非常积极，我本科时候跟他一起改论文，我俩在实验室呆过2天1夜，他做事情真的是竭尽全力，他的工作态度和工作能力我都非常佩服。第二个比较佩服的就是我在华为的实习leader，我们都叫他柴哥，因为我们实习生要坐班车去公司，所以一般七点多就到公司了，正式员工要求的是9点到公司，但是柴哥经常比我们来的还早，到了公司后，柴哥会先看一小时的书，然后开始一天的正式工作。柴哥对于人员把控和项目把控的能力非常强，能够非常合理地分配项目所需的资源，同时以身作则，永远都保持学习态度。按理说像柴哥这样19级的员工，基本都不会亲自参与代码开发，审查之类的，柴哥经常会把自己带的员工的代码拿出来看，指出他们在代码当中不规范和可以改进的地方，感觉有一个好leader，能够使人进步的非常快。</p>
</li>
<li><p>为什么不去华为要去阿里</p>
<p>首先，我个人非常想进一个互联网公司，而华为更偏向于传统的终端和通讯市场，公司的技术氛围比较淡薄，其二，我认为阿里是一个更有前景的公司，通讯行业，目前的5G基本已经挖空了行业十几年来的技术积累，如果要研制6G技术，需要进一步逼近香农极限，在目前看来是遥遥无期的（信道的<strong>香农极限</strong>（或称<strong>香农容量</strong>）指的是在会随机发生误码的<a href="https://zh.wikipedia.org/wiki/%E4%BF%A1%E9%81%93">信道</a>上进行无差错传输的最大传输速率。它的存在是<a href="https://zh.wikipedia.org/wiki/%E9%A6%99%E5%86%9C%E5%AE%9A%E7%90%86">香农定理</a>在带宽有限的信道上的一个结论。），而阿里主要做的是一个交易平台，不管社会如何变革，人与人之间或者公司与公司之间的交易永远不会消失，因此阿里是一个更具有市场前景的公司。</p>
</li>
<li><p>优点</p>
<p>坚持，沟通能力强，乐观</p>
</li>
</ol>
]]></content>
      <categories>
        <category>工作</category>
      </categories>
      <tags>
        <tag>工作</tag>
      </tags>
  </entry>
  <entry>
    <title>最长回文子串算法——Manacher&#39;s Algorithm 马拉车算法</title>
    <url>/2019/04/11/%E6%9C%80%E9%95%BF%E5%9B%9E%E6%96%87%E5%AD%90%E4%B8%B2%E7%AE%97%E6%B3%95%E2%80%94%E2%80%94Manacher-s-Algorithm-%E9%A9%AC%E6%8B%89%E8%BD%A6%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<p>这个马拉车算法Manacher‘s Algorithm是用来查找一个字符串的<a href="http://en.wikipedia.org/wiki/Longest_palindromic_substring">最长回文子串</a>的线性方法，由一个叫Manacher的人在1975年发明的，这个方法的最大贡献是在于将时间复杂度提升到了线性，这是非常了不起的。对于回文串想必大家都不陌生，就是正读反读都一样的字符串，比如 “bob”, “level”, “noon” 等等，那么如何在一个字符串中找出最长回文子串呢，可以以每一个字符为中心，向两边寻找回文子串，在遍历完整个数组后，就可以找到最长的回文子串。但是这个方法的时间复杂度为O(n*n)，并不是很高效，下面我们来看时间复杂度为O(n)的马拉车算法。</p>
<span id="more"></span>

<p>由于回文串的长度可奇可偶，比如”bob”是奇数形式的回文，”noon”就是偶数形式的回文，马拉车算法的第一步是预处理，做法是在每一个字符的左右都加上一个特殊字符，比如加上’#’，那么</p>
<p>bob    –&gt;      #b#o#b#</p>
<p>noon    –&gt;    #n#o#o#n# </p>
<p>这样做的好处是不论原字符串是奇数还是偶数个，处理之后得到的字符串的个数都是奇数个，这样就不用分情况讨论了，而可以一起搞定。接下来我们还需要和处理后的字符串t等长的数组p，其中p[i]表示以t[i]字符为中心的回文子串的半径，若p[i] &#x3D; 1，则该回文子串就是t[i]本身，那么我们来看一个简单的例子：</p>
<p># 1 # 2 # 2 # 1 # 2 # 2 #<br>1 2 1 2 5 2 1 6 1 2 3 2 1</p>
<p>为啥我们关心回文子串的半径呢？看上面那个例子，以中间的 ‘1’ 为中心的回文子串 “#2#2#1#2#2#” 的半径是6，而未添加#号的回文子串为 “22122”，长度是5，为半径减1。这是个普遍的规律么？我们再看看之前的那个 “#b#o#b#”，我们很容易看出来以中间的 ‘o’ 为中心的回文串的半径是4，而 “bob”的长度是3，符合规律。再来看偶数个的情况”noon”，添加#号后的回文串为 “#n#o#o#n#”，以最中间的 ‘#’ 为中心的回文串的半径是5，而 “noon” 的长度是4，完美符合规律。所以我们只要找到了最大的半径，就知道最长的回文子串的字符个数了。只知道长度无法定位子串，我们还需要知道子串的起始位置。   </p>
<p>我们还是先来看中间的 ‘1’ 在字符串 “#1#2#2#1#2#2#” 中的位置是7，而半径是6，貌似7-6&#x3D;1，刚好就是回文子串 “22122” 在原串 “122122” 中的起始位置1。那么我们再来验证下 “bob”，”o” 在 “#b#o#b#” 中的位置是3，但是半径是4，这一减成负的了，肯定不对。所以我们应该至少把中心位置向后移动一位，才能为0啊，那么我们就需要在前面增加一个字符，这个字符不能是#号，也不能是s中可能出现的字符，所以我们暂且就用美元号吧，毕竟是博主最爱的东西嘛。这样都不相同的话就不会改变p值了，那么末尾要不要对应的也添加呢，其实不用的，不用加的原因是字符串的结尾标识为’\0’，等于默认加过了。那此时 “o” 在 “$#b#o#b#” 中的位置是4，半径是4，一减就是0了，貌似没啥问题。我们再来验证一下那个数字串，中间的 ‘1’ 在字符串 “$#1#2#2#1#2#2#” 中的位置是8，而半径是6，这一减就是2了，而我们需要的是1，所以我们要除以2。之前的 “bob” 因为相减已经是0了，除以2还是0，没有问题。再来验证一下 “noon”，中间的 ‘#’ 在字符串 “​$#n#o#o#n#” 中的位置是5，半径也是5，相减并除以2还是0，完美。可以任意试试其他的例子，都是符合这个规律的，最长子串的长度是半径减1，起始位置是中间位置减去半径再除以2。</p>
<p>那么下面我们就来看如何求p数组，需要新增两个辅助变量mx和id，其中id为能延伸到最右端的位置的那个回文子串的中心点位置，mx是回文串能延伸到的最右端的位置，这个算法的最核心的一行如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">p[i] = mx &gt; i ? min(p[2 * id - i], mx - i) : 1;</span><br></pre></td></tr></table></figure>

<p>可以这么说，这行要是理解了，那么马拉车算法基本上就没啥问题了，那么这一行代码拆开来看就是</p>
<p>如果 mx &gt; i, 则 p[i] &#x3D; min( p[2 * id - i] , mx - i )</p>
<p>否则，p[i] &#x3D; 1</p>
<p>当 mx - i &gt; P[j] 的时候，以S[j]为中心的回文子串包含在以S[id]为中心的回文子串中，由于 i 和 j 对称，以S[i]为中心的回文子串必然包含在以S[id]为中心的回文子串中，所以必有 P[i] &#x3D; P[j]，其中 j &#x3D; 2*id - i，因为 j 到 id 之间到距离等于 id 到 i 之间到距离，为 i - id，所以 j &#x3D; id - (i - id) &#x3D; 2*id - i，参见下图。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190411213259.png"></p>
<p>当 P[j] &gt;&#x3D; mx - i 的时候，以S[j]为中心的回文子串不一定完全包含于以S[id]为中心的回文子串中，但是基于对称性可知，下图中两个绿框所包围的部分是相同的，也就是说以S[i]为中心的回文子串，其向右至少会扩张到mx的位置，也就是说 P[i] &#x3D; mx - i。至于mx之后的部分是否对称，就只能老老实实去匹配了，这就是后面紧跟到while循环的作用。</p>
<p><img src="https://github-blog-1255346696.cos.ap-beijing.myqcloud.com/20190411213328.png"></p>
<p>对于 mx &lt;&#x3D; i 的情况，无法对 P[i]做更多的假设，只能P[i] &#x3D; 1，然后再去匹配了。</p>
<p>c++代码如下</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">Manacher</span><span class="params">(string s)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Insert &#x27;#&#x27;</span></span><br><span class="line">    string t = <span class="string">&quot;$#&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; s.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        t += s[i];</span><br><span class="line">        t += <span class="string">&quot;#&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Process t</span></span><br><span class="line">    <span class="function">vector&lt;<span class="type">int</span>&gt; <span class="title">p</span><span class="params">(t.size(), <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="type">int</span> mx = <span class="number">0</span>, id = <span class="number">0</span>, resLen = <span class="number">0</span>, resCenter = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; t.<span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">        p[i] = mx &gt; i ? <span class="built_in">min</span>(p[<span class="number">2</span> * id - i], mx - i) : <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (t[i + p[i]] == t[i - p[i]]) ++p[i];</span><br><span class="line">        <span class="keyword">if</span> (mx &lt; i + p[i]) &#123;</span><br><span class="line">            mx = i + p[i];</span><br><span class="line">            id = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (resLen &lt; p[i]) &#123;</span><br><span class="line">            resLen = p[i];</span><br><span class="line">            resCenter = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> s.<span class="built_in">substr</span>((resCenter - resLen) / <span class="number">2</span>, resLen - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    string s1 = <span class="string">&quot;12212&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">Manacher</span>(s1) &lt;&lt; endl;</span><br><span class="line">    string s2 = <span class="string">&quot;122122&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">Manacher</span>(s2) &lt;&lt; endl;</span><br><span class="line">    string s = <span class="string">&quot;waabwswfd&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="built_in">Manacher</span>(s) &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>python代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">maxLenParaString</span>(<span class="params">s</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> s:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    t = <span class="string">&#x27;$#&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(s)):</span><br><span class="line">        t += s[i]</span><br><span class="line">        t += <span class="string">&#x27;#&#x27;</span></span><br><span class="line">    p = [<span class="number">0</span> <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(t))]</span><br><span class="line">    tempR = <span class="number">0</span></span><br><span class="line">    tempCenter = <span class="number">0</span></span><br><span class="line">    resLen = <span class="number">0</span></span><br><span class="line">    resCenter = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(t)):</span><br><span class="line">        <span class="keyword">if</span> tempR &gt; i:</span><br><span class="line">            p[i] = <span class="built_in">min</span>(p[<span class="number">2</span> * tempCenter - i], tempR - i)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p[i] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> t[i+p[i]]==t[i-p[i]]:</span><br><span class="line">            p[i]+=<span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> resLen&lt;p[i]:</span><br><span class="line">            resLen=p[i]-<span class="number">1</span></span><br><span class="line">            resCenter=i</span><br><span class="line">    <span class="keyword">return</span> resLen,resCenter</span><br></pre></td></tr></table></figure>







]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>《二号首长》读书笔记</title>
    <url>/2024/12/07/%E4%BA%8C%E5%8F%B7%E9%A6%96%E9%95%BF%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<p>之前本科期间有读过闫真的《沧浪之水》，感觉很好看，最近又在github项目：**<a href="https://github.com/0voice/expert_readed_books">expert_readed_books</a>** 看到了一本官场小说，于是下载到微信读书，花了大概40小时读完，记录下主要的内容和感受</p>
<p>本书讲述的是一个复旦毕业的才子唐小舟的故事，他毕业后分配到江南省雍州日报工作，与领导交恶，一直没能某得一官半职，但在机缘巧合下，被自己的复旦校友黎兆明，推荐给了刚到江南省当省委书记的赵德良当秘书，因为省委秘书职位的特殊关系，这个职位又被称为二号首长。本书主要就是记录他从一个普通记者转换为省委书记秘书过程中的一些故事。</p>
<p>其中比较印象深刻的情节有四个：</p>
<p>1、就任省委书记秘书一职：从无人问津的记者，到炙手可热的省委书记秘书，就一天的差异，大家的态度发生了翻天覆地的变化，前一天不愿献身的女徒弟，第二天主动联系，无数稍微能联系到一点的人，无不电话祝贺，导致第一天上班一直在接电话；</p>
<p>2、从省委书记秘书一职被冷落：因赵德良书记掀起的反黑除恶行动，未能达到如期效果，且唐小舟作为反黑除恶第一联络员期间，唐小舟推荐了同部门的大哥侯正德替代自己的工作，因此很长一段时间内都没有实职，身边的人渐渐远离，包括以前热络的朋友们，甚至是自己的爱人和女儿也离开了自己，可一段时间后，反黑行动有了大突破，唐小舟又被重用，这些势力的人又热络起来，甚至已经离婚的前妻来逼迫自己复婚，人情冷暖在此刻描绘的淋漓尽致；</p>
<p>3、黎兆平被抓：黎兆平就是前文说到的将唐小舟推荐给赵德良当秘书的复旦校友，本身也是省电视台娱乐频道的总监，赵德良因扫黑除恶，对省内其他势力步步紧逼，对方作出困兽之斗，将黎兆平冤枉后双规抓捕，在这里赵德良围魏救赵，将黎兆平选为人大代表后，夺回双规项目的调查权，最终采用韩信十面埋伏，对这群困兽网开一面，而不是赶尽杀绝（因为赶尽杀绝之后，还会来新的政治伙伴，这些人也不一定好对付），反而迎来了更好的政治环境；</p>
<p>4、升任办公室副主任：任书记秘书4年后，升任了办公室副主任，职级副厅，主管常委办与信访办，其中信访办是一块非常棘手的工作，而新的秘书长江育奇处处捧杀，导致工作进展非常困难。在这期间，唐小舟又有了新的继任者，新的省委书记秘书，自己与书记的链接越来越弱，独自走向了更独立的一面。</p>
<p>整本书整体来说，有一些出彩的地方，一些主线剧情的推动比较有意思，但同时也有一些薄弱的地方，对时政，政治体制，经济发展的思考，通过人物对话的形式展现出来，有时候有些生硬，且论述比较枯燥无趣，在小说中我认为应该适当减少。</p>
<p>书中最为核心的思想，莫过于平衡，赵德良对陈运达的平衡，对唐小舟和小舟继任者的平衡，展示的是政治的艺术，让唐小舟有种患得患失的感觉，这种感觉我们可能在工作中也会遇到，调整好心态，理解这是上层权力艺术的一部分，做好自己的分内工作，从领导者的角度出发，真正发现他们需要什么，从而去为他们或者是为更大的组织创造价值，正式当前工作需要的。</p>
]]></content>
      <categories>
        <category>小说</category>
        <category>读书笔记</category>
      </categories>
      <tags>
        <tag>小说</tag>
        <tag>读书笔记</tag>
      </tags>
  </entry>
</search>
